<?php

namespace App\Http\Controllers\Ventes;

use Illuminate\Http\Request;
use App\Http\Controllers\Controller;
use App\Traits\{GlobalMethod,Slug};
use DB;
use IlluminateSupportFacadesDB;

class PdfVenteController extends Controller
{
    
     /**
     * Display a listing of the resource.
     *
     * @return \Illuminate\Http\Response
     */
    use GlobalMethod,Slug; 

    public function index()
    {
        return 'hello';
    }

    function Gquery($request)
    {
      return str_replace(" ", "%", $request->get('query'));
      // return $request->get('query');
    }

    
//==================== RAPPORT JOURNALIER DES VenteS =================================

public function fetch_rapport_detailvente_date(Request $request)
{
    //

    if ($request->get('date1') && $request->get('date2')) {
        // code...
        $date1 = $request->get('date1');
        $date2 = $request->get('date2');


        $html ='<html><head><meta http-equiv="Content-Type" content="text/html; charset=utf-8"/>';
        $html .= $this->printRapportDetailVente($date1, $date2);       
        $html .='<script>window.print()</script>';

        echo($html);        

    } else {
        // code...
    }
    
    
}
function printRapportDetailVente($date1, $date2)
{

         //Info Entreprise
         $nomEse='';
         $adresseEse='';
         $Tel1Ese='';
         $Tel2Ese='';
         $siteEse='';
         $emailEse='';
         $idNatEse='';
         $numImpotEse='';
         $rccEse='';
         $siege='';
         $busnessName='';
         $pic='';
         $pic2 = $this->displayImg("fichier", 'logo.png');
         $logo='';
 
         $data1 = DB::table('entreprises')
         ->join('secteurs','secteurs.id','=','entreprises.idsecteur')
         ->join('forme_juridiques','forme_juridiques.id','=','entreprises.idforme')
 
         ->join('pays','pays.id','=','entreprises.idPays')
         ->join('provinces','provinces.id','=','entreprises.idProvince')
         ->join('users','users.id','=','entreprises.ceo')        
         ->select('entreprises.id as id','entreprises.id as idEntreprise',
         'entreprises.ceo','entreprises.nomEntreprise','entreprises.descriptionEntreprise',
         'entreprises.emailEntreprise','entreprises.adresseEntreprise',
         'entreprises.telephoneEntreprise','entreprises.solutionEntreprise','entreprises.idsecteur',
         'entreprises.idforme','entreprises.etat',
         'entreprises.idPays','entreprises.idProvince','entreprises.edition','entreprises.facebook',
         'entreprises.linkedin','entreprises.twitter','entreprises.siteweb','entreprises.rccm',
         'entreprises.invPersonnel','entreprises.invHub','entreprises.invRecherche',
         'entreprises.chiffreAffaire','entreprises.nbremploye','entreprises.slug','entreprises.logo',
             //forme
             'forme_juridiques.nomForme','secteurs.nomSecteur',
             //users
             'users.name','users.email','users.avatar','users.telephone','users.adresse',
             //
             'provinces.nomProvince','pays.nomPays', 'entreprises.created_at')
         ->get();
         $output='';
         foreach ($data1 as $row) 
         {                                
             $nomEse=$row->nomEntreprise;
             $adresseEse=$row->adresseEntreprise;
             $Tel1Ese=$row->telephoneEntreprise;
             $Tel2Ese=$row->telephone;
             $siteEse=$row->siteweb;
             $emailEse=$row->emailEntreprise;
             $idNatEse=$row->rccm;
             $numImpotEse=$row->rccm;
             $busnessName=$row->nomSecteur;
             $rccmEse=$row->rccm;
             $pic = $this->displayImg("fichier", 'logo.png');
             $siege=$row->nomForme;         
         }
 

         $sommePHT=0;
         $sommeTVA=0;
         $sommePTTF=0;
         // 
         $data2 =  DB::table('tvente_detail_vente')
         ->join('tvente_produit','tvente_produit.id','=','tvente_detail_vente.refProduit')
         ->join('tvente_categorie_produit','tvente_categorie_produit.id','=','tvente_produit.refCategorie')

         ->join('tvente_entete_vente','tvente_entete_vente.id','=','tvente_detail_vente.refEnteteVente')        
         ->join('tvente_module','tvente_module.id','=','tvente_entete_vente.module_id')
         ->join('tvente_services','tvente_services.id','=','tvente_entete_vente.refService')
         ->join('tvente_client','tvente_client.id','=','tvente_entete_vente.refClient')
         ->join('tvente_categorie_client','tvente_categorie_client.id','=','tvente_client.refCategieClient')  
         ->join('tfin_ssouscompte as compteclient','compteclient.id','=','tvente_categorie_client.compte_client')

         ->select(DB::raw('ROUND(SUM(((qteVente*puVente) - montantreduction)),4) as sommePHT, 
         ROUND(SUM(montanttva),4) as sommeTVA,
         ROUND(SUM(ROUND(((qteVente*puVente) - montantreduction + montanttva),4)),4) as sommePTTF'))
         ->where([
            ['dateVente','>=', $date1],
            ['dateVente','<=', $date2]
        ])    
         ->get(); 
         $output='';
         foreach ($data2 as $row) 
         {                                
            $sommePHT=$row->sommePHT;
            $sommeTVA=$row->sommeTVA;
            $sommePTTF=$row->sommePTTF;                           
         }

           

        $output='

           <!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Transitional//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd">
            <!-- saved from url=(0016)http://localhost -->
            <html>
            <head>
                <title>rpt_RapportVentes</title>
                <meta HTTP-EQUIV="Content-Type" CONTENT="text/html; charset=utf-8"/>
                <style type="text/css">
                    .csB6F858D0 {color:#000000;background-color:#D6E5F4;border-left-style: none;border-top-style: none;border-right-style: none;border-bottom-style: none;font-family:Times New Roman; font-size:24px; font-weight:bold; font-style:normal; padding-left:2px;padding-right:2px;}
                    .cs18F2469C {color:#000000;background-color:#E0E0E0;border-left:#000000 1px solid;border-top:#000000 1px solid;border-right:#000000 1px solid;border-bottom:#000000 1px solid;font-family:Times New Roman; font-size:10px; font-weight:bold; font-style:normal; }
                    .cs797456E3 {color:#000000;background-color:#E0E0E0;border-left:#000000 1px solid;border-top:#000000 1px solid;border-right-style: none;border-bottom:#000000 1px solid;font-family:Times New Roman; font-size:10px; font-weight:bold; font-style:normal; }
                    .cs20251968 {color:#000000;background-color:#E0E0E0;border-left:#000000 1px solid;border-top:#000000 1px solid;border-right-style: none;border-bottom:#000000 1px solid;font-family:Times New Roman; font-size:13px; font-weight:bold; font-style:normal; }
                    .cs9FE9304F {color:#000000;background-color:#E0E0E0;border-left-style: none;border-top:#000000 1px solid;border-right:#000000 1px solid;border-bottom:#000000 1px solid;font-family:Times New Roman; font-size:13px; font-weight:bold; font-style:normal; }
                    .csFF9B7F36 {color:#000000;background-color:#E0E0E0;border-left-style: none;border-top:#000000 1px solid;border-right-style: none;border-bottom:#000000 1px solid;font-family:Times New Roman; font-size:10px; font-weight:bold; font-style:normal; }
                    .csEAC52FCD {color:#000000;background-color:#E0E0E0;border-left-style: none;border-top:#000000 1px solid;border-right-style: none;border-bottom:#000000 1px solid;font-family:Times New Roman; font-size:13px; font-weight:bold; font-style:normal; }
                    .cs56F73198 {color:#000000;background-color:transparent;border-left:#000000 1px solid;border-top:#000000 1px solid;border-right:#000000 1px solid;border-bottom:#000000 1px solid;font-family:Times New Roman; font-size:16px; font-weight:normal; font-style:normal; padding-left:2px;}
                    .cs8681714E {color:#000000;background-color:transparent;border-left:#000000 1px solid;border-top:#000000 1px solid;border-right-style: none;border-bottom:#000000 1px solid;font-family:Times New Roman; font-size:10px; font-weight:normal; font-style:normal; }
                    .csD06EB5B2 {color:#000000;background-color:transparent;border-left-style: none;border-top:#000000 1px solid;border-right:#000000 1px solid;border-bottom:#000000 1px solid;font-family:Times New Roman; font-size:10px; font-weight:normal; font-style:normal; }
                    .csBFBB3693 {color:#000000;background-color:transparent;border-left-style: none;border-top:#000000 1px solid;border-right-style: none;border-bottom:#000000 1px solid;font-family:Times New Roman; font-size:10px; font-weight:normal; font-style:normal; }
                    .cs612ED82F {color:#000000;background-color:transparent;border-left-style: none;border-top-style: none;border-right-style: none;border-bottom-style: none;font-family:Times New Roman; font-size:12px; font-weight:bold; font-style:normal; padding-left:2px;}
                    .csFFC1C457 {color:#000000;background-color:transparent;border-left-style: none;border-top-style: none;border-right-style: none;border-bottom-style: none;font-family:Times New Roman; font-size:12px; font-weight:normal; font-style:normal; padding-left:2px;}
                    .cs101A94F7 {color:#000000;background-color:transparent;border-left-style: none;border-top-style: none;border-right-style: none;border-bottom-style: none;font-family:Times New Roman; font-size:13px; font-weight:normal; font-style:normal; }
                    .csCE72709D {color:#000000;background-color:transparent;border-left-style: none;border-top-style: none;border-right-style: none;border-bottom-style: none;font-family:Times New Roman; font-size:14px; font-weight:bold; font-style:normal; padding-left:2px;}
                    .cs12FE94AA {color:#000000;background-color:transparent;border-left-style: none;border-top-style: none;border-right-style: none;border-bottom-style: none;font-family:Times New Roman; font-size:14px; font-weight:normal; font-style:normal; padding-left:2px;}
                    .csFBB219FE {color:#000000;background-color:transparent;border-left-style: none;border-top-style: none;border-right-style: none;border-bottom-style: none;font-family:Times New Roman; font-size:18px; font-weight:bold; font-style:normal; padding-left:2px;}
                    .cs739196BC {color:#5C5C5C;background-color:transparent;border-left-style: none;border-top-style: none;border-right-style: none;border-bottom-style: none;font-family:Segoe UI; font-size:11px; font-weight:normal; font-style:normal; }
                    .csF7D3565D {height:0px;width:0px;overflow:hidden;font-size:0px;line-height:0px;}
                </style>
            </head>
            <body leftMargin=10 topMargin=10 rightMargin=10 bottomMargin=10 style="background-color:#FFFFFF">
            <table cellpadding="0" cellspacing="0" border="0" style="border-width:0px;empty-cells:show;width:957px;height:383px;position:relative;">
                <tr>
                    <td style="width:0px;height:0px;"></td>
                    <td style="height:0px;width:10px;"></td>
                    <td style="height:0px;width:3px;"></td>
                    <td style="height:0px;width:84px;"></td>
                    <td style="height:0px;width:51px;"></td>
                    <td style="height:0px;width:71px;"></td>
                    <td style="height:0px;width:51px;"></td>
                    <td style="height:0px;width:73px;"></td>
                    <td style="height:0px;width:66px;"></td>
                    <td style="height:0px;width:82px;"></td>
                    <td style="height:0px;width:179px;"></td>
                    <td style="height:0px;width:24px;"></td>
                    <td style="height:0px;width:13px;"></td>
                    <td style="height:0px;width:17px;"></td>
                    <td style="height:0px;width:23px;"></td>
                    <td style="height:0px;width:30px;"></td>
                    <td style="height:0px;width:42px;"></td>
                    <td style="height:0px;width:49px;"></td>
                    <td style="height:0px;width:31px;"></td>
                    <td style="height:0px;width:58px;"></td>
                </tr>
                <tr style="vertical-align:top;">
                    <td style="width:0px;height:23px;"></td>
                    <td class="cs739196BC" colspan="8" style="width:409px;height:23px;line-height:14px;text-align:center;vertical-align:middle;"></td>
                    <td></td>
                    <td></td>
                    <td></td>
                    <td></td>
                    <td></td>
                    <td></td>
                    <td></td>
                    <td></td>
                    <td></td>
                    <td></td>
                    <td></td>
                </tr>
                <tr style="vertical-align:top;">
                    <td style="width:0px;height:9px;"></td>
                    <td></td>
                    <td></td>
                    <td></td>
                    <td></td>
                    <td></td>
                    <td></td>
                    <td></td>
                    <td></td>
                    <td></td>
                    <td></td>
                    <td></td>
                    <td></td>
                    <td></td>
                    <td></td>
                    <td></td>
                    <td></td>
                    <td></td>
                    <td></td>
                    <td></td>
                </tr>
                <tr style="vertical-align:top;">
                    <td style="width:0px;height:1px;"></td>
                    <td></td>
                    <td class="csFBB219FE" colspan="10" rowspan="2" style="width:682px;height:23px;line-height:21px;text-align:left;vertical-align:middle;"><nobr>'.$nomEse.'</nobr></td>
                    <td></td>
                    <td></td>
                    <td></td>
                    <td></td>
                    <td></td>
                    <td></td>
                    <td></td>
                    <td></td>
                </tr>
                <tr style="vertical-align:top;">
                    <td style="width:0px;height:22px;"></td>
                    <td></td>
                    <td></td>
                    <td></td>
                    <td class="cs101A94F7" colspan="5" rowspan="7" style="width:175px;height:144px;text-align:left;vertical-align:top;"><div style="overflow:hidden;width:175px;height:144px;">
                        <img alt="" src="'.$pic2.'" style="width:175px;height:144px;" /></div>
                    </td>
                    <td></td>
                </tr>
                <tr style="vertical-align:top;">
                    <td style="width:0px;height:22px;"></td>
                    <td></td>
                    <td class="csCE72709D" colspan="10" style="width:682px;height:22px;line-height:15px;text-align:left;vertical-align:middle;"><nobr>'.$busnessName.'</nobr></td>
                    <td></td>
                    <td></td>
                    <td></td>
                </tr>
                <tr style="vertical-align:top;">
                    <td style="width:0px;height:22px;"></td>
                    <td></td>
                    <td class="csCE72709D" colspan="10" style="width:682px;height:22px;line-height:15px;text-align:left;vertical-align:middle;"><nobr>RCCM'.$rccEse.'.&nbsp;ID-NAT.'.$idNatEse.'</nobr></td>
                    <td></td>
                    <td></td>
                    <td></td>
                </tr>
                <tr style="vertical-align:top;">
                    <td style="width:0px;height:22px;"></td>
                    <td></td>
                    <td class="csFFC1C457" colspan="10" style="width:682px;height:22px;line-height:13px;text-align:left;vertical-align:middle;">'.$adresseEse.'</td>
                    <td></td>
                    <td></td>
                    <td></td>
                </tr>
                <tr style="vertical-align:top;">
                    <td style="width:0px;height:22px;"></td>
                    <td></td>
                    <td class="csFFC1C457" colspan="10" style="width:682px;height:22px;line-height:13px;text-align:left;vertical-align:middle;"><nobr>Email&nbsp;:&nbsp;'.$emailEse.'</nobr></td>
                    <td></td>
                    <td></td>
                    <td></td>
                </tr>
                <tr style="vertical-align:top;">
                    <td style="width:0px;height:22px;"></td>
                    <td></td>
                    <td class="csFFC1C457" colspan="10" style="width:682px;height:22px;line-height:13px;text-align:left;vertical-align:middle;"><nobr>Site&nbsp;web&nbsp;:&nbsp;'.$siteEse.'</nobr></td>
                    <td></td>
                    <td></td>
                    <td></td>
                </tr>
                <tr style="vertical-align:top;">
                    <td style="width:0px;height:12px;"></td>
                    <td></td>
                    <td class="cs612ED82F" colspan="10" rowspan="2" style="width:682px;height:23px;line-height:13px;text-align:left;vertical-align:middle;"><nobr>T&#233;l&#233;phone&nbsp;:&nbsp;'.$Tel1Ese.'&nbsp;&nbsp;24h/24</nobr></td>
                    <td></td>
                    <td></td>
                    <td></td>
                </tr>
                <tr style="vertical-align:top;">
                    <td style="width:0px;height:11px;"></td>
                    <td></td>
                    <td></td>
                    <td></td>
                    <td></td>
                    <td></td>
                    <td></td>
                    <td></td>
                    <td></td>
                    <td></td>
                </tr>
                <tr style="vertical-align:top;">
                    <td style="width:0px;height:8px;"></td>
                    <td></td>
                    <td></td>
                    <td></td>
                    <td></td>
                    <td></td>
                    <td></td>
                    <td></td>
                    <td></td>
                    <td></td>
                    <td></td>
                    <td></td>
                    <td></td>
                    <td></td>
                    <td></td>
                    <td></td>
                    <td></td>
                    <td></td>
                    <td></td>
                    <td></td>
                </tr>
                <tr style="vertical-align:top;">
                    <td style="width:0px;height:32px;"></td>
                    <td></td>
                    <td></td>
                    <td></td>
                    <td></td>
                    <td class="csB6F858D0" colspan="11" style="width:625px;height:32px;line-height:28px;text-align:center;vertical-align:middle;"><nobr>RAPPORT&nbsp;JOURNALIER&nbsp;DES&nbsp;VENTES</nobr></td>
                    <td></td>
                    <td></td>
                    <td></td>
                    <td></td>
                </tr>
                <tr style="vertical-align:top;">
                    <td style="width:0px;height:19px;"></td>
                    <td></td>
                    <td></td>
                    <td></td>
                    <td></td>
                    <td></td>
                    <td></td>
                    <td></td>
                    <td></td>
                    <td></td>
                    <td></td>
                    <td></td>
                    <td></td>
                    <td></td>
                    <td></td>
                    <td></td>
                    <td></td>
                    <td></td>
                    <td></td>
                    <td></td>
                </tr>
                <tr style="vertical-align:top;">
                    <td style="width:0px;height:23px;"></td>
                    <td></td>
                    <td class="cs56F73198" colspan="6" style="width:329px;height:21px;line-height:18px;text-align:left;vertical-align:top;"><nobr>&nbsp;PERIODE&nbsp;:&nbsp;&nbsp;Du&nbsp;&nbsp;'.$date1.'&nbsp;&nbsp;au&nbsp;'.$date2.'</nobr></td>
                    <td class="cs56F73198" colspan="12" style="width:610px;height:21px;line-height:18px;text-align:left;vertical-align:top;"><nobr>--</nobr></td>
                </tr>
                <tr style="vertical-align:top;">
                    <td style="width:0px;height:9px;"></td>
                    <td></td>
                    <td></td>
                    <td></td>
                    <td></td>
                    <td></td>
                    <td></td>
                    <td></td>
                    <td></td>
                    <td></td>
                    <td></td>
                    <td></td>
                    <td></td>
                    <td></td>
                    <td></td>
                    <td></td>
                    <td></td>
                    <td></td>
                    <td></td>
                    <td></td>
                </tr>
                <tr style="vertical-align:top;">
                    <td style="width:0px;height:24px;"></td>
                    <td></td>
                    <td></td>
                    <td class="cs9FE9304F" style="width:83px;height:22px;line-height:15px;text-align:center;vertical-align:middle;"><nobr>N&#176;&nbsp;FACTURE</nobr></td>
                    <td class="cs9FE9304F" colspan="3" style="width:172px;height:22px;line-height:15px;text-align:center;vertical-align:middle;"><nobr>CLIENT</nobr></td>
                    <td class="cs9FE9304F" style="width:72px;height:22px;line-height:15px;text-align:center;vertical-align:middle;"><nobr>DATE</nobr></td>
                    <td class="cs9FE9304F" colspan="2" style="width:147px;height:22px;line-height:15px;text-align:center;vertical-align:middle;"><nobr>CATEGORIE&nbsp;PROD.</nobr></td>
                    <td class="cs9FE9304F" style="width:178px;height:22px;line-height:15px;text-align:center;vertical-align:middle;"><nobr>ARTICLE</nobr></td>
                    <td class="cs9FE9304F" colspan="2" style="width:36px;height:22px;line-height:15px;text-align:center;vertical-align:middle;"><nobr>Qte</nobr></td>
                    <td class="cs9FE9304F" colspan="2" style="width:39px;height:22px;line-height:15px;text-align:center;vertical-align:middle;"><nobr>PU</nobr></td>
                    <td class="csEAC52FCD" colspan="2" style="width:72px;height:22px;line-height:15px;text-align:center;vertical-align:middle;"><nobr>PHT</nobr></td>
                    <td class="cs20251968" style="width:48px;height:22px;line-height:15px;text-align:center;vertical-align:middle;"><nobr>TVA</nobr></td>
                    <td class="cs20251968" colspan="2" style="width:88px;height:22px;line-height:15px;text-align:center;vertical-align:middle;"><nobr>PTTTC</nobr></td>
                </tr>
                ';

                        $output .= $this->showDetailVente($date1, $date2); 

                        $output.='
                <tr style="vertical-align:top;">
                    <td style="width:0px;height:24px;"></td>
                    <td></td>
                    <td></td>
                    <td></td>
                    <td></td>
                    <td></td>
                    <td></td>
                    <td></td>
                    <td></td>
                    <td></td>
                    <td></td>
                    <td class="cs18F2469C" colspan="4" style="width:75px;height:22px;line-height:11px;text-align:center;vertical-align:middle;"><nobr>TOTAL&nbsp;($)&nbsp;:</nobr></td>
                    <td class="csFF9B7F36" colspan="2" style="width:72px;height:22px;line-height:11px;text-align:center;vertical-align:middle;"><nobr>'.$sommePHT.'$</nobr></td>
                    <td class="cs797456E3" style="width:48px;height:22px;line-height:11px;text-align:center;vertical-align:middle;"><nobr>'.$sommeTVA.'$</nobr></td>
                    <td class="cs797456E3" colspan="2" style="width:88px;height:22px;line-height:11px;text-align:center;vertical-align:middle;"><nobr>'.$sommePTTF.'$</nobr></td>
                </tr>
                <tr style="vertical-align:top;">
                    <td style="width:0px;height:10px;"></td>
                    <td></td>
                    <td></td>
                    <td></td>
                    <td></td>
                    <td></td>
                    <td></td>
                    <td></td>
                    <td></td>
                    <td></td>
                    <td></td>
                    <td></td>
                    <td></td>
                    <td></td>
                    <td></td>
                    <td></td>
                    <td></td>
                    <td></td>
                    <td></td>
                    <td></td>
                </tr>
                <tr style="vertical-align:top;">
                    <td style="width:0px;height:22px;"></td>
                    <td></td>
                    <td class="cs12FE94AA" colspan="4" style="width:207px;height:22px;line-height:16px;text-align:left;vertical-align:top;"><nobr>Fait&nbsp;&#224;&nbsp;Goma&nbsp;le&nbsp;&nbsp;'.date('Y-m-d').'</nobr></td>
                    <td></td>
                    <td></td>
                    <td></td>
                    <td></td>
                    <td></td>
                    <td></td>
                    <td></td>
                    <td></td>
                    <td></td>
                    <td></td>
                    <td></td>
                    <td></td>
                    <td></td>
                    <td></td>
                </tr>
            </table>
            </body>
            </html>
        
        ';  
       
        return $output; 

}
function showDetailVente($date1, $date2)
{
    $data = DB::table('tvente_detail_vente')
    ->join('tvente_produit','tvente_produit.id','=','tvente_detail_vente.refProduit')
    ->join('tvente_categorie_produit','tvente_categorie_produit.id','=','tvente_produit.refCategorie')

    ->join('tvente_entete_vente','tvente_entete_vente.id','=','tvente_detail_vente.refEnteteVente')        
    ->join('tvente_module','tvente_module.id','=','tvente_entete_vente.module_id')
    ->join('tvente_services','tvente_services.id','=','tvente_entete_vente.refService')
    ->join('tvente_client','tvente_client.id','=','tvente_entete_vente.refClient')
    ->join('tvente_categorie_client','tvente_categorie_client.id','=','tvente_client.refCategieClient')  
    // ->join('tfin_ssouscompte as compteclient','compteclient.id','=','tvente_categorie_client.compte_client')

    // ->join('tfin_ssouscompte as comptevente','comptevente.id','=','tvente_categorie_produit.compte_vente')
    // ->join('tfin_ssouscompte as comptevariation','comptevariation.id','=','tvente_categorie_produit.compte_variationstock')
    // ->join('tfin_ssouscompte as compteperte','compteperte.id','=','tvente_categorie_produit.compte_perte')
    // ->join('tfin_ssouscompte as compteproduit','compteproduit.id','=','tvente_categorie_produit.compte_produit')
    // ->join('tfin_ssouscompte as comptedestockage','comptedestockage.id','=','tvente_categorie_produit.compte_destockage')
  

    ->select('tvente_detail_vente.id','refEnteteVente','refProduit','tvente_detail_vente.compte_vente',
    'tvente_detail_vente.compte_variationstock','tvente_detail_vente.compte_perte','tvente_detail_vente.compte_produit',
    'tvente_detail_vente.compte_destockage','puVente','qteVente','uniteVente','puBase','qteBase',
    'tvente_detail_vente.uniteBase','cmupVente','tvente_detail_vente.devise','tvente_detail_vente.taux',
    'montanttva','montantreduction',
    'tvente_detail_vente.active','tvente_detail_vente.author','tvente_detail_vente.refUser',
    'tvente_detail_vente.created_at','idStockService',
    //Produit
    'tvente_produit.designation','tvente_produit.refCategorie','tvente_produit.refUniteBase',
    'tvente_produit.pu','tvente_produit.qte','tvente_produit.cmup','tvente_produit.taux',
    'tvente_produit.Oldcode','tvente_produit.Newcode','tvente_produit.tvaapplique',
    'tvente_produit.estvendable','tvente_categorie_produit.designation as Categorie',
    //client 
    'noms','sexe','contact','mail','adresse','pieceidentite','numeroPiece','dateLivrePiece',
    'lieulivraisonCarte','nationnalite','datenaissance','lieunaissance','profession','occupation',
    'nombreEnfant','dateArriverGoma','arriverPar','refCategieClient','photo','slug',
    "tvente_categorie_client.designation as CategorieClient","compte_client",
    // 'compteclient.refSousCompte','compteclient.nom_ssouscompte','compteclient.numero_ssouscompte',
    //ente vente
    'nom_service', "tvente_module.nom_module",'tvente_entete_vente.code','refClient','refService','refReservation','module_id',
    'dateVente','libelle','tvente_entete_vente.montant','tvente_entete_vente.paie','reduction','totaltva',
    //compte produit
    // 'comptevente.refSousCompte as refSousCompteVente','comptevente.nom_ssouscompte as nom_ssouscompteVente',
    // 'comptevente.numero_ssouscompte as numero_ssouscompteVente'
    // ,'comptevariation.refSousCompte as refSousCompteVariation','comptevariation.nom_ssouscompte as nom_ssouscompteVariation',
    // 'comptevariation.numero_ssouscompte as numero_ssouscompteVariation'
    // ,'compteperte.refSousCompte as refSousComptePerte','compteperte.nom_ssouscompte as nom_ssouscomptePerte',
    // 'compteperte.numero_ssouscompte as numero_ssouscomptePerte'
    // ,'compteproduit.refSousCompte as refSousCompteProduit','compteproduit.nom_ssouscompte as nom_ssouscompteProduit',
    // 'compteproduit.numero_ssouscompte as numero_ssouscompteProduit'
    // ,'comptedestockage.refSousCompte as refSousCompteDestockage','comptedestockage.nom_ssouscompte as nom_ssouscompteDestockage',
    // 'comptedestockage.numero_ssouscompte as numero_ssouscompteDestockage',
    'priseencharge')
   ->selectRaw('ROUND(((qteVente*puVente) - montantreduction),2) as PTVente')
   ->selectRaw('ROUND(((qteVente*puVente) - montantreduction + montanttva),2) as PTVenteTVA')
   ->selectRaw('ROUND((IFNULL(montant,0)),2) as totalFacture')
   ->selectRaw('ROUND((montanttva),2) as TotalTVA')
   ->selectRaw('ROUND((((IFNULL(montant,0)) - montantreduction)+(montanttva)),2) as PTTTC')
   ->selectRaw('((qteVente*puVente)/tvente_detail_vente.taux) as PTVenteFC')
   ->selectRaw('(qteBase*puBase) as PTBase')
   ->selectRaw('IFNULL(paie,0) as totalPaie')
   ->selectRaw('(IFNULL(montant,0)-IFNULL(paie,0)) as RestePaie')
    ->selectRaw('CONCAT("S",YEAR(dateVente),"",MONTH(dateVente),"00",refEnteteVente) as codeFacture')
    ->where([
        ['dateVente','>=', $date1],
        ['dateVente','<=', $date2]
    ])
    ->orderBy("tvente_detail_vente.created_at", "asc")
    ->get();

    $output='';

    foreach ($data as $row) 
    { 

        $output .='
             <tr style="vertical-align:top;">
                <td style="width:0px;height:24px;"></td>
                <td></td>
                <td></td>
                <td class="csD06EB5B2" style="width:83px;height:22px;line-height:11px;text-align:center;vertical-align:middle;">'.$row->codeFacture.'</td>
                <td class="csD06EB5B2" colspan="3" style="width:172px;height:22px;line-height:11px;text-align:left;vertical-align:middle;">'.$row->noms.'</td>
                <td class="csD06EB5B2" style="width:72px;height:22px;line-height:11px;text-align:center;vertical-align:middle;">'.$row->dateVente.'</td>
                <td class="csD06EB5B2" colspan="2" style="width:147px;height:22px;line-height:11px;text-align:left;vertical-align:middle;">'.$row->Categorie.'</td>
                <td class="csD06EB5B2" style="width:178px;height:22px;line-height:11px;text-align:left;vertical-align:middle;">'.$row->designation.'</td>
                <td class="csD06EB5B2" colspan="2" style="width:36px;height:22px;line-height:11px;text-align:center;vertical-align:middle;">'.$row->qteVente.'</td>
                <td class="csD06EB5B2" colspan="2" style="width:39px;height:22px;line-height:11px;text-align:center;vertical-align:middle;">'.$row->puVente.'$</td>
                <td class="csBFBB3693" colspan="2" style="width:72px;height:22px;line-height:11px;text-align:center;vertical-align:middle;">'.$row->PTVente.'$</td>
                <td class="cs8681714E" style="width:48px;height:22px;line-height:11px;text-align:center;vertical-align:middle;">'.$row->montanttva.'$</td>
                <td class="cs8681714E" colspan="2" style="width:88px;height:22px;line-height:11px;text-align:center;vertical-align:middle;">'.$row->PTVenteTVA.'$</td>
            </tr>
        ';   
   
    }

    return $output;

}
//==================== RAPPORT DETAIL FACTURE SELON LES ORGANISATIONS =======================================

public function fetch_rapport_detailvente_date_categorie(Request $request)
{
    //refDepartement

    if ($request->get('date1') && $request->get('date2')&& $request->get('refCategorie')) {
        // code...
        $date1 = $request->get('date1');
        $date2 = $request->get('date2');
        $refCategorie = $request->get('refCategorie');

        $html ='<html><head><meta http-equiv="Content-Type" content="text/html; charset=utf-8"/>';
        $html .= $this->printRapportDetailVente_Categorie($date1, $date2,$refCategorie);       
        $html .='<script>window.print()</script>';

        echo($html); 
        
        // $html = $this->printRapportDetailVente_Categorie($date1, $date2,$refCategorie);
        // $pdf = \App::make('dompdf.wrapper');
        // $pdf->loadHTML($html)->setPaper('a4', 'landscape');
        // return $pdf->stream();            

    } else {
        // code...
    }  
    
}
function printRapportDetailVente_Categorie($date1, $date2,$refCategorie)
{

         //Info Entreprise
         $nomEse='';
         $adresseEse='';
         $Tel1Ese='';
         $Tel2Ese='';
         $siteEse='';
         $emailEse='';
         $idNatEse='';
         $numImpotEse='';
         $rccEse='';
         $siege='';
         $busnessName='';
         $pic='';
         $pic2 = $this->displayImg("fichier", 'logo.png');
         $logo='';
 
         $data1 = DB::table('entreprises')
         ->join('secteurs','secteurs.id','=','entreprises.idsecteur')
         ->join('forme_juridiques','forme_juridiques.id','=','entreprises.idforme')
 
         ->join('pays','pays.id','=','entreprises.idPays')
         ->join('provinces','provinces.id','=','entreprises.idProvince')
         ->join('users','users.id','=','entreprises.ceo')        
         ->select('entreprises.id as id','entreprises.id as idEntreprise',
         'entreprises.ceo','entreprises.nomEntreprise','entreprises.descriptionEntreprise',
         'entreprises.emailEntreprise','entreprises.adresseEntreprise',
         'entreprises.telephoneEntreprise','entreprises.solutionEntreprise','entreprises.idsecteur',
         'entreprises.idforme','entreprises.etat',
         'entreprises.idPays','entreprises.idProvince','entreprises.edition','entreprises.facebook',
         'entreprises.linkedin','entreprises.twitter','entreprises.siteweb','entreprises.rccm',
         'entreprises.invPersonnel','entreprises.invHub','entreprises.invRecherche',
         'entreprises.chiffreAffaire','entreprises.nbremploye','entreprises.slug','entreprises.logo',
             //forme
             'forme_juridiques.nomForme','secteurs.nomSecteur',
             //users
             'users.name','users.email','users.avatar','users.telephone','users.adresse',
             //
             'provinces.nomProvince','pays.nomPays', 'entreprises.created_at')
         ->get();
         $output='';
         foreach ($data1 as $row) 
         {                                
             $nomEse=$row->nomEntreprise;
             $adresseEse=$row->adresseEntreprise;
             $Tel1Ese=$row->telephoneEntreprise;
             $Tel2Ese=$row->telephone;
             $siteEse=$row->siteweb;
             $emailEse=$row->emailEntreprise;
             $idNatEse=$row->rccm;
             $numImpotEse=$row->rccm;
             $busnessName=$row->nomSecteur;
             $rccmEse=$row->rccm;
             $pic = $this->displayImg("fichier", 'logo.png');
             $siege=$row->nomForme;         
         }
 



         $sommePHT=0;
         $sommeTVA=0;
         $sommePTTF=0;
         // 
         $data2 =  DB::table('tvente_detail_vente')
         ->join('tvente_produit','tvente_produit.id','=','tvente_detail_vente.refProduit')
         ->join('tvente_categorie_produit','tvente_categorie_produit.id','=','tvente_produit.refCategorie')
 
         ->join('tvente_entete_vente','tvente_entete_vente.id','=','tvente_detail_vente.refEnteteVente')        
         ->join('tvente_module','tvente_module.id','=','tvente_entete_vente.module_id')
         ->join('tvente_services','tvente_services.id','=','tvente_entete_vente.refService')
         ->join('tvente_client','tvente_client.id','=','tvente_entete_vente.refClient')
         ->join('tvente_categorie_client','tvente_categorie_client.id','=','tvente_client.refCategieClient')  
         ->join('tfin_ssouscompte as compteclient','compteclient.id','=','tvente_categorie_client.compte_client')

         ->select(DB::raw('ROUND(SUM(((qteVente*puVente) - montantreduction)),4) as sommePHT, 
         ROUND(SUM(montanttva),4) as sommeTVA,
          ROUND(SUM(ROUND(((qteVente*puVente) - montantreduction + montanttva),4)),4) as sommePTTF'))
         ->where([
            ['dateVente','>=', $date1],
            ['dateVente','<=', $date2],
            ['tvente_categorie_produit.id','=', $refCategorie],
        ])    
         ->get(); 
         $output='';
         foreach ($data2 as $row) 
         {                                
            $sommePHT=$row->sommePHT;
            $sommeTVA=$row->sommeTVA;
            $sommePTTF=$row->sommePTTF;                           
         }




         $CategorieClient='';

         $data3=DB::table('tvente_detail_vente')
         ->join('tvente_produit','tvente_produit.id','=','tvente_detail_vente.refProduit')
         ->join('tvente_categorie_produit','tvente_categorie_produit.id','=','tvente_produit.refCategorie')
         ->join('tvente_entete_vente','tvente_entete_vente.id','=','tvente_detail_vente.refEnteteVente')
         ->join('tvente_client','tvente_client.id','=','tvente_entete_vente.refClient')
         ->join('tvente_categorie_client','tvente_categorie_client.id','=','tvente_client.refCategieClient')
         ->select('tvente_detail_vente.id','refEnteteVente','refProduit','puVente','qteVente','dateVente',
         'libelle',"tvente_produit.designation","refCategorie","pu","tvente_categorie_produit.designation as Categorie",
         'tvente_detail_vente.author','tvente_detail_vente.created_at','noms','sexe',
         'contact','mail','adresse','pieceidentite','numeroPiece','dateLivrePiece','lieulivraisonCarte',
         'nationnalite','datenaissance','lieunaissance','profession','occupation','nombreEnfant',
         'dateArriverGoma','arriverPar','refCategieClient','photo','slug',
         'tvente_detail_vente.devise','tvente_detail_vente.taux','tvente_categorie_client.designation as CategorieClient')
         ->where([
            ['dateVente','>=', $date1],
            ['dateVente','<=', $date2],
            ['refCategorie','=', $refCategorie],
        ])      
        ->get();      
        $output='';
        foreach ($data3 as $row) 
        {
            $CategorieClient=$row->CategorieClient;              
        }


          

        $output='
            <!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Transitional//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd">
            <!-- saved from url=(0016)http://localhost -->
            <html>
            <head>
                <title>rpt_RapportVentes</title>
                <meta HTTP-EQUIV="Content-Type" CONTENT="text/html; charset=utf-8"/>
                <style type="text/css">
                    .csB6F858D0 {color:#000000;background-color:#D6E5F4;border-left-style: none;border-top-style: none;border-right-style: none;border-bottom-style: none;font-family:Times New Roman; font-size:24px; font-weight:bold; font-style:normal; padding-left:2px;padding-right:2px;}
                    .cs18F2469C {color:#000000;background-color:#E0E0E0;border-left:#000000 1px solid;border-top:#000000 1px solid;border-right:#000000 1px solid;border-bottom:#000000 1px solid;font-family:Times New Roman; font-size:10px; font-weight:bold; font-style:normal; }
                    .cs797456E3 {color:#000000;background-color:#E0E0E0;border-left:#000000 1px solid;border-top:#000000 1px solid;border-right-style: none;border-bottom:#000000 1px solid;font-family:Times New Roman; font-size:10px; font-weight:bold; font-style:normal; }
                    .cs20251968 {color:#000000;background-color:#E0E0E0;border-left:#000000 1px solid;border-top:#000000 1px solid;border-right-style: none;border-bottom:#000000 1px solid;font-family:Times New Roman; font-size:13px; font-weight:bold; font-style:normal; }
                    .cs9FE9304F {color:#000000;background-color:#E0E0E0;border-left-style: none;border-top:#000000 1px solid;border-right:#000000 1px solid;border-bottom:#000000 1px solid;font-family:Times New Roman; font-size:13px; font-weight:bold; font-style:normal; }
                    .csFF9B7F36 {color:#000000;background-color:#E0E0E0;border-left-style: none;border-top:#000000 1px solid;border-right-style: none;border-bottom:#000000 1px solid;font-family:Times New Roman; font-size:10px; font-weight:bold; font-style:normal; }
                    .csEAC52FCD {color:#000000;background-color:#E0E0E0;border-left-style: none;border-top:#000000 1px solid;border-right-style: none;border-bottom:#000000 1px solid;font-family:Times New Roman; font-size:13px; font-weight:bold; font-style:normal; }
                    .cs56F73198 {color:#000000;background-color:transparent;border-left:#000000 1px solid;border-top:#000000 1px solid;border-right:#000000 1px solid;border-bottom:#000000 1px solid;font-family:Times New Roman; font-size:16px; font-weight:normal; font-style:normal; padding-left:2px;}
                    .cs8681714E {color:#000000;background-color:transparent;border-left:#000000 1px solid;border-top:#000000 1px solid;border-right-style: none;border-bottom:#000000 1px solid;font-family:Times New Roman; font-size:10px; font-weight:normal; font-style:normal; }
                    .csD06EB5B2 {color:#000000;background-color:transparent;border-left-style: none;border-top:#000000 1px solid;border-right:#000000 1px solid;border-bottom:#000000 1px solid;font-family:Times New Roman; font-size:10px; font-weight:normal; font-style:normal; }
                    .csBFBB3693 {color:#000000;background-color:transparent;border-left-style: none;border-top:#000000 1px solid;border-right-style: none;border-bottom:#000000 1px solid;font-family:Times New Roman; font-size:10px; font-weight:normal; font-style:normal; }
                    .cs612ED82F {color:#000000;background-color:transparent;border-left-style: none;border-top-style: none;border-right-style: none;border-bottom-style: none;font-family:Times New Roman; font-size:12px; font-weight:bold; font-style:normal; padding-left:2px;}
                    .csFFC1C457 {color:#000000;background-color:transparent;border-left-style: none;border-top-style: none;border-right-style: none;border-bottom-style: none;font-family:Times New Roman; font-size:12px; font-weight:normal; font-style:normal; padding-left:2px;}
                    .cs101A94F7 {color:#000000;background-color:transparent;border-left-style: none;border-top-style: none;border-right-style: none;border-bottom-style: none;font-family:Times New Roman; font-size:13px; font-weight:normal; font-style:normal; }
                    .csCE72709D {color:#000000;background-color:transparent;border-left-style: none;border-top-style: none;border-right-style: none;border-bottom-style: none;font-family:Times New Roman; font-size:14px; font-weight:bold; font-style:normal; padding-left:2px;}
                    .cs12FE94AA {color:#000000;background-color:transparent;border-left-style: none;border-top-style: none;border-right-style: none;border-bottom-style: none;font-family:Times New Roman; font-size:14px; font-weight:normal; font-style:normal; padding-left:2px;}
                    .csFBB219FE {color:#000000;background-color:transparent;border-left-style: none;border-top-style: none;border-right-style: none;border-bottom-style: none;font-family:Times New Roman; font-size:18px; font-weight:bold; font-style:normal; padding-left:2px;}
                    .cs739196BC {color:#5C5C5C;background-color:transparent;border-left-style: none;border-top-style: none;border-right-style: none;border-bottom-style: none;font-family:Segoe UI; font-size:11px; font-weight:normal; font-style:normal; }
                    .csF7D3565D {height:0px;width:0px;overflow:hidden;font-size:0px;line-height:0px;}
                </style>
            </head>
            <body leftMargin=10 topMargin=10 rightMargin=10 bottomMargin=10 style="background-color:#FFFFFF">
            <table cellpadding="0" cellspacing="0" border="0" style="border-width:0px;empty-cells:show;width:957px;height:383px;position:relative;">
                <tr>
                    <td style="width:0px;height:0px;"></td>
                    <td style="height:0px;width:10px;"></td>
                    <td style="height:0px;width:3px;"></td>
                    <td style="height:0px;width:84px;"></td>
                    <td style="height:0px;width:51px;"></td>
                    <td style="height:0px;width:71px;"></td>
                    <td style="height:0px;width:51px;"></td>
                    <td style="height:0px;width:73px;"></td>
                    <td style="height:0px;width:66px;"></td>
                    <td style="height:0px;width:82px;"></td>
                    <td style="height:0px;width:179px;"></td>
                    <td style="height:0px;width:24px;"></td>
                    <td style="height:0px;width:13px;"></td>
                    <td style="height:0px;width:17px;"></td>
                    <td style="height:0px;width:23px;"></td>
                    <td style="height:0px;width:30px;"></td>
                    <td style="height:0px;width:42px;"></td>
                    <td style="height:0px;width:49px;"></td>
                    <td style="height:0px;width:31px;"></td>
                    <td style="height:0px;width:58px;"></td>
                </tr>
                <tr style="vertical-align:top;">
                    <td style="width:0px;height:23px;"></td>
                    <td class="cs739196BC" colspan="8" style="width:409px;height:23px;line-height:14px;text-align:center;vertical-align:middle;"></td>
                    <td></td>
                    <td></td>
                    <td></td>
                    <td></td>
                    <td></td>
                    <td></td>
                    <td></td>
                    <td></td>
                    <td></td>
                    <td></td>
                    <td></td>
                </tr>
                <tr style="vertical-align:top;">
                    <td style="width:0px;height:9px;"></td>
                    <td></td>
                    <td></td>
                    <td></td>
                    <td></td>
                    <td></td>
                    <td></td>
                    <td></td>
                    <td></td>
                    <td></td>
                    <td></td>
                    <td></td>
                    <td></td>
                    <td></td>
                    <td></td>
                    <td></td>
                    <td></td>
                    <td></td>
                    <td></td>
                    <td></td>
                </tr>
                <tr style="vertical-align:top;">
                    <td style="width:0px;height:1px;"></td>
                    <td></td>
                    <td class="csFBB219FE" colspan="10" rowspan="2" style="width:682px;height:23px;line-height:21px;text-align:left;vertical-align:middle;"><nobr>'.$nomEse.'</nobr></td>
                    <td></td>
                    <td></td>
                    <td></td>
                    <td></td>
                    <td></td>
                    <td></td>
                    <td></td>
                    <td></td>
                </tr>
                <tr style="vertical-align:top;">
                    <td style="width:0px;height:22px;"></td>
                    <td></td>
                    <td></td>
                    <td></td>
                    <td class="cs101A94F7" colspan="5" rowspan="7" style="width:175px;height:144px;text-align:left;vertical-align:top;"><div style="overflow:hidden;width:175px;height:144px;">
                        <img alt="" src="'.$pic2.'" style="width:175px;height:144px;" /></div>
                    </td>
                    <td></td>
                </tr>
                <tr style="vertical-align:top;">
                    <td style="width:0px;height:22px;"></td>
                    <td></td>
                    <td class="csCE72709D" colspan="10" style="width:682px;height:22px;line-height:15px;text-align:left;vertical-align:middle;"><nobr>'.$busnessName.'</nobr></td>
                    <td></td>
                    <td></td>
                    <td></td>
                </tr>
                <tr style="vertical-align:top;">
                    <td style="width:0px;height:22px;"></td>
                    <td></td>
                    <td class="csCE72709D" colspan="10" style="width:682px;height:22px;line-height:15px;text-align:left;vertical-align:middle;"><nobr>RCCM'.$rccEse.'.&nbsp;ID-NAT.'.$idNatEse.'</nobr></td>
                    <td></td>
                    <td></td>
                    <td></td>
                </tr>
                <tr style="vertical-align:top;">
                    <td style="width:0px;height:22px;"></td>
                    <td></td>
                    <td class="csFFC1C457" colspan="10" style="width:682px;height:22px;line-height:13px;text-align:left;vertical-align:middle;">'.$adresseEse.'</td>
                    <td></td>
                    <td></td>
                    <td></td>
                </tr>
                <tr style="vertical-align:top;">
                    <td style="width:0px;height:22px;"></td>
                    <td></td>
                    <td class="csFFC1C457" colspan="10" style="width:682px;height:22px;line-height:13px;text-align:left;vertical-align:middle;"><nobr>Email&nbsp;:&nbsp;'.$emailEse.'</nobr></td>
                    <td></td>
                    <td></td>
                    <td></td>
                </tr>
                <tr style="vertical-align:top;">
                    <td style="width:0px;height:22px;"></td>
                    <td></td>
                    <td class="csFFC1C457" colspan="10" style="width:682px;height:22px;line-height:13px;text-align:left;vertical-align:middle;"><nobr>Site&nbsp;web&nbsp;:&nbsp;'.$siteEse.'</nobr></td>
                    <td></td>
                    <td></td>
                    <td></td>
                </tr>
                <tr style="vertical-align:top;">
                    <td style="width:0px;height:12px;"></td>
                    <td></td>
                    <td class="cs612ED82F" colspan="10" rowspan="2" style="width:682px;height:23px;line-height:13px;text-align:left;vertical-align:middle;"><nobr>T&#233;l&#233;phone&nbsp;:&nbsp;'.$Tel1Ese.'&nbsp;&nbsp;24h/24</nobr></td>
                    <td></td>
                    <td></td>
                    <td></td>
                </tr>
                <tr style="vertical-align:top;">
                    <td style="width:0px;height:11px;"></td>
                    <td></td>
                    <td></td>
                    <td></td>
                    <td></td>
                    <td></td>
                    <td></td>
                    <td></td>
                    <td></td>
                    <td></td>
                </tr>
                <tr style="vertical-align:top;">
                    <td style="width:0px;height:8px;"></td>
                    <td></td>
                    <td></td>
                    <td></td>
                    <td></td>
                    <td></td>
                    <td></td>
                    <td></td>
                    <td></td>
                    <td></td>
                    <td></td>
                    <td></td>
                    <td></td>
                    <td></td>
                    <td></td>
                    <td></td>
                    <td></td>
                    <td></td>
                    <td></td>
                    <td></td>
                </tr>
                <tr style="vertical-align:top;">
                    <td style="width:0px;height:32px;"></td>
                    <td></td>
                    <td></td>
                    <td></td>
                    <td></td>
                    <td class="csB6F858D0" colspan="11" style="width:625px;height:32px;line-height:28px;text-align:center;vertical-align:middle;"><nobr>RAPPORT&nbsp;JOURNALIER&nbsp;DES&nbsp;VENTES</nobr></td>
                    <td></td>
                    <td></td>
                    <td></td>
                    <td></td>
                </tr>
                <tr style="vertical-align:top;">
                    <td style="width:0px;height:19px;"></td>
                    <td></td>
                    <td></td>
                    <td></td>
                    <td></td>
                    <td></td>
                    <td></td>
                    <td></td>
                    <td></td>
                    <td></td>
                    <td></td>
                    <td></td>
                    <td></td>
                    <td></td>
                    <td></td>
                    <td></td>
                    <td></td>
                    <td></td>
                    <td></td>
                    <td></td>
                </tr>
                <tr style="vertical-align:top;">
                    <td style="width:0px;height:23px;"></td>
                    <td></td>
                    <td class="cs56F73198" colspan="6" style="width:329px;height:21px;line-height:18px;text-align:left;vertical-align:top;"><nobr>&nbsp;PERIODE&nbsp;:&nbsp;&nbsp;Du&nbsp;&nbsp;'.$date1.'&nbsp;&nbsp;au&nbsp;'.$date2.'</nobr></td>
                    <td class="cs56F73198" colspan="12" style="width:610px;height:21px;line-height:18px;text-align:left;vertical-align:top;"><nobr>'.$CategorieClient.'</nobr></td>
                </tr>
                <tr style="vertical-align:top;">
                    <td style="width:0px;height:9px;"></td>
                    <td></td>
                    <td></td>
                    <td></td>
                    <td></td>
                    <td></td>
                    <td></td>
                    <td></td>
                    <td></td>
                    <td></td>
                    <td></td>
                    <td></td>
                    <td></td>
                    <td></td>
                    <td></td>
                    <td></td>
                    <td></td>
                    <td></td>
                    <td></td>
                    <td></td>
                </tr>
                <tr style="vertical-align:top;">
                    <td style="width:0px;height:24px;"></td>
                    <td></td>
                    <td></td>
                    <td class="cs9FE9304F" style="width:83px;height:22px;line-height:15px;text-align:center;vertical-align:middle;"><nobr>N&#176;&nbsp;FACTURE</nobr></td>
                    <td class="cs9FE9304F" colspan="3" style="width:172px;height:22px;line-height:15px;text-align:center;vertical-align:middle;"><nobr>CLIENT</nobr></td>
                    <td class="cs9FE9304F" style="width:72px;height:22px;line-height:15px;text-align:center;vertical-align:middle;"><nobr>DATE</nobr></td>
                    <td class="cs9FE9304F" colspan="2" style="width:147px;height:22px;line-height:15px;text-align:center;vertical-align:middle;"><nobr>CATEGORIE&nbsp;PROD.</nobr></td>
                    <td class="cs9FE9304F" style="width:178px;height:22px;line-height:15px;text-align:center;vertical-align:middle;"><nobr>ARTICLE</nobr></td>
                    <td class="cs9FE9304F" colspan="2" style="width:36px;height:22px;line-height:15px;text-align:center;vertical-align:middle;"><nobr>Qte</nobr></td>
                    <td class="cs9FE9304F" colspan="2" style="width:39px;height:22px;line-height:15px;text-align:center;vertical-align:middle;"><nobr>PU</nobr></td>
                    <td class="csEAC52FCD" colspan="2" style="width:72px;height:22px;line-height:15px;text-align:center;vertical-align:middle;"><nobr>PHT</nobr></td>
                    <td class="cs20251968" style="width:48px;height:22px;line-height:15px;text-align:center;vertical-align:middle;"><nobr>TVA</nobr></td>
                    <td class="cs20251968" colspan="2" style="width:88px;height:22px;line-height:15px;text-align:center;vertical-align:middle;"><nobr>PTTTC</nobr></td>
                </tr>
                ';

                        $output .= $this->showDetailVente_Categorie($date1,$date2,$refCategorie); 

                        $output.='
                <tr style="vertical-align:top;">
                    <td style="width:0px;height:24px;"></td>
                    <td></td>
                    <td></td>
                    <td></td>
                    <td></td>
                    <td></td>
                    <td></td>
                    <td></td>
                    <td></td>
                    <td></td>
                    <td></td>
                    <td class="cs18F2469C" colspan="4" style="width:75px;height:22px;line-height:11px;text-align:center;vertical-align:middle;"><nobr>TOTAL&nbsp;($)&nbsp;:</nobr></td>
                    <td class="csFF9B7F36" colspan="2" style="width:72px;height:22px;line-height:11px;text-align:center;vertical-align:middle;"><nobr>'.$sommePHT.'$</nobr></td>
                    <td class="cs797456E3" style="width:48px;height:22px;line-height:11px;text-align:center;vertical-align:middle;"><nobr>'.$sommeTVA.'$</nobr></td>
                    <td class="cs797456E3" colspan="2" style="width:88px;height:22px;line-height:11px;text-align:center;vertical-align:middle;"><nobr>'.$sommePTTF.'$</nobr></td>
                </tr>
                <tr style="vertical-align:top;">
                    <td style="width:0px;height:10px;"></td>
                    <td></td>
                    <td></td>
                    <td></td>
                    <td></td>
                    <td></td>
                    <td></td>
                    <td></td>
                    <td></td>
                    <td></td>
                    <td></td>
                    <td></td>
                    <td></td>
                    <td></td>
                    <td></td>
                    <td></td>
                    <td></td>
                    <td></td>
                    <td></td>
                    <td></td>
                </tr>
                <tr style="vertical-align:top;">
                    <td style="width:0px;height:22px;"></td>
                    <td></td>
                    <td class="cs12FE94AA" colspan="4" style="width:207px;height:22px;line-height:16px;text-align:left;vertical-align:top;"><nobr>Fait&nbsp;&#224;&nbsp;Goma&nbsp;le&nbsp;&nbsp;'.date('Y-m-d').'</nobr></td>
                    <td></td>
                    <td></td>
                    <td></td>
                    <td></td>
                    <td></td>
                    <td></td>
                    <td></td>
                    <td></td>
                    <td></td>
                    <td></td>
                    <td></td>
                    <td></td>
                    <td></td>
                    <td></td>
                </tr>
            </table>
            </body>
            </html>        
        ';  
       
        return $output; 

}
function showDetailVente_Categorie($date1,$date2,$refCategorie)
{
        $data = DB::table('tvente_detail_vente')
        ->join('tvente_produit','tvente_produit.id','=','tvente_detail_vente.refProduit')
        ->join('tvente_categorie_produit','tvente_categorie_produit.id','=','tvente_produit.refCategorie')
    
        ->join('tvente_entete_vente','tvente_entete_vente.id','=','tvente_detail_vente.refEnteteVente')        
        ->join('tvente_module','tvente_module.id','=','tvente_entete_vente.module_id')
        ->join('tvente_services','tvente_services.id','=','tvente_entete_vente.refService')
        ->join('tvente_client','tvente_client.id','=','tvente_entete_vente.refClient')
        ->join('tvente_categorie_client','tvente_categorie_client.id','=','tvente_client.refCategieClient')  
        // ->join('tfin_ssouscompte as compteclient','compteclient.id','=','tvente_categorie_client.compte_client')
    
        // ->join('tfin_ssouscompte as comptevente','comptevente.id','=','tvente_categorie_produit.compte_vente')
        // ->join('tfin_ssouscompte as comptevariation','comptevariation.id','=','tvente_categorie_produit.compte_variationstock')
        // ->join('tfin_ssouscompte as compteperte','compteperte.id','=','tvente_categorie_produit.compte_perte')
        // ->join('tfin_ssouscompte as compteproduit','compteproduit.id','=','tvente_categorie_produit.compte_produit')
        // ->join('tfin_ssouscompte as comptedestockage','comptedestockage.id','=','tvente_categorie_produit.compte_destockage')
      
    
        ->select('tvente_detail_vente.id','refEnteteVente','refProduit','tvente_detail_vente.compte_vente',
        'tvente_detail_vente.compte_variationstock','tvente_detail_vente.compte_perte','tvente_detail_vente.compte_produit',
        'tvente_detail_vente.compte_destockage','puVente','qteVente','uniteVente','puBase','qteBase',
        'tvente_detail_vente.uniteBase','cmupVente','tvente_detail_vente.devise','tvente_detail_vente.taux',
        'montanttva','montantreduction',
        'tvente_detail_vente.active','tvente_detail_vente.author','tvente_detail_vente.refUser',
        'tvente_detail_vente.created_at','idStockService',
        //Produit
        'tvente_produit.designation','tvente_produit.refCategorie','tvente_produit.refUniteBase',
        'tvente_produit.pu','tvente_produit.qte','tvente_produit.cmup','tvente_produit.taux',
        'tvente_produit.Oldcode','tvente_produit.Newcode','tvente_produit.tvaapplique',
        'tvente_produit.estvendable','tvente_categorie_produit.designation as Categorie',
        //client 
        'noms','sexe','contact','mail','adresse','pieceidentite','numeroPiece','dateLivrePiece',
        'lieulivraisonCarte','nationnalite','datenaissance','lieunaissance','profession','occupation',
        'nombreEnfant','dateArriverGoma','arriverPar','refCategieClient','photo','slug',
        "tvente_categorie_client.designation as CategorieClient","compte_client",
        // 'compteclient.refSousCompte','compteclient.nom_ssouscompte','compteclient.numero_ssouscompte',
        //ente vente
        'nom_service', "tvente_module.nom_module",'tvente_entete_vente.code','refClient','refService','refReservation','module_id',
        'dateVente','libelle','tvente_entete_vente.montant','tvente_entete_vente.paie','reduction','totaltva',
        //compte produit
        // 'comptevente.refSousCompte as refSousCompteVente','comptevente.nom_ssouscompte as nom_ssouscompteVente',
        // 'comptevente.numero_ssouscompte as numero_ssouscompteVente'
        // ,'comptevariation.refSousCompte as refSousCompteVariation','comptevariation.nom_ssouscompte as nom_ssouscompteVariation',
        // 'comptevariation.numero_ssouscompte as numero_ssouscompteVariation'
        // ,'compteperte.refSousCompte as refSousComptePerte','compteperte.nom_ssouscompte as nom_ssouscomptePerte',
        // 'compteperte.numero_ssouscompte as numero_ssouscomptePerte'
        // ,'compteproduit.refSousCompte as refSousCompteProduit','compteproduit.nom_ssouscompte as nom_ssouscompteProduit',
        // 'compteproduit.numero_ssouscompte as numero_ssouscompteProduit'
        // ,'comptedestockage.refSousCompte as refSousCompteDestockage','comptedestockage.nom_ssouscompte as nom_ssouscompteDestockage',
        // 'comptedestockage.numero_ssouscompte as numero_ssouscompteDestockage',
        'priseencharge')
       ->selectRaw('ROUND(((qteVente*puVente) - montantreduction),2) as PTVente')
       ->selectRaw('ROUND(((qteVente*puVente) - montantreduction + montanttva),2) as PTVenteTVA')
       ->selectRaw('ROUND((IFNULL(montant,0)),2) as totalFacture')
       ->selectRaw('ROUND((montanttva),2) as TotalTVA')
       ->selectRaw('ROUND((((IFNULL(montant,0)) - montantreduction)+(montanttva)),2) as PTTTC')
       ->selectRaw('((qteVente*puVente)/tvente_detail_vente.taux) as PTVenteFC')
       ->selectRaw('(qteBase*puBase) as PTBase')
       ->selectRaw('IFNULL(paie,0) as totalPaie')
       ->selectRaw('(IFNULL(montant,0)-IFNULL(paie,0)) as RestePaie')
        ->selectRaw('CONCAT("S",YEAR(dateVente),"",MONTH(dateVente),"00",refEnteteVente) as codeFacture')
        ->where([
            ['dateVente','>=', $date1],
            ['dateVente','<=', $date2],
            ['tvente_categorie_produit.id','=', $refCategorie]
        ])
        ->orderBy("tvente_detail_vente.created_at", "asc")
        ->get();
        $output='';

        foreach ($data as $row) 
        {
            $output .='
            <tr style="vertical-align:top;">
                <td style="width:0px;height:24px;"></td>
                <td></td>
                <td></td>
                <td class="csD06EB5B2" style="width:83px;height:22px;line-height:11px;text-align:center;vertical-align:middle;">'.$row->codeFacture.'</td>
                <td class="csD06EB5B2" colspan="3" style="width:172px;height:22px;line-height:11px;text-align:left;vertical-align:middle;">'.$row->noms.'</td>
                <td class="csD06EB5B2" style="width:72px;height:22px;line-height:11px;text-align:center;vertical-align:middle;">'.$row->dateVente.'</td>
                <td class="csD06EB5B2" colspan="2" style="width:147px;height:22px;line-height:11px;text-align:left;vertical-align:middle;">'.$row->Categorie.'</td>
                <td class="csD06EB5B2" style="width:178px;height:22px;line-height:11px;text-align:left;vertical-align:middle;">'.$row->designation.'</td>
                <td class="csD06EB5B2" colspan="2" style="width:36px;height:22px;line-height:11px;text-align:center;vertical-align:middle;">'.$row->qteVente.'</td>
                <td class="csD06EB5B2" colspan="2" style="width:39px;height:22px;line-height:11px;text-align:center;vertical-align:middle;">'.$row->puVente.'$</td>
                <td class="csBFBB3693" colspan="2" style="width:72px;height:22px;line-height:11px;text-align:center;vertical-align:middle;">'.$row->PTVente.'$</td>
                <td class="cs8681714E" style="width:48px;height:22px;line-height:11px;text-align:center;vertical-align:middle;">'.$row->montanttva.'$</td>
                <td class="cs8681714E" colspan="2" style="width:88px;height:22px;line-height:11px;text-align:center;vertical-align:middle;">'.$row->PTVenteTVA.'$</td>
            </tr>
        '; 
           
   
    }

    return $output;

}

//==================== RAPPORT DETAIL FACTURE SELON LES ORGANISATIONS =======================================

public function fetch_rapport_detailvente_date_etat_facture_service(Request $request)
{
    //refDepartement

    if ($request->get('date1') && $request->get('date2')&& $request->get('etat_facture')&& $request->get('idService')) {
        // code...
        $date1 = $request->get('date1');
        $date2 = $request->get('date2');
        $etat_facture = $request->get('etat_facture');
        $idService = $request->get('idService');

        $html ='<html><head><meta http-equiv="Content-Type" content="text/html; charset=utf-8"/>';
        $html .= $this->printRapportDetailVente_EtatFacture_Service($date1, $date2,$etat_facture,$idService);       
        $html .='<script>window.print()</script>';

        echo($html); 

    } else {
        // code...
    }  
    
}
function printRapportDetailVente_EtatFacture_Service($date1, $date2,$etat_facture,$idService)
{

         //Info Entreprise
         $nomEse='';
         $adresseEse='';
         $Tel1Ese='';
         $Tel2Ese='';
         $siteEse='';
         $emailEse='';
         $idNatEse='';
         $numImpotEse='';
         $rccEse='';
         $siege='';
         $busnessName='';
         $pic='';
         $pic2 = $this->displayImg("fichier", 'logo.png');
         $logo='';
 
         $data1 = DB::table('entreprises')
         ->join('secteurs','secteurs.id','=','entreprises.idsecteur')
         ->join('forme_juridiques','forme_juridiques.id','=','entreprises.idforme')
 
         ->join('pays','pays.id','=','entreprises.idPays')
         ->join('provinces','provinces.id','=','entreprises.idProvince')
         ->join('users','users.id','=','entreprises.ceo')        
         ->select('entreprises.id as id','entreprises.id as idEntreprise',
         'entreprises.ceo','entreprises.nomEntreprise','entreprises.descriptionEntreprise',
         'entreprises.emailEntreprise','entreprises.adresseEntreprise',
         'entreprises.telephoneEntreprise','entreprises.solutionEntreprise','entreprises.idsecteur',
         'entreprises.idforme','entreprises.etat',
         'entreprises.idPays','entreprises.idProvince','entreprises.edition','entreprises.facebook',
         'entreprises.linkedin','entreprises.twitter','entreprises.siteweb','entreprises.rccm',
         'entreprises.invPersonnel','entreprises.invHub','entreprises.invRecherche',
         'entreprises.chiffreAffaire','entreprises.nbremploye','entreprises.slug','entreprises.logo',
             //forme
             'forme_juridiques.nomForme','secteurs.nomSecteur',
             //users
             'users.name','users.email','users.avatar','users.telephone','users.adresse',
             //
             'provinces.nomProvince','pays.nomPays', 'entreprises.created_at')
         ->get();
         $output='';
         foreach ($data1 as $row) 
         {                                
             $nomEse=$row->nomEntreprise;
             $adresseEse=$row->adresseEntreprise;
             $Tel1Ese=$row->telephoneEntreprise;
             $Tel2Ese=$row->telephone;
             $siteEse=$row->siteweb;
             $emailEse=$row->emailEntreprise;
             $idNatEse=$row->rccm;
             $numImpotEse=$row->rccm;
             $busnessName=$row->nomSecteur;
             $rccmEse=$row->rccm;
             $pic = $this->displayImg("fichier", 'logo.png');
             $siege=$row->nomForme;         
         }
 



         $sommePHT=0;
         $sommeTVA=0;
         $sommePTTF=0;
         // 
         $data2 =  DB::table('tvente_detail_vente')
         ->join('tvente_produit','tvente_produit.id','=','tvente_detail_vente.refProduit')
         ->join('tvente_categorie_produit','tvente_categorie_produit.id','=','tvente_produit.refCategorie')
 
         ->join('tvente_entete_vente','tvente_entete_vente.id','=','tvente_detail_vente.refEnteteVente')        
         ->join('tvente_module','tvente_module.id','=','tvente_entete_vente.module_id')
         ->join('tvente_services','tvente_services.id','=','tvente_entete_vente.refService')
         ->join('tvente_client','tvente_client.id','=','tvente_entete_vente.refClient')
         ->join('tvente_categorie_client','tvente_categorie_client.id','=','tvente_client.refCategieClient')  
         ->join('tfin_ssouscompte as compteclient','compteclient.id','=','tvente_categorie_client.compte_client')

         ->select(DB::raw('ROUND(SUM(((qteVente*puVente) - montantreduction)),4) as sommePHT, 
         ROUND(SUM(montanttva),4) as sommeTVA,
          ROUND(SUM(ROUND(((qteVente*puVente) - montantreduction + montanttva),4)),4) as sommePTTF'))
         ->where([
            ['dateVente','>=', $date1],
            ['dateVente','<=', $date2],
            ['tvente_entete_vente.etat_facture','=', $etat_facture],
            ['tvente_services.id','=', $idService]
        ])    
         ->get(); 
         //$idService
         $output='';
         foreach ($data2 as $row) 
         {                                
            $sommePHT=$row->sommePHT;
            $sommeTVA=$row->sommeTVA;
            $sommePTTF=$row->sommePTTF;                           
         }

         $CategorieClient = $etat_facture;  
         
         $services='';

         $data3= DB::table('tvente_entete_vente')
         ->join('tvente_module','tvente_module.id','=','tvente_entete_vente.module_id')
         ->join('tvente_services','tvente_services.id','=','tvente_entete_vente.refService')
         ->select('etat_facture','nom_service')
         ->where([
            ['dateVente','>=', $date1],
            ['dateVente','<=', $date2],
            ['tvente_entete_vente.etat_facture','=', $etat_facture],
            ['tvente_services.id','=', $idService]
        ])      
        ->get();      
        $output='';
        foreach ($data3 as $row) 
        {
            $services=$row->nom_service;              
        }

        $output='

               <!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Transitional//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd">
                <!-- saved from url=(0016)http://localhost -->
                <html>
                <head>
                    <title>rpt_RapportVentes</title>
                    <meta HTTP-EQUIV="Content-Type" CONTENT="text/html; charset=utf-8"/>
                    <style type="text/css">
                        .csB6F858D0 {color:#000000;background-color:#D6E5F4;border-left-style: none;border-top-style: none;border-right-style: none;border-bottom-style: none;font-family:Times New Roman; font-size:24px; font-weight:bold; font-style:normal; padding-left:2px;padding-right:2px;}
                        .cs18F2469C {color:#000000;background-color:#E0E0E0;border-left:#000000 1px solid;border-top:#000000 1px solid;border-right:#000000 1px solid;border-bottom:#000000 1px solid;font-family:Times New Roman; font-size:10px; font-weight:bold; font-style:normal; }
                        .cs797456E3 {color:#000000;background-color:#E0E0E0;border-left:#000000 1px solid;border-top:#000000 1px solid;border-right-style: none;border-bottom:#000000 1px solid;font-family:Times New Roman; font-size:10px; font-weight:bold; font-style:normal; }
                        .cs20251968 {color:#000000;background-color:#E0E0E0;border-left:#000000 1px solid;border-top:#000000 1px solid;border-right-style: none;border-bottom:#000000 1px solid;font-family:Times New Roman; font-size:13px; font-weight:bold; font-style:normal; }
                        .cs9FE9304F {color:#000000;background-color:#E0E0E0;border-left-style: none;border-top:#000000 1px solid;border-right:#000000 1px solid;border-bottom:#000000 1px solid;font-family:Times New Roman; font-size:13px; font-weight:bold; font-style:normal; }
                        .csFF9B7F36 {color:#000000;background-color:#E0E0E0;border-left-style: none;border-top:#000000 1px solid;border-right-style: none;border-bottom:#000000 1px solid;font-family:Times New Roman; font-size:10px; font-weight:bold; font-style:normal; }
                        .csEAC52FCD {color:#000000;background-color:#E0E0E0;border-left-style: none;border-top:#000000 1px solid;border-right-style: none;border-bottom:#000000 1px solid;font-family:Times New Roman; font-size:13px; font-weight:bold; font-style:normal; }
                        .cs56F73198 {color:#000000;background-color:transparent;border-left:#000000 1px solid;border-top:#000000 1px solid;border-right:#000000 1px solid;border-bottom:#000000 1px solid;font-family:Times New Roman; font-size:16px; font-weight:normal; font-style:normal; padding-left:2px;}
                        .cs8681714E {color:#000000;background-color:transparent;border-left:#000000 1px solid;border-top:#000000 1px solid;border-right-style: none;border-bottom:#000000 1px solid;font-family:Times New Roman; font-size:10px; font-weight:normal; font-style:normal; }
                        .csD06EB5B2 {color:#000000;background-color:transparent;border-left-style: none;border-top:#000000 1px solid;border-right:#000000 1px solid;border-bottom:#000000 1px solid;font-family:Times New Roman; font-size:10px; font-weight:normal; font-style:normal; }
                        .csBFBB3693 {color:#000000;background-color:transparent;border-left-style: none;border-top:#000000 1px solid;border-right-style: none;border-bottom:#000000 1px solid;font-family:Times New Roman; font-size:10px; font-weight:normal; font-style:normal; }
                        .cs612ED82F {color:#000000;background-color:transparent;border-left-style: none;border-top-style: none;border-right-style: none;border-bottom-style: none;font-family:Times New Roman; font-size:12px; font-weight:bold; font-style:normal; padding-left:2px;}
                        .csFFC1C457 {color:#000000;background-color:transparent;border-left-style: none;border-top-style: none;border-right-style: none;border-bottom-style: none;font-family:Times New Roman; font-size:12px; font-weight:normal; font-style:normal; padding-left:2px;}
                        .cs101A94F7 {color:#000000;background-color:transparent;border-left-style: none;border-top-style: none;border-right-style: none;border-bottom-style: none;font-family:Times New Roman; font-size:13px; font-weight:normal; font-style:normal; }
                        .csCE72709D {color:#000000;background-color:transparent;border-left-style: none;border-top-style: none;border-right-style: none;border-bottom-style: none;font-family:Times New Roman; font-size:14px; font-weight:bold; font-style:normal; padding-left:2px;}
                        .cs12FE94AA {color:#000000;background-color:transparent;border-left-style: none;border-top-style: none;border-right-style: none;border-bottom-style: none;font-family:Times New Roman; font-size:14px; font-weight:normal; font-style:normal; padding-left:2px;}
                        .csFBB219FE {color:#000000;background-color:transparent;border-left-style: none;border-top-style: none;border-right-style: none;border-bottom-style: none;font-family:Times New Roman; font-size:18px; font-weight:bold; font-style:normal; padding-left:2px;}
                        .cs739196BC {color:#5C5C5C;background-color:transparent;border-left-style: none;border-top-style: none;border-right-style: none;border-bottom-style: none;font-family:Segoe UI; font-size:11px; font-weight:normal; font-style:normal; }
                        .csF7D3565D {height:0px;width:0px;overflow:hidden;font-size:0px;line-height:0px;}
                    </style>
                </head>
                <body leftMargin=10 topMargin=10 rightMargin=10 bottomMargin=10 style="background-color:#FFFFFF">
                <table cellpadding="0" cellspacing="0" border="0" style="border-width:0px;empty-cells:show;width:957px;height:383px;position:relative;">
                    <tr>
                        <td style="width:0px;height:0px;"></td>
                        <td style="height:0px;width:10px;"></td>
                        <td style="height:0px;width:3px;"></td>
                        <td style="height:0px;width:84px;"></td>
                        <td style="height:0px;width:51px;"></td>
                        <td style="height:0px;width:71px;"></td>
                        <td style="height:0px;width:51px;"></td>
                        <td style="height:0px;width:73px;"></td>
                        <td style="height:0px;width:66px;"></td>
                        <td style="height:0px;width:82px;"></td>
                        <td style="height:0px;width:179px;"></td>
                        <td style="height:0px;width:24px;"></td>
                        <td style="height:0px;width:13px;"></td>
                        <td style="height:0px;width:17px;"></td>
                        <td style="height:0px;width:23px;"></td>
                        <td style="height:0px;width:30px;"></td>
                        <td style="height:0px;width:42px;"></td>
                        <td style="height:0px;width:49px;"></td>
                        <td style="height:0px;width:31px;"></td>
                        <td style="height:0px;width:58px;"></td>
                    </tr>
                    <tr style="vertical-align:top;">
                        <td style="width:0px;height:23px;"></td>
                        <td class="cs739196BC" colspan="8" style="width:409px;height:23px;line-height:14px;text-align:center;vertical-align:middle;"></td>
                        <td></td>
                        <td></td>
                        <td></td>
                        <td></td>
                        <td></td>
                        <td></td>
                        <td></td>
                        <td></td>
                        <td></td>
                        <td></td>
                        <td></td>
                    </tr>
                    <tr style="vertical-align:top;">
                        <td style="width:0px;height:9px;"></td>
                        <td></td>
                        <td></td>
                        <td></td>
                        <td></td>
                        <td></td>
                        <td></td>
                        <td></td>
                        <td></td>
                        <td></td>
                        <td></td>
                        <td></td>
                        <td></td>
                        <td></td>
                        <td></td>
                        <td></td>
                        <td></td>
                        <td></td>
                        <td></td>
                        <td></td>
                    </tr>
                    <tr style="vertical-align:top;">
                        <td style="width:0px;height:1px;"></td>
                        <td></td>
                        <td class="csFBB219FE" colspan="10" rowspan="2" style="width:682px;height:23px;line-height:21px;text-align:left;vertical-align:middle;"><nobr>'.$nomEse.'</nobr></td>
                        <td></td>
                        <td></td>
                        <td></td>
                        <td></td>
                        <td></td>
                        <td></td>
                        <td></td>
                        <td></td>
                    </tr>
                    <tr style="vertical-align:top;">
                        <td style="width:0px;height:22px;"></td>
                        <td></td>
                        <td></td>
                        <td></td>
                        <td class="cs101A94F7" colspan="5" rowspan="7" style="width:175px;height:144px;text-align:left;vertical-align:top;"><div style="overflow:hidden;width:175px;height:144px;">
                            <img alt="" src="'.$pic2.'" style="width:175px;height:144px;" /></div>
                        </td>
                        <td></td>
                    </tr>
                    <tr style="vertical-align:top;">
                        <td style="width:0px;height:22px;"></td>
                        <td></td>
                        <td class="csCE72709D" colspan="10" style="width:682px;height:22px;line-height:15px;text-align:left;vertical-align:middle;"><nobr>'.$busnessName.'</nobr></td>
                        <td></td>
                        <td></td>
                        <td></td>
                    </tr>
                    <tr style="vertical-align:top;">
                        <td style="width:0px;height:22px;"></td>
                        <td></td>
                        <td class="csCE72709D" colspan="10" style="width:682px;height:22px;line-height:15px;text-align:left;vertical-align:middle;"><nobr>RCCM'.$rccEse.'.&nbsp;ID-NAT.'.$idNatEse.'</nobr></td>
                        <td></td>
                        <td></td>
                        <td></td>
                    </tr>
                    <tr style="vertical-align:top;">
                        <td style="width:0px;height:22px;"></td>
                        <td></td>
                        <td class="csFFC1C457" colspan="10" style="width:682px;height:22px;line-height:13px;text-align:left;vertical-align:middle;">'.$adresseEse.'</td>
                        <td></td>
                        <td></td>
                        <td></td>
                    </tr>
                    <tr style="vertical-align:top;">
                        <td style="width:0px;height:22px;"></td>
                        <td></td>
                        <td class="csFFC1C457" colspan="10" style="width:682px;height:22px;line-height:13px;text-align:left;vertical-align:middle;"><nobr>Email&nbsp;:&nbsp;'.$emailEse.'</nobr></td>
                        <td></td>
                        <td></td>
                        <td></td>
                    </tr>
                    <tr style="vertical-align:top;">
                        <td style="width:0px;height:22px;"></td>
                        <td></td>
                        <td class="csFFC1C457" colspan="10" style="width:682px;height:22px;line-height:13px;text-align:left;vertical-align:middle;"><nobr>Site&nbsp;web&nbsp;:&nbsp;'.$siteEse.'</nobr></td>
                        <td></td>
                        <td></td>
                        <td></td>
                    </tr>
                    <tr style="vertical-align:top;">
                        <td style="width:0px;height:12px;"></td>
                        <td></td>
                        <td class="cs612ED82F" colspan="10" rowspan="2" style="width:682px;height:23px;line-height:13px;text-align:left;vertical-align:middle;"><nobr>T&#233;l&#233;phone&nbsp;:&nbsp;'.$Tel1Ese.'&nbsp;&nbsp;24h/24</nobr></td>
                        <td></td>
                        <td></td>
                        <td></td>
                    </tr>
                    <tr style="vertical-align:top;">
                        <td style="width:0px;height:11px;"></td>
                        <td></td>
                        <td></td>
                        <td></td>
                        <td></td>
                        <td></td>
                        <td></td>
                        <td></td>
                        <td></td>
                        <td></td>
                    </tr>
                    <tr style="vertical-align:top;">
                        <td style="width:0px;height:8px;"></td>
                        <td></td>
                        <td></td>
                        <td></td>
                        <td></td>
                        <td></td>
                        <td></td>
                        <td></td>
                        <td></td>
                        <td></td>
                        <td></td>
                        <td></td>
                        <td></td>
                        <td></td>
                        <td></td>
                        <td></td>
                        <td></td>
                        <td></td>
                        <td></td>
                        <td></td>
                    </tr>
                    <tr style="vertical-align:top;">
                        <td style="width:0px;height:32px;"></td>
                        <td></td>
                        <td></td>
                        <td></td>
                        <td></td>
                        <td class="csB6F858D0" colspan="11" style="width:625px;height:32px;line-height:28px;text-align:center;vertical-align:middle;"><nobr>RAPPORT&nbsp;JOURNALIER&nbsp;DES&nbsp;VENTES</nobr></td>
                        <td></td>
                        <td></td>
                        <td></td>
                        <td></td>
                    </tr>
                    <tr style="vertical-align:top;">
                        <td style="width:0px;height:19px;"></td>
                        <td></td>
                        <td></td>
                        <td></td>
                        <td></td>
                        <td></td>
                        <td></td>
                        <td></td>
                        <td></td>
                        <td></td>
                        <td></td>
                        <td></td>
                        <td></td>
                        <td></td>
                        <td></td>
                        <td></td>
                        <td></td>
                        <td></td>
                        <td></td>
                        <td></td>
                    </tr>
                    <tr style="vertical-align:top;">
                        <td style="width:0px;height:23px;"></td>
                        <td></td>
                        <td class="cs56F73198" colspan="6" style="width:329px;height:21px;line-height:18px;text-align:left;vertical-align:top;"><nobr>&nbsp;PERIODE&nbsp;:&nbsp;&nbsp;Du&nbsp;&nbsp;'.$date1.'&nbsp;&nbsp;au&nbsp;'.$date2.'</nobr></td>
                        <td class="cs56F73198" colspan="12" style="width:610px;height:21px;line-height:18px;text-align:left;vertical-align:top;"><nobr>'.$services.' : '.$etat_facture.'</nobr></td>
                    </tr>
                    <tr style="vertical-align:top;">
                        <td style="width:0px;height:9px;"></td>
                        <td></td>
                        <td></td>
                        <td></td>
                        <td></td>
                        <td></td>
                        <td></td>
                        <td></td>
                        <td></td>
                        <td></td>
                        <td></td>
                        <td></td>
                        <td></td>
                        <td></td>
                        <td></td>
                        <td></td>
                        <td></td>
                        <td></td>
                        <td></td>
                        <td></td>
                    </tr>
                    <tr style="vertical-align:top;">
                        <td style="width:0px;height:24px;"></td>
                        <td></td>
                        <td></td>
                        <td class="cs9FE9304F" style="width:83px;height:22px;line-height:15px;text-align:center;vertical-align:middle;"><nobr>N&#176;&nbsp;FACTURE</nobr></td>
                        <td class="cs9FE9304F" colspan="3" style="width:172px;height:22px;line-height:15px;text-align:center;vertical-align:middle;"><nobr>CLIENT</nobr></td>
                        <td class="cs9FE9304F" style="width:72px;height:22px;line-height:15px;text-align:center;vertical-align:middle;"><nobr>DATE</nobr></td>
                        <td class="cs9FE9304F" colspan="2" style="width:147px;height:22px;line-height:15px;text-align:center;vertical-align:middle;"><nobr>CATEGORIE&nbsp;PROD.</nobr></td>
                        <td class="cs9FE9304F" style="width:178px;height:22px;line-height:15px;text-align:center;vertical-align:middle;"><nobr>ARTICLE</nobr></td>
                        <td class="cs9FE9304F" colspan="2" style="width:36px;height:22px;line-height:15px;text-align:center;vertical-align:middle;"><nobr>Qte</nobr></td>
                        <td class="cs9FE9304F" colspan="2" style="width:39px;height:22px;line-height:15px;text-align:center;vertical-align:middle;"><nobr>PU</nobr></td>
                        <td class="csEAC52FCD" colspan="2" style="width:72px;height:22px;line-height:15px;text-align:center;vertical-align:middle;"><nobr>PHT</nobr></td>
                        <td class="cs20251968" style="width:48px;height:22px;line-height:15px;text-align:center;vertical-align:middle;"><nobr>TVA</nobr></td>
                        <td class="cs20251968" colspan="2" style="width:88px;height:22px;line-height:15px;text-align:center;vertical-align:middle;"><nobr>PTTTC</nobr></td>
                    </tr>
                    ';

                            $output .= $this->showDetailVente_EtatfactureService($date1,$date2,$etat_facture,$idService); 

                            $output.='
                    <tr style="vertical-align:top;">
                        <td style="width:0px;height:24px;"></td>
                        <td></td>
                        <td></td>
                        <td></td>
                        <td></td>
                        <td></td>
                        <td></td>
                        <td></td>
                        <td></td>
                        <td></td>
                        <td></td>
                        <td class="cs18F2469C" colspan="4" style="width:75px;height:22px;line-height:11px;text-align:center;vertical-align:middle;"><nobr>TOTAL&nbsp;($)&nbsp;:</nobr></td>
                        <td class="csFF9B7F36" colspan="2" style="width:72px;height:22px;line-height:11px;text-align:center;vertical-align:middle;"><nobr>'.$sommePHT.'$</nobr></td>
                        <td class="cs797456E3" style="width:48px;height:22px;line-height:11px;text-align:center;vertical-align:middle;"><nobr>'.$sommeTVA.'$</nobr></td>
                        <td class="cs797456E3" colspan="2" style="width:88px;height:22px;line-height:11px;text-align:center;vertical-align:middle;"><nobr>'.$sommePTTF.'$</nobr></td>
                    </tr>
                    <tr style="vertical-align:top;">
                        <td style="width:0px;height:10px;"></td>
                        <td></td>
                        <td></td>
                        <td></td>
                        <td></td>
                        <td></td>
                        <td></td>
                        <td></td>
                        <td></td>
                        <td></td>
                        <td></td>
                        <td></td>
                        <td></td>
                        <td></td>
                        <td></td>
                        <td></td>
                        <td></td>
                        <td></td>
                        <td></td>
                        <td></td>
                    </tr>
                    <tr style="vertical-align:top;">
                        <td style="width:0px;height:22px;"></td>
                        <td></td>
                        <td class="cs12FE94AA" colspan="4" style="width:207px;height:22px;line-height:16px;text-align:left;vertical-align:top;"><nobr>Fait&nbsp;&#224;&nbsp;Goma&nbsp;le&nbsp;&nbsp;'.date('Y-m-d').'</nobr></td>
                        <td></td>
                        <td></td>
                        <td></td>
                        <td></td>
                        <td></td>
                        <td></td>
                        <td></td>
                        <td></td>
                        <td></td>
                        <td></td>
                        <td></td>
                        <td></td>
                        <td></td>
                        <td></td>
                    </tr>
                </table>
                </body>
                </html>
        
        ';  
       
        return $output; 

}
function showDetailVente_EtatfactureService($date1,$date2,$etat_facture,$idService)
{
        $data = DB::table('tvente_detail_vente')
        ->join('tvente_produit','tvente_produit.id','=','tvente_detail_vente.refProduit')
        ->join('tvente_categorie_produit','tvente_categorie_produit.id','=','tvente_produit.refCategorie')
    
        ->join('tvente_entete_vente','tvente_entete_vente.id','=','tvente_detail_vente.refEnteteVente')        
        ->join('tvente_module','tvente_module.id','=','tvente_entete_vente.module_id')
        ->join('tvente_services','tvente_services.id','=','tvente_entete_vente.refService')
        ->join('tvente_client','tvente_client.id','=','tvente_entete_vente.refClient')
        ->join('tvente_categorie_client','tvente_categorie_client.id','=','tvente_client.refCategieClient')  
        // ->join('tfin_ssouscompte as compteclient','compteclient.id','=','tvente_categorie_client.compte_client')
    
        // ->join('tfin_ssouscompte as comptevente','comptevente.id','=','tvente_categorie_produit.compte_vente')
        // ->join('tfin_ssouscompte as comptevariation','comptevariation.id','=','tvente_categorie_produit.compte_variationstock')
        // ->join('tfin_ssouscompte as compteperte','compteperte.id','=','tvente_categorie_produit.compte_perte')
        // ->join('tfin_ssouscompte as compteproduit','compteproduit.id','=','tvente_categorie_produit.compte_produit')
        // ->join('tfin_ssouscompte as comptedestockage','comptedestockage.id','=','tvente_categorie_produit.compte_destockage')
      
    
        ->select('tvente_detail_vente.id','refEnteteVente','refProduit','tvente_detail_vente.compte_vente',
        'tvente_detail_vente.compte_variationstock','tvente_detail_vente.compte_perte','tvente_detail_vente.compte_produit',
        'tvente_detail_vente.compte_destockage','puVente','qteVente','uniteVente','puBase','qteBase',
        'tvente_detail_vente.uniteBase','cmupVente','tvente_detail_vente.devise','tvente_detail_vente.taux',
        'montanttva','montantreduction',
        'tvente_detail_vente.active','tvente_detail_vente.author','tvente_detail_vente.refUser',
        'tvente_detail_vente.created_at','idStockService',
        //Produit
        'tvente_produit.designation','tvente_produit.refCategorie','tvente_produit.refUniteBase',
        'tvente_produit.pu','tvente_produit.qte','tvente_produit.cmup','tvente_produit.taux',
        'tvente_produit.Oldcode','tvente_produit.Newcode','tvente_produit.tvaapplique',
        'tvente_produit.estvendable','tvente_categorie_produit.designation as Categorie',
        //client 
        'noms','sexe','contact','mail','adresse','pieceidentite','numeroPiece','dateLivrePiece',
        'lieulivraisonCarte','nationnalite','datenaissance','lieunaissance','profession','occupation',
        'nombreEnfant','dateArriverGoma','arriverPar','refCategieClient','photo','slug',
        "tvente_categorie_client.designation as CategorieClient","compte_client",
        // 'compteclient.refSousCompte','compteclient.nom_ssouscompte','compteclient.numero_ssouscompte',
        //ente vente
        'nom_service', "tvente_module.nom_module",'tvente_entete_vente.code','refClient','refService','refReservation','module_id',
        'dateVente','libelle','tvente_entete_vente.montant','tvente_entete_vente.paie','reduction','totaltva',
        //compte produit
        // 'comptevente.refSousCompte as refSousCompteVente','comptevente.nom_ssouscompte as nom_ssouscompteVente',
        // 'comptevente.numero_ssouscompte as numero_ssouscompteVente'
        // ,'comptevariation.refSousCompte as refSousCompteVariation','comptevariation.nom_ssouscompte as nom_ssouscompteVariation',
        // 'comptevariation.numero_ssouscompte as numero_ssouscompteVariation'
        // ,'compteperte.refSousCompte as refSousComptePerte','compteperte.nom_ssouscompte as nom_ssouscomptePerte',
        // 'compteperte.numero_ssouscompte as numero_ssouscomptePerte'
        // ,'compteproduit.refSousCompte as refSousCompteProduit','compteproduit.nom_ssouscompte as nom_ssouscompteProduit',
        // 'compteproduit.numero_ssouscompte as numero_ssouscompteProduit'
        // ,'comptedestockage.refSousCompte as refSousCompteDestockage','comptedestockage.nom_ssouscompte as nom_ssouscompteDestockage',
        // 'comptedestockage.numero_ssouscompte as numero_ssouscompteDestockage',
        'priseencharge')
       ->selectRaw('ROUND(((qteVente*puVente) - montantreduction),2) as PTVente')
       ->selectRaw('ROUND(((qteVente*puVente) - montantreduction + montanttva),2) as PTVenteTVA')
       ->selectRaw('ROUND((IFNULL(montant,0)),2) as totalFacture')
       ->selectRaw('ROUND((montanttva),2) as TotalTVA')
       ->selectRaw('ROUND((((IFNULL(montant,0)) - montantreduction)+(montanttva)),2) as PTTTC')
       ->selectRaw('((qteVente*puVente)/tvente_detail_vente.taux) as PTVenteFC')
       ->selectRaw('(qteBase*puBase) as PTBase')
       ->selectRaw('IFNULL(paie,0) as totalPaie')
       ->selectRaw('(IFNULL(montant,0)-IFNULL(paie,0)) as RestePaie')
        ->selectRaw('CONCAT("S",YEAR(dateVente),"",MONTH(dateVente),"00",refEnteteVente) as codeFacture')
        ->where([
            ['dateVente','>=', $date1],
            ['dateVente','<=', $date2],
            ['tvente_entete_vente.etat_facture','=', $etat_facture],
            ['tvente_services.id','=', $idService]
        ])
        ->orderBy("tvente_detail_vente.created_at", "asc")
        ->get();
        $output='';

        foreach ($data as $row) 
        {
            $output .='
            <tr style="vertical-align:top;">
                <td style="width:0px;height:24px;"></td>
                <td></td>
                <td></td>
                <td class="csD06EB5B2" style="width:83px;height:22px;line-height:11px;text-align:center;vertical-align:middle;">'.$row->codeFacture.'</td>
                <td class="csD06EB5B2" colspan="3" style="width:172px;height:22px;line-height:11px;text-align:left;vertical-align:middle;">'.$row->noms.'</td>
                <td class="csD06EB5B2" style="width:72px;height:22px;line-height:11px;text-align:center;vertical-align:middle;">'.$row->dateVente.'</td>
                <td class="csD06EB5B2" colspan="2" style="width:147px;height:22px;line-height:11px;text-align:left;vertical-align:middle;">'.$row->Categorie.'</td>
                <td class="csD06EB5B2" style="width:178px;height:22px;line-height:11px;text-align:left;vertical-align:middle;">'.$row->designation.'</td>
                <td class="csD06EB5B2" colspan="2" style="width:36px;height:22px;line-height:11px;text-align:center;vertical-align:middle;">'.$row->qteVente.'</td>
                <td class="csD06EB5B2" colspan="2" style="width:39px;height:22px;line-height:11px;text-align:center;vertical-align:middle;">'.$row->puVente.'$</td>
                <td class="csBFBB3693" colspan="2" style="width:72px;height:22px;line-height:11px;text-align:center;vertical-align:middle;">'.$row->PTVente.'$</td>
                <td class="cs8681714E" style="width:48px;height:22px;line-height:11px;text-align:center;vertical-align:middle;">'.$row->montanttva.'$</td>
                <td class="cs8681714E" colspan="2" style="width:88px;height:22px;line-height:11px;text-align:center;vertical-align:middle;">'.$row->PTVenteTVA.'$</td>
            </tr>
        '; 
           
   
    }

    return $output;

}

public function fetch_rapport_detailvente_date_etat_facture(Request $request)
{
    //refDepartement

    if ($request->get('date1') && $request->get('date2')&& $request->get('etat_facture')) {
        // code...
        $date1 = $request->get('date1');
        $date2 = $request->get('date2');
        $etat_facture = $request->get('etat_facture');

        $html ='<html><head><meta http-equiv="Content-Type" content="text/html; charset=utf-8"/>';
        $html .= $this->printRapportDetailVente_EtatFacture($date1, $date2,$etat_facture);       
        $html .='<script>window.print()</script>';

        echo($html); 

    } else {
        // code...
    }  
    
}
function printRapportDetailVente_EtatFacture($date1, $date2,$etat_facture)
{

         //Info Entreprise
         $nomEse='';
         $adresseEse='';
         $Tel1Ese='';
         $Tel2Ese='';
         $siteEse='';
         $emailEse='';
         $idNatEse='';
         $numImpotEse='';
         $rccEse='';
         $siege='';
         $busnessName='';
         $pic='';
         $pic2 = $this->displayImg("fichier", 'logo.png');
         $logo='';
 
         $data1 = DB::table('entreprises')
         ->join('secteurs','secteurs.id','=','entreprises.idsecteur')
         ->join('forme_juridiques','forme_juridiques.id','=','entreprises.idforme')
 
         ->join('pays','pays.id','=','entreprises.idPays')
         ->join('provinces','provinces.id','=','entreprises.idProvince')
         ->join('users','users.id','=','entreprises.ceo')        
         ->select('entreprises.id as id','entreprises.id as idEntreprise',
         'entreprises.ceo','entreprises.nomEntreprise','entreprises.descriptionEntreprise',
         'entreprises.emailEntreprise','entreprises.adresseEntreprise',
         'entreprises.telephoneEntreprise','entreprises.solutionEntreprise','entreprises.idsecteur',
         'entreprises.idforme','entreprises.etat',
         'entreprises.idPays','entreprises.idProvince','entreprises.edition','entreprises.facebook',
         'entreprises.linkedin','entreprises.twitter','entreprises.siteweb','entreprises.rccm',
         'entreprises.invPersonnel','entreprises.invHub','entreprises.invRecherche',
         'entreprises.chiffreAffaire','entreprises.nbremploye','entreprises.slug','entreprises.logo',
             //forme
             'forme_juridiques.nomForme','secteurs.nomSecteur',
             //users
             'users.name','users.email','users.avatar','users.telephone','users.adresse',
             //
             'provinces.nomProvince','pays.nomPays', 'entreprises.created_at')
         ->get();
         $output='';
         foreach ($data1 as $row) 
         {                                
             $nomEse=$row->nomEntreprise;
             $adresseEse=$row->adresseEntreprise;
             $Tel1Ese=$row->telephoneEntreprise;
             $Tel2Ese=$row->telephone;
             $siteEse=$row->siteweb;
             $emailEse=$row->emailEntreprise;
             $idNatEse=$row->rccm;
             $numImpotEse=$row->rccm;
             $busnessName=$row->nomSecteur;
             $rccmEse=$row->rccm;
             $pic = $this->displayImg("fichier", 'logo.png');
             $siege=$row->nomForme;         
         }
 



         $sommePHT=0;
         $sommeTVA=0;
         $sommePTTF=0;
         // 
         $data2 =  DB::table('tvente_detail_vente')
         ->join('tvente_produit','tvente_produit.id','=','tvente_detail_vente.refProduit')
         ->join('tvente_categorie_produit','tvente_categorie_produit.id','=','tvente_produit.refCategorie')
 
         ->join('tvente_entete_vente','tvente_entete_vente.id','=','tvente_detail_vente.refEnteteVente')        
         ->join('tvente_module','tvente_module.id','=','tvente_entete_vente.module_id')
         ->join('tvente_services','tvente_services.id','=','tvente_entete_vente.refService')
         ->join('tvente_client','tvente_client.id','=','tvente_entete_vente.refClient')
         ->join('tvente_categorie_client','tvente_categorie_client.id','=','tvente_client.refCategieClient')  
         ->join('tfin_ssouscompte as compteclient','compteclient.id','=','tvente_categorie_client.compte_client')

         ->select(DB::raw('ROUND(SUM(((qteVente*puVente) - montantreduction)),4) as sommePHT, 
         ROUND(SUM(montanttva),4) as sommeTVA,
          ROUND(SUM(ROUND(((qteVente*puVente) - montantreduction + montanttva),4)),4) as sommePTTF'))
         ->where([
            ['dateVente','>=', $date1],
            ['dateVente','<=', $date2],
            ['tvente_entete_vente.etat_facture','=', $etat_facture]
        ])    
         ->get(); 
         //$idService
         $output='';
         foreach ($data2 as $row) 
         {                                
            $sommePHT=$row->sommePHT;
            $sommeTVA=$row->sommeTVA;
            $sommePTTF=$row->sommePTTF;                           
         }

         $CategorieClient = $etat_facture;  
         


        $output='

               <!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Transitional//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd">
                <!-- saved from url=(0016)http://localhost -->
                <html>
                <head>
                    <title>rpt_RapportVentes</title>
                    <meta HTTP-EQUIV="Content-Type" CONTENT="text/html; charset=utf-8"/>
                    <style type="text/css">
                        .csB6F858D0 {color:#000000;background-color:#D6E5F4;border-left-style: none;border-top-style: none;border-right-style: none;border-bottom-style: none;font-family:Times New Roman; font-size:24px; font-weight:bold; font-style:normal; padding-left:2px;padding-right:2px;}
                        .cs18F2469C {color:#000000;background-color:#E0E0E0;border-left:#000000 1px solid;border-top:#000000 1px solid;border-right:#000000 1px solid;border-bottom:#000000 1px solid;font-family:Times New Roman; font-size:10px; font-weight:bold; font-style:normal; }
                        .cs797456E3 {color:#000000;background-color:#E0E0E0;border-left:#000000 1px solid;border-top:#000000 1px solid;border-right-style: none;border-bottom:#000000 1px solid;font-family:Times New Roman; font-size:10px; font-weight:bold; font-style:normal; }
                        .cs20251968 {color:#000000;background-color:#E0E0E0;border-left:#000000 1px solid;border-top:#000000 1px solid;border-right-style: none;border-bottom:#000000 1px solid;font-family:Times New Roman; font-size:13px; font-weight:bold; font-style:normal; }
                        .cs9FE9304F {color:#000000;background-color:#E0E0E0;border-left-style: none;border-top:#000000 1px solid;border-right:#000000 1px solid;border-bottom:#000000 1px solid;font-family:Times New Roman; font-size:13px; font-weight:bold; font-style:normal; }
                        .csFF9B7F36 {color:#000000;background-color:#E0E0E0;border-left-style: none;border-top:#000000 1px solid;border-right-style: none;border-bottom:#000000 1px solid;font-family:Times New Roman; font-size:10px; font-weight:bold; font-style:normal; }
                        .csEAC52FCD {color:#000000;background-color:#E0E0E0;border-left-style: none;border-top:#000000 1px solid;border-right-style: none;border-bottom:#000000 1px solid;font-family:Times New Roman; font-size:13px; font-weight:bold; font-style:normal; }
                        .cs56F73198 {color:#000000;background-color:transparent;border-left:#000000 1px solid;border-top:#000000 1px solid;border-right:#000000 1px solid;border-bottom:#000000 1px solid;font-family:Times New Roman; font-size:16px; font-weight:normal; font-style:normal; padding-left:2px;}
                        .cs8681714E {color:#000000;background-color:transparent;border-left:#000000 1px solid;border-top:#000000 1px solid;border-right-style: none;border-bottom:#000000 1px solid;font-family:Times New Roman; font-size:10px; font-weight:normal; font-style:normal; }
                        .csD06EB5B2 {color:#000000;background-color:transparent;border-left-style: none;border-top:#000000 1px solid;border-right:#000000 1px solid;border-bottom:#000000 1px solid;font-family:Times New Roman; font-size:10px; font-weight:normal; font-style:normal; }
                        .csBFBB3693 {color:#000000;background-color:transparent;border-left-style: none;border-top:#000000 1px solid;border-right-style: none;border-bottom:#000000 1px solid;font-family:Times New Roman; font-size:10px; font-weight:normal; font-style:normal; }
                        .cs612ED82F {color:#000000;background-color:transparent;border-left-style: none;border-top-style: none;border-right-style: none;border-bottom-style: none;font-family:Times New Roman; font-size:12px; font-weight:bold; font-style:normal; padding-left:2px;}
                        .csFFC1C457 {color:#000000;background-color:transparent;border-left-style: none;border-top-style: none;border-right-style: none;border-bottom-style: none;font-family:Times New Roman; font-size:12px; font-weight:normal; font-style:normal; padding-left:2px;}
                        .cs101A94F7 {color:#000000;background-color:transparent;border-left-style: none;border-top-style: none;border-right-style: none;border-bottom-style: none;font-family:Times New Roman; font-size:13px; font-weight:normal; font-style:normal; }
                        .csCE72709D {color:#000000;background-color:transparent;border-left-style: none;border-top-style: none;border-right-style: none;border-bottom-style: none;font-family:Times New Roman; font-size:14px; font-weight:bold; font-style:normal; padding-left:2px;}
                        .cs12FE94AA {color:#000000;background-color:transparent;border-left-style: none;border-top-style: none;border-right-style: none;border-bottom-style: none;font-family:Times New Roman; font-size:14px; font-weight:normal; font-style:normal; padding-left:2px;}
                        .csFBB219FE {color:#000000;background-color:transparent;border-left-style: none;border-top-style: none;border-right-style: none;border-bottom-style: none;font-family:Times New Roman; font-size:18px; font-weight:bold; font-style:normal; padding-left:2px;}
                        .cs739196BC {color:#5C5C5C;background-color:transparent;border-left-style: none;border-top-style: none;border-right-style: none;border-bottom-style: none;font-family:Segoe UI; font-size:11px; font-weight:normal; font-style:normal; }
                        .csF7D3565D {height:0px;width:0px;overflow:hidden;font-size:0px;line-height:0px;}
                    </style>
                </head>
                <body leftMargin=10 topMargin=10 rightMargin=10 bottomMargin=10 style="background-color:#FFFFFF">
                <table cellpadding="0" cellspacing="0" border="0" style="border-width:0px;empty-cells:show;width:957px;height:383px;position:relative;">
                    <tr>
                        <td style="width:0px;height:0px;"></td>
                        <td style="height:0px;width:10px;"></td>
                        <td style="height:0px;width:3px;"></td>
                        <td style="height:0px;width:84px;"></td>
                        <td style="height:0px;width:51px;"></td>
                        <td style="height:0px;width:71px;"></td>
                        <td style="height:0px;width:51px;"></td>
                        <td style="height:0px;width:73px;"></td>
                        <td style="height:0px;width:66px;"></td>
                        <td style="height:0px;width:82px;"></td>
                        <td style="height:0px;width:179px;"></td>
                        <td style="height:0px;width:24px;"></td>
                        <td style="height:0px;width:13px;"></td>
                        <td style="height:0px;width:17px;"></td>
                        <td style="height:0px;width:23px;"></td>
                        <td style="height:0px;width:30px;"></td>
                        <td style="height:0px;width:42px;"></td>
                        <td style="height:0px;width:49px;"></td>
                        <td style="height:0px;width:31px;"></td>
                        <td style="height:0px;width:58px;"></td>
                    </tr>
                    <tr style="vertical-align:top;">
                        <td style="width:0px;height:23px;"></td>
                        <td class="cs739196BC" colspan="8" style="width:409px;height:23px;line-height:14px;text-align:center;vertical-align:middle;"></td>
                        <td></td>
                        <td></td>
                        <td></td>
                        <td></td>
                        <td></td>
                        <td></td>
                        <td></td>
                        <td></td>
                        <td></td>
                        <td></td>
                        <td></td>
                    </tr>
                    <tr style="vertical-align:top;">
                        <td style="width:0px;height:9px;"></td>
                        <td></td>
                        <td></td>
                        <td></td>
                        <td></td>
                        <td></td>
                        <td></td>
                        <td></td>
                        <td></td>
                        <td></td>
                        <td></td>
                        <td></td>
                        <td></td>
                        <td></td>
                        <td></td>
                        <td></td>
                        <td></td>
                        <td></td>
                        <td></td>
                        <td></td>
                    </tr>
                    <tr style="vertical-align:top;">
                        <td style="width:0px;height:1px;"></td>
                        <td></td>
                        <td class="csFBB219FE" colspan="10" rowspan="2" style="width:682px;height:23px;line-height:21px;text-align:left;vertical-align:middle;"><nobr>'.$nomEse.'</nobr></td>
                        <td></td>
                        <td></td>
                        <td></td>
                        <td></td>
                        <td></td>
                        <td></td>
                        <td></td>
                        <td></td>
                    </tr>
                    <tr style="vertical-align:top;">
                        <td style="width:0px;height:22px;"></td>
                        <td></td>
                        <td></td>
                        <td></td>
                        <td class="cs101A94F7" colspan="5" rowspan="7" style="width:175px;height:144px;text-align:left;vertical-align:top;"><div style="overflow:hidden;width:175px;height:144px;">
                            <img alt="" src="'.$pic2.'" style="width:175px;height:144px;" /></div>
                        </td>
                        <td></td>
                    </tr>
                    <tr style="vertical-align:top;">
                        <td style="width:0px;height:22px;"></td>
                        <td></td>
                        <td class="csCE72709D" colspan="10" style="width:682px;height:22px;line-height:15px;text-align:left;vertical-align:middle;"><nobr>'.$busnessName.'</nobr></td>
                        <td></td>
                        <td></td>
                        <td></td>
                    </tr>
                    <tr style="vertical-align:top;">
                        <td style="width:0px;height:22px;"></td>
                        <td></td>
                        <td class="csCE72709D" colspan="10" style="width:682px;height:22px;line-height:15px;text-align:left;vertical-align:middle;"><nobr>RCCM'.$rccEse.'.&nbsp;ID-NAT.'.$idNatEse.'</nobr></td>
                        <td></td>
                        <td></td>
                        <td></td>
                    </tr>
                    <tr style="vertical-align:top;">
                        <td style="width:0px;height:22px;"></td>
                        <td></td>
                        <td class="csFFC1C457" colspan="10" style="width:682px;height:22px;line-height:13px;text-align:left;vertical-align:middle;">'.$adresseEse.'</td>
                        <td></td>
                        <td></td>
                        <td></td>
                    </tr>
                    <tr style="vertical-align:top;">
                        <td style="width:0px;height:22px;"></td>
                        <td></td>
                        <td class="csFFC1C457" colspan="10" style="width:682px;height:22px;line-height:13px;text-align:left;vertical-align:middle;"><nobr>Email&nbsp;:&nbsp;'.$emailEse.'</nobr></td>
                        <td></td>
                        <td></td>
                        <td></td>
                    </tr>
                    <tr style="vertical-align:top;">
                        <td style="width:0px;height:22px;"></td>
                        <td></td>
                        <td class="csFFC1C457" colspan="10" style="width:682px;height:22px;line-height:13px;text-align:left;vertical-align:middle;"><nobr>Site&nbsp;web&nbsp;:&nbsp;'.$siteEse.'</nobr></td>
                        <td></td>
                        <td></td>
                        <td></td>
                    </tr>
                    <tr style="vertical-align:top;">
                        <td style="width:0px;height:12px;"></td>
                        <td></td>
                        <td class="cs612ED82F" colspan="10" rowspan="2" style="width:682px;height:23px;line-height:13px;text-align:left;vertical-align:middle;"><nobr>T&#233;l&#233;phone&nbsp;:&nbsp;'.$Tel1Ese.'&nbsp;&nbsp;24h/24</nobr></td>
                        <td></td>
                        <td></td>
                        <td></td>
                    </tr>
                    <tr style="vertical-align:top;">
                        <td style="width:0px;height:11px;"></td>
                        <td></td>
                        <td></td>
                        <td></td>
                        <td></td>
                        <td></td>
                        <td></td>
                        <td></td>
                        <td></td>
                        <td></td>
                    </tr>
                    <tr style="vertical-align:top;">
                        <td style="width:0px;height:8px;"></td>
                        <td></td>
                        <td></td>
                        <td></td>
                        <td></td>
                        <td></td>
                        <td></td>
                        <td></td>
                        <td></td>
                        <td></td>
                        <td></td>
                        <td></td>
                        <td></td>
                        <td></td>
                        <td></td>
                        <td></td>
                        <td></td>
                        <td></td>
                        <td></td>
                        <td></td>
                    </tr>
                    <tr style="vertical-align:top;">
                        <td style="width:0px;height:32px;"></td>
                        <td></td>
                        <td></td>
                        <td></td>
                        <td></td>
                        <td class="csB6F858D0" colspan="11" style="width:625px;height:32px;line-height:28px;text-align:center;vertical-align:middle;"><nobr>RAPPORT&nbsp;JOURNALIER&nbsp;DES&nbsp;VENTES</nobr></td>
                        <td></td>
                        <td></td>
                        <td></td>
                        <td></td>
                    </tr>
                    <tr style="vertical-align:top;">
                        <td style="width:0px;height:19px;"></td>
                        <td></td>
                        <td></td>
                        <td></td>
                        <td></td>
                        <td></td>
                        <td></td>
                        <td></td>
                        <td></td>
                        <td></td>
                        <td></td>
                        <td></td>
                        <td></td>
                        <td></td>
                        <td></td>
                        <td></td>
                        <td></td>
                        <td></td>
                        <td></td>
                        <td></td>
                    </tr>
                    <tr style="vertical-align:top;">
                        <td style="width:0px;height:23px;"></td>
                        <td></td>
                        <td class="cs56F73198" colspan="6" style="width:329px;height:21px;line-height:18px;text-align:left;vertical-align:top;"><nobr>&nbsp;PERIODE&nbsp;:&nbsp;&nbsp;Du&nbsp;&nbsp;'.$date1.'&nbsp;&nbsp;au&nbsp;'.$date2.'</nobr></td>
                        <td class="cs56F73198" colspan="12" style="width:610px;height:21px;line-height:18px;text-align:left;vertical-align:top;"><nobr>'.$etat_facture.'</nobr></td>
                    </tr>
                    <tr style="vertical-align:top;">
                        <td style="width:0px;height:9px;"></td>
                        <td></td>
                        <td></td>
                        <td></td>
                        <td></td>
                        <td></td>
                        <td></td>
                        <td></td>
                        <td></td>
                        <td></td>
                        <td></td>
                        <td></td>
                        <td></td>
                        <td></td>
                        <td></td>
                        <td></td>
                        <td></td>
                        <td></td>
                        <td></td>
                        <td></td>
                    </tr>
                    <tr style="vertical-align:top;">
                        <td style="width:0px;height:24px;"></td>
                        <td></td>
                        <td></td>
                        <td class="cs9FE9304F" style="width:83px;height:22px;line-height:15px;text-align:center;vertical-align:middle;"><nobr>N&#176;&nbsp;FACTURE</nobr></td>
                        <td class="cs9FE9304F" colspan="3" style="width:172px;height:22px;line-height:15px;text-align:center;vertical-align:middle;"><nobr>CLIENT</nobr></td>
                        <td class="cs9FE9304F" style="width:72px;height:22px;line-height:15px;text-align:center;vertical-align:middle;"><nobr>DATE</nobr></td>
                        <td class="cs9FE9304F" colspan="2" style="width:147px;height:22px;line-height:15px;text-align:center;vertical-align:middle;"><nobr>CATEGORIE&nbsp;PROD.</nobr></td>
                        <td class="cs9FE9304F" style="width:178px;height:22px;line-height:15px;text-align:center;vertical-align:middle;"><nobr>ARTICLE</nobr></td>
                        <td class="cs9FE9304F" colspan="2" style="width:36px;height:22px;line-height:15px;text-align:center;vertical-align:middle;"><nobr>Qte</nobr></td>
                        <td class="cs9FE9304F" colspan="2" style="width:39px;height:22px;line-height:15px;text-align:center;vertical-align:middle;"><nobr>PU</nobr></td>
                        <td class="csEAC52FCD" colspan="2" style="width:72px;height:22px;line-height:15px;text-align:center;vertical-align:middle;"><nobr>PHT</nobr></td>
                        <td class="cs20251968" style="width:48px;height:22px;line-height:15px;text-align:center;vertical-align:middle;"><nobr>TVA</nobr></td>
                        <td class="cs20251968" colspan="2" style="width:88px;height:22px;line-height:15px;text-align:center;vertical-align:middle;"><nobr>PTTTC</nobr></td>
                    </tr>
                    ';

                            $output .= $this->showDetailVente_Etatfacture($date1,$date2,$etat_facture); 

                            $output.='
                    <tr style="vertical-align:top;">
                        <td style="width:0px;height:24px;"></td>
                        <td></td>
                        <td></td>
                        <td></td>
                        <td></td>
                        <td></td>
                        <td></td>
                        <td></td>
                        <td></td>
                        <td></td>
                        <td></td>
                        <td class="cs18F2469C" colspan="4" style="width:75px;height:22px;line-height:11px;text-align:center;vertical-align:middle;"><nobr>TOTAL&nbsp;($)&nbsp;:</nobr></td>
                        <td class="csFF9B7F36" colspan="2" style="width:72px;height:22px;line-height:11px;text-align:center;vertical-align:middle;"><nobr>'.$sommePHT.'$</nobr></td>
                        <td class="cs797456E3" style="width:48px;height:22px;line-height:11px;text-align:center;vertical-align:middle;"><nobr>'.$sommeTVA.'$</nobr></td>
                        <td class="cs797456E3" colspan="2" style="width:88px;height:22px;line-height:11px;text-align:center;vertical-align:middle;"><nobr>'.$sommePTTF.'$</nobr></td>
                    </tr>
                    <tr style="vertical-align:top;">
                        <td style="width:0px;height:10px;"></td>
                        <td></td>
                        <td></td>
                        <td></td>
                        <td></td>
                        <td></td>
                        <td></td>
                        <td></td>
                        <td></td>
                        <td></td>
                        <td></td>
                        <td></td>
                        <td></td>
                        <td></td>
                        <td></td>
                        <td></td>
                        <td></td>
                        <td></td>
                        <td></td>
                        <td></td>
                    </tr>
                    <tr style="vertical-align:top;">
                        <td style="width:0px;height:22px;"></td>
                        <td></td>
                        <td class="cs12FE94AA" colspan="4" style="width:207px;height:22px;line-height:16px;text-align:left;vertical-align:top;"><nobr>Fait&nbsp;&#224;&nbsp;Goma&nbsp;le&nbsp;&nbsp;'.date('Y-m-d').'</nobr></td>
                        <td></td>
                        <td></td>
                        <td></td>
                        <td></td>
                        <td></td>
                        <td></td>
                        <td></td>
                        <td></td>
                        <td></td>
                        <td></td>
                        <td></td>
                        <td></td>
                        <td></td>
                        <td></td>
                    </tr>
                </table>
                </body>
                </html>
        
        ';  
       
        return $output; 

}
function showDetailVente_Etatfacture($date1,$date2,$etat_facture)
{
        $data = DB::table('tvente_detail_vente')
        ->join('tvente_produit','tvente_produit.id','=','tvente_detail_vente.refProduit')
        ->join('tvente_categorie_produit','tvente_categorie_produit.id','=','tvente_produit.refCategorie')
    
        ->join('tvente_entete_vente','tvente_entete_vente.id','=','tvente_detail_vente.refEnteteVente')        
        ->join('tvente_module','tvente_module.id','=','tvente_entete_vente.module_id')
        ->join('tvente_services','tvente_services.id','=','tvente_entete_vente.refService')
        ->join('tvente_client','tvente_client.id','=','tvente_entete_vente.refClient')
        ->join('tvente_categorie_client','tvente_categorie_client.id','=','tvente_client.refCategieClient')  
            
        ->select('tvente_detail_vente.id','refEnteteVente','refProduit','tvente_detail_vente.compte_vente',
        'tvente_detail_vente.compte_variationstock','tvente_detail_vente.compte_perte','tvente_detail_vente.compte_produit',
        'tvente_detail_vente.compte_destockage','puVente','qteVente','uniteVente','puBase','qteBase',
        'tvente_detail_vente.uniteBase','cmupVente','tvente_detail_vente.devise','tvente_detail_vente.taux',
        'montanttva','montantreduction',
        'tvente_detail_vente.active','tvente_detail_vente.author','tvente_detail_vente.refUser',
        'tvente_detail_vente.created_at','idStockService',
        //Produit
        'tvente_produit.designation','tvente_produit.refCategorie','tvente_produit.refUniteBase',
        'tvente_produit.pu','tvente_produit.qte','tvente_produit.cmup','tvente_produit.taux',
        'tvente_produit.Oldcode','tvente_produit.Newcode','tvente_produit.tvaapplique',
        'tvente_produit.estvendable','tvente_categorie_produit.designation as Categorie',
        //client 
        'noms','sexe','contact','mail','adresse','pieceidentite','numeroPiece','dateLivrePiece',
        'lieulivraisonCarte','nationnalite','datenaissance','lieunaissance','profession','occupation',
        'nombreEnfant','dateArriverGoma','arriverPar','refCategieClient','photo','slug',
        "tvente_categorie_client.designation as CategorieClient","compte_client",

        'nom_service', "tvente_module.nom_module",'tvente_entete_vente.code','refClient','refService','refReservation','module_id',
        'dateVente','libelle','tvente_entete_vente.montant','tvente_entete_vente.paie','reduction','totaltva',
        'priseencharge')
       ->selectRaw('ROUND(((qteVente*puVente) - montantreduction),2) as PTVente')
       ->selectRaw('ROUND(((qteVente*puVente) - montantreduction + montanttva),2) as PTVenteTVA')
       ->selectRaw('ROUND((IFNULL(montant,0)),2) as totalFacture')
       ->selectRaw('ROUND((montanttva),2) as TotalTVA')
       ->selectRaw('ROUND((((IFNULL(montant,0)) - montantreduction)+(montanttva)),2) as PTTTC')
       ->selectRaw('((qteVente*puVente)/tvente_detail_vente.taux) as PTVenteFC')
       ->selectRaw('(qteBase*puBase) as PTBase')
       ->selectRaw('IFNULL(paie,0) as totalPaie')
       ->selectRaw('(IFNULL(montant,0)-IFNULL(paie,0)) as RestePaie')
        ->selectRaw('CONCAT("S",YEAR(dateVente),"",MONTH(dateVente),"00",refEnteteVente) as codeFacture')
        ->where([
            ['dateVente','>=', $date1],
            ['dateVente','<=', $date2],
            ['tvente_entete_vente.etat_facture','=', $etat_facture]
        ])
        ->orderBy("tvente_detail_vente.created_at", "asc")
        ->get();
        $output='';

        foreach ($data as $row) 
        {
            $output .='
            <tr style="vertical-align:top;">
                <td style="width:0px;height:24px;"></td>
                <td></td>
                <td></td>
                <td class="csD06EB5B2" style="width:83px;height:22px;line-height:11px;text-align:center;vertical-align:middle;">'.$row->codeFacture.'</td>
                <td class="csD06EB5B2" colspan="3" style="width:172px;height:22px;line-height:11px;text-align:left;vertical-align:middle;">'.$row->noms.'</td>
                <td class="csD06EB5B2" style="width:72px;height:22px;line-height:11px;text-align:center;vertical-align:middle;">'.$row->dateVente.'</td>
                <td class="csD06EB5B2" colspan="2" style="width:147px;height:22px;line-height:11px;text-align:left;vertical-align:middle;">'.$row->Categorie.'</td>
                <td class="csD06EB5B2" style="width:178px;height:22px;line-height:11px;text-align:left;vertical-align:middle;">'.$row->designation.'</td>
                <td class="csD06EB5B2" colspan="2" style="width:36px;height:22px;line-height:11px;text-align:center;vertical-align:middle;">'.$row->qteVente.'</td>
                <td class="csD06EB5B2" colspan="2" style="width:39px;height:22px;line-height:11px;text-align:center;vertical-align:middle;">'.$row->puVente.'$</td>
                <td class="csBFBB3693" colspan="2" style="width:72px;height:22px;line-height:11px;text-align:center;vertical-align:middle;">'.$row->PTVente.'$</td>
                <td class="cs8681714E" style="width:48px;height:22px;line-height:11px;text-align:center;vertical-align:middle;">'.$row->montanttva.'$</td>
                <td class="cs8681714E" colspan="2" style="width:88px;height:22px;line-height:11px;text-align:center;vertical-align:middle;">'.$row->PTVenteTVA.'$</td>
            </tr>
        '; 
           
   
    }

    return $output;

}
//==================== RAPPORT DETAIL FACTURE SELON LES SERVICES =======================================

public function fetch_rapport_detailvente_date_service(Request $request)
{
    //refDepartement

    if ($request->get('date1') && $request->get('date2')&& $request->get('idService')) {
        // code...
        $date1 = $request->get('date1');
        $date2 = $request->get('date2');
        $idService = $request->get('idService');

        $html ='<html><head><meta http-equiv="Content-Type" content="text/html; charset=utf-8"/>';
        $html .= $this->printRapportDetailVente_Service($date1, $date2,$idService);       
        $html .='<script>window.print()</script>';

        echo($html);          

    } else {
        // code...
    }  
    
}
function printRapportDetailVente_Service($date1, $date2,$idService)
{

         //Info Entreprise
         $nomEse='';
         $adresseEse='';
         $Tel1Ese='';
         $Tel2Ese='';
         $siteEse='';
         $emailEse='';
         $idNatEse='';
         $numImpotEse='';
         $rccEse='';
         $siege='';
         $busnessName='';
         $pic='';
         $pic2 = $this->displayImg("fichier", 'logo.png');
         $logo='';
 
         $data1 = DB::table('entreprises')
         ->join('secteurs','secteurs.id','=','entreprises.idsecteur')
         ->join('forme_juridiques','forme_juridiques.id','=','entreprises.idforme')
 
         ->join('pays','pays.id','=','entreprises.idPays')
         ->join('provinces','provinces.id','=','entreprises.idProvince')
         ->join('users','users.id','=','entreprises.ceo')        
         ->select('entreprises.id as id','entreprises.id as idEntreprise',
         'entreprises.ceo','entreprises.nomEntreprise','entreprises.descriptionEntreprise',
         'entreprises.emailEntreprise','entreprises.adresseEntreprise',
         'entreprises.telephoneEntreprise','entreprises.solutionEntreprise','entreprises.idsecteur',
         'entreprises.idforme','entreprises.etat',
         'entreprises.idPays','entreprises.idProvince','entreprises.edition','entreprises.facebook',
         'entreprises.linkedin','entreprises.twitter','entreprises.siteweb','entreprises.rccm',
         'entreprises.invPersonnel','entreprises.invHub','entreprises.invRecherche',
         'entreprises.chiffreAffaire','entreprises.nbremploye','entreprises.slug','entreprises.logo',
             //forme
             'forme_juridiques.nomForme','secteurs.nomSecteur',
             //users
             'users.name','users.email','users.avatar','users.telephone','users.adresse',
             //
             'provinces.nomProvince','pays.nomPays', 'entreprises.created_at')
         ->get();
         $output='';
         foreach ($data1 as $row) 
         {                                
             $nomEse=$row->nomEntreprise;
             $adresseEse=$row->adresseEntreprise;
             $Tel1Ese=$row->telephoneEntreprise;
             $Tel2Ese=$row->telephone;
             $siteEse=$row->siteweb;
             $emailEse=$row->emailEntreprise;
             $idNatEse=$row->rccm;
             $numImpotEse=$row->rccm;
             $busnessName=$row->nomSecteur;
             $rccmEse=$row->rccm;
             $pic = $this->displayImg("fichier", 'logo.png');
             $siege=$row->nomForme;         
         }
 



         $sommePHT=0;
         $sommeTVA=0;
         $sommePTTF=0;
         // 
         $data2 =  DB::table('tvente_detail_vente')
         ->join('tvente_produit','tvente_produit.id','=','tvente_detail_vente.refProduit')
         ->join('tvente_categorie_produit','tvente_categorie_produit.id','=','tvente_produit.refCategorie')
 
         ->join('tvente_entete_vente','tvente_entete_vente.id','=','tvente_detail_vente.refEnteteVente')        
         ->join('tvente_module','tvente_module.id','=','tvente_entete_vente.module_id')
         ->join('tvente_services','tvente_services.id','=','tvente_entete_vente.refService')
         ->join('tvente_client','tvente_client.id','=','tvente_entete_vente.refClient')
         ->join('tvente_categorie_client','tvente_categorie_client.id','=','tvente_client.refCategieClient')  
         ->join('tfin_ssouscompte as compteclient','compteclient.id','=','tvente_categorie_client.compte_client')

         ->select(DB::raw('ROUND(SUM(((qteVente*puVente) - montantreduction)),4) as sommePHT, 
         ROUND(SUM(montanttva),4) as sommeTVA,
         ROUND(SUM(ROUND(((qteVente*puVente) - montantreduction + montanttva),4)),4) as sommePTTF'))
         ->where([
            ['dateVente','>=', $date1],
            ['dateVente','<=', $date2],
            ['tvente_services.id','=', $idService],
        ])    
         ->get(); 
         $output='';
         foreach ($data2 as $row) 
         {                                
            $sommePHT=$row->sommePHT;
            $sommeTVA=$row->sommeTVA;
            $sommePTTF=$row->sommePTTF;                           
         }




         $services='';         

         $data3=DB::table('tvente_detail_vente')
         ->join('tvente_produit','tvente_produit.id','=','tvente_detail_vente.refProduit')
         ->join('tvente_categorie_produit','tvente_categorie_produit.id','=','tvente_produit.refCategorie')
         ->join('tvente_entete_vente','tvente_entete_vente.id','=','tvente_detail_vente.refEnteteVente')
         ->join('tvente_services','tvente_services.id','=','tvente_entete_vente.refService')
         ->join('tvente_client','tvente_client.id','=','tvente_entete_vente.refClient')
         ->join('tvente_categorie_client','tvente_categorie_client.id','=','tvente_client.refCategieClient')
         ->select('tvente_detail_vente.id','refEnteteVente','refProduit','puVente','qteVente','dateVente',
         'libelle',"tvente_produit.designation","refCategorie","pu","tvente_categorie_produit.designation as Categorie",
         'tvente_detail_vente.author','tvente_detail_vente.created_at','noms','sexe',
         'contact','mail','adresse','pieceidentite','numeroPiece','dateLivrePiece','lieulivraisonCarte',
         'nationnalite','datenaissance','lieunaissance','profession','occupation','nombreEnfant',
         'dateArriverGoma','arriverPar','refCategieClient','photo','slug','nom_service',
         'tvente_detail_vente.devise','tvente_detail_vente.taux','tvente_categorie_client.designation as CategorieClient')
         ->where([
            ['dateVente','>=', $date1],
            ['dateVente','<=', $date2],
            ['tvente_services.id','=', $idService]
        ])      
        ->get();      
        $output='';
        foreach ($data3 as $row) 
        {
            $services=$row->nom_service;              
        }


          

        $output='
                <!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Transitional//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd">
                <!-- saved from url=(0016)http://localhost -->
                <html>
                <head>
                    <title>rpt_RapportVentes</title>
                    <meta HTTP-EQUIV="Content-Type" CONTENT="text/html; charset=utf-8"/>
                    <style type="text/css">
                        .csB6F858D0 {color:#000000;background-color:#D6E5F4;border-left-style: none;border-top-style: none;border-right-style: none;border-bottom-style: none;font-family:Times New Roman; font-size:24px; font-weight:bold; font-style:normal; padding-left:2px;padding-right:2px;}
                        .cs18F2469C {color:#000000;background-color:#E0E0E0;border-left:#000000 1px solid;border-top:#000000 1px solid;border-right:#000000 1px solid;border-bottom:#000000 1px solid;font-family:Times New Roman; font-size:10px; font-weight:bold; font-style:normal; }
                        .cs797456E3 {color:#000000;background-color:#E0E0E0;border-left:#000000 1px solid;border-top:#000000 1px solid;border-right-style: none;border-bottom:#000000 1px solid;font-family:Times New Roman; font-size:10px; font-weight:bold; font-style:normal; }
                        .cs20251968 {color:#000000;background-color:#E0E0E0;border-left:#000000 1px solid;border-top:#000000 1px solid;border-right-style: none;border-bottom:#000000 1px solid;font-family:Times New Roman; font-size:13px; font-weight:bold; font-style:normal; }
                        .cs9FE9304F {color:#000000;background-color:#E0E0E0;border-left-style: none;border-top:#000000 1px solid;border-right:#000000 1px solid;border-bottom:#000000 1px solid;font-family:Times New Roman; font-size:13px; font-weight:bold; font-style:normal; }
                        .csFF9B7F36 {color:#000000;background-color:#E0E0E0;border-left-style: none;border-top:#000000 1px solid;border-right-style: none;border-bottom:#000000 1px solid;font-family:Times New Roman; font-size:10px; font-weight:bold; font-style:normal; }
                        .csEAC52FCD {color:#000000;background-color:#E0E0E0;border-left-style: none;border-top:#000000 1px solid;border-right-style: none;border-bottom:#000000 1px solid;font-family:Times New Roman; font-size:13px; font-weight:bold; font-style:normal; }
                        .cs56F73198 {color:#000000;background-color:transparent;border-left:#000000 1px solid;border-top:#000000 1px solid;border-right:#000000 1px solid;border-bottom:#000000 1px solid;font-family:Times New Roman; font-size:16px; font-weight:normal; font-style:normal; padding-left:2px;}
                        .cs8681714E {color:#000000;background-color:transparent;border-left:#000000 1px solid;border-top:#000000 1px solid;border-right-style: none;border-bottom:#000000 1px solid;font-family:Times New Roman; font-size:10px; font-weight:normal; font-style:normal; }
                        .csD06EB5B2 {color:#000000;background-color:transparent;border-left-style: none;border-top:#000000 1px solid;border-right:#000000 1px solid;border-bottom:#000000 1px solid;font-family:Times New Roman; font-size:10px; font-weight:normal; font-style:normal; }
                        .csBFBB3693 {color:#000000;background-color:transparent;border-left-style: none;border-top:#000000 1px solid;border-right-style: none;border-bottom:#000000 1px solid;font-family:Times New Roman; font-size:10px; font-weight:normal; font-style:normal; }
                        .cs612ED82F {color:#000000;background-color:transparent;border-left-style: none;border-top-style: none;border-right-style: none;border-bottom-style: none;font-family:Times New Roman; font-size:12px; font-weight:bold; font-style:normal; padding-left:2px;}
                        .csFFC1C457 {color:#000000;background-color:transparent;border-left-style: none;border-top-style: none;border-right-style: none;border-bottom-style: none;font-family:Times New Roman; font-size:12px; font-weight:normal; font-style:normal; padding-left:2px;}
                        .cs101A94F7 {color:#000000;background-color:transparent;border-left-style: none;border-top-style: none;border-right-style: none;border-bottom-style: none;font-family:Times New Roman; font-size:13px; font-weight:normal; font-style:normal; }
                        .csCE72709D {color:#000000;background-color:transparent;border-left-style: none;border-top-style: none;border-right-style: none;border-bottom-style: none;font-family:Times New Roman; font-size:14px; font-weight:bold; font-style:normal; padding-left:2px;}
                        .cs12FE94AA {color:#000000;background-color:transparent;border-left-style: none;border-top-style: none;border-right-style: none;border-bottom-style: none;font-family:Times New Roman; font-size:14px; font-weight:normal; font-style:normal; padding-left:2px;}
                        .csFBB219FE {color:#000000;background-color:transparent;border-left-style: none;border-top-style: none;border-right-style: none;border-bottom-style: none;font-family:Times New Roman; font-size:18px; font-weight:bold; font-style:normal; padding-left:2px;}
                        .cs739196BC {color:#5C5C5C;background-color:transparent;border-left-style: none;border-top-style: none;border-right-style: none;border-bottom-style: none;font-family:Segoe UI; font-size:11px; font-weight:normal; font-style:normal; }
                        .csF7D3565D {height:0px;width:0px;overflow:hidden;font-size:0px;line-height:0px;}
                    </style>
                </head>
                <body leftMargin=10 topMargin=10 rightMargin=10 bottomMargin=10 style="background-color:#FFFFFF">
                <table cellpadding="0" cellspacing="0" border="0" style="border-width:0px;empty-cells:show;width:957px;height:383px;position:relative;">
                    <tr>
                        <td style="width:0px;height:0px;"></td>
                        <td style="height:0px;width:10px;"></td>
                        <td style="height:0px;width:3px;"></td>
                        <td style="height:0px;width:84px;"></td>
                        <td style="height:0px;width:51px;"></td>
                        <td style="height:0px;width:71px;"></td>
                        <td style="height:0px;width:51px;"></td>
                        <td style="height:0px;width:73px;"></td>
                        <td style="height:0px;width:66px;"></td>
                        <td style="height:0px;width:82px;"></td>
                        <td style="height:0px;width:179px;"></td>
                        <td style="height:0px;width:24px;"></td>
                        <td style="height:0px;width:13px;"></td>
                        <td style="height:0px;width:17px;"></td>
                        <td style="height:0px;width:23px;"></td>
                        <td style="height:0px;width:30px;"></td>
                        <td style="height:0px;width:42px;"></td>
                        <td style="height:0px;width:49px;"></td>
                        <td style="height:0px;width:31px;"></td>
                        <td style="height:0px;width:58px;"></td>
                    </tr>
                    <tr style="vertical-align:top;">
                        <td style="width:0px;height:23px;"></td>
                        <td class="cs739196BC" colspan="8" style="width:409px;height:23px;line-height:14px;text-align:center;vertical-align:middle;"></td>
                        <td></td>
                        <td></td>
                        <td></td>
                        <td></td>
                        <td></td>
                        <td></td>
                        <td></td>
                        <td></td>
                        <td></td>
                        <td></td>
                        <td></td>
                    </tr>
                    <tr style="vertical-align:top;">
                        <td style="width:0px;height:9px;"></td>
                        <td></td>
                        <td></td>
                        <td></td>
                        <td></td>
                        <td></td>
                        <td></td>
                        <td></td>
                        <td></td>
                        <td></td>
                        <td></td>
                        <td></td>
                        <td></td>
                        <td></td>
                        <td></td>
                        <td></td>
                        <td></td>
                        <td></td>
                        <td></td>
                        <td></td>
                    </tr>
                    <tr style="vertical-align:top;">
                        <td style="width:0px;height:1px;"></td>
                        <td></td>
                        <td class="csFBB219FE" colspan="10" rowspan="2" style="width:682px;height:23px;line-height:21px;text-align:left;vertical-align:middle;"><nobr>'.$nomEse.'</nobr></td>
                        <td></td>
                        <td></td>
                        <td></td>
                        <td></td>
                        <td></td>
                        <td></td>
                        <td></td>
                        <td></td>
                    </tr>
                    <tr style="vertical-align:top;">
                        <td style="width:0px;height:22px;"></td>
                        <td></td>
                        <td></td>
                        <td></td>
                        <td class="cs101A94F7" colspan="5" rowspan="7" style="width:175px;height:144px;text-align:left;vertical-align:top;"><div style="overflow:hidden;width:175px;height:144px;">
                            <img alt="" src="'.$pic2.'" style="width:175px;height:144px;" /></div>
                        </td>
                        <td></td>
                    </tr>
                    <tr style="vertical-align:top;">
                        <td style="width:0px;height:22px;"></td>
                        <td></td>
                        <td class="csCE72709D" colspan="10" style="width:682px;height:22px;line-height:15px;text-align:left;vertical-align:middle;"><nobr>'.$busnessName.'</nobr></td>
                        <td></td>
                        <td></td>
                        <td></td>
                    </tr>
                    <tr style="vertical-align:top;">
                        <td style="width:0px;height:22px;"></td>
                        <td></td>
                        <td class="csCE72709D" colspan="10" style="width:682px;height:22px;line-height:15px;text-align:left;vertical-align:middle;"><nobr>RCCM'.$rccEse.'.&nbsp;ID-NAT.'.$idNatEse.'</nobr></td>
                        <td></td>
                        <td></td>
                        <td></td>
                    </tr>
                    <tr style="vertical-align:top;">
                        <td style="width:0px;height:22px;"></td>
                        <td></td>
                        <td class="csFFC1C457" colspan="10" style="width:682px;height:22px;line-height:13px;text-align:left;vertical-align:middle;">'.$adresseEse.'</td>
                        <td></td>
                        <td></td>
                        <td></td>
                    </tr>
                    <tr style="vertical-align:top;">
                        <td style="width:0px;height:22px;"></td>
                        <td></td>
                        <td class="csFFC1C457" colspan="10" style="width:682px;height:22px;line-height:13px;text-align:left;vertical-align:middle;"><nobr>Email&nbsp;:&nbsp;'.$emailEse.'</nobr></td>
                        <td></td>
                        <td></td>
                        <td></td>
                    </tr>
                    <tr style="vertical-align:top;">
                        <td style="width:0px;height:22px;"></td>
                        <td></td>
                        <td class="csFFC1C457" colspan="10" style="width:682px;height:22px;line-height:13px;text-align:left;vertical-align:middle;"><nobr>Site&nbsp;web&nbsp;:&nbsp;'.$siteEse.'</nobr></td>
                        <td></td>
                        <td></td>
                        <td></td>
                    </tr>
                    <tr style="vertical-align:top;">
                        <td style="width:0px;height:12px;"></td>
                        <td></td>
                        <td class="cs612ED82F" colspan="10" rowspan="2" style="width:682px;height:23px;line-height:13px;text-align:left;vertical-align:middle;"><nobr>T&#233;l&#233;phone&nbsp;:&nbsp;'.$Tel1Ese.'&nbsp;&nbsp;24h/24</nobr></td>
                        <td></td>
                        <td></td>
                        <td></td>
                    </tr>
                    <tr style="vertical-align:top;">
                        <td style="width:0px;height:11px;"></td>
                        <td></td>
                        <td></td>
                        <td></td>
                        <td></td>
                        <td></td>
                        <td></td>
                        <td></td>
                        <td></td>
                        <td></td>
                    </tr>
                    <tr style="vertical-align:top;">
                        <td style="width:0px;height:8px;"></td>
                        <td></td>
                        <td></td>
                        <td></td>
                        <td></td>
                        <td></td>
                        <td></td>
                        <td></td>
                        <td></td>
                        <td></td>
                        <td></td>
                        <td></td>
                        <td></td>
                        <td></td>
                        <td></td>
                        <td></td>
                        <td></td>
                        <td></td>
                        <td></td>
                        <td></td>
                    </tr>
                    <tr style="vertical-align:top;">
                        <td style="width:0px;height:32px;"></td>
                        <td></td>
                        <td></td>
                        <td></td>
                        <td></td>
                        <td class="csB6F858D0" colspan="11" style="width:625px;height:32px;line-height:28px;text-align:center;vertical-align:middle;"><nobr>RAPPORT&nbsp;JOURNALIER&nbsp;DES&nbsp;VENTES</nobr></td>
                        <td></td>
                        <td></td>
                        <td></td>
                        <td></td>
                    </tr>
                    <tr style="vertical-align:top;">
                        <td style="width:0px;height:19px;"></td>
                        <td></td>
                        <td></td>
                        <td></td>
                        <td></td>
                        <td></td>
                        <td></td>
                        <td></td>
                        <td></td>
                        <td></td>
                        <td></td>
                        <td></td>
                        <td></td>
                        <td></td>
                        <td></td>
                        <td></td>
                        <td></td>
                        <td></td>
                        <td></td>
                        <td></td>
                    </tr>
                    <tr style="vertical-align:top;">
                        <td style="width:0px;height:23px;"></td>
                        <td></td>
                        <td class="cs56F73198" colspan="6" style="width:329px;height:21px;line-height:18px;text-align:left;vertical-align:top;"><nobr>&nbsp;PERIODE&nbsp;:&nbsp;&nbsp;Du&nbsp;&nbsp;'.$date1.'&nbsp;&nbsp;au&nbsp;'.$date2.'</nobr></td>
                        <td class="cs56F73198" colspan="12" style="width:610px;height:21px;line-height:18px;text-align:left;vertical-align:top;"><nobr>'.$services.'</nobr></td>
                    </tr>
                    <tr style="vertical-align:top;">
                        <td style="width:0px;height:9px;"></td>
                        <td></td>
                        <td></td>
                        <td></td>
                        <td></td>
                        <td></td>
                        <td></td>
                        <td></td>
                        <td></td>
                        <td></td>
                        <td></td>
                        <td></td>
                        <td></td>
                        <td></td>
                        <td></td>
                        <td></td>
                        <td></td>
                        <td></td>
                        <td></td>
                        <td></td>
                    </tr>
                    <tr style="vertical-align:top;">
                        <td style="width:0px;height:24px;"></td>
                        <td></td>
                        <td></td>
                        <td class="cs9FE9304F" style="width:83px;height:22px;line-height:15px;text-align:center;vertical-align:middle;"><nobr>N&#176;&nbsp;FACTURE</nobr></td>
                        <td class="cs9FE9304F" colspan="3" style="width:172px;height:22px;line-height:15px;text-align:center;vertical-align:middle;"><nobr>CLIENT</nobr></td>
                        <td class="cs9FE9304F" style="width:72px;height:22px;line-height:15px;text-align:center;vertical-align:middle;"><nobr>DATE</nobr></td>
                        <td class="cs9FE9304F" colspan="2" style="width:147px;height:22px;line-height:15px;text-align:center;vertical-align:middle;"><nobr>CATEGORIE&nbsp;PROD.</nobr></td>
                        <td class="cs9FE9304F" style="width:178px;height:22px;line-height:15px;text-align:center;vertical-align:middle;"><nobr>ARTICLE</nobr></td>
                        <td class="cs9FE9304F" colspan="2" style="width:36px;height:22px;line-height:15px;text-align:center;vertical-align:middle;"><nobr>Qte</nobr></td>
                        <td class="cs9FE9304F" colspan="2" style="width:39px;height:22px;line-height:15px;text-align:center;vertical-align:middle;"><nobr>PU</nobr></td>
                        <td class="csEAC52FCD" colspan="2" style="width:72px;height:22px;line-height:15px;text-align:center;vertical-align:middle;"><nobr>PHT</nobr></td>
                        <td class="cs20251968" style="width:48px;height:22px;line-height:15px;text-align:center;vertical-align:middle;"><nobr>TVA</nobr></td>
                        <td class="cs20251968" colspan="2" style="width:88px;height:22px;line-height:15px;text-align:center;vertical-align:middle;"><nobr>PTTTC</nobr></td>
                    </tr>
                    ';

                            $output .= $this->showDetailVente_Service($date1,$date2,$idService); 

                            $output.='
                    <tr style="vertical-align:top;">
                        <td style="width:0px;height:24px;"></td>
                        <td></td>
                        <td></td>
                        <td></td>
                        <td></td>
                        <td></td>
                        <td></td>
                        <td></td>
                        <td></td>
                        <td></td>
                        <td></td>
                        <td class="cs18F2469C" colspan="4" style="width:75px;height:22px;line-height:11px;text-align:center;vertical-align:middle;"><nobr>TOTAL&nbsp;($)&nbsp;:</nobr></td>
                        <td class="csFF9B7F36" colspan="2" style="width:72px;height:22px;line-height:11px;text-align:center;vertical-align:middle;"><nobr>'.$sommePHT.'$</nobr></td>
                        <td class="cs797456E3" style="width:48px;height:22px;line-height:11px;text-align:center;vertical-align:middle;"><nobr>'.$sommeTVA.'$</nobr></td>
                        <td class="cs797456E3" colspan="2" style="width:88px;height:22px;line-height:11px;text-align:center;vertical-align:middle;"><nobr>'.$sommePTTF.'$</nobr></td>
                    </tr>
                    <tr style="vertical-align:top;">
                        <td style="width:0px;height:10px;"></td>
                        <td></td>
                        <td></td>
                        <td></td>
                        <td></td>
                        <td></td>
                        <td></td>
                        <td></td>
                        <td></td>
                        <td></td>
                        <td></td>
                        <td></td>
                        <td></td>
                        <td></td>
                        <td></td>
                        <td></td>
                        <td></td>
                        <td></td>
                        <td></td>
                        <td></td>
                    </tr>
                    <tr style="vertical-align:top;">
                        <td style="width:0px;height:22px;"></td>
                        <td></td>
                        <td class="cs12FE94AA" colspan="4" style="width:207px;height:22px;line-height:16px;text-align:left;vertical-align:top;"><nobr>Fait&nbsp;&#224;&nbsp;Goma&nbsp;le&nbsp;&nbsp;'.date('Y-m-d').'</nobr></td>
                        <td></td>
                        <td></td>
                        <td></td>
                        <td></td>
                        <td></td>
                        <td></td>
                        <td></td>
                        <td></td>
                        <td></td>
                        <td></td>
                        <td></td>
                        <td></td>
                        <td></td>
                        <td></td>
                    </tr>
                </table>
                </body>
                </html>        
        ';  
       
        return $output; 

}
function showDetailVente_Service($date1,$date2,$idService)
{
        $data = DB::table('tvente_detail_vente')
        ->join('tvente_produit','tvente_produit.id','=','tvente_detail_vente.refProduit')
        ->join('tvente_categorie_produit','tvente_categorie_produit.id','=','tvente_produit.refCategorie')
    
        ->join('tvente_entete_vente','tvente_entete_vente.id','=','tvente_detail_vente.refEnteteVente')        
        ->join('tvente_module','tvente_module.id','=','tvente_entete_vente.module_id')
        ->join('tvente_services','tvente_services.id','=','tvente_entete_vente.refService')
        ->join('tvente_client','tvente_client.id','=','tvente_entete_vente.refClient')
        ->join('tvente_categorie_client','tvente_categorie_client.id','=','tvente_client.refCategieClient')  
        // ->join('tfin_ssouscompte as compteclient','compteclient.id','=','tvente_categorie_client.compte_client')
    
        // ->join('tfin_ssouscompte as comptevente','comptevente.id','=','tvente_categorie_produit.compte_vente')
        // ->join('tfin_ssouscompte as comptevariation','comptevariation.id','=','tvente_categorie_produit.compte_variationstock')
        // ->join('tfin_ssouscompte as compteperte','compteperte.id','=','tvente_categorie_produit.compte_perte')
        // ->join('tfin_ssouscompte as compteproduit','compteproduit.id','=','tvente_categorie_produit.compte_produit')
        // ->join('tfin_ssouscompte as comptedestockage','comptedestockage.id','=','tvente_categorie_produit.compte_destockage')
      
    
        ->select('tvente_detail_vente.id','refEnteteVente','refProduit','tvente_detail_vente.compte_vente',
        'tvente_detail_vente.compte_variationstock','tvente_detail_vente.compte_perte','tvente_detail_vente.compte_produit',
        'tvente_detail_vente.compte_destockage','puVente','qteVente','uniteVente','puBase','qteBase',
        'tvente_detail_vente.uniteBase','cmupVente','tvente_detail_vente.devise','tvente_detail_vente.taux',
        'montanttva','montantreduction',
        'tvente_detail_vente.active','tvente_detail_vente.author','tvente_detail_vente.refUser',
        'tvente_detail_vente.created_at','idStockService',
        //Produit
        'tvente_produit.designation','tvente_produit.refCategorie','tvente_produit.refUniteBase',
        'tvente_produit.pu','tvente_produit.qte','tvente_produit.cmup','tvente_produit.taux',
        'tvente_produit.Oldcode','tvente_produit.Newcode','tvente_produit.tvaapplique',
        'tvente_produit.estvendable','tvente_categorie_produit.designation as Categorie',
        //client 
        'noms','sexe','contact','mail','adresse','pieceidentite','numeroPiece','dateLivrePiece',
        'lieulivraisonCarte','nationnalite','datenaissance','lieunaissance','profession','occupation',
        'nombreEnfant','dateArriverGoma','arriverPar','refCategieClient','photo','slug',
        "tvente_categorie_client.designation as CategorieClient","compte_client",
        // 'compteclient.refSousCompte','compteclient.nom_ssouscompte','compteclient.numero_ssouscompte',
        //ente vente
        'nom_service', "tvente_module.nom_module",'tvente_entete_vente.code','refClient','refService','refReservation','module_id',
        'dateVente','libelle','tvente_entete_vente.montant','tvente_entete_vente.paie','reduction','totaltva',
        //compte produit
        // 'comptevente.refSousCompte as refSousCompteVente','comptevente.nom_ssouscompte as nom_ssouscompteVente',
        // 'comptevente.numero_ssouscompte as numero_ssouscompteVente'
        // ,'comptevariation.refSousCompte as refSousCompteVariation','comptevariation.nom_ssouscompte as nom_ssouscompteVariation',
        // 'comptevariation.numero_ssouscompte as numero_ssouscompteVariation'
        // ,'compteperte.refSousCompte as refSousComptePerte','compteperte.nom_ssouscompte as nom_ssouscomptePerte',
        // 'compteperte.numero_ssouscompte as numero_ssouscomptePerte'
        // ,'compteproduit.refSousCompte as refSousCompteProduit','compteproduit.nom_ssouscompte as nom_ssouscompteProduit',
        // 'compteproduit.numero_ssouscompte as numero_ssouscompteProduit'
        // ,'comptedestockage.refSousCompte as refSousCompteDestockage','comptedestockage.nom_ssouscompte as nom_ssouscompteDestockage',
        // 'comptedestockage.numero_ssouscompte as numero_ssouscompteDestockage',
        'priseencharge')
       ->selectRaw('ROUND(((qteVente*puVente) - montantreduction),2) as PTVente')
       ->selectRaw('ROUND(((qteVente*puVente) - montantreduction + montanttva),2) as PTVenteTVA')
       ->selectRaw('ROUND((IFNULL(montant,0)),2) as totalFacture')
       ->selectRaw('ROUND((montanttva),2) as TotalTVA')
       ->selectRaw('ROUND((((IFNULL(montant,0)) - montantreduction)+(montanttva)),2) as PTTTC')
       ->selectRaw('((qteVente*puVente)/tvente_detail_vente.taux) as PTVenteFC')
       ->selectRaw('(qteBase*puBase) as PTBase')
       ->selectRaw('IFNULL(paie,0) as totalPaie')
       ->selectRaw('(IFNULL(montant,0)-IFNULL(paie,0)) as RestePaie')
        ->selectRaw('CONCAT("S",YEAR(dateVente),"",MONTH(dateVente),"00",refEnteteVente) as codeFacture')
        ->where([
            ['dateVente','>=', $date1],
            ['dateVente','<=', $date2],
            ['tvente_services.id','=', $idService]
        ])
        ->orderBy("tvente_detail_vente.created_at", "asc")
        ->get();
        $output='';

        foreach ($data as $row) 
        {
            $output .='
            <tr style="vertical-align:top;">
                <td style="width:0px;height:24px;"></td>
                <td></td>
                <td></td>
                <td class="csD06EB5B2" style="width:83px;height:22px;line-height:11px;text-align:center;vertical-align:middle;">'.$row->codeFacture.'</td>
                <td class="csD06EB5B2" colspan="3" style="width:172px;height:22px;line-height:11px;text-align:left;vertical-align:middle;">'.$row->noms.'</td>
                <td class="csD06EB5B2" style="width:72px;height:22px;line-height:11px;text-align:center;vertical-align:middle;">'.$row->dateVente.'</td>
                <td class="csD06EB5B2" colspan="2" style="width:147px;height:22px;line-height:11px;text-align:left;vertical-align:middle;">'.$row->Categorie.'</td>
                <td class="csD06EB5B2" style="width:178px;height:22px;line-height:11px;text-align:left;vertical-align:middle;">'.$row->designation.'</td>
                <td class="csD06EB5B2" colspan="2" style="width:36px;height:22px;line-height:11px;text-align:center;vertical-align:middle;">'.$row->qteVente.'</td>
                <td class="csD06EB5B2" colspan="2" style="width:39px;height:22px;line-height:11px;text-align:center;vertical-align:middle;">'.$row->puVente.'$</td>
                <td class="csBFBB3693" colspan="2" style="width:72px;height:22px;line-height:11px;text-align:center;vertical-align:middle;">'.$row->PTVente.'$</td>
                <td class="cs8681714E" style="width:48px;height:22px;line-height:11px;text-align:center;vertical-align:middle;">'.$row->montanttva.'$</td>
                <td class="cs8681714E" colspan="2" style="width:88px;height:22px;line-height:11px;text-align:center;vertical-align:middle;">'.$row->PTVenteTVA.'$</td>
            </tr>
        '; 
           
   
    }

    return $output;

}

//==================== RAPPORT DETAIL UTILISATION SELON LES SERVICES =======================================

public function fetch_rapport_detailusage_date_service(Request $request)
{
    //refDepartement

    if ($request->get('date1') && $request->get('date2')&& $request->get('idService')) {
        // code...
        $date1 = $request->get('date1');
        $date2 = $request->get('date2');
        $idService = $request->get('idService');

        $html ='<html><head><meta http-equiv="Content-Type" content="text/html; charset=utf-8"/>';
        $html .= $this->printRapportDetailUsage_Service($date1, $date2,$idService);       
        $html .='<script>window.print()</script>';

        echo($html);          

    } else {
        // code...
    }  
    
}
function printRapportDetailUsage_Service($date1, $date2,$idService)
{

         //Info Entreprise
         $nomEse='';
         $adresseEse='';
         $Tel1Ese='';
         $Tel2Ese='';
         $siteEse='';
         $emailEse='';
         $idNatEse='';
         $numImpotEse='';
         $rccEse='';
         $siege='';
         $busnessName='';
         $pic='';
         $pic2 = $this->displayImg("fichier", 'logo.png');
         $logo='';
 
         $data1 = DB::table('entreprises')
         ->join('secteurs','secteurs.id','=','entreprises.idsecteur')
         ->join('forme_juridiques','forme_juridiques.id','=','entreprises.idforme')
 
         ->join('pays','pays.id','=','entreprises.idPays')
         ->join('provinces','provinces.id','=','entreprises.idProvince')
         ->join('users','users.id','=','entreprises.ceo')        
         ->select('entreprises.id as id','entreprises.id as idEntreprise',
         'entreprises.ceo','entreprises.nomEntreprise','entreprises.descriptionEntreprise',
         'entreprises.emailEntreprise','entreprises.adresseEntreprise',
         'entreprises.telephoneEntreprise','entreprises.solutionEntreprise','entreprises.idsecteur',
         'entreprises.idforme','entreprises.etat',
         'entreprises.idPays','entreprises.idProvince','entreprises.edition','entreprises.facebook',
         'entreprises.linkedin','entreprises.twitter','entreprises.siteweb','entreprises.rccm',
         'entreprises.invPersonnel','entreprises.invHub','entreprises.invRecherche',
         'entreprises.chiffreAffaire','entreprises.nbremploye','entreprises.slug','entreprises.logo',
             //forme
             'forme_juridiques.nomForme','secteurs.nomSecteur',
             //users
             'users.name','users.email','users.avatar','users.telephone','users.adresse',
             //
             'provinces.nomProvince','pays.nomPays', 'entreprises.created_at')
         ->get();
         $output='';
         foreach ($data1 as $row) 
         {                                
             $nomEse=$row->nomEntreprise;
             $adresseEse=$row->adresseEntreprise;
             $Tel1Ese=$row->telephoneEntreprise;
             $Tel2Ese=$row->telephone;
             $siteEse=$row->siteweb;
             $emailEse=$row->emailEntreprise;
             $idNatEse=$row->rccm;
             $numImpotEse=$row->rccm;
             $busnessName=$row->nomSecteur;
             $rccmEse=$row->rccm;
             $pic = $this->displayImg("fichier", 'logo.png');
             $siege=$row->nomForme;         
         }
 



         $sommePHT=0;
         $sommeTVA=0;
         $sommePTTF=0;
         // 
         $data2 =  DB::table('tvente_detail_utilisation')
         ->join('tvente_produit','tvente_produit.id','=','tvente_detail_utilisation.refProduit')
         ->join('tvente_categorie_produit','tvente_categorie_produit.id','=','tvente_produit.refCategorie')     
 
         ->join('tvente_entete_utilisation','tvente_entete_utilisation.id','=','tvente_detail_utilisation.refEnteteVente')        
         ->join('tvente_module','tvente_module.id','=','tvente_entete_utilisation.module_id')
         ->join('tvente_services','tvente_services.id','=','tvente_entete_utilisation.refService')
         ->join('tagent','tagent.id','=','tvente_entete_utilisation.agent_id')

         ->select(DB::raw('ROUND(SUM(((qteVente*puVente) - montantreduction)),4) as sommePHT, 
         ROUND(SUM(montanttva),4) as sommeTVA,
         ROUND(SUM(ROUND(((qteVente*puVente) - montantreduction + montanttva),4)),4) as sommePTTF'))
         ->where([
            ['dateUse','>=', $date1],
            ['dateUse','<=', $date2],
            ['tvente_services.id','=', $idService],
        ])    
         ->get(); 
         $output='';
         foreach ($data2 as $row) 
         {                                
            $sommePHT=$row->sommePHT;
            $sommeTVA=$row->sommeTVA;
            $sommePTTF=$row->sommePTTF;                           
         }




         $CategorieClient='';

         $data3=DB::table('tvente_detail_utilisation')
         ->join('tvente_entete_utilisation','tvente_entete_utilisation.id','=','tvente_detail_utilisation.refEnteteVente')        
         ->join('tvente_module','tvente_module.id','=','tvente_entete_utilisation.module_id')
         ->join('tvente_services','tvente_services.id','=','tvente_entete_utilisation.refService')
        
         ->select('nom_service', "tvente_module.nom_module",'tvente_entete_utilisation.code','refService',
         'module_id','dateUse','libelle')
         ->where([
            ['dateUse','>=', $date1],
            ['dateUse','<=', $date2],
            ['tvente_services.id','=', $idService]
        ])      
        ->get();      
        $output='';
        foreach ($data3 as $row) 
        {
            $CategorieClient=$row->nom_service;              
        }


          

        $output='

                <!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Transitional//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd">
                <!-- saved from url=(0016)http://localhost -->
                <html>
                <head>
                    <title>rpt_DetailFactureAbonne</title>
                    <meta HTTP-EQUIV="Content-Type" CONTENT="text/html; charset=utf-8"/>
                    <style type="text/css">
                        .csB6F858D0 {color:#000000;background-color:#D6E5F4;border-left-style: none;border-top-style: none;border-right-style: none;border-bottom-style: none;font-family:Times New Roman; font-size:24px; font-weight:bold; font-style:normal; padding-left:2px;padding-right:2px;}
                        .cs49AA1D99 {color:#000000;background-color:#E0E0E0;border-left:#000000 1px solid;border-top:#000000 1px solid;border-right:#000000 1px solid;border-bottom:#000000 1px solid;font-family:Times New Roman; font-size:13px; font-weight:bold; font-style:normal; }
                        .cs8AAF79E9 {color:#000000;background-color:#E0E0E0;border-left-style: none;border-top:#000000 1px solid;border-right:#000000 1px solid;border-bottom:#000000 1px solid;font-family:Times New Roman; font-size:12px; font-weight:bold; font-style:normal; }
                        .cs9FE9304F {color:#000000;background-color:#E0E0E0;border-left-style: none;border-top:#000000 1px solid;border-right:#000000 1px solid;border-bottom:#000000 1px solid;font-family:Times New Roman; font-size:13px; font-weight:bold; font-style:normal; }
                        .csE6D2AE99 {color:#000000;background-color:#E0E0E0;border-left-style: none;border-top:#000000 1px solid;border-right-style: none;border-bottom:#000000 1px solid;font-family:Times New Roman; font-size:12px; font-weight:bold; font-style:normal; }
                        .csEAC52FCD {color:#000000;background-color:#E0E0E0;border-left-style: none;border-top:#000000 1px solid;border-right-style: none;border-bottom:#000000 1px solid;font-family:Times New Roman; font-size:13px; font-weight:bold; font-style:normal; }
                        .cs56F73198 {color:#000000;background-color:transparent;border-left:#000000 1px solid;border-top:#000000 1px solid;border-right:#000000 1px solid;border-bottom:#000000 1px solid;font-family:Times New Roman; font-size:16px; font-weight:normal; font-style:normal; padding-left:2px;}
                        .cs6E02D7D2 {color:#000000;background-color:transparent;border-left-style: none;border-top:#000000 1px solid;border-right:#000000 1px solid;border-bottom:#000000 1px solid;font-family:Times New Roman; font-size:14px; font-weight:normal; font-style:normal; }
                        .cs6C28398D {color:#000000;background-color:transparent;border-left-style: none;border-top:#000000 1px solid;border-right-style: none;border-bottom:#000000 1px solid;font-family:Times New Roman; font-size:14px; font-weight:normal; font-style:normal; }
                        .cs612ED82F {color:#000000;background-color:transparent;border-left-style: none;border-top-style: none;border-right-style: none;border-bottom-style: none;font-family:Times New Roman; font-size:12px; font-weight:bold; font-style:normal; padding-left:2px;}
                        .csFFC1C457 {color:#000000;background-color:transparent;border-left-style: none;border-top-style: none;border-right-style: none;border-bottom-style: none;font-family:Times New Roman; font-size:12px; font-weight:normal; font-style:normal; padding-left:2px;}
                        .cs101A94F7 {color:#000000;background-color:transparent;border-left-style: none;border-top-style: none;border-right-style: none;border-bottom-style: none;font-family:Times New Roman; font-size:13px; font-weight:normal; font-style:normal; }
                        .csCE72709D {color:#000000;background-color:transparent;border-left-style: none;border-top-style: none;border-right-style: none;border-bottom-style: none;font-family:Times New Roman; font-size:14px; font-weight:bold; font-style:normal; padding-left:2px;}
                        .cs12FE94AA {color:#000000;background-color:transparent;border-left-style: none;border-top-style: none;border-right-style: none;border-bottom-style: none;font-family:Times New Roman; font-size:14px; font-weight:normal; font-style:normal; padding-left:2px;}
                        .csFBB219FE {color:#000000;background-color:transparent;border-left-style: none;border-top-style: none;border-right-style: none;border-bottom-style: none;font-family:Times New Roman; font-size:18px; font-weight:bold; font-style:normal; padding-left:2px;}
                        .cs739196BC {color:#5C5C5C;background-color:transparent;border-left-style: none;border-top-style: none;border-right-style: none;border-bottom-style: none;font-family:Segoe UI; font-size:11px; font-weight:normal; font-style:normal; }
                        .csF7D3565D {height:0px;width:0px;overflow:hidden;font-size:0px;line-height:0px;}
                    </style>
                </head>
                <body leftMargin=10 topMargin=10 rightMargin=10 bottomMargin=10 style="background-color:#FFFFFF">
                <table cellpadding="0" cellspacing="0" border="0" style="border-width:0px;empty-cells:show;width:925px;height:383px;position:relative;">
                    <tr>
                        <td style="width:0px;height:0px;"></td>
                        <td style="height:0px;width:10px;"></td>
                        <td style="height:0px;width:102px;"></td>
                        <td style="height:0px;width:36px;"></td>
                        <td style="height:0px;width:71px;"></td>
                        <td style="height:0px;width:124px;"></td>
                        <td style="height:0px;width:66px;"></td>
                        <td style="height:0px;width:23px;"></td>
                        <td style="height:0px;width:149px;"></td>
                        <td style="height:0px;width:43px;"></td>
                        <td style="height:0px;width:60px;"></td>
                        <td style="height:0px;width:10px;"></td>
                        <td style="height:0px;width:30px;"></td>
                        <td style="height:0px;width:41px;"></td>
                        <td style="height:0px;width:12px;"></td>
                        <td style="height:0px;width:47px;"></td>
                        <td style="height:0px;width:75px;"></td>
                        <td style="height:0px;width:25px;"></td>
                        <td style="height:0px;width:1px;"></td>
                    </tr>
                    <tr style="vertical-align:top;">
                        <td style="width:0px;height:23px;"></td>
                        <td class="cs739196BC" colspan="6" style="width:409px;height:23px;line-height:14px;text-align:center;vertical-align:middle;"><nobr></nobr></td>
                        <td></td>
                        <td></td>
                        <td></td>
                        <td></td>
                        <td></td>
                        <td></td>
                        <td></td>
                        <td></td>
                        <td></td>
                        <td></td>
                        <td></td>
                        <td></td>
                    </tr>
                    <tr style="vertical-align:top;">
                        <td style="width:0px;height:9px;"></td>
                        <td></td>
                        <td></td>
                        <td></td>
                        <td></td>
                        <td></td>
                        <td></td>
                        <td></td>
                        <td></td>
                        <td></td>
                        <td></td>
                        <td></td>
                        <td></td>
                        <td></td>
                        <td></td>
                        <td></td>
                        <td></td>
                        <td></td>
                        <td></td>
                    </tr>
                    <tr style="vertical-align:top;">
                        <td style="width:0px;height:1px;"></td>
                        <td></td>
                        <td class="csFBB219FE" colspan="10" rowspan="2" style="width:682px;height:23px;line-height:21px;text-align:left;vertical-align:middle;"><nobr>'.$nomEse.'</nobr></td>
                        <td></td>
                        <td></td>
                        <td></td>
                        <td></td>
                        <td></td>
                        <td></td>
                        <td></td>
                    </tr>
                    <tr style="vertical-align:top;">
                        <td style="width:0px;height:22px;"></td>
                        <td></td>
                        <td></td>
                        <td class="cs101A94F7" colspan="4" rowspan="7" style="width:175px;height:144px;text-align:left;vertical-align:top;"><div style="overflow:hidden;width:175px;height:144px;">
                            <img alt="" src="'.$pic2.'" style="width:175px;height:144px;" /></div>
                        </td>
                        <td></td>
                        <td></td>
                    </tr>
                    <tr style="vertical-align:top;">
                        <td style="width:0px;height:22px;"></td>
                        <td></td>
                        <td class="csCE72709D" colspan="10" style="width:682px;height:22px;line-height:15px;text-align:left;vertical-align:middle;"><nobr>'.$busnessName.'</nobr></td>
                        <td></td>
                        <td></td>
                        <td></td>
                    </tr>
                    <tr style="vertical-align:top;">
                        <td style="width:0px;height:22px;"></td>
                        <td></td>
                        <td class="csCE72709D" colspan="10" style="width:682px;height:22px;line-height:15px;text-align:left;vertical-align:middle;"><nobr>RCCM'.$rccEse.'.&nbsp;ID-NAT.'.$idNatEse.'</nobr></td>
                        <td></td>
                        <td></td>
                        <td></td>
                    </tr>
                    <tr style="vertical-align:top;">
                        <td style="width:0px;height:22px;"></td>
                        <td></td>
                        <td class="csFFC1C457" colspan="10" style="width:682px;height:22px;line-height:13px;text-align:left;vertical-align:middle;"><nobr>'.$adresseEse.'</nobr></td>
                        <td></td>
                        <td></td>
                        <td></td>
                    </tr>
                    <tr style="vertical-align:top;">
                        <td style="width:0px;height:22px;"></td>
                        <td></td>
                        <td class="csFFC1C457" colspan="10" style="width:682px;height:22px;line-height:13px;text-align:left;vertical-align:middle;"><nobr>Email&nbsp;:&nbsp;'.$emailEse.'</nobr></td>
                        <td></td>
                        <td></td>
                        <td></td>
                    </tr>
                    <tr style="vertical-align:top;">
                        <td style="width:0px;height:22px;"></td>
                        <td></td>
                        <td class="csFFC1C457" colspan="10" style="width:682px;height:22px;line-height:13px;text-align:left;vertical-align:middle;"><nobr>Site&nbsp;web&nbsp;:&nbsp;'.$siteEse.'</nobr></td>
                        <td></td>
                        <td></td>
                        <td></td>
                    </tr>
                    <tr style="vertical-align:top;">
                        <td style="width:0px;height:12px;"></td>
                        <td></td>
                        <td class="cs612ED82F" colspan="10" rowspan="2" style="width:682px;height:23px;line-height:13px;text-align:left;vertical-align:middle;"><nobr>T&#233;l&#233;phone&nbsp;:&nbsp;'.$Tel1Ese.'&nbsp;&nbsp;24h/24</nobr></td>
                        <td></td>
                        <td></td>
                        <td></td>
                    </tr>
                    <tr style="vertical-align:top;">
                        <td style="width:0px;height:11px;"></td>
                        <td></td>
                        <td></td>
                        <td></td>
                        <td></td>
                        <td></td>
                        <td></td>
                        <td></td>
                        <td></td>
                    </tr>
                    <tr style="vertical-align:top;">
                        <td style="width:0px;height:8px;"></td>
                        <td></td>
                        <td></td>
                        <td></td>
                        <td></td>
                        <td></td>
                        <td></td>
                        <td></td>
                        <td></td>
                        <td></td>
                        <td></td>
                        <td></td>
                        <td></td>
                        <td></td>
                        <td></td>
                        <td></td>
                        <td></td>
                        <td></td>
                        <td></td>
                    </tr>
                    <tr style="vertical-align:top;">
                        <td style="width:0px;height:32px;"></td>
                        <td></td>
                        <td></td>
                        <td></td>
                        <td class="csB6F858D0" colspan="11" style="width:625px;height:32px;line-height:28px;text-align:center;vertical-align:middle;"><nobr>RAPPORT&nbsp;JOURNALIER&nbsp;DES&nbsp;VENTES</nobr></td>
                        <td></td>
                        <td></td>
                        <td></td>
                        <td></td>
                    </tr>
                    <tr style="vertical-align:top;">
                        <td style="width:0px;height:19px;"></td>
                        <td></td>
                        <td></td>
                        <td></td>
                        <td></td>
                        <td></td>
                        <td></td>
                        <td></td>
                        <td></td>
                        <td></td>
                        <td></td>
                        <td></td>
                        <td></td>
                        <td></td>
                        <td></td>
                        <td></td>
                        <td></td>
                        <td></td>
                        <td></td>
                    </tr>
                    <tr style="vertical-align:top;">
                        <td style="width:0px;height:23px;"></td>
                        <td></td>
                        <td class="cs56F73198" colspan="4" style="width:329px;height:21px;line-height:18px;text-align:left;vertical-align:top;"><nobr>&nbsp;PERIODE&nbsp;:&nbsp;&nbsp;Du&nbsp;&nbsp;'.$date1.'&nbsp;&nbsp;au&nbsp;'.$date2.'</nobr></td>
                        <td class="cs56F73198" colspan="12" style="width:577px;height:21px;line-height:18px;text-align:left;vertical-align:top;"><nobr>'.$CategorieClient.'</nobr></td>
                        <td></td>
                    </tr>
                    <tr style="vertical-align:top;">
                        <td style="width:0px;height:9px;"></td>
                        <td></td>
                        <td></td>
                        <td></td>
                        <td></td>
                        <td></td>
                        <td></td>
                        <td></td>
                        <td></td>
                        <td></td>
                        <td></td>
                        <td></td>
                        <td></td>
                        <td></td>
                        <td></td>
                        <td></td>
                        <td></td>
                        <td></td>
                        <td></td>
                    </tr>
                    <tr style="vertical-align:top;">
                        <td style="width:0px;height:24px;"></td>
                        <td></td>
                        <td class="cs8AAF79E9" style="width:101px;height:22px;line-height:14px;text-align:center;vertical-align:middle;"><nobr>N&#176;&nbsp;FACTURE</nobr></td>
                        <td class="cs8AAF79E9" colspan="3" style="width:230px;height:22px;line-height:14px;text-align:center;vertical-align:middle;"><nobr>CLIENT</nobr></td>
                        <td class="cs8AAF79E9" colspan="2" style="width:88px;height:22px;line-height:14px;text-align:center;vertical-align:middle;"><nobr>DATE&nbsp;FACT.</nobr></td>
                        <td class="cs8AAF79E9" style="width:148px;height:22px;line-height:14px;text-align:center;vertical-align:middle;"><nobr>ARTICLE</nobr></td>
                        <td class="cs8AAF79E9" style="width:42px;height:22px;line-height:14px;text-align:center;vertical-align:middle;"><nobr>Qt&#233;</nobr></td>
                        <td class="cs8AAF79E9" style="width:59px;height:22px;line-height:14px;text-align:center;vertical-align:middle;"><nobr>PU(USD)</nobr></td>
                        <td class="cs8AAF79E9" colspan="3" style="width:80px;height:22px;line-height:14px;text-align:center;vertical-align:middle;"><nobr>PHT(USD)</nobr></td>
                        <td class="cs8AAF79E9" colspan="2" style="width:58px;height:22px;line-height:14px;text-align:center;vertical-align:middle;"><nobr>%&nbsp;TVA</nobr></td>
                        <td class="csE6D2AE99" colspan="3" style="width:101px;height:22px;line-height:14px;text-align:center;vertical-align:middle;"><nobr>PTTTC($)</nobr></td>
                    </tr>
                    ';

                            $output .= $this->showDetailUsage_Service($date1,$date2,$idService); 

                            $output.='
                    <tr style="vertical-align:top;">
                        <td style="width:0px;height:24px;"></td>
                        <td></td>
                        <td></td>
                        <td></td>
                        <td></td>
                        <td></td>
                        <td></td>
                        <td></td>
                        <td></td>
                        <td class="cs49AA1D99" colspan="2" style="width:101px;height:22px;line-height:15px;text-align:center;vertical-align:middle;"><nobr>TOTAL&nbsp;($)&nbsp;:</nobr></td>
                        <td class="cs9FE9304F" colspan="3" style="width:80px;height:22px;line-height:15px;text-align:center;vertical-align:middle;"><nobr>'.$sommePHT.'</nobr></td>
                        <td class="cs9FE9304F" colspan="2" style="width:58px;height:22px;line-height:15px;text-align:center;vertical-align:middle;"><nobr>'.$sommeTVA.'</nobr></td>
                        <td class="csEAC52FCD" colspan="3" style="width:101px;height:22px;line-height:15px;text-align:center;vertical-align:middle;"><nobr>'.$sommePTTF.'</nobr></td>
                    </tr>
                    <tr style="vertical-align:top;">
                        <td style="width:0px;height:10px;"></td>
                        <td></td>
                        <td></td>
                        <td></td>
                        <td></td>
                        <td></td>
                        <td></td>
                        <td></td>
                        <td></td>
                        <td></td>
                        <td></td>
                        <td></td>
                        <td></td>
                        <td></td>
                        <td></td>
                        <td></td>
                        <td></td>
                        <td></td>
                        <td></td>
                    </tr>
                    <tr style="vertical-align:top;">
                        <td style="width:0px;height:22px;"></td>
                        <td></td>
                        <td class="cs12FE94AA" colspan="3" style="width:207px;height:22px;line-height:16px;text-align:left;vertical-align:top;"><nobr>Fait&nbsp;&#224;&nbsp;Goma&nbsp;le&nbsp;&nbsp;'.date('Y-m-d').'</nobr></td>
                        <td></td>
                        <td></td>
                        <td></td>
                        <td></td>
                        <td></td>
                        <td></td>
                        <td></td>
                        <td></td>
                        <td></td>
                        <td></td>
                        <td></td>
                        <td></td>
                        <td></td>
                        <td></td>
                    </tr>
                </table>
                </body>
                </html>
        
        ';  
       
        return $output; 

}
function showDetailUsage_Service($date1,$date2,$idService)
{
        $data = DB::table('tvente_detail_utilisation')
        ->join('tvente_produit','tvente_produit.id','=','tvente_detail_utilisation.refProduit')
        ->join('tvente_categorie_produit','tvente_categorie_produit.id','=','tvente_produit.refCategorie')        

        ->join('tvente_entete_utilisation','tvente_entete_utilisation.id','=','tvente_detail_utilisation.refEnteteVente')        
        ->join('tvente_module','tvente_module.id','=','tvente_entete_utilisation.module_id')
        ->join('tvente_services','tvente_services.id','=','tvente_entete_utilisation.refService')
        ->join('tagent','tagent.id','=','tvente_entete_utilisation.agent_id')

        ->select('tvente_detail_utilisation.id','refEnteteVente','refProduit','tvente_detail_utilisation.compte_vente',
        'tvente_detail_utilisation.compte_variationstock','tvente_detail_utilisation.compte_perte',
        'tvente_detail_utilisation.compte_produit','tvente_detail_utilisation.compte_destockage','puVente',
        'qteVente','uniteVente','puBase','qteBase','tvente_detail_utilisation.uniteBase','cmupVente',
        'tvente_detail_utilisation.devise','tvente_detail_utilisation.taux','montantreduction',
        'tvente_detail_utilisation.active','tvente_detail_utilisation.author','tvente_detail_utilisation.refUser',
        'tvente_detail_utilisation.created_at','idStockService',

        'tvente_produit.designation','tvente_produit.refCategorie','tvente_produit.refUniteBase',
        'tvente_produit.pu','tvente_produit.qte','tvente_produit.cmup','tvente_produit.taux',
        'tvente_produit.Oldcode','tvente_produit.Newcode','tvente_produit.tvaapplique',
        'tvente_produit.estvendable','montanttva',         
        'matricule_agent','noms_agent','sexe_agent','datenaissance_agent',
        'lieunaissnce_agent','provinceOrigine_agent','etatcivil_agent','refAvenue_agent','nummaison_agent',
        'contact_agent','mail_agent','grade_agent','fonction_agent','specialite_agent',
        'Categorie_agent','niveauEtude_agent','anneeFinEtude_agent','Ecole_agent','conjoint_agent', 
        'nomPere_agent', 'nomMere_agent', 'Nationalite_agent', 'Collectivite_agent', 
        'Territoire_agent', 'EmployeurAnt_agent', 'PersRef_agent','photo','slug','cartes','envie',

        'nom_service', "tvente_module.nom_module",'tvente_entete_utilisation.code','refService',
        'module_id','dateUse','libelle', 
        'type_sortie')
        ->selectRaw('ROUND(((qteVente*puVente) - montantreduction),2) as PTVente')
       ->selectRaw('ROUND(((qteVente*puVente) - montantreduction + montanttva),2) as PTVenteTVA')
       ->selectRaw('ROUND((IFNULL(qteVente*puVente,0)),2) as totalFacture')
       ->selectRaw('ROUND((montanttva),2) as TotalTVA')
        ->selectRaw('CONCAT("S",YEAR(dateUse),"",MONTH(dateUse),"00",refEnteteVente) as codeFacture')
        ->where([
            ['dateUse','>=', $date1],
            ['dateUse','<=', $date2],
            ['tvente_services.id','=', $idService]
        ])
        ->orderBy("tvente_detail_utilisation.created_at", "asc")
        ->get();
        $output='';

        foreach ($data as $row) 
        {
            $output .='
            <tr style="vertical-align:top;">
                <td style="width:0px;height:24px;"></td>
                <td></td>
                <td class="cs6E02D7D2" style="width:101px;height:22px;line-height:15px;text-align:center;vertical-align:middle;">'.$row->codeFacture.'</td>
                <td class="cs6E02D7D2" colspan="3" style="width:230px;height:22px;line-height:15px;text-align:left;vertical-align:middle;">'.$row->nom_service.' : '.$row->noms_agent.'</td>
                <td class="cs6E02D7D2" colspan="2" style="width:88px;height:22px;line-height:15px;text-align:center;vertical-align:middle;">'.$row->dateUse.'</td>
                <td class="cs6E02D7D2" style="width:148px;height:22px;line-height:15px;text-align:left;vertical-align:middle;">'.$row->designation.'</td>
                <td class="cs6E02D7D2" style="width:42px;height:22px;line-height:15px;text-align:center;vertical-align:middle;">'.$row->qteVente.' ('.$row->uniteVente.')</td>
                <td class="cs6E02D7D2" style="width:59px;height:22px;line-height:15px;text-align:center;vertical-align:middle;">'.$row->qteVente.'</td>
                <td class="cs6E02D7D2" colspan="3" style="width:80px;height:22px;line-height:15px;text-align:center;vertical-align:middle;">'.$row->PTVente.'</td>
                <td class="cs6E02D7D2" colspan="2" style="width:58px;height:22px;line-height:15px;text-align:center;vertical-align:middle;">'.$row->montanttva.'</td>
                <td class="cs6C28398D" colspan="3" style="width:101px;height:22px;line-height:15px;text-align:center;vertical-align:middle;">'.$row->PTVenteTVA.'</td>
            </tr>
        '; 
           
   
    }

    return $output;

}


//==================== RAPPORT DETAIL UTILISATION SELON LES SERVICES =======================================

public function fetch_rapport_detail_cuisine_date_service(Request $request)
{
    //refDepartement

    if ($request->get('date1') && $request->get('date2')&& $request->get('idService')) {
        // code...
        $date1 = $request->get('date1');
        $date2 = $request->get('date2');
        $idService = $request->get('idService');

        $html ='<html><head><meta http-equiv="Content-Type" content="text/html; charset=utf-8"/>';
        $html .= $this->printRapportDetailCuisine_Service($date1, $date2,$idService);       
        $html .='<script>window.print()</script>';

        echo($html);          

    } else {
        // code...
    }  
    
}
function printRapportDetailCuisine_Service($date1, $date2,$idService)
{

         //Info Entreprise
         $nomEse='';
         $adresseEse='';
         $Tel1Ese='';
         $Tel2Ese='';
         $siteEse='';
         $emailEse='';
         $idNatEse='';
         $numImpotEse='';
         $rccEse='';
         $siege='';
         $busnessName='';
         $pic='';
         $pic2 = $this->displayImg("fichier", 'logo.png');
         $logo='';
 
         $data1 = DB::table('entreprises')
         ->join('secteurs','secteurs.id','=','entreprises.idsecteur')
         ->join('forme_juridiques','forme_juridiques.id','=','entreprises.idforme')
 
         ->join('pays','pays.id','=','entreprises.idPays')
         ->join('provinces','provinces.id','=','entreprises.idProvince')
         ->join('users','users.id','=','entreprises.ceo')        
         ->select('entreprises.id as id','entreprises.id as idEntreprise',
         'entreprises.ceo','entreprises.nomEntreprise','entreprises.descriptionEntreprise',
         'entreprises.emailEntreprise','entreprises.adresseEntreprise',
         'entreprises.telephoneEntreprise','entreprises.solutionEntreprise','entreprises.idsecteur',
         'entreprises.idforme','entreprises.etat',
         'entreprises.idPays','entreprises.idProvince','entreprises.edition','entreprises.facebook',
         'entreprises.linkedin','entreprises.twitter','entreprises.siteweb','entreprises.rccm',
         'entreprises.invPersonnel','entreprises.invHub','entreprises.invRecherche',
         'entreprises.chiffreAffaire','entreprises.nbremploye','entreprises.slug','entreprises.logo',
             //forme
             'forme_juridiques.nomForme','secteurs.nomSecteur',
             //users
             'users.name','users.email','users.avatar','users.telephone','users.adresse',
             //
             'provinces.nomProvince','pays.nomPays', 'entreprises.created_at')
         ->get();
         $output='';
         foreach ($data1 as $row) 
         {                                
             $nomEse=$row->nomEntreprise;
             $adresseEse=$row->adresseEntreprise;
             $Tel1Ese=$row->telephoneEntreprise;
             $Tel2Ese=$row->telephone;
             $siteEse=$row->siteweb;
             $emailEse=$row->emailEntreprise;
             $idNatEse=$row->rccm;
             $numImpotEse=$row->rccm;
             $busnessName=$row->nomSecteur;
             $rccmEse=$row->rccm;
             $pic = $this->displayImg("fichier", 'logo.png');
             $siege=$row->nomForme;         
         }
 



         $sommePHT=0;
         $sommeTVA=0;
         $sommePTTF=0;
         // 
         $data2 =  DB::table('tvente_detail_cuisine')
         ->join('tvente_produit','tvente_produit.id','=','tvente_detail_cuisine.refProduit')
         ->join('tvente_categorie_produit','tvente_categorie_produit.id','=','tvente_produit.refCategorie')
 
         ->join('tvente_entete_cuisine','tvente_entete_cuisine.id','=','tvente_detail_cuisine.refEnteteVente')        
         ->join('tvente_module','tvente_module.id','=','tvente_entete_cuisine.module_id')
         ->join('tvente_services','tvente_services.id','=','tvente_entete_cuisine.refService')
         ->join('tvente_client','tvente_client.id','=','tvente_entete_cuisine.refClient')
         ->join('tvente_categorie_client','tvente_categorie_client.id','=','tvente_client.refCategieClient')

         ->select(DB::raw('ROUND(SUM(((qteVente * puVente) - montantreduction)),4) as sommePHT, 
         ROUND(SUM(montanttva),4) as sommeTVA,
         ROUND(SUM((((IFNULL((qteVente * puVente),0)) - montantreduction) + (montanttva))),4) as sommePTTF'))
         ->where([
            ['dateVente','>=', $date1],
            ['dateVente','<=', $date2],
            ['tvente_services.id','=', $idService],
        ])    
         ->get(); 
         $output='';
         foreach ($data2 as $row) 
         {                                
            $sommePHT=$row->sommePHT;
            $sommeTVA=$row->sommeTVA;
            $sommePTTF=$row->sommePTTF;                           
         }




         $CategorieClient='';

         $data3 = DB::table('tvente_detail_cuisine')
         ->join('tvente_entete_cuisine','tvente_entete_cuisine.id','=','tvente_detail_cuisine.refEnteteVente')      
         ->join('tvente_module','tvente_module.id','=','tvente_entete_cuisine.module_id')
         ->join('tvente_services','tvente_services.id','=','tvente_entete_cuisine.refService')
        
         ->select('nom_service', "tvente_module.nom_module",'tvente_entete_cuisine.code','refService',
         'module_id','dateVente','libelle')
         ->where([
            ['dateVente','>=', $date1],
            ['dateVente','<=', $date2],
            ['tvente_services.id','=', $idService]
        ])      
        ->get();      
        $output='';
        foreach ($data3 as $row) 
        {
            $CategorieClient=$row->nom_service;              
        }


          

        $output='

                <!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Transitional//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd">
                <!-- saved from url=(0016)http://localhost -->
                <html>
                <head>
                    <title>rpt_DetailFactureAbonne</title>
                    <meta HTTP-EQUIV="Content-Type" CONTENT="text/html; charset=utf-8"/>
                    <style type="text/css">
                        .csB6F858D0 {color:#000000;background-color:#D6E5F4;border-left-style: none;border-top-style: none;border-right-style: none;border-bottom-style: none;font-family:Times New Roman; font-size:24px; font-weight:bold; font-style:normal; padding-left:2px;padding-right:2px;}
                        .cs49AA1D99 {color:#000000;background-color:#E0E0E0;border-left:#000000 1px solid;border-top:#000000 1px solid;border-right:#000000 1px solid;border-bottom:#000000 1px solid;font-family:Times New Roman; font-size:13px; font-weight:bold; font-style:normal; }
                        .cs8AAF79E9 {color:#000000;background-color:#E0E0E0;border-left-style: none;border-top:#000000 1px solid;border-right:#000000 1px solid;border-bottom:#000000 1px solid;font-family:Times New Roman; font-size:12px; font-weight:bold; font-style:normal; }
                        .cs9FE9304F {color:#000000;background-color:#E0E0E0;border-left-style: none;border-top:#000000 1px solid;border-right:#000000 1px solid;border-bottom:#000000 1px solid;font-family:Times New Roman; font-size:13px; font-weight:bold; font-style:normal; }
                        .csE6D2AE99 {color:#000000;background-color:#E0E0E0;border-left-style: none;border-top:#000000 1px solid;border-right-style: none;border-bottom:#000000 1px solid;font-family:Times New Roman; font-size:12px; font-weight:bold; font-style:normal; }
                        .csEAC52FCD {color:#000000;background-color:#E0E0E0;border-left-style: none;border-top:#000000 1px solid;border-right-style: none;border-bottom:#000000 1px solid;font-family:Times New Roman; font-size:13px; font-weight:bold; font-style:normal; }
                        .cs56F73198 {color:#000000;background-color:transparent;border-left:#000000 1px solid;border-top:#000000 1px solid;border-right:#000000 1px solid;border-bottom:#000000 1px solid;font-family:Times New Roman; font-size:16px; font-weight:normal; font-style:normal; padding-left:2px;}
                        .cs6E02D7D2 {color:#000000;background-color:transparent;border-left-style: none;border-top:#000000 1px solid;border-right:#000000 1px solid;border-bottom:#000000 1px solid;font-family:Times New Roman; font-size:14px; font-weight:normal; font-style:normal; }
                        .cs6C28398D {color:#000000;background-color:transparent;border-left-style: none;border-top:#000000 1px solid;border-right-style: none;border-bottom:#000000 1px solid;font-family:Times New Roman; font-size:14px; font-weight:normal; font-style:normal; }
                        .cs612ED82F {color:#000000;background-color:transparent;border-left-style: none;border-top-style: none;border-right-style: none;border-bottom-style: none;font-family:Times New Roman; font-size:12px; font-weight:bold; font-style:normal; padding-left:2px;}
                        .csFFC1C457 {color:#000000;background-color:transparent;border-left-style: none;border-top-style: none;border-right-style: none;border-bottom-style: none;font-family:Times New Roman; font-size:12px; font-weight:normal; font-style:normal; padding-left:2px;}
                        .cs101A94F7 {color:#000000;background-color:transparent;border-left-style: none;border-top-style: none;border-right-style: none;border-bottom-style: none;font-family:Times New Roman; font-size:13px; font-weight:normal; font-style:normal; }
                        .csCE72709D {color:#000000;background-color:transparent;border-left-style: none;border-top-style: none;border-right-style: none;border-bottom-style: none;font-family:Times New Roman; font-size:14px; font-weight:bold; font-style:normal; padding-left:2px;}
                        .cs12FE94AA {color:#000000;background-color:transparent;border-left-style: none;border-top-style: none;border-right-style: none;border-bottom-style: none;font-family:Times New Roman; font-size:14px; font-weight:normal; font-style:normal; padding-left:2px;}
                        .csFBB219FE {color:#000000;background-color:transparent;border-left-style: none;border-top-style: none;border-right-style: none;border-bottom-style: none;font-family:Times New Roman; font-size:18px; font-weight:bold; font-style:normal; padding-left:2px;}
                        .cs739196BC {color:#5C5C5C;background-color:transparent;border-left-style: none;border-top-style: none;border-right-style: none;border-bottom-style: none;font-family:Segoe UI; font-size:11px; font-weight:normal; font-style:normal; }
                        .csF7D3565D {height:0px;width:0px;overflow:hidden;font-size:0px;line-height:0px;}
                    </style>
                </head>
                <body leftMargin=10 topMargin=10 rightMargin=10 bottomMargin=10 style="background-color:#FFFFFF">
                <table cellpadding="0" cellspacing="0" border="0" style="border-width:0px;empty-cells:show;width:925px;height:383px;position:relative;">
                    <tr>
                        <td style="width:0px;height:0px;"></td>
                        <td style="height:0px;width:10px;"></td>
                        <td style="height:0px;width:102px;"></td>
                        <td style="height:0px;width:36px;"></td>
                        <td style="height:0px;width:71px;"></td>
                        <td style="height:0px;width:124px;"></td>
                        <td style="height:0px;width:66px;"></td>
                        <td style="height:0px;width:23px;"></td>
                        <td style="height:0px;width:149px;"></td>
                        <td style="height:0px;width:43px;"></td>
                        <td style="height:0px;width:60px;"></td>
                        <td style="height:0px;width:10px;"></td>
                        <td style="height:0px;width:30px;"></td>
                        <td style="height:0px;width:41px;"></td>
                        <td style="height:0px;width:12px;"></td>
                        <td style="height:0px;width:47px;"></td>
                        <td style="height:0px;width:75px;"></td>
                        <td style="height:0px;width:25px;"></td>
                        <td style="height:0px;width:1px;"></td>
                    </tr>
                    <tr style="vertical-align:top;">
                        <td style="width:0px;height:23px;"></td>
                        <td class="cs739196BC" colspan="6" style="width:409px;height:23px;line-height:14px;text-align:center;vertical-align:middle;"><nobr></nobr></td>
                        <td></td>
                        <td></td>
                        <td></td>
                        <td></td>
                        <td></td>
                        <td></td>
                        <td></td>
                        <td></td>
                        <td></td>
                        <td></td>
                        <td></td>
                        <td></td>
                    </tr>
                    <tr style="vertical-align:top;">
                        <td style="width:0px;height:9px;"></td>
                        <td></td>
                        <td></td>
                        <td></td>
                        <td></td>
                        <td></td>
                        <td></td>
                        <td></td>
                        <td></td>
                        <td></td>
                        <td></td>
                        <td></td>
                        <td></td>
                        <td></td>
                        <td></td>
                        <td></td>
                        <td></td>
                        <td></td>
                        <td></td>
                    </tr>
                    <tr style="vertical-align:top;">
                        <td style="width:0px;height:1px;"></td>
                        <td></td>
                        <td class="csFBB219FE" colspan="10" rowspan="2" style="width:682px;height:23px;line-height:21px;text-align:left;vertical-align:middle;"><nobr>'.$nomEse.'</nobr></td>
                        <td></td>
                        <td></td>
                        <td></td>
                        <td></td>
                        <td></td>
                        <td></td>
                        <td></td>
                    </tr>
                    <tr style="vertical-align:top;">
                        <td style="width:0px;height:22px;"></td>
                        <td></td>
                        <td></td>
                        <td class="cs101A94F7" colspan="4" rowspan="7" style="width:175px;height:144px;text-align:left;vertical-align:top;"><div style="overflow:hidden;width:175px;height:144px;">
                            <img alt="" src="'.$pic2.'" style="width:175px;height:144px;" /></div>
                        </td>
                        <td></td>
                        <td></td>
                    </tr>
                    <tr style="vertical-align:top;">
                        <td style="width:0px;height:22px;"></td>
                        <td></td>
                        <td class="csCE72709D" colspan="10" style="width:682px;height:22px;line-height:15px;text-align:left;vertical-align:middle;"><nobr>'.$busnessName.'</nobr></td>
                        <td></td>
                        <td></td>
                        <td></td>
                    </tr>
                    <tr style="vertical-align:top;">
                        <td style="width:0px;height:22px;"></td>
                        <td></td>
                        <td class="csCE72709D" colspan="10" style="width:682px;height:22px;line-height:15px;text-align:left;vertical-align:middle;"><nobr>RCCM'.$rccEse.'.&nbsp;ID-NAT.'.$idNatEse.'</nobr></td>
                        <td></td>
                        <td></td>
                        <td></td>
                    </tr>
                    <tr style="vertical-align:top;">
                        <td style="width:0px;height:22px;"></td>
                        <td></td>
                        <td class="csFFC1C457" colspan="10" style="width:682px;height:22px;line-height:13px;text-align:left;vertical-align:middle;"><nobr>'.$adresseEse.'</nobr></td>
                        <td></td>
                        <td></td>
                        <td></td>
                    </tr>
                    <tr style="vertical-align:top;">
                        <td style="width:0px;height:22px;"></td>
                        <td></td>
                        <td class="csFFC1C457" colspan="10" style="width:682px;height:22px;line-height:13px;text-align:left;vertical-align:middle;"><nobr>Email&nbsp;:&nbsp;'.$emailEse.'</nobr></td>
                        <td></td>
                        <td></td>
                        <td></td>
                    </tr>
                    <tr style="vertical-align:top;">
                        <td style="width:0px;height:22px;"></td>
                        <td></td>
                        <td class="csFFC1C457" colspan="10" style="width:682px;height:22px;line-height:13px;text-align:left;vertical-align:middle;"><nobr>Site&nbsp;web&nbsp;:&nbsp;'.$siteEse.'</nobr></td>
                        <td></td>
                        <td></td>
                        <td></td>
                    </tr>
                    <tr style="vertical-align:top;">
                        <td style="width:0px;height:12px;"></td>
                        <td></td>
                        <td class="cs612ED82F" colspan="10" rowspan="2" style="width:682px;height:23px;line-height:13px;text-align:left;vertical-align:middle;"><nobr>T&#233;l&#233;phone&nbsp;:&nbsp;'.$Tel1Ese.'&nbsp;&nbsp;24h/24</nobr></td>
                        <td></td>
                        <td></td>
                        <td></td>
                    </tr>
                    <tr style="vertical-align:top;">
                        <td style="width:0px;height:11px;"></td>
                        <td></td>
                        <td></td>
                        <td></td>
                        <td></td>
                        <td></td>
                        <td></td>
                        <td></td>
                        <td></td>
                    </tr>
                    <tr style="vertical-align:top;">
                        <td style="width:0px;height:8px;"></td>
                        <td></td>
                        <td></td>
                        <td></td>
                        <td></td>
                        <td></td>
                        <td></td>
                        <td></td>
                        <td></td>
                        <td></td>
                        <td></td>
                        <td></td>
                        <td></td>
                        <td></td>
                        <td></td>
                        <td></td>
                        <td></td>
                        <td></td>
                        <td></td>
                    </tr>
                    <tr style="vertical-align:top;">
                        <td style="width:0px;height:32px;"></td>
                        <td></td>
                        <td></td>
                        <td></td>
                        <td class="csB6F858D0" colspan="11" style="width:625px;height:32px;line-height:28px;text-align:center;vertical-align:middle;"><nobr>RAPPORT&nbsp;JOURNALIER&nbsp;DES&nbsp;VENTES</nobr></td>
                        <td></td>
                        <td></td>
                        <td></td>
                        <td></td>
                    </tr>
                    <tr style="vertical-align:top;">
                        <td style="width:0px;height:19px;"></td>
                        <td></td>
                        <td></td>
                        <td></td>
                        <td></td>
                        <td></td>
                        <td></td>
                        <td></td>
                        <td></td>
                        <td></td>
                        <td></td>
                        <td></td>
                        <td></td>
                        <td></td>
                        <td></td>
                        <td></td>
                        <td></td>
                        <td></td>
                        <td></td>
                    </tr>
                    <tr style="vertical-align:top;">
                        <td style="width:0px;height:23px;"></td>
                        <td></td>
                        <td class="cs56F73198" colspan="4" style="width:329px;height:21px;line-height:18px;text-align:left;vertical-align:top;"><nobr>&nbsp;PERIODE&nbsp;:&nbsp;&nbsp;Du&nbsp;&nbsp;'.$date1.'&nbsp;&nbsp;au&nbsp;'.$date2.'</nobr></td>
                        <td class="cs56F73198" colspan="12" style="width:577px;height:21px;line-height:18px;text-align:left;vertical-align:top;"><nobr>'.$CategorieClient.'</nobr></td>
                        <td></td>
                    </tr>
                    <tr style="vertical-align:top;">
                        <td style="width:0px;height:9px;"></td>
                        <td></td>
                        <td></td>
                        <td></td>
                        <td></td>
                        <td></td>
                        <td></td>
                        <td></td>
                        <td></td>
                        <td></td>
                        <td></td>
                        <td></td>
                        <td></td>
                        <td></td>
                        <td></td>
                        <td></td>
                        <td></td>
                        <td></td>
                        <td></td>
                    </tr>
                    <tr style="vertical-align:top;">
                        <td style="width:0px;height:24px;"></td>
                        <td></td>
                        <td class="cs8AAF79E9" style="width:101px;height:22px;line-height:14px;text-align:center;vertical-align:middle;"><nobr>N&#176;&nbsp;FACTURE</nobr></td>
                        <td class="cs8AAF79E9" colspan="3" style="width:230px;height:22px;line-height:14px;text-align:center;vertical-align:middle;"><nobr>CLIENT</nobr></td>
                        <td class="cs8AAF79E9" colspan="2" style="width:88px;height:22px;line-height:14px;text-align:center;vertical-align:middle;"><nobr>DATE&nbsp;FACT.</nobr></td>
                        <td class="cs8AAF79E9" style="width:148px;height:22px;line-height:14px;text-align:center;vertical-align:middle;"><nobr>ARTICLE</nobr></td>
                        <td class="cs8AAF79E9" style="width:42px;height:22px;line-height:14px;text-align:center;vertical-align:middle;"><nobr>Qt&#233;</nobr></td>
                        <td class="cs8AAF79E9" style="width:59px;height:22px;line-height:14px;text-align:center;vertical-align:middle;"><nobr>PU(USD)</nobr></td>
                        <td class="cs8AAF79E9" colspan="3" style="width:80px;height:22px;line-height:14px;text-align:center;vertical-align:middle;"><nobr>PHT(USD)</nobr></td>
                        <td class="cs8AAF79E9" colspan="2" style="width:58px;height:22px;line-height:14px;text-align:center;vertical-align:middle;"><nobr>%&nbsp;TVA</nobr></td>
                        <td class="csE6D2AE99" colspan="3" style="width:101px;height:22px;line-height:14px;text-align:center;vertical-align:middle;"><nobr>PTTTC($)</nobr></td>
                    </tr>
                    ';

                            $output .= $this->showDetailCuisine_Service($date1,$date2,$idService); 

                            $output.='
                    <tr style="vertical-align:top;">
                        <td style="width:0px;height:24px;"></td>
                        <td></td>
                        <td></td>
                        <td></td>
                        <td></td>
                        <td></td>
                        <td></td>
                        <td></td>
                        <td></td>
                        <td class="cs49AA1D99" colspan="2" style="width:101px;height:22px;line-height:15px;text-align:center;vertical-align:middle;"><nobr>TOTAL&nbsp;($)&nbsp;:</nobr></td>
                        <td class="cs9FE9304F" colspan="3" style="width:80px;height:22px;line-height:15px;text-align:center;vertical-align:middle;"><nobr>'.$sommePHT.'</nobr></td>
                        <td class="cs9FE9304F" colspan="2" style="width:58px;height:22px;line-height:15px;text-align:center;vertical-align:middle;"><nobr>'.$sommeTVA.'</nobr></td>
                        <td class="csEAC52FCD" colspan="3" style="width:101px;height:22px;line-height:15px;text-align:center;vertical-align:middle;"><nobr>'.$sommePTTF.'</nobr></td>
                    </tr>
                    <tr style="vertical-align:top;">
                        <td style="width:0px;height:10px;"></td>
                        <td></td>
                        <td></td>
                        <td></td>
                        <td></td>
                        <td></td>
                        <td></td>
                        <td></td>
                        <td></td>
                        <td></td>
                        <td></td>
                        <td></td>
                        <td></td>
                        <td></td>
                        <td></td>
                        <td></td>
                        <td></td>
                        <td></td>
                        <td></td>
                    </tr>
                    <tr style="vertical-align:top;">
                        <td style="width:0px;height:22px;"></td>
                        <td></td>
                        <td class="cs12FE94AA" colspan="3" style="width:207px;height:22px;line-height:16px;text-align:left;vertical-align:top;"><nobr>Fait&nbsp;&#224;&nbsp;Goma&nbsp;le&nbsp;&nbsp;'.date('Y-m-d').'</nobr></td>
                        <td></td>
                        <td></td>
                        <td></td>
                        <td></td>
                        <td></td>
                        <td></td>
                        <td></td>
                        <td></td>
                        <td></td>
                        <td></td>
                        <td></td>
                        <td></td>
                        <td></td>
                        <td></td>
                    </tr>
                </table>
                </body>
                </html>
        
        ';  
       
        return $output; 

}
function showDetailCuisine_Service($date1,$date2,$idService)
{
        $data = DB::table('tvente_detail_cuisine')
        ->join('tvente_produit','tvente_produit.id','=','tvente_detail_cuisine.refProduit')
        ->join('tvente_categorie_produit','tvente_categorie_produit.id','=','tvente_produit.refCategorie')

        ->join('tvente_entete_cuisine','tvente_entete_cuisine.id','=','tvente_detail_cuisine.refEnteteVente')        
        ->join('tvente_module','tvente_module.id','=','tvente_entete_cuisine.module_id')
        ->join('tvente_services','tvente_services.id','=','tvente_entete_cuisine.refService')
        ->join('tvente_client','tvente_client.id','=','tvente_entete_cuisine.refClient')
        ->join('tvente_categorie_client','tvente_categorie_client.id','=','tvente_client.refCategieClient')

        ->select('tvente_detail_cuisine.id','refEnteteVente','refProduit','tvente_detail_cuisine.compte_vente',
        'tvente_detail_cuisine.compte_variationstock','tvente_detail_cuisine.compte_perte','tvente_detail_cuisine.compte_produit',
        'tvente_detail_cuisine.compte_destockage','puVente','qteVente','uniteVente','puBase','qteBase',
        'tvente_detail_cuisine.uniteBase','cmupVente','tvente_detail_cuisine.devise',
        'tvente_detail_cuisine.taux','montantreduction',
        'tvente_detail_cuisine.active','tvente_detail_cuisine.author','tvente_detail_cuisine.refUser',
        'tvente_detail_cuisine.created_at','idStockService',

        'tvente_produit.designation','tvente_produit.refCategorie','tvente_produit.refUniteBase',
        'tvente_produit.pu','tvente_produit.qte','tvente_produit.cmup','tvente_produit.taux',
        'tvente_produit.Oldcode','tvente_produit.Newcode','tvente_produit.tvaapplique',
        'tvente_produit.estvendable',
        
        'noms','sexe','contact','mail','adresse','pieceidentite','numeroPiece','dateLivrePiece',
        'lieulivraisonCarte','nationnalite','datenaissance','lieunaissance','profession','occupation',
        'nombreEnfant','dateArriverGoma','arriverPar','refCategieClient','photo','slug',
        "tvente_categorie_client.designation as CategorieClient","compte_client",

        'nom_service', "tvente_module.nom_module",'tvente_entete_cuisine.code','refClient','refService','refReservation',
        'module_id','dateVente','libelle','priseencharge')
        ->selectRaw('ROUND(((qteVente*puVente) - montantreduction),2) as PTVente')
       ->selectRaw('ROUND(((qteVente*puVente) - montantreduction + montanttva),2) as PTVenteTVA')
       ->selectRaw('ROUND((IFNULL(qteVente*puVente,0)),2) as totalFacture')
       ->selectRaw('ROUND((montanttva),2) as montanttva')
        ->selectRaw('CONCAT("S",YEAR(dateVente),"",MONTH(dateVente),"00",refEnteteVente) as codeFacture')
        ->where([
            ['dateVente','>=', $date1],
            ['dateVente','<=', $date2],
            ['tvente_services.id','=', $idService]
        ])
        ->orderBy("tvente_detail_cuisine.created_at", "asc")
        ->get();
        $output='';

        foreach ($data as $row) 
        {
            $output .='
            <tr style="vertical-align:top;">
                <td style="width:0px;height:24px;"></td>
                <td></td>
                <td class="cs6E02D7D2" style="width:101px;height:22px;line-height:15px;text-align:center;vertical-align:middle;">'.$row->codeFacture.'</td>
                <td class="cs6E02D7D2" colspan="3" style="width:230px;height:22px;line-height:15px;text-align:left;vertical-align:middle;">'.$row->nom_service.' : '.$row->noms.'</td>
                <td class="cs6E02D7D2" colspan="2" style="width:88px;height:22px;line-height:15px;text-align:center;vertical-align:middle;">'.$row->dateVente.'</td>
                <td class="cs6E02D7D2" style="width:148px;height:22px;line-height:15px;text-align:left;vertical-align:middle;">'.$row->designation.'</td>
                <td class="cs6E02D7D2" style="width:42px;height:22px;line-height:15px;text-align:center;vertical-align:middle;">'.$row->qteVente.' ('.$row->uniteVente.')</td>
                <td class="cs6E02D7D2" style="width:59px;height:22px;line-height:15px;text-align:center;vertical-align:middle;">'.$row->qteVente.'</td>
                <td class="cs6E02D7D2" colspan="3" style="width:80px;height:22px;line-height:15px;text-align:center;vertical-align:middle;">'.$row->PTVente.'</td>
                <td class="cs6E02D7D2" colspan="2" style="width:58px;height:22px;line-height:15px;text-align:center;vertical-align:middle;">'.$row->montanttva.'</td>
                <td class="cs6C28398D" colspan="3" style="width:101px;height:22px;line-height:15px;text-align:center;vertical-align:middle;">'.$row->PTVenteTVA.'</td>
            </tr>
        '; 
           
   
    }

    return $output;

}


//==================== RAPPORT DETAIL UTILISATION SELON LES SERVICES BY TYPE USAGE =======================================
public function fetch_rapport_detailusage_date_service_type(Request $request)
{
    //type_sortie

    if ($request->get('date1') && $request->get('date2') && $request->get('idService') && $request->get('type_sortie')) {
        // code...
        $date1 = $request->get('date1');
        $date2 = $request->get('date2');
        $idService = $request->get('idService');
        $type_sortie = $request->get('type_sortie');

        $html ='<html><head><meta http-equiv="Content-Type" content="text/html; charset=utf-8"/>';
        $html .= $this->printRapportDetailUsage_Service_Type($date1, $date2,$idService,$type_sortie);       
        $html .='<script>window.print()</script>';

        echo($html);          

    } else {
        // code...
    }  
    
}
function printRapportDetailUsage_Service_Type($date1, $date2,$idService,$type_sortie)
{

         //Info Entreprise
         $nomEse='';
         $adresseEse='';
         $Tel1Ese='';
         $Tel2Ese='';
         $siteEse='';
         $emailEse='';
         $idNatEse='';
         $numImpotEse='';
         $rccEse='';
         $siege='';
         $busnessName='';
         $pic='';
         $pic2 = $this->displayImg("fichier", 'logo.png');
         $logo='';
 
         $data1 = DB::table('entreprises')
         ->join('secteurs','secteurs.id','=','entreprises.idsecteur')
         ->join('forme_juridiques','forme_juridiques.id','=','entreprises.idforme')
 
         ->join('pays','pays.id','=','entreprises.idPays')
         ->join('provinces','provinces.id','=','entreprises.idProvince')
         ->join('users','users.id','=','entreprises.ceo')        
         ->select('entreprises.id as id','entreprises.id as idEntreprise',
         'entreprises.ceo','entreprises.nomEntreprise','entreprises.descriptionEntreprise',
         'entreprises.emailEntreprise','entreprises.adresseEntreprise',
         'entreprises.telephoneEntreprise','entreprises.solutionEntreprise','entreprises.idsecteur',
         'entreprises.idforme','entreprises.etat',
         'entreprises.idPays','entreprises.idProvince','entreprises.edition','entreprises.facebook',
         'entreprises.linkedin','entreprises.twitter','entreprises.siteweb','entreprises.rccm',
         'entreprises.invPersonnel','entreprises.invHub','entreprises.invRecherche',
         'entreprises.chiffreAffaire','entreprises.nbremploye','entreprises.slug','entreprises.logo',
             //forme
             'forme_juridiques.nomForme','secteurs.nomSecteur',
             //users
             'users.name','users.email','users.avatar','users.telephone','users.adresse',
             //
             'provinces.nomProvince','pays.nomPays', 'entreprises.created_at')
         ->get();
         $output='';
         foreach ($data1 as $row) 
         {                                
             $nomEse=$row->nomEntreprise;
             $adresseEse=$row->adresseEntreprise;
             $Tel1Ese=$row->telephoneEntreprise;
             $Tel2Ese=$row->telephone;
             $siteEse=$row->siteweb;
             $emailEse=$row->emailEntreprise;
             $idNatEse=$row->rccm;
             $numImpotEse=$row->rccm;
             $busnessName=$row->nomSecteur;
             $rccmEse=$row->rccm;
             $pic = $this->displayImg("fichier", 'logo.png');
             $siege=$row->nomForme;         
         }
 



         $sommePHT=0;
         $sommeTVA=0;
         $sommePTTF=0;
         // 
         $data2 =  DB::table('tvente_detail_utilisation')
         ->join('tvente_produit','tvente_produit.id','=','tvente_detail_utilisation.refProduit')
         ->join('tvente_categorie_produit','tvente_categorie_produit.id','=','tvente_produit.refCategorie')     
 
         ->join('tvente_entete_utilisation','tvente_entete_utilisation.id','=','tvente_detail_utilisation.refEnteteVente')        
         ->join('tvente_module','tvente_module.id','=','tvente_entete_utilisation.module_id')
         ->join('tvente_services','tvente_services.id','=','tvente_entete_utilisation.refService')
         ->join('tagent','tagent.id','=','tvente_entete_utilisation.agent_id')

         ->select(DB::raw('ROUND(SUM(((qteVente*puVente) - montantreduction)),4) as sommePHT, 
         ROUND(SUM(montanttva),4) as sommeTVA,
         ROUND(SUM(ROUND(((qteVente*puVente) - montantreduction + montanttva),4)),4) as sommePTTF'))
         ->where([
            ['dateUse','>=', $date1],
            ['dateUse','<=', $date2],
            ['tvente_services.id','=', $idService],
            ['type_sortie','=', $type_sortie],
        ])    
         ->get(); 
         $output='';
         foreach ($data2 as $row) 
         {                                
            $sommePHT=$row->sommePHT;
            $sommeTVA=$row->sommeTVA;
            $sommePTTF=$row->sommePTTF;                           
         }




         $CategorieClient='';

         $data3=DB::table('tvente_detail_utilisation')
         ->join('tvente_entete_utilisation','tvente_entete_utilisation.id','=','tvente_detail_utilisation.refEnteteVente')        
         ->join('tvente_module','tvente_module.id','=','tvente_entete_utilisation.module_id')
         ->join('tvente_services','tvente_services.id','=','tvente_entete_utilisation.refService')
        
         ->select('nom_service', "tvente_module.nom_module",'tvente_entete_utilisation.code','refService',
         'module_id','dateUse','libelle','type_sortie')
         ->where([
            ['dateUse','>=', $date1],
            ['dateUse','<=', $date2],
            ['tvente_services.id','=', $idService],
            ['type_sortie','=', $type_sortie],
        ])      
        ->get();      
        $output='';
        foreach ($data3 as $row) 
        {
            $CategorieClient=$row->nom_service .' - '. $row->type_sortie;              
        }


          

        $output='

                <!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Transitional//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd">
                <!-- saved from url=(0016)http://localhost -->
                <html>
                <head>
                    <title>rpt_DetailFactureAbonne</title>
                    <meta HTTP-EQUIV="Content-Type" CONTENT="text/html; charset=utf-8"/>
                    <style type="text/css">
                        .csB6F858D0 {color:#000000;background-color:#D6E5F4;border-left-style: none;border-top-style: none;border-right-style: none;border-bottom-style: none;font-family:Times New Roman; font-size:24px; font-weight:bold; font-style:normal; padding-left:2px;padding-right:2px;}
                        .cs49AA1D99 {color:#000000;background-color:#E0E0E0;border-left:#000000 1px solid;border-top:#000000 1px solid;border-right:#000000 1px solid;border-bottom:#000000 1px solid;font-family:Times New Roman; font-size:13px; font-weight:bold; font-style:normal; }
                        .cs8AAF79E9 {color:#000000;background-color:#E0E0E0;border-left-style: none;border-top:#000000 1px solid;border-right:#000000 1px solid;border-bottom:#000000 1px solid;font-family:Times New Roman; font-size:12px; font-weight:bold; font-style:normal; }
                        .cs9FE9304F {color:#000000;background-color:#E0E0E0;border-left-style: none;border-top:#000000 1px solid;border-right:#000000 1px solid;border-bottom:#000000 1px solid;font-family:Times New Roman; font-size:13px; font-weight:bold; font-style:normal; }
                        .csE6D2AE99 {color:#000000;background-color:#E0E0E0;border-left-style: none;border-top:#000000 1px solid;border-right-style: none;border-bottom:#000000 1px solid;font-family:Times New Roman; font-size:12px; font-weight:bold; font-style:normal; }
                        .csEAC52FCD {color:#000000;background-color:#E0E0E0;border-left-style: none;border-top:#000000 1px solid;border-right-style: none;border-bottom:#000000 1px solid;font-family:Times New Roman; font-size:13px; font-weight:bold; font-style:normal; }
                        .cs56F73198 {color:#000000;background-color:transparent;border-left:#000000 1px solid;border-top:#000000 1px solid;border-right:#000000 1px solid;border-bottom:#000000 1px solid;font-family:Times New Roman; font-size:16px; font-weight:normal; font-style:normal; padding-left:2px;}
                        .cs6E02D7D2 {color:#000000;background-color:transparent;border-left-style: none;border-top:#000000 1px solid;border-right:#000000 1px solid;border-bottom:#000000 1px solid;font-family:Times New Roman; font-size:14px; font-weight:normal; font-style:normal; }
                        .cs6C28398D {color:#000000;background-color:transparent;border-left-style: none;border-top:#000000 1px solid;border-right-style: none;border-bottom:#000000 1px solid;font-family:Times New Roman; font-size:14px; font-weight:normal; font-style:normal; }
                        .cs612ED82F {color:#000000;background-color:transparent;border-left-style: none;border-top-style: none;border-right-style: none;border-bottom-style: none;font-family:Times New Roman; font-size:12px; font-weight:bold; font-style:normal; padding-left:2px;}
                        .csFFC1C457 {color:#000000;background-color:transparent;border-left-style: none;border-top-style: none;border-right-style: none;border-bottom-style: none;font-family:Times New Roman; font-size:12px; font-weight:normal; font-style:normal; padding-left:2px;}
                        .cs101A94F7 {color:#000000;background-color:transparent;border-left-style: none;border-top-style: none;border-right-style: none;border-bottom-style: none;font-family:Times New Roman; font-size:13px; font-weight:normal; font-style:normal; }
                        .csCE72709D {color:#000000;background-color:transparent;border-left-style: none;border-top-style: none;border-right-style: none;border-bottom-style: none;font-family:Times New Roman; font-size:14px; font-weight:bold; font-style:normal; padding-left:2px;}
                        .cs12FE94AA {color:#000000;background-color:transparent;border-left-style: none;border-top-style: none;border-right-style: none;border-bottom-style: none;font-family:Times New Roman; font-size:14px; font-weight:normal; font-style:normal; padding-left:2px;}
                        .csFBB219FE {color:#000000;background-color:transparent;border-left-style: none;border-top-style: none;border-right-style: none;border-bottom-style: none;font-family:Times New Roman; font-size:18px; font-weight:bold; font-style:normal; padding-left:2px;}
                        .cs739196BC {color:#5C5C5C;background-color:transparent;border-left-style: none;border-top-style: none;border-right-style: none;border-bottom-style: none;font-family:Segoe UI; font-size:11px; font-weight:normal; font-style:normal; }
                        .csF7D3565D {height:0px;width:0px;overflow:hidden;font-size:0px;line-height:0px;}
                    </style>
                </head>
                <body leftMargin=10 topMargin=10 rightMargin=10 bottomMargin=10 style="background-color:#FFFFFF">
                <table cellpadding="0" cellspacing="0" border="0" style="border-width:0px;empty-cells:show;width:925px;height:383px;position:relative;">
                    <tr>
                        <td style="width:0px;height:0px;"></td>
                        <td style="height:0px;width:10px;"></td>
                        <td style="height:0px;width:102px;"></td>
                        <td style="height:0px;width:36px;"></td>
                        <td style="height:0px;width:71px;"></td>
                        <td style="height:0px;width:124px;"></td>
                        <td style="height:0px;width:66px;"></td>
                        <td style="height:0px;width:23px;"></td>
                        <td style="height:0px;width:149px;"></td>
                        <td style="height:0px;width:43px;"></td>
                        <td style="height:0px;width:60px;"></td>
                        <td style="height:0px;width:10px;"></td>
                        <td style="height:0px;width:30px;"></td>
                        <td style="height:0px;width:41px;"></td>
                        <td style="height:0px;width:12px;"></td>
                        <td style="height:0px;width:47px;"></td>
                        <td style="height:0px;width:75px;"></td>
                        <td style="height:0px;width:25px;"></td>
                        <td style="height:0px;width:1px;"></td>
                    </tr>
                    <tr style="vertical-align:top;">
                        <td style="width:0px;height:23px;"></td>
                        <td class="cs739196BC" colspan="6" style="width:409px;height:23px;line-height:14px;text-align:center;vertical-align:middle;"><nobr></nobr></td>
                        <td></td>
                        <td></td>
                        <td></td>
                        <td></td>
                        <td></td>
                        <td></td>
                        <td></td>
                        <td></td>
                        <td></td>
                        <td></td>
                        <td></td>
                        <td></td>
                    </tr>
                    <tr style="vertical-align:top;">
                        <td style="width:0px;height:9px;"></td>
                        <td></td>
                        <td></td>
                        <td></td>
                        <td></td>
                        <td></td>
                        <td></td>
                        <td></td>
                        <td></td>
                        <td></td>
                        <td></td>
                        <td></td>
                        <td></td>
                        <td></td>
                        <td></td>
                        <td></td>
                        <td></td>
                        <td></td>
                        <td></td>
                    </tr>
                    <tr style="vertical-align:top;">
                        <td style="width:0px;height:1px;"></td>
                        <td></td>
                        <td class="csFBB219FE" colspan="10" rowspan="2" style="width:682px;height:23px;line-height:21px;text-align:left;vertical-align:middle;"><nobr>'.$nomEse.'</nobr></td>
                        <td></td>
                        <td></td>
                        <td></td>
                        <td></td>
                        <td></td>
                        <td></td>
                        <td></td>
                    </tr>
                    <tr style="vertical-align:top;">
                        <td style="width:0px;height:22px;"></td>
                        <td></td>
                        <td></td>
                        <td class="cs101A94F7" colspan="4" rowspan="7" style="width:175px;height:144px;text-align:left;vertical-align:top;"><div style="overflow:hidden;width:175px;height:144px;">
                            <img alt="" src="'.$pic2.'" style="width:175px;height:144px;" /></div>
                        </td>
                        <td></td>
                        <td></td>
                    </tr>
                    <tr style="vertical-align:top;">
                        <td style="width:0px;height:22px;"></td>
                        <td></td>
                        <td class="csCE72709D" colspan="10" style="width:682px;height:22px;line-height:15px;text-align:left;vertical-align:middle;"><nobr>'.$busnessName.'</nobr></td>
                        <td></td>
                        <td></td>
                        <td></td>
                    </tr>
                    <tr style="vertical-align:top;">
                        <td style="width:0px;height:22px;"></td>
                        <td></td>
                        <td class="csCE72709D" colspan="10" style="width:682px;height:22px;line-height:15px;text-align:left;vertical-align:middle;"><nobr>RCCM'.$rccEse.'.&nbsp;ID-NAT.'.$idNatEse.'</nobr></td>
                        <td></td>
                        <td></td>
                        <td></td>
                    </tr>
                    <tr style="vertical-align:top;">
                        <td style="width:0px;height:22px;"></td>
                        <td></td>
                        <td class="csFFC1C457" colspan="10" style="width:682px;height:22px;line-height:13px;text-align:left;vertical-align:middle;"><nobr>'.$adresseEse.'</nobr></td>
                        <td></td>
                        <td></td>
                        <td></td>
                    </tr>
                    <tr style="vertical-align:top;">
                        <td style="width:0px;height:22px;"></td>
                        <td></td>
                        <td class="csFFC1C457" colspan="10" style="width:682px;height:22px;line-height:13px;text-align:left;vertical-align:middle;"><nobr>Email&nbsp;:&nbsp;'.$emailEse.'</nobr></td>
                        <td></td>
                        <td></td>
                        <td></td>
                    </tr>
                    <tr style="vertical-align:top;">
                        <td style="width:0px;height:22px;"></td>
                        <td></td>
                        <td class="csFFC1C457" colspan="10" style="width:682px;height:22px;line-height:13px;text-align:left;vertical-align:middle;"><nobr>Site&nbsp;web&nbsp;:&nbsp;'.$siteEse.'</nobr></td>
                        <td></td>
                        <td></td>
                        <td></td>
                    </tr>
                    <tr style="vertical-align:top;">
                        <td style="width:0px;height:12px;"></td>
                        <td></td>
                        <td class="cs612ED82F" colspan="10" rowspan="2" style="width:682px;height:23px;line-height:13px;text-align:left;vertical-align:middle;"><nobr>T&#233;l&#233;phone&nbsp;:&nbsp;'.$Tel1Ese.'&nbsp;&nbsp;24h/24</nobr></td>
                        <td></td>
                        <td></td>
                        <td></td>
                    </tr>
                    <tr style="vertical-align:top;">
                        <td style="width:0px;height:11px;"></td>
                        <td></td>
                        <td></td>
                        <td></td>
                        <td></td>
                        <td></td>
                        <td></td>
                        <td></td>
                        <td></td>
                    </tr>
                    <tr style="vertical-align:top;">
                        <td style="width:0px;height:8px;"></td>
                        <td></td>
                        <td></td>
                        <td></td>
                        <td></td>
                        <td></td>
                        <td></td>
                        <td></td>
                        <td></td>
                        <td></td>
                        <td></td>
                        <td></td>
                        <td></td>
                        <td></td>
                        <td></td>
                        <td></td>
                        <td></td>
                        <td></td>
                        <td></td>
                    </tr>
                    <tr style="vertical-align:top;">
                        <td style="width:0px;height:32px;"></td>
                        <td></td>
                        <td></td>
                        <td></td>
                        <td class="csB6F858D0" colspan="11" style="width:625px;height:32px;line-height:28px;text-align:center;vertical-align:middle;"><nobr>RAPPORT&nbsp;JOURNALIER&nbsp;DES&nbsp;VENTES</nobr></td>
                        <td></td>
                        <td></td>
                        <td></td>
                        <td></td>
                    </tr>
                    <tr style="vertical-align:top;">
                        <td style="width:0px;height:19px;"></td>
                        <td></td>
                        <td></td>
                        <td></td>
                        <td></td>
                        <td></td>
                        <td></td>
                        <td></td>
                        <td></td>
                        <td></td>
                        <td></td>
                        <td></td>
                        <td></td>
                        <td></td>
                        <td></td>
                        <td></td>
                        <td></td>
                        <td></td>
                        <td></td>
                    </tr>
                    <tr style="vertical-align:top;">
                        <td style="width:0px;height:23px;"></td>
                        <td></td>
                        <td class="cs56F73198" colspan="4" style="width:329px;height:21px;line-height:18px;text-align:left;vertical-align:top;"><nobr>&nbsp;PERIODE&nbsp;:&nbsp;&nbsp;Du&nbsp;&nbsp;'.$date1.'&nbsp;&nbsp;au&nbsp;'.$date2.'</nobr></td>
                        <td class="cs56F73198" colspan="12" style="width:577px;height:21px;line-height:18px;text-align:left;vertical-align:top;"><nobr>'.$CategorieClient.'</nobr></td>
                        <td></td>
                    </tr>
                    <tr style="vertical-align:top;">
                        <td style="width:0px;height:9px;"></td>
                        <td></td>
                        <td></td>
                        <td></td>
                        <td></td>
                        <td></td>
                        <td></td>
                        <td></td>
                        <td></td>
                        <td></td>
                        <td></td>
                        <td></td>
                        <td></td>
                        <td></td>
                        <td></td>
                        <td></td>
                        <td></td>
                        <td></td>
                        <td></td>
                    </tr>
                    <tr style="vertical-align:top;">
                        <td style="width:0px;height:24px;"></td>
                        <td></td>
                        <td class="cs8AAF79E9" style="width:101px;height:22px;line-height:14px;text-align:center;vertical-align:middle;"><nobr>N&#176;&nbsp;FACTURE</nobr></td>
                        <td class="cs8AAF79E9" colspan="3" style="width:230px;height:22px;line-height:14px;text-align:center;vertical-align:middle;"><nobr>CLIENT</nobr></td>
                        <td class="cs8AAF79E9" colspan="2" style="width:88px;height:22px;line-height:14px;text-align:center;vertical-align:middle;"><nobr>DATE&nbsp;FACT.</nobr></td>
                        <td class="cs8AAF79E9" style="width:148px;height:22px;line-height:14px;text-align:center;vertical-align:middle;"><nobr>ARTICLE</nobr></td>
                        <td class="cs8AAF79E9" style="width:42px;height:22px;line-height:14px;text-align:center;vertical-align:middle;"><nobr>Qt&#233;</nobr></td>
                        <td class="cs8AAF79E9" style="width:59px;height:22px;line-height:14px;text-align:center;vertical-align:middle;"><nobr>PU(USD)</nobr></td>
                        <td class="cs8AAF79E9" colspan="3" style="width:80px;height:22px;line-height:14px;text-align:center;vertical-align:middle;"><nobr>PHT(USD)</nobr></td>
                        <td class="cs8AAF79E9" colspan="2" style="width:58px;height:22px;line-height:14px;text-align:center;vertical-align:middle;"><nobr>%&nbsp;TVA</nobr></td>
                        <td class="csE6D2AE99" colspan="3" style="width:101px;height:22px;line-height:14px;text-align:center;vertical-align:middle;"><nobr>PTTTC($)</nobr></td>
                    </tr>
                    ';

                            $output .= $this->showDetailUsage_Service_Type($date1,$date2,$idService,$type_sortie); 

                            $output.='
                    <tr style="vertical-align:top;">
                        <td style="width:0px;height:24px;"></td>
                        <td></td>
                        <td></td>
                        <td></td>
                        <td></td>
                        <td></td>
                        <td></td>
                        <td></td>
                        <td></td>
                        <td class="cs49AA1D99" colspan="2" style="width:101px;height:22px;line-height:15px;text-align:center;vertical-align:middle;"><nobr>TOTAL&nbsp;($)&nbsp;:</nobr></td>
                        <td class="cs9FE9304F" colspan="3" style="width:80px;height:22px;line-height:15px;text-align:center;vertical-align:middle;"><nobr>'.$sommePHT.'</nobr></td>
                        <td class="cs9FE9304F" colspan="2" style="width:58px;height:22px;line-height:15px;text-align:center;vertical-align:middle;"><nobr>'.$sommeTVA.'</nobr></td>
                        <td class="csEAC52FCD" colspan="3" style="width:101px;height:22px;line-height:15px;text-align:center;vertical-align:middle;"><nobr>'.$sommePTTF.'</nobr></td>
                    </tr>
                    <tr style="vertical-align:top;">
                        <td style="width:0px;height:10px;"></td>
                        <td></td>
                        <td></td>
                        <td></td>
                        <td></td>
                        <td></td>
                        <td></td>
                        <td></td>
                        <td></td>
                        <td></td>
                        <td></td>
                        <td></td>
                        <td></td>
                        <td></td>
                        <td></td>
                        <td></td>
                        <td></td>
                        <td></td>
                        <td></td>
                    </tr>
                    <tr style="vertical-align:top;">
                        <td style="width:0px;height:22px;"></td>
                        <td></td>
                        <td class="cs12FE94AA" colspan="3" style="width:207px;height:22px;line-height:16px;text-align:left;vertical-align:top;"><nobr>Fait&nbsp;&#224;&nbsp;Goma&nbsp;le&nbsp;&nbsp;'.date('Y-m-d').'</nobr></td>
                        <td></td>
                        <td></td>
                        <td></td>
                        <td></td>
                        <td></td>
                        <td></td>
                        <td></td>
                        <td></td>
                        <td></td>
                        <td></td>
                        <td></td>
                        <td></td>
                        <td></td>
                        <td></td>
                    </tr>
                </table>
                </body>
                </html>
        
        ';  
       
        return $output; 

}
function showDetailUsage_Service_Type($date1,$date2,$idService,$type_sortie)
{
        $data = DB::table('tvente_detail_utilisation')
        ->join('tvente_produit','tvente_produit.id','=','tvente_detail_utilisation.refProduit')
        ->join('tvente_categorie_produit','tvente_categorie_produit.id','=','tvente_produit.refCategorie')        

        ->join('tvente_entete_utilisation','tvente_entete_utilisation.id','=','tvente_detail_utilisation.refEnteteVente')        
        ->join('tvente_module','tvente_module.id','=','tvente_entete_utilisation.module_id')
        ->join('tvente_services','tvente_services.id','=','tvente_entete_utilisation.refService')
        ->join('tagent','tagent.id','=','tvente_entete_utilisation.agent_id')

        ->select('tvente_detail_utilisation.id','refEnteteVente','refProduit','tvente_detail_utilisation.compte_vente',
        'tvente_detail_utilisation.compte_variationstock','tvente_detail_utilisation.compte_perte',
        'tvente_detail_utilisation.compte_produit','tvente_detail_utilisation.compte_destockage','puVente',
        'qteVente','uniteVente','puBase','qteBase','tvente_detail_utilisation.uniteBase','cmupVente',
        'tvente_detail_utilisation.devise','tvente_detail_utilisation.taux','montantreduction',
        'tvente_detail_utilisation.active','tvente_detail_utilisation.author','tvente_detail_utilisation.refUser',
        'tvente_detail_utilisation.created_at','idStockService',

        'tvente_produit.designation','tvente_produit.refCategorie','tvente_produit.refUniteBase',
        'tvente_produit.pu','tvente_produit.qte','tvente_produit.cmup','tvente_produit.taux',
        'tvente_produit.Oldcode','tvente_produit.Newcode','tvente_produit.tvaapplique',
        'tvente_produit.estvendable','montanttva',         
        'matricule_agent','noms_agent','sexe_agent','datenaissance_agent',
        'lieunaissnce_agent','provinceOrigine_agent','etatcivil_agent','refAvenue_agent','nummaison_agent',
        'contact_agent','mail_agent','grade_agent','fonction_agent','specialite_agent',
        'Categorie_agent','niveauEtude_agent','anneeFinEtude_agent','Ecole_agent','conjoint_agent', 
        'nomPere_agent', 'nomMere_agent', 'Nationalite_agent', 'Collectivite_agent', 
        'Territoire_agent', 'EmployeurAnt_agent', 'PersRef_agent','photo','slug','cartes','envie',

        'nom_service', "tvente_module.nom_module",'tvente_entete_utilisation.code','refService',
        'module_id','dateUse','libelle', 
        'type_sortie')
        ->selectRaw('ROUND(((qteVente*puVente) - montantreduction),2) as PTVente')
       ->selectRaw('ROUND(((qteVente*puVente) - montantreduction + montanttva),2) as PTVenteTVA')
       ->selectRaw('ROUND((IFNULL(qteVente*puVente,0)),2) as totalFacture')
       ->selectRaw('ROUND((montanttva),2) as TotalTVA')
        ->selectRaw('CONCAT("S",YEAR(dateUse),"",MONTH(dateUse),"00",refEnteteVente) as codeFacture')
        ->where([
            ['dateUse','>=', $date1],
            ['dateUse','<=', $date2],
            ['tvente_services.id','=', $idService],
            ['type_sortie','=', $type_sortie],
        ])
        ->orderBy("tvente_detail_utilisation.created_at", "asc")
        ->get();
        $output='';

        foreach ($data as $row) 
        {
            $output .='
            <tr style="vertical-align:top;">
                <td style="width:0px;height:24px;"></td>
                <td></td>
                <td class="cs6E02D7D2" style="width:101px;height:22px;line-height:15px;text-align:center;vertical-align:middle;">'.$row->codeFacture.'</td>
                <td class="cs6E02D7D2" colspan="3" style="width:230px;height:22px;line-height:15px;text-align:left;vertical-align:middle;">'.$row->nom_service.' : '.$row->noms_agent.'</td>
                <td class="cs6E02D7D2" colspan="2" style="width:88px;height:22px;line-height:15px;text-align:center;vertical-align:middle;">'.$row->dateUse.'</td>
                <td class="cs6E02D7D2" style="width:148px;height:22px;line-height:15px;text-align:left;vertical-align:middle;">'.$row->designation.'</td>
                <td class="cs6E02D7D2" style="width:42px;height:22px;line-height:15px;text-align:center;vertical-align:middle;">'.$row->qteVente.' ('.$row->uniteVente.')</td>
                <td class="cs6E02D7D2" style="width:59px;height:22px;line-height:15px;text-align:center;vertical-align:middle;">'.$row->qteVente.'</td>
                <td class="cs6E02D7D2" colspan="3" style="width:80px;height:22px;line-height:15px;text-align:center;vertical-align:middle;">'.$row->PTVente.'</td>
                <td class="cs6E02D7D2" colspan="2" style="width:58px;height:22px;line-height:15px;text-align:center;vertical-align:middle;">'.$row->montanttva.'</td>
                <td class="cs6C28398D" colspan="3" style="width:101px;height:22px;line-height:15px;text-align:center;vertical-align:middle;">'.$row->PTVenteTVA.'</td>
            </tr>
        '; 
           
   
    }

    return $output;

}


//=========== RAPPORT DES VENTES PAR SERVICE ET CATEGORIE =================================================


public function fetch_rapport_detailvente_date_service_bycategorie(Request $request)
{
    //refDepartement

    if ($request->get('date1') && $request->get('date2')&& $request->get('idService') && $request->get('idCategorie')) {
        // code...
        $date1 = $request->get('date1');
        $date2 = $request->get('date2');
        $idService = $request->get('idService');
        $idCategorie = $request->get('idCategorie');

        $html ='<html><head><meta http-equiv="Content-Type" content="text/html; charset=utf-8"/>';
        $html .= $this->printRapportDetailVente_Service_Categorie($date1, $date2,$idService,$idCategorie);       
        $html .='<script>window.print()</script>';

        echo($html);          

    } else {
        // code...
    }  
    
}
function printRapportDetailVente_Service_Categorie($date1, $date2,$idService,$idCategorie)
{

         //Info Entreprise
         $nomEse='';
         $adresseEse='';
         $Tel1Ese='';
         $Tel2Ese='';
         $siteEse='';
         $emailEse='';
         $idNatEse='';
         $numImpotEse='';
         $rccEse='';
         $siege='';
         $busnessName='';
         $pic='';
         $pic2 = $this->displayImg("fichier", 'logo.png');
         $logo='';
 
         $data1 = DB::table('entreprises')
         ->join('secteurs','secteurs.id','=','entreprises.idsecteur')
         ->join('forme_juridiques','forme_juridiques.id','=','entreprises.idforme')
 
         ->join('pays','pays.id','=','entreprises.idPays')
         ->join('provinces','provinces.id','=','entreprises.idProvince')
         ->join('users','users.id','=','entreprises.ceo')        
         ->select('entreprises.id as id','entreprises.id as idEntreprise',
         'entreprises.ceo','entreprises.nomEntreprise','entreprises.descriptionEntreprise',
         'entreprises.emailEntreprise','entreprises.adresseEntreprise',
         'entreprises.telephoneEntreprise','entreprises.solutionEntreprise','entreprises.idsecteur',
         'entreprises.idforme','entreprises.etat',
         'entreprises.idPays','entreprises.idProvince','entreprises.edition','entreprises.facebook',
         'entreprises.linkedin','entreprises.twitter','entreprises.siteweb','entreprises.rccm',
         'entreprises.invPersonnel','entreprises.invHub','entreprises.invRecherche',
         'entreprises.chiffreAffaire','entreprises.nbremploye','entreprises.slug','entreprises.logo',
             //forme
             'forme_juridiques.nomForme','secteurs.nomSecteur',
             //users
             'users.name','users.email','users.avatar','users.telephone','users.adresse',
             //
             'provinces.nomProvince','pays.nomPays', 'entreprises.created_at')
         ->get();
         $output='';
         foreach ($data1 as $row) 
         {                                
             $nomEse=$row->nomEntreprise;
             $adresseEse=$row->adresseEntreprise;
             $Tel1Ese=$row->telephoneEntreprise;
             $Tel2Ese=$row->telephone;
             $siteEse=$row->siteweb;
             $emailEse=$row->emailEntreprise;
             $idNatEse=$row->rccm;
             $numImpotEse=$row->rccm;
             $busnessName=$row->nomSecteur;
             $rccmEse=$row->rccm;
             $pic = $this->displayImg("fichier", 'logo.png');
             $siege=$row->nomForme;         
         }
 



         $sommePHT=0;
         $sommeTVA=0;
         $sommePTTF=0;
         // 
         $data2 =  DB::table('tvente_detail_vente')
         ->join('tvente_produit','tvente_produit.id','=','tvente_detail_vente.refProduit')
         ->join('tvente_categorie_produit','tvente_categorie_produit.id','=','tvente_produit.refCategorie')
 
         ->join('tvente_entete_vente','tvente_entete_vente.id','=','tvente_detail_vente.refEnteteVente')        
         ->join('tvente_module','tvente_module.id','=','tvente_entete_vente.module_id')
         ->join('tvente_services','tvente_services.id','=','tvente_entete_vente.refService')
         ->join('tvente_client','tvente_client.id','=','tvente_entete_vente.refClient')
         ->join('tvente_categorie_client','tvente_categorie_client.id','=','tvente_client.refCategieClient')  
         ->join('tfin_ssouscompte as compteclient','compteclient.id','=','tvente_categorie_client.compte_client')

         ->select(DB::raw('ROUND(SUM(((qteVente*puVente) - montantreduction)),4) as sommePHT, 
         ROUND(SUM(montanttva),4) as sommeTVA,
         ROUND(SUM(ROUND(((qteVente*puVente) - montantreduction + montanttva),4)),4) as sommePTTF'))
         ->where([
            ['dateVente','>=', $date1],
            ['dateVente','<=', $date2],
            ['tvente_services.id','=', $idService],
            ['tvente_categorie_produit.id','=', $idCategorie],
        ])    
         ->get(); 
         $output='';
         foreach ($data2 as $row) 
         {                                
            $sommePHT=$row->sommePHT;
            $sommeTVA=$row->sommeTVA;
            $sommePTTF=$row->sommePTTF;                           
         }




         $services='';
         $categorieproduit='';

         $data3=DB::table('tvente_detail_vente')
         ->join('tvente_produit','tvente_produit.id','=','tvente_detail_vente.refProduit')
         ->join('tvente_categorie_produit','tvente_categorie_produit.id','=','tvente_produit.refCategorie')
         ->join('tvente_entete_vente','tvente_entete_vente.id','=','tvente_detail_vente.refEnteteVente')
         ->join('tvente_services','tvente_services.id','=','tvente_entete_vente.refService')
         ->join('tvente_client','tvente_client.id','=','tvente_entete_vente.refClient')
         ->join('tvente_categorie_client','tvente_categorie_client.id','=','tvente_client.refCategieClient')
         ->select('tvente_detail_vente.id','refEnteteVente','refProduit','puVente','qteVente','dateVente',
         'libelle',"tvente_produit.designation","refCategorie","pu","tvente_categorie_produit.designation as Categorie",
         'tvente_detail_vente.author','tvente_detail_vente.created_at','noms','sexe',
         'contact','mail','adresse','pieceidentite','numeroPiece','dateLivrePiece','lieulivraisonCarte',
         'nationnalite','datenaissance','lieunaissance','profession','occupation','nombreEnfant',
         'dateArriverGoma','arriverPar','refCategieClient','photo','slug','nom_service',
         'tvente_detail_vente.devise','tvente_detail_vente.taux','tvente_categorie_client.designation as CategorieClient')
         ->where([
            ['dateVente','>=', $date1],
            ['dateVente','<=', $date2],
            ['tvente_services.id','=', $idService],
            ['tvente_categorie_produit.id','=', $idCategorie]
        ])      
        ->get();      
        $output='';
        foreach ($data3 as $row) 
        {
            $services=$row->nom_service;    
            $categorieproduit=$row->Categorie;          
        }


          

        $output='

               <!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Transitional//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd">
                <!-- saved from url=(0016)http://localhost -->
                <html>
                <head>
                    <title>rpt_RapportVentes</title>
                    <meta HTTP-EQUIV="Content-Type" CONTENT="text/html; charset=utf-8"/>
                    <style type="text/css">
                        .csB6F858D0 {color:#000000;background-color:#D6E5F4;border-left-style: none;border-top-style: none;border-right-style: none;border-bottom-style: none;font-family:Times New Roman; font-size:24px; font-weight:bold; font-style:normal; padding-left:2px;padding-right:2px;}
                        .cs18F2469C {color:#000000;background-color:#E0E0E0;border-left:#000000 1px solid;border-top:#000000 1px solid;border-right:#000000 1px solid;border-bottom:#000000 1px solid;font-family:Times New Roman; font-size:10px; font-weight:bold; font-style:normal; }
                        .cs797456E3 {color:#000000;background-color:#E0E0E0;border-left:#000000 1px solid;border-top:#000000 1px solid;border-right-style: none;border-bottom:#000000 1px solid;font-family:Times New Roman; font-size:10px; font-weight:bold; font-style:normal; }
                        .cs20251968 {color:#000000;background-color:#E0E0E0;border-left:#000000 1px solid;border-top:#000000 1px solid;border-right-style: none;border-bottom:#000000 1px solid;font-family:Times New Roman; font-size:13px; font-weight:bold; font-style:normal; }
                        .cs9FE9304F {color:#000000;background-color:#E0E0E0;border-left-style: none;border-top:#000000 1px solid;border-right:#000000 1px solid;border-bottom:#000000 1px solid;font-family:Times New Roman; font-size:13px; font-weight:bold; font-style:normal; }
                        .csFF9B7F36 {color:#000000;background-color:#E0E0E0;border-left-style: none;border-top:#000000 1px solid;border-right-style: none;border-bottom:#000000 1px solid;font-family:Times New Roman; font-size:10px; font-weight:bold; font-style:normal; }
                        .csEAC52FCD {color:#000000;background-color:#E0E0E0;border-left-style: none;border-top:#000000 1px solid;border-right-style: none;border-bottom:#000000 1px solid;font-family:Times New Roman; font-size:13px; font-weight:bold; font-style:normal; }
                        .cs56F73198 {color:#000000;background-color:transparent;border-left:#000000 1px solid;border-top:#000000 1px solid;border-right:#000000 1px solid;border-bottom:#000000 1px solid;font-family:Times New Roman; font-size:16px; font-weight:normal; font-style:normal; padding-left:2px;}
                        .cs8681714E {color:#000000;background-color:transparent;border-left:#000000 1px solid;border-top:#000000 1px solid;border-right-style: none;border-bottom:#000000 1px solid;font-family:Times New Roman; font-size:10px; font-weight:normal; font-style:normal; }
                        .csD06EB5B2 {color:#000000;background-color:transparent;border-left-style: none;border-top:#000000 1px solid;border-right:#000000 1px solid;border-bottom:#000000 1px solid;font-family:Times New Roman; font-size:10px; font-weight:normal; font-style:normal; }
                        .csBFBB3693 {color:#000000;background-color:transparent;border-left-style: none;border-top:#000000 1px solid;border-right-style: none;border-bottom:#000000 1px solid;font-family:Times New Roman; font-size:10px; font-weight:normal; font-style:normal; }
                        .cs612ED82F {color:#000000;background-color:transparent;border-left-style: none;border-top-style: none;border-right-style: none;border-bottom-style: none;font-family:Times New Roman; font-size:12px; font-weight:bold; font-style:normal; padding-left:2px;}
                        .csFFC1C457 {color:#000000;background-color:transparent;border-left-style: none;border-top-style: none;border-right-style: none;border-bottom-style: none;font-family:Times New Roman; font-size:12px; font-weight:normal; font-style:normal; padding-left:2px;}
                        .cs101A94F7 {color:#000000;background-color:transparent;border-left-style: none;border-top-style: none;border-right-style: none;border-bottom-style: none;font-family:Times New Roman; font-size:13px; font-weight:normal; font-style:normal; }
                        .csCE72709D {color:#000000;background-color:transparent;border-left-style: none;border-top-style: none;border-right-style: none;border-bottom-style: none;font-family:Times New Roman; font-size:14px; font-weight:bold; font-style:normal; padding-left:2px;}
                        .cs12FE94AA {color:#000000;background-color:transparent;border-left-style: none;border-top-style: none;border-right-style: none;border-bottom-style: none;font-family:Times New Roman; font-size:14px; font-weight:normal; font-style:normal; padding-left:2px;}
                        .csFBB219FE {color:#000000;background-color:transparent;border-left-style: none;border-top-style: none;border-right-style: none;border-bottom-style: none;font-family:Times New Roman; font-size:18px; font-weight:bold; font-style:normal; padding-left:2px;}
                        .cs739196BC {color:#5C5C5C;background-color:transparent;border-left-style: none;border-top-style: none;border-right-style: none;border-bottom-style: none;font-family:Segoe UI; font-size:11px; font-weight:normal; font-style:normal; }
                        .csF7D3565D {height:0px;width:0px;overflow:hidden;font-size:0px;line-height:0px;}
                    </style>
                </head>
                <body leftMargin=10 topMargin=10 rightMargin=10 bottomMargin=10 style="background-color:#FFFFFF">
                <table cellpadding="0" cellspacing="0" border="0" style="border-width:0px;empty-cells:show;width:957px;height:383px;position:relative;">
                    <tr>
                        <td style="width:0px;height:0px;"></td>
                        <td style="height:0px;width:10px;"></td>
                        <td style="height:0px;width:3px;"></td>
                        <td style="height:0px;width:84px;"></td>
                        <td style="height:0px;width:51px;"></td>
                        <td style="height:0px;width:71px;"></td>
                        <td style="height:0px;width:51px;"></td>
                        <td style="height:0px;width:73px;"></td>
                        <td style="height:0px;width:66px;"></td>
                        <td style="height:0px;width:82px;"></td>
                        <td style="height:0px;width:179px;"></td>
                        <td style="height:0px;width:24px;"></td>
                        <td style="height:0px;width:13px;"></td>
                        <td style="height:0px;width:17px;"></td>
                        <td style="height:0px;width:23px;"></td>
                        <td style="height:0px;width:30px;"></td>
                        <td style="height:0px;width:42px;"></td>
                        <td style="height:0px;width:49px;"></td>
                        <td style="height:0px;width:31px;"></td>
                        <td style="height:0px;width:58px;"></td>
                    </tr>
                    <tr style="vertical-align:top;">
                        <td style="width:0px;height:23px;"></td>
                        <td class="cs739196BC" colspan="8" style="width:409px;height:23px;line-height:14px;text-align:center;vertical-align:middle;"></td>
                        <td></td>
                        <td></td>
                        <td></td>
                        <td></td>
                        <td></td>
                        <td></td>
                        <td></td>
                        <td></td>
                        <td></td>
                        <td></td>
                        <td></td>
                    </tr>
                    <tr style="vertical-align:top;">
                        <td style="width:0px;height:9px;"></td>
                        <td></td>
                        <td></td>
                        <td></td>
                        <td></td>
                        <td></td>
                        <td></td>
                        <td></td>
                        <td></td>
                        <td></td>
                        <td></td>
                        <td></td>
                        <td></td>
                        <td></td>
                        <td></td>
                        <td></td>
                        <td></td>
                        <td></td>
                        <td></td>
                        <td></td>
                    </tr>
                    <tr style="vertical-align:top;">
                        <td style="width:0px;height:1px;"></td>
                        <td></td>
                        <td class="csFBB219FE" colspan="10" rowspan="2" style="width:682px;height:23px;line-height:21px;text-align:left;vertical-align:middle;"><nobr>'.$nomEse.'</nobr></td>
                        <td></td>
                        <td></td>
                        <td></td>
                        <td></td>
                        <td></td>
                        <td></td>
                        <td></td>
                        <td></td>
                    </tr>
                    <tr style="vertical-align:top;">
                        <td style="width:0px;height:22px;"></td>
                        <td></td>
                        <td></td>
                        <td></td>
                        <td class="cs101A94F7" colspan="5" rowspan="7" style="width:175px;height:144px;text-align:left;vertical-align:top;"><div style="overflow:hidden;width:175px;height:144px;">
                            <img alt="" src="'.$pic2.'" style="width:175px;height:144px;" /></div>
                        </td>
                        <td></td>
                    </tr>
                    <tr style="vertical-align:top;">
                        <td style="width:0px;height:22px;"></td>
                        <td></td>
                        <td class="csCE72709D" colspan="10" style="width:682px;height:22px;line-height:15px;text-align:left;vertical-align:middle;"><nobr>'.$busnessName.'</nobr></td>
                        <td></td>
                        <td></td>
                        <td></td>
                    </tr>
                    <tr style="vertical-align:top;">
                        <td style="width:0px;height:22px;"></td>
                        <td></td>
                        <td class="csCE72709D" colspan="10" style="width:682px;height:22px;line-height:15px;text-align:left;vertical-align:middle;"><nobr>RCCM'.$rccEse.'.&nbsp;ID-NAT.'.$idNatEse.'</nobr></td>
                        <td></td>
                        <td></td>
                        <td></td>
                    </tr>
                    <tr style="vertical-align:top;">
                        <td style="width:0px;height:22px;"></td>
                        <td></td>
                        <td class="csFFC1C457" colspan="10" style="width:682px;height:22px;line-height:13px;text-align:left;vertical-align:middle;">'.$adresseEse.'</td>
                        <td></td>
                        <td></td>
                        <td></td>
                    </tr>
                    <tr style="vertical-align:top;">
                        <td style="width:0px;height:22px;"></td>
                        <td></td>
                        <td class="csFFC1C457" colspan="10" style="width:682px;height:22px;line-height:13px;text-align:left;vertical-align:middle;"><nobr>Email&nbsp;:&nbsp;'.$emailEse.'</nobr></td>
                        <td></td>
                        <td></td>
                        <td></td>
                    </tr>
                    <tr style="vertical-align:top;">
                        <td style="width:0px;height:22px;"></td>
                        <td></td>
                        <td class="csFFC1C457" colspan="10" style="width:682px;height:22px;line-height:13px;text-align:left;vertical-align:middle;"><nobr>Site&nbsp;web&nbsp;:&nbsp;'.$siteEse.'</nobr></td>
                        <td></td>
                        <td></td>
                        <td></td>
                    </tr>
                    <tr style="vertical-align:top;">
                        <td style="width:0px;height:12px;"></td>
                        <td></td>
                        <td class="cs612ED82F" colspan="10" rowspan="2" style="width:682px;height:23px;line-height:13px;text-align:left;vertical-align:middle;"><nobr>T&#233;l&#233;phone&nbsp;:&nbsp;'.$Tel1Ese.'&nbsp;&nbsp;24h/24</nobr></td>
                        <td></td>
                        <td></td>
                        <td></td>
                    </tr>
                    <tr style="vertical-align:top;">
                        <td style="width:0px;height:11px;"></td>
                        <td></td>
                        <td></td>
                        <td></td>
                        <td></td>
                        <td></td>
                        <td></td>
                        <td></td>
                        <td></td>
                        <td></td>
                    </tr>
                    <tr style="vertical-align:top;">
                        <td style="width:0px;height:8px;"></td>
                        <td></td>
                        <td></td>
                        <td></td>
                        <td></td>
                        <td></td>
                        <td></td>
                        <td></td>
                        <td></td>
                        <td></td>
                        <td></td>
                        <td></td>
                        <td></td>
                        <td></td>
                        <td></td>
                        <td></td>
                        <td></td>
                        <td></td>
                        <td></td>
                        <td></td>
                    </tr>
                    <tr style="vertical-align:top;">
                        <td style="width:0px;height:32px;"></td>
                        <td></td>
                        <td></td>
                        <td></td>
                        <td></td>
                        <td class="csB6F858D0" colspan="11" style="width:625px;height:32px;line-height:28px;text-align:center;vertical-align:middle;"><nobr>RAPPORT&nbsp;JOURNALIER&nbsp;DES&nbsp;VENTES</nobr></td>
                        <td></td>
                        <td></td>
                        <td></td>
                        <td></td>
                    </tr>
                    <tr style="vertical-align:top;">
                        <td style="width:0px;height:19px;"></td>
                        <td></td>
                        <td></td>
                        <td></td>
                        <td></td>
                        <td></td>
                        <td></td>
                        <td></td>
                        <td></td>
                        <td></td>
                        <td></td>
                        <td></td>
                        <td></td>
                        <td></td>
                        <td></td>
                        <td></td>
                        <td></td>
                        <td></td>
                        <td></td>
                        <td></td>
                    </tr>
                    <tr style="vertical-align:top;">
                        <td style="width:0px;height:23px;"></td>
                        <td></td>
                        <td class="cs56F73198" colspan="6" style="width:329px;height:21px;line-height:18px;text-align:left;vertical-align:top;"><nobr>&nbsp;PERIODE&nbsp;:&nbsp;&nbsp;Du&nbsp;&nbsp;'.$date1.'&nbsp;&nbsp;au&nbsp;'.$date2.'</nobr></td>
                        <td class="cs56F73198" colspan="12" style="width:610px;height:21px;line-height:18px;text-align:left;vertical-align:top;"><nobr>'.$services.' - '.$categorieproduit.'</nobr></td>
                    </tr>
                    <tr style="vertical-align:top;">
                        <td style="width:0px;height:9px;"></td>
                        <td></td>
                        <td></td>
                        <td></td>
                        <td></td>
                        <td></td>
                        <td></td>
                        <td></td>
                        <td></td>
                        <td></td>
                        <td></td>
                        <td></td>
                        <td></td>
                        <td></td>
                        <td></td>
                        <td></td>
                        <td></td>
                        <td></td>
                        <td></td>
                        <td></td>
                    </tr>
                    <tr style="vertical-align:top;">
                        <td style="width:0px;height:24px;"></td>
                        <td></td>
                        <td></td>
                        <td class="cs9FE9304F" style="width:83px;height:22px;line-height:15px;text-align:center;vertical-align:middle;"><nobr>N&#176;&nbsp;FACTURE</nobr></td>
                        <td class="cs9FE9304F" colspan="3" style="width:172px;height:22px;line-height:15px;text-align:center;vertical-align:middle;"><nobr>CLIENT</nobr></td>
                        <td class="cs9FE9304F" style="width:72px;height:22px;line-height:15px;text-align:center;vertical-align:middle;"><nobr>DATE</nobr></td>
                        <td class="cs9FE9304F" colspan="2" style="width:147px;height:22px;line-height:15px;text-align:center;vertical-align:middle;"><nobr>CATEGORIE&nbsp;PROD.</nobr></td>
                        <td class="cs9FE9304F" style="width:178px;height:22px;line-height:15px;text-align:center;vertical-align:middle;"><nobr>ARTICLE</nobr></td>
                        <td class="cs9FE9304F" colspan="2" style="width:36px;height:22px;line-height:15px;text-align:center;vertical-align:middle;"><nobr>Qte</nobr></td>
                        <td class="cs9FE9304F" colspan="2" style="width:39px;height:22px;line-height:15px;text-align:center;vertical-align:middle;"><nobr>PU</nobr></td>
                        <td class="csEAC52FCD" colspan="2" style="width:72px;height:22px;line-height:15px;text-align:center;vertical-align:middle;"><nobr>PHT</nobr></td>
                        <td class="cs20251968" style="width:48px;height:22px;line-height:15px;text-align:center;vertical-align:middle;"><nobr>TVA</nobr></td>
                        <td class="cs20251968" colspan="2" style="width:88px;height:22px;line-height:15px;text-align:center;vertical-align:middle;"><nobr>PTTTC</nobr></td>
                    </tr>
                    ';

                            $output .= $this->showDetailVente_Service_Categorie($date1,$date2,$idService,$idCategorie); 

                            $output.='
                    <tr style="vertical-align:top;">
                        <td style="width:0px;height:24px;"></td>
                        <td></td>
                        <td></td>
                        <td></td>
                        <td></td>
                        <td></td>
                        <td></td>
                        <td></td>
                        <td></td>
                        <td></td>
                        <td></td>
                        <td class="cs18F2469C" colspan="4" style="width:75px;height:22px;line-height:11px;text-align:center;vertical-align:middle;"><nobr>TOTAL&nbsp;($)&nbsp;:</nobr></td>
                        <td class="csFF9B7F36" colspan="2" style="width:72px;height:22px;line-height:11px;text-align:center;vertical-align:middle;"><nobr>'.$sommePHT.'$</nobr></td>
                        <td class="cs797456E3" style="width:48px;height:22px;line-height:11px;text-align:center;vertical-align:middle;"><nobr>'.$sommeTVA.'$</nobr></td>
                        <td class="cs797456E3" colspan="2" style="width:88px;height:22px;line-height:11px;text-align:center;vertical-align:middle;"><nobr>'.$sommePTTF.'$</nobr></td>
                    </tr>
                    <tr style="vertical-align:top;">
                        <td style="width:0px;height:10px;"></td>
                        <td></td>
                        <td></td>
                        <td></td>
                        <td></td>
                        <td></td>
                        <td></td>
                        <td></td>
                        <td></td>
                        <td></td>
                        <td></td>
                        <td></td>
                        <td></td>
                        <td></td>
                        <td></td>
                        <td></td>
                        <td></td>
                        <td></td>
                        <td></td>
                        <td></td>
                    </tr>
                    <tr style="vertical-align:top;">
                        <td style="width:0px;height:22px;"></td>
                        <td></td>
                        <td class="cs12FE94AA" colspan="4" style="width:207px;height:22px;line-height:16px;text-align:left;vertical-align:top;"><nobr>Fait&nbsp;&#224;&nbsp;Goma&nbsp;le&nbsp;&nbsp;'.date('Y-m-d').'</nobr></td>
                        <td></td>
                        <td></td>
                        <td></td>
                        <td></td>
                        <td></td>
                        <td></td>
                        <td></td>
                        <td></td>
                        <td></td>
                        <td></td>
                        <td></td>
                        <td></td>
                        <td></td>
                        <td></td>
                    </tr>
                </table>
                </body>
                </html>
        
        ';  
       
        return $output; 

}
function showDetailVente_Service_Categorie($date1,$date2,$idService,$idCategorie)
{
        $data = DB::table('tvente_detail_vente')
        ->join('tvente_produit','tvente_produit.id','=','tvente_detail_vente.refProduit')
        ->join('tvente_categorie_produit','tvente_categorie_produit.id','=','tvente_produit.refCategorie')
    
        ->join('tvente_entete_vente','tvente_entete_vente.id','=','tvente_detail_vente.refEnteteVente')        
        ->join('tvente_module','tvente_module.id','=','tvente_entete_vente.module_id')
        ->join('tvente_services','tvente_services.id','=','tvente_entete_vente.refService')
        ->join('tvente_client','tvente_client.id','=','tvente_entete_vente.refClient')
        ->join('tvente_categorie_client','tvente_categorie_client.id','=','tvente_client.refCategieClient')  
        // ->join('tfin_ssouscompte as compteclient','compteclient.id','=','tvente_categorie_client.compte_client')
    
        // ->join('tfin_ssouscompte as comptevente','comptevente.id','=','tvente_categorie_produit.compte_vente')
        // ->join('tfin_ssouscompte as comptevariation','comptevariation.id','=','tvente_categorie_produit.compte_variationstock')
        // ->join('tfin_ssouscompte as compteperte','compteperte.id','=','tvente_categorie_produit.compte_perte')
        // ->join('tfin_ssouscompte as compteproduit','compteproduit.id','=','tvente_categorie_produit.compte_produit')
        // ->join('tfin_ssouscompte as comptedestockage','comptedestockage.id','=','tvente_categorie_produit.compte_destockage')
      
    
        ->select('tvente_detail_vente.id','refEnteteVente','refProduit','tvente_detail_vente.compte_vente',
        'tvente_detail_vente.compte_variationstock','tvente_detail_vente.compte_perte','tvente_detail_vente.compte_produit',
        'tvente_detail_vente.compte_destockage','puVente','qteVente','uniteVente','puBase','qteBase',
        'tvente_detail_vente.uniteBase','cmupVente','tvente_detail_vente.devise','tvente_detail_vente.taux',
        'montanttva','montantreduction',
        'tvente_detail_vente.active','tvente_detail_vente.author','tvente_detail_vente.refUser',
        'tvente_detail_vente.created_at','idStockService',
        //Produit
        'tvente_produit.designation','tvente_produit.refCategorie','tvente_produit.refUniteBase',
        'tvente_produit.pu','tvente_produit.qte','tvente_produit.cmup','tvente_produit.taux',
        'tvente_produit.Oldcode','tvente_produit.Newcode','tvente_produit.tvaapplique',
        'tvente_produit.estvendable','tvente_categorie_produit.designation as Categorie',
        //client 
        'noms','sexe','contact','mail','adresse','pieceidentite','numeroPiece','dateLivrePiece',
        'lieulivraisonCarte','nationnalite','datenaissance','lieunaissance','profession','occupation',
        'nombreEnfant','dateArriverGoma','arriverPar','refCategieClient','photo','slug',
        "tvente_categorie_client.designation as CategorieClient","compte_client",
        // 'compteclient.refSousCompte','compteclient.nom_ssouscompte','compteclient.numero_ssouscompte',
        //ente vente
        'nom_service', "tvente_module.nom_module",'tvente_entete_vente.code','refClient','refService','refReservation','module_id',
        'dateVente','libelle','tvente_entete_vente.montant','tvente_entete_vente.paie','reduction','totaltva',
        //compte produit
        // 'comptevente.refSousCompte as refSousCompteVente','comptevente.nom_ssouscompte as nom_ssouscompteVente',
        // 'comptevente.numero_ssouscompte as numero_ssouscompteVente'
        // ,'comptevariation.refSousCompte as refSousCompteVariation','comptevariation.nom_ssouscompte as nom_ssouscompteVariation',
        // 'comptevariation.numero_ssouscompte as numero_ssouscompteVariation'
        // ,'compteperte.refSousCompte as refSousComptePerte','compteperte.nom_ssouscompte as nom_ssouscomptePerte',
        // 'compteperte.numero_ssouscompte as numero_ssouscomptePerte'
        // ,'compteproduit.refSousCompte as refSousCompteProduit','compteproduit.nom_ssouscompte as nom_ssouscompteProduit',
        // 'compteproduit.numero_ssouscompte as numero_ssouscompteProduit'
        // ,'comptedestockage.refSousCompte as refSousCompteDestockage','comptedestockage.nom_ssouscompte as nom_ssouscompteDestockage',
        // 'comptedestockage.numero_ssouscompte as numero_ssouscompteDestockage',
        'priseencharge')
       ->selectRaw('ROUND(((qteVente*puVente) - montantreduction),2) as PTVente')
       ->selectRaw('ROUND(((qteVente*puVente) - montantreduction + montanttva),2) as PTVenteTVA')
       ->selectRaw('ROUND((IFNULL(montant,0)),2) as totalFacture')
       ->selectRaw('ROUND((montanttva),2) as TotalTVA')
       ->selectRaw('ROUND((((IFNULL(montant,0)) - montantreduction)+(montanttva)),2) as PTTTC')
       ->selectRaw('((qteVente*puVente)/tvente_detail_vente.taux) as PTVenteFC')
       ->selectRaw('(qteBase*puBase) as PTBase')
       ->selectRaw('IFNULL(paie,0) as totalPaie')
       ->selectRaw('(IFNULL(montant,0)-IFNULL(paie,0)) as RestePaie')
        ->selectRaw('CONCAT("S",YEAR(dateVente),"",MONTH(dateVente),"00",refEnteteVente) as codeFacture')
        ->where([
            ['dateVente','>=', $date1],
            ['dateVente','<=', $date2],
            ['tvente_services.id','=', $idService],
            ['tvente_categorie_produit.id','=', $idCategorie]
        ])
        ->orderBy("tvente_detail_vente.created_at", "asc")
        ->get();
        $output='';

        foreach ($data as $row) 
        {
            $output .='
             <tr style="vertical-align:top;">
                <td style="width:0px;height:24px;"></td>
                <td></td>
                <td></td>
                <td class="csD06EB5B2" style="width:83px;height:22px;line-height:11px;text-align:center;vertical-align:middle;">'.$row->codeFacture.'</td>
                <td class="csD06EB5B2" colspan="3" style="width:172px;height:22px;line-height:11px;text-align:left;vertical-align:middle;">'.$row->noms.'</td>
                <td class="csD06EB5B2" style="width:72px;height:22px;line-height:11px;text-align:center;vertical-align:middle;">'.$row->dateVente.'</td>
                <td class="csD06EB5B2" colspan="2" style="width:147px;height:22px;line-height:11px;text-align:left;vertical-align:middle;">'.$row->Categorie.'</td>
                <td class="csD06EB5B2" style="width:178px;height:22px;line-height:11px;text-align:left;vertical-align:middle;">'.$row->designation.'</td>
                <td class="csD06EB5B2" colspan="2" style="width:36px;height:22px;line-height:11px;text-align:center;vertical-align:middle;">'.$row->qteVente.'</td>
                <td class="csD06EB5B2" colspan="2" style="width:39px;height:22px;line-height:11px;text-align:center;vertical-align:middle;">'.$row->puVente.'$</td>
                <td class="csBFBB3693" colspan="2" style="width:72px;height:22px;line-height:11px;text-align:center;vertical-align:middle;">'.$row->PTVente.'$</td>
                <td class="cs8681714E" style="width:48px;height:22px;line-height:11px;text-align:center;vertical-align:middle;">'.$row->montanttva.'$</td>
                <td class="cs8681714E" colspan="2" style="width:88px;height:22px;line-height:11px;text-align:center;vertical-align:middle;">'.$row->PTVenteTVA.'$</td>
            </tr>
        '; 
           
   
    }

    return $output;

}



//==================== RAPPORT DETAIL Vente BY MEDICAMENT =======================================

public function fetch_rapport_detailvente_date_produit(Request $request)
{
    //refDepartement

    if ($request->get('date1') && $request->get('date2')&& $request->get('refProduit')) {
        // code...
        $date1 = $request->get('date1');
        $date2 = $request->get('date2');
        $refProduit = $request->get('refProduit');
        
        $html ='<html><head><meta http-equiv="Content-Type" content="text/html; charset=utf-8"/>';
        $html .= $this->printRapportDetailVente_Produit($date1, $date2,$refProduit);       
        $html .='<script>window.print()</script>';

        echo($html); 

        // $html = $this->printRapportDetailVente_Produit($date1, $date2,$refProduit);
        // $pdf = \App::make('dompdf.wrapper');
        // $pdf->loadHTML($html)->setPaper('a4', 'landscape');
        // return $pdf->stream();            

    } else {
        // code...
    }
    
}
function printRapportDetailVente_Produit($date1, $date2,$refProduit)
{

         //Info Entreprise
         $nomEse='';
         $adresseEse='';
         $Tel1Ese='';
         $Tel2Ese='';
         $siteEse='';
         $emailEse='';
         $idNatEse='';
         $numImpotEse='';
         $rccEse='';
         $siege='';
         $busnessName='';
         $pic='';
         $pic2 = $this->displayImg("fichier", 'logo.png');
         $logo='';
 
         $data1 = DB::table('entreprises')
         ->join('secteurs','secteurs.id','=','entreprises.idsecteur')
         ->join('forme_juridiques','forme_juridiques.id','=','entreprises.idforme')
 
         ->join('pays','pays.id','=','entreprises.idPays')
         ->join('provinces','provinces.id','=','entreprises.idProvince')
         ->join('users','users.id','=','entreprises.ceo')        
         ->select('entreprises.id as id','entreprises.id as idEntreprise',
         'entreprises.ceo','entreprises.nomEntreprise','entreprises.descriptionEntreprise',
         'entreprises.emailEntreprise','entreprises.adresseEntreprise',
         'entreprises.telephoneEntreprise','entreprises.solutionEntreprise','entreprises.idsecteur',
         'entreprises.idforme','entreprises.etat',
         'entreprises.idPays','entreprises.idProvince','entreprises.edition','entreprises.facebook',
         'entreprises.linkedin','entreprises.twitter','entreprises.siteweb','entreprises.rccm',
         'entreprises.invPersonnel','entreprises.invHub','entreprises.invRecherche',
         'entreprises.chiffreAffaire','entreprises.nbremploye','entreprises.slug','entreprises.logo',
             //forme
             'forme_juridiques.nomForme','secteurs.nomSecteur',
             //users
             'users.name','users.email','users.avatar','users.telephone','users.adresse',
             //
             'provinces.nomProvince','pays.nomPays', 'entreprises.created_at')
         ->get();
         $output='';
         foreach ($data1 as $row) 
         {                                
             $nomEse=$row->nomEntreprise;
             $adresseEse=$row->adresseEntreprise;
             $Tel1Ese=$row->telephoneEntreprise;
             $Tel2Ese=$row->telephone;
             $siteEse=$row->siteweb;
             $emailEse=$row->emailEntreprise;
             $idNatEse=$row->rccm;
             $numImpotEse=$row->rccm;
             $busnessName=$row->nomSecteur;
             $rccmEse=$row->rccm;
             $pic = $this->displayImg("fichier", 'logo.png');
             $siege=$row->nomForme;         
         }
 

         $sommePHT=0;
         $sommeTVA=0;
         $sommePTTF=0;
         // 
         $data2 =  DB::table('tvente_detail_vente')
         ->join('tvente_produit','tvente_produit.id','=','tvente_detail_vente.refProduit')
         ->join('tvente_categorie_produit','tvente_categorie_produit.id','=','tvente_produit.refCategorie')
 
         ->join('tvente_entete_vente','tvente_entete_vente.id','=','tvente_detail_vente.refEnteteVente')        
         ->join('tvente_module','tvente_module.id','=','tvente_entete_vente.module_id')
         ->join('tvente_services','tvente_services.id','=','tvente_entete_vente.refService')
         ->join('tvente_client','tvente_client.id','=','tvente_entete_vente.refClient')
         ->join('tvente_categorie_client','tvente_categorie_client.id','=','tvente_client.refCategieClient')  
         ->join('tfin_ssouscompte as compteclient','compteclient.id','=','tvente_categorie_client.compte_client')

         ->select(DB::raw('ROUND(SUM(((qteVente*puVente) - montantreduction)),4) as sommePHT, 
         ROUND(SUM(montanttva),4) as sommeTVA,
         ROUND(SUM(ROUND(((qteVente*puVente) - montantreduction + montanttva),4)),4) as sommePTTF'))
         ->where([
            ['dateVente','>=', $date1],
            ['dateVente','<=', $date2],
            ['tvente_produit.id','=', $refProduit],
        ])    
         ->get(); 
         $output='';
         foreach ($data2 as $row) 
         {                                
            $sommePHT=$row->sommePHT;
            $sommeTVA=$row->sommeTVA;
            $sommePTTF=$row->sommePTTF;                           
         }


         $designationProduit='';
         $categorieProduit='';

         $data3=DB::table('tvente_detail_vente')
         ->join('tvente_produit','tvente_produit.id','=','tvente_detail_vente.refProduit')
         ->join('tvente_categorie_produit','tvente_categorie_produit.id','=','tvente_produit.refCategorie')
         ->join('tvente_entete_vente','tvente_entete_vente.id','=','tvente_detail_vente.refEnteteVente')
         ->join('tvente_client','tvente_client.id','=','tvente_entete_vente.refClient')
         ->join('tvente_categorie_client','tvente_categorie_client.id','=','tvente_client.refCategieClient')
         ->select('tvente_detail_vente.id','refEnteteVente','refProduit','puVente','qteVente','dateVente',
         'libelle',"tvente_produit.designation","refCategorie","pu","tvente_categorie_produit.designation as Categorie",
         'tvente_detail_vente.author','tvente_detail_vente.created_at','noms','sexe',
         'contact','mail','adresse','pieceidentite','numeroPiece','dateLivrePiece','lieulivraisonCarte',
         'nationnalite','datenaissance','lieunaissance','profession','occupation','nombreEnfant',
         'dateArriverGoma','arriverPar','refCategieClient','photo','slug',
         'tvente_detail_vente.devise','tvente_detail_vente.taux','tvente_categorie_client.designation as CategorieClient')
         ->selectRaw('(qteVente*puVente) as prixTotal')
         ->selectRaw('CONCAT("S",YEAR(dateVente),"",MONTH(dateVente),"00",refEnteteVente) as codeFacture') 
         ->where([
            ['dateVente','>=', $date1],
            ['dateVente','<=', $date2],
            ['refProduit','=', $refProduit],
        ])      
        ->get();      
        $output='';
        foreach ($data3 as $row) 
        {
            $designationProduit=$row->designation;
            $categorieProduit=$row->Categorie;                   
        }



           

        $output='

            <!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Transitional//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd">
            <!-- saved from url=(0016)http://localhost -->
            <html>
            <head>
                <title>rpt_RapportVentes</title>
                <meta HTTP-EQUIV="Content-Type" CONTENT="text/html; charset=utf-8"/>
                <style type="text/css">
                    .csB6F858D0 {color:#000000;background-color:#D6E5F4;border-left-style: none;border-top-style: none;border-right-style: none;border-bottom-style: none;font-family:Times New Roman; font-size:24px; font-weight:bold; font-style:normal; padding-left:2px;padding-right:2px;}
                    .cs18F2469C {color:#000000;background-color:#E0E0E0;border-left:#000000 1px solid;border-top:#000000 1px solid;border-right:#000000 1px solid;border-bottom:#000000 1px solid;font-family:Times New Roman; font-size:10px; font-weight:bold; font-style:normal; }
                    .cs797456E3 {color:#000000;background-color:#E0E0E0;border-left:#000000 1px solid;border-top:#000000 1px solid;border-right-style: none;border-bottom:#000000 1px solid;font-family:Times New Roman; font-size:10px; font-weight:bold; font-style:normal; }
                    .cs20251968 {color:#000000;background-color:#E0E0E0;border-left:#000000 1px solid;border-top:#000000 1px solid;border-right-style: none;border-bottom:#000000 1px solid;font-family:Times New Roman; font-size:13px; font-weight:bold; font-style:normal; }
                    .cs9FE9304F {color:#000000;background-color:#E0E0E0;border-left-style: none;border-top:#000000 1px solid;border-right:#000000 1px solid;border-bottom:#000000 1px solid;font-family:Times New Roman; font-size:13px; font-weight:bold; font-style:normal; }
                    .csFF9B7F36 {color:#000000;background-color:#E0E0E0;border-left-style: none;border-top:#000000 1px solid;border-right-style: none;border-bottom:#000000 1px solid;font-family:Times New Roman; font-size:10px; font-weight:bold; font-style:normal; }
                    .csEAC52FCD {color:#000000;background-color:#E0E0E0;border-left-style: none;border-top:#000000 1px solid;border-right-style: none;border-bottom:#000000 1px solid;font-family:Times New Roman; font-size:13px; font-weight:bold; font-style:normal; }
                    .cs56F73198 {color:#000000;background-color:transparent;border-left:#000000 1px solid;border-top:#000000 1px solid;border-right:#000000 1px solid;border-bottom:#000000 1px solid;font-family:Times New Roman; font-size:16px; font-weight:normal; font-style:normal; padding-left:2px;}
                    .cs8681714E {color:#000000;background-color:transparent;border-left:#000000 1px solid;border-top:#000000 1px solid;border-right-style: none;border-bottom:#000000 1px solid;font-family:Times New Roman; font-size:10px; font-weight:normal; font-style:normal; }
                    .csD06EB5B2 {color:#000000;background-color:transparent;border-left-style: none;border-top:#000000 1px solid;border-right:#000000 1px solid;border-bottom:#000000 1px solid;font-family:Times New Roman; font-size:10px; font-weight:normal; font-style:normal; }
                    .csBFBB3693 {color:#000000;background-color:transparent;border-left-style: none;border-top:#000000 1px solid;border-right-style: none;border-bottom:#000000 1px solid;font-family:Times New Roman; font-size:10px; font-weight:normal; font-style:normal; }
                    .cs612ED82F {color:#000000;background-color:transparent;border-left-style: none;border-top-style: none;border-right-style: none;border-bottom-style: none;font-family:Times New Roman; font-size:12px; font-weight:bold; font-style:normal; padding-left:2px;}
                    .csFFC1C457 {color:#000000;background-color:transparent;border-left-style: none;border-top-style: none;border-right-style: none;border-bottom-style: none;font-family:Times New Roman; font-size:12px; font-weight:normal; font-style:normal; padding-left:2px;}
                    .cs101A94F7 {color:#000000;background-color:transparent;border-left-style: none;border-top-style: none;border-right-style: none;border-bottom-style: none;font-family:Times New Roman; font-size:13px; font-weight:normal; font-style:normal; }
                    .csCE72709D {color:#000000;background-color:transparent;border-left-style: none;border-top-style: none;border-right-style: none;border-bottom-style: none;font-family:Times New Roman; font-size:14px; font-weight:bold; font-style:normal; padding-left:2px;}
                    .cs12FE94AA {color:#000000;background-color:transparent;border-left-style: none;border-top-style: none;border-right-style: none;border-bottom-style: none;font-family:Times New Roman; font-size:14px; font-weight:normal; font-style:normal; padding-left:2px;}
                    .csFBB219FE {color:#000000;background-color:transparent;border-left-style: none;border-top-style: none;border-right-style: none;border-bottom-style: none;font-family:Times New Roman; font-size:18px; font-weight:bold; font-style:normal; padding-left:2px;}
                    .cs739196BC {color:#5C5C5C;background-color:transparent;border-left-style: none;border-top-style: none;border-right-style: none;border-bottom-style: none;font-family:Segoe UI; font-size:11px; font-weight:normal; font-style:normal; }
                    .csF7D3565D {height:0px;width:0px;overflow:hidden;font-size:0px;line-height:0px;}
                </style>
            </head>
            <body leftMargin=10 topMargin=10 rightMargin=10 bottomMargin=10 style="background-color:#FFFFFF">
            <table cellpadding="0" cellspacing="0" border="0" style="border-width:0px;empty-cells:show;width:957px;height:383px;position:relative;">
                <tr>
                    <td style="width:0px;height:0px;"></td>
                    <td style="height:0px;width:10px;"></td>
                    <td style="height:0px;width:3px;"></td>
                    <td style="height:0px;width:84px;"></td>
                    <td style="height:0px;width:51px;"></td>
                    <td style="height:0px;width:71px;"></td>
                    <td style="height:0px;width:51px;"></td>
                    <td style="height:0px;width:73px;"></td>
                    <td style="height:0px;width:66px;"></td>
                    <td style="height:0px;width:82px;"></td>
                    <td style="height:0px;width:179px;"></td>
                    <td style="height:0px;width:24px;"></td>
                    <td style="height:0px;width:13px;"></td>
                    <td style="height:0px;width:17px;"></td>
                    <td style="height:0px;width:23px;"></td>
                    <td style="height:0px;width:30px;"></td>
                    <td style="height:0px;width:42px;"></td>
                    <td style="height:0px;width:49px;"></td>
                    <td style="height:0px;width:31px;"></td>
                    <td style="height:0px;width:58px;"></td>
                </tr>
                <tr style="vertical-align:top;">
                    <td style="width:0px;height:23px;"></td>
                    <td class="cs739196BC" colspan="8" style="width:409px;height:23px;line-height:14px;text-align:center;vertical-align:middle;"></td>
                    <td></td>
                    <td></td>
                    <td></td>
                    <td></td>
                    <td></td>
                    <td></td>
                    <td></td>
                    <td></td>
                    <td></td>
                    <td></td>
                    <td></td>
                </tr>
                <tr style="vertical-align:top;">
                    <td style="width:0px;height:9px;"></td>
                    <td></td>
                    <td></td>
                    <td></td>
                    <td></td>
                    <td></td>
                    <td></td>
                    <td></td>
                    <td></td>
                    <td></td>
                    <td></td>
                    <td></td>
                    <td></td>
                    <td></td>
                    <td></td>
                    <td></td>
                    <td></td>
                    <td></td>
                    <td></td>
                    <td></td>
                </tr>
                <tr style="vertical-align:top;">
                    <td style="width:0px;height:1px;"></td>
                    <td></td>
                    <td class="csFBB219FE" colspan="10" rowspan="2" style="width:682px;height:23px;line-height:21px;text-align:left;vertical-align:middle;"><nobr>'.$nomEse.'</nobr></td>
                    <td></td>
                    <td></td>
                    <td></td>
                    <td></td>
                    <td></td>
                    <td></td>
                    <td></td>
                    <td></td>
                </tr>
                <tr style="vertical-align:top;">
                    <td style="width:0px;height:22px;"></td>
                    <td></td>
                    <td></td>
                    <td></td>
                    <td class="cs101A94F7" colspan="5" rowspan="7" style="width:175px;height:144px;text-align:left;vertical-align:top;"><div style="overflow:hidden;width:175px;height:144px;">
                        <img alt="" src="'.$pic2.'" style="width:175px;height:144px;" /></div>
                    </td>
                    <td></td>
                </tr>
                <tr style="vertical-align:top;">
                    <td style="width:0px;height:22px;"></td>
                    <td></td>
                    <td class="csCE72709D" colspan="10" style="width:682px;height:22px;line-height:15px;text-align:left;vertical-align:middle;"><nobr>'.$busnessName.'</nobr></td>
                    <td></td>
                    <td></td>
                    <td></td>
                </tr>
                <tr style="vertical-align:top;">
                    <td style="width:0px;height:22px;"></td>
                    <td></td>
                    <td class="csCE72709D" colspan="10" style="width:682px;height:22px;line-height:15px;text-align:left;vertical-align:middle;"><nobr>RCCM'.$rccEse.'.&nbsp;ID-NAT.'.$idNatEse.'</nobr></td>
                    <td></td>
                    <td></td>
                    <td></td>
                </tr>
                <tr style="vertical-align:top;">
                    <td style="width:0px;height:22px;"></td>
                    <td></td>
                    <td class="csFFC1C457" colspan="10" style="width:682px;height:22px;line-height:13px;text-align:left;vertical-align:middle;">'.$adresseEse.'</td>
                    <td></td>
                    <td></td>
                    <td></td>
                </tr>
                <tr style="vertical-align:top;">
                    <td style="width:0px;height:22px;"></td>
                    <td></td>
                    <td class="csFFC1C457" colspan="10" style="width:682px;height:22px;line-height:13px;text-align:left;vertical-align:middle;"><nobr>Email&nbsp;:&nbsp;'.$emailEse.'</nobr></td>
                    <td></td>
                    <td></td>
                    <td></td>
                </tr>
                <tr style="vertical-align:top;">
                    <td style="width:0px;height:22px;"></td>
                    <td></td>
                    <td class="csFFC1C457" colspan="10" style="width:682px;height:22px;line-height:13px;text-align:left;vertical-align:middle;"><nobr>Site&nbsp;web&nbsp;:&nbsp;'.$siteEse.'</nobr></td>
                    <td></td>
                    <td></td>
                    <td></td>
                </tr>
                <tr style="vertical-align:top;">
                    <td style="width:0px;height:12px;"></td>
                    <td></td>
                    <td class="cs612ED82F" colspan="10" rowspan="2" style="width:682px;height:23px;line-height:13px;text-align:left;vertical-align:middle;"><nobr>T&#233;l&#233;phone&nbsp;:&nbsp;'.$Tel1Ese.'&nbsp;&nbsp;24h/24</nobr></td>
                    <td></td>
                    <td></td>
                    <td></td>
                </tr>
                <tr style="vertical-align:top;">
                    <td style="width:0px;height:11px;"></td>
                    <td></td>
                    <td></td>
                    <td></td>
                    <td></td>
                    <td></td>
                    <td></td>
                    <td></td>
                    <td></td>
                    <td></td>
                </tr>
                <tr style="vertical-align:top;">
                    <td style="width:0px;height:8px;"></td>
                    <td></td>
                    <td></td>
                    <td></td>
                    <td></td>
                    <td></td>
                    <td></td>
                    <td></td>
                    <td></td>
                    <td></td>
                    <td></td>
                    <td></td>
                    <td></td>
                    <td></td>
                    <td></td>
                    <td></td>
                    <td></td>
                    <td></td>
                    <td></td>
                    <td></td>
                </tr>
                <tr style="vertical-align:top;">
                    <td style="width:0px;height:32px;"></td>
                    <td></td>
                    <td></td>
                    <td></td>
                    <td></td>
                    <td class="csB6F858D0" colspan="11" style="width:625px;height:32px;line-height:28px;text-align:center;vertical-align:middle;"><nobr>RAPPORT&nbsp;JOURNALIER&nbsp;DES&nbsp;VENTES</nobr></td>
                    <td></td>
                    <td></td>
                    <td></td>
                    <td></td>
                </tr>
                <tr style="vertical-align:top;">
                    <td style="width:0px;height:19px;"></td>
                    <td></td>
                    <td></td>
                    <td></td>
                    <td></td>
                    <td></td>
                    <td></td>
                    <td></td>
                    <td></td>
                    <td></td>
                    <td></td>
                    <td></td>
                    <td></td>
                    <td></td>
                    <td></td>
                    <td></td>
                    <td></td>
                    <td></td>
                    <td></td>
                    <td></td>
                </tr>
                <tr style="vertical-align:top;">
                    <td style="width:0px;height:23px;"></td>
                    <td></td>
                    <td class="cs56F73198" colspan="6" style="width:329px;height:21px;line-height:18px;text-align:left;vertical-align:top;"><nobr>&nbsp;PERIODE&nbsp;:&nbsp;&nbsp;Du&nbsp;&nbsp;'.$date1.'&nbsp;&nbsp;au&nbsp;'.$date2.'</nobr></td>
                    <td class="cs56F73198" colspan="12" style="width:610px;height:21px;line-height:18px;text-align:left;vertical-align:top;"><nobr>'.$designationProduit.' - '.$categorieProduit.'</nobr></td>
                </tr>
                <tr style="vertical-align:top;">
                    <td style="width:0px;height:9px;"></td>
                    <td></td>
                    <td></td>
                    <td></td>
                    <td></td>
                    <td></td>
                    <td></td>
                    <td></td>
                    <td></td>
                    <td></td>
                    <td></td>
                    <td></td>
                    <td></td>
                    <td></td>
                    <td></td>
                    <td></td>
                    <td></td>
                    <td></td>
                    <td></td>
                    <td></td>
                </tr>
                <tr style="vertical-align:top;">
                    <td style="width:0px;height:24px;"></td>
                    <td></td>
                    <td></td>
                    <td class="cs9FE9304F" style="width:83px;height:22px;line-height:15px;text-align:center;vertical-align:middle;"><nobr>N&#176;&nbsp;FACTURE</nobr></td>
                    <td class="cs9FE9304F" colspan="3" style="width:172px;height:22px;line-height:15px;text-align:center;vertical-align:middle;"><nobr>CLIENT</nobr></td>
                    <td class="cs9FE9304F" style="width:72px;height:22px;line-height:15px;text-align:center;vertical-align:middle;"><nobr>DATE</nobr></td>
                    <td class="cs9FE9304F" colspan="2" style="width:147px;height:22px;line-height:15px;text-align:center;vertical-align:middle;"><nobr>CATEGORIE&nbsp;PROD.</nobr></td>
                    <td class="cs9FE9304F" style="width:178px;height:22px;line-height:15px;text-align:center;vertical-align:middle;"><nobr>ARTICLE</nobr></td>
                    <td class="cs9FE9304F" colspan="2" style="width:36px;height:22px;line-height:15px;text-align:center;vertical-align:middle;"><nobr>Qte</nobr></td>
                    <td class="cs9FE9304F" colspan="2" style="width:39px;height:22px;line-height:15px;text-align:center;vertical-align:middle;"><nobr>PU</nobr></td>
                    <td class="csEAC52FCD" colspan="2" style="width:72px;height:22px;line-height:15px;text-align:center;vertical-align:middle;"><nobr>PHT</nobr></td>
                    <td class="cs20251968" style="width:48px;height:22px;line-height:15px;text-align:center;vertical-align:middle;"><nobr>TVA</nobr></td>
                    <td class="cs20251968" colspan="2" style="width:88px;height:22px;line-height:15px;text-align:center;vertical-align:middle;"><nobr>PTTTC</nobr></td>
                </tr>
                ';

                        $output .= $this->showDetailVente_Produit($date1, $date2,$refProduit); 

                        $output.='
                <tr style="vertical-align:top;">
                    <td style="width:0px;height:24px;"></td>
                    <td></td>
                    <td></td>
                    <td></td>
                    <td></td>
                    <td></td>
                    <td></td>
                    <td></td>
                    <td></td>
                    <td></td>
                    <td></td>
                    <td class="cs18F2469C" colspan="4" style="width:75px;height:22px;line-height:11px;text-align:center;vertical-align:middle;"><nobr>TOTAL&nbsp;($)&nbsp;:</nobr></td>
                    <td class="csFF9B7F36" colspan="2" style="width:72px;height:22px;line-height:11px;text-align:center;vertical-align:middle;"><nobr>'.$sommePHT.'$</nobr></td>
                    <td class="cs797456E3" style="width:48px;height:22px;line-height:11px;text-align:center;vertical-align:middle;"><nobr>'.$sommeTVA.'$</nobr></td>
                    <td class="cs797456E3" colspan="2" style="width:88px;height:22px;line-height:11px;text-align:center;vertical-align:middle;"><nobr>'.$sommePTTF.'$</nobr></td>
                </tr>
                <tr style="vertical-align:top;">
                    <td style="width:0px;height:10px;"></td>
                    <td></td>
                    <td></td>
                    <td></td>
                    <td></td>
                    <td></td>
                    <td></td>
                    <td></td>
                    <td></td>
                    <td></td>
                    <td></td>
                    <td></td>
                    <td></td>
                    <td></td>
                    <td></td>
                    <td></td>
                    <td></td>
                    <td></td>
                    <td></td>
                    <td></td>
                </tr>
                <tr style="vertical-align:top;">
                    <td style="width:0px;height:22px;"></td>
                    <td></td>
                    <td class="cs12FE94AA" colspan="4" style="width:207px;height:22px;line-height:16px;text-align:left;vertical-align:top;"><nobr>Fait&nbsp;&#224;&nbsp;Goma&nbsp;le&nbsp;&nbsp;'.date('Y-m-d').'</nobr></td>
                    <td></td>
                    <td></td>
                    <td></td>
                    <td></td>
                    <td></td>
                    <td></td>
                    <td></td>
                    <td></td>
                    <td></td>
                    <td></td>
                    <td></td>
                    <td></td>
                    <td></td>
                    <td></td>
                </tr>
            </table>
            </body>
            </html>

        ';  
       
        return $output; 

}
function showDetailVente_Produit($date1, $date2,$refProduit)
{
    $data = DB::table('tvente_detail_vente')
        ->join('tvente_produit','tvente_produit.id','=','tvente_detail_vente.refProduit')
        ->join('tvente_categorie_produit','tvente_categorie_produit.id','=','tvente_produit.refCategorie')
    
        ->join('tvente_entete_vente','tvente_entete_vente.id','=','tvente_detail_vente.refEnteteVente')        
        ->join('tvente_module','tvente_module.id','=','tvente_entete_vente.module_id')
        ->join('tvente_services','tvente_services.id','=','tvente_entete_vente.refService')
        ->join('tvente_client','tvente_client.id','=','tvente_entete_vente.refClient')
        ->join('tvente_categorie_client','tvente_categorie_client.id','=','tvente_client.refCategieClient')  
        // ->join('tfin_ssouscompte as compteclient','compteclient.id','=','tvente_categorie_client.compte_client')
    
        // ->join('tfin_ssouscompte as comptevente','comptevente.id','=','tvente_categorie_produit.compte_vente')
        // ->join('tfin_ssouscompte as comptevariation','comptevariation.id','=','tvente_categorie_produit.compte_variationstock')
        // ->join('tfin_ssouscompte as compteperte','compteperte.id','=','tvente_categorie_produit.compte_perte')
        // ->join('tfin_ssouscompte as compteproduit','compteproduit.id','=','tvente_categorie_produit.compte_produit')
        // ->join('tfin_ssouscompte as comptedestockage','comptedestockage.id','=','tvente_categorie_produit.compte_destockage')
      
    
        ->select('tvente_detail_vente.id','refEnteteVente','refProduit','tvente_detail_vente.compte_vente',
        'tvente_detail_vente.compte_variationstock','tvente_detail_vente.compte_perte','tvente_detail_vente.compte_produit',
        'tvente_detail_vente.compte_destockage','puVente','qteVente','uniteVente','puBase','qteBase',
        'tvente_detail_vente.uniteBase','cmupVente','tvente_detail_vente.devise','tvente_detail_vente.taux',
        'montanttva','montantreduction',
        'tvente_detail_vente.active','tvente_detail_vente.author','tvente_detail_vente.refUser',
        'tvente_detail_vente.created_at','idStockService',
        //Produit
        'tvente_produit.designation','tvente_produit.refCategorie','tvente_produit.refUniteBase',
        'tvente_produit.pu','tvente_produit.qte','tvente_produit.cmup','tvente_produit.taux',
        'tvente_produit.Oldcode','tvente_produit.Newcode','tvente_produit.tvaapplique',
        'tvente_produit.estvendable','tvente_categorie_produit.designation as Categorie',
        //client 
        'noms','sexe','contact','mail','adresse','pieceidentite','numeroPiece','dateLivrePiece',
        'lieulivraisonCarte','nationnalite','datenaissance','lieunaissance','profession','occupation',
        'nombreEnfant','dateArriverGoma','arriverPar','refCategieClient','photo','slug',
        "tvente_categorie_client.designation as CategorieClient","compte_client",
        // 'compteclient.refSousCompte','compteclient.nom_ssouscompte','compteclient.numero_ssouscompte',
        //ente vente
        'nom_service', "tvente_module.nom_module",'tvente_entete_vente.code','refClient','refService','refReservation','module_id',
        'dateVente','libelle','tvente_entete_vente.montant','tvente_entete_vente.paie','reduction',
        'tvente_categorie_produit.designation as Categorie','totaltva',
        //compte produit
        // 'comptevente.refSousCompte as refSousCompteVente','comptevente.nom_ssouscompte as nom_ssouscompteVente',
        // 'comptevente.numero_ssouscompte as numero_ssouscompteVente'
        // ,'comptevariation.refSousCompte as refSousCompteVariation','comptevariation.nom_ssouscompte as nom_ssouscompteVariation',
        // 'comptevariation.numero_ssouscompte as numero_ssouscompteVariation'
        // ,'compteperte.refSousCompte as refSousComptePerte','compteperte.nom_ssouscompte as nom_ssouscomptePerte',
        // 'compteperte.numero_ssouscompte as numero_ssouscomptePerte'
        // ,'compteproduit.refSousCompte as refSousCompteProduit','compteproduit.nom_ssouscompte as nom_ssouscompteProduit',
        // 'compteproduit.numero_ssouscompte as numero_ssouscompteProduit'
        // ,'comptedestockage.refSousCompte as refSousCompteDestockage','comptedestockage.nom_ssouscompte as nom_ssouscompteDestockage',
        // 'comptedestockage.numero_ssouscompte as numero_ssouscompteDestockage',
        'priseencharge')
       ->selectRaw('ROUND(((qteVente*puVente) - montantreduction),2) as PTVente')
       ->selectRaw('ROUND(((qteVente*puVente) - montantreduction + montanttva),2) as PTVenteTVA')
       ->selectRaw('ROUND((IFNULL(montant,0)),2) as totalFacture')
       ->selectRaw('ROUND((montanttva),2) as TotalTVA')
       ->selectRaw('ROUND((((IFNULL(montant,0)) - montantreduction)+(montanttva)),2) as PTTTC')
       ->selectRaw('((qteVente*puVente)/tvente_detail_vente.taux) as PTVenteFC')
       ->selectRaw('(qteBase*puBase) as PTBase')
       ->selectRaw('IFNULL(paie,0) as totalPaie')
       ->selectRaw('(IFNULL(montant,0)-IFNULL(paie,0)) as RestePaie')
       ->selectRaw('CONCAT("S",YEAR(dateVente),"",MONTH(dateVente),"00",refEnteteVente) as codeFacture')
       ->where([
                ['dateVente','>=', $date1],
                ['dateVente','<=', $date2],
                ['refProduit','=', $refProduit]
            ])
      ->orderBy("tvente_detail_vente.created_at", "asc")
    ->get();
    $output='';

    foreach ($data as $row) 
    {
        $output .='
            <tr style="vertical-align:top;">
                <td style="width:0px;height:24px;"></td>
                <td></td>
                <td></td>
                <td class="csD06EB5B2" style="width:83px;height:22px;line-height:11px;text-align:center;vertical-align:middle;">'.$row->codeFacture.'</td>
                <td class="csD06EB5B2" colspan="3" style="width:172px;height:22px;line-height:11px;text-align:left;vertical-align:middle;">'.$row->noms.'</td>
                <td class="csD06EB5B2" style="width:72px;height:22px;line-height:11px;text-align:center;vertical-align:middle;">'.$row->dateVente.'</td>
                <td class="csD06EB5B2" colspan="2" style="width:147px;height:22px;line-height:11px;text-align:left;vertical-align:middle;">'.$row->Categorie.'</td>
                <td class="csD06EB5B2" style="width:178px;height:22px;line-height:11px;text-align:left;vertical-align:middle;">'.$row->designation.'</td>
                <td class="csD06EB5B2" colspan="2" style="width:36px;height:22px;line-height:11px;text-align:center;vertical-align:middle;">'.$row->qteVente.'</td>
                <td class="csD06EB5B2" colspan="2" style="width:39px;height:22px;line-height:11px;text-align:center;vertical-align:middle;">'.$row->puVente.'$</td>
                <td class="csBFBB3693" colspan="2" style="width:72px;height:22px;line-height:11px;text-align:center;vertical-align:middle;">'.$row->PTVente.'$</td>
                <td class="cs8681714E" style="width:48px;height:22px;line-height:11px;text-align:center;vertical-align:middle;">'.$row->montanttva.'$</td>
                <td class="cs8681714E" colspan="2" style="width:88px;height:22px;line-height:11px;text-align:center;vertical-align:middle;">'.$row->PTVenteTVA.'$</td>
            </tr>
        ';          
   
    }

    return $output;

}

//==================== RAPPORT JOURNALIER DES ENTREES ===========================================================================

public function fetch_rapport_detailentree_date(Request $request)
{
    //

    if ($request->get('date1') && $request->get('date2')) {
        // code...
        $date1 = $request->get('date1');
        $date2 = $request->get('date2');

        $html ='<html><head><meta http-equiv="Content-Type" content="text/html; charset=utf-8"/>';
        $html .= $this->printRapportDetailEntree($date1, $date2);       
        $html .='<script>window.print()</script>';

        echo($html); 
        
        // $html = $this->printRapportDetailEntree($date1, $date2);
        // $pdf = \App::make('dompdf.wrapper');
        // $pdf->loadHTML($html)->setPaper('a4', 'landscape');
        // return $pdf->stream();            

    } else {
        // code...
    }
    
    
}
function printRapportDetailEntree($date1, $date2)
{

         //Info Entreprise
         $nomEse='';
         $adresseEse='';
         $Tel1Ese='';
         $Tel2Ese='';
         $siteEse='';
         $emailEse='';
         $idNatEse='';
         $numImpotEse='';
         $rccEse='';
         $siege='';
         $busnessName='';
         $pic='';
         $pic2 = $this->displayImg("fichier", 'logo.png');
         $logo='';
 
         $data1 = DB::table('entreprises')
         ->join('secteurs','secteurs.id','=','entreprises.idsecteur')
         ->join('forme_juridiques','forme_juridiques.id','=','entreprises.idforme')
 
         ->join('pays','pays.id','=','entreprises.idPays')
         ->join('provinces','provinces.id','=','entreprises.idProvince')
         ->join('users','users.id','=','entreprises.ceo')        
         ->select('entreprises.id as id','entreprises.id as idEntreprise',
         'entreprises.ceo','entreprises.nomEntreprise','entreprises.descriptionEntreprise',
         'entreprises.emailEntreprise','entreprises.adresseEntreprise',
         'entreprises.telephoneEntreprise','entreprises.solutionEntreprise','entreprises.idsecteur',
         'entreprises.idforme','entreprises.etat',
         'entreprises.idPays','entreprises.idProvince','entreprises.edition','entreprises.facebook',
         'entreprises.linkedin','entreprises.twitter','entreprises.siteweb','entreprises.rccm',
         'entreprises.invPersonnel','entreprises.invHub','entreprises.invRecherche',
         'entreprises.chiffreAffaire','entreprises.nbremploye','entreprises.slug','entreprises.logo',
             //forme
             'forme_juridiques.nomForme','secteurs.nomSecteur',
             //users
             'users.name','users.email','users.avatar','users.telephone','users.adresse',
             //
             'provinces.nomProvince','pays.nomPays', 'entreprises.created_at')
         ->get();
         $output='';
         foreach ($data1 as $row) 
         {                                
             $nomEse=$row->nomEntreprise;
             $adresseEse=$row->adresseEntreprise;
             $Tel1Ese=$row->telephoneEntreprise;
             $Tel2Ese=$row->telephone;
             $siteEse=$row->siteweb;
             $emailEse=$row->emailEntreprise;
             $idNatEse=$row->rccm;
             $numImpotEse=$row->rccm;
             $busnessName=$row->nomSecteur;
             $rccmEse=$row->rccm;
             $pic = $this->displayImg("fichier", 'logo.png');
             $siege=$row->nomForme;         
         }
 

         $totalFact=0;
                 
         // 
         $data2 =   DB::table('tvente_detail_entree')
         ->join('tvente_produit','tvente_produit.id','=','tvente_detail_entree.refProduit')
         ->join('tvente_categorie_produit','tvente_categorie_produit.id','=','tvente_produit.refCategorie')
         ->join('tvente_entete_entree','tvente_entete_entree.id','=','tvente_detail_entree.refEnteteEntree')
         ->join('tvente_fournisseur','tvente_fournisseur.id','=','tvente_entete_entree.refFournisseur')
 
         ->select(DB::raw('ROUND(SUM(qteEntree*puEntree),0) as TotalFacture'))
         ->where([
            ['dateEntree','>=', $date1],
            ['dateEntree','<=', $date2]
        ])    
         ->get(); 
         $output='';
         foreach ($data2 as $row) 
         {                                
            $totalFact=$row->TotalFacture;
                           
         }

           

        $output='<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Transitional//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd">
        <!-- saved from url=(0016)http://localhost -->
        <html>
        <head>
            <title>rpt_Rapportdetailfacture</title>
            <meta HTTP-EQUIV="Content-Type" CONTENT="text/html; charset=utf-8"/>
            <style type="text/css">
                .csB6F858D0 {color:#000000;background-color:#D6E5F4;border-left-style: none;border-top-style: none;border-right-style: none;border-bottom-style: none;font-family:Times New Roman; font-size:24px; font-weight:bold; font-style:normal; padding-left:2px;padding-right:2px;}
                .cs49AA1D99 {color:#000000;background-color:#E0E0E0;border-left:#000000 1px solid;border-top:#000000 1px solid;border-right:#000000 1px solid;border-bottom:#000000 1px solid;font-family:Times New Roman; font-size:13px; font-weight:bold; font-style:normal; }
                .cs9FE9304F {color:#000000;background-color:#E0E0E0;border-left-style: none;border-top:#000000 1px solid;border-right:#000000 1px solid;border-bottom:#000000 1px solid;font-family:Times New Roman; font-size:13px; font-weight:bold; font-style:normal; }
                .csEAC52FCD {color:#000000;background-color:#E0E0E0;border-left-style: none;border-top:#000000 1px solid;border-right-style: none;border-bottom:#000000 1px solid;font-family:Times New Roman; font-size:13px; font-weight:bold; font-style:normal; }
                .cs56F73198 {color:#000000;background-color:transparent;border-left:#000000 1px solid;border-top:#000000 1px solid;border-right:#000000 1px solid;border-bottom:#000000 1px solid;font-family:Times New Roman; font-size:16px; font-weight:normal; font-style:normal; padding-left:2px;}
                .cs6E02D7D2 {color:#000000;background-color:transparent;border-left-style: none;border-top:#000000 1px solid;border-right:#000000 1px solid;border-bottom:#000000 1px solid;font-family:Times New Roman; font-size:14px; font-weight:normal; font-style:normal; }
                .cs6C28398D {color:#000000;background-color:transparent;border-left-style: none;border-top:#000000 1px solid;border-right-style: none;border-bottom:#000000 1px solid;font-family:Times New Roman; font-size:14px; font-weight:normal; font-style:normal; }
                .cs612ED82F {color:#000000;background-color:transparent;border-left-style: none;border-top-style: none;border-right-style: none;border-bottom-style: none;font-family:Times New Roman; font-size:12px; font-weight:bold; font-style:normal; padding-left:2px;}
                .csFFC1C457 {color:#000000;background-color:transparent;border-left-style: none;border-top-style: none;border-right-style: none;border-bottom-style: none;font-family:Times New Roman; font-size:12px; font-weight:normal; font-style:normal; padding-left:2px;}
                .cs101A94F7 {color:#000000;background-color:transparent;border-left-style: none;border-top-style: none;border-right-style: none;border-bottom-style: none;font-family:Times New Roman; font-size:13px; font-weight:normal; font-style:normal; }
                .csCE72709D {color:#000000;background-color:transparent;border-left-style: none;border-top-style: none;border-right-style: none;border-bottom-style: none;font-family:Times New Roman; font-size:14px; font-weight:bold; font-style:normal; padding-left:2px;}
                .cs12FE94AA {color:#000000;background-color:transparent;border-left-style: none;border-top-style: none;border-right-style: none;border-bottom-style: none;font-family:Times New Roman; font-size:14px; font-weight:normal; font-style:normal; padding-left:2px;}
                .csFBB219FE {color:#000000;background-color:transparent;border-left-style: none;border-top-style: none;border-right-style: none;border-bottom-style: none;font-family:Times New Roman; font-size:18px; font-weight:bold; font-style:normal; padding-left:2px;}
                .cs739196BC {color:#5C5C5C;background-color:transparent;border-left-style: none;border-top-style: none;border-right-style: none;border-bottom-style: none;font-family:Segoe UI; font-size:11px; font-weight:normal; font-style:normal; }
                .csF7D3565D {height:0px;width:0px;overflow:hidden;font-size:0px;line-height:0px;}
            </style>
        </head>
        <body leftMargin=10 topMargin=10 rightMargin=10 bottomMargin=10 style="background-color:#FFFFFF">
        <table cellpadding="0" cellspacing="0" border="0" style="border-width:0px;empty-cells:show;width:909px;height:383px;position:relative;">
            <tr>
                <td style="width:0px;height:0px;"></td>
                <td style="height:0px;width:10px;"></td>
                <td style="height:0px;width:102px;"></td>
                <td style="height:0px;width:36px;"></td>
                <td style="height:0px;width:71px;"></td>
                <td style="height:0px;width:124px;"></td>
                <td style="height:0px;width:66px;"></td>
                <td style="height:0px;width:42px;"></td>
                <td style="height:0px;width:179px;"></td>
                <td style="height:0px;width:64px;"></td>
                <td style="height:0px;width:28px;"></td>
                <td style="height:0px;width:2px;"></td>
                <td style="height:0px;width:53px;"></td>
                <td style="height:0px;width:10px;"></td>
                <td style="height:0px;width:112px;"></td>
                <td style="height:0px;width:10px;"></td>
            </tr>
            <tr style="vertical-align:top;">
                <td style="width:0px;height:23px;"></td>
                <td></td>
                <td></td>
                <td></td>
                <td></td>
                <td></td>
                <td></td>
                <td></td>
                <td></td>
                <td></td>
                <td></td>
            </tr>
            <tr style="vertical-align:top;">
                <td style="width:0px;height:9px;"></td>
                <td></td>
                <td></td>
                <td></td>
                <td></td>
                <td></td>
                <td></td>
                <td></td>
                <td></td>
                <td></td>
                <td></td>
                <td></td>
                <td></td>
                <td></td>
                <td></td>
                <td></td>
            </tr>
            <tr style="vertical-align:top;">
                <td style="width:0px;height:1px;"></td>
                <td></td>
                <td class="csFBB219FE" colspan="8" rowspan="2" style="width:682px;height:23px;line-height:21px;text-align:left;vertical-align:middle;"><nobr>'.$nomEse.'</nobr></td>
                <td></td>
                <td></td>
                <td></td>
                <td></td>
                <td></td>
                <td></td>
            </tr>
            <tr style="vertical-align:top;">
                <td style="width:0px;height:22px;"></td>
                <td></td>
                <td></td>
                <td></td>
                <td class="cs101A94F7" colspan="3" rowspan="7" style="width:175px;height:144px;text-align:left;vertical-align:top;"><div style="overflow:hidden;width:175px;height:144px;">
                    <!--[if lt IE 7]><img alt="" src="'.$pic2.'" style="width:175px;height:144px;filter:progid:DXImageTransform.Microsoft.AlphaImageLoader(src="",sizingMethod="");" /><div style="display:none"><![endif]--><img alt="" src="'.$pic2.'" style="width:175px;height:144px;" /><!--[if lt IE 7]></div><![endif]--></div>
                </td>
                <td></td>
            </tr>
            <tr style="vertical-align:top;">
                <td style="width:0px;height:22px;"></td>
                <td></td>
                <td class="csCE72709D" colspan="8" style="width:682px;height:22px;line-height:15px;text-align:left;vertical-align:middle;"><nobr>'.$busnessName.'</nobr></td>
                <td></td>
                <td></td>
                <td></td>
            </tr>
            <tr style="vertical-align:top;">
                <td style="width:0px;height:22px;"></td>
                <td></td>
                <td class="csCE72709D" colspan="8" style="width:682px;height:22px;line-height:15px;text-align:left;vertical-align:middle;"><nobr>RCCM'.$rccEse.'.&nbsp;ID-NAT.'.$idNatEse.'</nobr></td>
                <td></td>
                <td></td>
                <td></td>
            </tr>
            <tr style="vertical-align:top;">
                <td style="width:0px;height:22px;"></td>
                <td></td>
                <td class="csFFC1C457" colspan="8" style="width:682px;height:22px;line-height:13px;text-align:left;vertical-align:middle;">'.$adresseEse.'</td>
                <td></td>
                <td></td>
                <td></td>
            </tr>
            <tr style="vertical-align:top;">
                <td style="width:0px;height:22px;"></td>
                <td></td>
                <td class="csFFC1C457" colspan="8" style="width:682px;height:22px;line-height:13px;text-align:left;vertical-align:middle;"><nobr>Email&nbsp;:&nbsp;'.$emailEse.'</nobr></td>
                <td></td>
                <td></td>
                <td></td>
            </tr>
            <tr style="vertical-align:top;">
                <td style="width:0px;height:22px;"></td>
                <td></td>
                <td class="csFFC1C457" colspan="8" style="width:682px;height:22px;line-height:13px;text-align:left;vertical-align:middle;"><nobr>Site&nbsp;web&nbsp;:&nbsp;'.$siteEse.'</nobr></td>
                <td></td>
                <td></td>
                <td></td>
            </tr>
            <tr style="vertical-align:top;">
                <td style="width:0px;height:12px;"></td>
                <td></td>
                <td class="cs612ED82F" colspan="8" rowspan="2" style="width:682px;height:23px;line-height:13px;text-align:left;vertical-align:middle;"><nobr>T&#233;l&#233;phone&nbsp;:&nbsp;'.$Tel1Ese.'&nbsp;&nbsp;24h/24</nobr></td>
                <td></td>
                <td></td>
                <td></td>
            </tr>
            <tr style="vertical-align:top;">
                <td style="width:0px;height:11px;"></td>
                <td></td>
                <td></td>
                <td></td>
                <td></td>
                <td></td>
                <td></td>
                <td></td>
            </tr>
            <tr style="vertical-align:top;">
                <td style="width:0px;height:8px;"></td>
                <td></td>
                <td></td>
                <td></td>
                <td></td>
                <td></td>
                <td></td>
                <td></td>
                <td></td>
                <td></td>
                <td></td>
                <td></td>
                <td></td>
                <td></td>
                <td></td>
                <td></td>
            </tr>
            <tr style="vertical-align:top;">
                <td style="width:0px;height:32px;"></td>
                <td></td>
                <td></td>
                <td></td>
                <td class="csB6F858D0" colspan="9" style="width:625px;height:32px;line-height:28px;text-align:center;vertical-align:middle;"><nobr>RAPPORT&nbsp;JOURNALIER&nbsp;DES&nbsp;ENTREES</nobr></td>
                <td></td>
                <td></td>
                <td></td>
            </tr>
            <tr style="vertical-align:top;">
                <td style="width:0px;height:19px;"></td>
                <td></td>
                <td></td>
                <td></td>
                <td></td>
                <td></td>
                <td></td>
                <td></td>
                <td></td>
                <td></td>
                <td></td>
                <td></td>
                <td></td>
                <td></td>
                <td></td>
                <td></td>
            </tr>
            <tr style="vertical-align:top;">
                <td style="width:0px;height:23px;"></td>
                <td></td>
                <td class="cs56F73198" colspan="4" style="width:329px;height:21px;line-height:18px;text-align:left;vertical-align:top;"><nobr>&nbsp;PERIODE&nbsp;:&nbsp;&nbsp;Du&nbsp;&nbsp;'.$date1.'&nbsp;&nbsp;au&nbsp;'.$date2.'</nobr></td>
                <td></td>
                <td></td>
                <td></td>
                <td></td>
                <td></td>
                <td></td>
                <td></td>
                <td></td>
                <td></td>
                <td></td>
            </tr>
            <tr style="vertical-align:top;">
                <td style="width:0px;height:9px;"></td>
                <td></td>
                <td></td>
                <td></td>
                <td></td>
                <td></td>
                <td></td>
                <td></td>
                <td></td>
                <td></td>
                <td></td>
                <td></td>
                <td></td>
                <td></td>
                <td></td>
                <td></td>
            </tr>
            <tr style="vertical-align:top;">
                <td style="width:0px;height:24px;"></td>
                <td></td>
                <td class="cs9FE9304F" style="width:101px;height:22px;line-height:15px;text-align:center;vertical-align:middle;"><nobr>N&#176;&nbsp;FACTURE</nobr></td>
                <td class="cs9FE9304F" colspan="3" style="width:230px;height:22px;line-height:15px;text-align:center;vertical-align:middle;"><nobr>FOURNISSEUR</nobr></td>
                <td class="cs9FE9304F" colspan="2" style="width:107px;height:22px;line-height:15px;text-align:center;vertical-align:middle;"><nobr>DATE&nbsp;ENTREE</nobr></td>
                <td class="cs9FE9304F" style="width:178px;height:22px;line-height:15px;text-align:center;vertical-align:middle;"><nobr>ARTICLE</nobr></td>
                <td class="cs9FE9304F" colspan="2" style="width:91px;height:22px;line-height:15px;text-align:center;vertical-align:middle;"><nobr>Qte</nobr></td>
                <td class="cs9FE9304F" colspan="3" style="width:64px;height:22px;line-height:15px;text-align:center;vertical-align:middle;"><nobr>PU(USD)</nobr></td>
                <td class="csEAC52FCD" colspan="2" style="width:122px;height:22px;line-height:15px;text-align:center;vertical-align:middle;"><nobr>PT(USD)</nobr></td>
            </tr>
            ';

            $output .= $this->showDetailEntree($date1,$date2); 

            $output.='
            <tr style="vertical-align:top;">
                <td style="width:0px;height:24px;"></td>
                <td></td>
                <td></td>
                <td></td>
                <td></td>
                <td></td>
                <td></td>
                <td></td>
                <td></td>
                <td class="cs49AA1D99" colspan="5" style="width:155px;height:22px;line-height:15px;text-align:center;vertical-align:middle;"><nobr>TOTAL&nbsp;($)&nbsp;:</nobr></td>
                <td class="csEAC52FCD" colspan="2" style="width:122px;height:22px;line-height:15px;text-align:center;vertical-align:middle;">'.$totalFact.' $</td>
            </tr>
            <tr style="vertical-align:top;">
                <td style="width:0px;height:10px;"></td>
                <td></td>
                <td></td>
                <td></td>
                <td></td>
                <td></td>
                <td></td>
                <td></td>
                <td></td>
                <td></td>
                <td></td>
                <td></td>
                <td></td>
                <td></td>
                <td></td>
                <td></td>
            </tr>
            <tr style="vertical-align:top;">
                <td style="width:0px;height:22px;"></td>
                <td></td>
                <td class="cs12FE94AA" colspan="3" style="width:207px;height:22px;line-height:16px;text-align:left;vertical-align:top;"><nobr>Fait&nbsp;&#224;&nbsp;Goma&nbsp;le&nbsp;&nbsp;'.date('Y-m-d').'</nobr></td>
                <td></td>
                <td></td>
                <td></td>
                <td></td>
                <td></td>
                <td></td>
                <td></td>
                <td></td>
                <td></td>
                <td></td>
                <td></td>
            </tr>
        </table>
        </body>
        </html>';  
       
        return $output; 

}
function showDetailEntree($date1, $date2)
{
    $data = DB::table('tvente_detail_entree')

    ->join('tvente_entete_entree','tvente_entete_entree.id','=','tvente_detail_entree.refEnteteEntree')
    ->join('tvente_module','tvente_module.id','=','tvente_entete_entree.module_id')
    ->join('tvente_fournisseur','tvente_fournisseur.id','=','tvente_entete_entree.refFournisseur')

    ->join('tvente_services','tvente_services.id','=','tvente_entete_entree.refService')
    ->join('tvente_produit','tvente_produit.id','=','tvente_detail_entree.refProduit')
    ->join('tvente_categorie_produit','tvente_categorie_produit.id','=','tvente_produit.refCategorie')
    
    // ->join('tfin_ssouscompte as compteachat','compteachat.id','=','tvente_categorie_produit.compte_achat')       
    // ->join('tfin_ssouscompte as comptevariation','comptevariation.id','=','tvente_categorie_produit.compte_variationstock')       
    // ->join('tfin_ssouscompte as compteproduit','compteproduit.id','=','tvente_categorie_produit.compte_produit')        
    // ->join('tfin_ssouscompte as comptestockage','comptestockage.id','=','tvente_categorie_produit.compte_stockage')      

    ->select('tvente_detail_entree.id','refEnteteEntree','refProduit','tvente_entete_entree.refService',
    'tvente_detail_entree.compte_achat','tvente_detail_entree.compte_variationstock',
    'tvente_detail_entree.compte_produit','tvente_detail_entree.compte_stockage','puEntree','qteEntree',
    'uniteEntree',
    'puBase','qteBase','tvente_detail_entree.uniteBase','tvente_detail_entree.devise','tvente_detail_entree.taux',
    'montanttva','montantreduction','tvente_detail_entree.active','tvente_detail_entree.author',
    'tvente_detail_entree.refUser','tvente_detail_entree.created_at','tvente_detail_entree.devise',
    'tvente_detail_entree.taux'

    ,'noms','contact','mail','adresse','tvente_entete_entree.code','tvente_entete_entree.refFournisseur',
    'tvente_entete_entree.refRecquisition','tvente_entete_entree.module_id','dateEntree',
    'tvente_entete_entree.libelle','transporteur','niveau1','niveaumax',"tvente_module.nom_module"

    ,'nom_service'

    ,"tvente_produit.designation as designation",'refCategorie','refUniteBase','pu','qte',
    'cmup','Oldcode','Newcode','tvaapplique','estvendable',"tvente_categorie_produit.designation as Categorie"

    // ,'compteachat.refSousCompte as refSousCompteAchat','compteachat.nom_ssouscompte as nom_ssouscompteAchat',
    // 'compteachat.numero_ssouscompte as numero_ssouscompteAchat'
    // ,'comptevariation.refSousCompte as refSousCompteVariation','comptevariation.nom_ssouscompte as nom_ssouscompteVariation',
    // 'comptevariation.numero_ssouscompte as numero_ssouscompteVariation'
    // ,'compteproduit.refSousCompte as refSousCompteProduit','compteproduit.nom_ssouscompte as nom_ssouscompteProduit',
    // 'compteproduit.numero_ssouscompte as numero_ssouscompteProduit'
    // ,'comptestockage.refSousCompte as refSousCompteStockage','comptestockage.nom_ssouscompte as nom_ssouscompteStockage',
    // 'comptestockage.numero_ssouscompte as numero_ssouscompteStockage' 
    )
    ->selectRaw('(((qteEntree) * (puEntree))/tvente_detail_entree.taux) as PTEntreeFC')
    ->selectRaw('(qteBase*puBase) as PTBase')
    ->selectRaw('((qteBase*puBase)/tvente_detail_entree.taux) as PTBaseFC')
    ->selectRaw('(qteEntree*puEntree) as prixTotal')
    ->selectRaw('CONCAT("BE",YEAR(dateEntree),"",MONTH(dateEntree),"00",refEnteteEntree) as codeFacture')
    ->where([
        ['dateEntree','>=', $date1],
        ['dateEntree','<=', $date2]
    ])
    ->orderBy("tvente_detail_entree.created_at", "asc")
    ->get();

    $output='';

    foreach ($data as $row) 
    { 
        $output .='<tr style="vertical-align:top;">
        <td style="width:0px;height:24px;"></td>
        <td></td>
        <td class="cs6E02D7D2" style="width:101px;height:22px;line-height:15px;text-align:center;vertical-align:middle;">'.$row->codeFacture.'</td>
        <td class="cs6E02D7D2" colspan="3" style="width:230px;height:22px;line-height:15px;text-align:left;vertical-align:middle;">'.$row->noms.'</td>
        <td class="cs6E02D7D2" colspan="2" style="width:107px;height:22px;line-height:15px;text-align:center;vertical-align:middle;">'.$row->dateEntree.'</td>
        <td class="cs6E02D7D2" style="width:178px;height:22px;line-height:15px;text-align:left;vertical-align:middle;">'.$row->designation.'</td>
        <td class="cs6E02D7D2" colspan="2" style="width:91px;height:22px;line-height:15px;text-align:center;vertical-align:middle;">'.$row->qteEntree.' ('.$row->uniteEntree.')</td>
        <td class="cs6E02D7D2" colspan="3" style="width:64px;height:22px;line-height:15px;text-align:center;vertical-align:middle;">'.$row->puEntree.'$</td>
        <td class="cs6C28398D" colspan="2" style="width:122px;height:22px;line-height:15px;text-align:center;vertical-align:middle;">'.$row->prixTotal.'$</td>
    </tr>';      
   
    }

    return $output;

}


//==================== RAPPORT JOURNALIER DES REQUISITIONS ===========================================================================

public function fetch_rapport_detailcmd_date(Request $request)
{
    //

    if ($request->get('date1') && $request->get('date2')) {
        // code...
        $date1 = $request->get('date1');
        $date2 = $request->get('date2');

        $html ='<html><head><meta http-equiv="Content-Type" content="text/html; charset=utf-8"/>';
        $html .= $this->printRapportDetailRequisition($date1, $date2);       
        $html .='<script>window.print()</script>';

        echo($html); 
        
        // $html = $this->printRapportDetailRequisition($date1, $date2);
        // $pdf = \App::make('dompdf.wrapper');
        // $pdf->loadHTML($html)->setPaper('a4', 'landscape');
        // return $pdf->stream();            

    } else {
        // code...
    }
    
    
}
function printRapportDetailRequisition($date1, $date2)
{

         //Info Entreprise
         $nomEse='';
         $adresseEse='';
         $Tel1Ese='';
         $Tel2Ese='';
         $siteEse='';
         $emailEse='';
         $idNatEse='';
         $numImpotEse='';
         $rccEse='';
         $siege='';
         $busnessName='';
         $pic='';
         $pic2 = $this->displayImg("fichier", 'logo.png');
         $logo='';
 
         $data1 = DB::table('entreprises')
         ->join('secteurs','secteurs.id','=','entreprises.idsecteur')
         ->join('forme_juridiques','forme_juridiques.id','=','entreprises.idforme')
 
         ->join('pays','pays.id','=','entreprises.idPays')
         ->join('provinces','provinces.id','=','entreprises.idProvince')
         ->join('users','users.id','=','entreprises.ceo')        
         ->select('entreprises.id as id','entreprises.id as idEntreprise',
         'entreprises.ceo','entreprises.nomEntreprise','entreprises.descriptionEntreprise',
         'entreprises.emailEntreprise','entreprises.adresseEntreprise',
         'entreprises.telephoneEntreprise','entreprises.solutionEntreprise','entreprises.idsecteur',
         'entreprises.idforme','entreprises.etat',
         'entreprises.idPays','entreprises.idProvince','entreprises.edition','entreprises.facebook',
         'entreprises.linkedin','entreprises.twitter','entreprises.siteweb','entreprises.rccm',
         'entreprises.invPersonnel','entreprises.invHub','entreprises.invRecherche',
         'entreprises.chiffreAffaire','entreprises.nbremploye','entreprises.slug','entreprises.logo',
             //forme
             'forme_juridiques.nomForme','secteurs.nomSecteur',
             //users
             'users.name','users.email','users.avatar','users.telephone','users.adresse',
             //
             'provinces.nomProvince','pays.nomPays', 'entreprises.created_at')
         ->get();
         $output='';
         foreach ($data1 as $row) 
         {                                
             $nomEse=$row->nomEntreprise;
             $adresseEse=$row->adresseEntreprise;
             $Tel1Ese=$row->telephoneEntreprise;
             $Tel2Ese=$row->telephone;
             $siteEse=$row->siteweb;
             $emailEse=$row->emailEntreprise;
             $idNatEse=$row->rccm;
             $numImpotEse=$row->rccm;
             $busnessName=$row->nomSecteur;
             $rccmEse=$row->rccm;
             $pic = $this->displayImg("fichier", 'logo.png');
             $siege=$row->nomForme;         
         }
 

         $totalFact=0;
                 
         // 
         $data2 =  DB::table('tvente_detail_requisition')         
         ->join('tvente_entete_requisition','tvente_entete_requisition.id','=','tvente_detail_requisition.refEnteteCmd')
         ->select(DB::raw('ROUND(SUM(qteCmd*puCmd),2) as TotalFacture'))
         ->where([
            ['dateCmd','>=', $date1],
            ['dateCmd','<=', $date2]
        ])    
         ->get(); 
         $output='';
         foreach ($data2 as $row) 
         {                                
            $totalFact=$row->TotalFacture;
                           
         }

           

        $output='<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Transitional//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd">
        <!-- saved from url=(0016)http://localhost -->
        <html>
        <head>
            <title>rpt_Rapportdetailfacture</title>
            <meta HTTP-EQUIV="Content-Type" CONTENT="text/html; charset=utf-8"/>
            <style type="text/css">
                .csB6F858D0 {color:#000000;background-color:#D6E5F4;border-left-style: none;border-top-style: none;border-right-style: none;border-bottom-style: none;font-family:Times New Roman; font-size:24px; font-weight:bold; font-style:normal; padding-left:2px;padding-right:2px;}
                .cs49AA1D99 {color:#000000;background-color:#E0E0E0;border-left:#000000 1px solid;border-top:#000000 1px solid;border-right:#000000 1px solid;border-bottom:#000000 1px solid;font-family:Times New Roman; font-size:13px; font-weight:bold; font-style:normal; }
                .cs9FE9304F {color:#000000;background-color:#E0E0E0;border-left-style: none;border-top:#000000 1px solid;border-right:#000000 1px solid;border-bottom:#000000 1px solid;font-family:Times New Roman; font-size:13px; font-weight:bold; font-style:normal; }
                .csEAC52FCD {color:#000000;background-color:#E0E0E0;border-left-style: none;border-top:#000000 1px solid;border-right-style: none;border-bottom:#000000 1px solid;font-family:Times New Roman; font-size:13px; font-weight:bold; font-style:normal; }
                .cs56F73198 {color:#000000;background-color:transparent;border-left:#000000 1px solid;border-top:#000000 1px solid;border-right:#000000 1px solid;border-bottom:#000000 1px solid;font-family:Times New Roman; font-size:16px; font-weight:normal; font-style:normal; padding-left:2px;}
                .cs6E02D7D2 {color:#000000;background-color:transparent;border-left-style: none;border-top:#000000 1px solid;border-right:#000000 1px solid;border-bottom:#000000 1px solid;font-family:Times New Roman; font-size:14px; font-weight:normal; font-style:normal; }
                .cs6C28398D {color:#000000;background-color:transparent;border-left-style: none;border-top:#000000 1px solid;border-right-style: none;border-bottom:#000000 1px solid;font-family:Times New Roman; font-size:14px; font-weight:normal; font-style:normal; }
                .cs612ED82F {color:#000000;background-color:transparent;border-left-style: none;border-top-style: none;border-right-style: none;border-bottom-style: none;font-family:Times New Roman; font-size:12px; font-weight:bold; font-style:normal; padding-left:2px;}
                .csFFC1C457 {color:#000000;background-color:transparent;border-left-style: none;border-top-style: none;border-right-style: none;border-bottom-style: none;font-family:Times New Roman; font-size:12px; font-weight:normal; font-style:normal; padding-left:2px;}
                .cs101A94F7 {color:#000000;background-color:transparent;border-left-style: none;border-top-style: none;border-right-style: none;border-bottom-style: none;font-family:Times New Roman; font-size:13px; font-weight:normal; font-style:normal; }
                .csCE72709D {color:#000000;background-color:transparent;border-left-style: none;border-top-style: none;border-right-style: none;border-bottom-style: none;font-family:Times New Roman; font-size:14px; font-weight:bold; font-style:normal; padding-left:2px;}
                .cs12FE94AA {color:#000000;background-color:transparent;border-left-style: none;border-top-style: none;border-right-style: none;border-bottom-style: none;font-family:Times New Roman; font-size:14px; font-weight:normal; font-style:normal; padding-left:2px;}
                .csFBB219FE {color:#000000;background-color:transparent;border-left-style: none;border-top-style: none;border-right-style: none;border-bottom-style: none;font-family:Times New Roman; font-size:18px; font-weight:bold; font-style:normal; padding-left:2px;}
                .cs739196BC {color:#5C5C5C;background-color:transparent;border-left-style: none;border-top-style: none;border-right-style: none;border-bottom-style: none;font-family:Segoe UI; font-size:11px; font-weight:normal; font-style:normal; }
                .csF7D3565D {height:0px;width:0px;overflow:hidden;font-size:0px;line-height:0px;}
            </style>
        </head>
        <body leftMargin=10 topMargin=10 rightMargin=10 bottomMargin=10 style="background-color:#FFFFFF">
        <table cellpadding="0" cellspacing="0" border="0" style="border-width:0px;empty-cells:show;width:909px;height:383px;position:relative;">
            <tr>
                <td style="width:0px;height:0px;"></td>
                <td style="height:0px;width:10px;"></td>
                <td style="height:0px;width:102px;"></td>
                <td style="height:0px;width:36px;"></td>
                <td style="height:0px;width:71px;"></td>
                <td style="height:0px;width:124px;"></td>
                <td style="height:0px;width:66px;"></td>
                <td style="height:0px;width:42px;"></td>
                <td style="height:0px;width:179px;"></td>
                <td style="height:0px;width:64px;"></td>
                <td style="height:0px;width:28px;"></td>
                <td style="height:0px;width:2px;"></td>
                <td style="height:0px;width:53px;"></td>
                <td style="height:0px;width:10px;"></td>
                <td style="height:0px;width:112px;"></td>
                <td style="height:0px;width:10px;"></td>
            </tr>
            <tr style="vertical-align:top;">
                <td style="width:0px;height:23px;"></td>
                <td></td>
                <td></td>
                <td></td>
                <td></td>
                <td></td>
                <td></td>
                <td></td>
                <td></td>
                <td></td>
                <td></td>
            </tr>
            <tr style="vertical-align:top;">
                <td style="width:0px;height:9px;"></td>
                <td></td>
                <td></td>
                <td></td>
                <td></td>
                <td></td>
                <td></td>
                <td></td>
                <td></td>
                <td></td>
                <td></td>
                <td></td>
                <td></td>
                <td></td>
                <td></td>
                <td></td>
            </tr>
            <tr style="vertical-align:top;">
                <td style="width:0px;height:1px;"></td>
                <td></td>
                <td class="csFBB219FE" colspan="8" rowspan="2" style="width:682px;height:23px;line-height:21px;text-align:left;vertical-align:middle;"><nobr>'.$nomEse.'</nobr></td>
                <td></td>
                <td></td>
                <td></td>
                <td></td>
                <td></td>
                <td></td>
            </tr>
            <tr style="vertical-align:top;">
                <td style="width:0px;height:22px;"></td>
                <td></td>
                <td></td>
                <td></td>
                <td class="cs101A94F7" colspan="3" rowspan="7" style="width:175px;height:144px;text-align:left;vertical-align:top;"><div style="overflow:hidden;width:175px;height:144px;">
                    <!--[if lt IE 7]><img alt="" src="'.$pic2.'" style="width:175px;height:144px;filter:progid:DXImageTransform.Microsoft.AlphaImageLoader(src="",sizingMethod="");" /><div style="display:none"><![endif]--><img alt="" src="'.$pic2.'" style="width:175px;height:144px;" /><!--[if lt IE 7]></div><![endif]--></div>
                </td>
                <td></td>
            </tr>
            <tr style="vertical-align:top;">
                <td style="width:0px;height:22px;"></td>
                <td></td>
                <td class="csCE72709D" colspan="8" style="width:682px;height:22px;line-height:15px;text-align:left;vertical-align:middle;"><nobr>'.$busnessName.'</nobr></td>
                <td></td>
                <td></td>
                <td></td>
            </tr>
            <tr style="vertical-align:top;">
                <td style="width:0px;height:22px;"></td>
                <td></td>
                <td class="csCE72709D" colspan="8" style="width:682px;height:22px;line-height:15px;text-align:left;vertical-align:middle;"><nobr>RCCM'.$rccEse.'.&nbsp;ID-NAT.'.$idNatEse.'</nobr></td>
                <td></td>
                <td></td>
                <td></td>
            </tr>
            <tr style="vertical-align:top;">
                <td style="width:0px;height:22px;"></td>
                <td></td>
                <td class="csFFC1C457" colspan="8" style="width:682px;height:22px;line-height:13px;text-align:left;vertical-align:middle;">'.$adresseEse.'</td>
                <td></td>
                <td></td>
                <td></td>
            </tr>
            <tr style="vertical-align:top;">
                <td style="width:0px;height:22px;"></td>
                <td></td>
                <td class="csFFC1C457" colspan="8" style="width:682px;height:22px;line-height:13px;text-align:left;vertical-align:middle;"><nobr>Email&nbsp;:&nbsp;'.$emailEse.'</nobr></td>
                <td></td>
                <td></td>
                <td></td>
            </tr>
            <tr style="vertical-align:top;">
                <td style="width:0px;height:22px;"></td>
                <td></td>
                <td class="csFFC1C457" colspan="8" style="width:682px;height:22px;line-height:13px;text-align:left;vertical-align:middle;"><nobr>Site&nbsp;web&nbsp;:&nbsp;'.$siteEse.'</nobr></td>
                <td></td>
                <td></td>
                <td></td>
            </tr>
            <tr style="vertical-align:top;">
                <td style="width:0px;height:12px;"></td>
                <td></td>
                <td class="cs612ED82F" colspan="8" rowspan="2" style="width:682px;height:23px;line-height:13px;text-align:left;vertical-align:middle;"><nobr>T&#233;l&#233;phone&nbsp;:&nbsp;'.$Tel1Ese.'&nbsp;&nbsp;24h/24</nobr></td>
                <td></td>
                <td></td>
                <td></td>
            </tr>
            <tr style="vertical-align:top;">
                <td style="width:0px;height:11px;"></td>
                <td></td>
                <td></td>
                <td></td>
                <td></td>
                <td></td>
                <td></td>
                <td></td>
            </tr>
            <tr style="vertical-align:top;">
                <td style="width:0px;height:8px;"></td>
                <td></td>
                <td></td>
                <td></td>
                <td></td>
                <td></td>
                <td></td>
                <td></td>
                <td></td>
                <td></td>
                <td></td>
                <td></td>
                <td></td>
                <td></td>
                <td></td>
                <td></td>
            </tr>
            <tr style="vertical-align:top;">
                <td style="width:0px;height:32px;"></td>
                <td></td>
                <td></td>
                <td></td>
                <td class="csB6F858D0" colspan="9" style="width:625px;height:32px;line-height:28px;text-align:center;vertical-align:middle;"><nobr>RAPPORT&nbsp;JOURNALIER&nbsp;DES&nbsp;COMMANDES FSS.</nobr></td>
                <td></td>
                <td></td>
                <td></td>
            </tr>
            <tr style="vertical-align:top;">
                <td style="width:0px;height:19px;"></td>
                <td></td>
                <td></td>
                <td></td>
                <td></td>
                <td></td>
                <td></td>
                <td></td>
                <td></td>
                <td></td>
                <td></td>
                <td></td>
                <td></td>
                <td></td>
                <td></td>
                <td></td>
            </tr>
            <tr style="vertical-align:top;">
                <td style="width:0px;height:23px;"></td>
                <td></td>
                <td class="cs56F73198" colspan="4" style="width:329px;height:21px;line-height:18px;text-align:left;vertical-align:top;"><nobr>&nbsp;PERIODE&nbsp;:&nbsp;&nbsp;Du&nbsp;&nbsp;'.$date1.'&nbsp;&nbsp;au&nbsp;'.$date2.'</nobr></td>
                <td></td>
                <td></td>
                <td></td>
                <td></td>
                <td></td>
                <td></td>
                <td></td>
                <td></td>
                <td></td>
                <td></td>
            </tr>
            <tr style="vertical-align:top;">
                <td style="width:0px;height:9px;"></td>
                <td></td>
                <td></td>
                <td></td>
                <td></td>
                <td></td>
                <td></td>
                <td></td>
                <td></td>
                <td></td>
                <td></td>
                <td></td>
                <td></td>
                <td></td>
                <td></td>
                <td></td>
            </tr>
            <tr style="vertical-align:top;">
                <td style="width:0px;height:24px;"></td>
                <td></td>
                <td class="cs9FE9304F" style="width:101px;height:22px;line-height:15px;text-align:center;vertical-align:middle;"><nobr>N&#176;&nbsp;COM.</nobr></td>
                <td class="cs9FE9304F" colspan="3" style="width:230px;height:22px;line-height:15px;text-align:center;vertical-align:middle;"><nobr>FOURNISSEUR</nobr></td>
                <td class="cs9FE9304F" colspan="2" style="width:107px;height:22px;line-height:15px;text-align:center;vertical-align:middle;"><nobr>DATE&nbsp;COM.</nobr></td>
                <td class="cs9FE9304F" style="width:178px;height:22px;line-height:15px;text-align:center;vertical-align:middle;"><nobr>ARTICLE</nobr></td>
                <td class="cs9FE9304F" colspan="2" style="width:91px;height:22px;line-height:15px;text-align:center;vertical-align:middle;"><nobr>Qte</nobr></td>
                <td class="cs9FE9304F" colspan="3" style="width:64px;height:22px;line-height:15px;text-align:center;vertical-align:middle;"><nobr>PU(USD)</nobr></td>
                <td class="csEAC52FCD" colspan="2" style="width:122px;height:22px;line-height:15px;text-align:center;vertical-align:middle;"><nobr>PT(USD)</nobr></td>
            </tr>
            ';

            $output .= $this->showDetailRequisition($date1,$date2); 

            $output.='
            <tr style="vertical-align:top;">
                <td style="width:0px;height:24px;"></td>
                <td></td>
                <td></td>
                <td></td>
                <td></td>
                <td></td>
                <td></td>
                <td></td>
                <td></td>
                <td class="cs49AA1D99" colspan="5" style="width:155px;height:22px;line-height:15px;text-align:center;vertical-align:middle;"><nobr>TOTAL&nbsp;($)&nbsp;:</nobr></td>
                <td class="csEAC52FCD" colspan="2" style="width:122px;height:22px;line-height:15px;text-align:center;vertical-align:middle;">'.$totalFact.' $</td>
            </tr>
            <tr style="vertical-align:top;">
                <td style="width:0px;height:10px;"></td>
                <td></td>
                <td></td>
                <td></td>
                <td></td>
                <td></td>
                <td></td>
                <td></td>
                <td></td>
                <td></td>
                <td></td>
                <td></td>
                <td></td>
                <td></td>
                <td></td>
                <td></td>
            </tr>
            <tr style="vertical-align:top;">
                <td style="width:0px;height:22px;"></td>
                <td></td>
                <td class="cs12FE94AA" colspan="3" style="width:207px;height:22px;line-height:16px;text-align:left;vertical-align:top;"><nobr>Fait&nbsp;&#224;&nbsp;Goma&nbsp;le&nbsp;&nbsp;'.date('Y-m-d').'</nobr></td>
                <td></td>
                <td></td>
                <td></td>
                <td></td>
                <td></td>
                <td></td>
                <td></td>
                <td></td>
                <td></td>
                <td></td>
                <td></td>
            </tr>
        </table>
        </body>
        </html>';  
       
        return $output; 

}
function showDetailRequisition($date1, $date2)
{
    $data = DB::table('tvente_detail_requisition')
    ->join('tfin_ssouscompte as compteachat','compteachat.id','=','tvente_detail_requisition.compte_achat')
    ->join('tfin_ssouscompte as compteproduit','compteproduit.id','=','tvente_detail_requisition.compte_produit')
    ->join('tvente_produit','tvente_produit.id','=','tvente_detail_requisition.refProduit')
    ->join('tvente_categorie_produit','tvente_categorie_produit.id','=','tvente_produit.refCategorie')
    ->join('tvente_entete_requisition','tvente_entete_requisition.id','=','tvente_detail_requisition.refEnteteCmd')
    ->join('tvente_fournisseur','tvente_fournisseur.id','=','tvente_entete_requisition.refFournisseur')
    ->select('tvente_detail_requisition.id','refEnteteCmd','refProduit','tvente_detail_requisition.compte_achat',
    'tvente_detail_requisition.compte_produit','puCmd','qteCmd','uniteCmd','tvente_detail_requisition.puBase',
    'tvente_detail_requisition.qteBase','tvente_detail_requisition.uniteBase','tvente_detail_requisition.devise',
    'tvente_detail_requisition.taux','montanttva','montantreduction','tvente_detail_requisition.active',
    'tvente_detail_requisition.author','tvente_detail_requisition.refUser','tvente_detail_requisition.created_at'
    ,"tvente_produit.designation as designation",'refCategorie','pu','qte',
    'cmup','Oldcode','Newcode','tvaapplique','estvendable',"tvente_categorie_produit.designation as Categorie"
    ,'compteachat.refSousCompte as refSousCompteAchat','compteachat.nom_ssouscompte as nom_ssouscompteAchat',
    'compteachat.numero_ssouscompte as numero_ssouscompteAchat'
    ,'compteproduit.refSousCompte as refSousCompteProduit','compteproduit.nom_ssouscompte as nom_ssouscompteProduit',
    'compteproduit.numero_ssouscompte as numero_ssouscompteProduit','noms','contact','mail','adresse','dateCmd')
    ->selectRaw('(qteCmd*puCmd) as PTCmd')
    ->selectRaw('(qteBase*puBase) as PTBase')
    ->selectRaw('((qteCmd*puCmd)/tvente_detail_requisition.taux) as PTCmdFC')
    ->selectRaw('((qteBase*puBase)/tvente_detail_requisition.taux) as PTBaseFC')
    ->selectRaw('CONCAT("BE",YEAR(dateCmd),"",MONTH(dateCmd),"00",refEnteteCmd) as codeFacture')
    ->where([
        ['dateCmd','>=', $date1],
        ['dateCmd','<=', $date2]
    ])
    ->orderBy("tvente_detail_requisition.created_at", "asc")
    ->get();

    $output='';

    foreach ($data as $row) 
    { 
        $output .='<tr style="vertical-align:top;">
        <td style="width:0px;height:24px;"></td>
        <td></td>
        <td class="cs6E02D7D2" style="width:101px;height:22px;line-height:15px;text-align:center;vertical-align:middle;">'.$row->codeFacture.'</td>
        <td class="cs6E02D7D2" colspan="3" style="width:230px;height:22px;line-height:15px;text-align:left;vertical-align:middle;">'.$row->noms.'</td>
        <td class="cs6E02D7D2" colspan="2" style="width:107px;height:22px;line-height:15px;text-align:center;vertical-align:middle;">'.$row->dateCmd.'</td>
        <td class="cs6E02D7D2" style="width:178px;height:22px;line-height:15px;text-align:left;vertical-align:middle;">'.$row->designation.'</td>
        <td class="cs6E02D7D2" colspan="2" style="width:91px;height:22px;line-height:15px;text-align:center;vertical-align:middle;">'.$row->qteCmd.'</td>
        <td class="cs6E02D7D2" colspan="3" style="width:64px;height:22px;line-height:15px;text-align:center;vertical-align:middle;">'.$row->puCmd.'$</td>
        <td class="cs6C28398D" colspan="2" style="width:122px;height:22px;line-height:15px;text-align:center;vertical-align:middle;">'.$row->PTCmd.'$</td>
    </tr>';      
   
    }

    return $output;

}

//=================================================================================================================================
//==================== FICHE DE STOCK ========================================================================================================

function pdf_fiche_stock_vente(Request $request)
{

    if ($request->get('date1') && $request->get('date2')) {
        // code...
        $date1 = $request->get('date1');
        $date2 = $request->get('date2');
        
        
        $html = $this->getInfoFicheStock($date1,$date2);
        $pdf = \App::make('dompdf.wrapper');

        $pdf->loadHTML($html);
        $pdf->loadHTML($html)->setPaper('a4', 'landscape');
        return $pdf->stream();
        
    }
    else{
    }    
}
function getInfoFicheStock($date1,$date2)
{
           //Info Entreprise
           $nomEse='';
           $adresseEse='';
           $Tel1Ese='';
           $Tel2Ese='';
           $siteEse='';
           $emailEse='';
           $idNatEse='';
           $numImpotEse='';
           $rccEse='';
           $siege='';
           $busnessName='';
           $pic='';
           $pic2 = $this->displayImg("fichier", 'logo.png');
           $logo='';
   
           $data1 = DB::table('entreprises')
           ->join('secteurs','secteurs.id','=','entreprises.idsecteur')
           ->join('forme_juridiques','forme_juridiques.id','=','entreprises.idforme')
   
           ->join('pays','pays.id','=','entreprises.idPays')
           ->join('provinces','provinces.id','=','entreprises.idProvince')
           ->join('users','users.id','=','entreprises.ceo')        
           ->select('entreprises.id as id','entreprises.id as idEntreprise',
           'entreprises.ceo','entreprises.nomEntreprise','entreprises.descriptionEntreprise',
           'entreprises.emailEntreprise','entreprises.adresseEntreprise',
           'entreprises.telephoneEntreprise','entreprises.solutionEntreprise','entreprises.idsecteur',
           'entreprises.idforme','entreprises.etat',
           'entreprises.idPays','entreprises.idProvince','entreprises.edition','entreprises.facebook',
           'entreprises.linkedin','entreprises.twitter','entreprises.siteweb','entreprises.rccm',
           'entreprises.invPersonnel','entreprises.invHub','entreprises.invRecherche',
           'entreprises.chiffreAffaire','entreprises.nbremploye','entreprises.slug','entreprises.logo',
            //forme
            'forme_juridiques.nomForme','secteurs.nomSecteur',
            //users
            'users.name','users.email','users.avatar','users.telephone','users.adresse',
            //
            'provinces.nomProvince','pays.nomPays', 'entreprises.created_at')
           ->get();
           $output='';
           foreach ($data1 as $row1) 
           {                                
               $nomEse=$row1->nomEntreprise;
               $adresseEse=$row1->adresseEntreprise;
               $Tel1Ese=$row1->telephoneEntreprise;
               $Tel2Ese=$row1->telephone;
               $siteEse=$row1->siteweb;
               $emailEse=$row1->emailEntreprise;
               $idNatEse=$row1->rccm;
               $numImpotEse=$row1->rccm;
               $busnessName=$row1->nomSecteur;
               $rccmEse=$row1->rccm;
               $pic = $this->displayImg("fichier", 'logo.png');
               $siege=$row1->nomForme;         
           }
           $totalVente=0;  
           $uniteVente=0;
           //
           $data2 = DB::table('tvente_detail_transfert')  
           ->join('tvente_entete_transfert','tvente_entete_transfert.id','=','tvente_detail_transfert.refEnteteTransfert')     
           ->join('tvente_services as servicesOrigine','servicesOrigine.id','=','tvente_entete_transfert.refService')
           ->join('tvente_services as servicesDestination','servicesDestination.id','=','tvente_entete_transfert.refService')
           ->join('tvente_produit','tvente_produit.id','=','tvente_detail_transfert.refProduit')
           ->join('tvente_categorie_produit','tvente_categorie_produit.id','=','tvente_produit.refCategorie')
           ->select(DB::raw('ROUND(SUM((qteTransfert * qteBase) * puBase),0) as TotalFacture'))
           ->where([
               ['tvente_entete_transfert.date_transfert','>=', $date1],
               ['tvente_entete_transfert.date_transfert','<=', $date2]
           ])               
           ->get();

           foreach ($data2 as $row2) 
           {                                
              $totalVente=$row2->TotalFacture;                           
           } 
           $totalVente =0;   
            $output=' 

            <!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Transitional//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd">
            <!-- saved from url=(0016)http://localhost -->
            <html>
            <head>
                <title>FicheStock</title>
                <meta HTTP-EQUIV="Content-Type" CONTENT="text/html; charset=utf-8"/>
                <style type="text/css">
                    .cs1B222893 {color:#000000;background-color:#D6E5F4;border-left:#004000 1px solid;border-top:#004000 1px solid;border-right:#004000 1px solid;border-bottom:#004000 1px solid;font-family:Times New Roman; font-size:27px; font-weight:bold; font-style:normal; padding-left:2px;padding-right:2px;}
                    .cs6F7E55AC {color:#000000;background-color:#D6E5F4;border-left-style: none;border-top:#004000 1px solid;border-right:#004000 1px solid;border-bottom:#004000 1px solid;font-family:Times New Roman; font-size:13px; font-weight:bold; font-style:normal; }
                    .csE0D816CD {color:#000000;background-color:#D6E5F4;border-left-style: none;border-top-style: none;border-right-style: none;border-bottom-style: none;font-family:Times New Roman; font-size:15px; font-weight:bold; font-style:normal; padding-left:2px;padding-right:2px;}
                    .cs8F59FFB2 {color:#000000;background-color:#F5F5F5;border-left:#004000 1px solid;border-top:#004000 1px solid;border-right:#004000 1px solid;border-bottom:#004000 1px solid;font-family:Times New Roman; font-size:13px; font-weight:bold; font-style:normal; }
                    .csF3AA49E4 {color:#000000;background-color:#F5F5F5;border-left-style: none;border-top:#004000 1px solid;border-right:#004000 1px solid;border-bottom:#004000 1px solid;font-family:Times New Roman; font-size:13px; font-weight:bold; font-style:normal; }
                    .csE78F4A6 {color:#000000;background-color:#F5F5F5;border-left-style: none;border-top:#004000 1px solid;border-right:#004000 1px solid;border-bottom:#004000 1px solid;font-family:Times New Roman; font-size:13px; font-weight:normal; font-style:normal; }
                    .cs4B928201 {color:#000000;background-color:#FFFFFF;border-left-style: none;border-top:#004000 1px solid;border-right:#004000 1px solid;border-bottom:#004000 1px solid;font-family:Times New Roman; font-size:13px; font-weight:bold; font-style:normal; }
                    .cs2C96DE68 {color:#000000;background-color:transparent;border-left:#000000 1px solid;border-top:#000000 1px solid;border-right:#000000 1px solid;border-bottom:#000000 1px solid;font-family:Times New Roman; font-size:13px; font-weight:normal; font-style:italic; padding-left:2px;}
                    .csE71035DC {color:#000000;background-color:transparent;border-left:#000000 1px solid;border-top:#000000 1px solid;border-right:#000000 1px solid;border-bottom:#000000 1px solid;font-family:Times New Roman; font-size:13px; font-weight:normal; font-style:normal; }
                    .csAB3AA82A {color:#000000;background-color:transparent;border-left-style: none;border-top:#000000 1px solid;border-right:#000000 1px solid;border-bottom:#000000 1px solid;font-family:Times New Roman; font-size:13px; font-weight:bold; font-style:normal; }
                    .csC73F4F41 {color:#000000;background-color:transparent;border-left-style: none;border-top:#004000 1px solid;border-right:#004000 1px solid;border-bottom:#004000 1px solid;font-family:Times New Roman; font-size:13px; font-weight:bold; font-style:normal; }
                    .csD149F8AB {color:#000000;background-color:transparent;border-left-style: none;border-top:#004000 1px solid;border-right:#004000 1px solid;border-bottom:#004000 1px solid;font-family:Times New Roman; font-size:13px; font-weight:normal; font-style:normal; }
                    .cs612ED82F {color:#000000;background-color:transparent;border-left-style: none;border-top-style: none;border-right-style: none;border-bottom-style: none;font-family:Times New Roman; font-size:12px; font-weight:bold; font-style:normal; padding-left:2px;}
                    .csFFC1C457 {color:#000000;background-color:transparent;border-left-style: none;border-top-style: none;border-right-style: none;border-bottom-style: none;font-family:Times New Roman; font-size:12px; font-weight:normal; font-style:normal; padding-left:2px;}
                    .cs101A94F7 {color:#000000;background-color:transparent;border-left-style: none;border-top-style: none;border-right-style: none;border-bottom-style: none;font-family:Times New Roman; font-size:13px; font-weight:normal; font-style:normal; }
                    .csCE72709D {color:#000000;background-color:transparent;border-left-style: none;border-top-style: none;border-right-style: none;border-bottom-style: none;font-family:Times New Roman; font-size:14px; font-weight:bold; font-style:normal; padding-left:2px;}
                    .csFBB219FE {color:#000000;background-color:transparent;border-left-style: none;border-top-style: none;border-right-style: none;border-bottom-style: none;font-family:Times New Roman; font-size:18px; font-weight:bold; font-style:normal; padding-left:2px;}
                    .cs739196BC {color:#5C5C5C;background-color:transparent;border-left-style: none;border-top-style: none;border-right-style: none;border-bottom-style: none;font-family:Segoe UI; font-size:11px; font-weight:normal; font-style:normal; }
                    .csF7D3565D {height:0px;width:0px;overflow:hidden;font-size:0px;line-height:0px;}
                </style>
            </head>
            <body leftMargin=10 topMargin=10 rightMargin=10 bottomMargin=10 style="background-color:#FFFFFF">
            <table cellpadding="0" cellspacing="0" border="0" style="border-width:0px;empty-cells:show;width:958px;height:352px;position:relative;">
                <tr>
                    <td style="width:0px;height:0px;"></td>
                    <td style="height:0px;width:6px;"></td>
                    <td style="height:0px;width:4px;"></td>
                    <td style="height:0px;width:163px;"></td>
                    <td style="height:0px;width:47px;"></td>
                    <td style="height:0px;width:59px;"></td>
                    <td style="height:0px;width:108px;"></td>
                    <td style="height:0px;width:22px;"></td>
                    <td style="height:0px;width:88px;"></td>
                    <td style="height:0px;width:77px;"></td>
                    <td style="height:0px;width:89px;"></td>
                    <td style="height:0px;width:21px;"></td>
                    <td style="height:0px;width:18px;"></td>
                    <td style="height:0px;width:86px;"></td>
                    <td style="height:0px;width:36px;"></td>
                    <td style="height:0px;width:132px;"></td>
                    <td style="height:0px;width:2px;"></td>
                </tr>
                <tr style="vertical-align:top;">
                    <td style="width:0px;height:23px;"></td>
                    <td></td>
                    <td></td>
                    <td></td>
                    <td></td>
                    <td></td>
                    <td></td>
                    <td></td>
                    <td></td>
                    <td></td>
                    <td></td>
                </tr>
                <tr style="vertical-align:top;">
                    <td style="width:0px;height:3px;"></td>
                    <td></td>
                    <td></td>
                    <td></td>
                    <td></td>
                    <td></td>
                    <td></td>
                    <td></td>
                    <td></td>
                    <td></td>
                    <td></td>
                    <td></td>
                    <td></td>
                    <td></td>
                    <td></td>
                    <td></td>
                    <td></td>
                </tr>
                <tr style="vertical-align:top;">
                    <td style="width:0px;height:10px;"></td>
                    <td></td>
                    <td></td>
                    <td class="csFBB219FE" colspan="10" rowspan="2" style="width:690px;height:23px;line-height:21px;text-align:left;vertical-align:middle;">'.$nomEse.'</td>
                    <td></td>
                    <td></td>
                    <td></td>
                    <td></td>
                </tr>
                <tr style="vertical-align:top;">
                    <td style="width:0px;height:13px;"></td>
                    <td></td>
                    <td></td>
                    <td></td>
                    <td class="cs101A94F7" colspan="2" rowspan="7" style="width:168px;height:144px;text-align:left;vertical-align:top;"><div style="overflow:hidden;width:168px;height:144px;">
                        <img alt="" src="'.$pic2.'" style="width:168px;height:144px;" /></div>
                    </td>
                    <td></td>
                </tr>
                <tr style="vertical-align:top;">
                    <td style="width:0px;height:22px;"></td>
                    <td></td>
                    <td></td>
                    <td class="csCE72709D" colspan="10" style="width:690px;height:22px;line-height:15px;text-align:left;vertical-align:middle;">'.$busnessName.'</td>
                    <td></td>
                    <td></td>
                </tr>
                <tr style="vertical-align:top;">
                    <td style="width:0px;height:22px;"></td>
                    <td></td>
                    <td></td>
                    <td class="csCE72709D" colspan="10" style="width:690px;height:22px;line-height:15px;text-align:left;vertical-align:middle;"><nobr>RCCM'.$rccEse.'.&nbsp;ID-NAT.'.$numImpotEse.'</nobr></td>
                    <td></td>
                    <td></td>
                </tr>
                <tr style="vertical-align:top;">
                    <td style="width:0px;height:22px;"></td>
                    <td></td>
                    <td></td>
                    <td class="csFFC1C457" colspan="10" style="width:690px;height:22px;line-height:13px;text-align:left;vertical-align:middle;">'.$adresseEse.'</td>
                    <td></td>
                    <td></td>
                </tr>
                <tr style="vertical-align:top;">
                    <td style="width:0px;height:22px;"></td>
                    <td></td>
                    <td></td>
                    <td class="csFFC1C457" colspan="10" style="width:690px;height:22px;line-height:13px;text-align:left;vertical-align:middle;"><nobr>Email&nbsp;:&nbsp;'.$emailEse.'</nobr></td>
                    <td></td>
                    <td></td>
                </tr>
                <tr style="vertical-align:top;">
                    <td style="width:0px;height:22px;"></td>
                    <td></td>
                    <td></td>
                    <td class="csFFC1C457" colspan="10" style="width:690px;height:22px;line-height:13px;text-align:left;vertical-align:middle;"><nobr>Site&nbsp;web&nbsp;:&nbsp;'.$siteEse.'</nobr></td>
                    <td></td>
                    <td></td>
                </tr>
                <tr style="vertical-align:top;">
                    <td style="width:0px;height:21px;"></td>
                    <td></td>
                    <td></td>
                    <td class="cs612ED82F" colspan="10" rowspan="2" style="width:690px;height:22px;line-height:13px;text-align:left;vertical-align:middle;"><nobr>T&#233;l&#233;phone&nbsp;:&nbsp;'.$Tel1Ese.'&nbsp;&nbsp;24h/24</nobr></td>
                    <td></td>
                    <td></td>
                </tr>
                <tr style="vertical-align:top;">
                    <td style="width:0px;height:1px;"></td>
                    <td></td>
                    <td></td>
                    <td></td>
                    <td></td>
                    <td></td>
                    <td></td>
                </tr>
                <tr style="vertical-align:top;">
                    <td style="width:0px;height:14px;"></td>
                    <td></td>
                    <td></td>
                    <td></td>
                    <td></td>
                    <td></td>
                    <td></td>
                    <td></td>
                    <td></td>
                    <td></td>
                    <td></td>
                    <td></td>
                    <td></td>
                    <td></td>
                    <td></td>
                    <td></td>
                    <td></td>
                </tr>
                <tr style="vertical-align:top;">
                    <td style="width:0px;height:34px;"></td>
                    <td></td>
                    <td></td>
                    <td></td>
                    <td></td>
                    <td class="cs1B222893" colspan="6" style="width:437px;height:32px;line-height:31px;text-align:center;vertical-align:middle;"><nobr>FICHE&nbsp;DE&nbsp;STOCK</nobr></td>
                    <td></td>
                    <td></td>
                    <td></td>
                    <td></td>
                    <td></td>
                    <td></td>
                </tr>
                <tr style="vertical-align:top;">
                    <td style="width:0px;height:7px;"></td>
                    <td></td>
                    <td></td>
                    <td></td>
                    <td></td>
                    <td></td>
                    <td></td>
                    <td></td>
                    <td></td>
                    <td></td>
                    <td></td>
                    <td></td>
                    <td></td>
                    <td></td>
                    <td></td>
                    <td></td>
                    <td></td>
                </tr>
                <tr style="vertical-align:top;">
                    <td style="width:0px;height:24px;"></td>
                    <td></td>
                    <td class="csE71035DC" colspan="10" style="width:676px;height:22px;line-height:15px;text-align:center;vertical-align:middle;"><nobr>TOTAL&nbsp;VENTE(USD)</nobr></td>
                    <td class="csAB3AA82A" colspan="5" style="width:273px;height:22px;line-height:15px;text-align:center;vertical-align:middle;"><nobr>'.$totalVente.'$</nobr></td>
                </tr>
                <tr style="vertical-align:top;">
                    <td style="width:0px;height:24px;"></td>
                    <td></td>
                    <td class="cs8F59FFB2" colspan="2" style="width:165px;height:22px;line-height:15px;text-align:center;vertical-align:middle;"><nobr>PRODUIT</nobr></td>
                    <td class="cs6F7E55AC" colspan="2" style="width:105px;height:22px;line-height:15px;text-align:center;vertical-align:middle;"><nobr>SI</nobr></td>
                    <td class="csF3AA49E4" style="width:107px;height:22px;line-height:15px;text-align:center;vertical-align:middle;"><nobr>ENTREE</nobr></td>
                    <td class="csC73F4F41" colspan="2" style="width:109px;height:22px;line-height:15px;text-align:center;vertical-align:middle;"><nobr>TOTAL</nobr></td>
                    <td class="cs4B928201" colspan="2" style="width:109px;height:22px;line-height:15px;text-align:center;vertical-align:middle;"><nobr>SORTIE</nobr></td>
                    <td class="csF3AA49E4" style="width:76px;height:22px;line-height:15px;text-align:center;vertical-align:middle;"><nobr>SF</nobr></td>                    
                    <td class="cs4B928201" colspan="3" style="width:139px;height:22px;line-height:15px;text-align:center;vertical-align:middle;"><nobr>PU(USD)</nobr></td>
                    <td class="cs6F7E55AC" colspan="2" style="width:133px;height:22px;line-height:15px;text-align:center;vertical-align:middle;"><nobr>PT(USD)</nobr></td>
                </tr>
                <tr style="vertical-align:top;">
                    <td style="width:0px;height:22px;"></td>
                    <td></td>
                    <td class="cs2C96DE68" colspan="15" style="width:948px;height:20px;line-height:15px;text-align:left;vertical-align:top;"><nobr>'.$date1.'</nobr></td>
                </tr>
                ';
                                                                
                   $output .= $this->showCategorieFicheStock($date1,$date2); 
                                                                
                 $output.='
            </table>
            </body>
            </html>

            '; 

    return $output;

} 
function showCategorieFicheStock($date1,$date2)
{
    $data = DB::table("tvente_categorie_produit")
    ->select("tvente_categorie_produit.id", "tvente_categorie_produit.designation", 
    "tvente_categorie_produit.created_at", "tvente_categorie_produit.author")
    ->orderBy("tvente_categorie_produit.designation", "asc")
    ->get();
    
    $output='';

    foreach ($data as $row) 
    {
        $output .='
                <tr style="vertical-align:top;">
                <td style="width:0px;height:22px;"></td>
                <td></td>
                <td class="csE0D816CD" colspan="15" style="width:948px;height:22px;line-height:17px;text-align:center;vertical-align:middle;">'.$row->designation.'</td>
            </tr>
            ';
                                                    
                $output .= $this->showDetailFicheStock($date1,$date2,$row->id);                                                     
                $output.='
        ';      
    }

    return $output;

}

function pdf_fiche_stock_vente_categorie(Request $request)
{

    if ($request->get('date1') && $request->get('date2')&& $request->get('idCategorie')) {
        // code...
        $date1 = $request->get('date1');
        $date2 = $request->get('date2');
        $idCategorie = $request->get('idCategorie');
        
        $html = $this->getInfoFicheStockCategorie($date1,$date2,$idCategorie);
        $pdf = \App::make('dompdf.wrapper');

        $pdf->loadHTML($html);
        $pdf->loadHTML($html)->setPaper('a4', 'landscape');
        return $pdf->stream();
        
    }
    else{
    }    
}
function getInfoFicheStockCategorie($date1,$date2,$idCategorie)
{
           //Info Entreprise
           $nomEse='';
           $adresseEse='';
           $Tel1Ese='';
           $Tel2Ese='';
           $siteEse='';
           $emailEse='';
           $idNatEse='';
           $numImpotEse='';
           $rccEse='';
           $siege='';
           $busnessName='';
           $pic='';
           $pic2 = $this->displayImg("fichier", 'logo.png');
           $logo='';
   
           $data1 = DB::table('entreprises')
           ->join('secteurs','secteurs.id','=','entreprises.idsecteur')
           ->join('forme_juridiques','forme_juridiques.id','=','entreprises.idforme')
   
           ->join('pays','pays.id','=','entreprises.idPays')
           ->join('provinces','provinces.id','=','entreprises.idProvince')
           ->join('users','users.id','=','entreprises.ceo')        
           ->select('entreprises.id as id','entreprises.id as idEntreprise',
           'entreprises.ceo','entreprises.nomEntreprise','entreprises.descriptionEntreprise',
           'entreprises.emailEntreprise','entreprises.adresseEntreprise',
           'entreprises.telephoneEntreprise','entreprises.solutionEntreprise','entreprises.idsecteur',
           'entreprises.idforme','entreprises.etat',
           'entreprises.idPays','entreprises.idProvince','entreprises.edition','entreprises.facebook',
           'entreprises.linkedin','entreprises.twitter','entreprises.siteweb','entreprises.rccm',
           'entreprises.invPersonnel','entreprises.invHub','entreprises.invRecherche',
           'entreprises.chiffreAffaire','entreprises.nbremploye','entreprises.slug','entreprises.logo',
            //forme
            'forme_juridiques.nomForme','secteurs.nomSecteur',
            //users
            'users.name','users.email','users.avatar','users.telephone','users.adresse',
            //
            'provinces.nomProvince','pays.nomPays', 'entreprises.created_at')
           ->get();
           $output='';
           foreach ($data1 as $row1) 
           {                                
               $nomEse=$row1->nomEntreprise;
               $adresseEse=$row1->adresseEntreprise;
               $Tel1Ese=$row1->telephoneEntreprise;
               $Tel2Ese=$row1->telephone;
               $siteEse=$row1->siteweb;
               $emailEse=$row1->emailEntreprise;
               $idNatEse=$row1->rccm;
               $numImpotEse=$row1->rccm;
               $busnessName=$row1->nomSecteur;
               $rccmEse=$row1->rccm;
               $pic = $this->displayImg("fichier", 'logo.png');
               $siege=$row1->nomForme;         
           }

           $totalVente=0;  
           $uniteVente=0;
           //
           $data2 = DB::table('tvente_detail_transfert')  
           ->join('tvente_entete_transfert','tvente_entete_transfert.id','=','tvente_detail_transfert.refEnteteTransfert')     
           ->join('tvente_services as servicesOrigine','servicesOrigine.id','=','tvente_entete_transfert.refService')
           ->join('tvente_services as servicesDestination','servicesDestination.id','=','tvente_entete_transfert.refService')
           ->join('tvente_produit','tvente_produit.id','=','tvente_detail_transfert.refProduit')
           ->join('tvente_categorie_produit','tvente_categorie_produit.id','=','tvente_produit.refCategorie')
           ->select(DB::raw('ROUND(SUM((qteTransfert * qteBase) * puBase),0) as TotalFacture'))
           ->where([
               ['tvente_entete_transfert.date_transfert','>=', $date1],
               ['tvente_entete_transfert.date_transfert','<=', $date2],
               ['tvente_categorie_produit.id','=', $idCategorie]
           ])               
           ->get();

           foreach ($data2 as $row2) 
           {                                
              $totalVente=$row2->TotalFacture;                           
           }

           $totalVente =0; 
    
            $output=' 

            <!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Transitional//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd">
            <!-- saved from url=(0016)http://localhost -->
            <html>
            <head>
                <title>FicheStock</title>
                <meta HTTP-EQUIV="Content-Type" CONTENT="text/html; charset=utf-8"/>
                <style type="text/css">
                    .cs1B222893 {color:#000000;background-color:#D6E5F4;border-left:#004000 1px solid;border-top:#004000 1px solid;border-right:#004000 1px solid;border-bottom:#004000 1px solid;font-family:Times New Roman; font-size:27px; font-weight:bold; font-style:normal; padding-left:2px;padding-right:2px;}
                    .cs6F7E55AC {color:#000000;background-color:#D6E5F4;border-left-style: none;border-top:#004000 1px solid;border-right:#004000 1px solid;border-bottom:#004000 1px solid;font-family:Times New Roman; font-size:13px; font-weight:bold; font-style:normal; }
                    .csE0D816CD {color:#000000;background-color:#D6E5F4;border-left-style: none;border-top-style: none;border-right-style: none;border-bottom-style: none;font-family:Times New Roman; font-size:15px; font-weight:bold; font-style:normal; padding-left:2px;padding-right:2px;}
                    .cs8F59FFB2 {color:#000000;background-color:#F5F5F5;border-left:#004000 1px solid;border-top:#004000 1px solid;border-right:#004000 1px solid;border-bottom:#004000 1px solid;font-family:Times New Roman; font-size:13px; font-weight:bold; font-style:normal; }
                    .csF3AA49E4 {color:#000000;background-color:#F5F5F5;border-left-style: none;border-top:#004000 1px solid;border-right:#004000 1px solid;border-bottom:#004000 1px solid;font-family:Times New Roman; font-size:13px; font-weight:bold; font-style:normal; }
                    .csE78F4A6 {color:#000000;background-color:#F5F5F5;border-left-style: none;border-top:#004000 1px solid;border-right:#004000 1px solid;border-bottom:#004000 1px solid;font-family:Times New Roman; font-size:13px; font-weight:normal; font-style:normal; }
                    .cs4B928201 {color:#000000;background-color:#FFFFFF;border-left-style: none;border-top:#004000 1px solid;border-right:#004000 1px solid;border-bottom:#004000 1px solid;font-family:Times New Roman; font-size:13px; font-weight:bold; font-style:normal; }
                    .cs2C96DE68 {color:#000000;background-color:transparent;border-left:#000000 1px solid;border-top:#000000 1px solid;border-right:#000000 1px solid;border-bottom:#000000 1px solid;font-family:Times New Roman; font-size:13px; font-weight:normal; font-style:italic; padding-left:2px;}
                    .csE71035DC {color:#000000;background-color:transparent;border-left:#000000 1px solid;border-top:#000000 1px solid;border-right:#000000 1px solid;border-bottom:#000000 1px solid;font-family:Times New Roman; font-size:13px; font-weight:normal; font-style:normal; }
                    .csAB3AA82A {color:#000000;background-color:transparent;border-left-style: none;border-top:#000000 1px solid;border-right:#000000 1px solid;border-bottom:#000000 1px solid;font-family:Times New Roman; font-size:13px; font-weight:bold; font-style:normal; }
                    .csC73F4F41 {color:#000000;background-color:transparent;border-left-style: none;border-top:#004000 1px solid;border-right:#004000 1px solid;border-bottom:#004000 1px solid;font-family:Times New Roman; font-size:13px; font-weight:bold; font-style:normal; }
                    .csD149F8AB {color:#000000;background-color:transparent;border-left-style: none;border-top:#004000 1px solid;border-right:#004000 1px solid;border-bottom:#004000 1px solid;font-family:Times New Roman; font-size:13px; font-weight:normal; font-style:normal; }
                    .cs612ED82F {color:#000000;background-color:transparent;border-left-style: none;border-top-style: none;border-right-style: none;border-bottom-style: none;font-family:Times New Roman; font-size:12px; font-weight:bold; font-style:normal; padding-left:2px;}
                    .csFFC1C457 {color:#000000;background-color:transparent;border-left-style: none;border-top-style: none;border-right-style: none;border-bottom-style: none;font-family:Times New Roman; font-size:12px; font-weight:normal; font-style:normal; padding-left:2px;}
                    .cs101A94F7 {color:#000000;background-color:transparent;border-left-style: none;border-top-style: none;border-right-style: none;border-bottom-style: none;font-family:Times New Roman; font-size:13px; font-weight:normal; font-style:normal; }
                    .csCE72709D {color:#000000;background-color:transparent;border-left-style: none;border-top-style: none;border-right-style: none;border-bottom-style: none;font-family:Times New Roman; font-size:14px; font-weight:bold; font-style:normal; padding-left:2px;}
                    .csFBB219FE {color:#000000;background-color:transparent;border-left-style: none;border-top-style: none;border-right-style: none;border-bottom-style: none;font-family:Times New Roman; font-size:18px; font-weight:bold; font-style:normal; padding-left:2px;}
                    .cs739196BC {color:#5C5C5C;background-color:transparent;border-left-style: none;border-top-style: none;border-right-style: none;border-bottom-style: none;font-family:Segoe UI; font-size:11px; font-weight:normal; font-style:normal; }
                    .csF7D3565D {height:0px;width:0px;overflow:hidden;font-size:0px;line-height:0px;}
                </style>
            </head>
            <body leftMargin=10 topMargin=10 rightMargin=10 bottomMargin=10 style="background-color:#FFFFFF">
            <table cellpadding="0" cellspacing="0" border="0" style="border-width:0px;empty-cells:show;width:958px;height:352px;position:relative;">
                <tr>
                    <td style="width:0px;height:0px;"></td>
                    <td style="height:0px;width:6px;"></td>
                    <td style="height:0px;width:4px;"></td>
                    <td style="height:0px;width:163px;"></td>
                    <td style="height:0px;width:47px;"></td>
                    <td style="height:0px;width:59px;"></td>
                    <td style="height:0px;width:108px;"></td>
                    <td style="height:0px;width:22px;"></td>
                    <td style="height:0px;width:88px;"></td>
                    <td style="height:0px;width:77px;"></td>
                    <td style="height:0px;width:89px;"></td>
                    <td style="height:0px;width:21px;"></td>
                    <td style="height:0px;width:18px;"></td>
                    <td style="height:0px;width:86px;"></td>
                    <td style="height:0px;width:36px;"></td>
                    <td style="height:0px;width:132px;"></td>
                    <td style="height:0px;width:2px;"></td>
                </tr>
                <tr style="vertical-align:top;">
                    <td style="width:0px;height:23px;"></td>
                    <td></td>
                    <td></td>
                    <td></td>
                    <td></td>
                    <td></td>
                    <td></td>
                    <td></td>
                    <td></td>
                    <td></td>
                    <td></td>
                </tr>
                <tr style="vertical-align:top;">
                    <td style="width:0px;height:3px;"></td>
                    <td></td>
                    <td></td>
                    <td></td>
                    <td></td>
                    <td></td>
                    <td></td>
                    <td></td>
                    <td></td>
                    <td></td>
                    <td></td>
                    <td></td>
                    <td></td>
                    <td></td>
                    <td></td>
                    <td></td>
                    <td></td>
                </tr>
                <tr style="vertical-align:top;">
                    <td style="width:0px;height:10px;"></td>
                    <td></td>
                    <td></td>
                    <td class="csFBB219FE" colspan="10" rowspan="2" style="width:690px;height:23px;line-height:21px;text-align:left;vertical-align:middle;">'.$nomEse.'</td>
                    <td></td>
                    <td></td>
                    <td></td>
                    <td></td>
                </tr>
                <tr style="vertical-align:top;">
                    <td style="width:0px;height:13px;"></td>
                    <td></td>
                    <td></td>
                    <td></td>
                    <td class="cs101A94F7" colspan="2" rowspan="7" style="width:168px;height:144px;text-align:left;vertical-align:top;"><div style="overflow:hidden;width:168px;height:144px;">
                        <img alt="" src="'.$pic2.'" style="width:168px;height:144px;" /></div>
                    </td>
                    <td></td>
                </tr>
                <tr style="vertical-align:top;">
                    <td style="width:0px;height:22px;"></td>
                    <td></td>
                    <td></td>
                    <td class="csCE72709D" colspan="10" style="width:690px;height:22px;line-height:15px;text-align:left;vertical-align:middle;">'.$busnessName.'</td>
                    <td></td>
                    <td></td>
                </tr>
                <tr style="vertical-align:top;">
                    <td style="width:0px;height:22px;"></td>
                    <td></td>
                    <td></td>
                    <td class="csCE72709D" colspan="10" style="width:690px;height:22px;line-height:15px;text-align:left;vertical-align:middle;"><nobr>RCCM'.$rccEse.'.&nbsp;ID-NAT.'.$numImpotEse.'</nobr></td>
                    <td></td>
                    <td></td>
                </tr>
                <tr style="vertical-align:top;">
                    <td style="width:0px;height:22px;"></td>
                    <td></td>
                    <td></td>
                    <td class="csFFC1C457" colspan="10" style="width:690px;height:22px;line-height:13px;text-align:left;vertical-align:middle;">'.$adresseEse.'</td>
                    <td></td>
                    <td></td>
                </tr>
                <tr style="vertical-align:top;">
                    <td style="width:0px;height:22px;"></td>
                    <td></td>
                    <td></td>
                    <td class="csFFC1C457" colspan="10" style="width:690px;height:22px;line-height:13px;text-align:left;vertical-align:middle;"><nobr>Email&nbsp;:&nbsp;'.$emailEse.'</nobr></td>
                    <td></td>
                    <td></td>
                </tr>
                <tr style="vertical-align:top;">
                    <td style="width:0px;height:22px;"></td>
                    <td></td>
                    <td></td>
                    <td class="csFFC1C457" colspan="10" style="width:690px;height:22px;line-height:13px;text-align:left;vertical-align:middle;"><nobr>Site&nbsp;web&nbsp;:&nbsp;'.$siteEse.'</nobr></td>
                    <td></td>
                    <td></td>
                </tr>
                <tr style="vertical-align:top;">
                    <td style="width:0px;height:21px;"></td>
                    <td></td>
                    <td></td>
                    <td class="cs612ED82F" colspan="10" rowspan="2" style="width:690px;height:22px;line-height:13px;text-align:left;vertical-align:middle;"><nobr>T&#233;l&#233;phone&nbsp;:&nbsp;'.$Tel1Ese.'&nbsp;&nbsp;24h/24</nobr></td>
                    <td></td>
                    <td></td>
                </tr>
                <tr style="vertical-align:top;">
                    <td style="width:0px;height:1px;"></td>
                    <td></td>
                    <td></td>
                    <td></td>
                    <td></td>
                    <td></td>
                    <td></td>
                </tr>
                <tr style="vertical-align:top;">
                    <td style="width:0px;height:14px;"></td>
                    <td></td>
                    <td></td>
                    <td></td>
                    <td></td>
                    <td></td>
                    <td></td>
                    <td></td>
                    <td></td>
                    <td></td>
                    <td></td>
                    <td></td>
                    <td></td>
                    <td></td>
                    <td></td>
                    <td></td>
                    <td></td>
                </tr>
                <tr style="vertical-align:top;">
                    <td style="width:0px;height:34px;"></td>
                    <td></td>
                    <td></td>
                    <td></td>
                    <td></td>
                    <td class="cs1B222893" colspan="6" style="width:437px;height:32px;line-height:31px;text-align:center;vertical-align:middle;"><nobr>FICHE&nbsp;DE&nbsp;STOCK</nobr></td>
                    <td></td>
                    <td></td>
                    <td></td>
                    <td></td>
                    <td></td>
                    <td></td>
                </tr>
                <tr style="vertical-align:top;">
                    <td style="width:0px;height:7px;"></td>
                    <td></td>
                    <td></td>
                    <td></td>
                    <td></td>
                    <td></td>
                    <td></td>
                    <td></td>
                    <td></td>
                    <td></td>
                    <td></td>
                    <td></td>
                    <td></td>
                    <td></td>
                    <td></td>
                    <td></td>
                    <td></td>
                </tr>
                <tr style="vertical-align:top;">
                    <td style="width:0px;height:24px;"></td>
                    <td></td>
                    <td class="csE71035DC" colspan="10" style="width:676px;height:22px;line-height:15px;text-align:center;vertical-align:middle;"><nobr>TOTAL&nbsp;VENTE(USD)</nobr></td>
                    <td class="csAB3AA82A" colspan="5" style="width:273px;height:22px;line-height:15px;text-align:center;vertical-align:middle;"><nobr>'.$totalVente.'$</nobr></td>
                </tr>
                <tr style="vertical-align:top;">
                    <td style="width:0px;height:24px;"></td>
                    <td></td>
                    <td class="cs8F59FFB2" colspan="2" style="width:165px;height:22px;line-height:15px;text-align:center;vertical-align:middle;"><nobr>PRODUIT</nobr></td>
                    <td class="cs6F7E55AC" colspan="2" style="width:105px;height:22px;line-height:15px;text-align:center;vertical-align:middle;"><nobr>SI</nobr></td>
                    <td class="csF3AA49E4" style="width:107px;height:22px;line-height:15px;text-align:center;vertical-align:middle;"><nobr>ENTREE</nobr></td>
                    <td class="csC73F4F41" colspan="2" style="width:109px;height:22px;line-height:15px;text-align:center;vertical-align:middle;"><nobr>TOTAL</nobr></td>
                    <td class="cs4B928201" colspan="2" style="width:109px;height:22px;line-height:15px;text-align:center;vertical-align:middle;"><nobr>SORTIE</nobr></td>
                    <td class="csF3AA49E4" style="width:76px;height:22px;line-height:15px;text-align:center;vertical-align:middle;"><nobr>SF</nobr></td>                    
                    <td class="cs4B928201" colspan="3" style="width:139px;height:22px;line-height:15px;text-align:center;vertical-align:middle;"><nobr>PU(USD)</nobr></td>
                    <td class="cs6F7E55AC" colspan="2" style="width:133px;height:22px;line-height:15px;text-align:center;vertical-align:middle;"><nobr>PT(USD)</nobr></td>
                </tr>
                <tr style="vertical-align:top;">
                    <td style="width:0px;height:22px;"></td>
                    <td></td>
                    <td class="cs2C96DE68" colspan="15" style="width:948px;height:20px;line-height:15px;text-align:left;vertical-align:top;"><nobr>'.$date1.'</nobr></td>
                </tr>
                ';
                                                                
                   $output .= $this->showCategorieFicheStockCategorie($date1,$date2,$idCategorie); 
                                                                
                 $output.='
            </table>
            </body>
            </html>

            '; 

    return $output;

}
function showCategorieFicheStockCategorie($date1,$date2,$idCategorie)
{
    $data = DB::table("tvente_categorie_produit")
    ->select("tvente_categorie_produit.id", "tvente_categorie_produit.designation", 
    "tvente_categorie_produit.created_at", "tvente_categorie_produit.author")
    ->where([
        ['tvente_categorie_produit.id','=', $idCategorie]
    ])
    ->orderBy("tvente_categorie_produit.designation", "asc")
    ->get();
    
    $output='';

    foreach ($data as $row) 
    {
        $output .='
                <tr style="vertical-align:top;">
                <td style="width:0px;height:22px;"></td>
                <td></td>
                <td class="csE0D816CD" colspan="15" style="width:948px;height:22px;line-height:17px;text-align:center;vertical-align:middle;">'.$row->designation.'</td>
            </tr>
            ';
                                                    
                $output .= $this->showDetailFicheStock($date1,$date2,$row->id);                                                     
                $output.='
        ';      
    }

    return $output;

}


function showDetailFicheStock($date1,$date2,$refCategorie)
{
    $data1 = DB::table('tvente_produit')
    ->join('tvente_categorie_produit','tvente_categorie_produit.id','=','tvente_produit.refCategorie')        
    ->select("tvente_produit.id","tvente_produit.designation as designation","refCategorie",
    "pu","uniteBase","tvente_categorie_produit.designation as Categorie","devise","qte","uniteBase")
    ->where([
        ['tvente_produit.refCategorie','=', $refCategorie]
    ])
    ->orderBy("tvente_produit.designation", "asc")
    ->get();

    $output='';

    foreach ($data1 as $row1) 
    {
        $totalSI=0;        
        $totalEntree=0;
        $totalG=0;
        $totalSortie=0;        
        $totalSF=0;
        $totalPT=0;
        $totalPU=0; 
        $totalVente=0;
        $totalApprov=0;
        $totalTransfert=0;
        $totalSortieMag=0;
        $puVente=0;  
        //
        $data2 = DB::table('tvente_detail_entree')
        ->join('tvente_produit','tvente_produit.id','=','tvente_detail_entree.refProduit')
        ->join('tvente_categorie_produit','tvente_categorie_produit.id','=','tvente_produit.refCategorie')
        ->join('tvente_entete_entree','tvente_entete_entree.id','=','tvente_detail_entree.refEnteteEntree')
        ->join('tvente_fournisseur','tvente_fournisseur.id','=','tvente_entete_entree.refFournisseur')

        ->select(DB::raw('IFNULL(ROUND(SUM(qteBase*qteEntree),0),0) as totalEntree'))
        ->where([               
            ['tvente_entete_entree.dateEntree','<', $date1],
            ['tvente_produit.id','=', $row1->id]
        ])               
        ->get();
        foreach ($data2 as $row2) 
        {                                
           $totalEntree=$row2->totalEntree;                           
        }

        $data3 = DB::table('tvente_detail_transfert')  
        ->join('tvente_entete_transfert','tvente_entete_transfert.id','=','tvente_detail_transfert.refEnteteTransfert')     
        ->join('tvente_services as servicesOrigine','servicesOrigine.id','=','tvente_entete_transfert.refService')
        ->join('tvente_services as servicesDestination','servicesDestination.id','=','tvente_entete_transfert.refService')
        ->join('tvente_produit','tvente_produit.id','=','tvente_detail_transfert.refProduit')
        ->join('tvente_categorie_produit','tvente_categorie_produit.id','=','tvente_produit.refCategorie')
        ->select(DB::raw('IFNULL(ROUND(SUM(qteBase*qteTransfert),0),0) as totalSortie'))
        ->where([               
            ['tvente_entete_transfert.date_transfert','<', $date1],
            ['tvente_produit.id','=', $row1->id]
        ])->get(); 
        
        foreach ($data3 as $row3) 
        {                                
           $totalSortie=$row3->totalSortie;                           
        }            
       

        $data4 =   DB::select(
            'select (IFNULL(ROUND(:quanteEntree,0),0) - IFNULL(ROUND(:quanteSortie,0),0)) as SI from tvente_produit  
             where (tvente_produit.id = :idPro)',
             ['idPro' => $row1->id,'quanteEntree' => $totalEntree,'quanteSortie'=>$totalSortie]
        );         
         foreach ($data4 as $row4) 
         {                                
            $totalSI=$row4->SI;                           
         }


        $data6 = DB::table('tvente_detail_entree')
        ->join('tvente_produit','tvente_produit.id','=','tvente_detail_entree.refProduit')
        ->join('tvente_categorie_produit','tvente_categorie_produit.id','=','tvente_produit.refCategorie')
        ->join('tvente_entete_entree','tvente_entete_entree.id','=','tvente_detail_entree.refEnteteEntree')
        ->join('tvente_fournisseur','tvente_fournisseur.id','=','tvente_entete_entree.refFournisseur')

        ->select(DB::raw('IFNULL(ROUND(SUM(qteBase*qteEntree),0),0) as totalEntree'))
        ->where([
            ['tvente_entete_entree.dateEntree','>=', $date1],
            ['tvente_entete_entree.dateEntree','<=', $date2],
            ['tvente_produit.id','=', $row1->id]
        ])
        ->get();        
        foreach ($data6 as $row6) 
        {                                
           $totalApprov=$row6->totalEntree;                           
        }


        $data66 = DB::table('tvente_detail_transfert')  
        ->join('tvente_entete_transfert','tvente_entete_transfert.id','=','tvente_detail_transfert.refEnteteTransfert')     
        ->join('tvente_services as servicesOrigine','servicesOrigine.id','=','tvente_entete_transfert.refService')
        ->join('tvente_services as servicesDestination','servicesDestination.id','=','tvente_entete_transfert.refService')
        ->join('tvente_produit','tvente_produit.id','=','tvente_detail_transfert.refProduit')
        ->join('tvente_categorie_produit','tvente_categorie_produit.id','=','tvente_produit.refCategorie')

        ->select(DB::raw('IFNULL(ROUND(SUM(qteBase*qteTransfert),0),0) as totalTransfert'))
        ->where([
            ['tvente_entete_transfert.date_transfert','>=', $date1],
            ['tvente_entete_transfert.date_transfert','<=', $date2],
            ['tvente_produit.id','=', $row1->id]
        ])
        ->get();        
        foreach ($data66 as $row6) 
        {                                
           $totalTransfert=$row6->totalTransfert;                           
        }

        $data7 =   DB::select(
            'select (IFNULL(ROUND(:SI,0),0) + IFNULL(ROUND(:quanteEntree,0),0)) as totalG from tvente_produit  
             where (tvente_produit.id = :idPro)',
             ['idPro' => $row1->id,'SI' => $totalSI,'quanteEntree'=>$totalApprov]
        );         
        foreach ($data7 as $row7) 
        {                                
           $totalG=$row7->totalG;                           
        }

        $data8 =   DB::select(
            'select (IFNULL(ROUND(:SI,0),0) + IFNULL(ROUND(:quanteEntree,0),0) - IFNULL(ROUND(:quanteSortie,0),0)) as SF from tvente_produit  
             where (tvente_produit.id = :idPro)',
             ['idPro' => $row1->id,'SI' => $totalSI,'quanteEntree'=>$totalApprov,'quanteSortie'=>$totalTransfert]
        );         
        foreach ($data8 as $row8) 
        {                                
           $totalSF=$row8->SF;                           
        }
 
        // $data9 = DB::table('tvente_detail_transfert')  
        // ->join('tvente_entete_transfert','tvente_entete_transfert.id','=','tvente_detail_transfert.refEnteteTransfert')     
        // ->join('tvente_services as servicesOrigine','servicesOrigine.id','=','tvente_entete_transfert.refService')
        // ->join('tvente_services as servicesDestination','servicesDestination.id','=','tvente_entete_transfert.refService')
        // ->join('tvente_produit','tvente_produit.id','=','tvente_detail_transfert.refProduit')
        // ->join('tvente_categorie_produit','tvente_categorie_produit.id','=','tvente_produit.refCategorie')        
        // ->select(DB::raw('IFNULL(ROUND(SUM((qteBase * qteTransfert) * puBase),0),0) as PTVente'))
        // ->where([               
        //     ['tvente_entete_transfert.date_transfert','>=', $date1],
        //     ['tvente_entete_transfert.date_transfert','<=', $date2],
        //     ['tvente_produit.id','=', $row1->id]
        // ])->get(); 
        
        // foreach ($data9 as $row9) 
        // {                                
        //    $totalPT=$row9->PTVente;                           
        // }       
        
        $data10 =   DB::select(
            'select cmup as PU from tvente_produit  
             where tvente_produit.id = :idPro',
             ['idPro' => $row1->id]
        );         
        foreach ($data10 as $row10) 
        { 
           $puVente=$row10->PU;                         
        }

        $totalPT = floatval($puVente) * floatval($totalSF);

        $output .='
                <tr style="vertical-align:top;">
                <td style="width:0px;height:24px;"></td>
                <td></td>
                <td class="cs8F59FFB2" colspan="2" style="width:165px;height:22px;line-height:15px;text-align:center;vertical-align:middle;">'.$row1->designation.'</td>
                <td class="cs6F7E55AC" colspan="2" style="width:105px;height:22px;line-height:15px;text-align:center;vertical-align:middle;">'.round($totalSI,2).' '.$row1->uniteBase.'</td>
                <td class="csE78F4A6" style="width:107px;height:22px;line-height:15px;text-align:center;vertical-align:middle;">'.round($totalApprov,2).' '.$row1->uniteBase.' </td>
                <td class="csD149F8AB" colspan="2" style="width:109px;height:22px;line-height:15px;text-align:center;vertical-align:middle;">'.round($totalG,2).' '.$row1->uniteBase.'</td>
                <td class="cs4B928201" colspan="2" style="width:109px;height:22px;line-height:15px;text-align:center;vertical-align:middle;">'.round($totalTransfert,2).' '.$row1->uniteBase.'</td>
                <td class="csE78F4A6" style="width:76px;height:22px;line-height:15px;text-align:center;vertical-align:middle;">'.round($totalSF,2).' '.$row1->uniteBase.'</td>                
                <td class="cs4B928201" colspan="3" style="width:139px;height:22px;line-height:15px;text-align:center;vertical-align:middle;">'.round($puVente,2).'$</td>
                <td class="cs6F7E55AC" colspan="2" style="width:133px;height:22px;line-height:15px;text-align:center;vertical-align:middle;">'.round($totalPT,2).'$</td>
            </tr>
        ';     
    }

    return $output;

}

//=============== FICHE DE STOCK DES SERVICES BY CATEGORIE=======================================================================================

function pdf_fiche_stock_vente_service_bycategorie(Request $request)
{

    if ($request->get('date1') && $request->get('date2') && $request->get('idCategorie') && $request->get('idService')) {
        // code...
        $date1 = $request->get('date1');
        $date2 = $request->get('date2');
        $idCategorie = $request->get('idCategorie');
        $idService = $request->get('idService');
        
        //$html = $this->getInfoFicheStockServicesByCategorie($date1,$date2,$idCategorie,$idService);
        // $pdf = \App::make('dompdf.wrapper');

        // $pdf->loadHTML($html);
        // $pdf->loadHTML($html)->setPaper('a4', 'landscape');
        // return $pdf->stream();


        $html ='<html><head><meta http-equiv="Content-Type" content="text/html; charset=utf-8"/>';
        $html .= $this->getInfoFicheStockServicesByCategorie($date1,$date2,$idCategorie,$idService);       
        $html .='<script>window.print()</script>';

        echo($html); 
        
    }
    else{
    }    
}
function getInfoFicheStockServicesByCategorie($date1,$date2,$idCategorie,$idService)
{
           //Info Entreprise
           $nomEse='';
           $adresseEse='';
           $Tel1Ese='';
           $Tel2Ese='';
           $siteEse='';
           $emailEse='';
           $idNatEse='';
           $numImpotEse='';
           $rccEse='';
           $siege='';
           $busnessName='';
           $pic='';
           $pic2 = $this->displayImg("fichier", 'logo.png');
           $logo='';
   
           $data1 = DB::table('entreprises')
           ->join('secteurs','secteurs.id','=','entreprises.idsecteur')
           ->join('forme_juridiques','forme_juridiques.id','=','entreprises.idforme')
   
           ->join('pays','pays.id','=','entreprises.idPays')
           ->join('provinces','provinces.id','=','entreprises.idProvince')
           ->join('users','users.id','=','entreprises.ceo')        
           ->select('entreprises.id as id','entreprises.id as idEntreprise',
           'entreprises.ceo','entreprises.nomEntreprise','entreprises.descriptionEntreprise',
           'entreprises.emailEntreprise','entreprises.adresseEntreprise',
           'entreprises.telephoneEntreprise','entreprises.solutionEntreprise','entreprises.idsecteur',
           'entreprises.idforme','entreprises.etat',
           'entreprises.idPays','entreprises.idProvince','entreprises.edition','entreprises.facebook',
           'entreprises.linkedin','entreprises.twitter','entreprises.siteweb','entreprises.rccm',
           'entreprises.invPersonnel','entreprises.invHub','entreprises.invRecherche',
           'entreprises.chiffreAffaire','entreprises.nbremploye','entreprises.slug','entreprises.logo',
            //forme
            'forme_juridiques.nomForme','secteurs.nomSecteur',
            //users
            'users.name','users.email','users.avatar','users.telephone','users.adresse',
            //
            'provinces.nomProvince','pays.nomPays', 'entreprises.created_at')
           ->get();
           $output='';
           foreach ($data1 as $row1) 
           {                                
               $nomEse=$row1->nomEntreprise;
               $adresseEse=$row1->adresseEntreprise;
               $Tel1Ese=$row1->telephoneEntreprise;
               $Tel2Ese=$row1->telephone;
               $siteEse=$row1->siteweb;
               $emailEse=$row1->emailEntreprise;
               $idNatEse=$row1->rccm;
               $numImpotEse=$row1->rccm;
               $busnessName=$row1->nomSecteur;
               $rccmEse=$row1->rccm;
               $pic = $this->displayImg("fichier", 'logo.png');
               $siege=$row1->nomForme;         
           }


           $totalVente = 0;
           $totalTransfert=0;
           $totalCMUP = 0;
           $globalTP=0;

           $data5 = DB::table('tvente_detail_vente')
           ->join('tvente_stock_service','tvente_stock_service.id','=','tvente_detail_vente.idStockService')
           ->join('tvente_produit','tvente_produit.id','=','tvente_stock_service.refProduit')
           ->join('tvente_categorie_produit','tvente_categorie_produit.id','=','tvente_produit.refCategorie')
           ->join('tvente_entete_vente','tvente_entete_vente.id','=','tvente_detail_vente.refEnteteVente')
           ->select(DB::raw('IFNULL(ROUND(SUM(qteVente*puVente),0),0) as totalSortie'))
           ->where([               
               ['tvente_entete_vente.dateVente','>=', $date1],
               ['tvente_entete_vente.dateVente','<=', $date2],
               ['tvente_categorie_produit.id','=', $idCategorie],
               ['tvente_stock_service.refService','=', $idService]
           ])->get(); 
           
           foreach ($data5 as $row5) 
           {                                
              $totalVente=$row5->totalSortie;                           
           }


           $CategorieClient=''; 

           $data3=DB::table('tvente_services')
           ->select('id','nom_service','status','active')
           ->where([
              ['tvente_services.id','=', $idService]
          ])      
          ->get();      
          $output='';
          foreach ($data3 as $row) 
          {
              $CategorieClient=$row->nom_service;              
          }
  
   
            $output=' 

            <!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Transitional//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd">
            <!-- saved from url=(0016)http://localhost -->
            <html>
            <head>
                <title>FicheStock</title>
                <meta HTTP-EQUIV="Content-Type" CONTENT="text/html; charset=utf-8"/>
                <style type="text/css">
                    .cs1B222893 {color:#000000;background-color:#D6E5F4;border-left:#004000 1px solid;border-top:#004000 1px solid;border-right:#004000 1px solid;border-bottom:#004000 1px solid;font-family:Times New Roman; font-size:27px; font-weight:bold; font-style:normal; padding-left:2px;padding-right:2px;}
                    .cs6F7E55AC {color:#000000;background-color:#D6E5F4;border-left-style: none;border-top:#004000 1px solid;border-right:#004000 1px solid;border-bottom:#004000 1px solid;font-family:Times New Roman; font-size:13px; font-weight:bold; font-style:normal; }
                    .csE0D816CD {color:#000000;background-color:#D6E5F4;border-left-style: none;border-top-style: none;border-right-style: none;border-bottom-style: none;font-family:Times New Roman; font-size:15px; font-weight:bold; font-style:normal; padding-left:2px;padding-right:2px;}
                    .cs8F59FFB2 {color:#000000;background-color:#F5F5F5;border-left:#004000 1px solid;border-top:#004000 1px solid;border-right:#004000 1px solid;border-bottom:#004000 1px solid;font-family:Times New Roman; font-size:13px; font-weight:bold; font-style:normal; }
                    .csF3AA49E4 {color:#000000;background-color:#F5F5F5;border-left-style: none;border-top:#004000 1px solid;border-right:#004000 1px solid;border-bottom:#004000 1px solid;font-family:Times New Roman; font-size:13px; font-weight:bold; font-style:normal; }
                    .csE78F4A6 {color:#000000;background-color:#F5F5F5;border-left-style: none;border-top:#004000 1px solid;border-right:#004000 1px solid;border-bottom:#004000 1px solid;font-family:Times New Roman; font-size:13px; font-weight:normal; font-style:normal; }
                    .cs4B928201 {color:#000000;background-color:#FFFFFF;border-left-style: none;border-top:#004000 1px solid;border-right:#004000 1px solid;border-bottom:#004000 1px solid;font-family:Times New Roman; font-size:13px; font-weight:bold; font-style:normal; }
                    .cs2C96DE68 {color:#000000;background-color:transparent;border-left:#000000 1px solid;border-top:#000000 1px solid;border-right:#000000 1px solid;border-bottom:#000000 1px solid;font-family:Times New Roman; font-size:13px; font-weight:normal; font-style:italic; padding-left:2px;}
                    .csE71035DC {color:#000000;background-color:transparent;border-left:#000000 1px solid;border-top:#000000 1px solid;border-right:#000000 1px solid;border-bottom:#000000 1px solid;font-family:Times New Roman; font-size:13px; font-weight:normal; font-style:normal; }
                    .csAB3AA82A {color:#000000;background-color:transparent;border-left-style: none;border-top:#000000 1px solid;border-right:#000000 1px solid;border-bottom:#000000 1px solid;font-family:Times New Roman; font-size:13px; font-weight:bold; font-style:normal; }
                    .csC73F4F41 {color:#000000;background-color:transparent;border-left-style: none;border-top:#004000 1px solid;border-right:#004000 1px solid;border-bottom:#004000 1px solid;font-family:Times New Roman; font-size:13px; font-weight:bold; font-style:normal; }
                    .csD149F8AB {color:#000000;background-color:transparent;border-left-style: none;border-top:#004000 1px solid;border-right:#004000 1px solid;border-bottom:#004000 1px solid;font-family:Times New Roman; font-size:13px; font-weight:normal; font-style:normal; }
                    .cs612ED82F {color:#000000;background-color:transparent;border-left-style: none;border-top-style: none;border-right-style: none;border-bottom-style: none;font-family:Times New Roman; font-size:12px; font-weight:bold; font-style:normal; padding-left:2px;}
                    .csFFC1C457 {color:#000000;background-color:transparent;border-left-style: none;border-top-style: none;border-right-style: none;border-bottom-style: none;font-family:Times New Roman; font-size:12px; font-weight:normal; font-style:normal; padding-left:2px;}
                    .cs101A94F7 {color:#000000;background-color:transparent;border-left-style: none;border-top-style: none;border-right-style: none;border-bottom-style: none;font-family:Times New Roman; font-size:13px; font-weight:normal; font-style:normal; }
                    .csCE72709D {color:#000000;background-color:transparent;border-left-style: none;border-top-style: none;border-right-style: none;border-bottom-style: none;font-family:Times New Roman; font-size:14px; font-weight:bold; font-style:normal; padding-left:2px;}
                    .csFBB219FE {color:#000000;background-color:transparent;border-left-style: none;border-top-style: none;border-right-style: none;border-bottom-style: none;font-family:Times New Roman; font-size:18px; font-weight:bold; font-style:normal; padding-left:2px;}
                    .cs739196BC {color:#5C5C5C;background-color:transparent;border-left-style: none;border-top-style: none;border-right-style: none;border-bottom-style: none;font-family:Segoe UI; font-size:11px; font-weight:normal; font-style:normal; }
                    .csF7D3565D {height:0px;width:0px;overflow:hidden;font-size:0px;line-height:0px;}
                </style>
            </head>
            <body leftMargin=10 topMargin=10 rightMargin=10 bottomMargin=10 style="background-color:#FFFFFF">
            <table cellpadding="0" cellspacing="0" border="0" style="border-width:0px;empty-cells:show;width:958px;height:352px;position:relative;">
                <tr>
                    <td style="width:0px;height:0px;"></td>
                    <td style="height:0px;width:6px;"></td>
                    <td style="height:0px;width:4px;"></td>
                    <td style="height:0px;width:163px;"></td>
                    <td style="height:0px;width:47px;"></td>
                    <td style="height:0px;width:59px;"></td>
                    <td style="height:0px;width:108px;"></td>
                    <td style="height:0px;width:22px;"></td>
                    <td style="height:0px;width:88px;"></td>
                    <td style="height:0px;width:77px;"></td>
                    <td style="height:0px;width:89px;"></td>
                    <td style="height:0px;width:21px;"></td>
                    <td style="height:0px;width:18px;"></td>
                    <td style="height:0px;width:86px;"></td>
                    <td style="height:0px;width:36px;"></td>
                    <td style="height:0px;width:132px;"></td>
                    <td style="height:0px;width:2px;"></td>
                </tr>
                <tr style="vertical-align:top;">
                    <td style="width:0px;height:23px;"></td>
                    <td></td>
                    <td></td>
                    <td></td>
                    <td></td>
                    <td></td>
                    <td></td>
                    <td></td>
                    <td></td>
                    <td></td>
                    <td></td>
                </tr>
                <tr style="vertical-align:top;">
                    <td style="width:0px;height:3px;"></td>
                    <td></td>
                    <td></td>
                    <td></td>
                    <td></td>
                    <td></td>
                    <td></td>
                    <td></td>
                    <td></td>
                    <td></td>
                    <td></td>
                    <td></td>
                    <td></td>
                    <td></td>
                    <td></td>
                    <td></td>
                    <td></td>
                </tr>
                <tr style="vertical-align:top;">
                    <td style="width:0px;height:10px;"></td>
                    <td></td>
                    <td></td>
                    <td class="csFBB219FE" colspan="10" rowspan="2" style="width:690px;height:23px;line-height:21px;text-align:left;vertical-align:middle;">'.$nomEse.'</td>
                    <td></td>
                    <td></td>
                    <td></td>
                    <td></td>
                </tr>
                <tr style="vertical-align:top;">
                    <td style="width:0px;height:13px;"></td>
                    <td></td>
                    <td></td>
                    <td></td>
                    <td class="cs101A94F7" colspan="2" rowspan="7" style="width:168px;height:144px;text-align:left;vertical-align:top;"><div style="overflow:hidden;width:168px;height:144px;">
                        <img alt="" src="'.$pic2.'" style="width:168px;height:144px;" /></div>
                    </td>
                    <td></td>
                </tr>
                <tr style="vertical-align:top;">
                    <td style="width:0px;height:22px;"></td>
                    <td></td>
                    <td></td>
                    <td class="csCE72709D" colspan="10" style="width:690px;height:22px;line-height:15px;text-align:left;vertical-align:middle;">'.$busnessName.'</td>
                    <td></td>
                    <td></td>
                </tr>
                <tr style="vertical-align:top;">
                    <td style="width:0px;height:22px;"></td>
                    <td></td>
                    <td></td>
                    <td class="csCE72709D" colspan="10" style="width:690px;height:22px;line-height:15px;text-align:left;vertical-align:middle;"><nobr>RCCM'.$rccEse.'.&nbsp;ID-NAT.'.$numImpotEse.'</nobr></td>
                    <td></td>
                    <td></td>
                </tr>
                <tr style="vertical-align:top;">
                    <td style="width:0px;height:22px;"></td>
                    <td></td>
                    <td></td>
                    <td class="csFFC1C457" colspan="10" style="width:690px;height:22px;line-height:13px;text-align:left;vertical-align:middle;">'.$adresseEse.'</td>
                    <td></td>
                    <td></td>
                </tr>
                <tr style="vertical-align:top;">
                    <td style="width:0px;height:22px;"></td>
                    <td></td>
                    <td></td>
                    <td class="csFFC1C457" colspan="10" style="width:690px;height:22px;line-height:13px;text-align:left;vertical-align:middle;"><nobr>Email&nbsp;:&nbsp;'.$emailEse.'</nobr></td>
                    <td></td>
                    <td></td>
                </tr>
                <tr style="vertical-align:top;">
                    <td style="width:0px;height:22px;"></td>
                    <td></td>
                    <td></td>
                    <td class="csFFC1C457" colspan="10" style="width:690px;height:22px;line-height:13px;text-align:left;vertical-align:middle;"><nobr>Site&nbsp;web&nbsp;:&nbsp;'.$siteEse.'</nobr></td>
                    <td></td>
                    <td></td>
                </tr>
                <tr style="vertical-align:top;">
                    <td style="width:0px;height:21px;"></td>
                    <td></td>
                    <td></td>
                    <td class="cs612ED82F" colspan="10" rowspan="2" style="width:690px;height:22px;line-height:13px;text-align:left;vertical-align:middle;"><nobr>T&#233;l&#233;phone&nbsp;:&nbsp;'.$Tel1Ese.'&nbsp;&nbsp;24h/24</nobr></td>
                    <td></td>
                    <td></td>
                </tr>
                <tr style="vertical-align:top;">
                    <td style="width:0px;height:1px;"></td>
                    <td></td>
                    <td></td>
                    <td></td>
                    <td></td>
                    <td></td>
                    <td></td>
                </tr>
                <tr style="vertical-align:top;">
                    <td style="width:0px;height:14px;"></td>
                    <td></td>
                    <td></td>
                    <td></td>
                    <td></td>
                    <td></td>
                    <td></td>
                    <td></td>
                    <td></td>
                    <td></td>
                    <td></td>
                    <td></td>
                    <td></td>
                    <td></td>
                    <td></td>
                    <td></td>
                    <td></td>
                </tr>
                <tr style="vertical-align:top;">
                    <td style="width:0px;height:34px;"></td>
                    <td></td>
                    <td></td>
                    <td></td>
                    <td></td>
                    <td class="cs1B222893" colspan="6" style="width:437px;height:32px;line-height:31px;text-align:center;vertical-align:middle;"><nobr>FICHE&nbsp;DE&nbsp;STOCK : '.$CategorieClient.'</nobr></td>
                    <td></td>
                    <td></td>
                    <td></td>
                    <td></td>
                    <td></td>
                    <td></td>
                </tr>
                <tr style="vertical-align:top;">
                    <td style="width:0px;height:7px;"></td>
                    <td></td>
                    <td></td>
                    <td></td>
                    <td></td>
                    <td></td>
                    <td></td>
                    <td></td>
                    <td></td>
                    <td></td>
                    <td></td>
                    <td></td>
                    <td></td>
                    <td></td>
                    <td></td>
                    <td></td>
                    <td></td>
                </tr>
                <tr style="vertical-align:top;">
                    <td style="width:0px;height:24px;"></td>
                    <td></td>
                    <td class="csE71035DC" colspan="10" style="width:676px;height:22px;line-height:15px;text-align:center;vertical-align:middle;"><nobr>TOTAL&nbsp;VENTE(USD)</nobr></td>
                    <td class="csAB3AA82A" colspan="5" style="width:273px;height:22px;line-height:15px;text-align:center;vertical-align:middle;"><nobr>'.$totalVente.'$</nobr></td>
                </tr>
                <tr style="vertical-align:top;">
                    <td style="width:0px;height:24px;"></td>
                    <td></td>
                    <td class="cs8F59FFB2" colspan="2" style="width:165px;height:22px;line-height:15px;text-align:center;vertical-align:middle;"><nobr>PRODUIT</nobr></td>
                    <td class="cs6F7E55AC" colspan="2" style="width:105px;height:22px;line-height:15px;text-align:center;vertical-align:middle;"><nobr>SI</nobr></td>
                    <td class="csF3AA49E4" style="width:107px;height:22px;line-height:15px;text-align:center;vertical-align:middle;"><nobr>ENTREE</nobr></td>
                    <td class="csC73F4F41" colspan="2" style="width:109px;height:22px;line-height:15px;text-align:center;vertical-align:middle;"><nobr>TOTAL</nobr></td>
                    <td class="cs4B928201" colspan="2" style="width:109px;height:22px;line-height:15px;text-align:center;vertical-align:middle;"><nobr>SORTIE</nobr></td>
                    <td class="csF3AA49E4" style="width:76px;height:22px;line-height:15px;text-align:center;vertical-align:middle;"><nobr>SF</nobr></td>                    
                    <td class="cs4B928201" colspan="3" style="width:139px;height:22px;line-height:15px;text-align:center;vertical-align:middle;"><nobr>PU(USD)</nobr></td>
                    <td class="cs6F7E55AC" colspan="2" style="width:133px;height:22px;line-height:15px;text-align:center;vertical-align:middle;"><nobr>PT(USD)</nobr></td>
                </tr>
                <tr style="vertical-align:top;">
                    <td style="width:0px;height:22px;"></td>
                    <td></td>
                    <td class="cs2C96DE68" colspan="15" style="width:948px;height:20px;line-height:15px;text-align:left;vertical-align:top;"><nobr>'.$date1.'</nobr></td>
                </tr>
                ';
                                                                
                   $output .= $this->showCategorieFicheStockServiceByCategorie($date1,$date2,$idCategorie,$idService); 
                                                                
                 $output.='
            </table>
            </body>
            </html>

            '; 

    return $output;

} 
function showCategorieFicheStockServiceByCategorie($date1,$date2,$idCategorie,$idService)
{
    $data = DB::table("tvente_categorie_produit")
    ->select("tvente_categorie_produit.id", "tvente_categorie_produit.designation", 
    "tvente_categorie_produit.created_at", "tvente_categorie_produit.author")
    ->where([
        ['tvente_categorie_produit.id','=', $idCategorie]
    ])
    ->orderBy("tvente_categorie_produit.designation", "asc")
    ->get();
    
    $output='';

    foreach ($data as $row) 
    {
        $output .='
                <tr style="vertical-align:top;">
                <td style="width:0px;height:22px;"></td>
                <td></td>
                <td class="csE0D816CD" colspan="15" style="width:948px;height:22px;line-height:17px;text-align:center;vertical-align:middle;">'.$row->designation.'</td>
            </tr>
            ';
                                                    
                $output .= $this->showDetailFicheStockServiceByCat($date1,$date2,$row->id,$idService);                                                     
                $output.='
        ';      
    }

    return $output;

}

function showDetailFicheStockServiceByCat($date1, $date2, $refCategorie, $idService)
{
    // Récupérer les données de stock, mouvements et ventes en une seule requête 
    $data11 = DB::table('tvente_stock_service')
    ->join('tvente_services', 'tvente_services.id', '=', 'tvente_stock_service.refService')
    ->Join('tvente_produit', 'tvente_produit.id', '=', 'tvente_stock_service.refProduit')
    ->Join('tvente_categorie_produit', 'tvente_categorie_produit.id', '=', 'tvente_produit.refCategorie')

    ->leftJoin('tvente_mouvement_stock as dtEntree', function ($join) use ($date1, $idService) {
        $join->on('dtEntree.idStockService', '=', 'tvente_stock_service.id')        
             ->where('dtEntree.type_mouvement', '=', 'Entree')
             ->where('dtEntree.dateMvt', '<', $date1);
    })

        // Utilisez distinct() avant select()
        ->distinct()
        ->select(
            "tvente_stock_service.id",
            'tvente_stock_service.refService',
            'tvente_stock_service.refProduit',
            "tvente_produit.designation as designation",
            "refCategorie",
            "tvente_stock_service.pu",
            "tvente_categorie_produit.designation as Categorie",
            "tvente_stock_service.qte",
            "tvente_stock_service.uniteBase",
            "tvente_stock_service.cmup","tvente_stock_service.devise","tvente_stock_service.taux",            
            DB::raw('IFNULL(ROUND(SUM(dtEntree.qteBase * dtEntree.qteMvt), 3), 0) as totalEntree'),

        )
        ->where([
            ['tvente_produit.refCategorie', '=', $refCategorie],
            ['tvente_stock_service.refService', '=', $idService]
        ])
        ->groupBy("tvente_stock_service.id", "tvente_stock_service.refService", "tvente_stock_service.refProduit", 
        "designation", "refCategorie", "pu", "Categorie", "qte", "uniteBase","cmup",
        "tvente_stock_service.devise","tvente_stock_service.taux")
        ->orderBy("tvente_produit.designation", "asc")
        ->get();



    $data22 = DB::table('tvente_stock_service')
    ->join('tvente_services', 'tvente_services.id', '=', 'tvente_stock_service.refService')
    ->Join('tvente_produit', 'tvente_produit.id', '=', 'tvente_stock_service.refProduit')
    ->Join('tvente_categorie_produit', 'tvente_categorie_produit.id', '=', 'tvente_produit.refCategorie')

    ->leftJoin('tvente_mouvement_stock as dtSortie', function ($join) use ($date1, $idService) {
        $join->on('dtSortie.idStockService', '=', 'tvente_stock_service.id')        
             ->where('dtSortie.type_mouvement', '=', 'Sortie')
             ->where('dtSortie.dateMvt', '<', $date1);
    })
    // Utilisez distinct() avant select()
    ->distinct()
    ->select(
        "tvente_stock_service.id",
        'tvente_stock_service.refService',
        'tvente_stock_service.refProduit',
        "tvente_produit.designation as designation",
        "refCategorie",
        "tvente_stock_service.pu",
        "tvente_categorie_produit.designation as Categorie",
        "tvente_stock_service.qte",
        "tvente_stock_service.uniteBase",
        "tvente_stock_service.cmup",
        DB::raw('IFNULL(ROUND(SUM(dtSortie.qteBase * dtSortie.qteMvt), 3), 0) as totalSortie')
    )
    ->where([
        ['tvente_produit.refCategorie', '=', $refCategorie],
        ['tvente_stock_service.refService', '=', $idService]
    ])
    ->groupBy("tvente_stock_service.id", "tvente_stock_service.refService", "tvente_stock_service.refProduit", "designation", "refCategorie", "pu", "Categorie", "qte", "uniteBase","cmup")
    ->orderBy("tvente_produit.designation", "asc")
    ->get();

    // ============ LEs Mouvements =========================================================================

        // Récupérer les données de stock, mouvements et ventes en une seule requête 
        $data1 = DB::table('tvente_stock_service')
        ->join('tvente_services', 'tvente_services.id', '=', 'tvente_stock_service.refService')
        ->Join('tvente_produit', 'tvente_produit.id', '=', 'tvente_stock_service.refProduit')
        ->Join('tvente_categorie_produit', 'tvente_categorie_produit.id', '=', 'tvente_produit.refCategorie')
    
        ->leftJoin('tvente_mouvement_stock as mvtEntree', function ($join) use ($date1, $date2, $idService) {
            $join->on('mvtEntree.idStockService', '=', 'tvente_stock_service.id')        
                 ->where('mvtEntree.type_mouvement', '=', 'Entree')
                 ->whereBetween('mvtEntree.dateMvt', [$date1, $date2]);;
        })
    
            // Utilisez distinct() avant select()
            ->distinct()
            ->select(
                "tvente_stock_service.id",
                'tvente_stock_service.refService',
                'tvente_stock_service.refProduit',
                "tvente_produit.designation as designation",
                "refCategorie",
                "tvente_stock_service.pu",
                "tvente_categorie_produit.designation as Categorie",
                "tvente_stock_service.qte",
                "tvente_stock_service.uniteBase",
                "tvente_stock_service.cmup","tvente_stock_service.devise","tvente_stock_service.taux",            
                DB::raw('IFNULL(ROUND(SUM(mvtEntree.qteBase * mvtEntree.qteMvt), 3), 0) as stockEntree'),
    
            )
            ->where([
                ['tvente_produit.refCategorie', '=', $refCategorie],
                ['tvente_stock_service.refService', '=', $idService]
            ])
            ->groupBy("tvente_stock_service.id", "tvente_stock_service.refService", "tvente_stock_service.refProduit", 
            "designation", "refCategorie", "pu", "Categorie", "qte", "uniteBase","cmup",
            "tvente_stock_service.devise","tvente_stock_service.taux")
            ->orderBy("tvente_produit.designation", "asc")
            ->get();
    
    //======================================================================
    
        // Récupérer les données de stock, mouvements et ventes en une seule requête 
        $data2 = DB::table('tvente_stock_service')
        ->join('tvente_services', 'tvente_services.id', '=', 'tvente_stock_service.refService')
        ->Join('tvente_produit', 'tvente_produit.id', '=', 'tvente_stock_service.refProduit')
        ->Join('tvente_categorie_produit', 'tvente_categorie_produit.id', '=', 'tvente_produit.refCategorie')
    
        ->leftJoin('tvente_mouvement_stock as mvtSortie', function ($join) use ($date1, $date2, $idService) {
            $join->on('mvtSortie.idStockService', '=', 'tvente_stock_service.id')        
                 ->where('mvtSortie.type_mouvement', '=', 'Sortie')
                 ->whereBetween('mvtSortie.dateMvt', [$date1, $date2]);;
        })
    
            // Utilisez distinct() avant select()
            ->distinct()
            ->select(
                "tvente_stock_service.id",
                'tvente_stock_service.refService',
                'tvente_stock_service.refProduit',
                "tvente_produit.designation as designation",
                "refCategorie",
                "tvente_stock_service.pu",
                "tvente_categorie_produit.designation as Categorie",
                "tvente_stock_service.qte",
                "tvente_stock_service.uniteBase",
                "tvente_stock_service.cmup","tvente_stock_service.devise","tvente_stock_service.taux",            
                DB::raw('IFNULL(ROUND(SUM(mvtSortie.qteBase * mvtSortie.qteMvt), 3), 0) as stockSortie'),
    
            )
            ->where([
                ['tvente_produit.refCategorie', '=', $refCategorie],
                ['tvente_stock_service.refService', '=', $idService]
            ])
            ->groupBy("tvente_stock_service.id", "tvente_stock_service.refService", "tvente_stock_service.refProduit", 
            "designation", "refCategorie", "pu", "Categorie", "qte", "uniteBase","cmup",
            "tvente_stock_service.devise","tvente_stock_service.taux")
            ->orderBy("tvente_produit.designation", "asc")
            ->get();
    

    // Construction de l'output
    
    $output = '';

    // Vérifiez que les deux tableaux ont la même longueur
    if ((count($data1) === count($data2)) && (count($data1) === count($data11)) 
    && (count($data1) === count($data22)))
    {
        for ($i = 0; $i < count($data1); $i++) {
            $row11 = $data11[$i];
            $row22 = $data22[$i];
            $row1 = $data1[$i];
            $row2 = $data2[$i];            

            $totalSortie = floatval($row22->totalSortie);
            $totalEntree = floatval($row11->totalEntree);

            $stockSortie = floatval($row2->stockSortie);            
            $stockEntree = floatval($row1->stockEntree);

            $totalSI = ((floatval($totalEntree)) - (floatval($totalSortie)));
            $totalGEntree = floatval($stockEntree);
            $totalG = floatval($totalSI) + floatval($stockEntree);
            $TGSortie = floatval($stockSortie);
            $totalSF = floatval($totalG) - floatval($stockSortie);
            $totalPT = floatval($totalSF) * floatval($row2->cmup);


            $output .= '
                <tr style="vertical-align:top;">
                    <td style="width:0px;height:24px;"></td>
                    <td></td>
                    <td class="cs8F59FFB2" colspan="2" style="width:165px;height:22px;line-height:15px;text-align:center;vertical-align:middle;">'.$row1->designation.'</td>
                    <td class="cs6F7E55AC" colspan="2" style="width:105px;height:22px;line-height:15px;text-align:center;vertical-align:middle;">'.$totalSI.' '.$row1->uniteBase.'</td>
                    <td class="csE78F4A6" style="width:107px;height:22px;line-height:15px;text-align:center;vertical-align:middle;">'.$totalGEntree.' '.$row1->uniteBase.' </td>
                    <td class="csD149F8AB" colspan="2" style="width:109px;height:22px;line-height:15px;text-align:center;vertical-align:middle;">'.$totalG.' '.$row1->uniteBase.'</td>
                    <td class="cs4B928201" colspan="2" style="width:109px;height:22px;line-height:15px;text-align:center;vertical-align:middle;">'.$TGSortie.' '.$row1->uniteBase.'</td>
                    <td class="csE78F4A6" style="width:76px;height:22px;line-height:15px;text-align:center;vertical-align:middle;">'.$totalSF.' '.$row1->uniteBase.'</td>                
                    <td class="cs4B928201" colspan="3" style="width:139px;height:22px;line-height:15px;text-align:center;vertical-align:middle;">'.round($row2->cmup, 2).'$</td>
                    <td class="cs6F7E55AC" colspan="2" style="width:133px;height:22px;line-height:15px;text-align:center;vertical-align:middle;">'.round($totalPT, 2).'$</td>
                </tr>
            ';   

    }
    } else {
        // Gérer le cas où les tableaux n'ont pas la même longueur
        echo 'Les tableaux ont pas la même longueur.';
    }

    return $output;
}







//=============== FICHE DE STOCK DES SERVICES BY CATEGORIE=======================================================================================

function pdf_fiche_stock_vente_service(Request $request)
{

    if ($request->get('date1') && $request->get('date2') && $request->get('idService')) {
        // code...
        $date1 = $request->get('date1');
        $date2 = $request->get('date2');
        $idService = $request->get('idService');
        
        // $html = $this->getInfoFicheStockServices($date1,$date2,$idService);
        // $pdf = \App::make('dompdf.wrapper');

        // $pdf->loadHTML($html);
        // $pdf->loadHTML($html)->setPaper('a4', 'landscape');
        // return $pdf->stream();


        $html ='<html><head><meta http-equiv="Content-Type" content="text/html; charset=utf-8"/>';
        $html .= $this->getInfoFicheStockServices($date1,$date2,$idService);       
        $html .='<script>window.print()</script>';

        echo($html); 
        
    }
    else{
    }    
}

function getInfoFicheStockServices($date1,$date2,$idService)
{
           //Info Entreprise
           $nomEse='';
           $adresseEse='';
           $Tel1Ese='';
           $Tel2Ese='';
           $siteEse='';
           $emailEse='';
           $idNatEse='';
           $numImpotEse='';
           $rccEse='';
           $siege='';
           $busnessName='';
           $pic='';
           $pic2 = $this->displayImg("fichier", 'logo.png');
           $logo='';
   
           $data1 = DB::table('entreprises')
           ->join('secteurs','secteurs.id','=','entreprises.idsecteur')
           ->join('forme_juridiques','forme_juridiques.id','=','entreprises.idforme')
   
           ->join('pays','pays.id','=','entreprises.idPays')
           ->join('provinces','provinces.id','=','entreprises.idProvince')
           ->join('users','users.id','=','entreprises.ceo')        
           ->select('entreprises.id as id','entreprises.id as idEntreprise',
           'entreprises.ceo','entreprises.nomEntreprise','entreprises.descriptionEntreprise',
           'entreprises.emailEntreprise','entreprises.adresseEntreprise',
           'entreprises.telephoneEntreprise','entreprises.solutionEntreprise','entreprises.idsecteur',
           'entreprises.idforme','entreprises.etat',
           'entreprises.idPays','entreprises.idProvince','entreprises.edition','entreprises.facebook',
           'entreprises.linkedin','entreprises.twitter','entreprises.siteweb','entreprises.rccm',
           'entreprises.invPersonnel','entreprises.invHub','entreprises.invRecherche',
           'entreprises.chiffreAffaire','entreprises.nbremploye','entreprises.slug','entreprises.logo',
            //forme
            'forme_juridiques.nomForme','secteurs.nomSecteur',
            //users
            'users.name','users.email','users.avatar','users.telephone','users.adresse',
            //
            'provinces.nomProvince','pays.nomPays', 'entreprises.created_at')
           ->get();
           $output='';
           foreach ($data1 as $row1) 
           {                                
               $nomEse=$row1->nomEntreprise;
               $adresseEse=$row1->adresseEntreprise;
               $Tel1Ese=$row1->telephoneEntreprise;
               $Tel2Ese=$row1->telephone;
               $siteEse=$row1->siteweb;
               $emailEse=$row1->emailEntreprise;
               $idNatEse=$row1->rccm;
               $numImpotEse=$row1->rccm;
               $busnessName=$row1->nomSecteur;
               $rccmEse=$row1->rccm;
               $pic = $this->displayImg("fichier", 'logo.png');
               $siege=$row1->nomForme;         
           }



           $totalVente = 0;
           $totalTransfert=0;
           $totalCMUP = 0;
           $globalTP=0;

           $data5 = DB::table('tvente_detail_vente')
           ->join('tvente_stock_service','tvente_stock_service.id','=','tvente_detail_vente.idStockService')
           ->join('tvente_produit','tvente_produit.id','=','tvente_stock_service.refProduit')
           ->join('tvente_categorie_produit','tvente_categorie_produit.id','=','tvente_produit.refCategorie')
           ->join('tvente_entete_vente','tvente_entete_vente.id','=','tvente_detail_vente.refEnteteVente')
           ->select(DB::raw('IFNULL(ROUND(SUM(qteVente*puVente),0),0) as totalSortie'))
           ->where([               
               ['tvente_entete_vente.dateVente','>=', $date1],
               ['tvente_entete_vente.dateVente','<=', $date2],
               ['tvente_stock_service.refService','=', $idService]
           ])->get(); 
           
           foreach ($data5 as $row5) 
           {                                
              $totalVente=$row5->totalSortie;                           
           }
   

           $CategorieClient=''; 

           $data3=DB::table('tvente_services')
           ->select('id','nom_service','status','active')
           ->where([
              ['tvente_services.id','=', $idService]
          ])      
          ->get();      
          $output='';
          foreach ($data3 as $row) 
          {
              $CategorieClient=$row->nom_service;              
          }

            $output=' 

            <!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Transitional//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd">
            <!-- saved from url=(0016)http://localhost -->
            <html>
            <head>
                <title>FicheStock</title>
                <meta HTTP-EQUIV="Content-Type" CONTENT="text/html; charset=utf-8"/>
                <style type="text/css">
                    .cs1B222893 {color:#000000;background-color:#D6E5F4;border-left:#004000 1px solid;border-top:#004000 1px solid;border-right:#004000 1px solid;border-bottom:#004000 1px solid;font-family:Times New Roman; font-size:27px; font-weight:bold; font-style:normal; padding-left:2px;padding-right:2px;}
                    .cs6F7E55AC {color:#000000;background-color:#D6E5F4;border-left-style: none;border-top:#004000 1px solid;border-right:#004000 1px solid;border-bottom:#004000 1px solid;font-family:Times New Roman; font-size:13px; font-weight:bold; font-style:normal; }
                    .csE0D816CD {color:#000000;background-color:#D6E5F4;border-left-style: none;border-top-style: none;border-right-style: none;border-bottom-style: none;font-family:Times New Roman; font-size:15px; font-weight:bold; font-style:normal; padding-left:2px;padding-right:2px;}
                    .cs8F59FFB2 {color:#000000;background-color:#F5F5F5;border-left:#004000 1px solid;border-top:#004000 1px solid;border-right:#004000 1px solid;border-bottom:#004000 1px solid;font-family:Times New Roman; font-size:13px; font-weight:bold; font-style:normal; }
                    .csF3AA49E4 {color:#000000;background-color:#F5F5F5;border-left-style: none;border-top:#004000 1px solid;border-right:#004000 1px solid;border-bottom:#004000 1px solid;font-family:Times New Roman; font-size:13px; font-weight:bold; font-style:normal; }
                    .csE78F4A6 {color:#000000;background-color:#F5F5F5;border-left-style: none;border-top:#004000 1px solid;border-right:#004000 1px solid;border-bottom:#004000 1px solid;font-family:Times New Roman; font-size:13px; font-weight:normal; font-style:normal; }
                    .cs4B928201 {color:#000000;background-color:#FFFFFF;border-left-style: none;border-top:#004000 1px solid;border-right:#004000 1px solid;border-bottom:#004000 1px solid;font-family:Times New Roman; font-size:13px; font-weight:bold; font-style:normal; }
                    .cs2C96DE68 {color:#000000;background-color:transparent;border-left:#000000 1px solid;border-top:#000000 1px solid;border-right:#000000 1px solid;border-bottom:#000000 1px solid;font-family:Times New Roman; font-size:13px; font-weight:normal; font-style:italic; padding-left:2px;}
                    .csE71035DC {color:#000000;background-color:transparent;border-left:#000000 1px solid;border-top:#000000 1px solid;border-right:#000000 1px solid;border-bottom:#000000 1px solid;font-family:Times New Roman; font-size:13px; font-weight:normal; font-style:normal; }
                    .csAB3AA82A {color:#000000;background-color:transparent;border-left-style: none;border-top:#000000 1px solid;border-right:#000000 1px solid;border-bottom:#000000 1px solid;font-family:Times New Roman; font-size:13px; font-weight:bold; font-style:normal; }
                    .csC73F4F41 {color:#000000;background-color:transparent;border-left-style: none;border-top:#004000 1px solid;border-right:#004000 1px solid;border-bottom:#004000 1px solid;font-family:Times New Roman; font-size:13px; font-weight:bold; font-style:normal; }
                    .csD149F8AB {color:#000000;background-color:transparent;border-left-style: none;border-top:#004000 1px solid;border-right:#004000 1px solid;border-bottom:#004000 1px solid;font-family:Times New Roman; font-size:13px; font-weight:normal; font-style:normal; }
                    .cs612ED82F {color:#000000;background-color:transparent;border-left-style: none;border-top-style: none;border-right-style: none;border-bottom-style: none;font-family:Times New Roman; font-size:12px; font-weight:bold; font-style:normal; padding-left:2px;}
                    .csFFC1C457 {color:#000000;background-color:transparent;border-left-style: none;border-top-style: none;border-right-style: none;border-bottom-style: none;font-family:Times New Roman; font-size:12px; font-weight:normal; font-style:normal; padding-left:2px;}
                    .cs101A94F7 {color:#000000;background-color:transparent;border-left-style: none;border-top-style: none;border-right-style: none;border-bottom-style: none;font-family:Times New Roman; font-size:13px; font-weight:normal; font-style:normal; }
                    .csCE72709D {color:#000000;background-color:transparent;border-left-style: none;border-top-style: none;border-right-style: none;border-bottom-style: none;font-family:Times New Roman; font-size:14px; font-weight:bold; font-style:normal; padding-left:2px;}
                    .csFBB219FE {color:#000000;background-color:transparent;border-left-style: none;border-top-style: none;border-right-style: none;border-bottom-style: none;font-family:Times New Roman; font-size:18px; font-weight:bold; font-style:normal; padding-left:2px;}
                    .cs739196BC {color:#5C5C5C;background-color:transparent;border-left-style: none;border-top-style: none;border-right-style: none;border-bottom-style: none;font-family:Segoe UI; font-size:11px; font-weight:normal; font-style:normal; }
                    .csF7D3565D {height:0px;width:0px;overflow:hidden;font-size:0px;line-height:0px;}
                </style>
            </head>
            <body leftMargin=10 topMargin=10 rightMargin=10 bottomMargin=10 style="background-color:#FFFFFF">
            <table cellpadding="0" cellspacing="0" border="0" style="border-width:0px;empty-cells:show;width:958px;height:352px;position:relative;">
                <tr>
                    <td style="width:0px;height:0px;"></td>
                    <td style="height:0px;width:6px;"></td>
                    <td style="height:0px;width:4px;"></td>
                    <td style="height:0px;width:163px;"></td>
                    <td style="height:0px;width:47px;"></td>
                    <td style="height:0px;width:59px;"></td>
                    <td style="height:0px;width:108px;"></td>
                    <td style="height:0px;width:22px;"></td>
                    <td style="height:0px;width:88px;"></td>
                    <td style="height:0px;width:77px;"></td>
                    <td style="height:0px;width:89px;"></td>
                    <td style="height:0px;width:21px;"></td>
                    <td style="height:0px;width:18px;"></td>
                    <td style="height:0px;width:86px;"></td>
                    <td style="height:0px;width:36px;"></td>
                    <td style="height:0px;width:132px;"></td>
                    <td style="height:0px;width:2px;"></td>
                </tr>
                <tr style="vertical-align:top;">
                    <td style="width:0px;height:23px;"></td>
                    <td></td>
                    <td></td>
                    <td></td>
                    <td></td>
                    <td></td>
                    <td></td>
                    <td></td>
                    <td></td>
                    <td></td>
                    <td></td>
                </tr>
                <tr style="vertical-align:top;">
                    <td style="width:0px;height:3px;"></td>
                    <td></td>
                    <td></td>
                    <td></td>
                    <td></td>
                    <td></td>
                    <td></td>
                    <td></td>
                    <td></td>
                    <td></td>
                    <td></td>
                    <td></td>
                    <td></td>
                    <td></td>
                    <td></td>
                    <td></td>
                    <td></td>
                </tr>
                <tr style="vertical-align:top;">
                    <td style="width:0px;height:10px;"></td>
                    <td></td>
                    <td></td>
                    <td class="csFBB219FE" colspan="10" rowspan="2" style="width:690px;height:23px;line-height:21px;text-align:left;vertical-align:middle;">'.$nomEse.'</td>
                    <td></td>
                    <td></td>
                    <td></td>
                    <td></td>
                </tr>
                <tr style="vertical-align:top;">
                    <td style="width:0px;height:13px;"></td>
                    <td></td>
                    <td></td>
                    <td></td>
                    <td class="cs101A94F7" colspan="2" rowspan="7" style="width:168px;height:144px;text-align:left;vertical-align:top;"><div style="overflow:hidden;width:168px;height:144px;">
                        <img alt="" src="'.$pic2.'" style="width:168px;height:144px;" /></div>
                    </td>
                    <td></td>
                </tr>
                <tr style="vertical-align:top;">
                    <td style="width:0px;height:22px;"></td>
                    <td></td>
                    <td></td>
                    <td class="csCE72709D" colspan="10" style="width:690px;height:22px;line-height:15px;text-align:left;vertical-align:middle;">'.$busnessName.'</td>
                    <td></td>
                    <td></td>
                </tr>
                <tr style="vertical-align:top;">
                    <td style="width:0px;height:22px;"></td>
                    <td></td>
                    <td></td>
                    <td class="csCE72709D" colspan="10" style="width:690px;height:22px;line-height:15px;text-align:left;vertical-align:middle;"><nobr>RCCM'.$rccEse.'.&nbsp;ID-NAT.'.$numImpotEse.'</nobr></td>
                    <td></td>
                    <td></td>
                </tr>
                <tr style="vertical-align:top;">
                    <td style="width:0px;height:22px;"></td>
                    <td></td>
                    <td></td>
                    <td class="csFFC1C457" colspan="10" style="width:690px;height:22px;line-height:13px;text-align:left;vertical-align:middle;">'.$adresseEse.'</td>
                    <td></td>
                    <td></td>
                </tr>
                <tr style="vertical-align:top;">
                    <td style="width:0px;height:22px;"></td>
                    <td></td>
                    <td></td>
                    <td class="csFFC1C457" colspan="10" style="width:690px;height:22px;line-height:13px;text-align:left;vertical-align:middle;"><nobr>Email&nbsp;:&nbsp;'.$emailEse.'</nobr></td>
                    <td></td>
                    <td></td>
                </tr>
                <tr style="vertical-align:top;">
                    <td style="width:0px;height:22px;"></td>
                    <td></td>
                    <td></td>
                    <td class="csFFC1C457" colspan="10" style="width:690px;height:22px;line-height:13px;text-align:left;vertical-align:middle;"><nobr>Site&nbsp;web&nbsp;:&nbsp;'.$siteEse.'</nobr></td>
                    <td></td>
                    <td></td>
                </tr>
                <tr style="vertical-align:top;">
                    <td style="width:0px;height:21px;"></td>
                    <td></td>
                    <td></td>
                    <td class="cs612ED82F" colspan="10" rowspan="2" style="width:690px;height:22px;line-height:13px;text-align:left;vertical-align:middle;"><nobr>T&#233;l&#233;phone&nbsp;:&nbsp;'.$Tel1Ese.'&nbsp;&nbsp;24h/24</nobr></td>
                    <td></td>
                    <td></td>
                </tr>
                <tr style="vertical-align:top;">
                    <td style="width:0px;height:1px;"></td>
                    <td></td>
                    <td></td>
                    <td></td>
                    <td></td>
                    <td></td>
                    <td></td>
                </tr>
                <tr style="vertical-align:top;">
                    <td style="width:0px;height:14px;"></td>
                    <td></td>
                    <td></td>
                    <td></td>
                    <td></td>
                    <td></td>
                    <td></td>
                    <td></td>
                    <td></td>
                    <td></td>
                    <td></td>
                    <td></td>
                    <td></td>
                    <td></td>
                    <td></td>
                    <td></td>
                    <td></td>
                </tr>
                <tr style="vertical-align:top;">
                    <td style="width:0px;height:34px;"></td>
                    <td></td>
                    <td></td>
                    <td></td>
                    <td></td>
                    <td class="cs1B222893" colspan="6" style="width:437px;height:32px;line-height:31px;text-align:center;vertical-align:middle;"><nobr>FICHE&nbsp;DE&nbsp;STOCK : '.$CategorieClient.'</nobr></td>
                    <td></td>
                    <td></td>
                    <td></td>
                    <td></td>
                    <td></td>
                    <td></td>
                </tr>
                <tr style="vertical-align:top;">
                    <td style="width:0px;height:7px;"></td>
                    <td></td>
                    <td></td>
                    <td></td>
                    <td></td>
                    <td></td>
                    <td></td>
                    <td></td>
                    <td></td>
                    <td></td>
                    <td></td>
                    <td></td>
                    <td></td>
                    <td></td>
                    <td></td>
                    <td></td>
                    <td></td>
                </tr>
                <tr style="vertical-align:top;">
                    <td style="width:0px;height:24px;"></td>
                    <td></td>
                    <td class="csE71035DC" colspan="10" style="width:676px;height:22px;line-height:15px;text-align:center;vertical-align:middle;"><nobr>TOTAL&nbsp;VENTE(USD)</nobr></td>
                    <td class="csAB3AA82A" colspan="5" style="width:273px;height:22px;line-height:15px;text-align:center;vertical-align:middle;"><nobr>'.$totalVente.'$</nobr></td>
                </tr>
                <tr style="vertical-align:top;">
                    <td style="width:0px;height:24px;"></td>
                    <td></td>
                    <td class="cs8F59FFB2" colspan="2" style="width:165px;height:22px;line-height:15px;text-align:center;vertical-align:middle;"><nobr>PRODUIT</nobr></td>
                    <td class="cs6F7E55AC" colspan="2" style="width:105px;height:22px;line-height:15px;text-align:center;vertical-align:middle;"><nobr>SI</nobr></td>
                    <td class="csF3AA49E4" style="width:107px;height:22px;line-height:15px;text-align:center;vertical-align:middle;"><nobr>ENTREE</nobr></td>
                    <td class="csC73F4F41" colspan="2" style="width:109px;height:22px;line-height:15px;text-align:center;vertical-align:middle;"><nobr>TOTAL</nobr></td>
                    <td class="cs4B928201" colspan="2" style="width:109px;height:22px;line-height:15px;text-align:center;vertical-align:middle;"><nobr>SORTIE</nobr></td>
                    <td class="csF3AA49E4" style="width:76px;height:22px;line-height:15px;text-align:center;vertical-align:middle;"><nobr>SF</nobr></td>                    
                    <td class="cs4B928201" colspan="3" style="width:139px;height:22px;line-height:15px;text-align:center;vertical-align:middle;"><nobr>PU(USD)</nobr></td>
                    <td class="cs6F7E55AC" colspan="2" style="width:133px;height:22px;line-height:15px;text-align:center;vertical-align:middle;"><nobr>PT(USD)</nobr></td>
                </tr>
                <tr style="vertical-align:top;">
                    <td style="width:0px;height:22px;"></td>
                    <td></td>
                    <td class="cs2C96DE68" colspan="15" style="width:948px;height:20px;line-height:15px;text-align:left;vertical-align:top;"><nobr>'.$date1.'</nobr></td>
                </tr>
                ';
                                                                
                   $output .= $this->showCategorieFicheStockService($date1,$date2,$idService); 
                                                                
                 $output.='
            </table>
            </body>
            </html>

            '; 

    return $output;

} 

function showCategorieFicheStockService($date1,$date2,$idService)
{
    $data = DB::table("tvente_categorie_produit")
    ->select("tvente_categorie_produit.id", "tvente_categorie_produit.designation", 
    "tvente_categorie_produit.created_at", "tvente_categorie_produit.author")
    ->orderBy("tvente_categorie_produit.designation", "asc")
    ->get();
    
    $output='';

    foreach ($data as $row) 
    {
        $output .='
                <tr style="vertical-align:top;">
                <td style="width:0px;height:22px;"></td>
                <td></td>
                <td class="csE0D816CD" colspan="15" style="width:948px;height:22px;line-height:17px;text-align:center;vertical-align:middle;">'.$row->designation.'</td>
            </tr>
            ';
                                                    
                $output .= $this->showDetailFicheStockServiceByCat($date1,$date2,$row->id,$idService);                                                     
                $output.='
        ';      
    }

    return $output;

}

//=============== FICHE DE STOCK DES SERVICES BY CATEGORIE=======================================================================================

function pdf_fiche_stock_cout_vente_service(Request $request)
{

    if ($request->get('date1') && $request->get('date2') && $request->get('idService')) {
        // code...
        $date1 = $request->get('date1');
        $date2 = $request->get('date2');
        $idService = $request->get('idService');
        
        // $html = $this->getInfoFicheStockCoutServices($date1,$date2,$idService);
        // $pdf = \App::make('dompdf.wrapper');

        // $pdf->loadHTML($html);
        // $pdf->loadHTML($html)->setPaper('a4', 'landscape');
        // return $pdf->stream();

        $html ='<html><head><meta http-equiv="Content-Type" content="text/html; charset=utf-8"/>';
        $html .= $this->getInfoFicheStockCoutServices($date1,$date2,$idService);       
        $html .='<script>window.print()</script>';

        echo($html); 
        
    }
    else{
    }    
}

function getInfoFicheStockCoutServices($date1,$date2,$idService)
{
           //Info Entreprise
           $nomEse='';
           $adresseEse='';
           $Tel1Ese='';
           $Tel2Ese='';
           $siteEse='';
           $emailEse='';
           $idNatEse='';
           $numImpotEse='';
           $rccEse='';
           $siege='';
           $busnessName='';
           $pic='';
           $pic2 = $this->displayImg("fichier", 'logo.png');
           $logo='';
   
           $data1 = DB::table('entreprises')
           ->join('secteurs','secteurs.id','=','entreprises.idsecteur')
           ->join('forme_juridiques','forme_juridiques.id','=','entreprises.idforme')
   
           ->join('pays','pays.id','=','entreprises.idPays')
           ->join('provinces','provinces.id','=','entreprises.idProvince')
           ->join('users','users.id','=','entreprises.ceo')        
           ->select('entreprises.id as id','entreprises.id as idEntreprise',
           'entreprises.ceo','entreprises.nomEntreprise','entreprises.descriptionEntreprise',
           'entreprises.emailEntreprise','entreprises.adresseEntreprise',
           'entreprises.telephoneEntreprise','entreprises.solutionEntreprise','entreprises.idsecteur',
           'entreprises.idforme','entreprises.etat',
           'entreprises.idPays','entreprises.idProvince','entreprises.edition','entreprises.facebook',
           'entreprises.linkedin','entreprises.twitter','entreprises.siteweb','entreprises.rccm',
           'entreprises.invPersonnel','entreprises.invHub','entreprises.invRecherche',
           'entreprises.chiffreAffaire','entreprises.nbremploye','entreprises.slug','entreprises.logo',
            //forme
            'forme_juridiques.nomForme','secteurs.nomSecteur',
            //users
            'users.name','users.email','users.avatar','users.telephone','users.adresse',
            //
            'provinces.nomProvince','pays.nomPays', 'entreprises.created_at')
           ->get();
           $output='';
           foreach ($data1 as $row1) 
           {                                
               $nomEse=$row1->nomEntreprise;
               $adresseEse=$row1->adresseEntreprise;
               $Tel1Ese=$row1->telephoneEntreprise;
               $Tel2Ese=$row1->telephone;
               $siteEse=$row1->siteweb;
               $emailEse=$row1->emailEntreprise;
               $idNatEse=$row1->rccm;
               $numImpotEse=$row1->rccm;
               $busnessName=$row1->nomSecteur;
               $rccmEse=$row1->rccm;
               $pic = $this->displayImg("fichier", 'logo.png');
               $siege=$row1->nomForme;         
           }



           $totalVente = 0;
           $totalTransfert=0;
           $totalCMUP = 0;
           $globalTP=0;

           $data5 = DB::table('tvente_detail_vente')
           ->join('tvente_stock_service','tvente_stock_service.id','=','tvente_detail_vente.idStockService')
           ->join('tvente_produit','tvente_produit.id','=','tvente_stock_service.refProduit')
           ->join('tvente_categorie_produit','tvente_categorie_produit.id','=','tvente_produit.refCategorie')
           ->join('tvente_entete_vente','tvente_entete_vente.id','=','tvente_detail_vente.refEnteteVente')
           ->select(DB::raw('IFNULL(ROUND(SUM(qteVente*puVente),0),0) as totalSortie'))
           ->where([               
               ['tvente_entete_vente.dateVente','>=', $date1],
               ['tvente_entete_vente.dateVente','<=', $date2],
               ['tvente_stock_service.refService','=', $idService]
           ])->get(); 
           
           foreach ($data5 as $row5) 
           {                                
              $totalVente=$row5->totalSortie;                           
           }
   

           $CategorieClient=''; 

           $data3=DB::table('tvente_services')
           ->select('id','nom_service','status','active')
           ->where([
              ['tvente_services.id','=', $idService]
          ])      
          ->get();      
          $output='';
          foreach ($data3 as $row) 
          {
              $CategorieClient=$row->nom_service;              
          }

            $output=' 

            <!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Transitional//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd">
            <!-- saved from url=(0016)http://localhost -->
            <html>
            <head>
                <title>FicheStock</title>
                <meta HTTP-EQUIV="Content-Type" CONTENT="text/html; charset=utf-8"/>
                <style type="text/css">
                    .cs1B222893 {color:#000000;background-color:#D6E5F4;border-left:#004000 1px solid;border-top:#004000 1px solid;border-right:#004000 1px solid;border-bottom:#004000 1px solid;font-family:Times New Roman; font-size:27px; font-weight:bold; font-style:normal; padding-left:2px;padding-right:2px;}
                    .cs6F7E55AC {color:#000000;background-color:#D6E5F4;border-left-style: none;border-top:#004000 1px solid;border-right:#004000 1px solid;border-bottom:#004000 1px solid;font-family:Times New Roman; font-size:13px; font-weight:bold; font-style:normal; }
                    .csE0D816CD {color:#000000;background-color:#D6E5F4;border-left-style: none;border-top-style: none;border-right-style: none;border-bottom-style: none;font-family:Times New Roman; font-size:15px; font-weight:bold; font-style:normal; padding-left:2px;padding-right:2px;}
                    .cs8F59FFB2 {color:#000000;background-color:#F5F5F5;border-left:#004000 1px solid;border-top:#004000 1px solid;border-right:#004000 1px solid;border-bottom:#004000 1px solid;font-family:Times New Roman; font-size:13px; font-weight:bold; font-style:normal; }
                    .csF3AA49E4 {color:#000000;background-color:#F5F5F5;border-left-style: none;border-top:#004000 1px solid;border-right:#004000 1px solid;border-bottom:#004000 1px solid;font-family:Times New Roman; font-size:13px; font-weight:bold; font-style:normal; }
                    .csE78F4A6 {color:#000000;background-color:#F5F5F5;border-left-style: none;border-top:#004000 1px solid;border-right:#004000 1px solid;border-bottom:#004000 1px solid;font-family:Times New Roman; font-size:13px; font-weight:normal; font-style:normal; }
                    .cs4B928201 {color:#000000;background-color:#FFFFFF;border-left-style: none;border-top:#004000 1px solid;border-right:#004000 1px solid;border-bottom:#004000 1px solid;font-family:Times New Roman; font-size:13px; font-weight:bold; font-style:normal; }
                    .cs2C96DE68 {color:#000000;background-color:transparent;border-left:#000000 1px solid;border-top:#000000 1px solid;border-right:#000000 1px solid;border-bottom:#000000 1px solid;font-family:Times New Roman; font-size:13px; font-weight:normal; font-style:italic; padding-left:2px;}
                    .csE71035DC {color:#000000;background-color:transparent;border-left:#000000 1px solid;border-top:#000000 1px solid;border-right:#000000 1px solid;border-bottom:#000000 1px solid;font-family:Times New Roman; font-size:13px; font-weight:normal; font-style:normal; }
                    .csAB3AA82A {color:#000000;background-color:transparent;border-left-style: none;border-top:#000000 1px solid;border-right:#000000 1px solid;border-bottom:#000000 1px solid;font-family:Times New Roman; font-size:13px; font-weight:bold; font-style:normal; }
                    .csC73F4F41 {color:#000000;background-color:transparent;border-left-style: none;border-top:#004000 1px solid;border-right:#004000 1px solid;border-bottom:#004000 1px solid;font-family:Times New Roman; font-size:13px; font-weight:bold; font-style:normal; }
                    .csD149F8AB {color:#000000;background-color:transparent;border-left-style: none;border-top:#004000 1px solid;border-right:#004000 1px solid;border-bottom:#004000 1px solid;font-family:Times New Roman; font-size:13px; font-weight:normal; font-style:normal; }
                    .cs612ED82F {color:#000000;background-color:transparent;border-left-style: none;border-top-style: none;border-right-style: none;border-bottom-style: none;font-family:Times New Roman; font-size:12px; font-weight:bold; font-style:normal; padding-left:2px;}
                    .csFFC1C457 {color:#000000;background-color:transparent;border-left-style: none;border-top-style: none;border-right-style: none;border-bottom-style: none;font-family:Times New Roman; font-size:12px; font-weight:normal; font-style:normal; padding-left:2px;}
                    .cs101A94F7 {color:#000000;background-color:transparent;border-left-style: none;border-top-style: none;border-right-style: none;border-bottom-style: none;font-family:Times New Roman; font-size:13px; font-weight:normal; font-style:normal; }
                    .csCE72709D {color:#000000;background-color:transparent;border-left-style: none;border-top-style: none;border-right-style: none;border-bottom-style: none;font-family:Times New Roman; font-size:14px; font-weight:bold; font-style:normal; padding-left:2px;}
                    .csFBB219FE {color:#000000;background-color:transparent;border-left-style: none;border-top-style: none;border-right-style: none;border-bottom-style: none;font-family:Times New Roman; font-size:18px; font-weight:bold; font-style:normal; padding-left:2px;}
                    .cs739196BC {color:#5C5C5C;background-color:transparent;border-left-style: none;border-top-style: none;border-right-style: none;border-bottom-style: none;font-family:Segoe UI; font-size:11px; font-weight:normal; font-style:normal; }
                    .csF7D3565D {height:0px;width:0px;overflow:hidden;font-size:0px;line-height:0px;}
                </style>
            </head>
            <body leftMargin=10 topMargin=10 rightMargin=10 bottomMargin=10 style="background-color:#FFFFFF">
            <table cellpadding="0" cellspacing="0" border="0" style="border-width:0px;empty-cells:show;width:958px;height:352px;position:relative;">
                <tr>
                    <td style="width:0px;height:0px;"></td>
                    <td style="height:0px;width:6px;"></td>
                    <td style="height:0px;width:4px;"></td>
                    <td style="height:0px;width:163px;"></td>
                    <td style="height:0px;width:47px;"></td>
                    <td style="height:0px;width:59px;"></td>
                    <td style="height:0px;width:108px;"></td>
                    <td style="height:0px;width:22px;"></td>
                    <td style="height:0px;width:88px;"></td>
                    <td style="height:0px;width:77px;"></td>
                    <td style="height:0px;width:89px;"></td>
                    <td style="height:0px;width:21px;"></td>
                    <td style="height:0px;width:18px;"></td>
                    <td style="height:0px;width:86px;"></td>
                    <td style="height:0px;width:36px;"></td>
                    <td style="height:0px;width:132px;"></td>
                    <td style="height:0px;width:2px;"></td>
                </tr>
                <tr style="vertical-align:top;">
                    <td style="width:0px;height:23px;"></td>
                    <td></td>
                    <td></td>
                    <td></td>
                    <td></td>
                    <td></td>
                    <td></td>
                    <td></td>
                    <td></td>
                    <td></td>
                    <td></td>
                </tr>
                <tr style="vertical-align:top;">
                    <td style="width:0px;height:3px;"></td>
                    <td></td>
                    <td></td>
                    <td></td>
                    <td></td>
                    <td></td>
                    <td></td>
                    <td></td>
                    <td></td>
                    <td></td>
                    <td></td>
                    <td></td>
                    <td></td>
                    <td></td>
                    <td></td>
                    <td></td>
                    <td></td>
                </tr>
                <tr style="vertical-align:top;">
                    <td style="width:0px;height:10px;"></td>
                    <td></td>
                    <td></td>
                    <td class="csFBB219FE" colspan="10" rowspan="2" style="width:690px;height:23px;line-height:21px;text-align:left;vertical-align:middle;">'.$nomEse.'</td>
                    <td></td>
                    <td></td>
                    <td></td>
                    <td></td>
                </tr>
                <tr style="vertical-align:top;">
                    <td style="width:0px;height:13px;"></td>
                    <td></td>
                    <td></td>
                    <td></td>
                    <td class="cs101A94F7" colspan="2" rowspan="7" style="width:168px;height:144px;text-align:left;vertical-align:top;"><div style="overflow:hidden;width:168px;height:144px;">
                        <img alt="" src="'.$pic2.'" style="width:168px;height:144px;" /></div>
                    </td>
                    <td></td>
                </tr>
                <tr style="vertical-align:top;">
                    <td style="width:0px;height:22px;"></td>
                    <td></td>
                    <td></td>
                    <td class="csCE72709D" colspan="10" style="width:690px;height:22px;line-height:15px;text-align:left;vertical-align:middle;">'.$busnessName.'</td>
                    <td></td>
                    <td></td>
                </tr>
                <tr style="vertical-align:top;">
                    <td style="width:0px;height:22px;"></td>
                    <td></td>
                    <td></td>
                    <td class="csCE72709D" colspan="10" style="width:690px;height:22px;line-height:15px;text-align:left;vertical-align:middle;"><nobr>RCCM'.$rccEse.'.&nbsp;ID-NAT.'.$numImpotEse.'</nobr></td>
                    <td></td>
                    <td></td>
                </tr>
                <tr style="vertical-align:top;">
                    <td style="width:0px;height:22px;"></td>
                    <td></td>
                    <td></td>
                    <td class="csFFC1C457" colspan="10" style="width:690px;height:22px;line-height:13px;text-align:left;vertical-align:middle;">'.$adresseEse.'</td>
                    <td></td>
                    <td></td>
                </tr>
                <tr style="vertical-align:top;">
                    <td style="width:0px;height:22px;"></td>
                    <td></td>
                    <td></td>
                    <td class="csFFC1C457" colspan="10" style="width:690px;height:22px;line-height:13px;text-align:left;vertical-align:middle;"><nobr>Email&nbsp;:&nbsp;'.$emailEse.'</nobr></td>
                    <td></td>
                    <td></td>
                </tr>
                <tr style="vertical-align:top;">
                    <td style="width:0px;height:22px;"></td>
                    <td></td>
                    <td></td>
                    <td class="csFFC1C457" colspan="10" style="width:690px;height:22px;line-height:13px;text-align:left;vertical-align:middle;"><nobr>Site&nbsp;web&nbsp;:&nbsp;'.$siteEse.'</nobr></td>
                    <td></td>
                    <td></td>
                </tr>
                <tr style="vertical-align:top;">
                    <td style="width:0px;height:21px;"></td>
                    <td></td>
                    <td></td>
                    <td class="cs612ED82F" colspan="10" rowspan="2" style="width:690px;height:22px;line-height:13px;text-align:left;vertical-align:middle;"><nobr>T&#233;l&#233;phone&nbsp;:&nbsp;'.$Tel1Ese.'&nbsp;&nbsp;24h/24</nobr></td>
                    <td></td>
                    <td></td>
                </tr>
                <tr style="vertical-align:top;">
                    <td style="width:0px;height:1px;"></td>
                    <td></td>
                    <td></td>
                    <td></td>
                    <td></td>
                    <td></td>
                    <td></td>
                </tr>
                <tr style="vertical-align:top;">
                    <td style="width:0px;height:14px;"></td>
                    <td></td>
                    <td></td>
                    <td></td>
                    <td></td>
                    <td></td>
                    <td></td>
                    <td></td>
                    <td></td>
                    <td></td>
                    <td></td>
                    <td></td>
                    <td></td>
                    <td></td>
                    <td></td>
                    <td></td>
                    <td></td>
                </tr>
                <tr style="vertical-align:top;">
                    <td style="width:0px;height:34px;"></td>
                    <td></td>
                    <td></td>
                    <td></td>
                    <td></td>
                    <td class="cs1B222893" colspan="6" style="width:437px;height:32px;line-height:31px;text-align:center;vertical-align:middle;"><nobr>FICHE&nbsp;DE&nbsp;STOCK DES COUTS : '.$CategorieClient.'</nobr></td>
                    <td></td>
                    <td></td>
                    <td></td>
                    <td></td>
                    <td></td>
                    <td></td>
                </tr>
                <tr style="vertical-align:top;">
                    <td style="width:0px;height:7px;"></td>
                    <td></td>
                    <td></td>
                    <td></td>
                    <td></td>
                    <td></td>
                    <td></td>
                    <td></td>
                    <td></td>
                    <td></td>
                    <td></td>
                    <td></td>
                    <td></td>
                    <td></td>
                    <td></td>
                    <td></td>
                    <td></td>
                </tr>
                <tr style="vertical-align:top;">
                    <td style="width:0px;height:24px;"></td>
                    <td></td>
                    <td class="csE71035DC" colspan="10" style="width:676px;height:22px;line-height:15px;text-align:center;vertical-align:middle;"><nobr>--</nobr></td>
                    <td class="csAB3AA82A" colspan="5" style="width:273px;height:22px;line-height:15px;text-align:center;vertical-align:middle;"><nobr>--</nobr></td>
                </tr>
                <tr style="vertical-align:top;">
                    <td style="width:0px;height:24px;"></td>
                    <td></td>
                    <td class="cs8F59FFB2" colspan="2" style="width:165px;height:22px;line-height:15px;text-align:center;vertical-align:middle;"><nobr>PRODUIT</nobr></td>
                    <td class="cs6F7E55AC" colspan="2" style="width:105px;height:22px;line-height:15px;text-align:center;vertical-align:middle;"><nobr>SI</nobr></td>
                    <td class="csF3AA49E4" style="width:107px;height:22px;line-height:15px;text-align:center;vertical-align:middle;"><nobr>ENTREE</nobr></td>
                    <td class="csC73F4F41" colspan="2" style="width:109px;height:22px;line-height:15px;text-align:center;vertical-align:middle;"><nobr>TOTAL</nobr></td>
                    <td class="cs4B928201" colspan="2" style="width:109px;height:22px;line-height:15px;text-align:center;vertical-align:middle;"><nobr>SORTIE</nobr></td>
                    <td class="csF3AA49E4" style="width:76px;height:22px;line-height:15px;text-align:center;vertical-align:middle;"><nobr>SF</nobr></td>                    
                    <td class="cs4B928201" colspan="3" style="width:139px;height:22px;line-height:15px;text-align:center;vertical-align:middle;"><nobr>DEVISE</nobr></td>
                    <td class="cs6F7E55AC" colspan="2" style="width:133px;height:22px;line-height:15px;text-align:center;vertical-align:middle;"><nobr>TAUX</nobr></td>
                </tr>
                <tr style="vertical-align:top;">
                    <td style="width:0px;height:22px;"></td>
                    <td></td>
                    <td class="cs2C96DE68" colspan="15" style="width:948px;height:20px;line-height:15px;text-align:left;vertical-align:top;"><nobr>'.$date1.'</nobr></td>
                </tr>
                ';
                                                                
                   $output .= $this->showCategorieFicheStockCoutService($date1,$date2,$idService); 
                                                                
                 $output.='
            </table>
            </body>
            </html>

            '; 

    return $output;

} 

function showCategorieFicheStockCoutService($date1,$date2,$idService)
{
    $data = DB::table("tvente_categorie_produit")
    ->select("tvente_categorie_produit.id", "tvente_categorie_produit.designation", 
    "tvente_categorie_produit.created_at", "tvente_categorie_produit.author")
    ->orderBy("tvente_categorie_produit.designation", "asc")
    ->get();
    
    $output='';

    foreach ($data as $row) 
    {
        $output .='
                <tr style="vertical-align:top;">
                <td style="width:0px;height:22px;"></td>
                <td></td>
                <td class="csE0D816CD" colspan="15" style="width:948px;height:22px;line-height:17px;text-align:center;vertical-align:middle;">'.$row->designation.'</td>
            </tr>
            ';
                                                    
                $output .= $this->showDetailFicheStockCoutServiceByCat($date1,$date2,$row->id,$idService);                                                     
                $output.='
        ';      
    }

    return $output;

}

function showDetailFicheStockCoutServiceByCat($date1,$date2,$refCategorie,$idService)
{

    // Récupérer les données de stock, mouvements et ventes en une seule requête 
    $data11 = DB::table('tvente_stock_service')
    ->join('tvente_services', 'tvente_services.id', '=', 'tvente_stock_service.refService')
    ->Join('tvente_produit', 'tvente_produit.id', '=', 'tvente_stock_service.refProduit')
    ->Join('tvente_categorie_produit', 'tvente_categorie_produit.id', '=', 'tvente_produit.refCategorie')

    ->leftJoin('tvente_mouvement_stock as dtEntree', function ($join) use ($date1, $idService) {
        $join->on('dtEntree.idStockService', '=', 'tvente_stock_service.id')        
             ->where('dtEntree.type_mouvement', '=', 'Entree')
             ->where('dtEntree.dateMvt', '<', $date1);
    })

        // Utilisez distinct() avant select()
        ->distinct()
        ->select(
            "tvente_stock_service.id",
            'tvente_stock_service.refService',
            'tvente_stock_service.refProduit',
            "tvente_produit.designation as designation",
            "refCategorie",
            "tvente_stock_service.pu",
            "tvente_categorie_produit.designation as Categorie",
            "tvente_stock_service.qte",
            "tvente_stock_service.uniteBase",
            "tvente_stock_service.cmup","tvente_stock_service.devise","tvente_stock_service.taux",            
            DB::raw('IFNULL(ROUND(SUM(dtEntree.puMvt * dtEntree.qteMvt), 3), 0) as totalEntree'),

        )
        ->where([
            ['tvente_produit.refCategorie', '=', $refCategorie],
            ['tvente_stock_service.refService', '=', $idService]
        ])
        ->groupBy("tvente_stock_service.id", "tvente_stock_service.refService", "tvente_stock_service.refProduit", 
        "designation", "refCategorie", "pu", "Categorie", "qte", "uniteBase","cmup",
        "tvente_stock_service.devise","tvente_stock_service.taux")
        ->orderBy("tvente_produit.designation", "asc")
        ->get();

//======================================================================

    $data22 = DB::table('tvente_stock_service')
    ->join('tvente_services', 'tvente_services.id', '=', 'tvente_stock_service.refService')
    ->Join('tvente_produit', 'tvente_produit.id', '=', 'tvente_stock_service.refProduit')
    ->Join('tvente_categorie_produit', 'tvente_categorie_produit.id', '=', 'tvente_produit.refCategorie')

    ->leftJoin('tvente_mouvement_stock as dtSortie', function ($join) use ($date1, $idService) {
        $join->on('dtSortie.idStockService', '=', 'tvente_stock_service.id')        
             ->where('dtSortie.type_mouvement', '=', 'Sortie')
             ->where('dtSortie.dateMvt', '<', $date1);
    })
    // Utilisez distinct() avant select()
    ->distinct()
    ->select(
        "tvente_stock_service.id",
        'tvente_stock_service.refService',
        'tvente_stock_service.refProduit',
        "tvente_produit.designation as designation",
        "refCategorie",
        "tvente_stock_service.pu",
        "tvente_categorie_produit.designation as Categorie",
        "tvente_stock_service.qte",
        "tvente_stock_service.uniteBase",
        "tvente_stock_service.cmup",
        DB::raw('IFNULL(ROUND(SUM(dtSortie.puMvt * dtSortie.qteMvt), 3), 0) as totalSortie')
    )
    ->where([
        ['tvente_produit.refCategorie', '=', $refCategorie],
        ['tvente_stock_service.refService', '=', $idService]
    ])
    ->groupBy("tvente_stock_service.id", "tvente_stock_service.refService", "tvente_stock_service.refProduit", "designation", "refCategorie", "pu", "Categorie", "qte", "uniteBase","cmup")
    ->orderBy("tvente_produit.designation", "asc")
    ->get();

    // ============ LEs Mouvements =========================================================================

        // Récupérer les données de stock, mouvements et ventes en une seule requête 
        $data1 = DB::table('tvente_stock_service')
        ->join('tvente_services', 'tvente_services.id', '=', 'tvente_stock_service.refService')
        ->Join('tvente_produit', 'tvente_produit.id', '=', 'tvente_stock_service.refProduit')
        ->Join('tvente_categorie_produit', 'tvente_categorie_produit.id', '=', 'tvente_produit.refCategorie')
    
        ->leftJoin('tvente_mouvement_stock as mvtEntree', function ($join) use ($date1, $date2, $idService) {
            $join->on('mvtEntree.idStockService', '=', 'tvente_stock_service.id')        
                 ->where('mvtEntree.type_mouvement', '=', 'Entree')
                 ->whereBetween('mvtEntree.dateMvt', [$date1, $date2]);;
        })
    
            // Utilisez distinct() avant select()
            ->distinct()
            ->select(
                "tvente_stock_service.id",
                'tvente_stock_service.refService',
                'tvente_stock_service.refProduit',
                "tvente_produit.designation as designation",
                "refCategorie",
                "tvente_stock_service.pu",
                "tvente_categorie_produit.designation as Categorie",
                "tvente_stock_service.qte",
                "tvente_stock_service.uniteBase",
                "tvente_stock_service.cmup","tvente_stock_service.devise","tvente_stock_service.taux",            
                DB::raw('IFNULL(ROUND(SUM(mvtEntree.puMvt * mvtEntree.qteMvt), 3), 0) as stockEntree'),
    
            )
            ->where([
                ['tvente_produit.refCategorie', '=', $refCategorie],
                ['tvente_stock_service.refService', '=', $idService]
            ])
            ->groupBy("tvente_stock_service.id", "tvente_stock_service.refService", "tvente_stock_service.refProduit", 
            "designation", "refCategorie", "pu", "Categorie", "qte", "uniteBase","cmup",
            "tvente_stock_service.devise","tvente_stock_service.taux")
            ->orderBy("tvente_produit.designation", "asc")
            ->get();
    
    //======================================================================
    
        // Récupérer les données de stock, mouvements et ventes en une seule requête 
        $data2 = DB::table('tvente_stock_service')
        ->join('tvente_services', 'tvente_services.id', '=', 'tvente_stock_service.refService')
        ->Join('tvente_produit', 'tvente_produit.id', '=', 'tvente_stock_service.refProduit')
        ->Join('tvente_categorie_produit', 'tvente_categorie_produit.id', '=', 'tvente_produit.refCategorie')
    
        ->leftJoin('tvente_mouvement_stock as mvtSortie', function ($join) use ($date1, $date2, $idService) {
            $join->on('mvtSortie.idStockService', '=', 'tvente_stock_service.id')        
                 ->where('mvtSortie.type_mouvement', '=', 'Sortie')
                 ->whereBetween('mvtSortie.dateMvt', [$date1, $date2]);;
        })
    
            // Utilisez distinct() avant select()
            ->distinct()
            ->select(
                "tvente_stock_service.id",
                'tvente_stock_service.refService',
                'tvente_stock_service.refProduit',
                "tvente_produit.designation as designation",
                "refCategorie",
                "tvente_stock_service.pu",
                "tvente_categorie_produit.designation as Categorie",
                "tvente_stock_service.qte",
                "tvente_stock_service.uniteBase",
                "tvente_stock_service.cmup","tvente_stock_service.devise","tvente_stock_service.taux",            
                DB::raw('IFNULL(ROUND(SUM(mvtSortie.puMvt * mvtSortie.qteMvt), 3), 0) as stockSortie'),
    
            )
            ->where([
                ['tvente_produit.refCategorie', '=', $refCategorie],
                ['tvente_stock_service.refService', '=', $idService]
            ])
            ->groupBy("tvente_stock_service.id", "tvente_stock_service.refService", "tvente_stock_service.refProduit", 
            "designation", "refCategorie", "pu", "Categorie", "qte", "uniteBase","cmup",
            "tvente_stock_service.devise","tvente_stock_service.taux")
            ->orderBy("tvente_produit.designation", "asc")
            ->get();
    

    // Construction de l'output
    
    $output = '';

    // Vérifiez que les deux tableaux ont la même longueur
    if ((count($data1) === count($data2)) && (count($data1) === count($data11)) 
    && (count($data1) === count($data22)))
    {
        for ($i = 0; $i < count($data1); $i++) {
            $row11 = $data11[$i];
            $row22 = $data22[$i];
            $row1 = $data1[$i];
            $row2 = $data2[$i];            

            $totalSortie = floatval($row22->totalSortie);
            $totalEntree = floatval($row11->totalEntree);

            $stockSortie = floatval($row2->stockSortie);            
            $stockEntree = floatval($row1->stockEntree);

            $totalSI = ((floatval($totalEntree)) - (floatval($totalSortie)));
            $totalGEntree = floatval($stockEntree);
            $totalG = floatval($totalSI) + floatval($stockEntree);
            $TGSortie = floatval($stockSortie);
            $totalSF = floatval($totalG) - floatval($stockSortie);
            $totalPT = floatval($totalSF) * floatval($row2->cmup);


            $output .= '
                <tr style="vertical-align:top;">
                    <td style="width:0px;height:24px;"></td>
                    <td></td>
                    <td class="cs8F59FFB2" colspan="2" style="width:165px;height:22px;line-height:15px;text-align:center;vertical-align:middle;">'.$row1->designation.'</td>
                    <td class="cs6F7E55AC" colspan="2" style="width:105px;height:22px;line-height:15px;text-align:center;vertical-align:middle;">'.$totalSI.'$</td>
                    <td class="csE78F4A6" style="width:107px;height:22px;line-height:15px;text-align:center;vertical-align:middle;">'.$totalGEntree.'$ </td>
                    <td class="csD149F8AB" colspan="2" style="width:109px;height:22px;line-height:15px;text-align:center;vertical-align:middle;">'.$totalG.'$</td>
                    <td class="cs4B928201" colspan="2" style="width:109px;height:22px;line-height:15px;text-align:center;vertical-align:middle;">'.$TGSortie.'$</td>
                    <td class="csE78F4A6" style="width:76px;height:22px;line-height:15px;text-align:center;vertical-align:middle;">'.$totalSF.'$</td>                
                    <td class="cs4B928201" colspan="3" style="width:139px;height:22px;line-height:15px;text-align:center;vertical-align:middle;">'.$row2->devise.'</td>
                    <td class="cs6F7E55AC" colspan="2" style="width:133px;height:22px;line-height:15px;text-align:center;vertical-align:middle;">'.$row2->taux.'</td>
                </tr>
            ';   

    }
    } else {
        // Gérer le cas où les tableaux n'ont pas la même longueur
        echo 'Les tableaux ont pas la même longueur.';
    }

    return $output;

}

//========================== LES DETTES DES VENTES ========================================================================
//=========================================================================================================================


//==================== RAPPORT JOURNALIER DES VenteS =================================

public function fetch_rapport_detailvente_dette_date(Request $request)
{
    //

    if ($request->get('date1') && $request->get('date2')) {
        // code...
        $date1 = $request->get('date1');
        $date2 = $request->get('date2');


        $html ='<html><head><meta http-equiv="Content-Type" content="text/html; charset=utf-8"/>';
        $html .= $this->printRapportDetailVenteDette($date1, $date2);       
        $html .='<script>window.print()</script>';

        echo($html); 

        
        // $html = $this->printRapportDetailVente($date1, $date2);
        // $pdf = \App::make('dompdf.wrapper');
        // $pdf->loadHTML($html)->setPaper('a4', 'landscape');
        // return $pdf->stream();            

    } else {
        // code...
    }
    
    
}

function printRapportDetailVenteDette($date1, $date2)
{

         //Info Entreprise
         $nomEse='';
         $adresseEse='';
         $Tel1Ese='';
         $Tel2Ese='';
         $siteEse='';
         $emailEse='';
         $idNatEse='';
         $numImpotEse='';
         $rccEse='';
         $siege='';
         $busnessName='';
         $pic='';
         $pic2 = $this->displayImg("fichier", 'logo.png');
         $logo='';
 
         $data1 = DB::table('entreprises')
         ->join('secteurs','secteurs.id','=','entreprises.idsecteur')
         ->join('forme_juridiques','forme_juridiques.id','=','entreprises.idforme')
 
         ->join('pays','pays.id','=','entreprises.idPays')
         ->join('provinces','provinces.id','=','entreprises.idProvince')
         ->join('users','users.id','=','entreprises.ceo')        
         ->select('entreprises.id as id','entreprises.id as idEntreprise',
         'entreprises.ceo','entreprises.nomEntreprise','entreprises.descriptionEntreprise',
         'entreprises.emailEntreprise','entreprises.adresseEntreprise',
         'entreprises.telephoneEntreprise','entreprises.solutionEntreprise','entreprises.idsecteur',
         'entreprises.idforme','entreprises.etat',
         'entreprises.idPays','entreprises.idProvince','entreprises.edition','entreprises.facebook',
         'entreprises.linkedin','entreprises.twitter','entreprises.siteweb','entreprises.rccm',
         'entreprises.invPersonnel','entreprises.invHub','entreprises.invRecherche',
         'entreprises.chiffreAffaire','entreprises.nbremploye','entreprises.slug','entreprises.logo',
             //forme
             'forme_juridiques.nomForme','secteurs.nomSecteur',
             //users
             'users.name','users.email','users.avatar','users.telephone','users.adresse',
             //
             'provinces.nomProvince','pays.nomPays', 'entreprises.created_at')
         ->get();
         $output='';
         foreach ($data1 as $row) 
         {                                
             $nomEse=$row->nomEntreprise;
             $adresseEse=$row->adresseEntreprise;
             $Tel1Ese=$row->telephoneEntreprise;
             $Tel2Ese=$row->telephone;
             $siteEse=$row->siteweb;
             $emailEse=$row->emailEntreprise;
             $idNatEse=$row->rccm;
             $numImpotEse=$row->rccm;
             $busnessName=$row->nomSecteur;
             $rccmEse=$row->rccm;
             $pic = $this->displayImg("fichier", 'logo.png');
             $siege=$row->nomForme;         
         }
 

         $sommePHT=0;
         $sommeTVA=0;
         $sommePTTF=0;
         // 
         $data2 =  DB::table('tvente_detail_vente')
         ->join('tvente_produit','tvente_produit.id','=','tvente_detail_vente.refProduit')
         ->join('tvente_categorie_produit','tvente_categorie_produit.id','=','tvente_produit.refCategorie')
 
         ->join('tvente_entete_vente','tvente_entete_vente.id','=','tvente_detail_vente.refEnteteVente')        
         ->join('tvente_module','tvente_module.id','=','tvente_entete_vente.module_id')
         ->join('tvente_services','tvente_services.id','=','tvente_entete_vente.refService')
         ->join('tvente_client','tvente_client.id','=','tvente_entete_vente.refClient')
         ->join('tvente_categorie_client','tvente_categorie_client.id','=','tvente_client.refCategieClient')  
         ->join('tfin_ssouscompte as compteclient','compteclient.id','=','tvente_categorie_client.compte_client')

         ->select(DB::raw('ROUND(SUM(((qteVente*puVente) - montantreduction)),4) as sommePHT, 
         ROUND(SUM(montanttva),4) as sommeTVA,
         ROUND(SUM(ROUND(((qteVente*puVente) - montantreduction + montanttva),4)),4) as sommePTTF'))
         ->where([
            ['dateVente','>=', $date1],
            ['dateVente','<=', $date2]
        ])  
        ->whereRaw("ROUND(IFNULL(montant, 0), 3) - ROUND(IFNULL(paie, 0), 3) > 0")  
         ->get(); 
         $output='';
         foreach ($data2 as $row) 
         {                                
            $sommePHT=$row->sommePHT;
            $sommeTVA=$row->sommeTVA;
            $sommePTTF=$row->sommePTTF;                           
         }
          

        $output='
                           <!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Transitional//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd">
            <!-- saved from url=(0016)http://localhost -->
            <html>
            <head>
                <title>rpt_RapportVentes</title>
                <meta HTTP-EQUIV="Content-Type" CONTENT="text/html; charset=utf-8"/>
                <style type="text/css">
                    .csB6F858D0 {color:#000000;background-color:#D6E5F4;border-left-style: none;border-top-style: none;border-right-style: none;border-bottom-style: none;font-family:Times New Roman; font-size:24px; font-weight:bold; font-style:normal; padding-left:2px;padding-right:2px;}
                    .cs18F2469C {color:#000000;background-color:#E0E0E0;border-left:#000000 1px solid;border-top:#000000 1px solid;border-right:#000000 1px solid;border-bottom:#000000 1px solid;font-family:Times New Roman; font-size:10px; font-weight:bold; font-style:normal; }
                    .cs797456E3 {color:#000000;background-color:#E0E0E0;border-left:#000000 1px solid;border-top:#000000 1px solid;border-right-style: none;border-bottom:#000000 1px solid;font-family:Times New Roman; font-size:10px; font-weight:bold; font-style:normal; }
                    .cs20251968 {color:#000000;background-color:#E0E0E0;border-left:#000000 1px solid;border-top:#000000 1px solid;border-right-style: none;border-bottom:#000000 1px solid;font-family:Times New Roman; font-size:13px; font-weight:bold; font-style:normal; }
                    .cs9FE9304F {color:#000000;background-color:#E0E0E0;border-left-style: none;border-top:#000000 1px solid;border-right:#000000 1px solid;border-bottom:#000000 1px solid;font-family:Times New Roman; font-size:13px; font-weight:bold; font-style:normal; }
                    .csFF9B7F36 {color:#000000;background-color:#E0E0E0;border-left-style: none;border-top:#000000 1px solid;border-right-style: none;border-bottom:#000000 1px solid;font-family:Times New Roman; font-size:10px; font-weight:bold; font-style:normal; }
                    .csEAC52FCD {color:#000000;background-color:#E0E0E0;border-left-style: none;border-top:#000000 1px solid;border-right-style: none;border-bottom:#000000 1px solid;font-family:Times New Roman; font-size:13px; font-weight:bold; font-style:normal; }
                    .cs56F73198 {color:#000000;background-color:transparent;border-left:#000000 1px solid;border-top:#000000 1px solid;border-right:#000000 1px solid;border-bottom:#000000 1px solid;font-family:Times New Roman; font-size:16px; font-weight:normal; font-style:normal; padding-left:2px;}
                    .cs8681714E {color:#000000;background-color:transparent;border-left:#000000 1px solid;border-top:#000000 1px solid;border-right-style: none;border-bottom:#000000 1px solid;font-family:Times New Roman; font-size:10px; font-weight:normal; font-style:normal; }
                    .csD06EB5B2 {color:#000000;background-color:transparent;border-left-style: none;border-top:#000000 1px solid;border-right:#000000 1px solid;border-bottom:#000000 1px solid;font-family:Times New Roman; font-size:10px; font-weight:normal; font-style:normal; }
                    .csBFBB3693 {color:#000000;background-color:transparent;border-left-style: none;border-top:#000000 1px solid;border-right-style: none;border-bottom:#000000 1px solid;font-family:Times New Roman; font-size:10px; font-weight:normal; font-style:normal; }
                    .cs612ED82F {color:#000000;background-color:transparent;border-left-style: none;border-top-style: none;border-right-style: none;border-bottom-style: none;font-family:Times New Roman; font-size:12px; font-weight:bold; font-style:normal; padding-left:2px;}
                    .csFFC1C457 {color:#000000;background-color:transparent;border-left-style: none;border-top-style: none;border-right-style: none;border-bottom-style: none;font-family:Times New Roman; font-size:12px; font-weight:normal; font-style:normal; padding-left:2px;}
                    .cs101A94F7 {color:#000000;background-color:transparent;border-left-style: none;border-top-style: none;border-right-style: none;border-bottom-style: none;font-family:Times New Roman; font-size:13px; font-weight:normal; font-style:normal; }
                    .csCE72709D {color:#000000;background-color:transparent;border-left-style: none;border-top-style: none;border-right-style: none;border-bottom-style: none;font-family:Times New Roman; font-size:14px; font-weight:bold; font-style:normal; padding-left:2px;}
                    .cs12FE94AA {color:#000000;background-color:transparent;border-left-style: none;border-top-style: none;border-right-style: none;border-bottom-style: none;font-family:Times New Roman; font-size:14px; font-weight:normal; font-style:normal; padding-left:2px;}
                    .csFBB219FE {color:#000000;background-color:transparent;border-left-style: none;border-top-style: none;border-right-style: none;border-bottom-style: none;font-family:Times New Roman; font-size:18px; font-weight:bold; font-style:normal; padding-left:2px;}
                    .cs739196BC {color:#5C5C5C;background-color:transparent;border-left-style: none;border-top-style: none;border-right-style: none;border-bottom-style: none;font-family:Segoe UI; font-size:11px; font-weight:normal; font-style:normal; }
                    .csF7D3565D {height:0px;width:0px;overflow:hidden;font-size:0px;line-height:0px;}
                </style>
            </head>
            <body leftMargin=10 topMargin=10 rightMargin=10 bottomMargin=10 style="background-color:#FFFFFF">
            <table cellpadding="0" cellspacing="0" border="0" style="border-width:0px;empty-cells:show;width:957px;height:383px;position:relative;">
                <tr>
                    <td style="width:0px;height:0px;"></td>
                    <td style="height:0px;width:10px;"></td>
                    <td style="height:0px;width:3px;"></td>
                    <td style="height:0px;width:84px;"></td>
                    <td style="height:0px;width:51px;"></td>
                    <td style="height:0px;width:71px;"></td>
                    <td style="height:0px;width:51px;"></td>
                    <td style="height:0px;width:73px;"></td>
                    <td style="height:0px;width:66px;"></td>
                    <td style="height:0px;width:82px;"></td>
                    <td style="height:0px;width:179px;"></td>
                    <td style="height:0px;width:24px;"></td>
                    <td style="height:0px;width:13px;"></td>
                    <td style="height:0px;width:17px;"></td>
                    <td style="height:0px;width:23px;"></td>
                    <td style="height:0px;width:30px;"></td>
                    <td style="height:0px;width:42px;"></td>
                    <td style="height:0px;width:49px;"></td>
                    <td style="height:0px;width:31px;"></td>
                    <td style="height:0px;width:58px;"></td>
                </tr>
                <tr style="vertical-align:top;">
                    <td style="width:0px;height:23px;"></td>
                    <td class="cs739196BC" colspan="8" style="width:409px;height:23px;line-height:14px;text-align:center;vertical-align:middle;"></td>
                    <td></td>
                    <td></td>
                    <td></td>
                    <td></td>
                    <td></td>
                    <td></td>
                    <td></td>
                    <td></td>
                    <td></td>
                    <td></td>
                    <td></td>
                </tr>
                <tr style="vertical-align:top;">
                    <td style="width:0px;height:9px;"></td>
                    <td></td>
                    <td></td>
                    <td></td>
                    <td></td>
                    <td></td>
                    <td></td>
                    <td></td>
                    <td></td>
                    <td></td>
                    <td></td>
                    <td></td>
                    <td></td>
                    <td></td>
                    <td></td>
                    <td></td>
                    <td></td>
                    <td></td>
                    <td></td>
                    <td></td>
                </tr>
                <tr style="vertical-align:top;">
                    <td style="width:0px;height:1px;"></td>
                    <td></td>
                    <td class="csFBB219FE" colspan="10" rowspan="2" style="width:682px;height:23px;line-height:21px;text-align:left;vertical-align:middle;"><nobr>'.$nomEse.'</nobr></td>
                    <td></td>
                    <td></td>
                    <td></td>
                    <td></td>
                    <td></td>
                    <td></td>
                    <td></td>
                    <td></td>
                </tr>
                <tr style="vertical-align:top;">
                    <td style="width:0px;height:22px;"></td>
                    <td></td>
                    <td></td>
                    <td></td>
                    <td class="cs101A94F7" colspan="5" rowspan="7" style="width:175px;height:144px;text-align:left;vertical-align:top;"><div style="overflow:hidden;width:175px;height:144px;">
                        <img alt="" src="'.$pic2.'" style="width:175px;height:144px;" /></div>
                    </td>
                    <td></td>
                </tr>
                <tr style="vertical-align:top;">
                    <td style="width:0px;height:22px;"></td>
                    <td></td>
                    <td class="csCE72709D" colspan="10" style="width:682px;height:22px;line-height:15px;text-align:left;vertical-align:middle;"><nobr>'.$busnessName.'</nobr></td>
                    <td></td>
                    <td></td>
                    <td></td>
                </tr>
                <tr style="vertical-align:top;">
                    <td style="width:0px;height:22px;"></td>
                    <td></td>
                    <td class="csCE72709D" colspan="10" style="width:682px;height:22px;line-height:15px;text-align:left;vertical-align:middle;"><nobr>RCCM'.$rccEse.'.&nbsp;ID-NAT.'.$idNatEse.'</nobr></td>
                    <td></td>
                    <td></td>
                    <td></td>
                </tr>
                <tr style="vertical-align:top;">
                    <td style="width:0px;height:22px;"></td>
                    <td></td>
                    <td class="csFFC1C457" colspan="10" style="width:682px;height:22px;line-height:13px;text-align:left;vertical-align:middle;">'.$adresseEse.'</td>
                    <td></td>
                    <td></td>
                    <td></td>
                </tr>
                <tr style="vertical-align:top;">
                    <td style="width:0px;height:22px;"></td>
                    <td></td>
                    <td class="csFFC1C457" colspan="10" style="width:682px;height:22px;line-height:13px;text-align:left;vertical-align:middle;"><nobr>Email&nbsp;:&nbsp;'.$emailEse.'</nobr></td>
                    <td></td>
                    <td></td>
                    <td></td>
                </tr>
                <tr style="vertical-align:top;">
                    <td style="width:0px;height:22px;"></td>
                    <td></td>
                    <td class="csFFC1C457" colspan="10" style="width:682px;height:22px;line-height:13px;text-align:left;vertical-align:middle;"><nobr>Site&nbsp;web&nbsp;:&nbsp;'.$siteEse.'</nobr></td>
                    <td></td>
                    <td></td>
                    <td></td>
                </tr>
                <tr style="vertical-align:top;">
                    <td style="width:0px;height:12px;"></td>
                    <td></td>
                    <td class="cs612ED82F" colspan="10" rowspan="2" style="width:682px;height:23px;line-height:13px;text-align:left;vertical-align:middle;"><nobr>T&#233;l&#233;phone&nbsp;:&nbsp;'.$Tel1Ese.'&nbsp;&nbsp;24h/24</nobr></td>
                    <td></td>
                    <td></td>
                    <td></td>
                </tr>
                <tr style="vertical-align:top;">
                    <td style="width:0px;height:11px;"></td>
                    <td></td>
                    <td></td>
                    <td></td>
                    <td></td>
                    <td></td>
                    <td></td>
                    <td></td>
                    <td></td>
                    <td></td>
                </tr>
                <tr style="vertical-align:top;">
                    <td style="width:0px;height:8px;"></td>
                    <td></td>
                    <td></td>
                    <td></td>
                    <td></td>
                    <td></td>
                    <td></td>
                    <td></td>
                    <td></td>
                    <td></td>
                    <td></td>
                    <td></td>
                    <td></td>
                    <td></td>
                    <td></td>
                    <td></td>
                    <td></td>
                    <td></td>
                    <td></td>
                    <td></td>
                </tr>
                <tr style="vertical-align:top;">
                    <td style="width:0px;height:32px;"></td>
                    <td></td>
                    <td></td>
                    <td></td>
                    <td></td>
                    <td class="csB6F858D0" colspan="11" style="width:625px;height:32px;line-height:28px;text-align:center;vertical-align:middle;"><nobr>RAPPORT&nbsp;JOURNALIER&nbsp;DES&nbsp;VENTES</nobr></td>
                    <td></td>
                    <td></td>
                    <td></td>
                    <td></td>
                </tr>
                <tr style="vertical-align:top;">
                    <td style="width:0px;height:19px;"></td>
                    <td></td>
                    <td></td>
                    <td></td>
                    <td></td>
                    <td></td>
                    <td></td>
                    <td></td>
                    <td></td>
                    <td></td>
                    <td></td>
                    <td></td>
                    <td></td>
                    <td></td>
                    <td></td>
                    <td></td>
                    <td></td>
                    <td></td>
                    <td></td>
                    <td></td>
                </tr>
                <tr style="vertical-align:top;">
                    <td style="width:0px;height:23px;"></td>
                    <td></td>
                    <td class="cs56F73198" colspan="6" style="width:329px;height:21px;line-height:18px;text-align:left;vertical-align:top;"><nobr>&nbsp;PERIODE&nbsp;:&nbsp;&nbsp;Du&nbsp;&nbsp;'.$date1.'&nbsp;&nbsp;au&nbsp;'.$date2.'</nobr></td>
                    <td class="cs56F73198" colspan="12" style="width:610px;height:21px;line-height:18px;text-align:left;vertical-align:top;"><nobr>--</nobr></td>
                </tr>
                <tr style="vertical-align:top;">
                    <td style="width:0px;height:9px;"></td>
                    <td></td>
                    <td></td>
                    <td></td>
                    <td></td>
                    <td></td>
                    <td></td>
                    <td></td>
                    <td></td>
                    <td></td>
                    <td></td>
                    <td></td>
                    <td></td>
                    <td></td>
                    <td></td>
                    <td></td>
                    <td></td>
                    <td></td>
                    <td></td>
                    <td></td>
                </tr>
                <tr style="vertical-align:top;">
                    <td style="width:0px;height:24px;"></td>
                    <td></td>
                    <td></td>
                    <td class="cs9FE9304F" style="width:83px;height:22px;line-height:15px;text-align:center;vertical-align:middle;"><nobr>N&#176;&nbsp;FACTURE</nobr></td>
                    <td class="cs9FE9304F" colspan="3" style="width:172px;height:22px;line-height:15px;text-align:center;vertical-align:middle;"><nobr>CLIENT</nobr></td>
                    <td class="cs9FE9304F" style="width:72px;height:22px;line-height:15px;text-align:center;vertical-align:middle;"><nobr>DATE</nobr></td>
                    <td class="cs9FE9304F" colspan="2" style="width:147px;height:22px;line-height:15px;text-align:center;vertical-align:middle;"><nobr>CATEGORIE&nbsp;PROD.</nobr></td>
                    <td class="cs9FE9304F" style="width:178px;height:22px;line-height:15px;text-align:center;vertical-align:middle;"><nobr>ARTICLE</nobr></td>
                    <td class="cs9FE9304F" colspan="2" style="width:36px;height:22px;line-height:15px;text-align:center;vertical-align:middle;"><nobr>Qte</nobr></td>
                    <td class="cs9FE9304F" colspan="2" style="width:39px;height:22px;line-height:15px;text-align:center;vertical-align:middle;"><nobr>PU</nobr></td>
                    <td class="csEAC52FCD" colspan="2" style="width:72px;height:22px;line-height:15px;text-align:center;vertical-align:middle;"><nobr>PHT</nobr></td>
                    <td class="cs20251968" style="width:48px;height:22px;line-height:15px;text-align:center;vertical-align:middle;"><nobr>TVA</nobr></td>
                    <td class="cs20251968" colspan="2" style="width:88px;height:22px;line-height:15px;text-align:center;vertical-align:middle;"><nobr>PTTTC</nobr></td>
                </tr>
                ';

                        $output .= $this->showDetailVenteDette($date1, $date2); 

                        $output.='
                <tr style="vertical-align:top;">
                    <td style="width:0px;height:24px;"></td>
                    <td></td>
                    <td></td>
                    <td></td>
                    <td></td>
                    <td></td>
                    <td></td>
                    <td></td>
                    <td></td>
                    <td></td>
                    <td></td>
                    <td class="cs18F2469C" colspan="4" style="width:75px;height:22px;line-height:11px;text-align:center;vertical-align:middle;"><nobr>TOTAL&nbsp;($)&nbsp;:</nobr></td>
                    <td class="csFF9B7F36" colspan="2" style="width:72px;height:22px;line-height:11px;text-align:center;vertical-align:middle;"><nobr>'.$sommePHT.'$</nobr></td>
                    <td class="cs797456E3" style="width:48px;height:22px;line-height:11px;text-align:center;vertical-align:middle;"><nobr>'.$sommeTVA.'$</nobr></td>
                    <td class="cs797456E3" colspan="2" style="width:88px;height:22px;line-height:11px;text-align:center;vertical-align:middle;"><nobr>'.$sommePTTF.'$</nobr></td>
                </tr>
                <tr style="vertical-align:top;">
                    <td style="width:0px;height:10px;"></td>
                    <td></td>
                    <td></td>
                    <td></td>
                    <td></td>
                    <td></td>
                    <td></td>
                    <td></td>
                    <td></td>
                    <td></td>
                    <td></td>
                    <td></td>
                    <td></td>
                    <td></td>
                    <td></td>
                    <td></td>
                    <td></td>
                    <td></td>
                    <td></td>
                    <td></td>
                </tr>
                <tr style="vertical-align:top;">
                    <td style="width:0px;height:22px;"></td>
                    <td></td>
                    <td class="cs12FE94AA" colspan="4" style="width:207px;height:22px;line-height:16px;text-align:left;vertical-align:top;"><nobr>Fait&nbsp;&#224;&nbsp;Goma&nbsp;le&nbsp;&nbsp;'.date('Y-m-d').'</nobr></td>
                    <td></td>
                    <td></td>
                    <td></td>
                    <td></td>
                    <td></td>
                    <td></td>
                    <td></td>
                    <td></td>
                    <td></td>
                    <td></td>
                    <td></td>
                    <td></td>
                    <td></td>
                    <td></td>
                </tr>
            </table>
            </body>
            </html>      
        ';  
       
        return $output; 

}

function showDetailVenteDette($date1, $date2)
{
    $data = DB::table('tvente_detail_vente')
    ->join('tvente_produit','tvente_produit.id','=','tvente_detail_vente.refProduit')
    ->join('tvente_categorie_produit','tvente_categorie_produit.id','=','tvente_produit.refCategorie')

    ->join('tvente_entete_vente','tvente_entete_vente.id','=','tvente_detail_vente.refEnteteVente')        
    ->join('tvente_module','tvente_module.id','=','tvente_entete_vente.module_id')
    ->join('tvente_services','tvente_services.id','=','tvente_entete_vente.refService')
    ->join('tvente_client','tvente_client.id','=','tvente_entete_vente.refClient')
    ->join('tvente_categorie_client','tvente_categorie_client.id','=','tvente_client.refCategieClient')  
    // ->join('tfin_ssouscompte as compteclient','compteclient.id','=','tvente_categorie_client.compte_client')

    // ->join('tfin_ssouscompte as comptevente','comptevente.id','=','tvente_categorie_produit.compte_vente')
    // ->join('tfin_ssouscompte as comptevariation','comptevariation.id','=','tvente_categorie_produit.compte_variationstock')
    // ->join('tfin_ssouscompte as compteperte','compteperte.id','=','tvente_categorie_produit.compte_perte')
    // ->join('tfin_ssouscompte as compteproduit','compteproduit.id','=','tvente_categorie_produit.compte_produit')
    // ->join('tfin_ssouscompte as comptedestockage','comptedestockage.id','=','tvente_categorie_produit.compte_destockage')
  

    ->select('tvente_detail_vente.id','refEnteteVente','refProduit','tvente_detail_vente.compte_vente',
    'tvente_detail_vente.compte_variationstock','tvente_detail_vente.compte_perte','tvente_detail_vente.compte_produit',
    'tvente_detail_vente.compte_destockage','puVente','qteVente','uniteVente','puBase','qteBase',
    'tvente_detail_vente.uniteBase','cmupVente','tvente_detail_vente.devise','tvente_detail_vente.taux',
    'montanttva','montantreduction',
    'tvente_detail_vente.active','tvente_detail_vente.author','tvente_detail_vente.refUser',
    'tvente_detail_vente.created_at','idStockService',
    //Produit
    'tvente_produit.designation','tvente_produit.refCategorie','tvente_produit.refUniteBase',
    'tvente_produit.pu','tvente_produit.qte','tvente_produit.cmup','tvente_produit.taux',
    'tvente_produit.Oldcode','tvente_produit.Newcode','tvente_produit.tvaapplique',
    'tvente_produit.estvendable','tvente_categorie_produit.designation as Categorie',
    //client 
    'noms','sexe','contact','mail','adresse','pieceidentite','numeroPiece','dateLivrePiece',
    'lieulivraisonCarte','nationnalite','datenaissance','lieunaissance','profession','occupation',
    'nombreEnfant','dateArriverGoma','arriverPar','refCategieClient','photo','slug',
    "tvente_categorie_client.designation as CategorieClient","compte_client",
    // 'compteclient.refSousCompte','compteclient.nom_ssouscompte','compteclient.numero_ssouscompte',
    //ente vente
    'nom_service', "tvente_module.nom_module",'tvente_entete_vente.code','refClient','refService','refReservation','module_id',
    'dateVente','libelle','tvente_entete_vente.montant','tvente_entete_vente.paie','reduction',
    'tvente_categorie_produit.designation as Categorie','totaltva',
    //compte produit
    // 'comptevente.refSousCompte as refSousCompteVente','comptevente.nom_ssouscompte as nom_ssouscompteVente',
    // 'comptevente.numero_ssouscompte as numero_ssouscompteVente'
    // ,'comptevariation.refSousCompte as refSousCompteVariation','comptevariation.nom_ssouscompte as nom_ssouscompteVariation',
    // 'comptevariation.numero_ssouscompte as numero_ssouscompteVariation'
    // ,'compteperte.refSousCompte as refSousComptePerte','compteperte.nom_ssouscompte as nom_ssouscomptePerte',
    // 'compteperte.numero_ssouscompte as numero_ssouscomptePerte'
    // ,'compteproduit.refSousCompte as refSousCompteProduit','compteproduit.nom_ssouscompte as nom_ssouscompteProduit',
    // 'compteproduit.numero_ssouscompte as numero_ssouscompteProduit'
    // ,'comptedestockage.refSousCompte as refSousCompteDestockage','comptedestockage.nom_ssouscompte as nom_ssouscompteDestockage',
    // 'comptedestockage.numero_ssouscompte as numero_ssouscompteDestockage',
    'priseencharge')
   ->selectRaw('ROUND(((qteVente*puVente) - montantreduction),2) as PTVente')
   ->selectRaw('ROUND(((qteVente*puVente) - montantreduction + montanttva),2) as PTVenteTVA')
   ->selectRaw('ROUND((IFNULL(montant,0)),2) as totalFacture')
   ->selectRaw('ROUND((montanttva),2) as TotalTVA')
   ->selectRaw('ROUND((((IFNULL(montant,0)) - montantreduction)+(montanttva)),2) as PTTTC')
   ->selectRaw('((qteVente*puVente)/tvente_detail_vente.taux) as PTVenteFC')
   ->selectRaw('(qteBase*puBase) as PTBase')
   ->selectRaw('IFNULL(paie,0) as totalPaie')
   ->selectRaw('(IFNULL(montant,0)-IFNULL(paie,0)) as RestePaie')
   ->selectRaw('CONCAT("S",YEAR(dateVente),"",MONTH(dateVente),"00",refEnteteVente) as codeFacture')
    ->where([
        ['dateVente','>=', $date1],
        ['dateVente','<=', $date2]
    ])
    ->whereRaw("ROUND(IFNULL(montant, 0), 3) - ROUND(IFNULL(paie, 0), 3) > 0")
    ->orderBy("tvente_detail_vente.created_at", "asc")
    ->get();

    $output='';

    foreach ($data as $row) 
    { 

        $output .='
            <tr style="vertical-align:top;">
                <td style="width:0px;height:24px;"></td>
                <td></td>
                <td></td>
                <td class="csD06EB5B2" style="width:83px;height:22px;line-height:11px;text-align:center;vertical-align:middle;">'.$row->codeFacture.'</td>
                <td class="csD06EB5B2" colspan="3" style="width:172px;height:22px;line-height:11px;text-align:left;vertical-align:middle;">'.$row->noms.'</td>
                <td class="csD06EB5B2" style="width:72px;height:22px;line-height:11px;text-align:center;vertical-align:middle;">'.$row->dateVente.'</td>
                <td class="csD06EB5B2" colspan="2" style="width:147px;height:22px;line-height:11px;text-align:left;vertical-align:middle;">'.$row->Categorie.'</td>
                <td class="csD06EB5B2" style="width:178px;height:22px;line-height:11px;text-align:left;vertical-align:middle;">'.$row->designation.'</td>
                <td class="csD06EB5B2" colspan="2" style="width:36px;height:22px;line-height:11px;text-align:center;vertical-align:middle;">'.$row->qteVente.'</td>
                <td class="csD06EB5B2" colspan="2" style="width:39px;height:22px;line-height:11px;text-align:center;vertical-align:middle;">'.$row->puVente.'$</td>
                <td class="csBFBB3693" colspan="2" style="width:72px;height:22px;line-height:11px;text-align:center;vertical-align:middle;">'.$row->PTVente.'$</td>
                <td class="cs8681714E" style="width:48px;height:22px;line-height:11px;text-align:center;vertical-align:middle;">'.$row->montanttva.'$</td>
                <td class="cs8681714E" colspan="2" style="width:88px;height:22px;line-height:11px;text-align:center;vertical-align:middle;">'.$row->PTVenteTVA.'$</td>
            </tr>
        ';  
   
    }

    return $output;

}



////==================================================================================================================================
//=================== FICHE DE STOCK PAR GRANDE UNITE ================================================================================

function pdf_fiche_stock_vente_unite(Request $request)
{

    if ($request->get('date1') && $request->get('date2')) {
        // code...
        $date1 = $request->get('date1');
        $date2 = $request->get('date2');
        
        
        // $html = $this->getInfoFicheStockUnite($date1,$date2);
        // $pdf = \App::make('dompdf.wrapper');

        // $pdf->loadHTML($html);
        // $pdf->loadHTML($html)->setPaper('a4', 'landscape');
        // return $pdf->stream();


        $html ='<html><head><meta http-equiv="Content-Type" content="text/html; charset=utf-8"/>';
        $html .= $this->getInfoFicheStockUnite($date1,$date2);       
        $html .='<script>window.print()</script>';

        echo($html);
        
    }
    else{
    }    
}
function getInfoFicheStockUnite($date1,$date2)
{
           //Info Entreprise
           $nomEse='';
           $adresseEse='';
           $Tel1Ese='';
           $Tel2Ese='';
           $siteEse='';
           $emailEse='';
           $idNatEse='';
           $numImpotEse='';
           $rccEse='';
           $siege='';
           $busnessName='';
           $pic='';
           $pic2 = $this->displayImg("fichier", 'logo.png');
           $logo='';
   
           $data1 = DB::table('entreprises')
           ->join('secteurs','secteurs.id','=','entreprises.idsecteur')
           ->join('forme_juridiques','forme_juridiques.id','=','entreprises.idforme')
   
           ->join('pays','pays.id','=','entreprises.idPays')
           ->join('provinces','provinces.id','=','entreprises.idProvince')
           ->join('users','users.id','=','entreprises.ceo')        
           ->select('entreprises.id as id','entreprises.id as idEntreprise',
           'entreprises.ceo','entreprises.nomEntreprise','entreprises.descriptionEntreprise',
           'entreprises.emailEntreprise','entreprises.adresseEntreprise',
           'entreprises.telephoneEntreprise','entreprises.solutionEntreprise','entreprises.idsecteur',
           'entreprises.idforme','entreprises.etat',
           'entreprises.idPays','entreprises.idProvince','entreprises.edition','entreprises.facebook',
           'entreprises.linkedin','entreprises.twitter','entreprises.siteweb','entreprises.rccm',
           'entreprises.invPersonnel','entreprises.invHub','entreprises.invRecherche',
           'entreprises.chiffreAffaire','entreprises.nbremploye','entreprises.slug','entreprises.logo',
            //forme
            'forme_juridiques.nomForme','secteurs.nomSecteur',
            //users
            'users.name','users.email','users.avatar','users.telephone','users.adresse',
            //
            'provinces.nomProvince','pays.nomPays', 'entreprises.created_at')
           ->get();
           $output='';
           foreach ($data1 as $row1) 
           {                                
               $nomEse=$row1->nomEntreprise;
               $adresseEse=$row1->adresseEntreprise;
               $Tel1Ese=$row1->telephoneEntreprise;
               $Tel2Ese=$row1->telephone;
               $siteEse=$row1->siteweb;
               $emailEse=$row1->emailEntreprise;
               $idNatEse=$row1->rccm;
               $numImpotEse=$row1->rccm;
               $busnessName=$row1->nomSecteur;
               $rccmEse=$row1->rccm;
               $pic = $this->displayImg("fichier", 'logo.png');
               $siege=$row1->nomForme;         
           }
           $totalVente=0;  
           $uniteVente=0;
           //
           $data2 = DB::table('tvente_detail_transfert')  
           ->join('tvente_entete_transfert','tvente_entete_transfert.id','=','tvente_detail_transfert.refEnteteTransfert')     
           ->join('tvente_services as servicesOrigine','servicesOrigine.id','=','tvente_entete_transfert.refService')
           ->join('tvente_services as servicesDestination','servicesDestination.id','=','tvente_entete_transfert.refService')
           ->join('tvente_produit','tvente_produit.id','=','tvente_detail_transfert.refProduit')
           ->join('tvente_categorie_produit','tvente_categorie_produit.id','=','tvente_produit.refCategorie')
           ->select(DB::raw('ROUND(SUM((qteTransfert * qteBase) * puBase),0) as TotalFacture'))
           ->where([
               ['tvente_entete_transfert.date_transfert','>=', $date1],
               ['tvente_entete_transfert.date_transfert','<=', $date2]
           ])               
           ->get();

           foreach ($data2 as $row2) 
           {                                
              $totalVente=$row2->TotalFacture;                           
           } 
           $totalVente =0;   
           $output=' 

            <!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Transitional//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd">
            <!-- saved from url=(0016)http://localhost -->
            <html>
            <head>
                <title>FicheStock</title>
                <meta HTTP-EQUIV="Content-Type" CONTENT="text/html; charset=utf-8"/>
                <style type="text/css">
                    .cs1B222893 {color:#000000;background-color:#D6E5F4;border-left:#004000 1px solid;border-top:#004000 1px solid;border-right:#004000 1px solid;border-bottom:#004000 1px solid;font-family:Times New Roman; font-size:27px; font-weight:bold; font-style:normal; padding-left:2px;padding-right:2px;}
                    .cs6F7E55AC {color:#000000;background-color:#D6E5F4;border-left-style: none;border-top:#004000 1px solid;border-right:#004000 1px solid;border-bottom:#004000 1px solid;font-family:Times New Roman; font-size:13px; font-weight:bold; font-style:normal; }
                    .csE0D816CD {color:#000000;background-color:#D6E5F4;border-left-style: none;border-top-style: none;border-right-style: none;border-bottom-style: none;font-family:Times New Roman; font-size:15px; font-weight:bold; font-style:normal; padding-left:2px;padding-right:2px;}
                    .cs8F59FFB2 {color:#000000;background-color:#F5F5F5;border-left:#004000 1px solid;border-top:#004000 1px solid;border-right:#004000 1px solid;border-bottom:#004000 1px solid;font-family:Times New Roman; font-size:13px; font-weight:bold; font-style:normal; }
                    .csF3AA49E4 {color:#000000;background-color:#F5F5F5;border-left-style: none;border-top:#004000 1px solid;border-right:#004000 1px solid;border-bottom:#004000 1px solid;font-family:Times New Roman; font-size:13px; font-weight:bold; font-style:normal; }
                    .csE78F4A6 {color:#000000;background-color:#F5F5F5;border-left-style: none;border-top:#004000 1px solid;border-right:#004000 1px solid;border-bottom:#004000 1px solid;font-family:Times New Roman; font-size:13px; font-weight:normal; font-style:normal; }
                    .cs4B928201 {color:#000000;background-color:#FFFFFF;border-left-style: none;border-top:#004000 1px solid;border-right:#004000 1px solid;border-bottom:#004000 1px solid;font-family:Times New Roman; font-size:13px; font-weight:bold; font-style:normal; }
                    .cs2C96DE68 {color:#000000;background-color:transparent;border-left:#000000 1px solid;border-top:#000000 1px solid;border-right:#000000 1px solid;border-bottom:#000000 1px solid;font-family:Times New Roman; font-size:13px; font-weight:normal; font-style:italic; padding-left:2px;}
                    .csE71035DC {color:#000000;background-color:transparent;border-left:#000000 1px solid;border-top:#000000 1px solid;border-right:#000000 1px solid;border-bottom:#000000 1px solid;font-family:Times New Roman; font-size:13px; font-weight:normal; font-style:normal; }
                    .csAB3AA82A {color:#000000;background-color:transparent;border-left-style: none;border-top:#000000 1px solid;border-right:#000000 1px solid;border-bottom:#000000 1px solid;font-family:Times New Roman; font-size:13px; font-weight:bold; font-style:normal; }
                    .csC73F4F41 {color:#000000;background-color:transparent;border-left-style: none;border-top:#004000 1px solid;border-right:#004000 1px solid;border-bottom:#004000 1px solid;font-family:Times New Roman; font-size:13px; font-weight:bold; font-style:normal; }
                    .csD149F8AB {color:#000000;background-color:transparent;border-left-style: none;border-top:#004000 1px solid;border-right:#004000 1px solid;border-bottom:#004000 1px solid;font-family:Times New Roman; font-size:13px; font-weight:normal; font-style:normal; }
                    .cs612ED82F {color:#000000;background-color:transparent;border-left-style: none;border-top-style: none;border-right-style: none;border-bottom-style: none;font-family:Times New Roman; font-size:12px; font-weight:bold; font-style:normal; padding-left:2px;}
                    .csFFC1C457 {color:#000000;background-color:transparent;border-left-style: none;border-top-style: none;border-right-style: none;border-bottom-style: none;font-family:Times New Roman; font-size:12px; font-weight:normal; font-style:normal; padding-left:2px;}
                    .cs101A94F7 {color:#000000;background-color:transparent;border-left-style: none;border-top-style: none;border-right-style: none;border-bottom-style: none;font-family:Times New Roman; font-size:13px; font-weight:normal; font-style:normal; }
                    .csCE72709D {color:#000000;background-color:transparent;border-left-style: none;border-top-style: none;border-right-style: none;border-bottom-style: none;font-family:Times New Roman; font-size:14px; font-weight:bold; font-style:normal; padding-left:2px;}
                    .csFBB219FE {color:#000000;background-color:transparent;border-left-style: none;border-top-style: none;border-right-style: none;border-bottom-style: none;font-family:Times New Roman; font-size:18px; font-weight:bold; font-style:normal; padding-left:2px;}
                    .cs739196BC {color:#5C5C5C;background-color:transparent;border-left-style: none;border-top-style: none;border-right-style: none;border-bottom-style: none;font-family:Segoe UI; font-size:11px; font-weight:normal; font-style:normal; }
                    .csF7D3565D {height:0px;width:0px;overflow:hidden;font-size:0px;line-height:0px;}
                </style>
            </head>
            <body leftMargin=10 topMargin=10 rightMargin=10 bottomMargin=10 style="background-color:#FFFFFF">
            <table cellpadding="0" cellspacing="0" border="0" style="border-width:0px;empty-cells:show;width:958px;height:352px;position:relative;">
                <tr>
                    <td style="width:0px;height:0px;"></td>
                    <td style="height:0px;width:6px;"></td>
                    <td style="height:0px;width:4px;"></td>
                    <td style="height:0px;width:163px;"></td>
                    <td style="height:0px;width:47px;"></td>
                    <td style="height:0px;width:59px;"></td>
                    <td style="height:0px;width:108px;"></td>
                    <td style="height:0px;width:22px;"></td>
                    <td style="height:0px;width:88px;"></td>
                    <td style="height:0px;width:77px;"></td>
                    <td style="height:0px;width:89px;"></td>
                    <td style="height:0px;width:21px;"></td>
                    <td style="height:0px;width:18px;"></td>
                    <td style="height:0px;width:86px;"></td>
                    <td style="height:0px;width:36px;"></td>
                    <td style="height:0px;width:132px;"></td>
                    <td style="height:0px;width:2px;"></td>
                </tr>
                <tr style="vertical-align:top;">
                    <td style="width:0px;height:23px;"></td>
                    <td></td>
                    <td></td>
                    <td></td>
                    <td></td>
                    <td></td>
                    <td></td>
                    <td></td>
                    <td></td>
                    <td></td>
                    <td></td>
                </tr>
                <tr style="vertical-align:top;">
                    <td style="width:0px;height:3px;"></td>
                    <td></td>
                    <td></td>
                    <td></td>
                    <td></td>
                    <td></td>
                    <td></td>
                    <td></td>
                    <td></td>
                    <td></td>
                    <td></td>
                    <td></td>
                    <td></td>
                    <td></td>
                    <td></td>
                    <td></td>
                    <td></td>
                </tr>
                <tr style="vertical-align:top;">
                    <td style="width:0px;height:10px;"></td>
                    <td></td>
                    <td></td>
                    <td class="csFBB219FE" colspan="10" rowspan="2" style="width:690px;height:23px;line-height:21px;text-align:left;vertical-align:middle;">'.$nomEse.'</td>
                    <td></td>
                    <td></td>
                    <td></td>
                    <td></td>
                </tr>
                <tr style="vertical-align:top;">
                    <td style="width:0px;height:13px;"></td>
                    <td></td>
                    <td></td>
                    <td></td>
                    <td class="cs101A94F7" colspan="2" rowspan="7" style="width:168px;height:144px;text-align:left;vertical-align:top;"><div style="overflow:hidden;width:168px;height:144px;">
                        <img alt="" src="'.$pic2.'" style="width:168px;height:144px;" /></div>
                    </td>
                    <td></td>
                </tr>
                <tr style="vertical-align:top;">
                    <td style="width:0px;height:22px;"></td>
                    <td></td>
                    <td></td>
                    <td class="csCE72709D" colspan="10" style="width:690px;height:22px;line-height:15px;text-align:left;vertical-align:middle;">'.$busnessName.'</td>
                    <td></td>
                    <td></td>
                </tr>
                <tr style="vertical-align:top;">
                    <td style="width:0px;height:22px;"></td>
                    <td></td>
                    <td></td>
                    <td class="csCE72709D" colspan="10" style="width:690px;height:22px;line-height:15px;text-align:left;vertical-align:middle;"><nobr>RCCM'.$rccEse.'.&nbsp;ID-NAT.'.$numImpotEse.'</nobr></td>
                    <td></td>
                    <td></td>
                </tr>
                <tr style="vertical-align:top;">
                    <td style="width:0px;height:22px;"></td>
                    <td></td>
                    <td></td>
                    <td class="csFFC1C457" colspan="10" style="width:690px;height:22px;line-height:13px;text-align:left;vertical-align:middle;">'.$adresseEse.'</td>
                    <td></td>
                    <td></td>
                </tr>
                <tr style="vertical-align:top;">
                    <td style="width:0px;height:22px;"></td>
                    <td></td>
                    <td></td>
                    <td class="csFFC1C457" colspan="10" style="width:690px;height:22px;line-height:13px;text-align:left;vertical-align:middle;"><nobr>Email&nbsp;:&nbsp;'.$emailEse.'</nobr></td>
                    <td></td>
                    <td></td>
                </tr>
                <tr style="vertical-align:top;">
                    <td style="width:0px;height:22px;"></td>
                    <td></td>
                    <td></td>
                    <td class="csFFC1C457" colspan="10" style="width:690px;height:22px;line-height:13px;text-align:left;vertical-align:middle;"><nobr>Site&nbsp;web&nbsp;:&nbsp;'.$siteEse.'</nobr></td>
                    <td></td>
                    <td></td>
                </tr>
                <tr style="vertical-align:top;">
                    <td style="width:0px;height:21px;"></td>
                    <td></td>
                    <td></td>
                    <td class="cs612ED82F" colspan="10" rowspan="2" style="width:690px;height:22px;line-height:13px;text-align:left;vertical-align:middle;"><nobr>T&#233;l&#233;phone&nbsp;:&nbsp;'.$Tel1Ese.'&nbsp;&nbsp;24h/24</nobr></td>
                    <td></td>
                    <td></td>
                </tr>
                <tr style="vertical-align:top;">
                    <td style="width:0px;height:1px;"></td>
                    <td></td>
                    <td></td>
                    <td></td>
                    <td></td>
                    <td></td>
                    <td></td>
                </tr>
                <tr style="vertical-align:top;">
                    <td style="width:0px;height:14px;"></td>
                    <td></td>
                    <td></td>
                    <td></td>
                    <td></td>
                    <td></td>
                    <td></td>
                    <td></td>
                    <td></td>
                    <td></td>
                    <td></td>
                    <td></td>
                    <td></td>
                    <td></td>
                    <td></td>
                    <td></td>
                    <td></td>
                </tr>
                <tr style="vertical-align:top;">
                    <td style="width:0px;height:34px;"></td>
                    <td></td>
                    <td></td>
                    <td></td>
                    <td></td>
                    <td class="cs1B222893" colspan="6" style="width:437px;height:32px;line-height:31px;text-align:center;vertical-align:middle;"><nobr>FICHE&nbsp;DE&nbsp;STOCK</nobr></td>
                    <td></td>
                    <td></td>
                    <td></td>
                    <td></td>
                    <td></td>
                    <td></td>
                </tr>
                <tr style="vertical-align:top;">
                    <td style="width:0px;height:7px;"></td>
                    <td></td>
                    <td></td>
                    <td></td>
                    <td></td>
                    <td></td>
                    <td></td>
                    <td></td>
                    <td></td>
                    <td></td>
                    <td></td>
                    <td></td>
                    <td></td>
                    <td></td>
                    <td></td>
                    <td></td>
                    <td></td>
                </tr>
                <tr style="vertical-align:top;">
                    <td style="width:0px;height:24px;"></td>
                    <td></td>
                    <td class="csE71035DC" colspan="10" style="width:676px;height:22px;line-height:15px;text-align:center;vertical-align:middle;"><nobr>TOTAL&nbsp;VENTE(USD)</nobr></td>
                    <td class="csAB3AA82A" colspan="5" style="width:273px;height:22px;line-height:15px;text-align:center;vertical-align:middle;"><nobr>'.$totalVente.'$</nobr></td>
                </tr>
                <tr style="vertical-align:top;">
                    <td style="width:0px;height:24px;"></td>
                    <td></td>
                    <td class="cs8F59FFB2" colspan="2" style="width:165px;height:22px;line-height:15px;text-align:center;vertical-align:middle;"><nobr>PRODUIT</nobr></td>
                    <td class="cs6F7E55AC" colspan="2" style="width:105px;height:22px;line-height:15px;text-align:center;vertical-align:middle;"><nobr>SI</nobr></td>
                    <td class="csF3AA49E4" style="width:107px;height:22px;line-height:15px;text-align:center;vertical-align:middle;"><nobr>ENTREE</nobr></td>
                    <td class="csC73F4F41" colspan="2" style="width:109px;height:22px;line-height:15px;text-align:center;vertical-align:middle;"><nobr>TOTAL</nobr></td>
                    <td class="cs4B928201" colspan="2" style="width:109px;height:22px;line-height:15px;text-align:center;vertical-align:middle;"><nobr>SORTIE</nobr></td>
                    <td class="csF3AA49E4" style="width:76px;height:22px;line-height:15px;text-align:center;vertical-align:middle;"><nobr>SF</nobr></td>                    
                    <td class="cs4B928201" colspan="3" style="width:139px;height:22px;line-height:15px;text-align:center;vertical-align:middle;"><nobr>PU(USD)</nobr></td>
                    <td class="cs6F7E55AC" colspan="2" style="width:133px;height:22px;line-height:15px;text-align:center;vertical-align:middle;"><nobr>PT(USD)</nobr></td>
                </tr>
                <tr style="vertical-align:top;">
                    <td style="width:0px;height:22px;"></td>
                    <td></td>
                    <td class="cs2C96DE68" colspan="15" style="width:948px;height:20px;line-height:15px;text-align:left;vertical-align:top;"><nobr>'.$date1.'</nobr></td>
                </tr>
                ';
                                                                
                   $output .= $this->showCategorieFicheStockUnite($date1,$date2); 
                                                                
                 $output.='
            </table>
            </body>
            </html>

            '; 

    return $output;

} 
function showCategorieFicheStockUnite($date1,$date2)
{
    $data = DB::table("tvente_categorie_produit")
    ->select("tvente_categorie_produit.id", "tvente_categorie_produit.designation", 
    "tvente_categorie_produit.created_at", "tvente_categorie_produit.author")
    ->orderBy("tvente_categorie_produit.designation", "asc")
    ->get();
    
    $output='';

    foreach ($data as $row) 
    {
        $output .='
                <tr style="vertical-align:top;">
                <td style="width:0px;height:22px;"></td>
                <td></td>
                <td class="csE0D816CD" colspan="15" style="width:948px;height:22px;line-height:17px;text-align:center;vertical-align:middle;">'.$row->designation.'</td>
            </tr>
            ';
                                                    
                $output .= $this->showDetailFicheStockUnite($date1,$date2,$row->id);                                                     
                $output.='
        ';      
    }

    return $output;

}




//===================== FICHE STOCK PAR GRANDE UNITE PAR CATEGORIE ===========================================================


function pdf_fiche_stock_vente_categorie_unite(Request $request)
{

    if ($request->get('date1') && $request->get('date2')&& $request->get('idCategorie')) {
        // code...
        $date1 = $request->get('date1');
        $date2 = $request->get('date2');
        $idCategorie = $request->get('idCategorie');
        
        // $html = $this->getInfoFicheStockCategorieUnite($date1,$date2,$idCategorie);
        // $pdf = \App::make('dompdf.wrapper');

        // $pdf->loadHTML($html);
        // $pdf->loadHTML($html)->setPaper('a4', 'landscape');
        // return $pdf->stream();

        $html ='<html><head><meta http-equiv="Content-Type" content="text/html; charset=utf-8"/>';
        $html .= $this->getInfoFicheStockCategorieUnite($date1,$date2,$idCategorie);       
        $html .='<script>window.print()</script>';

        echo($html);
        
    }
    else{
    }    
}
function getInfoFicheStockCategorieUnite($date1,$date2,$idCategorie)
{
           //Info Entreprise
           $nomEse='';
           $adresseEse='';
           $Tel1Ese='';
           $Tel2Ese='';
           $siteEse='';
           $emailEse='';
           $idNatEse='';
           $numImpotEse='';
           $rccEse='';
           $siege='';
           $busnessName='';
           $pic='';
           $pic2 = $this->displayImg("fichier", 'logo.png');
           $logo='';
   
           $data1 = DB::table('entreprises')
           ->join('secteurs','secteurs.id','=','entreprises.idsecteur')
           ->join('forme_juridiques','forme_juridiques.id','=','entreprises.idforme')
   
           ->join('pays','pays.id','=','entreprises.idPays')
           ->join('provinces','provinces.id','=','entreprises.idProvince')
           ->join('users','users.id','=','entreprises.ceo')        
           ->select('entreprises.id as id','entreprises.id as idEntreprise',
           'entreprises.ceo','entreprises.nomEntreprise','entreprises.descriptionEntreprise',
           'entreprises.emailEntreprise','entreprises.adresseEntreprise',
           'entreprises.telephoneEntreprise','entreprises.solutionEntreprise','entreprises.idsecteur',
           'entreprises.idforme','entreprises.etat',
           'entreprises.idPays','entreprises.idProvince','entreprises.edition','entreprises.facebook',
           'entreprises.linkedin','entreprises.twitter','entreprises.siteweb','entreprises.rccm',
           'entreprises.invPersonnel','entreprises.invHub','entreprises.invRecherche',
           'entreprises.chiffreAffaire','entreprises.nbremploye','entreprises.slug','entreprises.logo',
            //forme
            'forme_juridiques.nomForme','secteurs.nomSecteur',
            //users
            'users.name','users.email','users.avatar','users.telephone','users.adresse',
            //
            'provinces.nomProvince','pays.nomPays', 'entreprises.created_at')
           ->get();
           $output='';
           foreach ($data1 as $row1) 
           {                                
               $nomEse=$row1->nomEntreprise;
               $adresseEse=$row1->adresseEntreprise;
               $Tel1Ese=$row1->telephoneEntreprise;
               $Tel2Ese=$row1->telephone;
               $siteEse=$row1->siteweb;
               $emailEse=$row1->emailEntreprise;
               $idNatEse=$row1->rccm;
               $numImpotEse=$row1->rccm;
               $busnessName=$row1->nomSecteur;
               $rccmEse=$row1->rccm;
               $pic = $this->displayImg("fichier", 'logo.png');
               $siege=$row1->nomForme;         
           }

           $totalVente=0;  
           $uniteVente=0;
           //
           $data2 = DB::table('tvente_detail_transfert')  
           ->join('tvente_entete_transfert','tvente_entete_transfert.id','=','tvente_detail_transfert.refEnteteTransfert')     
           ->join('tvente_services as servicesOrigine','servicesOrigine.id','=','tvente_entete_transfert.refService')
           ->join('tvente_services as servicesDestination','servicesDestination.id','=','tvente_entete_transfert.refService')
           ->join('tvente_produit','tvente_produit.id','=','tvente_detail_transfert.refProduit')
           ->join('tvente_categorie_produit','tvente_categorie_produit.id','=','tvente_produit.refCategorie')
           ->select(DB::raw('ROUND(SUM((qteTransfert * qteBase) * puBase),0) as TotalFacture'))
           ->where([
               ['tvente_entete_transfert.date_transfert','>=', $date1],
               ['tvente_entete_transfert.date_transfert','<=', $date2],
               ['tvente_categorie_produit.id','=', $idCategorie]
           ])               
           ->get();

           foreach ($data2 as $row2) 
           {                                
              $totalVente=$row2->TotalFacture;                           
           }

           $totalVente =0; 
    
            $output=' 

            <!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Transitional//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd">
            <!-- saved from url=(0016)http://localhost -->
            <html>
            <head>
                <title>FicheStock</title>
                <meta HTTP-EQUIV="Content-Type" CONTENT="text/html; charset=utf-8"/>
                <style type="text/css">
                    .cs1B222893 {color:#000000;background-color:#D6E5F4;border-left:#004000 1px solid;border-top:#004000 1px solid;border-right:#004000 1px solid;border-bottom:#004000 1px solid;font-family:Times New Roman; font-size:27px; font-weight:bold; font-style:normal; padding-left:2px;padding-right:2px;}
                    .cs6F7E55AC {color:#000000;background-color:#D6E5F4;border-left-style: none;border-top:#004000 1px solid;border-right:#004000 1px solid;border-bottom:#004000 1px solid;font-family:Times New Roman; font-size:13px; font-weight:bold; font-style:normal; }
                    .csE0D816CD {color:#000000;background-color:#D6E5F4;border-left-style: none;border-top-style: none;border-right-style: none;border-bottom-style: none;font-family:Times New Roman; font-size:15px; font-weight:bold; font-style:normal; padding-left:2px;padding-right:2px;}
                    .cs8F59FFB2 {color:#000000;background-color:#F5F5F5;border-left:#004000 1px solid;border-top:#004000 1px solid;border-right:#004000 1px solid;border-bottom:#004000 1px solid;font-family:Times New Roman; font-size:13px; font-weight:bold; font-style:normal; }
                    .csF3AA49E4 {color:#000000;background-color:#F5F5F5;border-left-style: none;border-top:#004000 1px solid;border-right:#004000 1px solid;border-bottom:#004000 1px solid;font-family:Times New Roman; font-size:13px; font-weight:bold; font-style:normal; }
                    .csE78F4A6 {color:#000000;background-color:#F5F5F5;border-left-style: none;border-top:#004000 1px solid;border-right:#004000 1px solid;border-bottom:#004000 1px solid;font-family:Times New Roman; font-size:13px; font-weight:normal; font-style:normal; }
                    .cs4B928201 {color:#000000;background-color:#FFFFFF;border-left-style: none;border-top:#004000 1px solid;border-right:#004000 1px solid;border-bottom:#004000 1px solid;font-family:Times New Roman; font-size:13px; font-weight:bold; font-style:normal; }
                    .cs2C96DE68 {color:#000000;background-color:transparent;border-left:#000000 1px solid;border-top:#000000 1px solid;border-right:#000000 1px solid;border-bottom:#000000 1px solid;font-family:Times New Roman; font-size:13px; font-weight:normal; font-style:italic; padding-left:2px;}
                    .csE71035DC {color:#000000;background-color:transparent;border-left:#000000 1px solid;border-top:#000000 1px solid;border-right:#000000 1px solid;border-bottom:#000000 1px solid;font-family:Times New Roman; font-size:13px; font-weight:normal; font-style:normal; }
                    .csAB3AA82A {color:#000000;background-color:transparent;border-left-style: none;border-top:#000000 1px solid;border-right:#000000 1px solid;border-bottom:#000000 1px solid;font-family:Times New Roman; font-size:13px; font-weight:bold; font-style:normal; }
                    .csC73F4F41 {color:#000000;background-color:transparent;border-left-style: none;border-top:#004000 1px solid;border-right:#004000 1px solid;border-bottom:#004000 1px solid;font-family:Times New Roman; font-size:13px; font-weight:bold; font-style:normal; }
                    .csD149F8AB {color:#000000;background-color:transparent;border-left-style: none;border-top:#004000 1px solid;border-right:#004000 1px solid;border-bottom:#004000 1px solid;font-family:Times New Roman; font-size:13px; font-weight:normal; font-style:normal; }
                    .cs612ED82F {color:#000000;background-color:transparent;border-left-style: none;border-top-style: none;border-right-style: none;border-bottom-style: none;font-family:Times New Roman; font-size:12px; font-weight:bold; font-style:normal; padding-left:2px;}
                    .csFFC1C457 {color:#000000;background-color:transparent;border-left-style: none;border-top-style: none;border-right-style: none;border-bottom-style: none;font-family:Times New Roman; font-size:12px; font-weight:normal; font-style:normal; padding-left:2px;}
                    .cs101A94F7 {color:#000000;background-color:transparent;border-left-style: none;border-top-style: none;border-right-style: none;border-bottom-style: none;font-family:Times New Roman; font-size:13px; font-weight:normal; font-style:normal; }
                    .csCE72709D {color:#000000;background-color:transparent;border-left-style: none;border-top-style: none;border-right-style: none;border-bottom-style: none;font-family:Times New Roman; font-size:14px; font-weight:bold; font-style:normal; padding-left:2px;}
                    .csFBB219FE {color:#000000;background-color:transparent;border-left-style: none;border-top-style: none;border-right-style: none;border-bottom-style: none;font-family:Times New Roman; font-size:18px; font-weight:bold; font-style:normal; padding-left:2px;}
                    .cs739196BC {color:#5C5C5C;background-color:transparent;border-left-style: none;border-top-style: none;border-right-style: none;border-bottom-style: none;font-family:Segoe UI; font-size:11px; font-weight:normal; font-style:normal; }
                    .csF7D3565D {height:0px;width:0px;overflow:hidden;font-size:0px;line-height:0px;}
                </style>
            </head>
            <body leftMargin=10 topMargin=10 rightMargin=10 bottomMargin=10 style="background-color:#FFFFFF">
            <table cellpadding="0" cellspacing="0" border="0" style="border-width:0px;empty-cells:show;width:958px;height:352px;position:relative;">
                <tr>
                    <td style="width:0px;height:0px;"></td>
                    <td style="height:0px;width:6px;"></td>
                    <td style="height:0px;width:4px;"></td>
                    <td style="height:0px;width:163px;"></td>
                    <td style="height:0px;width:47px;"></td>
                    <td style="height:0px;width:59px;"></td>
                    <td style="height:0px;width:108px;"></td>
                    <td style="height:0px;width:22px;"></td>
                    <td style="height:0px;width:88px;"></td>
                    <td style="height:0px;width:77px;"></td>
                    <td style="height:0px;width:89px;"></td>
                    <td style="height:0px;width:21px;"></td>
                    <td style="height:0px;width:18px;"></td>
                    <td style="height:0px;width:86px;"></td>
                    <td style="height:0px;width:36px;"></td>
                    <td style="height:0px;width:132px;"></td>
                    <td style="height:0px;width:2px;"></td>
                </tr>
                <tr style="vertical-align:top;">
                    <td style="width:0px;height:23px;"></td>
                    <td></td>
                    <td></td>
                    <td></td>
                    <td></td>
                    <td></td>
                    <td></td>
                    <td></td>
                    <td></td>
                    <td></td>
                    <td></td>
                </tr>
                <tr style="vertical-align:top;">
                    <td style="width:0px;height:3px;"></td>
                    <td></td>
                    <td></td>
                    <td></td>
                    <td></td>
                    <td></td>
                    <td></td>
                    <td></td>
                    <td></td>
                    <td></td>
                    <td></td>
                    <td></td>
                    <td></td>
                    <td></td>
                    <td></td>
                    <td></td>
                    <td></td>
                </tr>
                <tr style="vertical-align:top;">
                    <td style="width:0px;height:10px;"></td>
                    <td></td>
                    <td></td>
                    <td class="csFBB219FE" colspan="10" rowspan="2" style="width:690px;height:23px;line-height:21px;text-align:left;vertical-align:middle;">'.$nomEse.'</td>
                    <td></td>
                    <td></td>
                    <td></td>
                    <td></td>
                </tr>
                <tr style="vertical-align:top;">
                    <td style="width:0px;height:13px;"></td>
                    <td></td>
                    <td></td>
                    <td></td>
                    <td class="cs101A94F7" colspan="2" rowspan="7" style="width:168px;height:144px;text-align:left;vertical-align:top;"><div style="overflow:hidden;width:168px;height:144px;">
                        <img alt="" src="'.$pic2.'" style="width:168px;height:144px;" /></div>
                    </td>
                    <td></td>
                </tr>
                <tr style="vertical-align:top;">
                    <td style="width:0px;height:22px;"></td>
                    <td></td>
                    <td></td>
                    <td class="csCE72709D" colspan="10" style="width:690px;height:22px;line-height:15px;text-align:left;vertical-align:middle;">'.$busnessName.'</td>
                    <td></td>
                    <td></td>
                </tr>
                <tr style="vertical-align:top;">
                    <td style="width:0px;height:22px;"></td>
                    <td></td>
                    <td></td>
                    <td class="csCE72709D" colspan="10" style="width:690px;height:22px;line-height:15px;text-align:left;vertical-align:middle;"><nobr>RCCM'.$rccEse.'.&nbsp;ID-NAT.'.$numImpotEse.'</nobr></td>
                    <td></td>
                    <td></td>
                </tr>
                <tr style="vertical-align:top;">
                    <td style="width:0px;height:22px;"></td>
                    <td></td>
                    <td></td>
                    <td class="csFFC1C457" colspan="10" style="width:690px;height:22px;line-height:13px;text-align:left;vertical-align:middle;">'.$adresseEse.'</td>
                    <td></td>
                    <td></td>
                </tr>
                <tr style="vertical-align:top;">
                    <td style="width:0px;height:22px;"></td>
                    <td></td>
                    <td></td>
                    <td class="csFFC1C457" colspan="10" style="width:690px;height:22px;line-height:13px;text-align:left;vertical-align:middle;"><nobr>Email&nbsp;:&nbsp;'.$emailEse.'</nobr></td>
                    <td></td>
                    <td></td>
                </tr>
                <tr style="vertical-align:top;">
                    <td style="width:0px;height:22px;"></td>
                    <td></td>
                    <td></td>
                    <td class="csFFC1C457" colspan="10" style="width:690px;height:22px;line-height:13px;text-align:left;vertical-align:middle;"><nobr>Site&nbsp;web&nbsp;:&nbsp;'.$siteEse.'</nobr></td>
                    <td></td>
                    <td></td>
                </tr>
                <tr style="vertical-align:top;">
                    <td style="width:0px;height:21px;"></td>
                    <td></td>
                    <td></td>
                    <td class="cs612ED82F" colspan="10" rowspan="2" style="width:690px;height:22px;line-height:13px;text-align:left;vertical-align:middle;"><nobr>T&#233;l&#233;phone&nbsp;:&nbsp;'.$Tel1Ese.'&nbsp;&nbsp;24h/24</nobr></td>
                    <td></td>
                    <td></td>
                </tr>
                <tr style="vertical-align:top;">
                    <td style="width:0px;height:1px;"></td>
                    <td></td>
                    <td></td>
                    <td></td>
                    <td></td>
                    <td></td>
                    <td></td>
                </tr>
                <tr style="vertical-align:top;">
                    <td style="width:0px;height:14px;"></td>
                    <td></td>
                    <td></td>
                    <td></td>
                    <td></td>
                    <td></td>
                    <td></td>
                    <td></td>
                    <td></td>
                    <td></td>
                    <td></td>
                    <td></td>
                    <td></td>
                    <td></td>
                    <td></td>
                    <td></td>
                    <td></td>
                </tr>
                <tr style="vertical-align:top;">
                    <td style="width:0px;height:34px;"></td>
                    <td></td>
                    <td></td>
                    <td></td>
                    <td></td>
                    <td class="cs1B222893" colspan="6" style="width:437px;height:32px;line-height:31px;text-align:center;vertical-align:middle;"><nobr>FICHE&nbsp;DE&nbsp;STOCK</nobr></td>
                    <td></td>
                    <td></td>
                    <td></td>
                    <td></td>
                    <td></td>
                    <td></td>
                </tr>
                <tr style="vertical-align:top;">
                    <td style="width:0px;height:7px;"></td>
                    <td></td>
                    <td></td>
                    <td></td>
                    <td></td>
                    <td></td>
                    <td></td>
                    <td></td>
                    <td></td>
                    <td></td>
                    <td></td>
                    <td></td>
                    <td></td>
                    <td></td>
                    <td></td>
                    <td></td>
                    <td></td>
                </tr>
                <tr style="vertical-align:top;">
                    <td style="width:0px;height:24px;"></td>
                    <td></td>
                    <td class="csE71035DC" colspan="10" style="width:676px;height:22px;line-height:15px;text-align:center;vertical-align:middle;"><nobr>TOTAL&nbsp;VENTE(USD)</nobr></td>
                    <td class="csAB3AA82A" colspan="5" style="width:273px;height:22px;line-height:15px;text-align:center;vertical-align:middle;"><nobr>'.$totalVente.'$</nobr></td>
                </tr>
                <tr style="vertical-align:top;">
                    <td style="width:0px;height:24px;"></td>
                    <td></td>
                    <td class="cs8F59FFB2" colspan="2" style="width:165px;height:22px;line-height:15px;text-align:center;vertical-align:middle;"><nobr>PRODUIT</nobr></td>
                    <td class="cs6F7E55AC" colspan="2" style="width:105px;height:22px;line-height:15px;text-align:center;vertical-align:middle;"><nobr>SI</nobr></td>
                    <td class="csF3AA49E4" style="width:107px;height:22px;line-height:15px;text-align:center;vertical-align:middle;"><nobr>ENTREE</nobr></td>
                    <td class="csC73F4F41" colspan="2" style="width:109px;height:22px;line-height:15px;text-align:center;vertical-align:middle;"><nobr>TOTAL</nobr></td>
                    <td class="cs4B928201" colspan="2" style="width:109px;height:22px;line-height:15px;text-align:center;vertical-align:middle;"><nobr>SORTIE</nobr></td>
                    <td class="csF3AA49E4" style="width:76px;height:22px;line-height:15px;text-align:center;vertical-align:middle;"><nobr>SF</nobr></td>                    
                    <td class="cs4B928201" colspan="3" style="width:139px;height:22px;line-height:15px;text-align:center;vertical-align:middle;"><nobr>PU(USD)</nobr></td>
                    <td class="cs6F7E55AC" colspan="2" style="width:133px;height:22px;line-height:15px;text-align:center;vertical-align:middle;"><nobr>PT(USD)</nobr></td>
                </tr>
                <tr style="vertical-align:top;">
                    <td style="width:0px;height:22px;"></td>
                    <td></td>
                    <td class="cs2C96DE68" colspan="15" style="width:948px;height:20px;line-height:15px;text-align:left;vertical-align:top;"><nobr>'.$date1.'</nobr></td>
                </tr>
                ';
                                                                
                   $output .= $this->showCategorieFicheStockCategorieUnite($date1,$date2,$idCategorie); 
                                                                
                 $output.='
            </table>
            </body>
            </html>

            '; 

    return $output;

}
function showCategorieFicheStockCategorieUnite($date1,$date2,$idCategorie)
{
    $data = DB::table("tvente_categorie_produit")
    ->select("tvente_categorie_produit.id", "tvente_categorie_produit.designation", 
    "tvente_categorie_produit.created_at", "tvente_categorie_produit.author")
    ->where([
        ['tvente_categorie_produit.id','=', $idCategorie]
    ])
    ->orderBy("tvente_categorie_produit.designation", "asc")
    ->get();
    
    $output='';

    foreach ($data as $row) 
    {
        $output .='
                <tr style="vertical-align:top;">
                <td style="width:0px;height:22px;"></td>
                <td></td>
                <td class="csE0D816CD" colspan="15" style="width:948px;height:22px;line-height:17px;text-align:center;vertical-align:middle;">'.$row->designation.'</td>
            </tr>
            ';
                                                    
                $output .= $this->showDetailFicheStockUnite($date1,$date2,$row->id);                                                     
                $output.='
        ';      
    }

    return $output;

}
function showDetailFicheStockUnite($date1,$date2,$refCategorie)
{
        // Récupérer les données de stock, mouvements et ventes en une seule requête 
        $data11 = DB::table('tvente_stock_service')
        ->join('tvente_services', 'tvente_services.id', '=', 'tvente_stock_service.refService')
        ->Join('tvente_produit', 'tvente_produit.id', '=', 'tvente_stock_service.refProduit')
        ->Join('tvente_categorie_produit', 'tvente_categorie_produit.id', '=', 'tvente_produit.refCategorie')
    
        ->leftJoin('tvente_mouvement_stock as dtEntree', function ($join) use ($date1, $idService) {
            $join->on('dtEntree.idStockService', '=', 'tvente_stock_service.id')        
                 ->where('dtEntree.type_mouvement', '=', 'Entree')
                 ->where('dtEntree.dateMvt', '<', $date1);
        })
    
            // Utilisez distinct() avant select()
            ->distinct()
            ->select(
                "tvente_stock_service.id",
                'tvente_stock_service.refService',
                'tvente_stock_service.refProduit',
                "tvente_produit.designation as designation",
                "refCategorie",
                "tvente_stock_service.pu",
                "tvente_categorie_produit.designation as Categorie",
                "tvente_stock_service.qte",
                "tvente_stock_service.uniteBase",
                "tvente_stock_service.unitePivot",
                "tvente_stock_service.cmup",
                "tvente_stock_service.qtePivot",
                "tvente_stock_service.cmup",
                "tvente_stock_service.devise",
                "tvente_stock_service.taux",            
                DB::raw('IFNULL(ROUND(SUM(dtEntree.qteBase * dtEntree.qteMvt), 3), 0) as totalEntree'),
    
            )
            ->where([
                ['tvente_produit.refCategorie', '=', $refCategorie],
                ['tvente_stock_service.refService', '=', $idService]
            ])
            ->groupBy("tvente_stock_service.id",
                'tvente_stock_service.refService',
                'tvente_stock_service.refProduit',
                "tvente_produit.designation",
                "refCategorie",
                "tvente_stock_service.pu",
                "tvente_categorie_produit.designation",
                "tvente_stock_service.qte",
                "tvente_stock_service.uniteBase",
                "tvente_stock_service.unitePivot",
                "tvente_stock_service.cmup",
                "tvente_stock_service.qtePivot",
                "tvente_stock_service.cmup",
                "tvente_stock_service.devise",
                "tvente_stock_service.taux")
            ->orderBy("tvente_produit.designation", "asc")
            ->get();
    
    //======================================================================
    
        $data22 = DB::table('tvente_stock_service')
        ->join('tvente_services', 'tvente_services.id', '=', 'tvente_stock_service.refService')
        ->Join('tvente_produit', 'tvente_produit.id', '=', 'tvente_stock_service.refProduit')
        ->Join('tvente_categorie_produit', 'tvente_categorie_produit.id', '=', 'tvente_produit.refCategorie')
    
        ->leftJoin('tvente_mouvement_stock as dtSortie', function ($join) use ($date1, $idService) {
            $join->on('dtSortie.idStockService', '=', 'tvente_stock_service.id')        
                 ->where('dtSortie.type_mouvement', '=', 'Sortie')
                 ->where('dtSortie.dateMvt', '<', $date1);
        })
        // Utilisez distinct() avant select()
        ->distinct()
        ->select(
            "tvente_stock_service.id",
            'tvente_stock_service.refService',
            'tvente_stock_service.refProduit',
            "tvente_produit.designation as designation",
            "refCategorie",
            "tvente_stock_service.pu",
            "tvente_categorie_produit.designation as Categorie",
            "tvente_stock_service.qte",
            "tvente_stock_service.uniteBase",
            "tvente_stock_service.unitePivot",
            "tvente_stock_service.cmup",
            "tvente_stock_service.qtePivot",
            DB::raw('IFNULL(ROUND(SUM(dtSortie.qteBase * dtSortie.qteMvt), 3), 0) as totalSortie')
        )
        ->where([
            ['tvente_produit.refCategorie', '=', $refCategorie],
            ['tvente_stock_service.refService', '=', $idService]
        ])
        ->groupBy(
            "tvente_stock_service.id",
            'tvente_stock_service.refService',
            'tvente_stock_service.refProduit',
            "tvente_produit.designation",
            "refCategorie",
            "tvente_stock_service.pu",
            "tvente_categorie_produit.designation",
            "tvente_stock_service.qte",
            "tvente_stock_service.uniteBase",
            "tvente_stock_service.unitePivot",
            "tvente_stock_service.cmup",
            "tvente_stock_service.qtePivot")
        ->orderBy("tvente_produit.designation", "asc")
        ->get();
    
        // ============ LEs Mouvements =========================================================================
    
            // Récupérer les données de stock, mouvements et ventes en une seule requête 
            $data1 = DB::table('tvente_stock_service')
            ->join('tvente_services', 'tvente_services.id', '=', 'tvente_stock_service.refService')
            ->Join('tvente_produit', 'tvente_produit.id', '=', 'tvente_stock_service.refProduit')
            ->Join('tvente_categorie_produit', 'tvente_categorie_produit.id', '=', 'tvente_produit.refCategorie')
        
            ->leftJoin('tvente_mouvement_stock as mvtEntree', function ($join) use ($date1, $date2, $idService) {
                $join->on('mvtEntree.idStockService', '=', 'tvente_stock_service.id')        
                     ->where('mvtEntree.type_mouvement', '=', 'Entree')
                     ->whereBetween('mvtEntree.dateMvt', [$date1, $date2]);
            })
        
                // Utilisez distinct() avant select() 
                ->distinct()
                ->select(
                    "tvente_stock_service.id",
                    'tvente_stock_service.refService',
                    'tvente_stock_service.refProduit',
                    "tvente_produit.designation as designation",
                    "refCategorie",
                    "tvente_stock_service.pu",
                    "tvente_categorie_produit.designation as Categorie",
                    "tvente_stock_service.qte",
                    "tvente_stock_service.uniteBase",
                    "tvente_stock_service.unitePivot",
                    "tvente_stock_service.cmup",
                    "tvente_stock_service.qtePivot",
                    "tvente_stock_service.cmup","tvente_stock_service.devise","tvente_stock_service.taux",            
                    DB::raw('IFNULL(ROUND(SUM(mvtEntree.qteBase * mvtEntree.qteMvt), 3), 0) as stockEntree'),
        
                )
                ->where([
                    ['tvente_produit.refCategorie', '=', $refCategorie],
                    ['tvente_stock_service.refService', '=', $idService]
                ])
                ->groupBy("tvente_stock_service.id",
                    'tvente_stock_service.refService',
                    'tvente_stock_service.refProduit',
                    "tvente_produit.designation",
                    "refCategorie",
                    "tvente_stock_service.pu",
                    "tvente_categorie_produit.designation",
                    "tvente_stock_service.qte",
                    "tvente_stock_service.uniteBase",
                    "tvente_stock_service.unitePivot",
                    "tvente_stock_service.cmup",
                    "tvente_stock_service.qtePivot",
                    "tvente_stock_service.cmup",
                    "tvente_stock_service.devise",
                    "tvente_stock_service.taux")
                ->orderBy("tvente_produit.designation", "asc")
                ->get();
        
        //======================================================================
        
            // Récupérer les données de stock, mouvements et ventes en une seule requête 
            $data2 = DB::table('tvente_stock_service')
            ->join('tvente_services', 'tvente_services.id', '=', 'tvente_stock_service.refService')
            ->Join('tvente_produit', 'tvente_produit.id', '=', 'tvente_stock_service.refProduit')
            ->Join('tvente_categorie_produit', 'tvente_categorie_produit.id', '=', 'tvente_produit.refCategorie')
        
            ->leftJoin('tvente_mouvement_stock as mvtSortie', function ($join) use ($date1, $date2, $idService) {
                $join->on('mvtSortie.idStockService', '=', 'tvente_stock_service.id')        
                     ->where('mvtSortie.type_mouvement', '=', 'Sortie')
                     ->whereBetween('mvtSortie.dateMvt', [$date1, $date2]);
            })
        
                // Utilisez distinct() avant select()
                ->distinct()
                ->select(
                    "tvente_stock_service.id",
                    'tvente_stock_service.refService',
                    'tvente_stock_service.refProduit',
                    "tvente_produit.designation as designation",
                    "refCategorie",
                    "tvente_stock_service.pu",
                    "tvente_categorie_produit.designation as Categorie",
                    "tvente_stock_service.qte",
                    "tvente_stock_service.uniteBase",
                    "tvente_stock_service.unitePivot",
                    "tvente_stock_service.cmup",
                    "tvente_stock_service.qtePivot",
                    "tvente_stock_service.cmup",
                    "tvente_stock_service.devise",
                    "tvente_stock_service.taux",            
                    DB::raw('IFNULL(ROUND(SUM(mvtSortie.qteBase * mvtSortie.qteMvt), 3), 0) as stockSortie'),
        
                )
                ->where([
                    ['tvente_produit.refCategorie', '=', $refCategorie],
                    ['tvente_stock_service.refService', '=', $idService]
                ])
                ->groupBy(
                    "tvente_stock_service.id",
                    'tvente_stock_service.refService',
                    'tvente_stock_service.refProduit',
                    "tvente_produit.designation",
                    "refCategorie",
                    "tvente_stock_service.pu",
                    "tvente_categorie_produit.designation",
                    "tvente_stock_service.qte",
                    "tvente_stock_service.uniteBase",
                    "tvente_stock_service.unitePivot",
                    "tvente_stock_service.cmup",
                    "tvente_stock_service.qtePivot",
                    "tvente_stock_service.cmup",
                    "tvente_stock_service.devise",
                    "tvente_stock_service.taux"
                    )
                ->orderBy("tvente_produit.designation", "asc")
                ->get();
        
    
        // Construction de l'output
        
        $output = '';
    
        // Vérifiez que les deux tableaux ont la même longueur
        if ((count($data1) === count($data2)) && (count($data1) === count($data11)) 
        && (count($data1) === count($data22)))
        {
            for ($i = 0; $i < count($data1); $i++) {
                $row11 = $data11[$i];
                $row22 = $data22[$i];
                $row1 = $data1[$i];
                $row2 = $data2[$i];            
    
                $cmup_data = floatval($this->calculerCoutMoyen($row1->id, $date1, $date2));

                $totalSortie = floatval($row22->totalSortie);
                $totalEntree = floatval($row11->totalEntree);
    
                $stockSortie = floatval($row2->stockSortie);            
                $stockEntree = floatval($row1->stockEntree);
    
                $totalSI = ((floatval($totalEntree)) - (floatval($totalSortie)));
                $totalGEntree = floatval($stockEntree);
                $totalG = floatval($totalSI) + floatval($stockEntree);
                $TGSortie = floatval($stockSortie);
                $totalSF = floatval($totalG) - floatval($stockSortie);
                $cmup_pivot = ((floatval($cmup_data)) * (floatval($row11->qtePivot)));
                $totalPT = floatval($totalSF) * floatval($cmup_pivot);              
    
    
                $output .= '
                    <tr style="vertical-align:top;">
                        <td style="width:0px;height:24px;"></td>
                        <td></td>
                        <td class="cs8F59FFB2" colspan="2" style="width:165px;height:22px;line-height:15px;text-align:center;vertical-align:middle;">'.$row1->designation.'</td>
                        <td class="cs6F7E55AC" colspan="2" style="width:105px;height:22px;line-height:15px;text-align:center;vertical-align:middle;">'.round($totalSI,2).' '.$row1->unitePivot.'</td>
                        <td class="csE78F4A6" style="width:107px;height:22px;line-height:15px;text-align:center;vertical-align:middle;">'.round($totalGEntree,2).' '.$row1->unitePivot.' </td>
                        <td class="csD149F8AB" colspan="2" style="width:109px;height:22px;line-height:15px;text-align:center;vertical-align:middle;">'.round($totalG,2).' '.$row1->unitePivot.'</td>
                        <td class="cs4B928201" colspan="2" style="width:109px;height:22px;line-height:15px;text-align:center;vertical-align:middle;">'.round($TGSortie,2).' '.$row1->unitePivot.'</td>
                        <td class="csE78F4A6" style="width:76px;height:22px;line-height:15px;text-align:center;vertical-align:middle;">'.round($totalSF,2).' '.$row1->unitePivot.'</td>                
                        <td class="cs4B928201" colspan="3" style="width:139px;height:22px;line-height:15px;text-align:center;vertical-align:middle;">'.round($cmup_pivot,2).'$</td>
                        <td class="cs6F7E55AC" colspan="2" style="width:133px;height:22px;line-height:15px;text-align:center;vertical-align:middle;">'.round($totalPT,2).'$</td>
                    </tr>
                ';   
    
            }
        } else {
            // Gérer le cas où les tableaux n'ont pas la même longueur
            echo 'Les tableaux ont pas la même longueur.';
        }


   return $output;

}



//=============== FICHE DE STOCK DES SERVICES BY CATEGORIE AVEC GRAANDE UNITE=======================================================================================

function pdf_fiche_stock_vente_service_bycategorie_unite(Request $request)
{

    if ($request->get('date1') && $request->get('date2') && $request->get('idCategorie') && $request->get('idService')) {
        // code...
        $date1 = $request->get('date1');
        $date2 = $request->get('date2');
        $idCategorie = $request->get('idCategorie');
        $idService = $request->get('idService');
        
        // $html = $this->getInfoFicheStockServicesByCategorieUnite($date1,$date2,$idCategorie,$idService);
        // $pdf = \App::make('dompdf.wrapper');

        // $pdf->loadHTML($html);
        // $pdf->loadHTML($html)->setPaper('a4', 'landscape');
        // return $pdf->stream();

        $html ='<html><head><meta http-equiv="Content-Type" content="text/html; charset=utf-8"/>';
        $html .= $this->getInfoFicheStockServicesByCategorieUnite($date1,$date2,$idCategorie,$idService);       
        $html .='<script>window.print()</script>';

        echo($html);
        
    }
    else{
    }    
}

function getInfoFicheStockServicesByCategorieUnite($date1,$date2,$idCategorie,$idService)
{
           //Info Entreprise
           $nomEse='';
           $adresseEse='';
           $Tel1Ese='';
           $Tel2Ese='';
           $siteEse='';
           $emailEse='';
           $idNatEse='';
           $numImpotEse='';
           $rccEse='';
           $siege='';
           $busnessName='';
           $pic='';
           $pic2 = $this->displayImg("fichier", 'logo.png');
           $logo='';
   
           $data1 = DB::table('entreprises')
           ->join('secteurs','secteurs.id','=','entreprises.idsecteur')
           ->join('forme_juridiques','forme_juridiques.id','=','entreprises.idforme')
   
           ->join('pays','pays.id','=','entreprises.idPays')
           ->join('provinces','provinces.id','=','entreprises.idProvince')
           ->join('users','users.id','=','entreprises.ceo')        
           ->select('entreprises.id as id','entreprises.id as idEntreprise',
           'entreprises.ceo','entreprises.nomEntreprise','entreprises.descriptionEntreprise',
           'entreprises.emailEntreprise','entreprises.adresseEntreprise',
           'entreprises.telephoneEntreprise','entreprises.solutionEntreprise','entreprises.idsecteur',
           'entreprises.idforme','entreprises.etat',
           'entreprises.idPays','entreprises.idProvince','entreprises.edition','entreprises.facebook',
           'entreprises.linkedin','entreprises.twitter','entreprises.siteweb','entreprises.rccm',
           'entreprises.invPersonnel','entreprises.invHub','entreprises.invRecherche',
           'entreprises.chiffreAffaire','entreprises.nbremploye','entreprises.slug','entreprises.logo',
            //forme
            'forme_juridiques.nomForme','secteurs.nomSecteur',
            //users
            'users.name','users.email','users.avatar','users.telephone','users.adresse',
            //
            'provinces.nomProvince','pays.nomPays', 'entreprises.created_at')
           ->get();
           $output='';
           foreach ($data1 as $row1) 
           {                                
               $nomEse=$row1->nomEntreprise;
               $adresseEse=$row1->adresseEntreprise;
               $Tel1Ese=$row1->telephoneEntreprise;
               $Tel2Ese=$row1->telephone;
               $siteEse=$row1->siteweb;
               $emailEse=$row1->emailEntreprise;
               $idNatEse=$row1->rccm;
               $numImpotEse=$row1->rccm;
               $busnessName=$row1->nomSecteur;
               $rccmEse=$row1->rccm;
               $pic = $this->displayImg("fichier", 'logo.png');
               $siege=$row1->nomForme;         
           }


           $totalVente = 0;
           $totalTransfert=0;
           $totalCMUP = 0;
           $globalTP=0;

           $data5 = DB::table('tvente_detail_vente')
           ->join('tvente_stock_service','tvente_stock_service.id','=','tvente_detail_vente.idStockService')
           ->join('tvente_produit','tvente_produit.id','=','tvente_stock_service.refProduit')
           ->join('tvente_categorie_produit','tvente_categorie_produit.id','=','tvente_produit.refCategorie')
           ->join('tvente_entete_vente','tvente_entete_vente.id','=','tvente_detail_vente.refEnteteVente')
           ->select(DB::raw('IFNULL(ROUND(SUM(qteVente*puVente),0),0) as totalSortie'))
           ->where([               
               ['tvente_entete_vente.dateVente','>=', $date1],
               ['tvente_entete_vente.dateVente','<=', $date2],
               ['tvente_categorie_produit.id','=', $idCategorie],
               ['tvente_stock_service.refService','=', $idService]
           ])->get(); 
           
           foreach ($data5 as $row5) 
           {                                
              $totalVente=$row5->totalSortie;                           
           }


           $CategorieClient=''; 

           $data3=DB::table('tvente_services')
           ->select('id','nom_service','status','active')
           ->where([
              ['tvente_services.id','=', $idService]
          ])      
          ->get();      
          $output='';
          foreach ($data3 as $row) 
          {
              $CategorieClient=$row->nom_service;              
          }
  
   
            $output=' 

            <!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Transitional//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd">
            <!-- saved from url=(0016)http://localhost -->
            <html>
            <head>
                <title>FicheStock</title>
                <meta HTTP-EQUIV="Content-Type" CONTENT="text/html; charset=utf-8"/>
                <style type="text/css">
                    .cs1B222893 {color:#000000;background-color:#D6E5F4;border-left:#004000 1px solid;border-top:#004000 1px solid;border-right:#004000 1px solid;border-bottom:#004000 1px solid;font-family:Times New Roman; font-size:27px; font-weight:bold; font-style:normal; padding-left:2px;padding-right:2px;}
                    .cs6F7E55AC {color:#000000;background-color:#D6E5F4;border-left-style: none;border-top:#004000 1px solid;border-right:#004000 1px solid;border-bottom:#004000 1px solid;font-family:Times New Roman; font-size:13px; font-weight:bold; font-style:normal; }
                    .csE0D816CD {color:#000000;background-color:#D6E5F4;border-left-style: none;border-top-style: none;border-right-style: none;border-bottom-style: none;font-family:Times New Roman; font-size:15px; font-weight:bold; font-style:normal; padding-left:2px;padding-right:2px;}
                    .cs8F59FFB2 {color:#000000;background-color:#F5F5F5;border-left:#004000 1px solid;border-top:#004000 1px solid;border-right:#004000 1px solid;border-bottom:#004000 1px solid;font-family:Times New Roman; font-size:13px; font-weight:bold; font-style:normal; }
                    .csF3AA49E4 {color:#000000;background-color:#F5F5F5;border-left-style: none;border-top:#004000 1px solid;border-right:#004000 1px solid;border-bottom:#004000 1px solid;font-family:Times New Roman; font-size:13px; font-weight:bold; font-style:normal; }
                    .csE78F4A6 {color:#000000;background-color:#F5F5F5;border-left-style: none;border-top:#004000 1px solid;border-right:#004000 1px solid;border-bottom:#004000 1px solid;font-family:Times New Roman; font-size:13px; font-weight:normal; font-style:normal; }
                    .cs4B928201 {color:#000000;background-color:#FFFFFF;border-left-style: none;border-top:#004000 1px solid;border-right:#004000 1px solid;border-bottom:#004000 1px solid;font-family:Times New Roman; font-size:13px; font-weight:bold; font-style:normal; }
                    .cs2C96DE68 {color:#000000;background-color:transparent;border-left:#000000 1px solid;border-top:#000000 1px solid;border-right:#000000 1px solid;border-bottom:#000000 1px solid;font-family:Times New Roman; font-size:13px; font-weight:normal; font-style:italic; padding-left:2px;}
                    .csE71035DC {color:#000000;background-color:transparent;border-left:#000000 1px solid;border-top:#000000 1px solid;border-right:#000000 1px solid;border-bottom:#000000 1px solid;font-family:Times New Roman; font-size:13px; font-weight:normal; font-style:normal; }
                    .csAB3AA82A {color:#000000;background-color:transparent;border-left-style: none;border-top:#000000 1px solid;border-right:#000000 1px solid;border-bottom:#000000 1px solid;font-family:Times New Roman; font-size:13px; font-weight:bold; font-style:normal; }
                    .csC73F4F41 {color:#000000;background-color:transparent;border-left-style: none;border-top:#004000 1px solid;border-right:#004000 1px solid;border-bottom:#004000 1px solid;font-family:Times New Roman; font-size:13px; font-weight:bold; font-style:normal; }
                    .csD149F8AB {color:#000000;background-color:transparent;border-left-style: none;border-top:#004000 1px solid;border-right:#004000 1px solid;border-bottom:#004000 1px solid;font-family:Times New Roman; font-size:13px; font-weight:normal; font-style:normal; }
                    .cs612ED82F {color:#000000;background-color:transparent;border-left-style: none;border-top-style: none;border-right-style: none;border-bottom-style: none;font-family:Times New Roman; font-size:12px; font-weight:bold; font-style:normal; padding-left:2px;}
                    .csFFC1C457 {color:#000000;background-color:transparent;border-left-style: none;border-top-style: none;border-right-style: none;border-bottom-style: none;font-family:Times New Roman; font-size:12px; font-weight:normal; font-style:normal; padding-left:2px;}
                    .cs101A94F7 {color:#000000;background-color:transparent;border-left-style: none;border-top-style: none;border-right-style: none;border-bottom-style: none;font-family:Times New Roman; font-size:13px; font-weight:normal; font-style:normal; }
                    .csCE72709D {color:#000000;background-color:transparent;border-left-style: none;border-top-style: none;border-right-style: none;border-bottom-style: none;font-family:Times New Roman; font-size:14px; font-weight:bold; font-style:normal; padding-left:2px;}
                    .csFBB219FE {color:#000000;background-color:transparent;border-left-style: none;border-top-style: none;border-right-style: none;border-bottom-style: none;font-family:Times New Roman; font-size:18px; font-weight:bold; font-style:normal; padding-left:2px;}
                    .cs739196BC {color:#5C5C5C;background-color:transparent;border-left-style: none;border-top-style: none;border-right-style: none;border-bottom-style: none;font-family:Segoe UI; font-size:11px; font-weight:normal; font-style:normal; }
                    .csF7D3565D {height:0px;width:0px;overflow:hidden;font-size:0px;line-height:0px;}
                </style>
            </head>
            <body leftMargin=10 topMargin=10 rightMargin=10 bottomMargin=10 style="background-color:#FFFFFF">
            <table cellpadding="0" cellspacing="0" border="0" style="border-width:0px;empty-cells:show;width:958px;height:352px;position:relative;">
                <tr>
                    <td style="width:0px;height:0px;"></td>
                    <td style="height:0px;width:6px;"></td>
                    <td style="height:0px;width:4px;"></td>
                    <td style="height:0px;width:163px;"></td>
                    <td style="height:0px;width:47px;"></td>
                    <td style="height:0px;width:59px;"></td>
                    <td style="height:0px;width:108px;"></td>
                    <td style="height:0px;width:22px;"></td>
                    <td style="height:0px;width:88px;"></td>
                    <td style="height:0px;width:77px;"></td>
                    <td style="height:0px;width:89px;"></td>
                    <td style="height:0px;width:21px;"></td>
                    <td style="height:0px;width:18px;"></td>
                    <td style="height:0px;width:86px;"></td>
                    <td style="height:0px;width:36px;"></td>
                    <td style="height:0px;width:132px;"></td>
                    <td style="height:0px;width:2px;"></td>
                </tr>
                <tr style="vertical-align:top;">
                    <td style="width:0px;height:23px;"></td>
                    <td></td>
                    <td></td>
                    <td></td>
                    <td></td>
                    <td></td>
                    <td></td>
                    <td></td>
                    <td></td>
                    <td></td>
                    <td></td>
                </tr>
                <tr style="vertical-align:top;">
                    <td style="width:0px;height:3px;"></td>
                    <td></td>
                    <td></td>
                    <td></td>
                    <td></td>
                    <td></td>
                    <td></td>
                    <td></td>
                    <td></td>
                    <td></td>
                    <td></td>
                    <td></td>
                    <td></td>
                    <td></td>
                    <td></td>
                    <td></td>
                    <td></td>
                </tr>
                <tr style="vertical-align:top;">
                    <td style="width:0px;height:10px;"></td>
                    <td></td>
                    <td></td>
                    <td class="csFBB219FE" colspan="10" rowspan="2" style="width:690px;height:23px;line-height:21px;text-align:left;vertical-align:middle;">'.$nomEse.'</td>
                    <td></td>
                    <td></td>
                    <td></td>
                    <td></td>
                </tr>
                <tr style="vertical-align:top;">
                    <td style="width:0px;height:13px;"></td>
                    <td></td>
                    <td></td>
                    <td></td>
                    <td class="cs101A94F7" colspan="2" rowspan="7" style="width:168px;height:144px;text-align:left;vertical-align:top;"><div style="overflow:hidden;width:168px;height:144px;">
                        <img alt="" src="'.$pic2.'" style="width:168px;height:144px;" /></div>
                    </td>
                    <td></td>
                </tr>
                <tr style="vertical-align:top;">
                    <td style="width:0px;height:22px;"></td>
                    <td></td>
                    <td></td>
                    <td class="csCE72709D" colspan="10" style="width:690px;height:22px;line-height:15px;text-align:left;vertical-align:middle;">'.$busnessName.'</td>
                    <td></td>
                    <td></td>
                </tr>
                <tr style="vertical-align:top;">
                    <td style="width:0px;height:22px;"></td>
                    <td></td>
                    <td></td>
                    <td class="csCE72709D" colspan="10" style="width:690px;height:22px;line-height:15px;text-align:left;vertical-align:middle;"><nobr>RCCM'.$rccEse.'.&nbsp;ID-NAT.'.$numImpotEse.'</nobr></td>
                    <td></td>
                    <td></td>
                </tr>
                <tr style="vertical-align:top;">
                    <td style="width:0px;height:22px;"></td>
                    <td></td>
                    <td></td>
                    <td class="csFFC1C457" colspan="10" style="width:690px;height:22px;line-height:13px;text-align:left;vertical-align:middle;">'.$adresseEse.'</td>
                    <td></td>
                    <td></td>
                </tr>
                <tr style="vertical-align:top;">
                    <td style="width:0px;height:22px;"></td>
                    <td></td>
                    <td></td>
                    <td class="csFFC1C457" colspan="10" style="width:690px;height:22px;line-height:13px;text-align:left;vertical-align:middle;"><nobr>Email&nbsp;:&nbsp;'.$emailEse.'</nobr></td>
                    <td></td>
                    <td></td>
                </tr>
                <tr style="vertical-align:top;">
                    <td style="width:0px;height:22px;"></td>
                    <td></td>
                    <td></td>
                    <td class="csFFC1C457" colspan="10" style="width:690px;height:22px;line-height:13px;text-align:left;vertical-align:middle;"><nobr>Site&nbsp;web&nbsp;:&nbsp;'.$siteEse.'</nobr></td>
                    <td></td>
                    <td></td>
                </tr>
                <tr style="vertical-align:top;">
                    <td style="width:0px;height:21px;"></td>
                    <td></td>
                    <td></td>
                    <td class="cs612ED82F" colspan="10" rowspan="2" style="width:690px;height:22px;line-height:13px;text-align:left;vertical-align:middle;"><nobr>T&#233;l&#233;phone&nbsp;:&nbsp;'.$Tel1Ese.'&nbsp;&nbsp;24h/24</nobr></td>
                    <td></td>
                    <td></td>
                </tr>
                <tr style="vertical-align:top;">
                    <td style="width:0px;height:1px;"></td>
                    <td></td>
                    <td></td>
                    <td></td>
                    <td></td>
                    <td></td>
                    <td></td>
                </tr>
                <tr style="vertical-align:top;">
                    <td style="width:0px;height:14px;"></td>
                    <td></td>
                    <td></td>
                    <td></td>
                    <td></td>
                    <td></td>
                    <td></td>
                    <td></td>
                    <td></td>
                    <td></td>
                    <td></td>
                    <td></td>
                    <td></td>
                    <td></td>
                    <td></td>
                    <td></td>
                    <td></td>
                </tr>
                <tr style="vertical-align:top;">
                    <td style="width:0px;height:34px;"></td>
                    <td></td>
                    <td></td>
                    <td></td>
                    <td></td>
                    <td class="cs1B222893" colspan="6" style="width:437px;height:32px;line-height:31px;text-align:center;vertical-align:middle;"><nobr>FICHE&nbsp;DE&nbsp;STOCK : '.$CategorieClient.'</nobr></td>
                    <td></td>
                    <td></td>
                    <td></td>
                    <td></td>
                    <td></td>
                    <td></td>
                </tr>
                <tr style="vertical-align:top;">
                    <td style="width:0px;height:7px;"></td>
                    <td></td>
                    <td></td>
                    <td></td>
                    <td></td>
                    <td></td>
                    <td></td>
                    <td></td>
                    <td></td>
                    <td></td>
                    <td></td>
                    <td></td>
                    <td></td>
                    <td></td>
                    <td></td>
                    <td></td>
                    <td></td>
                </tr>
                <tr style="vertical-align:top;">
                    <td style="width:0px;height:24px;"></td>
                    <td></td>
                    <td class="csE71035DC" colspan="10" style="width:676px;height:22px;line-height:15px;text-align:center;vertical-align:middle;"><nobr>TOTAL&nbsp;VENTE(USD)</nobr></td>
                    <td class="csAB3AA82A" colspan="5" style="width:273px;height:22px;line-height:15px;text-align:center;vertical-align:middle;"><nobr>'.$totalVente.'$</nobr></td>
                </tr>
                <tr style="vertical-align:top;">
                    <td style="width:0px;height:24px;"></td>
                    <td></td>
                    <td class="cs8F59FFB2" colspan="2" style="width:165px;height:22px;line-height:15px;text-align:center;vertical-align:middle;"><nobr>PRODUIT</nobr></td>
                    <td class="cs6F7E55AC" colspan="2" style="width:105px;height:22px;line-height:15px;text-align:center;vertical-align:middle;"><nobr>SI</nobr></td>
                    <td class="csF3AA49E4" style="width:107px;height:22px;line-height:15px;text-align:center;vertical-align:middle;"><nobr>ENTREE</nobr></td>
                    <td class="csC73F4F41" colspan="2" style="width:109px;height:22px;line-height:15px;text-align:center;vertical-align:middle;"><nobr>TOTAL</nobr></td>
                    <td class="cs4B928201" colspan="2" style="width:109px;height:22px;line-height:15px;text-align:center;vertical-align:middle;"><nobr>SORTIE</nobr></td>
                    <td class="csF3AA49E4" style="width:76px;height:22px;line-height:15px;text-align:center;vertical-align:middle;"><nobr>SF</nobr></td>                    
                    <td class="cs4B928201" colspan="3" style="width:139px;height:22px;line-height:15px;text-align:center;vertical-align:middle;"><nobr>PU(USD)</nobr></td>
                    <td class="cs6F7E55AC" colspan="2" style="width:133px;height:22px;line-height:15px;text-align:center;vertical-align:middle;"><nobr>PT(USD)</nobr></td>
                </tr>
                <tr style="vertical-align:top;">
                    <td style="width:0px;height:22px;"></td>
                    <td></td>
                    <td class="cs2C96DE68" colspan="15" style="width:948px;height:20px;line-height:15px;text-align:left;vertical-align:top;"><nobr>'.$date1.'</nobr></td>
                </tr>
                ';
                                                                
                   $output .= $this->showCategorieFicheStockServiceByCategorieUnite($date1,$date2,$idCategorie,$idService); 
                                                                
                 $output.='
            </table>
            </body>
            </html>

            '; 

    return $output;

} 

function showCategorieFicheStockServiceByCategorieUnite($date1,$date2,$idCategorie,$idService)
{
    $data = DB::table("tvente_categorie_produit")
    ->select("tvente_categorie_produit.id", "tvente_categorie_produit.designation", 
    "tvente_categorie_produit.created_at", "tvente_categorie_produit.author")
    ->where([
        ['tvente_categorie_produit.id','=', $idCategorie]
    ])
    ->orderBy("tvente_categorie_produit.designation", "asc")
    ->get();
    
    $output='';

    foreach ($data as $row) 
    {
        $output .='
                <tr style="vertical-align:top;">
                <td style="width:0px;height:22px;"></td>
                <td></td>
                <td class="csE0D816CD" colspan="15" style="width:948px;height:22px;line-height:17px;text-align:center;vertical-align:middle;">'.$row->designation.'</td>
            </tr>
            ';
                                                    
                $output .= $this->showDetailFicheStockServiceByCatUnite($date1,$date2,$row->id,$idService);                                                     
                $output.='
        ';      
    }

    return $output;

}

function showDetailFicheStockServiceByCatUnite($date1,$date2,$refCategorie,$idService)
{

    $data11 = DB::table('tvente_stock_service')
    ->join('tvente_services', 'tvente_services.id', '=', 'tvente_stock_service.refService')
    ->Join('tvente_produit', 'tvente_produit.id', '=', 'tvente_stock_service.refProduit')
    ->Join('tvente_categorie_produit', 'tvente_categorie_produit.id', '=', 'tvente_produit.refCategorie')

    ->leftJoin('tvente_mouvement_stock as dtEntree', function ($join) use ($date1, $idService) {
        $join->on('dtEntree.idStockService', '=', 'tvente_stock_service.id')        
             ->where('dtEntree.type_mouvement', '=', 'Entree')
             ->where('dtEntree.dateMvt', '<', $date1);
    })

        // Utilisez distinct() avant select()
        ->distinct()
        ->select(
            "tvente_stock_service.id",
            'tvente_stock_service.refService',
            'tvente_stock_service.refProduit',
            "tvente_produit.designation as designation",
            "refCategorie",
            "tvente_stock_service.pu",
            "tvente_categorie_produit.designation as Categorie",
            "tvente_stock_service.qte",
            "tvente_stock_service.uniteBase",
            "tvente_stock_service.unitePivot",
            "tvente_stock_service.cmup",
            "tvente_stock_service.qtePivot",
            "tvente_stock_service.cmup","tvente_stock_service.devise","tvente_stock_service.taux",            
            DB::raw('IFNULL(ROUND(SUM(dtEntree.qteBase * dtEntree.qteMvt), 3), 0) as totalEntree'),

        )
        ->where([
            ['tvente_produit.refCategorie', '=', $refCategorie],
            ['tvente_stock_service.refService', '=', $idService]
        ])
        ->groupBy("tvente_stock_service.id",
            'tvente_stock_service.refService',
            'tvente_stock_service.refProduit',
            "tvente_produit.designation",
            "refCategorie",
            "tvente_stock_service.pu",
            "tvente_categorie_produit.designation",
            "tvente_stock_service.qte",
            "tvente_stock_service.uniteBase",
            "tvente_stock_service.unitePivot",
            "tvente_stock_service.cmup",
            "tvente_stock_service.qtePivot",
            "tvente_stock_service.cmup","tvente_stock_service.devise","tvente_stock_service.taux")
        ->orderBy("tvente_produit.designation", "asc")
        ->get();

//======================================================================

    $data22 = DB::table('tvente_stock_service')
    ->join('tvente_services', 'tvente_services.id', '=', 'tvente_stock_service.refService')
    ->Join('tvente_produit', 'tvente_produit.id', '=', 'tvente_stock_service.refProduit')
    ->Join('tvente_categorie_produit', 'tvente_categorie_produit.id', '=', 'tvente_produit.refCategorie')

    ->leftJoin('tvente_mouvement_stock as dtSortie', function ($join) use ($date1, $idService) {
        $join->on('dtSortie.idStockService', '=', 'tvente_stock_service.id')        
             ->where('dtSortie.type_mouvement', '=', 'Sortie')
             ->where('dtSortie.dateMvt', '<', $date1);
    })
    // Utilisez distinct() avant select()
    ->distinct()
    ->select(
        "tvente_stock_service.id",
        'tvente_stock_service.refService',
        'tvente_stock_service.refProduit',
        "tvente_produit.designation as designation",
        "refCategorie",
        "tvente_stock_service.pu",
        "tvente_categorie_produit.designation as Categorie",
        "tvente_stock_service.qte",
        "tvente_stock_service.uniteBase",
        "tvente_stock_service.unitePivot",
        "tvente_stock_service.cmup",
        "tvente_stock_service.qtePivot",
        DB::raw('IFNULL(ROUND(SUM(dtSortie.qteBase * dtSortie.qteMvt), 3), 0) as totalSortie')
    )
    ->where([
        ['tvente_produit.refCategorie', '=', $refCategorie],
        ['tvente_stock_service.refService', '=', $idService]
    ])
    ->groupBy("tvente_stock_service.id",
        'tvente_stock_service.refService',
        'tvente_stock_service.refProduit',
        "tvente_produit.designation",
        "refCategorie",
        "tvente_stock_service.pu",
        "tvente_categorie_produit.designation",
        "tvente_stock_service.qte",
        "tvente_stock_service.uniteBase",
        "tvente_stock_service.unitePivot",
        "tvente_stock_service.cmup",
        "tvente_stock_service.qtePivot")
    ->orderBy("tvente_produit.designation", "asc")
    ->get();

    // ============ LEs Mouvements =========================================================================

        // Récupérer les données de stock, mouvements et ventes en une seule requête 
        $data1 = DB::table('tvente_stock_service')
        ->join('tvente_services', 'tvente_services.id', '=', 'tvente_stock_service.refService')
        ->Join('tvente_produit', 'tvente_produit.id', '=', 'tvente_stock_service.refProduit')
        ->Join('tvente_categorie_produit', 'tvente_categorie_produit.id', '=', 'tvente_produit.refCategorie')
    
        ->leftJoin('tvente_mouvement_stock as mvtEntree', function ($join) use ($date1, $date2, $idService) {
            $join->on('mvtEntree.idStockService', '=', 'tvente_stock_service.id')        
                 ->where('mvtEntree.type_mouvement', '=', 'Entree')
                 ->whereBetween('mvtEntree.dateMvt', [$date1, $date2]);
        })
    
            // Utilisez distinct() avant select()
            ->distinct()
            ->select(
                "tvente_stock_service.id",
                'tvente_stock_service.refService',
                'tvente_stock_service.refProduit',
                "tvente_produit.designation as designation",
                "refCategorie",
                "tvente_stock_service.pu",
                "tvente_categorie_produit.designation as Categorie",
                "tvente_stock_service.qte",
                "tvente_stock_service.uniteBase",
                "tvente_stock_service.unitePivot",
                "tvente_stock_service.cmup",
                "tvente_stock_service.qtePivot",
                "tvente_stock_service.cmup","tvente_stock_service.devise","tvente_stock_service.taux",            
                DB::raw('IFNULL(ROUND(SUM(mvtEntree.qteBase * mvtEntree.qteMvt), 3), 0) as stockEntree'),
    
            )
            ->where([
                ['tvente_produit.refCategorie', '=', $refCategorie],
                ['tvente_stock_service.refService', '=', $idService]
            ])
            ->groupBy("tvente_stock_service.id",
                'tvente_stock_service.refService',
                'tvente_stock_service.refProduit',
                "tvente_produit.designation",
                "refCategorie",
                "tvente_stock_service.pu",
                "tvente_categorie_produit.designation",
                "tvente_stock_service.qte",
                "tvente_stock_service.uniteBase",
                "tvente_stock_service.unitePivot",
                "tvente_stock_service.cmup",
                "tvente_stock_service.qtePivot",
                "tvente_stock_service.cmup",
                "tvente_stock_service.devise",
                "tvente_stock_service.taux")
            ->orderBy("tvente_produit.designation", "asc")
            ->get();
    
    //======================================================================
    
        // Récupérer les données de stock, mouvements et ventes en une seule requête 
        $data2 = DB::table('tvente_stock_service')
        ->join('tvente_services', 'tvente_services.id', '=', 'tvente_stock_service.refService')
        ->Join('tvente_produit', 'tvente_produit.id', '=', 'tvente_stock_service.refProduit')
        ->Join('tvente_categorie_produit', 'tvente_categorie_produit.id', '=', 'tvente_produit.refCategorie')
    
        ->leftJoin('tvente_mouvement_stock as mvtSortie', function ($join) use ($date1, $date2, $idService) {
            $join->on('mvtSortie.idStockService', '=', 'tvente_stock_service.id')        
                 ->where('mvtSortie.type_mouvement', '=', 'Sortie')
                 ->whereBetween('mvtSortie.dateMvt', [$date1, $date2]);
        })
    
            // Utilisez distinct() avant select()
            ->distinct()
            ->select(
                "tvente_stock_service.id",
                'tvente_stock_service.refService',
                'tvente_stock_service.refProduit',
                "tvente_produit.designation as designation",
                "refCategorie",
                "tvente_stock_service.pu",
                "tvente_categorie_produit.designation as Categorie",
                "tvente_stock_service.qte",
                "tvente_stock_service.uniteBase",
                "tvente_stock_service.unitePivot",
                "tvente_stock_service.cmup",
                "tvente_stock_service.qtePivot",
                "tvente_stock_service.cmup","tvente_stock_service.devise","tvente_stock_service.taux",            
                DB::raw('IFNULL(ROUND(SUM(mvtSortie.qteBase * mvtSortie.qteMvt), 3), 0) as stockSortie'),
    
            )
            ->where([
                ['tvente_produit.refCategorie', '=', $refCategorie],
                ['tvente_stock_service.refService', '=', $idService]
            ])
            ->groupBy("tvente_stock_service.id",
                'tvente_stock_service.refService',
                'tvente_stock_service.refProduit',
                "tvente_produit.designation",
                "refCategorie",
                "tvente_stock_service.pu",
                "tvente_categorie_produit.designation",
                "tvente_stock_service.qte",
                "tvente_stock_service.uniteBase",
                "tvente_stock_service.unitePivot",
                "tvente_stock_service.cmup",
                "tvente_stock_service.qtePivot",
                "tvente_stock_service.cmup",
                "tvente_stock_service.devise",
                "tvente_stock_service.taux")
            ->orderBy("tvente_produit.designation", "asc")
            ->get();
    

    // Construction de l'output
    
    $output = '';

    // Vérifiez que les deux tableaux ont la même longueur
    if ((count($data1) === count($data2)) && (count($data1) === count($data11)) 
    && (count($data1) === count($data22)))
    {
        for ($i = 0; $i < count($data1); $i++) {
                $row11 = $data11[$i];
                $row22 = $data22[$i];
                $row1 = $data1[$i];
                $row2 = $data2[$i];            
    
                $cmup_data = floatval($this->calculerCoutMoyen($row1->id, $date1, $date2));

                $totalSortie = floatval($row22->totalSortie);
                $totalEntree = floatval($row11->totalEntree);
    
                $stockSortie = floatval($row2->stockSortie);            
                $stockEntree = floatval($row1->stockEntree);
    
                $totalSI = ((floatval($totalEntree)) - (floatval($totalSortie)));
                $totalGEntree = floatval($stockEntree);
                $totalG = floatval($totalSI) + floatval($stockEntree);
                $TGSortie = floatval($stockSortie);
                $totalSF = floatval($totalG) - floatval($stockSortie);
                $cmup_pivot = ((floatval($cmup_data)) * (floatval($row11->qtePivot)));
                $totalPT = (floatval($totalSF)/floatval($row1->qtePivot)) * floatval($cmup_pivot);              
    
    
                $output .= '
                    <tr style="vertical-align:top;">
                        <td style="width:0px;height:24px;"></td>
                        <td></td>
                        <td class="cs8F59FFB2" colspan="2" style="width:165px;height:22px;line-height:15px;text-align:center;vertical-align:middle;">'.$row1->designation.'</td>
                        <td class="cs6F7E55AC" colspan="2" style="width:105px;height:22px;line-height:15px;text-align:center;vertical-align:middle;">'.round((floatval($totalSI)/floatval($row1->qtePivot)),2).' '.$row1->unitePivot.'</td>
                        <td class="csE78F4A6" style="width:107px;height:22px;line-height:15px;text-align:center;vertical-align:middle;">'.round((floatval($totalGEntree)/floatval($row1->qtePivot)),2).' '.$row1->unitePivot.' </td>
                        <td class="csD149F8AB" colspan="2" style="width:109px;height:22px;line-height:15px;text-align:center;vertical-align:middle;">'.round((floatval($totalG)/floatval($row1->qtePivot)),2).' '.$row1->unitePivot.'</td>
                        <td class="cs4B928201" colspan="2" style="width:109px;height:22px;line-height:15px;text-align:center;vertical-align:middle;">'.round((floatval($TGSortie)/floatval($row1->qtePivot)),2).' '.$row1->unitePivot.'</td>
                        <td class="csE78F4A6" style="width:76px;height:22px;line-height:15px;text-align:center;vertical-align:middle;">'.round((floatval($totalSF)/floatval($row1->qtePivot)),2).' '.$row1->unitePivot.'</td>                
                        <td class="cs4B928201" colspan="3" style="width:139px;height:22px;line-height:15px;text-align:center;vertical-align:middle;">'.round($cmup_pivot,2).'$</td>
                        <td class="cs6F7E55AC" colspan="2" style="width:133px;height:22px;line-height:15px;text-align:center;vertical-align:middle;">'.round($totalPT,2).'$</td>
                    </tr>
                ';   
    
            }
    } else {
        // Gérer le cas où les tableaux n'ont pas la même longueur
        echo 'Les tableaux ont pas la même longueur.';
    }

    return $output;

}




function pdf_fiche_stock_vente_service_unite(Request $request)
{

    if ($request->get('date1') && $request->get('date2') && $request->get('idService')) {
        // code...
        $date1 = $request->get('date1');
        $date2 = $request->get('date2');
        $idService = $request->get('idService');
        
        // $html = $this->getInfoFicheStockServicesByUnite($date1,$date2,$idService);
        // $pdf = \App::make('dompdf.wrapper');

        // $pdf->loadHTML($html);
        // $pdf->loadHTML($html)->setPaper('a4', 'landscape');
        // return $pdf->stream();

        $html ='<html><head><meta http-equiv="Content-Type" content="text/html; charset=utf-8"/>';
        $html .= $this->getInfoFicheStockServicesByUnite($date1,$date2,$idService);       
        $html .='<script>window.print()</script>';

        echo($html);
        
    }
    else{
    }    
}

function getInfoFicheStockServicesByUnite($date1,$date2,$idService)
{
           //Info Entreprise
           $nomEse='';
           $adresseEse='';
           $Tel1Ese='';
           $Tel2Ese='';
           $siteEse='';
           $emailEse='';
           $idNatEse='';
           $numImpotEse='';
           $rccEse='';
           $siege='';
           $busnessName='';
           $pic='';
           $pic2 = $this->displayImg("fichier", 'logo.png');
           $logo='';
   
           $data1 = DB::table('entreprises')
           ->join('secteurs','secteurs.id','=','entreprises.idsecteur')
           ->join('forme_juridiques','forme_juridiques.id','=','entreprises.idforme')
   
           ->join('pays','pays.id','=','entreprises.idPays')
           ->join('provinces','provinces.id','=','entreprises.idProvince')
           ->join('users','users.id','=','entreprises.ceo')        
           ->select('entreprises.id as id','entreprises.id as idEntreprise',
           'entreprises.ceo','entreprises.nomEntreprise','entreprises.descriptionEntreprise',
           'entreprises.emailEntreprise','entreprises.adresseEntreprise',
           'entreprises.telephoneEntreprise','entreprises.solutionEntreprise','entreprises.idsecteur',
           'entreprises.idforme','entreprises.etat',
           'entreprises.idPays','entreprises.idProvince','entreprises.edition','entreprises.facebook',
           'entreprises.linkedin','entreprises.twitter','entreprises.siteweb','entreprises.rccm',
           'entreprises.invPersonnel','entreprises.invHub','entreprises.invRecherche',
           'entreprises.chiffreAffaire','entreprises.nbremploye','entreprises.slug','entreprises.logo',
            //forme
            'forme_juridiques.nomForme','secteurs.nomSecteur',
            //users
            'users.name','users.email','users.avatar','users.telephone','users.adresse',
            //
            'provinces.nomProvince','pays.nomPays', 'entreprises.created_at')
           ->get();
           $output='';
           foreach ($data1 as $row1) 
           {                                
               $nomEse=$row1->nomEntreprise;
               $adresseEse=$row1->adresseEntreprise;
               $Tel1Ese=$row1->telephoneEntreprise;
               $Tel2Ese=$row1->telephone;
               $siteEse=$row1->siteweb;
               $emailEse=$row1->emailEntreprise;
               $idNatEse=$row1->rccm;
               $numImpotEse=$row1->rccm;
               $busnessName=$row1->nomSecteur;
               $rccmEse=$row1->rccm;
               $pic = $this->displayImg("fichier", 'logo.png');
               $siege=$row1->nomForme;         
           }


           $totalVente = 0;
           $totalTransfert=0;
           $totalCMUP = 0;
           $globalTP=0;

           $data5 = DB::table('tvente_detail_vente')
           ->join('tvente_stock_service','tvente_stock_service.id','=','tvente_detail_vente.idStockService')
           ->join('tvente_produit','tvente_produit.id','=','tvente_stock_service.refProduit')
           ->join('tvente_categorie_produit','tvente_categorie_produit.id','=','tvente_produit.refCategorie')
           ->join('tvente_entete_vente','tvente_entete_vente.id','=','tvente_detail_vente.refEnteteVente')
           ->select(DB::raw('IFNULL(ROUND(SUM(qteVente*puVente),0),0) as totalSortie'))
           ->where([               
               ['tvente_entete_vente.dateVente','>=', $date1],
               ['tvente_entete_vente.dateVente','<=', $date2],
               ['tvente_stock_service.refService','=', $idService]
           ])->get(); 
           
           foreach ($data5 as $row5) 
           {                                
              $totalVente=$row5->totalSortie;                           
           }


           $CategorieClient=''; 

           $data3=DB::table('tvente_services')
           ->select('id','nom_service','status','active')
           ->where([
              ['tvente_services.id','=', $idService]
          ])      
          ->get();      
          $output='';
          foreach ($data3 as $row) 
          {
              $CategorieClient=$row->nom_service;              
          }
  
   
            $output=' 

            <!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Transitional//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd">
            <!-- saved from url=(0016)http://localhost -->
            <html>
            <head>
                <title>FicheStock</title>
                <meta HTTP-EQUIV="Content-Type" CONTENT="text/html; charset=utf-8"/>
                <style type="text/css">
                    .cs1B222893 {color:#000000;background-color:#D6E5F4;border-left:#004000 1px solid;border-top:#004000 1px solid;border-right:#004000 1px solid;border-bottom:#004000 1px solid;font-family:Times New Roman; font-size:27px; font-weight:bold; font-style:normal; padding-left:2px;padding-right:2px;}
                    .cs6F7E55AC {color:#000000;background-color:#D6E5F4;border-left-style: none;border-top:#004000 1px solid;border-right:#004000 1px solid;border-bottom:#004000 1px solid;font-family:Times New Roman; font-size:13px; font-weight:bold; font-style:normal; }
                    .csE0D816CD {color:#000000;background-color:#D6E5F4;border-left-style: none;border-top-style: none;border-right-style: none;border-bottom-style: none;font-family:Times New Roman; font-size:15px; font-weight:bold; font-style:normal; padding-left:2px;padding-right:2px;}
                    .cs8F59FFB2 {color:#000000;background-color:#F5F5F5;border-left:#004000 1px solid;border-top:#004000 1px solid;border-right:#004000 1px solid;border-bottom:#004000 1px solid;font-family:Times New Roman; font-size:13px; font-weight:bold; font-style:normal; }
                    .csF3AA49E4 {color:#000000;background-color:#F5F5F5;border-left-style: none;border-top:#004000 1px solid;border-right:#004000 1px solid;border-bottom:#004000 1px solid;font-family:Times New Roman; font-size:13px; font-weight:bold; font-style:normal; }
                    .csE78F4A6 {color:#000000;background-color:#F5F5F5;border-left-style: none;border-top:#004000 1px solid;border-right:#004000 1px solid;border-bottom:#004000 1px solid;font-family:Times New Roman; font-size:13px; font-weight:normal; font-style:normal; }
                    .cs4B928201 {color:#000000;background-color:#FFFFFF;border-left-style: none;border-top:#004000 1px solid;border-right:#004000 1px solid;border-bottom:#004000 1px solid;font-family:Times New Roman; font-size:13px; font-weight:bold; font-style:normal; }
                    .cs2C96DE68 {color:#000000;background-color:transparent;border-left:#000000 1px solid;border-top:#000000 1px solid;border-right:#000000 1px solid;border-bottom:#000000 1px solid;font-family:Times New Roman; font-size:13px; font-weight:normal; font-style:italic; padding-left:2px;}
                    .csE71035DC {color:#000000;background-color:transparent;border-left:#000000 1px solid;border-top:#000000 1px solid;border-right:#000000 1px solid;border-bottom:#000000 1px solid;font-family:Times New Roman; font-size:13px; font-weight:normal; font-style:normal; }
                    .csAB3AA82A {color:#000000;background-color:transparent;border-left-style: none;border-top:#000000 1px solid;border-right:#000000 1px solid;border-bottom:#000000 1px solid;font-family:Times New Roman; font-size:13px; font-weight:bold; font-style:normal; }
                    .csC73F4F41 {color:#000000;background-color:transparent;border-left-style: none;border-top:#004000 1px solid;border-right:#004000 1px solid;border-bottom:#004000 1px solid;font-family:Times New Roman; font-size:13px; font-weight:bold; font-style:normal; }
                    .csD149F8AB {color:#000000;background-color:transparent;border-left-style: none;border-top:#004000 1px solid;border-right:#004000 1px solid;border-bottom:#004000 1px solid;font-family:Times New Roman; font-size:13px; font-weight:normal; font-style:normal; }
                    .cs612ED82F {color:#000000;background-color:transparent;border-left-style: none;border-top-style: none;border-right-style: none;border-bottom-style: none;font-family:Times New Roman; font-size:12px; font-weight:bold; font-style:normal; padding-left:2px;}
                    .csFFC1C457 {color:#000000;background-color:transparent;border-left-style: none;border-top-style: none;border-right-style: none;border-bottom-style: none;font-family:Times New Roman; font-size:12px; font-weight:normal; font-style:normal; padding-left:2px;}
                    .cs101A94F7 {color:#000000;background-color:transparent;border-left-style: none;border-top-style: none;border-right-style: none;border-bottom-style: none;font-family:Times New Roman; font-size:13px; font-weight:normal; font-style:normal; }
                    .csCE72709D {color:#000000;background-color:transparent;border-left-style: none;border-top-style: none;border-right-style: none;border-bottom-style: none;font-family:Times New Roman; font-size:14px; font-weight:bold; font-style:normal; padding-left:2px;}
                    .csFBB219FE {color:#000000;background-color:transparent;border-left-style: none;border-top-style: none;border-right-style: none;border-bottom-style: none;font-family:Times New Roman; font-size:18px; font-weight:bold; font-style:normal; padding-left:2px;}
                    .cs739196BC {color:#5C5C5C;background-color:transparent;border-left-style: none;border-top-style: none;border-right-style: none;border-bottom-style: none;font-family:Segoe UI; font-size:11px; font-weight:normal; font-style:normal; }
                    .csF7D3565D {height:0px;width:0px;overflow:hidden;font-size:0px;line-height:0px;}
                </style>
            </head>
            <body leftMargin=10 topMargin=10 rightMargin=10 bottomMargin=10 style="background-color:#FFFFFF">
            <table cellpadding="0" cellspacing="0" border="0" style="border-width:0px;empty-cells:show;width:958px;height:352px;position:relative;">
                <tr>
                    <td style="width:0px;height:0px;"></td>
                    <td style="height:0px;width:6px;"></td>
                    <td style="height:0px;width:4px;"></td>
                    <td style="height:0px;width:163px;"></td>
                    <td style="height:0px;width:47px;"></td>
                    <td style="height:0px;width:59px;"></td>
                    <td style="height:0px;width:108px;"></td>
                    <td style="height:0px;width:22px;"></td>
                    <td style="height:0px;width:88px;"></td>
                    <td style="height:0px;width:77px;"></td>
                    <td style="height:0px;width:89px;"></td>
                    <td style="height:0px;width:21px;"></td>
                    <td style="height:0px;width:18px;"></td>
                    <td style="height:0px;width:86px;"></td>
                    <td style="height:0px;width:36px;"></td>
                    <td style="height:0px;width:132px;"></td>
                    <td style="height:0px;width:2px;"></td>
                </tr>
                <tr style="vertical-align:top;">
                    <td style="width:0px;height:23px;"></td>
                    <td></td>
                    <td></td>
                    <td></td>
                    <td></td>
                    <td></td>
                    <td></td>
                    <td></td>
                    <td></td>
                    <td></td>
                    <td></td>
                </tr>
                <tr style="vertical-align:top;">
                    <td style="width:0px;height:3px;"></td>
                    <td></td>
                    <td></td>
                    <td></td>
                    <td></td>
                    <td></td>
                    <td></td>
                    <td></td>
                    <td></td>
                    <td></td>
                    <td></td>
                    <td></td>
                    <td></td>
                    <td></td>
                    <td></td>
                    <td></td>
                    <td></td>
                </tr>
                <tr style="vertical-align:top;">
                    <td style="width:0px;height:10px;"></td>
                    <td></td>
                    <td></td>
                    <td class="csFBB219FE" colspan="10" rowspan="2" style="width:690px;height:23px;line-height:21px;text-align:left;vertical-align:middle;">'.$nomEse.'</td>
                    <td></td>
                    <td></td>
                    <td></td>
                    <td></td>
                </tr>
                <tr style="vertical-align:top;">
                    <td style="width:0px;height:13px;"></td>
                    <td></td>
                    <td></td>
                    <td></td>
                    <td class="cs101A94F7" colspan="2" rowspan="7" style="width:168px;height:144px;text-align:left;vertical-align:top;"><div style="overflow:hidden;width:168px;height:144px;">
                        <img alt="" src="'.$pic2.'" style="width:168px;height:144px;" /></div>
                    </td>
                    <td></td>
                </tr>
                <tr style="vertical-align:top;">
                    <td style="width:0px;height:22px;"></td>
                    <td></td>
                    <td></td>
                    <td class="csCE72709D" colspan="10" style="width:690px;height:22px;line-height:15px;text-align:left;vertical-align:middle;">'.$busnessName.'</td>
                    <td></td>
                    <td></td>
                </tr>
                <tr style="vertical-align:top;">
                    <td style="width:0px;height:22px;"></td>
                    <td></td>
                    <td></td>
                    <td class="csCE72709D" colspan="10" style="width:690px;height:22px;line-height:15px;text-align:left;vertical-align:middle;"><nobr>RCCM'.$rccEse.'.&nbsp;ID-NAT.'.$numImpotEse.'</nobr></td>
                    <td></td>
                    <td></td>
                </tr>
                <tr style="vertical-align:top;">
                    <td style="width:0px;height:22px;"></td>
                    <td></td>
                    <td></td>
                    <td class="csFFC1C457" colspan="10" style="width:690px;height:22px;line-height:13px;text-align:left;vertical-align:middle;">'.$adresseEse.'</td>
                    <td></td>
                    <td></td>
                </tr>
                <tr style="vertical-align:top;">
                    <td style="width:0px;height:22px;"></td>
                    <td></td>
                    <td></td>
                    <td class="csFFC1C457" colspan="10" style="width:690px;height:22px;line-height:13px;text-align:left;vertical-align:middle;"><nobr>Email&nbsp;:&nbsp;'.$emailEse.'</nobr></td>
                    <td></td>
                    <td></td>
                </tr>
                <tr style="vertical-align:top;">
                    <td style="width:0px;height:22px;"></td>
                    <td></td>
                    <td></td>
                    <td class="csFFC1C457" colspan="10" style="width:690px;height:22px;line-height:13px;text-align:left;vertical-align:middle;"><nobr>Site&nbsp;web&nbsp;:&nbsp;'.$siteEse.'</nobr></td>
                    <td></td>
                    <td></td>
                </tr>
                <tr style="vertical-align:top;">
                    <td style="width:0px;height:21px;"></td>
                    <td></td>
                    <td></td>
                    <td class="cs612ED82F" colspan="10" rowspan="2" style="width:690px;height:22px;line-height:13px;text-align:left;vertical-align:middle;"><nobr>T&#233;l&#233;phone&nbsp;:&nbsp;'.$Tel1Ese.'&nbsp;&nbsp;24h/24</nobr></td>
                    <td></td>
                    <td></td>
                </tr>
                <tr style="vertical-align:top;">
                    <td style="width:0px;height:1px;"></td>
                    <td></td>
                    <td></td>
                    <td></td>
                    <td></td>
                    <td></td>
                    <td></td>
                </tr>
                <tr style="vertical-align:top;">
                    <td style="width:0px;height:14px;"></td>
                    <td></td>
                    <td></td>
                    <td></td>
                    <td></td>
                    <td></td>
                    <td></td>
                    <td></td>
                    <td></td>
                    <td></td>
                    <td></td>
                    <td></td>
                    <td></td>
                    <td></td>
                    <td></td>
                    <td></td>
                    <td></td>
                </tr>
                <tr style="vertical-align:top;">
                    <td style="width:0px;height:34px;"></td>
                    <td></td>
                    <td></td>
                    <td></td>
                    <td></td>
                    <td class="cs1B222893" colspan="6" style="width:437px;height:32px;line-height:31px;text-align:center;vertical-align:middle;"><nobr>FICHE&nbsp;DE&nbsp;STOCK : '.$CategorieClient.'</nobr></td>
                    <td></td>
                    <td></td>
                    <td></td>
                    <td></td>
                    <td></td>
                    <td></td>
                </tr>
                <tr style="vertical-align:top;">
                    <td style="width:0px;height:7px;"></td>
                    <td></td>
                    <td></td>
                    <td></td>
                    <td></td>
                    <td></td>
                    <td></td>
                    <td></td>
                    <td></td>
                    <td></td>
                    <td></td>
                    <td></td>
                    <td></td>
                    <td></td>
                    <td></td>
                    <td></td>
                    <td></td>
                </tr>
                <tr style="vertical-align:top;">
                    <td style="width:0px;height:24px;"></td>
                    <td></td>
                    <td class="csE71035DC" colspan="10" style="width:676px;height:22px;line-height:15px;text-align:center;vertical-align:middle;"><nobr>TOTAL&nbsp;VENTE(USD)</nobr></td>
                    <td class="csAB3AA82A" colspan="5" style="width:273px;height:22px;line-height:15px;text-align:center;vertical-align:middle;"><nobr>'.$totalVente.'$</nobr></td>
                </tr>
                <tr style="vertical-align:top;">
                    <td style="width:0px;height:24px;"></td>
                    <td></td>
                    <td class="cs8F59FFB2" colspan="2" style="width:165px;height:22px;line-height:15px;text-align:center;vertical-align:middle;"><nobr>PRODUIT</nobr></td>
                    <td class="cs6F7E55AC" colspan="2" style="width:105px;height:22px;line-height:15px;text-align:center;vertical-align:middle;"><nobr>SI</nobr></td>
                    <td class="csF3AA49E4" style="width:107px;height:22px;line-height:15px;text-align:center;vertical-align:middle;"><nobr>ENTREE</nobr></td>
                    <td class="csC73F4F41" colspan="2" style="width:109px;height:22px;line-height:15px;text-align:center;vertical-align:middle;"><nobr>TOTAL</nobr></td>
                    <td class="cs4B928201" colspan="2" style="width:109px;height:22px;line-height:15px;text-align:center;vertical-align:middle;"><nobr>SORTIE</nobr></td>
                    <td class="csF3AA49E4" style="width:76px;height:22px;line-height:15px;text-align:center;vertical-align:middle;"><nobr>SF</nobr></td>                    
                    <td class="cs4B928201" colspan="3" style="width:139px;height:22px;line-height:15px;text-align:center;vertical-align:middle;"><nobr>PU(USD)</nobr></td>
                    <td class="cs6F7E55AC" colspan="2" style="width:133px;height:22px;line-height:15px;text-align:center;vertical-align:middle;"><nobr>PT(USD)</nobr></td>
                </tr>
                <tr style="vertical-align:top;">
                    <td style="width:0px;height:22px;"></td>
                    <td></td>
                    <td class="cs2C96DE68" colspan="15" style="width:948px;height:20px;line-height:15px;text-align:left;vertical-align:top;"><nobr>'.$date1.'</nobr></td>
                </tr>
                ';
                                                                
                   $output .= $this->showCategorieFicheStockServiceByUnite($date1,$date2,$idService); 
                                                                
                 $output.='
            </table>
            </body>
            </html>

            '; 

    return $output;

} 

function showCategorieFicheStockServiceByUnite($date1,$date2,$idService)
{
    $data = DB::table("tvente_categorie_produit")
    ->select("tvente_categorie_produit.id", "tvente_categorie_produit.designation", 
    "tvente_categorie_produit.created_at", "tvente_categorie_produit.author")   
    ->orderBy("tvente_categorie_produit.designation", "asc")
    ->get();
    
    $output='';

    foreach ($data as $row) 
    {
        $output .='
                <tr style="vertical-align:top;">
                <td style="width:0px;height:22px;"></td>
                <td></td>
                <td class="csE0D816CD" colspan="15" style="width:948px;height:22px;line-height:17px;text-align:center;vertical-align:middle;">'.$row->designation.'</td>
            </tr>
            ';
                                                    
                $output .= $this->showDetailFicheStockServiceByCatUnite($date1,$date2,$row->id,$idService);                                                     
                $output.='
        ';      
    }

    return $output;

}



//========================== IVENTAIRE DE STOCK =============================================================================

function pdf_fiche_inventaire_service(Request $request)
{

    if ($request->get('date1') && $request->get('date2') && $request->get('idService')) {
        // code...
        $date1 = $request->get('date1');
        $date2 = $request->get('date2');
        $idService = $request->get('idService');
        
        // $html = $this->getInfoInventaireServices($date1,$date2,$idService);
        // $pdf = \App::make('dompdf.wrapper');

        // $pdf->loadHTML($html);
        // $pdf->loadHTML($html)->setPaper('a4', 'landscape');
        // return $pdf->stream();

        $html ='<html><head><meta http-equiv="Content-Type" content="text/html; charset=utf-8"/>';
        $html .= $this->getInfoInventaireServices($date1,$date2,$idService);       
        $html .='<script>window.print()</script>';

        echo($html);
        
    }
    else{
    }    
}
function getInfoInventaireServices($date1,$date2,$idService)
{
           //Info Entreprise
           $nomEse='';
           $adresseEse='';
           $Tel1Ese='';
           $Tel2Ese='';
           $siteEse='';
           $emailEse='';
           $idNatEse='';
           $numImpotEse='';
           $rccEse='';
           $siege='';
           $busnessName='';
           $pic='';
           $pic2 = $this->displayImg("fichier", 'logo.png');
           $logo='';
   
           $data1 = DB::table('entreprises')
           ->join('secteurs','secteurs.id','=','entreprises.idsecteur')
           ->join('forme_juridiques','forme_juridiques.id','=','entreprises.idforme')
   
           ->join('pays','pays.id','=','entreprises.idPays')
           ->join('provinces','provinces.id','=','entreprises.idProvince')
           ->join('users','users.id','=','entreprises.ceo')        
           ->select('entreprises.id as id','entreprises.id as idEntreprise',
           'entreprises.ceo','entreprises.nomEntreprise','entreprises.descriptionEntreprise',
           'entreprises.emailEntreprise','entreprises.adresseEntreprise',
           'entreprises.telephoneEntreprise','entreprises.solutionEntreprise','entreprises.idsecteur',
           'entreprises.idforme','entreprises.etat',
           'entreprises.idPays','entreprises.idProvince','entreprises.edition','entreprises.facebook',
           'entreprises.linkedin','entreprises.twitter','entreprises.siteweb','entreprises.rccm',
           'entreprises.invPersonnel','entreprises.invHub','entreprises.invRecherche',
           'entreprises.chiffreAffaire','entreprises.nbremploye','entreprises.slug','entreprises.logo',
            //forme
            'forme_juridiques.nomForme','secteurs.nomSecteur',
            //users
            'users.name','users.email','users.avatar','users.telephone','users.adresse',
            //
            'provinces.nomProvince','pays.nomPays', 'entreprises.created_at')
           ->first();
           
           if ($data1) 
           {                                
               $nomEse=$data1->nomEntreprise;
               $adresseEse=$data1->adresseEntreprise;
               $Tel1Ese=$data1->telephoneEntreprise;
               $Tel2Ese=$data1->telephone;
               $siteEse=$data1->siteweb;
               $emailEse=$data1->emailEntreprise;
               $idNatEse=$data1->rccm;
               $numImpotEse=$data1->rccm;
               $busnessName=$data1->nomSecteur;
               $rccmEse=$data1->rccm;
               $pic = $this->displayImg("fichier", 'logo.png');
               $siege=$data1->nomForme;         
           }



         $nom_service=''; 

         $data3=DB::table('tvente_services')
           ->select('id','nom_service','status','active')
           ->where([
              ['tvente_services.id','=', $idService]
          ])      
          ->first();
          if ($data3) 
          {
              $nom_service=$data3->nom_service;              
          }

          $output='';

        $output=' 

           <!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Transitional//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd">
            <!-- saved from url=(0016)http://localhost -->
            <html>
            <head>
                <title>rptInventaire</title>
                <meta HTTP-EQUIV="Content-Type" CONTENT="text/html; charset=utf-8"/>
                <style type="text/css">
                    .csFBCBEF30 {color:#000000;background-color:transparent;border-left:#000000 1px solid;border-top:#000000 1px solid;border-right:#000000 1px solid;border-bottom:#000000 1px solid;font-family:Times New Roman; font-size:12px; font-weight:normal; font-style:normal; }
                    .cs275E312D {color:#000000;background-color:transparent;border-left:#000000 1px solid;border-top:#000000 1px solid;border-right:#000000 1px solid;border-bottom:#000000 1px solid;font-family:Times New Roman; font-size:13px; font-weight:bold; font-style:normal; }
                    .csDC7EEB9 {color:#000000;background-color:transparent;border-left-style: none;border-top:#000000 1px solid;border-right:#000000 1px solid;border-bottom:#000000 1px solid;font-family:Times New Roman; font-size:12px; font-weight:normal; font-style:normal; }
                    .csAB3AA82A {color:#000000;background-color:transparent;border-left-style: none;border-top:#000000 1px solid;border-right:#000000 1px solid;border-bottom:#000000 1px solid;font-family:Times New Roman; font-size:13px; font-weight:bold; font-style:normal; }
                    .cs8A513397 {color:#000000;background-color:transparent;border-left-style: none;border-top-style: none;border-right-style: none;border-bottom-style: none;font-family:Times New Roman; font-size:13px; font-weight:bold; font-style:normal; padding-left:2px;}
                    .cs101A94F7 {color:#000000;background-color:transparent;border-left-style: none;border-top-style: none;border-right-style: none;border-bottom-style: none;font-family:Times New Roman; font-size:13px; font-weight:normal; font-style:normal; }
                    .cs6105B8F3 {color:#000000;background-color:transparent;border-left-style: none;border-top-style: none;border-right-style: none;border-bottom-style: none;font-family:Times New Roman; font-size:13px; font-weight:normal; font-style:normal; padding-left:2px;}
                    .cs5EA817F2 {color:#000000;background-color:transparent;border-left-style: none;border-top-style: none;border-right-style: none;border-bottom-style: none;font-family:Times New Roman; font-size:13px; font-weight:normal; font-style:normal; padding-left:2px;padding-right:2px;}
                    .cs2C853136 {color:#000000;background-color:transparent;border-left-style: none;border-top-style: none;border-right-style: none;border-bottom-style: none;font-family:Times New Roman; font-size:19px; font-weight:bold; font-style:normal; padding-left:2px;padding-right:2px;}
                    .csD7F64717 {color:#000000;background-color:transparent;border-left-style: none;border-top-style: none;border-right-style: none;border-bottom-style: none;font-family:Times New Roman; font-size:19px; font-weight:normal; font-style:normal; padding-left:2px;padding-right:2px;}
                    .cs739196BC {color:#5C5C5C;background-color:transparent;border-left-style: none;border-top-style: none;border-right-style: none;border-bottom-style: none;font-family:Segoe UI; font-size:11px; font-weight:normal; font-style:normal; }
                    .csF7D3565D {height:0px;width:0px;overflow:hidden;font-size:0px;line-height:0px;}
                </style>
            </head>
            <body leftMargin=10 topMargin=10 rightMargin=10 bottomMargin=10 style="background-color:#FFFFFF">
            <table cellpadding="0" cellspacing="0" border="0" style="border-width:0px;empty-cells:show;width:646px;height:362px;position:relative;">
                <tr>
                    <td style="width:0px;height:0px;"></td>
                    <td style="height:0px;width:10px;"></td>
                    <td style="height:0px;width:53px;"></td>
                    <td style="height:0px;width:45px;"></td>
                    <td style="height:0px;width:58px;"></td>
                    <td style="height:0px;width:21px;"></td>
                    <td style="height:0px;width:137px;"></td>
                    <td style="height:0px;width:85px;"></td>
                    <td style="height:0px;width:15px;"></td>
                    <td style="height:0px;width:22px;"></td>
                    <td style="height:0px;width:35px;"></td>
                    <td style="height:0px;width:34px;"></td>
                    <td style="height:0px;width:9px;"></td>
                    <td style="height:0px;width:19px;"></td>
                    <td style="height:0px;width:103px;"></td>
                </tr>
                <tr style="vertical-align:top;">
                    <td style="width:0px;height:23px;"></td>
                    <td class="cs739196BC" colspan="7" style="width:409px;height:23px;line-height:14px;text-align:center;vertical-align:middle;"><nobr></nobr></td>
                    <td></td>
                    <td></td>
                    <td></td>
                    <td></td>
                    <td></td>
                    <td></td>
                    <td></td>
                </tr>
                <tr style="vertical-align:top;">
                    <td style="width:0px;height:10px;"></td>
                    <td></td>
                    <td></td>
                    <td></td>
                    <td></td>
                    <td></td>
                    <td></td>
                    <td></td>
                    <td></td>
                    <td></td>
                    <td></td>
                    <td></td>
                    <td></td>
                    <td></td>
                    <td></td>
                </tr>
                <tr style="vertical-align:top;">
                    <td style="width:0px;height:2px;"></td>
                    <td></td>
                    <td></td>
                    <td></td>
                    <td></td>
                    <td></td>
                    <td></td>
                    <td></td>
                    <td></td>
                    <td></td>
                    <td></td>
                    <td></td>
                    <td class="cs101A94F7" colspan="3" rowspan="6" style="width:131px;height:110px;text-align:left;vertical-align:top;"><div style="overflow:hidden;width:131px;height:110px;"><img alt="" src="'.$pic2.'" style="width:131px;height:110px;" /></div>
                    </td>
                </tr>
                <tr style="vertical-align:top;">
                    <td style="width:0px;height:22px;"></td>
                    <td></td>
                    <td class="cs8A513397" colspan="8" style="width:434px;height:22px;line-height:15px;text-align:left;vertical-align:middle;"><nobr>'.$nomEse.'</nobr></td>
                    <td></td>
                    <td></td>
                </tr>
                <tr style="vertical-align:top;">
                    <td style="width:0px;height:22px;"></td>
                    <td></td>
                    <td class="cs6105B8F3" colspan="8" style="width:434px;height:22px;line-height:15px;text-align:left;vertical-align:middle;"><nobr>'.$busnessName.'</nobr></td>
                    <td></td>
                    <td></td>
                </tr>
                <tr style="vertical-align:top;">
                    <td style="width:0px;height:22px;"></td>
                    <td></td>
                    <td class="cs8A513397" colspan="8" style="width:434px;height:22px;line-height:15px;text-align:left;vertical-align:middle;"><nobr>RCCM'.$rccEse.'.&nbsp;ID-NAT.'.$numImpotEse.'</nobr></td>
                    <td></td>
                    <td></td>
                </tr>
                <tr style="vertical-align:top;">
                    <td style="width:0px;height:22px;"></td>
                    <td></td>
                    <td class="cs8A513397" colspan="8" style="width:434px;height:22px;line-height:15px;text-align:left;vertical-align:middle;"><nobr>N&#176;&nbsp;'.$numImpotEse.'</nobr></td>
                    <td></td>
                    <td></td>
                </tr>
                <tr style="vertical-align:top;">
                    <td style="width:0px;height:20px;"></td>
                    <td></td>
                    <td class="cs6105B8F3" colspan="8" rowspan="2" style="width:434px;height:22px;line-height:15px;text-align:left;vertical-align:middle;"><nobr>'.$adresseEse.'</nobr></td>
                    <td></td>
                    <td></td>
                </tr>
                <tr style="vertical-align:top;">
                    <td style="width:0px;height:2px;"></td>
                    <td></td>
                    <td></td>
                    <td></td>
                    <td></td>
                    <td></td>
                    <td></td>
                </tr>
                <tr style="vertical-align:top;">
                    <td style="width:0px;height:23px;"></td>
                    <td></td>
                    <td class="cs6105B8F3" colspan="8" style="width:434px;height:23px;line-height:15px;text-align:left;vertical-align:middle;"><nobr>E-mail&nbsp;:&nbsp;'.$emailEse.'</nobr></td>
                    <td></td>
                    <td></td>
                    <td></td>
                    <td></td>
                    <td></td>
                </tr>
                <tr style="vertical-align:top;">
                    <td style="width:0px;height:22px;"></td>
                    <td></td>
                    <td class="cs6105B8F3" colspan="8" style="width:434px;height:22px;line-height:15px;text-align:left;vertical-align:middle;"><nobr>Site-web&nbsp;:&nbsp;'.$siteEse.'/nobr></td>
                    <td></td>
                    <td></td>
                    <td></td>
                    <td></td>
                    <td></td>
                </tr>
                <tr style="vertical-align:top;">
                    <td style="width:0px;height:22px;"></td>
                    <td></td>
                    <td class="cs8A513397" colspan="8" style="width:434px;height:22px;line-height:15px;text-align:left;vertical-align:middle;"><nobr>Tel&#233;phone&nbsp;:&nbsp;'.$Tel1Ese.'</nobr></td>
                    <td></td>
                    <td></td>
                    <td></td>
                    <td></td>
                    <td></td>
                </tr>
                <tr style="vertical-align:top;">
                    <td style="width:0px;height:10px;"></td>
                    <td></td>
                    <td></td>
                    <td></td>
                    <td></td>
                    <td></td>
                    <td></td>
                    <td></td>
                    <td></td>
                    <td></td>
                    <td></td>
                    <td></td>
                    <td></td>
                    <td></td>
                    <td></td>
                </tr>
                <tr style="vertical-align:top;">
                    <td style="width:0px;height:23px;"></td>
                    <td></td>
                    <td></td>
                    <td></td>
                    <td></td>
                    <td></td>
                    <td class="csD7F64717" colspan="5" style="width:290px;height:23px;line-height:22px;text-align:center;vertical-align:middle;"><nobr>Date&nbsp;Inventaire&nbsp;:&nbsp;'.$date1.'</nobr></td>
                    <td></td>
                    <td></td>
                    <td></td>
                    <td></td>
                </tr>
                <tr style="vertical-align:top;">
                    <td style="width:0px;height:23px;"></td>
                    <td></td>
                    <td></td>
                    <td></td>
                    <td class="cs2C853136" colspan="10" style="width:431px;height:23px;line-height:22px;text-align:center;vertical-align:middle;"><nobr>Service&nbsp;:&nbsp;&nbsp;'.$nom_service.'</nobr></td>
                    <td></td>
                </tr>
                <tr style="vertical-align:top;">
                    <td style="width:0px;height:11px;"></td>
                    <td></td>
                    <td></td>
                    <td></td>
                    <td></td>
                    <td></td>
                    <td></td>
                    <td></td>
                    <td></td>
                    <td></td>
                    <td></td>
                    <td></td>
                    <td></td>
                    <td></td>
                    <td></td>
                </tr>
                <tr style="vertical-align:top;">
                    <td style="width:0px;height:24px;"></td>
                    <td></td>
                    <td class="cs275E312D" style="width:51px;height:22px;line-height:15px;text-align:center;vertical-align:middle;"><nobr>N&#176;</nobr></td>
                    <td class="csAB3AA82A" colspan="4" style="width:260px;height:22px;line-height:15px;text-align:center;vertical-align:middle;"><nobr>Produit</nobr></td>
                    <td class="csAB3AA82A" colspan="2" style="width:99px;height:22px;line-height:15px;text-align:center;vertical-align:middle;"><nobr>Stock&nbsp;Th&#233;orique</nobr></td>
                    <td class="csAB3AA82A" colspan="4" style="width:99px;height:22px;line-height:15px;text-align:center;vertical-align:middle;"><nobr>Stock&nbsp;Physique</nobr></td>
                    <td class="csAB3AA82A" colspan="2" style="width:121px;height:22px;line-height:15px;text-align:center;vertical-align:middle;"><nobr>Solde</nobr></td>
                </tr>
                ';
                                                                            
                            $output .= $this->showInvetaireService($date1,$date2,$idService); 
                                                                            
                            $output.='
                <tr style="vertical-align:top;">
                    <td style="width:0px;height:13px;"></td>
                    <td></td>
                    <td></td>
                    <td></td>
                    <td></td>
                    <td></td>
                    <td></td>
                    <td></td>
                    <td></td>
                    <td></td>
                    <td></td>
                    <td></td>
                    <td></td>
                    <td></td>
                    <td></td>
                </tr>
                <tr style="vertical-align:top;">
                    <td style="width:0px;height:22px;"></td>
                    <td></td>
                    <td class="cs5EA817F2" colspan="3" style="width:152px;height:22px;line-height:15px;text-align:center;vertical-align:top;"><nobr>Fait&nbsp;&#224;&nbsp;Goma&nbsp;le&nbsp;'.date('Y-m-d').'</nobr></td>
                    <td></td>
                    <td></td>
                    <td></td>
                    <td></td>
                    <td></td>
                    <td></td>
                    <td></td>
                    <td></td>
                    <td></td>
                    <td></td>
                </tr>
            </table>
            </body>
            </html>
                        '; 

                return $output;

         } 

function showInvetaireService($date1,$date2,$idService)
{
    //tvente_stock_service
    $data = DB::table('tvente_detail_inventaire')
    ->join('tvente_stock_service','tvente_stock_service.id','=','tvente_detail_inventaire.idStockService')
    ->join('tvente_produit','tvente_produit.id','=','tvente_stock_service.refProduit')
    ->join('tvente_services','tvente_services.id','=','tvente_stock_service.refService')
    ->join('tvente_categorie_produit','tvente_categorie_produit.id','=','tvente_produit.refCategorie')
    ->join('tvente_entete_inventaire','tvente_entete_inventaire.id','=','tvente_detail_inventaire.refEnteteVente')        
    ->join('tvente_module','tvente_module.id','=','tvente_entete_inventaire.module_id')    
    
    ->select('tvente_detail_inventaire.id','refEnteteVente','tvente_stock_service.refProduit',
    'tvente_detail_inventaire.compte_vente',
    'tvente_detail_inventaire.compte_variationstock','tvente_detail_inventaire.compte_perte',
    'tvente_detail_inventaire.compte_produit','tvente_detail_inventaire.compte_destockage','puVente',
    'qteVente','qteObs','uniteVente','puBase','qteBase','tvente_detail_inventaire.uniteBase','cmupVente',
    'tvente_detail_inventaire.devise','tvente_detail_inventaire.taux','montantreduction',
    'tvente_detail_inventaire.active','tvente_detail_inventaire.author','tvente_detail_inventaire.refUser',
    'tvente_detail_inventaire.created_at','idStockService',

    'tvente_produit.designation','tvente_produit.refCategorie','tvente_produit.refUniteBase',
    'tvente_produit.pu','tvente_produit.qte','tvente_produit.cmup','tvente_produit.taux',
    'tvente_produit.Oldcode','tvente_produit.Newcode','tvente_produit.tvaapplique',
    'tvente_produit.estvendable',

    'nom_service', "tvente_module.nom_module",'tvente_entete_inventaire.code','tvente_stock_service.refService',
    'module_id','dateVente','libelle','priseencharge','unitePivot','qtePivot'
   )
   ->selectRaw('ROUND((qteVente * qteBase),2) as QtePhysique')
   ->selectRaw('ROUND((qteObs * qteBase),2) as QteTheorique')
   ->selectRaw('(ROUND((qteObs * qteBase),2) - ROUND((qteVente * qteBase),2)) as Solde')
   ->selectRaw('ROUND(((qteVente * qteBase)/qtePivot),2) as QtePhysiquePivot')
   ->selectRaw('ROUND(((qteObs * qteBase)/qtePivot),2) as QteTheoriquePivot')
   ->selectRaw('(ROUND(((qteObs * qteBase)/qtePivot),2) - ROUND(((qteVente * qteBase)/qtePivot),2)) as SoldePivot')
   ->where([
        ['dateVente','>=', $date1],
        ['dateVente','<=', $date2],
        ['tvente_services.id','=', $idService],
        // ['tvente_categorie_produit.id','=', $refCategorie]
    ])
   ->orderBy("tvente_produit.designation", "asc")
   ->get();

   $count = 0;
    
    $output='';

    foreach ($data as $row) 
    {

        $count ++;

        $output .='
                <tr style="vertical-align:top;">
                    <td style="width:0px;height:24px;"></td>
                    <td></td>
                    <td class="csFBCBEF30" style="width:51px;height:22px;line-height:13px;text-align:center;vertical-align:middle;"><nobr>'.$count.'</nobr></td>
                    <td class="csDC7EEB9" colspan="4" style="width:260px;height:22px;line-height:13px;text-align:left;vertical-align:middle;"><nobr>'.$row->designation.'</nobr></td>
                    <td class="csDC7EEB9" colspan="2" style="width:99px;height:22px;line-height:13px;text-align:center;vertical-align:middle;"><nobr>'.$row->QteTheorique.'&nbsp;'.$row->uniteBase.'</nobr></td>
                    <td class="csDC7EEB9" colspan="4" style="width:99px;height:22px;line-height:13px;text-align:center;vertical-align:middle;"><nobr>'.$row->QtePhysique.'&nbsp;'.$row->uniteBase.'</nobr></td>
                    <td class="csDC7EEB9" colspan="2" style="width:121px;height:22px;line-height:13px;text-align:center;vertical-align:middle;"><nobr>'.$row->Solde.'&nbsp;'.$row->uniteBase.'</nobr></td>
                </tr>
           ';
     
    }

    return $output;

}


//=============== INVENTAIRE SERVICES BY CATEGORIE=======================================================================================

function pdf_fiche_inventaire_service_bycategorie(Request $request)
{

    if ($request->get('date1') && $request->get('date2') && $request->get('idCategorie') && $request->get('idService')) {
        // code...
        $date1 = $request->get('date1');
        $date2 = $request->get('date2');
        $idCategorie = $request->get('idCategorie');
        $idService = $request->get('idService');
        
        // $html = $this->getInfoInventaireServicesByCategorie($date1,$date2,$idCategorie,$idService);
        // $pdf = \App::make('dompdf.wrapper');

        // $pdf->loadHTML($html);
        // $pdf->loadHTML($html)->setPaper('a4', 'landscape');
        // return $pdf->stream();

        $html ='<html><head><meta http-equiv="Content-Type" content="text/html; charset=utf-8"/>';
        $html .= $this->getInfoInventaireServicesByCategorie($date1,$date2,$idCategorie,$idService);       
        $html .='<script>window.print()</script>';

        echo($html);
        
    }
    else{
    }    
}

function getInfoInventaireServicesByCategorie($date1,$date2,$idCategorie,$idService)
{

               //Info Entreprise
               $nomEse='';
               $adresseEse='';
               $Tel1Ese='';
               $Tel2Ese='';
               $siteEse='';
               $emailEse='';
               $idNatEse='';
               $numImpotEse='';
               $rccEse='';
               $siege='';
               $busnessName='';
               $pic='';
               $pic2 = $this->displayImg("fichier", 'logo.png');
               $logo='';
       
               $data1 = DB::table('entreprises')
               ->join('secteurs','secteurs.id','=','entreprises.idsecteur')
               ->join('forme_juridiques','forme_juridiques.id','=','entreprises.idforme')
       
               ->join('pays','pays.id','=','entreprises.idPays')
               ->join('provinces','provinces.id','=','entreprises.idProvince')
               ->join('users','users.id','=','entreprises.ceo')        
               ->select('entreprises.id as id','entreprises.id as idEntreprise',
               'entreprises.ceo','entreprises.nomEntreprise','entreprises.descriptionEntreprise',
               'entreprises.emailEntreprise','entreprises.adresseEntreprise',
               'entreprises.telephoneEntreprise','entreprises.solutionEntreprise','entreprises.idsecteur',
               'entreprises.idforme','entreprises.etat',
               'entreprises.idPays','entreprises.idProvince','entreprises.edition','entreprises.facebook',
               'entreprises.linkedin','entreprises.twitter','entreprises.siteweb','entreprises.rccm',
               'entreprises.invPersonnel','entreprises.invHub','entreprises.invRecherche',
               'entreprises.chiffreAffaire','entreprises.nbremploye','entreprises.slug','entreprises.logo',
                //forme
                'forme_juridiques.nomForme','secteurs.nomSecteur',
                //users
                'users.name','users.email','users.avatar','users.telephone','users.adresse',
                //
                'provinces.nomProvince','pays.nomPays', 'entreprises.created_at')
               ->first();
               
               if ($data1) 
               {                                
                   $nomEse=$data1->nomEntreprise;
                   $adresseEse=$data1->adresseEntreprise;
                   $Tel1Ese=$data1->telephoneEntreprise;
                   $Tel2Ese=$data1->telephone;
                   $siteEse=$data1->siteweb;
                   $emailEse=$data1->emailEntreprise;
                   $idNatEse=$data1->rccm;
                   $numImpotEse=$data1->rccm;
                   $busnessName=$data1->nomSecteur;
                   $rccmEse=$data1->rccm;
                   $pic = $this->displayImg("fichier", 'logo.png');
                   $siege=$data1->nomForme;         
               }
    
    
    
             $nom_service=''; 
    
             $data3=DB::table('tvente_services')
               ->select('id','nom_service','status','active')
               ->where([
                  ['tvente_services.id','=', $idService]
              ])      
              ->first();
              if ($data3) 
              {
                  $nom_service=$data3->nom_service;              
              }


              $nom_categorie=''; 
    
              $data4=DB::table('tvente_categorie_produit')
                ->select('id','code','designation','compte_achat','compte_vente','compte_variationstock',
                'compte_perte','compte_produit','compte_destockage','compte_stockage','id_groupe_categorie',
                'author','refUser')
                ->where([
                   ['tvente_categorie_produit.id','=', $idCategorie]
               ])      
               ->first();
               if ($data4) 
               {
                   $nom_categorie=$data4->designation;              
               }
    
              $output='';
    
            $output=' 
    
               <!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Transitional//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd">
                <!-- saved from url=(0016)http://localhost -->
                <html>
                <head>
                    <title>rptInventaire</title>
                    <meta HTTP-EQUIV="Content-Type" CONTENT="text/html; charset=utf-8"/>
                    <style type="text/css">
                        .csFBCBEF30 {color:#000000;background-color:transparent;border-left:#000000 1px solid;border-top:#000000 1px solid;border-right:#000000 1px solid;border-bottom:#000000 1px solid;font-family:Times New Roman; font-size:12px; font-weight:normal; font-style:normal; }
                        .cs275E312D {color:#000000;background-color:transparent;border-left:#000000 1px solid;border-top:#000000 1px solid;border-right:#000000 1px solid;border-bottom:#000000 1px solid;font-family:Times New Roman; font-size:13px; font-weight:bold; font-style:normal; }
                        .csDC7EEB9 {color:#000000;background-color:transparent;border-left-style: none;border-top:#000000 1px solid;border-right:#000000 1px solid;border-bottom:#000000 1px solid;font-family:Times New Roman; font-size:12px; font-weight:normal; font-style:normal; }
                        .csAB3AA82A {color:#000000;background-color:transparent;border-left-style: none;border-top:#000000 1px solid;border-right:#000000 1px solid;border-bottom:#000000 1px solid;font-family:Times New Roman; font-size:13px; font-weight:bold; font-style:normal; }
                        .cs8A513397 {color:#000000;background-color:transparent;border-left-style: none;border-top-style: none;border-right-style: none;border-bottom-style: none;font-family:Times New Roman; font-size:13px; font-weight:bold; font-style:normal; padding-left:2px;}
                        .cs101A94F7 {color:#000000;background-color:transparent;border-left-style: none;border-top-style: none;border-right-style: none;border-bottom-style: none;font-family:Times New Roman; font-size:13px; font-weight:normal; font-style:normal; }
                        .cs6105B8F3 {color:#000000;background-color:transparent;border-left-style: none;border-top-style: none;border-right-style: none;border-bottom-style: none;font-family:Times New Roman; font-size:13px; font-weight:normal; font-style:normal; padding-left:2px;}
                        .cs5EA817F2 {color:#000000;background-color:transparent;border-left-style: none;border-top-style: none;border-right-style: none;border-bottom-style: none;font-family:Times New Roman; font-size:13px; font-weight:normal; font-style:normal; padding-left:2px;padding-right:2px;}
                        .cs2C853136 {color:#000000;background-color:transparent;border-left-style: none;border-top-style: none;border-right-style: none;border-bottom-style: none;font-family:Times New Roman; font-size:19px; font-weight:bold; font-style:normal; padding-left:2px;padding-right:2px;}
                        .csD7F64717 {color:#000000;background-color:transparent;border-left-style: none;border-top-style: none;border-right-style: none;border-bottom-style: none;font-family:Times New Roman; font-size:19px; font-weight:normal; font-style:normal; padding-left:2px;padding-right:2px;}
                        .cs739196BC {color:#5C5C5C;background-color:transparent;border-left-style: none;border-top-style: none;border-right-style: none;border-bottom-style: none;font-family:Segoe UI; font-size:11px; font-weight:normal; font-style:normal; }
                        .csF7D3565D {height:0px;width:0px;overflow:hidden;font-size:0px;line-height:0px;}
                    </style>
                </head>
                <body leftMargin=10 topMargin=10 rightMargin=10 bottomMargin=10 style="background-color:#FFFFFF">
                <table cellpadding="0" cellspacing="0" border="0" style="border-width:0px;empty-cells:show;width:646px;height:362px;position:relative;">
                    <tr>
                        <td style="width:0px;height:0px;"></td>
                        <td style="height:0px;width:10px;"></td>
                        <td style="height:0px;width:53px;"></td>
                        <td style="height:0px;width:45px;"></td>
                        <td style="height:0px;width:58px;"></td>
                        <td style="height:0px;width:21px;"></td>
                        <td style="height:0px;width:137px;"></td>
                        <td style="height:0px;width:85px;"></td>
                        <td style="height:0px;width:15px;"></td>
                        <td style="height:0px;width:22px;"></td>
                        <td style="height:0px;width:35px;"></td>
                        <td style="height:0px;width:34px;"></td>
                        <td style="height:0px;width:9px;"></td>
                        <td style="height:0px;width:19px;"></td>
                        <td style="height:0px;width:103px;"></td>
                    </tr>
                    <tr style="vertical-align:top;">
                        <td style="width:0px;height:23px;"></td>
                        <td class="cs739196BC" colspan="7" style="width:409px;height:23px;line-height:14px;text-align:center;vertical-align:middle;"><nobr></nobr></td>
                        <td></td>
                        <td></td>
                        <td></td>
                        <td></td>
                        <td></td>
                        <td></td>
                        <td></td>
                    </tr>
                    <tr style="vertical-align:top;">
                        <td style="width:0px;height:10px;"></td>
                        <td></td>
                        <td></td>
                        <td></td>
                        <td></td>
                        <td></td>
                        <td></td>
                        <td></td>
                        <td></td>
                        <td></td>
                        <td></td>
                        <td></td>
                        <td></td>
                        <td></td>
                        <td></td>
                    </tr>
                    <tr style="vertical-align:top;">
                        <td style="width:0px;height:2px;"></td>
                        <td></td>
                        <td></td>
                        <td></td>
                        <td></td>
                        <td></td>
                        <td></td>
                        <td></td>
                        <td></td>
                        <td></td>
                        <td></td>
                        <td></td>
                        <td class="cs101A94F7" colspan="3" rowspan="6" style="width:131px;height:110px;text-align:left;vertical-align:top;"><div style="overflow:hidden;width:131px;height:110px;"><img alt="" src="'.$pic2.'" style="width:131px;height:110px;" /></div>
                        </td>
                    </tr>
                    <tr style="vertical-align:top;">
                        <td style="width:0px;height:22px;"></td>
                        <td></td>
                        <td class="cs8A513397" colspan="8" style="width:434px;height:22px;line-height:15px;text-align:left;vertical-align:middle;"><nobr>'.$nomEse.'</nobr></td>
                        <td></td>
                        <td></td>
                    </tr>
                    <tr style="vertical-align:top;">
                        <td style="width:0px;height:22px;"></td>
                        <td></td>
                        <td class="cs6105B8F3" colspan="8" style="width:434px;height:22px;line-height:15px;text-align:left;vertical-align:middle;"><nobr>'.$busnessName.'</nobr></td>
                        <td></td>
                        <td></td>
                    </tr>
                    <tr style="vertical-align:top;">
                        <td style="width:0px;height:22px;"></td>
                        <td></td>
                        <td class="cs8A513397" colspan="8" style="width:434px;height:22px;line-height:15px;text-align:left;vertical-align:middle;"><nobr>RCCM'.$rccEse.'.&nbsp;ID-NAT.'.$numImpotEse.'</nobr></td>
                        <td></td>
                        <td></td>
                    </tr>
                    <tr style="vertical-align:top;">
                        <td style="width:0px;height:22px;"></td>
                        <td></td>
                        <td class="cs8A513397" colspan="8" style="width:434px;height:22px;line-height:15px;text-align:left;vertical-align:middle;"><nobr>N&#176;&nbsp;'.$numImpotEse.'</nobr></td>
                        <td></td>
                        <td></td>
                    </tr>
                    <tr style="vertical-align:top;">
                        <td style="width:0px;height:20px;"></td>
                        <td></td>
                        <td class="cs6105B8F3" colspan="8" rowspan="2" style="width:434px;height:22px;line-height:15px;text-align:left;vertical-align:middle;"><nobr>'.$adresseEse.'</nobr></td>
                        <td></td>
                        <td></td>
                    </tr>
                    <tr style="vertical-align:top;">
                        <td style="width:0px;height:2px;"></td>
                        <td></td>
                        <td></td>
                        <td></td>
                        <td></td>
                        <td></td>
                        <td></td>
                    </tr>
                    <tr style="vertical-align:top;">
                        <td style="width:0px;height:23px;"></td>
                        <td></td>
                        <td class="cs6105B8F3" colspan="8" style="width:434px;height:23px;line-height:15px;text-align:left;vertical-align:middle;"><nobr>E-mail&nbsp;:&nbsp;'.$emailEse.'</nobr></td>
                        <td></td>
                        <td></td>
                        <td></td>
                        <td></td>
                        <td></td>
                    </tr>
                    <tr style="vertical-align:top;">
                        <td style="width:0px;height:22px;"></td>
                        <td></td>
                        <td class="cs6105B8F3" colspan="8" style="width:434px;height:22px;line-height:15px;text-align:left;vertical-align:middle;"><nobr>Site-web&nbsp;:&nbsp;'.$siteEse.'/nobr></td>
                        <td></td>
                        <td></td>
                        <td></td>
                        <td></td>
                        <td></td>
                    </tr>
                    <tr style="vertical-align:top;">
                        <td style="width:0px;height:22px;"></td>
                        <td></td>
                        <td class="cs8A513397" colspan="8" style="width:434px;height:22px;line-height:15px;text-align:left;vertical-align:middle;"><nobr>Tel&#233;phone&nbsp;:&nbsp;'.$Tel1Ese.'</nobr></td>
                        <td></td>
                        <td></td>
                        <td></td>
                        <td></td>
                        <td></td>
                    </tr>
                    <tr style="vertical-align:top;">
                        <td style="width:0px;height:10px;"></td>
                        <td></td>
                        <td></td>
                        <td></td>
                        <td></td>
                        <td></td>
                        <td></td>
                        <td></td>
                        <td></td>
                        <td></td>
                        <td></td>
                        <td></td>
                        <td></td>
                        <td></td>
                        <td></td>
                    </tr>
                    <tr style="vertical-align:top;">
                        <td style="width:0px;height:23px;"></td>
                        <td></td>
                        <td></td>
                        <td></td>
                        <td></td>
                        <td></td>
                        <td class="csD7F64717" colspan="5" style="width:290px;height:23px;line-height:22px;text-align:center;vertical-align:middle;"><nobr>Date&nbsp;Inventaire&nbsp;:&nbsp;'.$date1.'</nobr></td>
                        <td></td>
                        <td></td>
                        <td></td>
                        <td></td>
                    </tr>
                    <tr style="vertical-align:top;">
                        <td style="width:0px;height:23px;"></td>
                        <td></td>
                        <td></td>
                        <td></td>
                        <td class="cs2C853136" colspan="10" style="width:431px;height:23px;line-height:22px;text-align:center;vertical-align:middle;"><nobr>Service&nbsp;:&nbsp;&nbsp;'.$nom_service.' - '.$nom_categorie.'</nobr></td>
                        <td></td>
                    </tr>
                    <tr style="vertical-align:top;">
                        <td style="width:0px;height:11px;"></td>
                        <td></td>
                        <td></td>
                        <td></td>
                        <td></td>
                        <td></td>
                        <td></td>
                        <td></td>
                        <td></td>
                        <td></td>
                        <td></td>
                        <td></td>
                        <td></td>
                        <td></td>
                        <td></td>
                    </tr>
                    <tr style="vertical-align:top;">
                        <td style="width:0px;height:24px;"></td>
                        <td></td>
                        <td class="cs275E312D" style="width:51px;height:22px;line-height:15px;text-align:center;vertical-align:middle;"><nobr>N&#176;</nobr></td>
                        <td class="csAB3AA82A" colspan="4" style="width:260px;height:22px;line-height:15px;text-align:center;vertical-align:middle;"><nobr>Produit</nobr></td>
                        <td class="csAB3AA82A" colspan="2" style="width:99px;height:22px;line-height:15px;text-align:center;vertical-align:middle;"><nobr>Stock&nbsp;Th&#233;orique</nobr></td>
                        <td class="csAB3AA82A" colspan="4" style="width:99px;height:22px;line-height:15px;text-align:center;vertical-align:middle;"><nobr>Stock&nbsp;Physique</nobr></td>
                        <td class="csAB3AA82A" colspan="2" style="width:121px;height:22px;line-height:15px;text-align:center;vertical-align:middle;"><nobr>Solde</nobr></td>
                    </tr>
                    ';
                                                                                
                                $output .= $this->showInvetaireServiceCategorie($date1,$date2,$idService,$idCategorie); 
                                                                                
                                $output.='
                    <tr style="vertical-align:top;">
                        <td style="width:0px;height:13px;"></td>
                        <td></td>
                        <td></td>
                        <td></td>
                        <td></td>
                        <td></td>
                        <td></td>
                        <td></td>
                        <td></td>
                        <td></td>
                        <td></td>
                        <td></td>
                        <td></td>
                        <td></td>
                        <td></td>
                    </tr>
                    <tr style="vertical-align:top;">
                        <td style="width:0px;height:22px;"></td>
                        <td></td>
                        <td class="cs5EA817F2" colspan="3" style="width:152px;height:22px;line-height:15px;text-align:center;vertical-align:top;"><nobr>Fait&nbsp;&#224;&nbsp;Goma&nbsp;le&nbsp;'.date('Y-m-d').'</nobr></td>
                        <td></td>
                        <td></td>
                        <td></td>
                        <td></td>
                        <td></td>
                        <td></td>
                        <td></td>
                        <td></td>
                        <td></td>
                        <td></td>
                    </tr>
                </table>
                </body>
                </html>
                            '; 

    return $output;

} 

function showInvetaireServiceCategorie($date1,$date2,$idCategorie,$idService)
{
    $data = DB::table('tvente_detail_inventaire')
    ->join('tvente_stock_service','tvente_stock_service.id','=','tvente_detail_inventaire.idStockService')
    ->join('tvente_produit','tvente_produit.id','=','tvente_stock_service.refProduit')
    ->join('tvente_services','tvente_services.id','=','tvente_stock_service.refService')
    ->join('tvente_categorie_produit','tvente_categorie_produit.id','=','tvente_produit.refCategorie')
    ->join('tvente_entete_inventaire','tvente_entete_inventaire.id','=','tvente_detail_inventaire.refEnteteVente')        
    ->join('tvente_module','tvente_module.id','=','tvente_entete_inventaire.module_id')    
    
    ->select('tvente_detail_inventaire.id','refEnteteVente','tvente_stock_service.refProduit',
    'tvente_detail_inventaire.compte_vente',
    'tvente_detail_inventaire.compte_variationstock','tvente_detail_inventaire.compte_perte',
    'tvente_detail_inventaire.compte_produit','tvente_detail_inventaire.compte_destockage','puVente',
    'qteVente','qteObs','uniteVente','puBase','qteBase','tvente_detail_inventaire.uniteBase','cmupVente',
    'tvente_detail_inventaire.devise','tvente_detail_inventaire.taux','montantreduction',
    'tvente_detail_inventaire.active','tvente_detail_inventaire.author','tvente_detail_inventaire.refUser',
    'tvente_detail_inventaire.created_at','idStockService',

    'tvente_produit.designation','tvente_produit.refCategorie','tvente_produit.refUniteBase',
    'tvente_produit.pu','tvente_produit.qte','tvente_produit.cmup','tvente_produit.taux',
    'tvente_produit.Oldcode','tvente_produit.Newcode','tvente_produit.tvaapplique',
    'tvente_produit.estvendable',

    'nom_service', "tvente_module.nom_module",'tvente_entete_inventaire.code','tvente_stock_service.refService',
    'module_id','dateVente','libelle','priseencharge','unitePivot','qtePivot'
   )
   ->selectRaw('ROUND((qteVente * qteBase),2) as QtePhysique')
   ->selectRaw('ROUND((qteObs * qteBase),2) as QteTheorique')
   ->selectRaw('(ROUND((qteObs * qteBase),2) - ROUND((qteVente * qteBase),2)) as Solde')
   ->selectRaw('ROUND(((qteVente * qteBase)/qtePivot),2) as QtePhysiquePivot')
   ->selectRaw('ROUND(((qteObs * qteBase)/qtePivot),2) as QteTheoriquePivot')
   ->selectRaw('(ROUND(((qteObs * qteBase)/qtePivot),2) - ROUND(((qteVente * qteBase)/qtePivot),2)) as SoldePivot')
   ->where([
        ['dateVente','>=', $date1],
        ['dateVente','<=', $date2],
        ['tvente_services.id','=', $idService],
        ['tvente_categorie_produit.id','=', $idCategorie]
    ])
   ->orderBy("tvente_produit.designation", "asc")
   ->get();

   $count = 0;
    
    $output='';

    foreach ($data as $row) 
    {

        $count ++;

        $output .='
                <tr style="vertical-align:top;">
                    <td style="width:0px;height:24px;"></td>
                    <td></td>
                    <td class="csFBCBEF30" style="width:51px;height:22px;line-height:13px;text-align:center;vertical-align:middle;"><nobr>'.$count.'</nobr></td>
                    <td class="csDC7EEB9" colspan="4" style="width:260px;height:22px;line-height:13px;text-align:left;vertical-align:middle;"><nobr>'.$row->designation.'</nobr></td>
                    <td class="csDC7EEB9" colspan="2" style="width:99px;height:22px;line-height:13px;text-align:center;vertical-align:middle;"><nobr>'.$row->QteTheorique.'&nbsp;'.$row->uniteBase.'</nobr></td>
                    <td class="csDC7EEB9" colspan="4" style="width:99px;height:22px;line-height:13px;text-align:center;vertical-align:middle;"><nobr>'.$row->QtePhysique.'&nbsp;'.$row->uniteBase.'</nobr></td>
                    <td class="csDC7EEB9" colspan="2" style="width:121px;height:22px;line-height:13px;text-align:center;vertical-align:middle;"><nobr>'.$row->Solde.'&nbsp;'.$row->uniteBase.'</nobr></td>
                </tr>
           ';
     
    }

    return $output;

}




//==================================================================================================================
//=============== FICHE D'INVENTAIRE POUR DES GRANDES UNITES ========================================================

//=============== FICHE D'INVENTAIRE BY CATEGORIE AVEC GRAANDE UNITE=======================================================================================

//========================== IVENTAIRE DE STOCK =============================================================================

function pdf_fiche_inventaire_service_unite(Request $request)
{

    if ($request->get('date1') && $request->get('date2') && $request->get('idService')) {
        // code...
        $date1 = $request->get('date1');
        $date2 = $request->get('date2');
        $idService = $request->get('idService');
        
        // $html = $this->getInfoInventaireServicesUnite($date1,$date2,$idService);
        // $pdf = \App::make('dompdf.wrapper');

        // $pdf->loadHTML($html);
        // $pdf->loadHTML($html)->setPaper('a4', 'landscape');
        // return $pdf->stream();

        $html ='<html><head><meta http-equiv="Content-Type" content="text/html; charset=utf-8"/>';
        $html .= $this->getInfoInventaireServicesUnite($date1,$date2,$idService);       
        $html .='<script>window.print()</script>';

        echo($html);
        
    }
    else{
    }    
}
function getInfoInventaireServicesUnite($date1,$date2,$idService)
{
           //Info Entreprise
           $nomEse='';
           $adresseEse='';
           $Tel1Ese='';
           $Tel2Ese='';
           $siteEse='';
           $emailEse='';
           $idNatEse='';
           $numImpotEse='';
           $rccEse='';
           $siege='';
           $busnessName='';
           $pic='';
           $pic2 = $this->displayImg("fichier", 'logo.png');
           $logo='';
   
           $data1 = DB::table('entreprises')
           ->join('secteurs','secteurs.id','=','entreprises.idsecteur')
           ->join('forme_juridiques','forme_juridiques.id','=','entreprises.idforme')
   
           ->join('pays','pays.id','=','entreprises.idPays')
           ->join('provinces','provinces.id','=','entreprises.idProvince')
           ->join('users','users.id','=','entreprises.ceo')        
           ->select('entreprises.id as id','entreprises.id as idEntreprise',
           'entreprises.ceo','entreprises.nomEntreprise','entreprises.descriptionEntreprise',
           'entreprises.emailEntreprise','entreprises.adresseEntreprise',
           'entreprises.telephoneEntreprise','entreprises.solutionEntreprise','entreprises.idsecteur',
           'entreprises.idforme','entreprises.etat',
           'entreprises.idPays','entreprises.idProvince','entreprises.edition','entreprises.facebook',
           'entreprises.linkedin','entreprises.twitter','entreprises.siteweb','entreprises.rccm',
           'entreprises.invPersonnel','entreprises.invHub','entreprises.invRecherche',
           'entreprises.chiffreAffaire','entreprises.nbremploye','entreprises.slug','entreprises.logo',
            //forme
            'forme_juridiques.nomForme','secteurs.nomSecteur',
            //users
            'users.name','users.email','users.avatar','users.telephone','users.adresse',
            //
            'provinces.nomProvince','pays.nomPays', 'entreprises.created_at')
           ->first();
           
           if ($data1) 
           {                                
               $nomEse=$data1->nomEntreprise;
               $adresseEse=$data1->adresseEntreprise;
               $Tel1Ese=$data1->telephoneEntreprise;
               $Tel2Ese=$data1->telephone;
               $siteEse=$data1->siteweb;
               $emailEse=$data1->emailEntreprise;
               $idNatEse=$data1->rccm;
               $numImpotEse=$data1->rccm;
               $busnessName=$data1->nomSecteur;
               $rccmEse=$data1->rccm;
               $pic = $this->displayImg("fichier", 'logo.png');
               $siege=$data1->nomForme;         
           }



         $nom_service=''; 

         $data3=DB::table('tvente_services')
           ->select('id','nom_service','status','active')
           ->where([
              ['tvente_services.id','=', $idService]
          ])      
          ->first();
          if ($data3) 
          {
              $nom_service=$data3->nom_service;              
          }

          $output='';

        $output=' 

           <!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Transitional//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd">
            <!-- saved from url=(0016)http://localhost -->
            <html>
            <head>
                <title>rptInventaire</title>
                <meta HTTP-EQUIV="Content-Type" CONTENT="text/html; charset=utf-8"/>
                <style type="text/css">
                    .csFBCBEF30 {color:#000000;background-color:transparent;border-left:#000000 1px solid;border-top:#000000 1px solid;border-right:#000000 1px solid;border-bottom:#000000 1px solid;font-family:Times New Roman; font-size:12px; font-weight:normal; font-style:normal; }
                    .cs275E312D {color:#000000;background-color:transparent;border-left:#000000 1px solid;border-top:#000000 1px solid;border-right:#000000 1px solid;border-bottom:#000000 1px solid;font-family:Times New Roman; font-size:13px; font-weight:bold; font-style:normal; }
                    .csDC7EEB9 {color:#000000;background-color:transparent;border-left-style: none;border-top:#000000 1px solid;border-right:#000000 1px solid;border-bottom:#000000 1px solid;font-family:Times New Roman; font-size:12px; font-weight:normal; font-style:normal; }
                    .csAB3AA82A {color:#000000;background-color:transparent;border-left-style: none;border-top:#000000 1px solid;border-right:#000000 1px solid;border-bottom:#000000 1px solid;font-family:Times New Roman; font-size:13px; font-weight:bold; font-style:normal; }
                    .cs8A513397 {color:#000000;background-color:transparent;border-left-style: none;border-top-style: none;border-right-style: none;border-bottom-style: none;font-family:Times New Roman; font-size:13px; font-weight:bold; font-style:normal; padding-left:2px;}
                    .cs101A94F7 {color:#000000;background-color:transparent;border-left-style: none;border-top-style: none;border-right-style: none;border-bottom-style: none;font-family:Times New Roman; font-size:13px; font-weight:normal; font-style:normal; }
                    .cs6105B8F3 {color:#000000;background-color:transparent;border-left-style: none;border-top-style: none;border-right-style: none;border-bottom-style: none;font-family:Times New Roman; font-size:13px; font-weight:normal; font-style:normal; padding-left:2px;}
                    .cs5EA817F2 {color:#000000;background-color:transparent;border-left-style: none;border-top-style: none;border-right-style: none;border-bottom-style: none;font-family:Times New Roman; font-size:13px; font-weight:normal; font-style:normal; padding-left:2px;padding-right:2px;}
                    .cs2C853136 {color:#000000;background-color:transparent;border-left-style: none;border-top-style: none;border-right-style: none;border-bottom-style: none;font-family:Times New Roman; font-size:19px; font-weight:bold; font-style:normal; padding-left:2px;padding-right:2px;}
                    .csD7F64717 {color:#000000;background-color:transparent;border-left-style: none;border-top-style: none;border-right-style: none;border-bottom-style: none;font-family:Times New Roman; font-size:19px; font-weight:normal; font-style:normal; padding-left:2px;padding-right:2px;}
                    .cs739196BC {color:#5C5C5C;background-color:transparent;border-left-style: none;border-top-style: none;border-right-style: none;border-bottom-style: none;font-family:Segoe UI; font-size:11px; font-weight:normal; font-style:normal; }
                    .csF7D3565D {height:0px;width:0px;overflow:hidden;font-size:0px;line-height:0px;}
                </style>
            </head>
            <body leftMargin=10 topMargin=10 rightMargin=10 bottomMargin=10 style="background-color:#FFFFFF">
            <table cellpadding="0" cellspacing="0" border="0" style="border-width:0px;empty-cells:show;width:646px;height:362px;position:relative;">
                <tr>
                    <td style="width:0px;height:0px;"></td>
                    <td style="height:0px;width:10px;"></td>
                    <td style="height:0px;width:53px;"></td>
                    <td style="height:0px;width:45px;"></td>
                    <td style="height:0px;width:58px;"></td>
                    <td style="height:0px;width:21px;"></td>
                    <td style="height:0px;width:137px;"></td>
                    <td style="height:0px;width:85px;"></td>
                    <td style="height:0px;width:15px;"></td>
                    <td style="height:0px;width:22px;"></td>
                    <td style="height:0px;width:35px;"></td>
                    <td style="height:0px;width:34px;"></td>
                    <td style="height:0px;width:9px;"></td>
                    <td style="height:0px;width:19px;"></td>
                    <td style="height:0px;width:103px;"></td>
                </tr>
                <tr style="vertical-align:top;">
                    <td style="width:0px;height:23px;"></td>
                    <td class="cs739196BC" colspan="7" style="width:409px;height:23px;line-height:14px;text-align:center;vertical-align:middle;"><nobr></nobr></td>
                    <td></td>
                    <td></td>
                    <td></td>
                    <td></td>
                    <td></td>
                    <td></td>
                    <td></td>
                </tr>
                <tr style="vertical-align:top;">
                    <td style="width:0px;height:10px;"></td>
                    <td></td>
                    <td></td>
                    <td></td>
                    <td></td>
                    <td></td>
                    <td></td>
                    <td></td>
                    <td></td>
                    <td></td>
                    <td></td>
                    <td></td>
                    <td></td>
                    <td></td>
                    <td></td>
                </tr>
                <tr style="vertical-align:top;">
                    <td style="width:0px;height:2px;"></td>
                    <td></td>
                    <td></td>
                    <td></td>
                    <td></td>
                    <td></td>
                    <td></td>
                    <td></td>
                    <td></td>
                    <td></td>
                    <td></td>
                    <td></td>
                    <td class="cs101A94F7" colspan="3" rowspan="6" style="width:131px;height:110px;text-align:left;vertical-align:top;"><div style="overflow:hidden;width:131px;height:110px;"><img alt="" src="'.$pic2.'" style="width:131px;height:110px;" /></div>
                    </td>
                </tr>
                <tr style="vertical-align:top;">
                    <td style="width:0px;height:22px;"></td>
                    <td></td>
                    <td class="cs8A513397" colspan="8" style="width:434px;height:22px;line-height:15px;text-align:left;vertical-align:middle;"><nobr>'.$nomEse.'</nobr></td>
                    <td></td>
                    <td></td>
                </tr>
                <tr style="vertical-align:top;">
                    <td style="width:0px;height:22px;"></td>
                    <td></td>
                    <td class="cs6105B8F3" colspan="8" style="width:434px;height:22px;line-height:15px;text-align:left;vertical-align:middle;"><nobr>'.$busnessName.'</nobr></td>
                    <td></td>
                    <td></td>
                </tr>
                <tr style="vertical-align:top;">
                    <td style="width:0px;height:22px;"></td>
                    <td></td>
                    <td class="cs8A513397" colspan="8" style="width:434px;height:22px;line-height:15px;text-align:left;vertical-align:middle;"><nobr>RCCM'.$rccEse.'.&nbsp;ID-NAT.'.$numImpotEse.'</nobr></td>
                    <td></td>
                    <td></td>
                </tr>
                <tr style="vertical-align:top;">
                    <td style="width:0px;height:22px;"></td>
                    <td></td>
                    <td class="cs8A513397" colspan="8" style="width:434px;height:22px;line-height:15px;text-align:left;vertical-align:middle;"><nobr>N&#176;&nbsp;'.$numImpotEse.'</nobr></td>
                    <td></td>
                    <td></td>
                </tr>
                <tr style="vertical-align:top;">
                    <td style="width:0px;height:20px;"></td>
                    <td></td>
                    <td class="cs6105B8F3" colspan="8" rowspan="2" style="width:434px;height:22px;line-height:15px;text-align:left;vertical-align:middle;"><nobr>'.$adresseEse.'</nobr></td>
                    <td></td>
                    <td></td>
                </tr>
                <tr style="vertical-align:top;">
                    <td style="width:0px;height:2px;"></td>
                    <td></td>
                    <td></td>
                    <td></td>
                    <td></td>
                    <td></td>
                    <td></td>
                </tr>
                <tr style="vertical-align:top;">
                    <td style="width:0px;height:23px;"></td>
                    <td></td>
                    <td class="cs6105B8F3" colspan="8" style="width:434px;height:23px;line-height:15px;text-align:left;vertical-align:middle;"><nobr>E-mail&nbsp;:&nbsp;'.$emailEse.'</nobr></td>
                    <td></td>
                    <td></td>
                    <td></td>
                    <td></td>
                    <td></td>
                </tr>
                <tr style="vertical-align:top;">
                    <td style="width:0px;height:22px;"></td>
                    <td></td>
                    <td class="cs6105B8F3" colspan="8" style="width:434px;height:22px;line-height:15px;text-align:left;vertical-align:middle;"><nobr>Site-web&nbsp;:&nbsp;'.$siteEse.'/nobr></td>
                    <td></td>
                    <td></td>
                    <td></td>
                    <td></td>
                    <td></td>
                </tr>
                <tr style="vertical-align:top;">
                    <td style="width:0px;height:22px;"></td>
                    <td></td>
                    <td class="cs8A513397" colspan="8" style="width:434px;height:22px;line-height:15px;text-align:left;vertical-align:middle;"><nobr>Tel&#233;phone&nbsp;:&nbsp;'.$Tel1Ese.'</nobr></td>
                    <td></td>
                    <td></td>
                    <td></td>
                    <td></td>
                    <td></td>
                </tr>
                <tr style="vertical-align:top;">
                    <td style="width:0px;height:10px;"></td>
                    <td></td>
                    <td></td>
                    <td></td>
                    <td></td>
                    <td></td>
                    <td></td>
                    <td></td>
                    <td></td>
                    <td></td>
                    <td></td>
                    <td></td>
                    <td></td>
                    <td></td>
                    <td></td>
                </tr>
                <tr style="vertical-align:top;">
                    <td style="width:0px;height:23px;"></td>
                    <td></td>
                    <td></td>
                    <td></td>
                    <td></td>
                    <td></td>
                    <td class="csD7F64717" colspan="5" style="width:290px;height:23px;line-height:22px;text-align:center;vertical-align:middle;"><nobr>Date&nbsp;Inventaire&nbsp;:&nbsp;'.$date1.'</nobr></td>
                    <td></td>
                    <td></td>
                    <td></td>
                    <td></td>
                </tr>
                <tr style="vertical-align:top;">
                    <td style="width:0px;height:23px;"></td>
                    <td></td>
                    <td></td>
                    <td></td>
                    <td class="cs2C853136" colspan="10" style="width:431px;height:23px;line-height:22px;text-align:center;vertical-align:middle;"><nobr>Service&nbsp;:&nbsp;&nbsp;'.$nom_service.'</nobr></td>
                    <td></td>
                </tr>
                <tr style="vertical-align:top;">
                    <td style="width:0px;height:11px;"></td>
                    <td></td>
                    <td></td>
                    <td></td>
                    <td></td>
                    <td></td>
                    <td></td>
                    <td></td>
                    <td></td>
                    <td></td>
                    <td></td>
                    <td></td>
                    <td></td>
                    <td></td>
                    <td></td>
                </tr>
                <tr style="vertical-align:top;">
                    <td style="width:0px;height:24px;"></td>
                    <td></td>
                    <td class="cs275E312D" style="width:51px;height:22px;line-height:15px;text-align:center;vertical-align:middle;"><nobr>N&#176;</nobr></td>
                    <td class="csAB3AA82A" colspan="4" style="width:260px;height:22px;line-height:15px;text-align:center;vertical-align:middle;"><nobr>Produit</nobr></td>
                    <td class="csAB3AA82A" colspan="2" style="width:99px;height:22px;line-height:15px;text-align:center;vertical-align:middle;"><nobr>Stock&nbsp;Th&#233;orique</nobr></td>
                    <td class="csAB3AA82A" colspan="4" style="width:99px;height:22px;line-height:15px;text-align:center;vertical-align:middle;"><nobr>Stock&nbsp;Physique</nobr></td>
                    <td class="csAB3AA82A" colspan="2" style="width:121px;height:22px;line-height:15px;text-align:center;vertical-align:middle;"><nobr>Solde</nobr></td>
                </tr>
                ';
                                                                            
                            $output .= $this->showInvetaireServiceUnite($date1,$date2,$idService); 
                                                                            
                            $output.='
                <tr style="vertical-align:top;">
                    <td style="width:0px;height:13px;"></td>
                    <td></td>
                    <td></td>
                    <td></td>
                    <td></td>
                    <td></td>
                    <td></td>
                    <td></td>
                    <td></td>
                    <td></td>
                    <td></td>
                    <td></td>
                    <td></td>
                    <td></td>
                    <td></td>
                </tr>
                <tr style="vertical-align:top;">
                    <td style="width:0px;height:22px;"></td>
                    <td></td>
                    <td class="cs5EA817F2" colspan="3" style="width:152px;height:22px;line-height:15px;text-align:center;vertical-align:top;"><nobr>Fait&nbsp;&#224;&nbsp;Goma&nbsp;le&nbsp;'.date('Y-m-d').'</nobr></td>
                    <td></td>
                    <td></td>
                    <td></td>
                    <td></td>
                    <td></td>
                    <td></td>
                    <td></td>
                    <td></td>
                    <td></td>
                    <td></td>
                </tr>
            </table>
            </body>
            </html>
                        '; 

                return $output;

         } 

function showInvetaireServiceUnite($date1,$date2,$idService)
{
    //tvente_stock_service
    $data = DB::table('tvente_detail_inventaire')
    ->join('tvente_stock_service','tvente_stock_service.id','=','tvente_detail_inventaire.idStockService')
    ->join('tvente_produit','tvente_produit.id','=','tvente_stock_service.refProduit')
    ->join('tvente_services','tvente_services.id','=','tvente_stock_service.refService')
    ->join('tvente_categorie_produit','tvente_categorie_produit.id','=','tvente_produit.refCategorie')
    ->join('tvente_entete_inventaire','tvente_entete_inventaire.id','=','tvente_detail_inventaire.refEnteteVente')        
    ->join('tvente_module','tvente_module.id','=','tvente_entete_inventaire.module_id')    
    
    ->select('tvente_detail_inventaire.id','refEnteteVente','tvente_stock_service.refProduit',
    'tvente_detail_inventaire.compte_vente',
    'tvente_detail_inventaire.compte_variationstock','tvente_detail_inventaire.compte_perte',
    'tvente_detail_inventaire.compte_produit','tvente_detail_inventaire.compte_destockage','puVente',
    'qteVente','qteObs','uniteVente','puBase','qteBase','tvente_detail_inventaire.uniteBase','cmupVente',
    'tvente_detail_inventaire.devise','tvente_detail_inventaire.taux','montantreduction',
    'tvente_detail_inventaire.active','tvente_detail_inventaire.author','tvente_detail_inventaire.refUser',
    'tvente_detail_inventaire.created_at','idStockService',

    'tvente_produit.designation','tvente_produit.refCategorie','tvente_produit.refUniteBase',
    'tvente_produit.pu','tvente_produit.qte','tvente_produit.cmup','tvente_produit.taux',
    'tvente_produit.Oldcode','tvente_produit.Newcode','tvente_produit.tvaapplique',
    'tvente_produit.estvendable',

    'nom_service', "tvente_module.nom_module",'tvente_entete_inventaire.code','tvente_stock_service.refService',
    'module_id','dateVente','libelle','priseencharge','unitePivot','qtePivot'
   )
   ->selectRaw('ROUND((qteVente * qteBase),2) as QtePhysique')
   ->selectRaw('ROUND((qteObs * qteBase),2) as QteTheorique')
   ->selectRaw('(ROUND((qteObs * qteBase),2) - ROUND((qteVente * qteBase),2)) as Solde')
   ->selectRaw('ROUND(((qteVente * qteBase)/qtePivot),2) as QtePhysiquePivot')
   ->selectRaw('ROUND(((qteObs * qteBase)/qtePivot),2) as QteTheoriquePivot')
   ->selectRaw('(ROUND(((qteObs * qteBase)/qtePivot),2) - ROUND(((qteVente * qteBase)/qtePivot),2)) as SoldePivot')
   ->where([
        ['dateVente','>=', $date1],
        ['dateVente','<=', $date2],
        ['tvente_services.id','=', $idService],
        // ['tvente_categorie_produit.id','=', $refCategorie]
    ])
   ->orderBy("tvente_produit.designation", "asc")
   ->get();

   $count = 0;
    
    $output='';

    foreach ($data as $row) 
    {

        $count ++;

        $output .='
                <tr style="vertical-align:top;">
                    <td style="width:0px;height:24px;"></td>
                    <td></td>
                    <td class="csFBCBEF30" style="width:51px;height:22px;line-height:13px;text-align:center;vertical-align:middle;"><nobr>'.$count.'</nobr></td>
                    <td class="csDC7EEB9" colspan="4" style="width:260px;height:22px;line-height:13px;text-align:left;vertical-align:middle;"><nobr>'.$row->designation.'</nobr></td>
                    <td class="csDC7EEB9" colspan="2" style="width:99px;height:22px;line-height:13px;text-align:center;vertical-align:middle;"><nobr>'.$row->QteTheoriquePivot.'&nbsp;'.$row->unitePivot.'</nobr></td>
                    <td class="csDC7EEB9" colspan="4" style="width:99px;height:22px;line-height:13px;text-align:center;vertical-align:middle;"><nobr>'.$row->QtePhysiquePivot.'&nbsp;'.$row->unitePivot.'</nobr></td>
                    <td class="csDC7EEB9" colspan="2" style="width:121px;height:22px;line-height:13px;text-align:center;vertical-align:middle;"><nobr>'.$row->SoldePivot.'&nbsp;'.$row->unitePivot.'</nobr></td>
                </tr>
           ';
     
    }

    return $output;

}


//=============== INVENTAIRE SERVICES BY CATEGORIE=======================================================================================

function pdf_fiche_inventaire_service_bycategorie_unite(Request $request)
{

    if ($request->get('date1') && $request->get('date2') && $request->get('idCategorie') && $request->get('idService')) {
        // code...
        $date1 = $request->get('date1');
        $date2 = $request->get('date2');
        $idCategorie = $request->get('idCategorie');
        $idService = $request->get('idService');
        
        // $html = $this->getInfoInventaireServicesByCategorieUnite($date1,$date2,$idCategorie,$idService);
        // $pdf = \App::make('dompdf.wrapper');

        // $pdf->loadHTML($html);
        // $pdf->loadHTML($html)->setPaper('a4', 'landscape');
        // return $pdf->stream();

        $html ='<html><head><meta http-equiv="Content-Type" content="text/html; charset=utf-8"/>';
        $html .= $this->getInfoInventaireServicesByCategorieUnite($date1,$date2,$idCategorie,$idService);       
        $html .='<script>window.print()</script>';

        echo($html);
        
    }
    else{
    }    
}

function getInfoInventaireServicesByCategorieUnite($date1,$date2,$idCategorie,$idService)
{

               //Info Entreprise
               $nomEse='';
               $adresseEse='';
               $Tel1Ese='';
               $Tel2Ese='';
               $siteEse='';
               $emailEse='';
               $idNatEse='';
               $numImpotEse='';
               $rccEse='';
               $siege='';
               $busnessName='';
               $pic='';
               $pic2 = $this->displayImg("fichier", 'logo.png');
               $logo='';
       
               $data1 = DB::table('entreprises')
               ->join('secteurs','secteurs.id','=','entreprises.idsecteur')
               ->join('forme_juridiques','forme_juridiques.id','=','entreprises.idforme')
       
               ->join('pays','pays.id','=','entreprises.idPays')
               ->join('provinces','provinces.id','=','entreprises.idProvince')
               ->join('users','users.id','=','entreprises.ceo')        
               ->select('entreprises.id as id','entreprises.id as idEntreprise',
               'entreprises.ceo','entreprises.nomEntreprise','entreprises.descriptionEntreprise',
               'entreprises.emailEntreprise','entreprises.adresseEntreprise',
               'entreprises.telephoneEntreprise','entreprises.solutionEntreprise','entreprises.idsecteur',
               'entreprises.idforme','entreprises.etat',
               'entreprises.idPays','entreprises.idProvince','entreprises.edition','entreprises.facebook',
               'entreprises.linkedin','entreprises.twitter','entreprises.siteweb','entreprises.rccm',
               'entreprises.invPersonnel','entreprises.invHub','entreprises.invRecherche',
               'entreprises.chiffreAffaire','entreprises.nbremploye','entreprises.slug','entreprises.logo',
                //forme
                'forme_juridiques.nomForme','secteurs.nomSecteur',
                //users
                'users.name','users.email','users.avatar','users.telephone','users.adresse',
                //
                'provinces.nomProvince','pays.nomPays', 'entreprises.created_at')
               ->first();
               
               if ($data1) 
               {                                
                   $nomEse=$data1->nomEntreprise;
                   $adresseEse=$data1->adresseEntreprise;
                   $Tel1Ese=$data1->telephoneEntreprise;
                   $Tel2Ese=$data1->telephone;
                   $siteEse=$data1->siteweb;
                   $emailEse=$data1->emailEntreprise;
                   $idNatEse=$data1->rccm;
                   $numImpotEse=$data1->rccm;
                   $busnessName=$data1->nomSecteur;
                   $rccmEse=$data1->rccm;
                   $pic = $this->displayImg("fichier", 'logo.png');
                   $siege=$data1->nomForme;         
               }
    
    
    
             $nom_service=''; 
    
             $data3=DB::table('tvente_services')
               ->select('id','nom_service','status','active')
               ->where([
                  ['tvente_services.id','=', $idService]
              ])      
              ->first();
              if ($data3) 
              {
                  $nom_service=$data3->nom_service;              
              }


              $nom_categorie=''; 
    
              $data4=DB::table('tvente_categorie_produit')
                ->select('id','code','designation','compte_achat','compte_vente','compte_variationstock',
                'compte_perte','compte_produit','compte_destockage','compte_stockage','id_groupe_categorie',
                'author','refUser')
                ->where([
                   ['tvente_categorie_produit.id','=', $idCategorie]
               ])      
               ->first();
               if ($data4) 
               {
                   $nom_categorie=$data4->designation;              
               }
    
              $output='';
    
            $output=' 
    
               <!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Transitional//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd">
                <!-- saved from url=(0016)http://localhost -->
                <html>
                <head>
                    <title>rptInventaire</title>
                    <meta HTTP-EQUIV="Content-Type" CONTENT="text/html; charset=utf-8"/>
                    <style type="text/css">
                        .csFBCBEF30 {color:#000000;background-color:transparent;border-left:#000000 1px solid;border-top:#000000 1px solid;border-right:#000000 1px solid;border-bottom:#000000 1px solid;font-family:Times New Roman; font-size:12px; font-weight:normal; font-style:normal; }
                        .cs275E312D {color:#000000;background-color:transparent;border-left:#000000 1px solid;border-top:#000000 1px solid;border-right:#000000 1px solid;border-bottom:#000000 1px solid;font-family:Times New Roman; font-size:13px; font-weight:bold; font-style:normal; }
                        .csDC7EEB9 {color:#000000;background-color:transparent;border-left-style: none;border-top:#000000 1px solid;border-right:#000000 1px solid;border-bottom:#000000 1px solid;font-family:Times New Roman; font-size:12px; font-weight:normal; font-style:normal; }
                        .csAB3AA82A {color:#000000;background-color:transparent;border-left-style: none;border-top:#000000 1px solid;border-right:#000000 1px solid;border-bottom:#000000 1px solid;font-family:Times New Roman; font-size:13px; font-weight:bold; font-style:normal; }
                        .cs8A513397 {color:#000000;background-color:transparent;border-left-style: none;border-top-style: none;border-right-style: none;border-bottom-style: none;font-family:Times New Roman; font-size:13px; font-weight:bold; font-style:normal; padding-left:2px;}
                        .cs101A94F7 {color:#000000;background-color:transparent;border-left-style: none;border-top-style: none;border-right-style: none;border-bottom-style: none;font-family:Times New Roman; font-size:13px; font-weight:normal; font-style:normal; }
                        .cs6105B8F3 {color:#000000;background-color:transparent;border-left-style: none;border-top-style: none;border-right-style: none;border-bottom-style: none;font-family:Times New Roman; font-size:13px; font-weight:normal; font-style:normal; padding-left:2px;}
                        .cs5EA817F2 {color:#000000;background-color:transparent;border-left-style: none;border-top-style: none;border-right-style: none;border-bottom-style: none;font-family:Times New Roman; font-size:13px; font-weight:normal; font-style:normal; padding-left:2px;padding-right:2px;}
                        .cs2C853136 {color:#000000;background-color:transparent;border-left-style: none;border-top-style: none;border-right-style: none;border-bottom-style: none;font-family:Times New Roman; font-size:19px; font-weight:bold; font-style:normal; padding-left:2px;padding-right:2px;}
                        .csD7F64717 {color:#000000;background-color:transparent;border-left-style: none;border-top-style: none;border-right-style: none;border-bottom-style: none;font-family:Times New Roman; font-size:19px; font-weight:normal; font-style:normal; padding-left:2px;padding-right:2px;}
                        .cs739196BC {color:#5C5C5C;background-color:transparent;border-left-style: none;border-top-style: none;border-right-style: none;border-bottom-style: none;font-family:Segoe UI; font-size:11px; font-weight:normal; font-style:normal; }
                        .csF7D3565D {height:0px;width:0px;overflow:hidden;font-size:0px;line-height:0px;}
                    </style>
                </head>
                <body leftMargin=10 topMargin=10 rightMargin=10 bottomMargin=10 style="background-color:#FFFFFF">
                <table cellpadding="0" cellspacing="0" border="0" style="border-width:0px;empty-cells:show;width:646px;height:362px;position:relative;">
                    <tr>
                        <td style="width:0px;height:0px;"></td>
                        <td style="height:0px;width:10px;"></td>
                        <td style="height:0px;width:53px;"></td>
                        <td style="height:0px;width:45px;"></td>
                        <td style="height:0px;width:58px;"></td>
                        <td style="height:0px;width:21px;"></td>
                        <td style="height:0px;width:137px;"></td>
                        <td style="height:0px;width:85px;"></td>
                        <td style="height:0px;width:15px;"></td>
                        <td style="height:0px;width:22px;"></td>
                        <td style="height:0px;width:35px;"></td>
                        <td style="height:0px;width:34px;"></td>
                        <td style="height:0px;width:9px;"></td>
                        <td style="height:0px;width:19px;"></td>
                        <td style="height:0px;width:103px;"></td>
                    </tr>
                    <tr style="vertical-align:top;">
                        <td style="width:0px;height:23px;"></td>
                        <td class="cs739196BC" colspan="7" style="width:409px;height:23px;line-height:14px;text-align:center;vertical-align:middle;"><nobr></nobr></td>
                        <td></td>
                        <td></td>
                        <td></td>
                        <td></td>
                        <td></td>
                        <td></td>
                        <td></td>
                    </tr>
                    <tr style="vertical-align:top;">
                        <td style="width:0px;height:10px;"></td>
                        <td></td>
                        <td></td>
                        <td></td>
                        <td></td>
                        <td></td>
                        <td></td>
                        <td></td>
                        <td></td>
                        <td></td>
                        <td></td>
                        <td></td>
                        <td></td>
                        <td></td>
                        <td></td>
                    </tr>
                    <tr style="vertical-align:top;">
                        <td style="width:0px;height:2px;"></td>
                        <td></td>
                        <td></td>
                        <td></td>
                        <td></td>
                        <td></td>
                        <td></td>
                        <td></td>
                        <td></td>
                        <td></td>
                        <td></td>
                        <td></td>
                        <td class="cs101A94F7" colspan="3" rowspan="6" style="width:131px;height:110px;text-align:left;vertical-align:top;"><div style="overflow:hidden;width:131px;height:110px;"><img alt="" src="'.$pic2.'" style="width:131px;height:110px;" /></div>
                        </td>
                    </tr>
                    <tr style="vertical-align:top;">
                        <td style="width:0px;height:22px;"></td>
                        <td></td>
                        <td class="cs8A513397" colspan="8" style="width:434px;height:22px;line-height:15px;text-align:left;vertical-align:middle;"><nobr>'.$nomEse.'</nobr></td>
                        <td></td>
                        <td></td>
                    </tr>
                    <tr style="vertical-align:top;">
                        <td style="width:0px;height:22px;"></td>
                        <td></td>
                        <td class="cs6105B8F3" colspan="8" style="width:434px;height:22px;line-height:15px;text-align:left;vertical-align:middle;"><nobr>'.$busnessName.'</nobr></td>
                        <td></td>
                        <td></td>
                    </tr>
                    <tr style="vertical-align:top;">
                        <td style="width:0px;height:22px;"></td>
                        <td></td>
                        <td class="cs8A513397" colspan="8" style="width:434px;height:22px;line-height:15px;text-align:left;vertical-align:middle;"><nobr>RCCM'.$rccEse.'.&nbsp;ID-NAT.'.$numImpotEse.'</nobr></td>
                        <td></td>
                        <td></td>
                    </tr>
                    <tr style="vertical-align:top;">
                        <td style="width:0px;height:22px;"></td>
                        <td></td>
                        <td class="cs8A513397" colspan="8" style="width:434px;height:22px;line-height:15px;text-align:left;vertical-align:middle;"><nobr>N&#176;&nbsp;'.$numImpotEse.'</nobr></td>
                        <td></td>
                        <td></td>
                    </tr>
                    <tr style="vertical-align:top;">
                        <td style="width:0px;height:20px;"></td>
                        <td></td>
                        <td class="cs6105B8F3" colspan="8" rowspan="2" style="width:434px;height:22px;line-height:15px;text-align:left;vertical-align:middle;"><nobr>'.$adresseEse.'</nobr></td>
                        <td></td>
                        <td></td>
                    </tr>
                    <tr style="vertical-align:top;">
                        <td style="width:0px;height:2px;"></td>
                        <td></td>
                        <td></td>
                        <td></td>
                        <td></td>
                        <td></td>
                        <td></td>
                    </tr>
                    <tr style="vertical-align:top;">
                        <td style="width:0px;height:23px;"></td>
                        <td></td>
                        <td class="cs6105B8F3" colspan="8" style="width:434px;height:23px;line-height:15px;text-align:left;vertical-align:middle;"><nobr>E-mail&nbsp;:&nbsp;'.$emailEse.'</nobr></td>
                        <td></td>
                        <td></td>
                        <td></td>
                        <td></td>
                        <td></td>
                    </tr>
                    <tr style="vertical-align:top;">
                        <td style="width:0px;height:22px;"></td>
                        <td></td>
                        <td class="cs6105B8F3" colspan="8" style="width:434px;height:22px;line-height:15px;text-align:left;vertical-align:middle;"><nobr>Site-web&nbsp;:&nbsp;'.$siteEse.'/nobr></td>
                        <td></td>
                        <td></td>
                        <td></td>
                        <td></td>
                        <td></td>
                    </tr>
                    <tr style="vertical-align:top;">
                        <td style="width:0px;height:22px;"></td>
                        <td></td>
                        <td class="cs8A513397" colspan="8" style="width:434px;height:22px;line-height:15px;text-align:left;vertical-align:middle;"><nobr>Tel&#233;phone&nbsp;:&nbsp;'.$Tel1Ese.'</nobr></td>
                        <td></td>
                        <td></td>
                        <td></td>
                        <td></td>
                        <td></td>
                    </tr>
                    <tr style="vertical-align:top;">
                        <td style="width:0px;height:10px;"></td>
                        <td></td>
                        <td></td>
                        <td></td>
                        <td></td>
                        <td></td>
                        <td></td>
                        <td></td>
                        <td></td>
                        <td></td>
                        <td></td>
                        <td></td>
                        <td></td>
                        <td></td>
                        <td></td>
                    </tr>
                    <tr style="vertical-align:top;">
                        <td style="width:0px;height:23px;"></td>
                        <td></td>
                        <td></td>
                        <td></td>
                        <td></td>
                        <td></td>
                        <td class="csD7F64717" colspan="5" style="width:290px;height:23px;line-height:22px;text-align:center;vertical-align:middle;"><nobr>Date&nbsp;Inventaire&nbsp;:&nbsp;'.$date1.'</nobr></td>
                        <td></td>
                        <td></td>
                        <td></td>
                        <td></td>
                    </tr>
                    <tr style="vertical-align:top;">
                        <td style="width:0px;height:23px;"></td>
                        <td></td>
                        <td></td>
                        <td></td>
                        <td class="cs2C853136" colspan="10" style="width:431px;height:23px;line-height:22px;text-align:center;vertical-align:middle;"><nobr>Service&nbsp;:&nbsp;&nbsp;'.$nom_service.' - '.$nom_categorie.'</nobr></td>
                        <td></td>
                    </tr>
                    <tr style="vertical-align:top;">
                        <td style="width:0px;height:11px;"></td>
                        <td></td>
                        <td></td>
                        <td></td>
                        <td></td>
                        <td></td>
                        <td></td>
                        <td></td>
                        <td></td>
                        <td></td>
                        <td></td>
                        <td></td>
                        <td></td>
                        <td></td>
                        <td></td>
                    </tr>
                    <tr style="vertical-align:top;">
                        <td style="width:0px;height:24px;"></td>
                        <td></td>
                        <td class="cs275E312D" style="width:51px;height:22px;line-height:15px;text-align:center;vertical-align:middle;"><nobr>N&#176;</nobr></td>
                        <td class="csAB3AA82A" colspan="4" style="width:260px;height:22px;line-height:15px;text-align:center;vertical-align:middle;"><nobr>Produit</nobr></td>
                        <td class="csAB3AA82A" colspan="2" style="width:99px;height:22px;line-height:15px;text-align:center;vertical-align:middle;"><nobr>Stock&nbsp;Th&#233;orique</nobr></td>
                        <td class="csAB3AA82A" colspan="4" style="width:99px;height:22px;line-height:15px;text-align:center;vertical-align:middle;"><nobr>Stock&nbsp;Physique</nobr></td>
                        <td class="csAB3AA82A" colspan="2" style="width:121px;height:22px;line-height:15px;text-align:center;vertical-align:middle;"><nobr>Solde</nobr></td>
                    </tr>
                    ';
                                                                                
                                $output .= $this->showInvetaireServiceCategorieUnite($date1,$date2,$idService,$idCategorie); 
                                                                                
                                $output.='
                    <tr style="vertical-align:top;">
                        <td style="width:0px;height:13px;"></td>
                        <td></td>
                        <td></td>
                        <td></td>
                        <td></td>
                        <td></td>
                        <td></td>
                        <td></td>
                        <td></td>
                        <td></td>
                        <td></td>
                        <td></td>
                        <td></td>
                        <td></td>
                        <td></td>
                    </tr>
                    <tr style="vertical-align:top;">
                        <td style="width:0px;height:22px;"></td>
                        <td></td>
                        <td class="cs5EA817F2" colspan="3" style="width:152px;height:22px;line-height:15px;text-align:center;vertical-align:top;"><nobr>Fait&nbsp;&#224;&nbsp;Goma&nbsp;le&nbsp;'.date('Y-m-d').'</nobr></td>
                        <td></td>
                        <td></td>
                        <td></td>
                        <td></td>
                        <td></td>
                        <td></td>
                        <td></td>
                        <td></td>
                        <td></td>
                        <td></td>
                    </tr>
                </table>
                </body>
                </html>
                            '; 

    return $output;

} 

function showInvetaireServiceCategorieUnite($date1,$date2,$idCategorie,$idService)
{
    $data = DB::table('tvente_detail_inventaire')
    ->join('tvente_stock_service','tvente_stock_service.id','=','tvente_detail_inventaire.idStockService')
    ->join('tvente_produit','tvente_produit.id','=','tvente_stock_service.refProduit')
    ->join('tvente_services','tvente_services.id','=','tvente_stock_service.refService')
    ->join('tvente_categorie_produit','tvente_categorie_produit.id','=','tvente_produit.refCategorie')
    ->join('tvente_entete_inventaire','tvente_entete_inventaire.id','=','tvente_detail_inventaire.refEnteteVente')        
    ->join('tvente_module','tvente_module.id','=','tvente_entete_inventaire.module_id')    
    
    ->select('tvente_detail_inventaire.id','refEnteteVente','tvente_stock_service.refProduit',
    'tvente_detail_inventaire.compte_vente',
    'tvente_detail_inventaire.compte_variationstock','tvente_detail_inventaire.compte_perte',
    'tvente_detail_inventaire.compte_produit','tvente_detail_inventaire.compte_destockage','puVente',
    'qteVente','qteObs','uniteVente','puBase','qteBase','tvente_detail_inventaire.uniteBase','cmupVente',
    'tvente_detail_inventaire.devise','tvente_detail_inventaire.taux','montantreduction',
    'tvente_detail_inventaire.active','tvente_detail_inventaire.author','tvente_detail_inventaire.refUser',
    'tvente_detail_inventaire.created_at','idStockService',

    'tvente_produit.designation','tvente_produit.refCategorie','tvente_produit.refUniteBase',
    'tvente_produit.pu','tvente_produit.qte','tvente_produit.cmup','tvente_produit.taux',
    'tvente_produit.Oldcode','tvente_produit.Newcode','tvente_produit.tvaapplique',
    'tvente_produit.estvendable',

    'nom_service', "tvente_module.nom_module",'tvente_entete_inventaire.code','tvente_stock_service.refService',
    'module_id','dateVente','libelle','priseencharge','unitePivot','qtePivot'
   )
   ->selectRaw('ROUND((qteVente * qteBase),2) as QtePhysique')
   ->selectRaw('ROUND((qteObs * qteBase),2) as QteTheorique')
   ->selectRaw('(ROUND((qteObs * qteBase),2) - ROUND((qteVente * qteBase),2)) as Solde')
   ->selectRaw('ROUND(((qteVente * qteBase)/qtePivot),2) as QtePhysiquePivot')
   ->selectRaw('ROUND(((qteObs * qteBase)/qtePivot),2) as QteTheoriquePivot')
   ->selectRaw('(ROUND(((qteObs * qteBase)/qtePivot),2) - ROUND(((qteVente * qteBase)/qtePivot),2)) as SoldePivot')
   ->where([
        ['dateVente','>=', $date1],
        ['dateVente','<=', $date2],
        ['tvente_services.id','=', $idService],
        ['tvente_categorie_produit.id','=', $idCategorie]
    ])
   ->orderBy("tvente_produit.designation", "asc")
   ->get();

   $count = 0;
    
    $output='';

    foreach ($data as $row) 
    {

        $count ++;

        $output .='
                <tr style="vertical-align:top;">
                    <td style="width:0px;height:24px;"></td>
                    <td></td>
                    <td class="csFBCBEF30" style="width:51px;height:22px;line-height:13px;text-align:center;vertical-align:middle;"><nobr>'.$count.'</nobr></td>
                    <td class="csDC7EEB9" colspan="4" style="width:260px;height:22px;line-height:13px;text-align:left;vertical-align:middle;"><nobr>'.$row->designation.'</nobr></td>
                    <td class="csDC7EEB9" colspan="2" style="width:99px;height:22px;line-height:13px;text-align:center;vertical-align:middle;"><nobr>'.$row->QteTheoriquePivot.'&nbsp;'.$row->unitePivot.'</nobr></td>
                    <td class="csDC7EEB9" colspan="4" style="width:99px;height:22px;line-height:13px;text-align:center;vertical-align:middle;"><nobr>'.$row->QtePhysiquePivot.'&nbsp;'.$row->unitePivot.'</nobr></td>
                    <td class="csDC7EEB9" colspan="2" style="width:121px;height:22px;line-height:13px;text-align:center;vertical-align:middle;"><nobr>'.$row->SoldePivot.'&nbsp;'.$row->unitePivot.'</nobr></td>
                </tr>
           ';
     
    }

    return $output;

}










//================= RAPPORT JOURNALIER DES VENTES SERVICE PRODUIT =============================================

public function fetch_rapport_detailvente_date_service_byproduit(Request $request)
{
    //refDepartement

    if ($request->get('date1') && $request->get('date2')&& $request->get('idService') && $request->get('idProduit')) {
        // code...
        $date1 = $request->get('date1');
        $date2 = $request->get('date2');
        $idService = $request->get('idService');
        $idProduit = $request->get('idProduit');

        $html ='<html><head><meta http-equiv="Content-Type" content="text/html; charset=utf-8"/>';
        $html .= $this->printRapportDetailVente_Service_Produit($date1, $date2,$idService,$idProduit);       
        $html .='<script>window.print()</script>';

        echo($html);          

    } else {
        // code...
    }  
    
}
function printRapportDetailVente_Service_Produit($date1, $date2,$idService,$idProduit)
{

         //Info Entreprise
         $nomEse='';
         $adresseEse='';
         $Tel1Ese='';
         $Tel2Ese='';
         $siteEse='';
         $emailEse='';
         $idNatEse='';
         $numImpotEse='';
         $rccEse='';
         $siege='';
         $busnessName='';
         $pic='';
         $pic2 = $this->displayImg("fichier", 'logo.png');
         $logo='';
 
         $data1 = DB::table('entreprises')
         ->join('secteurs','secteurs.id','=','entreprises.idsecteur')
         ->join('forme_juridiques','forme_juridiques.id','=','entreprises.idforme')
 
         ->join('pays','pays.id','=','entreprises.idPays')
         ->join('provinces','provinces.id','=','entreprises.idProvince')
         ->join('users','users.id','=','entreprises.ceo')        
         ->select('entreprises.id as id','entreprises.id as idEntreprise',
         'entreprises.ceo','entreprises.nomEntreprise','entreprises.descriptionEntreprise',
         'entreprises.emailEntreprise','entreprises.adresseEntreprise',
         'entreprises.telephoneEntreprise','entreprises.solutionEntreprise','entreprises.idsecteur',
         'entreprises.idforme','entreprises.etat',
         'entreprises.idPays','entreprises.idProvince','entreprises.edition','entreprises.facebook',
         'entreprises.linkedin','entreprises.twitter','entreprises.siteweb','entreprises.rccm',
         'entreprises.invPersonnel','entreprises.invHub','entreprises.invRecherche',
         'entreprises.chiffreAffaire','entreprises.nbremploye','entreprises.slug','entreprises.logo',
             //forme
             'forme_juridiques.nomForme','secteurs.nomSecteur',
             //users
             'users.name','users.email','users.avatar','users.telephone','users.adresse',
             //
             'provinces.nomProvince','pays.nomPays', 'entreprises.created_at')
         ->get();
         $output='';
         foreach ($data1 as $row) 
         {                                
             $nomEse=$row->nomEntreprise;
             $adresseEse=$row->adresseEntreprise;
             $Tel1Ese=$row->telephoneEntreprise;
             $Tel2Ese=$row->telephone;
             $siteEse=$row->siteweb;
             $emailEse=$row->emailEntreprise;
             $idNatEse=$row->rccm;
             $numImpotEse=$row->rccm;
             $busnessName=$row->nomSecteur;
             $rccmEse=$row->rccm;
             $pic = $this->displayImg("fichier", 'logo.png');
             $siege=$row->nomForme;         
         }
 



         $sommePHT=0;
         $sommeTVA=0;
         $sommePTTF=0;
         // 
         $data2 =  DB::table('tvente_detail_vente')
         ->join('tvente_produit','tvente_produit.id','=','tvente_detail_vente.refProduit')
         ->join('tvente_categorie_produit','tvente_categorie_produit.id','=','tvente_produit.refCategorie')
 
         ->join('tvente_entete_vente','tvente_entete_vente.id','=','tvente_detail_vente.refEnteteVente')        
         ->join('tvente_module','tvente_module.id','=','tvente_entete_vente.module_id')
         ->join('tvente_services','tvente_services.id','=','tvente_entete_vente.refService')
         ->join('tvente_client','tvente_client.id','=','tvente_entete_vente.refClient')
         ->join('tvente_categorie_client','tvente_categorie_client.id','=','tvente_client.refCategieClient')  
         ->join('tfin_ssouscompte as compteclient','compteclient.id','=','tvente_categorie_client.compte_client')

         ->select(DB::raw('ROUND(SUM(((qteVente*puVente) - montantreduction)),4) as sommePHT, 
         ROUND(SUM(montanttva),4) as sommeTVA,
         ROUND(SUM(ROUND(((qteVente*puVente) - montantreduction + montanttva),4)),4) as sommePTTF'))
         ->where([
            ['dateVente','>=', $date1],
            ['dateVente','<=', $date2],
            ['tvente_services.id','=', $idService],
            ['tvente_produit.id','=', $idProduit],
        ])    
         ->get(); 
         $output='';
         foreach ($data2 as $row) 
         {                                
            $sommePHT=$row->sommePHT;
            $sommeTVA=$row->sommeTVA;
            $sommePTTF=$row->sommePTTF;                           
         }




         $services='';
         $nom_produit='';

         $data3=DB::table('tvente_detail_vente')
         ->join('tvente_produit','tvente_produit.id','=','tvente_detail_vente.refProduit')
         ->join('tvente_categorie_produit','tvente_categorie_produit.id','=','tvente_produit.refCategorie')
         ->join('tvente_entete_vente','tvente_entete_vente.id','=','tvente_detail_vente.refEnteteVente')
         ->join('tvente_services','tvente_services.id','=','tvente_entete_vente.refService')
         ->join('tvente_client','tvente_client.id','=','tvente_entete_vente.refClient')
         ->join('tvente_categorie_client','tvente_categorie_client.id','=','tvente_client.refCategieClient')
         ->select('tvente_detail_vente.id','refEnteteVente','refProduit','puVente','qteVente','dateVente',
         'libelle',"tvente_produit.designation","refCategorie","pu","tvente_categorie_produit.designation as Categorie",
         'tvente_detail_vente.author','tvente_detail_vente.created_at','noms','sexe',
         'contact','mail','adresse','pieceidentite','numeroPiece','dateLivrePiece','lieulivraisonCarte',
         'nationnalite','datenaissance','lieunaissance','profession','occupation','nombreEnfant',
         'dateArriverGoma','arriverPar','refCategieClient','photo','slug','nom_service',
         'tvente_detail_vente.devise','tvente_detail_vente.taux','tvente_categorie_client.designation as CategorieClient')
         ->where([
            ['dateVente','>=', $date1],
            ['dateVente','<=', $date2],
            ['tvente_services.id','=', $idService],
            ['tvente_produit.id','=', $idProduit],
        ])      
        ->get();      
        $output='';
        foreach ($data3 as $row) 
        {
            $services=$row->nom_service;  
            $nom_produit=$row->designation;            
        }


          

        $output='

                <!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Transitional//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd">
                <!-- saved from url=(0016)http://localhost -->
                <html>
                <head>
                    <title>rpt_DetailFactureAbonne</title>
                    <meta HTTP-EQUIV="Content-Type" CONTENT="text/html; charset=utf-8"/>
                    <style type="text/css">
                        .csB6F858D0 {color:#000000;background-color:#D6E5F4;border-left-style: none;border-top-style: none;border-right-style: none;border-bottom-style: none;font-family:Times New Roman; font-size:24px; font-weight:bold; font-style:normal; padding-left:2px;padding-right:2px;}
                        .cs49AA1D99 {color:#000000;background-color:#E0E0E0;border-left:#000000 1px solid;border-top:#000000 1px solid;border-right:#000000 1px solid;border-bottom:#000000 1px solid;font-family:Times New Roman; font-size:13px; font-weight:bold; font-style:normal; }
                        .cs8AAF79E9 {color:#000000;background-color:#E0E0E0;border-left-style: none;border-top:#000000 1px solid;border-right:#000000 1px solid;border-bottom:#000000 1px solid;font-family:Times New Roman; font-size:12px; font-weight:bold; font-style:normal; }
                        .cs9FE9304F {color:#000000;background-color:#E0E0E0;border-left-style: none;border-top:#000000 1px solid;border-right:#000000 1px solid;border-bottom:#000000 1px solid;font-family:Times New Roman; font-size:13px; font-weight:bold; font-style:normal; }
                        .csE6D2AE99 {color:#000000;background-color:#E0E0E0;border-left-style: none;border-top:#000000 1px solid;border-right-style: none;border-bottom:#000000 1px solid;font-family:Times New Roman; font-size:12px; font-weight:bold; font-style:normal; }
                        .csEAC52FCD {color:#000000;background-color:#E0E0E0;border-left-style: none;border-top:#000000 1px solid;border-right-style: none;border-bottom:#000000 1px solid;font-family:Times New Roman; font-size:13px; font-weight:bold; font-style:normal; }
                        .cs56F73198 {color:#000000;background-color:transparent;border-left:#000000 1px solid;border-top:#000000 1px solid;border-right:#000000 1px solid;border-bottom:#000000 1px solid;font-family:Times New Roman; font-size:16px; font-weight:normal; font-style:normal; padding-left:2px;}
                        .cs6E02D7D2 {color:#000000;background-color:transparent;border-left-style: none;border-top:#000000 1px solid;border-right:#000000 1px solid;border-bottom:#000000 1px solid;font-family:Times New Roman; font-size:14px; font-weight:normal; font-style:normal; }
                        .cs6C28398D {color:#000000;background-color:transparent;border-left-style: none;border-top:#000000 1px solid;border-right-style: none;border-bottom:#000000 1px solid;font-family:Times New Roman; font-size:14px; font-weight:normal; font-style:normal; }
                        .cs612ED82F {color:#000000;background-color:transparent;border-left-style: none;border-top-style: none;border-right-style: none;border-bottom-style: none;font-family:Times New Roman; font-size:12px; font-weight:bold; font-style:normal; padding-left:2px;}
                        .csFFC1C457 {color:#000000;background-color:transparent;border-left-style: none;border-top-style: none;border-right-style: none;border-bottom-style: none;font-family:Times New Roman; font-size:12px; font-weight:normal; font-style:normal; padding-left:2px;}
                        .cs101A94F7 {color:#000000;background-color:transparent;border-left-style: none;border-top-style: none;border-right-style: none;border-bottom-style: none;font-family:Times New Roman; font-size:13px; font-weight:normal; font-style:normal; }
                        .csCE72709D {color:#000000;background-color:transparent;border-left-style: none;border-top-style: none;border-right-style: none;border-bottom-style: none;font-family:Times New Roman; font-size:14px; font-weight:bold; font-style:normal; padding-left:2px;}
                        .cs12FE94AA {color:#000000;background-color:transparent;border-left-style: none;border-top-style: none;border-right-style: none;border-bottom-style: none;font-family:Times New Roman; font-size:14px; font-weight:normal; font-style:normal; padding-left:2px;}
                        .csFBB219FE {color:#000000;background-color:transparent;border-left-style: none;border-top-style: none;border-right-style: none;border-bottom-style: none;font-family:Times New Roman; font-size:18px; font-weight:bold; font-style:normal; padding-left:2px;}
                        .cs739196BC {color:#5C5C5C;background-color:transparent;border-left-style: none;border-top-style: none;border-right-style: none;border-bottom-style: none;font-family:Segoe UI; font-size:11px; font-weight:normal; font-style:normal; }
                        .csF7D3565D {height:0px;width:0px;overflow:hidden;font-size:0px;line-height:0px;}
                    </style>
                </head>
                <body leftMargin=10 topMargin=10 rightMargin=10 bottomMargin=10 style="background-color:#FFFFFF">
                <table cellpadding="0" cellspacing="0" border="0" style="border-width:0px;empty-cells:show;width:925px;height:383px;position:relative;">
                    <tr>
                        <td style="width:0px;height:0px;"></td>
                        <td style="height:0px;width:10px;"></td>
                        <td style="height:0px;width:102px;"></td>
                        <td style="height:0px;width:36px;"></td>
                        <td style="height:0px;width:71px;"></td>
                        <td style="height:0px;width:124px;"></td>
                        <td style="height:0px;width:66px;"></td>
                        <td style="height:0px;width:23px;"></td>
                        <td style="height:0px;width:149px;"></td>
                        <td style="height:0px;width:43px;"></td>
                        <td style="height:0px;width:60px;"></td>
                        <td style="height:0px;width:10px;"></td>
                        <td style="height:0px;width:30px;"></td>
                        <td style="height:0px;width:41px;"></td>
                        <td style="height:0px;width:12px;"></td>
                        <td style="height:0px;width:47px;"></td>
                        <td style="height:0px;width:75px;"></td>
                        <td style="height:0px;width:25px;"></td>
                        <td style="height:0px;width:1px;"></td>
                    </tr>
                    <tr style="vertical-align:top;">
                        <td style="width:0px;height:23px;"></td>
                        <td class="cs739196BC" colspan="6" style="width:409px;height:23px;line-height:14px;text-align:center;vertical-align:middle;"><nobr></nobr></td>
                        <td></td>
                        <td></td>
                        <td></td>
                        <td></td>
                        <td></td>
                        <td></td>
                        <td></td>
                        <td></td>
                        <td></td>
                        <td></td>
                        <td></td>
                        <td></td>
                    </tr>
                    <tr style="vertical-align:top;">
                        <td style="width:0px;height:9px;"></td>
                        <td></td>
                        <td></td>
                        <td></td>
                        <td></td>
                        <td></td>
                        <td></td>
                        <td></td>
                        <td></td>
                        <td></td>
                        <td></td>
                        <td></td>
                        <td></td>
                        <td></td>
                        <td></td>
                        <td></td>
                        <td></td>
                        <td></td>
                        <td></td>
                    </tr>
                    <tr style="vertical-align:top;">
                        <td style="width:0px;height:1px;"></td>
                        <td></td>
                        <td class="csFBB219FE" colspan="10" rowspan="2" style="width:682px;height:23px;line-height:21px;text-align:left;vertical-align:middle;"><nobr>'.$nomEse.'</nobr></td>
                        <td></td>
                        <td></td>
                        <td></td>
                        <td></td>
                        <td></td>
                        <td></td>
                        <td></td>
                    </tr>
                    <tr style="vertical-align:top;">
                        <td style="width:0px;height:22px;"></td>
                        <td></td>
                        <td></td>
                        <td class="cs101A94F7" colspan="4" rowspan="7" style="width:175px;height:144px;text-align:left;vertical-align:top;"><div style="overflow:hidden;width:175px;height:144px;">
                            <img alt="" src="'.$pic2.'" style="width:175px;height:144px;" /></div>
                        </td>
                        <td></td>
                        <td></td>
                    </tr>
                    <tr style="vertical-align:top;">
                        <td style="width:0px;height:22px;"></td>
                        <td></td>
                        <td class="csCE72709D" colspan="10" style="width:682px;height:22px;line-height:15px;text-align:left;vertical-align:middle;"><nobr>'.$busnessName.'</nobr></td>
                        <td></td>
                        <td></td>
                        <td></td>
                    </tr>
                    <tr style="vertical-align:top;">
                        <td style="width:0px;height:22px;"></td>
                        <td></td>
                        <td class="csCE72709D" colspan="10" style="width:682px;height:22px;line-height:15px;text-align:left;vertical-align:middle;"><nobr>RCCM'.$rccEse.'.&nbsp;ID-NAT.'.$idNatEse.'</nobr></td>
                        <td></td>
                        <td></td>
                        <td></td>
                    </tr>
                    <tr style="vertical-align:top;">
                        <td style="width:0px;height:22px;"></td>
                        <td></td>
                        <td class="csFFC1C457" colspan="10" style="width:682px;height:22px;line-height:13px;text-align:left;vertical-align:middle;"><nobr>'.$adresseEse.'</nobr></td>
                        <td></td>
                        <td></td>
                        <td></td>
                    </tr>
                    <tr style="vertical-align:top;">
                        <td style="width:0px;height:22px;"></td>
                        <td></td>
                        <td class="csFFC1C457" colspan="10" style="width:682px;height:22px;line-height:13px;text-align:left;vertical-align:middle;"><nobr>Email&nbsp;:&nbsp;'.$emailEse.'</nobr></td>
                        <td></td>
                        <td></td>
                        <td></td>
                    </tr>
                    <tr style="vertical-align:top;">
                        <td style="width:0px;height:22px;"></td>
                        <td></td>
                        <td class="csFFC1C457" colspan="10" style="width:682px;height:22px;line-height:13px;text-align:left;vertical-align:middle;"><nobr>Site&nbsp;web&nbsp;:&nbsp;'.$siteEse.'</nobr></td>
                        <td></td>
                        <td></td>
                        <td></td>
                    </tr>
                    <tr style="vertical-align:top;">
                        <td style="width:0px;height:12px;"></td>
                        <td></td>
                        <td class="cs612ED82F" colspan="10" rowspan="2" style="width:682px;height:23px;line-height:13px;text-align:left;vertical-align:middle;"><nobr>T&#233;l&#233;phone&nbsp;:&nbsp;'.$Tel1Ese.'&nbsp;&nbsp;24h/24</nobr></td>
                        <td></td>
                        <td></td>
                        <td></td>
                    </tr>
                    <tr style="vertical-align:top;">
                        <td style="width:0px;height:11px;"></td>
                        <td></td>
                        <td></td>
                        <td></td>
                        <td></td>
                        <td></td>
                        <td></td>
                        <td></td>
                        <td></td>
                    </tr>
                    <tr style="vertical-align:top;">
                        <td style="width:0px;height:8px;"></td>
                        <td></td>
                        <td></td>
                        <td></td>
                        <td></td>
                        <td></td>
                        <td></td>
                        <td></td>
                        <td></td>
                        <td></td>
                        <td></td>
                        <td></td>
                        <td></td>
                        <td></td>
                        <td></td>
                        <td></td>
                        <td></td>
                        <td></td>
                        <td></td>
                    </tr>
                    <tr style="vertical-align:top;">
                        <td style="width:0px;height:32px;"></td>
                        <td></td>
                        <td></td>
                        <td></td>
                        <td class="csB6F858D0" colspan="11" style="width:625px;height:32px;line-height:28px;text-align:center;vertical-align:middle;"><nobr>RAPPORT&nbsp;JOURNALIER&nbsp;DES&nbsp;VENTES</nobr></td>
                        <td></td>
                        <td></td>
                        <td></td>
                        <td></td>
                    </tr>
                    <tr style="vertical-align:top;">
                        <td style="width:0px;height:19px;"></td>
                        <td></td>
                        <td></td>
                        <td></td>
                        <td></td>
                        <td></td>
                        <td></td>
                        <td></td>
                        <td></td>
                        <td></td>
                        <td></td>
                        <td></td>
                        <td></td>
                        <td></td>
                        <td></td>
                        <td></td>
                        <td></td>
                        <td></td>
                        <td></td>
                    </tr>
                    <tr style="vertical-align:top;">
                        <td style="width:0px;height:23px;"></td>
                        <td></td>
                        <td class="cs56F73198" colspan="4" style="width:329px;height:21px;line-height:18px;text-align:left;vertical-align:top;"><nobr>&nbsp;PERIODE&nbsp;:&nbsp;&nbsp;Du&nbsp;&nbsp;'.$date1.'&nbsp;&nbsp;au&nbsp;'.$date2.'</nobr></td>
                        <td class="cs56F73198" colspan="12" style="width:577px;height:21px;line-height:18px;text-align:left;vertical-align:top;"><nobr>'.$services.' - '.$nom_produit.'</nobr></td>
                        <td></td>
                    </tr>
                    <tr style="vertical-align:top;">
                        <td style="width:0px;height:9px;"></td>
                        <td></td>
                        <td></td>
                        <td></td>
                        <td></td>
                        <td></td>
                        <td></td>
                        <td></td>
                        <td></td>
                        <td></td>
                        <td></td>
                        <td></td>
                        <td></td>
                        <td></td>
                        <td></td>
                        <td></td>
                        <td></td>
                        <td></td>
                        <td></td>
                    </tr>
                    <tr style="vertical-align:top;">
                        <td style="width:0px;height:24px;"></td>
                        <td></td>
                        <td class="cs8AAF79E9" style="width:101px;height:22px;line-height:14px;text-align:center;vertical-align:middle;"><nobr>N&#176;&nbsp;FACTURE</nobr></td>
                        <td class="cs8AAF79E9" colspan="3" style="width:230px;height:22px;line-height:14px;text-align:center;vertical-align:middle;"><nobr>CLIENT</nobr></td>
                        <td class="cs8AAF79E9" colspan="2" style="width:88px;height:22px;line-height:14px;text-align:center;vertical-align:middle;"><nobr>DATE&nbsp;FACT.</nobr></td>
                        <td class="cs8AAF79E9" style="width:148px;height:22px;line-height:14px;text-align:center;vertical-align:middle;"><nobr>ARTICLE</nobr></td>
                        <td class="cs8AAF79E9" style="width:42px;height:22px;line-height:14px;text-align:center;vertical-align:middle;"><nobr>Qt&#233;</nobr></td>
                        <td class="cs8AAF79E9" style="width:59px;height:22px;line-height:14px;text-align:center;vertical-align:middle;"><nobr>PU(USD)</nobr></td>
                        <td class="cs8AAF79E9" colspan="3" style="width:80px;height:22px;line-height:14px;text-align:center;vertical-align:middle;"><nobr>PHT(USD)</nobr></td>
                        <td class="cs8AAF79E9" colspan="2" style="width:58px;height:22px;line-height:14px;text-align:center;vertical-align:middle;"><nobr>%&nbsp;TVA</nobr></td>
                        <td class="csE6D2AE99" colspan="3" style="width:101px;height:22px;line-height:14px;text-align:center;vertical-align:middle;"><nobr>PTTTC($)</nobr></td>
                    </tr>
                    ';

                            $output .= $this->showDetailVente_Service_Produit($date1,$date2,$idService,$idProduit); 

                            $output.='
                    <tr style="vertical-align:top;">
                        <td style="width:0px;height:24px;"></td>
                        <td></td>
                        <td></td>
                        <td></td>
                        <td></td>
                        <td></td>
                        <td></td>
                        <td></td>
                        <td></td>
                        <td class="cs49AA1D99" colspan="2" style="width:101px;height:22px;line-height:15px;text-align:center;vertical-align:middle;"><nobr>TOTAL&nbsp;($)&nbsp;:</nobr></td>
                        <td class="cs9FE9304F" colspan="3" style="width:80px;height:22px;line-height:15px;text-align:center;vertical-align:middle;"><nobr>'.$sommePHT.'</nobr></td>
                        <td class="cs9FE9304F" colspan="2" style="width:58px;height:22px;line-height:15px;text-align:center;vertical-align:middle;"><nobr>'.$sommeTVA.'</nobr></td>
                        <td class="csEAC52FCD" colspan="3" style="width:101px;height:22px;line-height:15px;text-align:center;vertical-align:middle;"><nobr>'.$sommePTTF.'</nobr></td>
                    </tr>
                    <tr style="vertical-align:top;">
                        <td style="width:0px;height:10px;"></td>
                        <td></td>
                        <td></td>
                        <td></td>
                        <td></td>
                        <td></td>
                        <td></td>
                        <td></td>
                        <td></td>
                        <td></td>
                        <td></td>
                        <td></td>
                        <td></td>
                        <td></td>
                        <td></td>
                        <td></td>
                        <td></td>
                        <td></td>
                        <td></td>
                    </tr>
                    <tr style="vertical-align:top;">
                        <td style="width:0px;height:22px;"></td>
                        <td></td>
                        <td class="cs12FE94AA" colspan="3" style="width:207px;height:22px;line-height:16px;text-align:left;vertical-align:top;"><nobr>Fait&nbsp;&#224;&nbsp;Goma&nbsp;le&nbsp;&nbsp;'.date('Y-m-d').'</nobr></td>
                        <td></td>
                        <td></td>
                        <td></td>
                        <td></td>
                        <td></td>
                        <td></td>
                        <td></td>
                        <td></td>
                        <td></td>
                        <td></td>
                        <td></td>
                        <td></td>
                        <td></td>
                        <td></td>
                    </tr>
                </table>
                </body>
                </html>
        
        ';  
       
        return $output; 

}
function showDetailVente_Service_Produit($date1,$date2,$idService,$idProduit)
{
        $data = DB::table('tvente_detail_vente')
        ->join('tvente_produit','tvente_produit.id','=','tvente_detail_vente.refProduit')
        ->join('tvente_categorie_produit','tvente_categorie_produit.id','=','tvente_produit.refCategorie')
    
        ->join('tvente_entete_vente','tvente_entete_vente.id','=','tvente_detail_vente.refEnteteVente')        
        ->join('tvente_module','tvente_module.id','=','tvente_entete_vente.module_id')
        ->join('tvente_services','tvente_services.id','=','tvente_entete_vente.refService')
        ->join('tvente_client','tvente_client.id','=','tvente_entete_vente.refClient')
        ->join('tvente_categorie_client','tvente_categorie_client.id','=','tvente_client.refCategieClient')  
        // ->join('tfin_ssouscompte as compteclient','compteclient.id','=','tvente_categorie_client.compte_client')
    
        // ->join('tfin_ssouscompte as comptevente','comptevente.id','=','tvente_categorie_produit.compte_vente')
        // ->join('tfin_ssouscompte as comptevariation','comptevariation.id','=','tvente_categorie_produit.compte_variationstock')
        // ->join('tfin_ssouscompte as compteperte','compteperte.id','=','tvente_categorie_produit.compte_perte')
        // ->join('tfin_ssouscompte as compteproduit','compteproduit.id','=','tvente_categorie_produit.compte_produit')
        // ->join('tfin_ssouscompte as comptedestockage','comptedestockage.id','=','tvente_categorie_produit.compte_destockage')
      
    
        ->select('tvente_detail_vente.id','refEnteteVente','refProduit','tvente_detail_vente.compte_vente',
        'tvente_detail_vente.compte_variationstock','tvente_detail_vente.compte_perte','tvente_detail_vente.compte_produit',
        'tvente_detail_vente.compte_destockage','puVente','qteVente','uniteVente','puBase','qteBase',
        'tvente_detail_vente.uniteBase','cmupVente','tvente_detail_vente.devise','tvente_detail_vente.taux',
        'montanttva','montantreduction',
        'tvente_detail_vente.active','tvente_detail_vente.author','tvente_detail_vente.refUser',
        'tvente_detail_vente.created_at','idStockService',
        //Produit
        'tvente_produit.designation','tvente_produit.refCategorie','tvente_produit.refUniteBase',
        'tvente_produit.pu','tvente_produit.qte','tvente_produit.cmup','tvente_produit.taux',
        'tvente_produit.Oldcode','tvente_produit.Newcode','tvente_produit.tvaapplique',
        'tvente_produit.estvendable','tvente_categorie_produit.designation as Categorie',
        //client 
        'noms','sexe','contact','mail','adresse','pieceidentite','numeroPiece','dateLivrePiece',
        'lieulivraisonCarte','nationnalite','datenaissance','lieunaissance','profession','occupation',
        'nombreEnfant','dateArriverGoma','arriverPar','refCategieClient','photo','slug',
        "tvente_categorie_client.designation as CategorieClient","compte_client",
        // 'compteclient.refSousCompte','compteclient.nom_ssouscompte','compteclient.numero_ssouscompte',
        //ente vente
        'nom_service', "tvente_module.nom_module",'tvente_entete_vente.code','refClient','refService','refReservation','module_id',
        'dateVente','libelle','tvente_entete_vente.montant','tvente_entete_vente.paie','reduction','totaltva',
        //compte produit
        // 'comptevente.refSousCompte as refSousCompteVente','comptevente.nom_ssouscompte as nom_ssouscompteVente',
        // 'comptevente.numero_ssouscompte as numero_ssouscompteVente'
        // ,'comptevariation.refSousCompte as refSousCompteVariation','comptevariation.nom_ssouscompte as nom_ssouscompteVariation',
        // 'comptevariation.numero_ssouscompte as numero_ssouscompteVariation'
        // ,'compteperte.refSousCompte as refSousComptePerte','compteperte.nom_ssouscompte as nom_ssouscomptePerte',
        // 'compteperte.numero_ssouscompte as numero_ssouscomptePerte'
        // ,'compteproduit.refSousCompte as refSousCompteProduit','compteproduit.nom_ssouscompte as nom_ssouscompteProduit',
        // 'compteproduit.numero_ssouscompte as numero_ssouscompteProduit'
        // ,'comptedestockage.refSousCompte as refSousCompteDestockage','comptedestockage.nom_ssouscompte as nom_ssouscompteDestockage',
        // 'comptedestockage.numero_ssouscompte as numero_ssouscompteDestockage',
        'priseencharge')
       ->selectRaw('ROUND(((qteVente*puVente) - montantreduction),2) as PTVente')
       ->selectRaw('ROUND(((qteVente*puVente) - montantreduction + montanttva),2) as PTVenteTVA')
       ->selectRaw('ROUND((IFNULL(montant,0)),2) as totalFacture')
       ->selectRaw('ROUND((montanttva),2) as TotalTVA')
       ->selectRaw('ROUND((((IFNULL(montant,0)) - montantreduction)+(montanttva)),2) as PTTTC')
       ->selectRaw('((qteVente*puVente)/tvente_detail_vente.taux) as PTVenteFC')
       ->selectRaw('(qteBase*puBase) as PTBase')
       ->selectRaw('IFNULL(paie,0) as totalPaie')
       ->selectRaw('(IFNULL(montant,0)-IFNULL(paie,0)) as RestePaie')
        ->selectRaw('CONCAT("S",YEAR(dateVente),"",MONTH(dateVente),"00",refEnteteVente) as codeFacture')
        ->where([
            ['dateVente','>=', $date1],
            ['dateVente','<=', $date2],
            ['tvente_services.id','=', $idService],
            ['tvente_produit.id','=', $idProduit]
        ])
        ->orderBy("tvente_detail_vente.created_at", "asc")
        ->get();
        $output='';

        foreach ($data as $row) 
        {
            $output .='
            <tr style="vertical-align:top;">
                <td style="width:0px;height:24px;"></td>
                <td></td>
                <td class="cs6E02D7D2" style="width:101px;height:22px;line-height:15px;text-align:center;vertical-align:middle;">'.$row->codeFacture.'</td>
                <td class="cs6E02D7D2" colspan="3" style="width:230px;height:22px;line-height:15px;text-align:left;vertical-align:middle;">'.$row->noms.'</td>
                <td class="cs6E02D7D2" colspan="2" style="width:88px;height:22px;line-height:15px;text-align:center;vertical-align:middle;">'.$row->dateVente.'</td>
                <td class="cs6E02D7D2" style="width:148px;height:22px;line-height:15px;text-align:left;vertical-align:middle;">'.$row->designation.'</td>
                <td class="cs6E02D7D2" style="width:42px;height:22px;line-height:15px;text-align:center;vertical-align:middle;">'.$row->qteVente.'</td>
                <td class="cs6E02D7D2" style="width:59px;height:22px;line-height:15px;text-align:center;vertical-align:middle;">'.$row->qteVente.'</td>
                <td class="cs6E02D7D2" colspan="3" style="width:80px;height:22px;line-height:15px;text-align:center;vertical-align:middle;">'.$row->PTVente.'</td>
                <td class="cs6E02D7D2" colspan="2" style="width:58px;height:22px;line-height:15px;text-align:center;vertical-align:middle;">'.$row->montanttva.'</td>
                <td class="cs6C28398D" colspan="3" style="width:101px;height:22px;line-height:15px;text-align:center;vertical-align:middle;">'.$row->PTVenteTVA.'</td>
            </tr>
        '; 
           
   
    }

    return $output;

}

//=============== RAPPORT JOURNALIER DES SORTIES PAR SERVICE ET PRODUIT ==============================================

public function fetch_rapport_detailusage_date_service_byproduit(Request $request)
{
    //type_sortie

    if ($request->get('date1') && $request->get('date2') && $request->get('idService') && $request->get('idProduit')) {
        // code...
        $date1 = $request->get('date1');
        $date2 = $request->get('date2');
        $idService = $request->get('idService');
        $idProduit = $request->get('idProduit');

        $html ='<html><head><meta http-equiv="Content-Type" content="text/html; charset=utf-8"/>';
        $html .= $this->printRapportDetailUsage_Service_Produit($date1, $date2,$idService,$idProduit);       
        $html .='<script>window.print()</script>';

        echo($html);          

    } else {
        // code...
    }  
    
}
function printRapportDetailUsage_Service_Produit($date1, $date2,$idService,$idProduit)
{

         //Info Entreprise
         $nomEse='';
         $adresseEse='';
         $Tel1Ese='';
         $Tel2Ese='';
         $siteEse='';
         $emailEse='';
         $idNatEse='';
         $numImpotEse='';
         $rccEse='';
         $siege='';
         $busnessName='';
         $pic='';
         $pic2 = $this->displayImg("fichier", 'logo.png');
         $logo='';
 
         $data1 = DB::table('entreprises')
         ->join('secteurs','secteurs.id','=','entreprises.idsecteur')
         ->join('forme_juridiques','forme_juridiques.id','=','entreprises.idforme')
 
         ->join('pays','pays.id','=','entreprises.idPays')
         ->join('provinces','provinces.id','=','entreprises.idProvince')
         ->join('users','users.id','=','entreprises.ceo')        
         ->select('entreprises.id as id','entreprises.id as idEntreprise',
         'entreprises.ceo','entreprises.nomEntreprise','entreprises.descriptionEntreprise',
         'entreprises.emailEntreprise','entreprises.adresseEntreprise',
         'entreprises.telephoneEntreprise','entreprises.solutionEntreprise','entreprises.idsecteur',
         'entreprises.idforme','entreprises.etat',
         'entreprises.idPays','entreprises.idProvince','entreprises.edition','entreprises.facebook',
         'entreprises.linkedin','entreprises.twitter','entreprises.siteweb','entreprises.rccm',
         'entreprises.invPersonnel','entreprises.invHub','entreprises.invRecherche',
         'entreprises.chiffreAffaire','entreprises.nbremploye','entreprises.slug','entreprises.logo',
             //forme
             'forme_juridiques.nomForme','secteurs.nomSecteur',
             //users
             'users.name','users.email','users.avatar','users.telephone','users.adresse',
             //
             'provinces.nomProvince','pays.nomPays', 'entreprises.created_at')
         ->get();
         $output='';
         foreach ($data1 as $row) 
         {                                
             $nomEse=$row->nomEntreprise;
             $adresseEse=$row->adresseEntreprise;
             $Tel1Ese=$row->telephoneEntreprise;
             $Tel2Ese=$row->telephone;
             $siteEse=$row->siteweb;
             $emailEse=$row->emailEntreprise;
             $idNatEse=$row->rccm;
             $numImpotEse=$row->rccm;
             $busnessName=$row->nomSecteur;
             $rccmEse=$row->rccm;
             $pic = $this->displayImg("fichier", 'logo.png');
             $siege=$row->nomForme;         
         }
 



         $sommePHT=0;
         $sommeTVA=0;
         $sommePTTF=0;
         // 
         $data2 =  DB::table('tvente_detail_utilisation')
         ->join('tvente_produit','tvente_produit.id','=','tvente_detail_utilisation.refProduit')
         ->join('tvente_categorie_produit','tvente_categorie_produit.id','=','tvente_produit.refCategorie')     
 
         ->join('tvente_entete_utilisation','tvente_entete_utilisation.id','=','tvente_detail_utilisation.refEnteteVente')        
         ->join('tvente_module','tvente_module.id','=','tvente_entete_utilisation.module_id')
         ->join('tvente_services','tvente_services.id','=','tvente_entete_utilisation.refService')
         ->join('tagent','tagent.id','=','tvente_entete_utilisation.agent_id')

         ->select(DB::raw('ROUND(SUM(((qteVente*puVente) - montantreduction)),4) as sommePHT, 
         ROUND(SUM(montanttva),4) as sommeTVA,
         ROUND(SUM(ROUND(((qteVente*puVente) - montantreduction + montanttva),4)),4) as sommePTTF'))
         ->where([
            ['dateUse','>=', $date1],
            ['dateUse','<=', $date2],
            ['tvente_services.id','=', $idService],
            ['tvente_produit.id','=', $idProduit],
        ])    
         ->get(); 
         $output='';
         foreach ($data2 as $row) 
         {                                
            $sommePHT=$row->sommePHT;
            $sommeTVA=$row->sommeTVA;
            $sommePTTF=$row->sommePTTF;                           
         }




         $CategorieClient='';

         $data3=DB::table('tvente_detail_utilisation')
         ->join('tvente_entete_utilisation','tvente_entete_utilisation.id','=','tvente_detail_utilisation.refEnteteVente')        
         ->join('tvente_module','tvente_module.id','=','tvente_entete_utilisation.module_id')
         ->join('tvente_services','tvente_services.id','=','tvente_entete_utilisation.refService')
         ->join('tvente_produit','tvente_produit.id','=','tvente_detail_utilisation.refProduit')
         ->select('nom_service', "tvente_module.nom_module",'tvente_entete_utilisation.code','refService',
         'module_id','dateUse','libelle','type_sortie','tvente_produit.designation')
         ->where([
            ['dateUse','>=', $date1],
            ['dateUse','<=', $date2],
            ['tvente_services.id','=', $idService],
            ['tvente_produit.id','=', $idProduit]
        ])      
        ->get();      
        $output='';
        foreach ($data3 as $row) 
        {
            $CategorieClient=$row->nom_service .' - '. $row->designation;              
        }


          

        $output='

                <!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Transitional//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd">
                <!-- saved from url=(0016)http://localhost -->
                <html>
                <head>
                    <title>rpt_DetailFactureAbonne</title>
                    <meta HTTP-EQUIV="Content-Type" CONTENT="text/html; charset=utf-8"/>
                    <style type="text/css">
                        .csB6F858D0 {color:#000000;background-color:#D6E5F4;border-left-style: none;border-top-style: none;border-right-style: none;border-bottom-style: none;font-family:Times New Roman; font-size:24px; font-weight:bold; font-style:normal; padding-left:2px;padding-right:2px;}
                        .cs49AA1D99 {color:#000000;background-color:#E0E0E0;border-left:#000000 1px solid;border-top:#000000 1px solid;border-right:#000000 1px solid;border-bottom:#000000 1px solid;font-family:Times New Roman; font-size:13px; font-weight:bold; font-style:normal; }
                        .cs8AAF79E9 {color:#000000;background-color:#E0E0E0;border-left-style: none;border-top:#000000 1px solid;border-right:#000000 1px solid;border-bottom:#000000 1px solid;font-family:Times New Roman; font-size:12px; font-weight:bold; font-style:normal; }
                        .cs9FE9304F {color:#000000;background-color:#E0E0E0;border-left-style: none;border-top:#000000 1px solid;border-right:#000000 1px solid;border-bottom:#000000 1px solid;font-family:Times New Roman; font-size:13px; font-weight:bold; font-style:normal; }
                        .csE6D2AE99 {color:#000000;background-color:#E0E0E0;border-left-style: none;border-top:#000000 1px solid;border-right-style: none;border-bottom:#000000 1px solid;font-family:Times New Roman; font-size:12px; font-weight:bold; font-style:normal; }
                        .csEAC52FCD {color:#000000;background-color:#E0E0E0;border-left-style: none;border-top:#000000 1px solid;border-right-style: none;border-bottom:#000000 1px solid;font-family:Times New Roman; font-size:13px; font-weight:bold; font-style:normal; }
                        .cs56F73198 {color:#000000;background-color:transparent;border-left:#000000 1px solid;border-top:#000000 1px solid;border-right:#000000 1px solid;border-bottom:#000000 1px solid;font-family:Times New Roman; font-size:16px; font-weight:normal; font-style:normal; padding-left:2px;}
                        .cs6E02D7D2 {color:#000000;background-color:transparent;border-left-style: none;border-top:#000000 1px solid;border-right:#000000 1px solid;border-bottom:#000000 1px solid;font-family:Times New Roman; font-size:14px; font-weight:normal; font-style:normal; }
                        .cs6C28398D {color:#000000;background-color:transparent;border-left-style: none;border-top:#000000 1px solid;border-right-style: none;border-bottom:#000000 1px solid;font-family:Times New Roman; font-size:14px; font-weight:normal; font-style:normal; }
                        .cs612ED82F {color:#000000;background-color:transparent;border-left-style: none;border-top-style: none;border-right-style: none;border-bottom-style: none;font-family:Times New Roman; font-size:12px; font-weight:bold; font-style:normal; padding-left:2px;}
                        .csFFC1C457 {color:#000000;background-color:transparent;border-left-style: none;border-top-style: none;border-right-style: none;border-bottom-style: none;font-family:Times New Roman; font-size:12px; font-weight:normal; font-style:normal; padding-left:2px;}
                        .cs101A94F7 {color:#000000;background-color:transparent;border-left-style: none;border-top-style: none;border-right-style: none;border-bottom-style: none;font-family:Times New Roman; font-size:13px; font-weight:normal; font-style:normal; }
                        .csCE72709D {color:#000000;background-color:transparent;border-left-style: none;border-top-style: none;border-right-style: none;border-bottom-style: none;font-family:Times New Roman; font-size:14px; font-weight:bold; font-style:normal; padding-left:2px;}
                        .cs12FE94AA {color:#000000;background-color:transparent;border-left-style: none;border-top-style: none;border-right-style: none;border-bottom-style: none;font-family:Times New Roman; font-size:14px; font-weight:normal; font-style:normal; padding-left:2px;}
                        .csFBB219FE {color:#000000;background-color:transparent;border-left-style: none;border-top-style: none;border-right-style: none;border-bottom-style: none;font-family:Times New Roman; font-size:18px; font-weight:bold; font-style:normal; padding-left:2px;}
                        .cs739196BC {color:#5C5C5C;background-color:transparent;border-left-style: none;border-top-style: none;border-right-style: none;border-bottom-style: none;font-family:Segoe UI; font-size:11px; font-weight:normal; font-style:normal; }
                        .csF7D3565D {height:0px;width:0px;overflow:hidden;font-size:0px;line-height:0px;}
                    </style>
                </head>
                <body leftMargin=10 topMargin=10 rightMargin=10 bottomMargin=10 style="background-color:#FFFFFF">
                <table cellpadding="0" cellspacing="0" border="0" style="border-width:0px;empty-cells:show;width:925px;height:383px;position:relative;">
                    <tr>
                        <td style="width:0px;height:0px;"></td>
                        <td style="height:0px;width:10px;"></td>
                        <td style="height:0px;width:102px;"></td>
                        <td style="height:0px;width:36px;"></td>
                        <td style="height:0px;width:71px;"></td>
                        <td style="height:0px;width:124px;"></td>
                        <td style="height:0px;width:66px;"></td>
                        <td style="height:0px;width:23px;"></td>
                        <td style="height:0px;width:149px;"></td>
                        <td style="height:0px;width:43px;"></td>
                        <td style="height:0px;width:60px;"></td>
                        <td style="height:0px;width:10px;"></td>
                        <td style="height:0px;width:30px;"></td>
                        <td style="height:0px;width:41px;"></td>
                        <td style="height:0px;width:12px;"></td>
                        <td style="height:0px;width:47px;"></td>
                        <td style="height:0px;width:75px;"></td>
                        <td style="height:0px;width:25px;"></td>
                        <td style="height:0px;width:1px;"></td>
                    </tr>
                    <tr style="vertical-align:top;">
                        <td style="width:0px;height:23px;"></td>
                        <td class="cs739196BC" colspan="6" style="width:409px;height:23px;line-height:14px;text-align:center;vertical-align:middle;"><nobr></nobr></td>
                        <td></td>
                        <td></td>
                        <td></td>
                        <td></td>
                        <td></td>
                        <td></td>
                        <td></td>
                        <td></td>
                        <td></td>
                        <td></td>
                        <td></td>
                        <td></td>
                    </tr>
                    <tr style="vertical-align:top;">
                        <td style="width:0px;height:9px;"></td>
                        <td></td>
                        <td></td>
                        <td></td>
                        <td></td>
                        <td></td>
                        <td></td>
                        <td></td>
                        <td></td>
                        <td></td>
                        <td></td>
                        <td></td>
                        <td></td>
                        <td></td>
                        <td></td>
                        <td></td>
                        <td></td>
                        <td></td>
                        <td></td>
                    </tr>
                    <tr style="vertical-align:top;">
                        <td style="width:0px;height:1px;"></td>
                        <td></td>
                        <td class="csFBB219FE" colspan="10" rowspan="2" style="width:682px;height:23px;line-height:21px;text-align:left;vertical-align:middle;"><nobr>'.$nomEse.'</nobr></td>
                        <td></td>
                        <td></td>
                        <td></td>
                        <td></td>
                        <td></td>
                        <td></td>
                        <td></td>
                    </tr>
                    <tr style="vertical-align:top;">
                        <td style="width:0px;height:22px;"></td>
                        <td></td>
                        <td></td>
                        <td class="cs101A94F7" colspan="4" rowspan="7" style="width:175px;height:144px;text-align:left;vertical-align:top;"><div style="overflow:hidden;width:175px;height:144px;">
                            <img alt="" src="'.$pic2.'" style="width:175px;height:144px;" /></div>
                        </td>
                        <td></td>
                        <td></td>
                    </tr>
                    <tr style="vertical-align:top;">
                        <td style="width:0px;height:22px;"></td>
                        <td></td>
                        <td class="csCE72709D" colspan="10" style="width:682px;height:22px;line-height:15px;text-align:left;vertical-align:middle;"><nobr>'.$busnessName.'</nobr></td>
                        <td></td>
                        <td></td>
                        <td></td>
                    </tr>
                    <tr style="vertical-align:top;">
                        <td style="width:0px;height:22px;"></td>
                        <td></td>
                        <td class="csCE72709D" colspan="10" style="width:682px;height:22px;line-height:15px;text-align:left;vertical-align:middle;"><nobr>RCCM'.$rccEse.'.&nbsp;ID-NAT.'.$idNatEse.'</nobr></td>
                        <td></td>
                        <td></td>
                        <td></td>
                    </tr>
                    <tr style="vertical-align:top;">
                        <td style="width:0px;height:22px;"></td>
                        <td></td>
                        <td class="csFFC1C457" colspan="10" style="width:682px;height:22px;line-height:13px;text-align:left;vertical-align:middle;"><nobr>'.$adresseEse.'</nobr></td>
                        <td></td>
                        <td></td>
                        <td></td>
                    </tr>
                    <tr style="vertical-align:top;">
                        <td style="width:0px;height:22px;"></td>
                        <td></td>
                        <td class="csFFC1C457" colspan="10" style="width:682px;height:22px;line-height:13px;text-align:left;vertical-align:middle;"><nobr>Email&nbsp;:&nbsp;'.$emailEse.'</nobr></td>
                        <td></td>
                        <td></td>
                        <td></td>
                    </tr>
                    <tr style="vertical-align:top;">
                        <td style="width:0px;height:22px;"></td>
                        <td></td>
                        <td class="csFFC1C457" colspan="10" style="width:682px;height:22px;line-height:13px;text-align:left;vertical-align:middle;"><nobr>Site&nbsp;web&nbsp;:&nbsp;'.$siteEse.'</nobr></td>
                        <td></td>
                        <td></td>
                        <td></td>
                    </tr>
                    <tr style="vertical-align:top;">
                        <td style="width:0px;height:12px;"></td>
                        <td></td>
                        <td class="cs612ED82F" colspan="10" rowspan="2" style="width:682px;height:23px;line-height:13px;text-align:left;vertical-align:middle;"><nobr>T&#233;l&#233;phone&nbsp;:&nbsp;'.$Tel1Ese.'&nbsp;&nbsp;24h/24</nobr></td>
                        <td></td>
                        <td></td>
                        <td></td>
                    </tr>
                    <tr style="vertical-align:top;">
                        <td style="width:0px;height:11px;"></td>
                        <td></td>
                        <td></td>
                        <td></td>
                        <td></td>
                        <td></td>
                        <td></td>
                        <td></td>
                        <td></td>
                    </tr>
                    <tr style="vertical-align:top;">
                        <td style="width:0px;height:8px;"></td>
                        <td></td>
                        <td></td>
                        <td></td>
                        <td></td>
                        <td></td>
                        <td></td>
                        <td></td>
                        <td></td>
                        <td></td>
                        <td></td>
                        <td></td>
                        <td></td>
                        <td></td>
                        <td></td>
                        <td></td>
                        <td></td>
                        <td></td>
                        <td></td>
                    </tr>
                    <tr style="vertical-align:top;">
                        <td style="width:0px;height:32px;"></td>
                        <td></td>
                        <td></td>
                        <td></td>
                        <td class="csB6F858D0" colspan="11" style="width:625px;height:32px;line-height:28px;text-align:center;vertical-align:middle;"><nobr>RAPPORT&nbsp;JOURNALIER&nbsp;DES&nbsp;VENTES</nobr></td>
                        <td></td>
                        <td></td>
                        <td></td>
                        <td></td>
                    </tr>
                    <tr style="vertical-align:top;">
                        <td style="width:0px;height:19px;"></td>
                        <td></td>
                        <td></td>
                        <td></td>
                        <td></td>
                        <td></td>
                        <td></td>
                        <td></td>
                        <td></td>
                        <td></td>
                        <td></td>
                        <td></td>
                        <td></td>
                        <td></td>
                        <td></td>
                        <td></td>
                        <td></td>
                        <td></td>
                        <td></td>
                    </tr>
                    <tr style="vertical-align:top;">
                        <td style="width:0px;height:23px;"></td>
                        <td></td>
                        <td class="cs56F73198" colspan="4" style="width:329px;height:21px;line-height:18px;text-align:left;vertical-align:top;"><nobr>&nbsp;PERIODE&nbsp;:&nbsp;&nbsp;Du&nbsp;&nbsp;'.$date1.'&nbsp;&nbsp;au&nbsp;'.$date2.'</nobr></td>
                        <td class="cs56F73198" colspan="12" style="width:577px;height:21px;line-height:18px;text-align:left;vertical-align:top;"><nobr>'.$CategorieClient.'</nobr></td>
                        <td></td>
                    </tr>
                    <tr style="vertical-align:top;">
                        <td style="width:0px;height:9px;"></td>
                        <td></td>
                        <td></td>
                        <td></td>
                        <td></td>
                        <td></td>
                        <td></td>
                        <td></td>
                        <td></td>
                        <td></td>
                        <td></td>
                        <td></td>
                        <td></td>
                        <td></td>
                        <td></td>
                        <td></td>
                        <td></td>
                        <td></td>
                        <td></td>
                    </tr>
                    <tr style="vertical-align:top;">
                        <td style="width:0px;height:24px;"></td>
                        <td></td>
                        <td class="cs8AAF79E9" style="width:101px;height:22px;line-height:14px;text-align:center;vertical-align:middle;"><nobr>N&#176;&nbsp;FACTURE</nobr></td>
                        <td class="cs8AAF79E9" colspan="3" style="width:230px;height:22px;line-height:14px;text-align:center;vertical-align:middle;"><nobr>CLIENT</nobr></td>
                        <td class="cs8AAF79E9" colspan="2" style="width:88px;height:22px;line-height:14px;text-align:center;vertical-align:middle;"><nobr>DATE&nbsp;FACT.</nobr></td>
                        <td class="cs8AAF79E9" style="width:148px;height:22px;line-height:14px;text-align:center;vertical-align:middle;"><nobr>ARTICLE</nobr></td>
                        <td class="cs8AAF79E9" style="width:42px;height:22px;line-height:14px;text-align:center;vertical-align:middle;"><nobr>Qt&#233;</nobr></td>
                        <td class="cs8AAF79E9" style="width:59px;height:22px;line-height:14px;text-align:center;vertical-align:middle;"><nobr>PU(USD)</nobr></td>
                        <td class="cs8AAF79E9" colspan="3" style="width:80px;height:22px;line-height:14px;text-align:center;vertical-align:middle;"><nobr>PHT(USD)</nobr></td>
                        <td class="cs8AAF79E9" colspan="2" style="width:58px;height:22px;line-height:14px;text-align:center;vertical-align:middle;"><nobr>%&nbsp;TVA</nobr></td>
                        <td class="csE6D2AE99" colspan="3" style="width:101px;height:22px;line-height:14px;text-align:center;vertical-align:middle;"><nobr>PTTTC($)</nobr></td>
                    </tr>
                    ';

                            $output .= $this->showDetailUsage_Service_Produit($date1,$date2,$idService,$idProduit); 

                            $output.='
                    <tr style="vertical-align:top;">
                        <td style="width:0px;height:24px;"></td>
                        <td></td>
                        <td></td>
                        <td></td>
                        <td></td>
                        <td></td>
                        <td></td>
                        <td></td>
                        <td></td>
                        <td class="cs49AA1D99" colspan="2" style="width:101px;height:22px;line-height:15px;text-align:center;vertical-align:middle;"><nobr>TOTAL&nbsp;($)&nbsp;:</nobr></td>
                        <td class="cs9FE9304F" colspan="3" style="width:80px;height:22px;line-height:15px;text-align:center;vertical-align:middle;"><nobr>'.$sommePHT.'</nobr></td>
                        <td class="cs9FE9304F" colspan="2" style="width:58px;height:22px;line-height:15px;text-align:center;vertical-align:middle;"><nobr>'.$sommeTVA.'</nobr></td>
                        <td class="csEAC52FCD" colspan="3" style="width:101px;height:22px;line-height:15px;text-align:center;vertical-align:middle;"><nobr>'.$sommePTTF.'</nobr></td>
                    </tr>
                    <tr style="vertical-align:top;">
                        <td style="width:0px;height:10px;"></td>
                        <td></td>
                        <td></td>
                        <td></td>
                        <td></td>
                        <td></td>
                        <td></td>
                        <td></td>
                        <td></td>
                        <td></td>
                        <td></td>
                        <td></td>
                        <td></td>
                        <td></td>
                        <td></td>
                        <td></td>
                        <td></td>
                        <td></td>
                        <td></td>
                    </tr>
                    <tr style="vertical-align:top;">
                        <td style="width:0px;height:22px;"></td>
                        <td></td>
                        <td class="cs12FE94AA" colspan="3" style="width:207px;height:22px;line-height:16px;text-align:left;vertical-align:top;"><nobr>Fait&nbsp;&#224;&nbsp;Goma&nbsp;le&nbsp;&nbsp;'.date('Y-m-d').'</nobr></td>
                        <td></td>
                        <td></td>
                        <td></td>
                        <td></td>
                        <td></td>
                        <td></td>
                        <td></td>
                        <td></td>
                        <td></td>
                        <td></td>
                        <td></td>
                        <td></td>
                        <td></td>
                        <td></td>
                    </tr>
                </table>
                </body>
                </html>
        
        ';  
       
        return $output; 

}
function showDetailUsage_Service_Produit($date1,$date2,$idService,$idProduit)
{
        $data = DB::table('tvente_detail_utilisation')
        ->join('tvente_produit','tvente_produit.id','=','tvente_detail_utilisation.refProduit')
        ->join('tvente_categorie_produit','tvente_categorie_produit.id','=','tvente_produit.refCategorie')        

        ->join('tvente_entete_utilisation','tvente_entete_utilisation.id','=','tvente_detail_utilisation.refEnteteVente')        
        ->join('tvente_module','tvente_module.id','=','tvente_entete_utilisation.module_id')
        ->join('tvente_services','tvente_services.id','=','tvente_entete_utilisation.refService')
        ->join('tagent','tagent.id','=','tvente_entete_utilisation.agent_id')

        ->select('tvente_detail_utilisation.id','refEnteteVente','refProduit','tvente_detail_utilisation.compte_vente',
        'tvente_detail_utilisation.compte_variationstock','tvente_detail_utilisation.compte_perte',
        'tvente_detail_utilisation.compte_produit','tvente_detail_utilisation.compte_destockage','puVente',
        'qteVente','uniteVente','puBase','qteBase','tvente_detail_utilisation.uniteBase','cmupVente',
        'tvente_detail_utilisation.devise','tvente_detail_utilisation.taux','montantreduction',
        'tvente_detail_utilisation.active','tvente_detail_utilisation.author','tvente_detail_utilisation.refUser',
        'tvente_detail_utilisation.created_at','idStockService',

        'tvente_produit.designation','tvente_produit.refCategorie','tvente_produit.refUniteBase',
        'tvente_produit.pu','tvente_produit.qte','tvente_produit.cmup','tvente_produit.taux',
        'tvente_produit.Oldcode','tvente_produit.Newcode','tvente_produit.tvaapplique',
        'tvente_produit.estvendable','montanttva',         
        'matricule_agent','noms_agent','sexe_agent','datenaissance_agent',
        'lieunaissnce_agent','provinceOrigine_agent','etatcivil_agent','refAvenue_agent','nummaison_agent',
        'contact_agent','mail_agent','grade_agent','fonction_agent','specialite_agent',
        'Categorie_agent','niveauEtude_agent','anneeFinEtude_agent','Ecole_agent','conjoint_agent', 
        'nomPere_agent', 'nomMere_agent', 'Nationalite_agent', 'Collectivite_agent', 
        'Territoire_agent', 'EmployeurAnt_agent', 'PersRef_agent','photo','slug','cartes','envie',

        'nom_service', "tvente_module.nom_module",'tvente_entete_utilisation.code','refService',
        'module_id','dateUse','libelle', 
        'type_sortie')
        ->selectRaw('ROUND(((qteVente*puVente) - montantreduction),2) as PTVente')
       ->selectRaw('ROUND(((qteVente*puVente) - montantreduction + montanttva),2) as PTVenteTVA')
       ->selectRaw('ROUND((IFNULL(qteVente*puVente,0)),2) as totalFacture')
       ->selectRaw('ROUND((montanttva),2) as TotalTVA')
        ->selectRaw('CONCAT("S",YEAR(dateUse),"",MONTH(dateUse),"00",refEnteteVente) as codeFacture')
        ->where([
            ['dateUse','>=', $date1],
            ['dateUse','<=', $date2],
            ['tvente_services.id','=', $idService],
            ['tvente_produit.id','=', $idProduit]
        ])
        ->orderBy("tvente_detail_utilisation.created_at", "asc")
        ->get();
        $output='';

        foreach ($data as $row) 
        {
            $output .='
            <tr style="vertical-align:top;">
                <td style="width:0px;height:24px;"></td>
                <td></td>
                <td class="cs6E02D7D2" style="width:101px;height:22px;line-height:15px;text-align:center;vertical-align:middle;">'.$row->codeFacture.'</td>
                <td class="cs6E02D7D2" colspan="3" style="width:230px;height:22px;line-height:15px;text-align:left;vertical-align:middle;">'.$row->nom_service.' : '.$row->noms_agent.'</td>
                <td class="cs6E02D7D2" colspan="2" style="width:88px;height:22px;line-height:15px;text-align:center;vertical-align:middle;">'.$row->dateUse.'</td>
                <td class="cs6E02D7D2" style="width:148px;height:22px;line-height:15px;text-align:left;vertical-align:middle;">'.$row->designation.'</td>
                <td class="cs6E02D7D2" style="width:42px;height:22px;line-height:15px;text-align:center;vertical-align:middle;">'.$row->qteVente.' ('.$row->uniteVente.')</td>
                <td class="cs6E02D7D2" style="width:59px;height:22px;line-height:15px;text-align:center;vertical-align:middle;">'.$row->qteVente.'</td>
                <td class="cs6E02D7D2" colspan="3" style="width:80px;height:22px;line-height:15px;text-align:center;vertical-align:middle;">'.$row->PTVente.'</td>
                <td class="cs6E02D7D2" colspan="2" style="width:58px;height:22px;line-height:15px;text-align:center;vertical-align:middle;">'.$row->montanttva.'</td>
                <td class="cs6C28398D" colspan="3" style="width:101px;height:22px;line-height:15px;text-align:center;vertical-align:middle;">'.$row->PTVenteTVA.'</td>
            </tr>
        '; 
           
   
    }

    return $output;

}


//=============== RAPPORT JOURNALIER DES SORTIES PAR SERVICE ET PRODUIT ==============================================

public function fetch_rapport_detailusage_date_service_bycategorie(Request $request)
{

    if ($request->get('date1') && $request->get('date2') && $request->get('idService') && $request->get('idCategorie')) {
        // code...
        $date1 = $request->get('date1');
        $date2 = $request->get('date2');
        $idService = $request->get('idService');
        $idCategorie = $request->get('idCategorie');

        $html ='<html><head><meta http-equiv="Content-Type" content="text/html; charset=utf-8"/>';
        $html .= $this->printRapportDetailUsage_Service_Categorie($date1, $date2,$idService,$idCategorie);       
        $html .='<script>window.print()</script>';

        echo($html);          

    } else {
        // code...
    }  
    
}
function printRapportDetailUsage_Service_Categorie($date1, $date2,$idService,$idCategorie)
{

         //Info Entreprise
         $nomEse='';
         $adresseEse='';
         $Tel1Ese='';
         $Tel2Ese='';
         $siteEse='';
         $emailEse='';
         $idNatEse='';
         $numImpotEse='';
         $rccEse='';
         $siege='';
         $busnessName='';
         $pic='';
         $pic2 = $this->displayImg("fichier", 'logo.png');
         $logo='';
 
         $data1 = DB::table('entreprises')
         ->join('secteurs','secteurs.id','=','entreprises.idsecteur')
         ->join('forme_juridiques','forme_juridiques.id','=','entreprises.idforme')
 
         ->join('pays','pays.id','=','entreprises.idPays')
         ->join('provinces','provinces.id','=','entreprises.idProvince')
         ->join('users','users.id','=','entreprises.ceo')        
         ->select('entreprises.id as id','entreprises.id as idEntreprise',
         'entreprises.ceo','entreprises.nomEntreprise','entreprises.descriptionEntreprise',
         'entreprises.emailEntreprise','entreprises.adresseEntreprise',
         'entreprises.telephoneEntreprise','entreprises.solutionEntreprise','entreprises.idsecteur',
         'entreprises.idforme','entreprises.etat',
         'entreprises.idPays','entreprises.idProvince','entreprises.edition','entreprises.facebook',
         'entreprises.linkedin','entreprises.twitter','entreprises.siteweb','entreprises.rccm',
         'entreprises.invPersonnel','entreprises.invHub','entreprises.invRecherche',
         'entreprises.chiffreAffaire','entreprises.nbremploye','entreprises.slug','entreprises.logo',
             //forme
             'forme_juridiques.nomForme','secteurs.nomSecteur',
             //users
             'users.name','users.email','users.avatar','users.telephone','users.adresse',
             //
             'provinces.nomProvince','pays.nomPays', 'entreprises.created_at')
         ->get();
         $output='';
         foreach ($data1 as $row) 
         {                                
             $nomEse=$row->nomEntreprise;
             $adresseEse=$row->adresseEntreprise;
             $Tel1Ese=$row->telephoneEntreprise;
             $Tel2Ese=$row->telephone;
             $siteEse=$row->siteweb;
             $emailEse=$row->emailEntreprise;
             $idNatEse=$row->rccm;
             $numImpotEse=$row->rccm;
             $busnessName=$row->nomSecteur;
             $rccmEse=$row->rccm;
             $pic = $this->displayImg("fichier", 'logo.png');
             $siege=$row->nomForme;         
         }
 



         $sommePHT=0;
         $sommeTVA=0;
         $sommePTTF=0;
         // 
         $data2 =  DB::table('tvente_detail_utilisation')
         ->join('tvente_produit','tvente_produit.id','=','tvente_detail_utilisation.refProduit')
         ->join('tvente_categorie_produit','tvente_categorie_produit.id','=','tvente_produit.refCategorie')     
 
         ->join('tvente_entete_utilisation','tvente_entete_utilisation.id','=','tvente_detail_utilisation.refEnteteVente')        
         ->join('tvente_module','tvente_module.id','=','tvente_entete_utilisation.module_id')
         ->join('tvente_services','tvente_services.id','=','tvente_entete_utilisation.refService')
         ->join('tagent','tagent.id','=','tvente_entete_utilisation.agent_id')

         ->select(DB::raw('ROUND(SUM(((qteVente*puVente) - montantreduction)),4) as sommePHT, 
         ROUND(SUM(montanttva),4) as sommeTVA,
         ROUND(SUM(ROUND(((qteVente*puVente) - montantreduction + montanttva),4)),4) as sommePTTF'))
         ->where([
            ['dateUse','>=', $date1],
            ['dateUse','<=', $date2],
            ['tvente_services.id','=', $idService],
            ['tvente_categorie_produit.id','=', $idCategorie],
        ])    
         ->get(); 
         $output='';
         foreach ($data2 as $row) 
         {                                
            $sommePHT=$row->sommePHT;
            $sommeTVA=$row->sommeTVA;
            $sommePTTF=$row->sommePTTF;                           
         }




         $CategorieClient='';

         $data3=DB::table('tvente_detail_utilisation')
         ->join('tvente_entete_utilisation','tvente_entete_utilisation.id','=','tvente_detail_utilisation.refEnteteVente')        
         ->join('tvente_module','tvente_module.id','=','tvente_entete_utilisation.module_id')
         ->join('tvente_services','tvente_services.id','=','tvente_entete_utilisation.refService')
         ->join('tvente_produit','tvente_produit.id','=','tvente_detail_utilisation.refProduit')
         ->select('nom_service', "tvente_module.nom_module",'tvente_entete_utilisation.code','refService',
         'module_id','dateUse','libelle','type_sortie','tvente_categorie_produit.designation')
         ->where([
            ['dateUse','>=', $date1],
            ['dateUse','<=', $date2],
            ['tvente_services.id','=', $idService],
            ['tvente_categorie_produit.id','=', $idCategorie]
        ])      
        ->get();      
        $output='';
        foreach ($data3 as $row) 
        {
            $CategorieClient=$row->nom_service .' - '. $row->designation;              
        }


          

        $output='

                <!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Transitional//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd">
                <!-- saved from url=(0016)http://localhost -->
                <html>
                <head>
                    <title>rpt_DetailFactureAbonne</title>
                    <meta HTTP-EQUIV="Content-Type" CONTENT="text/html; charset=utf-8"/>
                    <style type="text/css">
                        .csB6F858D0 {color:#000000;background-color:#D6E5F4;border-left-style: none;border-top-style: none;border-right-style: none;border-bottom-style: none;font-family:Times New Roman; font-size:24px; font-weight:bold; font-style:normal; padding-left:2px;padding-right:2px;}
                        .cs49AA1D99 {color:#000000;background-color:#E0E0E0;border-left:#000000 1px solid;border-top:#000000 1px solid;border-right:#000000 1px solid;border-bottom:#000000 1px solid;font-family:Times New Roman; font-size:13px; font-weight:bold; font-style:normal; }
                        .cs8AAF79E9 {color:#000000;background-color:#E0E0E0;border-left-style: none;border-top:#000000 1px solid;border-right:#000000 1px solid;border-bottom:#000000 1px solid;font-family:Times New Roman; font-size:12px; font-weight:bold; font-style:normal; }
                        .cs9FE9304F {color:#000000;background-color:#E0E0E0;border-left-style: none;border-top:#000000 1px solid;border-right:#000000 1px solid;border-bottom:#000000 1px solid;font-family:Times New Roman; font-size:13px; font-weight:bold; font-style:normal; }
                        .csE6D2AE99 {color:#000000;background-color:#E0E0E0;border-left-style: none;border-top:#000000 1px solid;border-right-style: none;border-bottom:#000000 1px solid;font-family:Times New Roman; font-size:12px; font-weight:bold; font-style:normal; }
                        .csEAC52FCD {color:#000000;background-color:#E0E0E0;border-left-style: none;border-top:#000000 1px solid;border-right-style: none;border-bottom:#000000 1px solid;font-family:Times New Roman; font-size:13px; font-weight:bold; font-style:normal; }
                        .cs56F73198 {color:#000000;background-color:transparent;border-left:#000000 1px solid;border-top:#000000 1px solid;border-right:#000000 1px solid;border-bottom:#000000 1px solid;font-family:Times New Roman; font-size:16px; font-weight:normal; font-style:normal; padding-left:2px;}
                        .cs6E02D7D2 {color:#000000;background-color:transparent;border-left-style: none;border-top:#000000 1px solid;border-right:#000000 1px solid;border-bottom:#000000 1px solid;font-family:Times New Roman; font-size:14px; font-weight:normal; font-style:normal; }
                        .cs6C28398D {color:#000000;background-color:transparent;border-left-style: none;border-top:#000000 1px solid;border-right-style: none;border-bottom:#000000 1px solid;font-family:Times New Roman; font-size:14px; font-weight:normal; font-style:normal; }
                        .cs612ED82F {color:#000000;background-color:transparent;border-left-style: none;border-top-style: none;border-right-style: none;border-bottom-style: none;font-family:Times New Roman; font-size:12px; font-weight:bold; font-style:normal; padding-left:2px;}
                        .csFFC1C457 {color:#000000;background-color:transparent;border-left-style: none;border-top-style: none;border-right-style: none;border-bottom-style: none;font-family:Times New Roman; font-size:12px; font-weight:normal; font-style:normal; padding-left:2px;}
                        .cs101A94F7 {color:#000000;background-color:transparent;border-left-style: none;border-top-style: none;border-right-style: none;border-bottom-style: none;font-family:Times New Roman; font-size:13px; font-weight:normal; font-style:normal; }
                        .csCE72709D {color:#000000;background-color:transparent;border-left-style: none;border-top-style: none;border-right-style: none;border-bottom-style: none;font-family:Times New Roman; font-size:14px; font-weight:bold; font-style:normal; padding-left:2px;}
                        .cs12FE94AA {color:#000000;background-color:transparent;border-left-style: none;border-top-style: none;border-right-style: none;border-bottom-style: none;font-family:Times New Roman; font-size:14px; font-weight:normal; font-style:normal; padding-left:2px;}
                        .csFBB219FE {color:#000000;background-color:transparent;border-left-style: none;border-top-style: none;border-right-style: none;border-bottom-style: none;font-family:Times New Roman; font-size:18px; font-weight:bold; font-style:normal; padding-left:2px;}
                        .cs739196BC {color:#5C5C5C;background-color:transparent;border-left-style: none;border-top-style: none;border-right-style: none;border-bottom-style: none;font-family:Segoe UI; font-size:11px; font-weight:normal; font-style:normal; }
                        .csF7D3565D {height:0px;width:0px;overflow:hidden;font-size:0px;line-height:0px;}
                    </style>
                </head>
                <body leftMargin=10 topMargin=10 rightMargin=10 bottomMargin=10 style="background-color:#FFFFFF">
                <table cellpadding="0" cellspacing="0" border="0" style="border-width:0px;empty-cells:show;width:925px;height:383px;position:relative;">
                    <tr>
                        <td style="width:0px;height:0px;"></td>
                        <td style="height:0px;width:10px;"></td>
                        <td style="height:0px;width:102px;"></td>
                        <td style="height:0px;width:36px;"></td>
                        <td style="height:0px;width:71px;"></td>
                        <td style="height:0px;width:124px;"></td>
                        <td style="height:0px;width:66px;"></td>
                        <td style="height:0px;width:23px;"></td>
                        <td style="height:0px;width:149px;"></td>
                        <td style="height:0px;width:43px;"></td>
                        <td style="height:0px;width:60px;"></td>
                        <td style="height:0px;width:10px;"></td>
                        <td style="height:0px;width:30px;"></td>
                        <td style="height:0px;width:41px;"></td>
                        <td style="height:0px;width:12px;"></td>
                        <td style="height:0px;width:47px;"></td>
                        <td style="height:0px;width:75px;"></td>
                        <td style="height:0px;width:25px;"></td>
                        <td style="height:0px;width:1px;"></td>
                    </tr>
                    <tr style="vertical-align:top;">
                        <td style="width:0px;height:23px;"></td>
                        <td class="cs739196BC" colspan="6" style="width:409px;height:23px;line-height:14px;text-align:center;vertical-align:middle;"><nobr></nobr></td>
                        <td></td>
                        <td></td>
                        <td></td>
                        <td></td>
                        <td></td>
                        <td></td>
                        <td></td>
                        <td></td>
                        <td></td>
                        <td></td>
                        <td></td>
                        <td></td>
                    </tr>
                    <tr style="vertical-align:top;">
                        <td style="width:0px;height:9px;"></td>
                        <td></td>
                        <td></td>
                        <td></td>
                        <td></td>
                        <td></td>
                        <td></td>
                        <td></td>
                        <td></td>
                        <td></td>
                        <td></td>
                        <td></td>
                        <td></td>
                        <td></td>
                        <td></td>
                        <td></td>
                        <td></td>
                        <td></td>
                        <td></td>
                    </tr>
                    <tr style="vertical-align:top;">
                        <td style="width:0px;height:1px;"></td>
                        <td></td>
                        <td class="csFBB219FE" colspan="10" rowspan="2" style="width:682px;height:23px;line-height:21px;text-align:left;vertical-align:middle;"><nobr>'.$nomEse.'</nobr></td>
                        <td></td>
                        <td></td>
                        <td></td>
                        <td></td>
                        <td></td>
                        <td></td>
                        <td></td>
                    </tr>
                    <tr style="vertical-align:top;">
                        <td style="width:0px;height:22px;"></td>
                        <td></td>
                        <td></td>
                        <td class="cs101A94F7" colspan="4" rowspan="7" style="width:175px;height:144px;text-align:left;vertical-align:top;"><div style="overflow:hidden;width:175px;height:144px;">
                            <img alt="" src="'.$pic2.'" style="width:175px;height:144px;" /></div>
                        </td>
                        <td></td>
                        <td></td>
                    </tr>
                    <tr style="vertical-align:top;">
                        <td style="width:0px;height:22px;"></td>
                        <td></td>
                        <td class="csCE72709D" colspan="10" style="width:682px;height:22px;line-height:15px;text-align:left;vertical-align:middle;"><nobr>'.$busnessName.'</nobr></td>
                        <td></td>
                        <td></td>
                        <td></td>
                    </tr>
                    <tr style="vertical-align:top;">
                        <td style="width:0px;height:22px;"></td>
                        <td></td>
                        <td class="csCE72709D" colspan="10" style="width:682px;height:22px;line-height:15px;text-align:left;vertical-align:middle;"><nobr>RCCM'.$rccEse.'.&nbsp;ID-NAT.'.$idNatEse.'</nobr></td>
                        <td></td>
                        <td></td>
                        <td></td>
                    </tr>
                    <tr style="vertical-align:top;">
                        <td style="width:0px;height:22px;"></td>
                        <td></td>
                        <td class="csFFC1C457" colspan="10" style="width:682px;height:22px;line-height:13px;text-align:left;vertical-align:middle;"><nobr>'.$adresseEse.'</nobr></td>
                        <td></td>
                        <td></td>
                        <td></td>
                    </tr>
                    <tr style="vertical-align:top;">
                        <td style="width:0px;height:22px;"></td>
                        <td></td>
                        <td class="csFFC1C457" colspan="10" style="width:682px;height:22px;line-height:13px;text-align:left;vertical-align:middle;"><nobr>Email&nbsp;:&nbsp;'.$emailEse.'</nobr></td>
                        <td></td>
                        <td></td>
                        <td></td>
                    </tr>
                    <tr style="vertical-align:top;">
                        <td style="width:0px;height:22px;"></td>
                        <td></td>
                        <td class="csFFC1C457" colspan="10" style="width:682px;height:22px;line-height:13px;text-align:left;vertical-align:middle;"><nobr>Site&nbsp;web&nbsp;:&nbsp;'.$siteEse.'</nobr></td>
                        <td></td>
                        <td></td>
                        <td></td>
                    </tr>
                    <tr style="vertical-align:top;">
                        <td style="width:0px;height:12px;"></td>
                        <td></td>
                        <td class="cs612ED82F" colspan="10" rowspan="2" style="width:682px;height:23px;line-height:13px;text-align:left;vertical-align:middle;"><nobr>T&#233;l&#233;phone&nbsp;:&nbsp;'.$Tel1Ese.'&nbsp;&nbsp;24h/24</nobr></td>
                        <td></td>
                        <td></td>
                        <td></td>
                    </tr>
                    <tr style="vertical-align:top;">
                        <td style="width:0px;height:11px;"></td>
                        <td></td>
                        <td></td>
                        <td></td>
                        <td></td>
                        <td></td>
                        <td></td>
                        <td></td>
                        <td></td>
                    </tr>
                    <tr style="vertical-align:top;">
                        <td style="width:0px;height:8px;"></td>
                        <td></td>
                        <td></td>
                        <td></td>
                        <td></td>
                        <td></td>
                        <td></td>
                        <td></td>
                        <td></td>
                        <td></td>
                        <td></td>
                        <td></td>
                        <td></td>
                        <td></td>
                        <td></td>
                        <td></td>
                        <td></td>
                        <td></td>
                        <td></td>
                    </tr>
                    <tr style="vertical-align:top;">
                        <td style="width:0px;height:32px;"></td>
                        <td></td>
                        <td></td>
                        <td></td>
                        <td class="csB6F858D0" colspan="11" style="width:625px;height:32px;line-height:28px;text-align:center;vertical-align:middle;"><nobr>RAPPORT&nbsp;JOURNALIER&nbsp;DES&nbsp;VENTES</nobr></td>
                        <td></td>
                        <td></td>
                        <td></td>
                        <td></td>
                    </tr>
                    <tr style="vertical-align:top;">
                        <td style="width:0px;height:19px;"></td>
                        <td></td>
                        <td></td>
                        <td></td>
                        <td></td>
                        <td></td>
                        <td></td>
                        <td></td>
                        <td></td>
                        <td></td>
                        <td></td>
                        <td></td>
                        <td></td>
                        <td></td>
                        <td></td>
                        <td></td>
                        <td></td>
                        <td></td>
                        <td></td>
                    </tr>
                    <tr style="vertical-align:top;">
                        <td style="width:0px;height:23px;"></td>
                        <td></td>
                        <td class="cs56F73198" colspan="4" style="width:329px;height:21px;line-height:18px;text-align:left;vertical-align:top;"><nobr>&nbsp;PERIODE&nbsp;:&nbsp;&nbsp;Du&nbsp;&nbsp;'.$date1.'&nbsp;&nbsp;au&nbsp;'.$date2.'</nobr></td>
                        <td class="cs56F73198" colspan="12" style="width:577px;height:21px;line-height:18px;text-align:left;vertical-align:top;"><nobr>'.$CategorieClient.'</nobr></td>
                        <td></td>
                    </tr>
                    <tr style="vertical-align:top;">
                        <td style="width:0px;height:9px;"></td>
                        <td></td>
                        <td></td>
                        <td></td>
                        <td></td>
                        <td></td>
                        <td></td>
                        <td></td>
                        <td></td>
                        <td></td>
                        <td></td>
                        <td></td>
                        <td></td>
                        <td></td>
                        <td></td>
                        <td></td>
                        <td></td>
                        <td></td>
                        <td></td>
                    </tr>
                    <tr style="vertical-align:top;">
                        <td style="width:0px;height:24px;"></td>
                        <td></td>
                        <td class="cs8AAF79E9" style="width:101px;height:22px;line-height:14px;text-align:center;vertical-align:middle;"><nobr>N&#176;&nbsp;FACTURE</nobr></td>
                        <td class="cs8AAF79E9" colspan="3" style="width:230px;height:22px;line-height:14px;text-align:center;vertical-align:middle;"><nobr>CLIENT</nobr></td>
                        <td class="cs8AAF79E9" colspan="2" style="width:88px;height:22px;line-height:14px;text-align:center;vertical-align:middle;"><nobr>DATE&nbsp;FACT.</nobr></td>
                        <td class="cs8AAF79E9" style="width:148px;height:22px;line-height:14px;text-align:center;vertical-align:middle;"><nobr>ARTICLE</nobr></td>
                        <td class="cs8AAF79E9" style="width:42px;height:22px;line-height:14px;text-align:center;vertical-align:middle;"><nobr>Qt&#233;</nobr></td>
                        <td class="cs8AAF79E9" style="width:59px;height:22px;line-height:14px;text-align:center;vertical-align:middle;"><nobr>PU(USD)</nobr></td>
                        <td class="cs8AAF79E9" colspan="3" style="width:80px;height:22px;line-height:14px;text-align:center;vertical-align:middle;"><nobr>PHT(USD)</nobr></td>
                        <td class="cs8AAF79E9" colspan="2" style="width:58px;height:22px;line-height:14px;text-align:center;vertical-align:middle;"><nobr>%&nbsp;TVA</nobr></td>
                        <td class="csE6D2AE99" colspan="3" style="width:101px;height:22px;line-height:14px;text-align:center;vertical-align:middle;"><nobr>PTTTC($)</nobr></td>
                    </tr>
                    ';

                            $output .= $this->showDetailUsage_Service_Categorie($date1,$date2,$idService,$idCategorie); 

                            $output.='
                    <tr style="vertical-align:top;">
                        <td style="width:0px;height:24px;"></td>
                        <td></td>
                        <td></td>
                        <td></td>
                        <td></td>
                        <td></td>
                        <td></td>
                        <td></td>
                        <td></td>
                        <td class="cs49AA1D99" colspan="2" style="width:101px;height:22px;line-height:15px;text-align:center;vertical-align:middle;"><nobr>TOTAL&nbsp;($)&nbsp;:</nobr></td>
                        <td class="cs9FE9304F" colspan="3" style="width:80px;height:22px;line-height:15px;text-align:center;vertical-align:middle;"><nobr>'.$sommePHT.'</nobr></td>
                        <td class="cs9FE9304F" colspan="2" style="width:58px;height:22px;line-height:15px;text-align:center;vertical-align:middle;"><nobr>'.$sommeTVA.'</nobr></td>
                        <td class="csEAC52FCD" colspan="3" style="width:101px;height:22px;line-height:15px;text-align:center;vertical-align:middle;"><nobr>'.$sommePTTF.'</nobr></td>
                    </tr>
                    <tr style="vertical-align:top;">
                        <td style="width:0px;height:10px;"></td>
                        <td></td>
                        <td></td>
                        <td></td>
                        <td></td>
                        <td></td>
                        <td></td>
                        <td></td>
                        <td></td>
                        <td></td>
                        <td></td>
                        <td></td>
                        <td></td>
                        <td></td>
                        <td></td>
                        <td></td>
                        <td></td>
                        <td></td>
                        <td></td>
                    </tr>
                    <tr style="vertical-align:top;">
                        <td style="width:0px;height:22px;"></td>
                        <td></td>
                        <td class="cs12FE94AA" colspan="3" style="width:207px;height:22px;line-height:16px;text-align:left;vertical-align:top;"><nobr>Fait&nbsp;&#224;&nbsp;Goma&nbsp;le&nbsp;&nbsp;'.date('Y-m-d').'</nobr></td>
                        <td></td>
                        <td></td>
                        <td></td>
                        <td></td>
                        <td></td>
                        <td></td>
                        <td></td>
                        <td></td>
                        <td></td>
                        <td></td>
                        <td></td>
                        <td></td>
                        <td></td>
                        <td></td>
                    </tr>
                </table>
                </body>
                </html>
        
        ';  
       
        return $output; 

}
function showDetailUsage_Service_Categorie($date1,$date2,$idService,$idCategorie)
{
        $data = DB::table('tvente_detail_utilisation')
        ->join('tvente_produit','tvente_produit.id','=','tvente_detail_utilisation.refProduit')
        ->join('tvente_categorie_produit','tvente_categorie_produit.id','=','tvente_produit.refCategorie')        

        ->join('tvente_entete_utilisation','tvente_entete_utilisation.id','=','tvente_detail_utilisation.refEnteteVente')        
        ->join('tvente_module','tvente_module.id','=','tvente_entete_utilisation.module_id')
        ->join('tvente_services','tvente_services.id','=','tvente_entete_utilisation.refService')
        ->join('tagent','tagent.id','=','tvente_entete_utilisation.agent_id')

        ->select('tvente_detail_utilisation.id','refEnteteVente','refProduit','tvente_detail_utilisation.compte_vente',
        'tvente_detail_utilisation.compte_variationstock','tvente_detail_utilisation.compte_perte',
        'tvente_detail_utilisation.compte_produit','tvente_detail_utilisation.compte_destockage','puVente',
        'qteVente','uniteVente','puBase','qteBase','tvente_detail_utilisation.uniteBase','cmupVente',
        'tvente_detail_utilisation.devise','tvente_detail_utilisation.taux','montantreduction',
        'tvente_detail_utilisation.active','tvente_detail_utilisation.author','tvente_detail_utilisation.refUser',
        'tvente_detail_utilisation.created_at','idStockService',

        'tvente_produit.designation','tvente_produit.refCategorie','tvente_produit.refUniteBase',
        'tvente_produit.pu','tvente_produit.qte','tvente_produit.cmup','tvente_produit.taux',
        'tvente_produit.Oldcode','tvente_produit.Newcode','tvente_produit.tvaapplique',
        'tvente_produit.estvendable','montanttva',         
        'matricule_agent','noms_agent','sexe_agent','datenaissance_agent',
        'lieunaissnce_agent','provinceOrigine_agent','etatcivil_agent','refAvenue_agent','nummaison_agent',
        'contact_agent','mail_agent','grade_agent','fonction_agent','specialite_agent',
        'Categorie_agent','niveauEtude_agent','anneeFinEtude_agent','Ecole_agent','conjoint_agent', 
        'nomPere_agent', 'nomMere_agent', 'Nationalite_agent', 'Collectivite_agent', 
        'Territoire_agent', 'EmployeurAnt_agent', 'PersRef_agent','photo','slug','cartes','envie',

        'nom_service', "tvente_module.nom_module",'tvente_entete_utilisation.code','refService',
        'module_id','dateUse','libelle', 
        'type_sortie')
        ->selectRaw('ROUND(((qteVente*puVente) - montantreduction),2) as PTVente')
       ->selectRaw('ROUND(((qteVente*puVente) - montantreduction + montanttva),2) as PTVenteTVA')
       ->selectRaw('ROUND((IFNULL(qteVente*puVente,0)),2) as totalFacture')
       ->selectRaw('ROUND((montanttva),2) as TotalTVA')
        ->selectRaw('CONCAT("S",YEAR(dateUse),"",MONTH(dateUse),"00",refEnteteVente) as codeFacture')
        ->where([
            ['dateUse','>=', $date1],
            ['dateUse','<=', $date2],
            ['tvente_services.id','=', $idService],
            ['tvente_categorie_produit.id','=', $idCategorie]
        ])
        ->orderBy("tvente_detail_utilisation.created_at", "asc")
        ->get();
        $output='';

        foreach ($data as $row) 
        {
            $output .='
            <tr style="vertical-align:top;">
                <td style="width:0px;height:24px;"></td>
                <td></td>
                <td class="cs6E02D7D2" style="width:101px;height:22px;line-height:15px;text-align:center;vertical-align:middle;">'.$row->codeFacture.'</td>
                <td class="cs6E02D7D2" colspan="3" style="width:230px;height:22px;line-height:15px;text-align:left;vertical-align:middle;">'.$row->nom_service.' : '.$row->noms_agent.'</td>
                <td class="cs6E02D7D2" colspan="2" style="width:88px;height:22px;line-height:15px;text-align:center;vertical-align:middle;">'.$row->dateUse.'</td>
                <td class="cs6E02D7D2" style="width:148px;height:22px;line-height:15px;text-align:left;vertical-align:middle;">'.$row->designation.'</td>
                <td class="cs6E02D7D2" style="width:42px;height:22px;line-height:15px;text-align:center;vertical-align:middle;">'.$row->qteVente.' ('.$row->uniteVente.')</td>
                <td class="cs6E02D7D2" style="width:59px;height:22px;line-height:15px;text-align:center;vertical-align:middle;">'.$row->qteVente.'</td>
                <td class="cs6E02D7D2" colspan="3" style="width:80px;height:22px;line-height:15px;text-align:center;vertical-align:middle;">'.$row->PTVente.'</td>
                <td class="cs6E02D7D2" colspan="2" style="width:58px;height:22px;line-height:15px;text-align:center;vertical-align:middle;">'.$row->montanttva.'</td>
                <td class="cs6C28398D" colspan="3" style="width:101px;height:22px;line-height:15px;text-align:center;vertical-align:middle;">'.$row->PTVenteTVA.'</td>
            </tr>
        '; 
           
   
    }

    return $output;

}


//===================== RAPPORT DE PAIEMENT  DES VENTES  =======================================================
//===============================================================================================================

public function fetch_rapport_paiementfacture_date(Request $request)
{
    
    if ($request->get('date1') && $request->get('date2')) {
        // code...
        $date1 = $request->get('date1');
        $date2 = $request->get('date2');

        $html ='<html><head><meta http-equiv="Content-Type" content="text/html; charset=utf-8"/>';
        $html .= $this->printRapportPaieFacture($date1, $date2);       
        $html .='<script>window.print()</script>';
        echo($html);
    } else {
        // code...
    }
    
    
}
function printRapportPaieFacture($date1, $date2)
{

         //Info Entreprise
        $nomEse='';
        $adresseEse='';
        $Tel1Ese='';
        $Tel2Ese='';
        $siteEse='';
        $emailEse='';
        $idNatEse='';
        $numImpotEse='';
        $rccEse='';
        $siege='';
        $busnessName='';
        $pic='';
        $pic2 = $this->displayImg("fichier", 'logo.png');
        $logo='';

        $data1 = DB::table('entreprises')
        ->join('secteurs','secteurs.id','=','entreprises.idsecteur')
        ->join('forme_juridiques','forme_juridiques.id','=','entreprises.idforme')

        ->join('pays','pays.id','=','entreprises.idPays')
        ->join('provinces','provinces.id','=','entreprises.idProvince')
        ->join('users','users.id','=','entreprises.ceo')        
        ->select('entreprises.id as id','entreprises.id as idEntreprise',
        'entreprises.ceo','entreprises.nomEntreprise','entreprises.descriptionEntreprise',
        'entreprises.emailEntreprise','entreprises.adresseEntreprise',
        'entreprises.telephoneEntreprise','entreprises.solutionEntreprise','entreprises.idsecteur',
        'entreprises.idforme','entreprises.etat',
        'entreprises.idPays','entreprises.idProvince','entreprises.edition','entreprises.facebook',
        'entreprises.linkedin','entreprises.twitter','entreprises.siteweb','entreprises.rccm',
        'entreprises.invPersonnel','entreprises.invHub','entreprises.invRecherche',
        'entreprises.chiffreAffaire','entreprises.nbremploye','entreprises.slug','entreprises.logo',
            //forme
            'forme_juridiques.nomForme','secteurs.nomSecteur',
            //users
            'users.name','users.email','users.avatar','users.telephone','users.adresse',
            //
            'provinces.nomProvince','pays.nomPays', 'entreprises.created_at')
        ->get();
         $output='';
         foreach ($data1 as $row) 
         {                                
             $nomEse=$row->nomEntreprise;
             $adresseEse=$row->adresseEntreprise;
             $Tel1Ese=$row->telephoneEntreprise;
             $Tel2Ese=$row->telephone;
             $siteEse=$row->siteweb;
             $emailEse=$row->emailEntreprise;
             $idNatEse=$row->rccm;
             $numImpotEse=$row->rccm;
             $busnessName=$row->nomSecteur;
             $rccmEse=$row->rccm;
             $pic = $this->displayImg("fichier", 'logo.png');
             $siege=$row->nomForme;         
         }

         $totalPaie=0;
                 
         //
         $data2 = DB::table('tvente_paiement')         
         ->select(DB::raw('ROUND(SUM(montant_paie),2) as TotalPaie'))
         ->where([
            ['tvente_paiement.date_paie','>=', $date1],
            ['tvente_paiement.date_paie','<=', $date2]
        ])    
         ->get(); 
         $output='';
         foreach ($data2 as $row) 
         {                                
            $totalPaie=$row->TotalPaie;
                           
         }

           

        $output='
        <!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Transitional//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd">
        <!-- saved from url=(0016)http://localhost -->
        <html>
        <head>
            <title>rpt_RapportPaiement</title>
            <meta HTTP-EQUIV="Content-Type" CONTENT="text/html; charset=utf-8"/>
            <style type="text/css">
                .csB6F858D0 {color:#000000;background-color:#D6E5F4;border-left-style: none;border-top-style: none;border-right-style: none;border-bottom-style: none;font-family:Times New Roman; font-size:24px; font-weight:bold; font-style:normal; padding-left:2px;padding-right:2px;}
                .cs49AA1D99 {color:#000000;background-color:#E0E0E0;border-left:#000000 1px solid;border-top:#000000 1px solid;border-right:#000000 1px solid;border-bottom:#000000 1px solid;font-family:Times New Roman; font-size:13px; font-weight:bold; font-style:normal; }
                .cs3DB3E5A1 {color:#000000;background-color:#E0E0E0;border-left-style: none;border-top:#000000 1px solid;border-right:#000000 1px solid;border-bottom:#000000 1px solid;font-family:Times New Roman; font-size:11px; font-weight:bold; font-style:normal; }
                .cs691A15EF {color:#000000;background-color:#E0E0E0;border-left-style: none;border-top:#000000 1px solid;border-right-style: none;border-bottom:#000000 1px solid;font-family:Times New Roman; font-size:11px; font-weight:bold; font-style:normal; }
                .csEAC52FCD {color:#000000;background-color:#E0E0E0;border-left-style: none;border-top:#000000 1px solid;border-right-style: none;border-bottom:#000000 1px solid;font-family:Times New Roman; font-size:13px; font-weight:bold; font-style:normal; }
                .cs56F73198 {color:#000000;background-color:transparent;border-left:#000000 1px solid;border-top:#000000 1px solid;border-right:#000000 1px solid;border-bottom:#000000 1px solid;font-family:Times New Roman; font-size:16px; font-weight:normal; font-style:normal; padding-left:2px;}
                .cs3B0DD49A {color:#000000;background-color:transparent;border-left-style: none;border-top:#000000 1px solid;border-right:#000000 1px solid;border-bottom:#000000 1px solid;font-family:Times New Roman; font-size:11px; font-weight:normal; font-style:normal; }
                .cs803D2C52 {color:#000000;background-color:transparent;border-left-style: none;border-top:#000000 1px solid;border-right-style: none;border-bottom:#000000 1px solid;font-family:Times New Roman; font-size:11px; font-weight:normal; font-style:normal; }
                .cs612ED82F {color:#000000;background-color:transparent;border-left-style: none;border-top-style: none;border-right-style: none;border-bottom-style: none;font-family:Times New Roman; font-size:12px; font-weight:bold; font-style:normal; padding-left:2px;}
                .csFFC1C457 {color:#000000;background-color:transparent;border-left-style: none;border-top-style: none;border-right-style: none;border-bottom-style: none;font-family:Times New Roman; font-size:12px; font-weight:normal; font-style:normal; padding-left:2px;}
                .cs101A94F7 {color:#000000;background-color:transparent;border-left-style: none;border-top-style: none;border-right-style: none;border-bottom-style: none;font-family:Times New Roman; font-size:13px; font-weight:normal; font-style:normal; }
                .csCE72709D {color:#000000;background-color:transparent;border-left-style: none;border-top-style: none;border-right-style: none;border-bottom-style: none;font-family:Times New Roman; font-size:14px; font-weight:bold; font-style:normal; padding-left:2px;}
                .cs12FE94AA {color:#000000;background-color:transparent;border-left-style: none;border-top-style: none;border-right-style: none;border-bottom-style: none;font-family:Times New Roman; font-size:14px; font-weight:normal; font-style:normal; padding-left:2px;}
                .csFBB219FE {color:#000000;background-color:transparent;border-left-style: none;border-top-style: none;border-right-style: none;border-bottom-style: none;font-family:Times New Roman; font-size:18px; font-weight:bold; font-style:normal; padding-left:2px;}
                .cs739196BC {color:#5C5C5C;background-color:transparent;border-left-style: none;border-top-style: none;border-right-style: none;border-bottom-style: none;font-family:Segoe UI; font-size:11px; font-weight:normal; font-style:normal; }
                .csF7D3565D {height:0px;width:0px;overflow:hidden;font-size:0px;line-height:0px;}
            </style>
        </head>
        <body leftMargin=10 topMargin=10 rightMargin=10 bottomMargin=10 style="background-color:#FFFFFF">
        <table cellpadding="0" cellspacing="0" border="0" style="border-width:0px;empty-cells:show;width:946px;height:383px;position:relative;">
            <tr>
                <td style="width:0px;height:0px;"></td>
                <td style="height:0px;width:10px;"></td>
                <td style="height:0px;width:88px;"></td>
                <td style="height:0px;width:50px;"></td>
                <td style="height:0px;width:71px;"></td>
                <td style="height:0px;width:101px;"></td>
                <td style="height:0px;width:23px;"></td>
                <td style="height:0px;width:66px;"></td>
                <td style="height:0px;width:110px;"></td>
                <td style="height:0px;width:127px;"></td>
                <td style="height:0px;width:89px;"></td>
                <td style="height:0px;width:33px;"></td>
                <td style="height:0px;width:9px;"></td>
                <td style="height:0px;width:55px;"></td>
                <td style="height:0px;width:53px;"></td>
                <td style="height:0px;width:59px;"></td>
                <td style="height:0px;width:2px;"></td>
            </tr>
            <tr style="vertical-align:top;">
                <td style="width:0px;height:23px;"></td>
                <td></td>
                <td></td>
                <td></td>
                <td></td>
                <td></td>
                <td></td>
                <td></td>
                <td></td>
                <td></td>
                <td></td>
            </tr>
            <tr style="vertical-align:top;">
                <td style="width:0px;height:9px;"></td>
                <td></td>
                <td></td>
                <td></td>
                <td></td>
                <td></td>
                <td></td>
                <td></td>
                <td></td>
                <td></td>
                <td></td>
                <td></td>
                <td></td>
                <td></td>
                <td></td>
                <td></td>
                <td></td>
            </tr>
            <tr style="vertical-align:top;">
                <td style="width:0px;height:23px;"></td>
                <td></td>
                <td class="csFBB219FE" colspan="9" style="width:723px;height:23px;line-height:21px;text-align:left;vertical-align:middle;"><nobr>'.$nomEse.'</nobr></td>
                <td></td>
                <td class="cs101A94F7" colspan="4" rowspan="7" style="width:176px;height:144px;text-align:left;vertical-align:top;"><div style="overflow:hidden;width:176px;height:144px;">
                    <img alt="" src="'.$pic2.'" style="width:176px;height:144px;" /></div>
                </td>
                <td></td>
            </tr>
            <tr style="vertical-align:top;">
                <td style="width:0px;height:22px;"></td>
                <td></td>
                <td class="csCE72709D" colspan="9" style="width:723px;height:22px;line-height:15px;text-align:left;vertical-align:middle;">'.$busnessName.'</td>
                <td></td>
                <td></td>
            </tr>
            <tr style="vertical-align:top;">
                <td style="width:0px;height:22px;"></td>
                <td></td>
                <td class="csCE72709D" colspan="9" style="width:723px;height:22px;line-height:15px;text-align:left;vertical-align:middle;"><nobr>RCCM'.$rccEse.'.&nbsp;ID-NAT.'.$idNatEse.'</nobr></td>
                <td></td>
                <td></td>
            </tr>
            <tr style="vertical-align:top;">
                <td style="width:0px;height:22px;"></td>
                <td></td>
                <td class="csFFC1C457" colspan="9" style="width:723px;height:22px;line-height:13px;text-align:left;vertical-align:middle;">'.$adresseEse.'</td>
                <td></td>
                <td></td>
            </tr>
            <tr style="vertical-align:top;">
                <td style="width:0px;height:22px;"></td>
                <td></td>
                <td class="csFFC1C457" colspan="9" style="width:723px;height:22px;line-height:13px;text-align:left;vertical-align:middle;"><nobr>Email&nbsp;:&nbsp;'.$emailEse.'</nobr></td>
                <td></td>
                <td></td>
            </tr>
            <tr style="vertical-align:top;">
                <td style="width:0px;height:22px;"></td>
                <td></td>
                <td class="csFFC1C457" colspan="9" style="width:723px;height:22px;line-height:13px;text-align:left;vertical-align:middle;"><nobr>Site&nbsp;web&nbsp;:&nbsp;'.$siteEse.'</nobr></td>
                <td></td>
                <td></td>
            </tr>
            <tr style="vertical-align:top;">
                <td style="width:0px;height:11px;"></td>
                <td></td>
                <td class="cs612ED82F" colspan="9" rowspan="2" style="width:723px;height:23px;line-height:13px;text-align:left;vertical-align:middle;"><nobr>T&#233;l&#233;phone&nbsp;:&nbsp;'.$Tel1Ese.'&nbsp;&nbsp;24h/24</nobr></td>
                <td></td>
                <td></td>
            </tr>
            <tr style="vertical-align:top;">
                <td style="width:0px;height:12px;"></td>
                <td></td>
                <td></td>
                <td></td>
                <td></td>
                <td></td>
                <td></td>
                <td></td>
            </tr>
            <tr style="vertical-align:top;">
                <td style="width:0px;height:8px;"></td>
                <td></td>
                <td></td>
                <td></td>
                <td></td>
                <td></td>
                <td></td>
                <td></td>
                <td></td>
                <td></td>
                <td></td>
                <td></td>
                <td></td>
                <td></td>
                <td></td>
                <td></td>
                <td></td>
            </tr>
            <tr style="vertical-align:top;">
                <td style="width:0px;height:32px;"></td>
                <td></td>
                <td></td>
                <td></td>
                <td class="csB6F858D0" colspan="9" style="width:625px;height:32px;line-height:28px;text-align:center;vertical-align:middle;"><nobr>RAPPORT&nbsp;JOURNALIER&nbsp;DES&nbsp;PAIEMENTS</nobr></td>
                <td></td>
                <td></td>
                <td></td>
                <td></td>
            </tr>
            <tr style="vertical-align:top;">
                <td style="width:0px;height:19px;"></td>
                <td></td>
                <td></td>
                <td></td>
                <td></td>
                <td></td>
                <td></td>
                <td></td>
                <td></td>
                <td></td>
                <td></td>
                <td></td>
                <td></td>
                <td></td>
                <td></td>
                <td></td>
                <td></td>
            </tr>
            <tr style="vertical-align:top;">
                <td style="width:0px;height:23px;"></td>
                <td></td>
                <td class="cs56F73198" colspan="5" style="width:329px;height:21px;line-height:18px;text-align:left;vertical-align:top;"><nobr>&nbsp;PERIODE&nbsp;:&nbsp;&nbsp;Du&nbsp;&nbsp;'.$date1.'&nbsp;&nbsp;au&nbsp;'.$date2.'</nobr></td>
                <td class="cs56F73198" colspan="9" style="width:597px;height:21px;line-height:18px;text-align:left;vertical-align:top;"><nobr>DEPARTEMENT</nobr></td>
                <td></td>
            </tr>
            <tr style="vertical-align:top;">
                <td style="width:0px;height:9px;"></td>
                <td></td>
                <td></td>
                <td></td>
                <td></td>
                <td></td>
                <td></td>
                <td></td>
                <td></td>
                <td></td>
                <td></td>
                <td></td>
                <td></td>
                <td></td>
                <td></td>
                <td></td>
                <td></td>
            </tr>
            <tr style="vertical-align:top;">
                <td style="width:0px;height:24px;"></td>
                <td></td>
                <td class="cs3DB3E5A1" style="width:87px;height:22px;line-height:12px;text-align:center;vertical-align:middle;"><nobr>DATE</nobr></td>
                <td class="cs3DB3E5A1" colspan="2" style="width:120px;height:22px;line-height:12px;text-align:center;vertical-align:middle;"><nobr>AGENT</nobr></td>
                <td class="cs3DB3E5A1" style="width:100px;height:22px;line-height:12px;text-align:center;vertical-align:middle;"><nobr>N&#176;&nbsp;PAIEMENT</nobr></td>
                <td class="cs3DB3E5A1" colspan="3" style="width:198px;height:22px;line-height:12px;text-align:center;vertical-align:middle;"><nobr>CLIENT</nobr></td>
                <td class="cs3DB3E5A1" style="width:126px;height:22px;line-height:12px;text-align:center;vertical-align:middle;"><nobr>LIBELLE</nobr></td>
                <td class="cs3DB3E5A1" style="width:88px;height:22px;line-height:12px;text-align:center;vertical-align:middle;"><nobr>N&#176;&nbsp;FACTURE</nobr></td>
                <td class="cs3DB3E5A1" colspan="3" style="width:96px;height:22px;line-height:12px;text-align:center;vertical-align:middle;"><nobr>MONTANT($)</nobr></td>
                <td class="cs3DB3E5A1" style="width:52px;height:22px;line-height:12px;text-align:center;vertical-align:middle;"><nobr>TAUX</nobr></td>
                <td class="cs691A15EF" colspan="2" style="width:61px;height:22px;line-height:12px;text-align:center;vertical-align:middle;"><nobr>COMPTE</nobr></td>
            </tr>
            ';
        
                    $output .= $this->showPaieFacturation($date1,$date2); 
        
                    $output.='
            <tr style="vertical-align:top;">
                <td style="width:0px;height:24px;"></td>
                <td></td>
                <td></td>
                <td></td>
                <td></td>
                <td></td>
                <td></td>
                <td></td>
                <td></td>
                <td class="cs49AA1D99" colspan="2" style="width:214px;height:22px;line-height:15px;text-align:center;vertical-align:middle;"><nobr>TOTAL&nbsp;($)&nbsp;:</nobr></td>
                <td class="csEAC52FCD" colspan="5" style="width:209px;height:22px;line-height:15px;text-align:center;vertical-align:middle;"><nobr>'.$totalPaie.' $</nobr></td>
                <td></td>
            </tr>
            <tr style="vertical-align:top;">
                <td style="width:0px;height:10px;"></td>
                <td></td>
                <td></td>
                <td></td>
                <td></td>
                <td></td>
                <td></td>
                <td></td>
                <td></td>
                <td></td>
                <td></td>
                <td></td>
                <td></td>
                <td></td>
                <td></td>
                <td></td>
                <td></td>
            </tr>
            <tr style="vertical-align:top;">
                <td style="width:0px;height:22px;"></td>
                <td></td>
                <td class="cs12FE94AA" colspan="3" style="width:207px;height:22px;line-height:16px;text-align:left;vertical-align:top;"><nobr>Fait&nbsp;&#224;&nbsp;Goma&nbsp;le&nbsp;&nbsp;'.date('Y-m-d').'</nobr></td>
                <td></td>
                <td></td>
                <td></td>
                <td></td>
                <td></td>
                <td></td>
                <td></td>
                <td></td>
                <td></td>
                <td></td>
                <td></td>
                <td></td>
            </tr>
        </table>
        </body>
        </html>
        ';  
       
        return $output; 

}
function showPaieFacturation($date1, $date2)
{
    $data = DB::table('tvente_paiement')
    ->join('tvente_entete_paievente','tvente_entete_paievente.id','=','tvente_paiement.refEntetepaie')
    ->join('tvente_entete_vente','tvente_entete_vente.id','=','tvente_paiement.refEnteteVente')
    // ->join('tvente_module','tvente_module.id','=','tvente_entete_vente.module_id')
    ->join('tvente_services','tvente_services.id','=','tvente_entete_vente.refService')
    ->join('tvente_client','tvente_client.id','=','tvente_entete_vente.refClient')
    ->join('tvente_categorie_client','tvente_categorie_client.id','=','tvente_client.refCategieClient')  
    ->join('tfin_ssouscompte as compteclient','compteclient.id','=','tvente_categorie_client.compte_client')

    ->join('tconf_banque' , 'tconf_banque.id','=','tvente_paiement.refBanque')
    ->join('tfin_ssouscompte as comptebanque','comptebanque.id','=','tconf_banque.refSscompte')

    ->select('tvente_paiement.id','refEntetepaie','refEnteteVente','refBanque','montant_paie',
    'tvente_paiement.devise','tvente_paiement.taux','date_paie','modepaie','libellepaie','numeroBordereau',
    'tvente_paiement.author','tvente_paiement.refUser','tvente_paiement.active','tvente_paiement.created_at'
    
    ,'date_entete_paie','date_paie_current'

    ,'nom_service','refClient','tvente_entete_vente.refService','tvente_entete_vente.refReservation',
    'tvente_entete_vente.module_id','dateVente','libelle','tvente_entete_vente.montant',
    'tvente_entete_vente.paie'

    ,'noms','sexe','contact','mail','adresse','pieceidentite','numeroPiece','dateLivrePiece',
    'lieulivraisonCarte','nationnalite','datenaissance','lieunaissance','profession','occupation',
    'nombreEnfant','dateArriverGoma','arriverPar','refCategieClient','photo','slug', 
    "tvente_categorie_client.designation", "compte_client",
    'compteclient.nom_ssouscompte as nom_ssouscompteClient',
    'compteclient.numero_ssouscompte as numero_ssouscompteClient'

    ,"tconf_banque.nom_banque","tconf_banque.numerocompte",'tconf_banque.nom_mode',
    "tconf_banque.refSscompte as refSscompteBanque",'compteBanque.nom_ssouscompte as nom_ssouscompteBanque',
    'compteBanque.numero_ssouscompte as numero_ssouscompteBanque')
    ->selectRaw('((montant_paie)/tvente_paiement.taux) as montant_paieFC')
    ->selectRaw('CONCAT("R",YEAR(date_paie),"",MONTH(date_paie),"00",tvente_paiement.id) as codeRecu')
    ->selectRaw('ROUND((IFNULL(paie,0)),1) as totalPaie')
    ->selectRaw('CONCAT("F",YEAR(dateVente),"",MONTH(dateVente),"00",tvente_entete_vente.id) as codeFacture')
    ->selectRaw("DATE_FORMAT(tvente_paiement.date_paie,'%d/%M/%Y') as date_paie")
    ->where([
        ['tvente_paiement.date_paie','>=', $date1],
        ['tvente_paiement.date_paie','<=', $date2]
    ])
    ->orderBy("tvente_paiement.created_at", "asc")
    ->get();

    $output='';

    foreach ($data as $row) 
    {
        $output .='
        <tr style="vertical-align:top;">
		<td style="width:0px;height:24px;"></td>
		<td></td>
		<td class="cs3B0DD49A" style="width:87px;height:22px;line-height:12px;text-align:center;vertical-align:middle;">'.$row->date_paie.'</td>
		<td class="cs3B0DD49A" colspan="2" style="width:120px;height:22px;line-height:12px;text-align:left;vertical-align:middle;">'.$row->author.'</td>
		<td class="cs3B0DD49A" style="width:100px;height:22px;line-height:12px;text-align:center;vertical-align:middle;">'.$row->codeRecu.'</td>
		<td class="cs3B0DD49A" colspan="3" style="width:198px;height:22px;line-height:12px;text-align:left;vertical-align:middle;">'.$row->noms.'</td>
		<td class="cs3B0DD49A" style="width:126px;height:22px;line-height:12px;text-align:center;vertical-align:middle;">'.$row->codeFacture.'&nbsp;:&nbsp;'.$row->noms.'</td>
		<td class="cs3B0DD49A" style="width:88px;height:22px;line-height:12px;text-align:center;vertical-align:middle;">'.$row->codeFacture.'</td>
		<td class="cs3B0DD49A" colspan="3" style="width:96px;height:22px;line-height:12px;text-align:center;vertical-align:middle;">'.$row->montant_paie.'$</td>
		<td class="cs3B0DD49A" style="width:52px;height:22px;line-height:12px;text-align:center;vertical-align:middle;">'.$row->taux.'</td>
		<td class="cs803D2C52" style="width:59px;height:22px;line-height:12px;text-align:center;vertical-align:middle;">'.$row->numero_ssouscompteBanque.'</td>
		<td></td>
	</tr>
        ';        
   
    }

    return $output;

}


public function fetch_rapport_paiementfacture_date_banque(Request $request)
{
    if ($request->get('date1') && $request->get('date2')&& $request->get('refBanque')) {
        // code...
        $date1 = $request->get('date1');
        $date2 = $request->get('date2');
        $refBanque = $request->get('refBanque');
        
        $html ='<html><head><meta http-equiv="Content-Type" content="text/html; charset=utf-8"/>';
        $html .= $this->printRapportPaiementFacture_Banque($date1, $date2,$refBanque);       
        $html .='<script>window.print()</script>';
        echo($html);
    } else {
        // code...
    }  
    
}
function printRapportPaiementFacture_Banque($date1, $date2,$refBanque)
{

        $nomEse='';
        $adresseEse='';
        $Tel1Ese='';
        $Tel2Ese='';
        $siteEse='';
        $emailEse='';
        $idNatEse='';
        $numImpotEse='';
        $rccEse='';
        $siege='';
        $busnessName='';
        $pic='';
        $pic2 = $this->displayImg("fichier", 'logo.png');
        $logo='';

        $data1 = DB::table('entreprises')
        ->join('secteurs','secteurs.id','=','entreprises.idsecteur')
        ->join('forme_juridiques','forme_juridiques.id','=','entreprises.idforme')

        ->join('pays','pays.id','=','entreprises.idPays')
        ->join('provinces','provinces.id','=','entreprises.idProvince')
        ->join('users','users.id','=','entreprises.ceo')        
        ->select('entreprises.id as id','entreprises.id as idEntreprise',
        'entreprises.ceo','entreprises.nomEntreprise','entreprises.descriptionEntreprise',
        'entreprises.emailEntreprise','entreprises.adresseEntreprise',
        'entreprises.telephoneEntreprise','entreprises.solutionEntreprise','entreprises.idsecteur',
        'entreprises.idforme','entreprises.etat',
        'entreprises.idPays','entreprises.idProvince','entreprises.edition','entreprises.facebook',
        'entreprises.linkedin','entreprises.twitter','entreprises.siteweb','entreprises.rccm',
        'entreprises.invPersonnel','entreprises.invHub','entreprises.invRecherche',
        'entreprises.chiffreAffaire','entreprises.nbremploye','entreprises.slug','entreprises.logo',
            //forme
            'forme_juridiques.nomForme','secteurs.nomSecteur',
            //users
            'users.name','users.email','users.avatar','users.telephone','users.adresse',
            //
            'provinces.nomProvince','pays.nomPays', 'entreprises.created_at')
        ->get();
         $output='';
         foreach ($data1 as $row) 
         {                                
             $nomEse=$row->nomEntreprise;
             $adresseEse=$row->adresseEntreprise;
             $Tel1Ese=$row->telephoneEntreprise;
             $Tel2Ese=$row->telephone;
             $siteEse=$row->siteweb;
             $emailEse=$row->emailEntreprise;
             $idNatEse=$row->rccm;
             $numImpotEse=$row->rccm;
             $busnessName=$row->nomSecteur;
             $rccmEse=$row->rccm;
             $pic = $this->displayImg("fichier", 'logo.png');
             $siege=$row->nomForme;         
         }


         $totalPaie=0;
                 
         //
         $data2 = DB::table('tvente_paiement')
         ->select(DB::raw('ROUND(SUM(montant_paie),2) as TotalPaie'))
         ->where([
            ['tvente_paiement.date_paie','>=', $date1],
            ['tvente_paiement.date_paie','<=', $date2],
            ['refBanque','=', $refBanque]
        ])    
         ->get(); 
         $output='';
         foreach ($data2 as $row) 
         {                                
            $totalPaie=$row->TotalPaie;
                           
         }

         $nom_banque='';
         $numero_ssouscompte='';

         $data3 = DB::table('tvente_paiement')
         ->join('tvente_entete_vente','tvente_entete_vente.id','=','tvente_paiement.refEnteteVente')
         ->join('tvente_client','tvente_client.id','=','tvente_entete_vente.refClient')
         ->join('tvente_categorie_client','tvente_categorie_client.id','=','tvente_client.refCategieClient')
 
         ->join('tconf_banque' , 'tconf_banque.id','=','tvente_paiement.refBanque')
         ->join('tfin_ssouscompte','tfin_ssouscompte.id','=','tconf_banque.refSscompte')
         ->join('tfin_souscompte','tfin_souscompte.id','=','tfin_ssouscompte.refSousCompte')
         ->join('tfin_compte','tfin_compte.id','=','tfin_souscompte.refCompte')
         ->join('tfin_classe','tfin_classe.id','=','tfin_compte.refClasse')
         ->join('tfin_typecompte','tfin_typecompte.id','=','tfin_compte.refTypecompte')
         ->join('tfin_typeposition','tfin_typeposition.id','=','tfin_compte.refPosition') 
 
         ->select('tvente_paiement.id','refEnteteVente','montant_paie',
         'libelle','tvente_paiement.author','tvente_paiement.created_at','noms','sexe',
         'contact','mail','adresse','pieceidentite','numeroPiece','dateLivrePiece','lieulivraisonCarte',
         'nationnalite','datenaissance','lieunaissance','profession','occupation','nombreEnfant',
         'dateArriverGoma','arriverPar','refCategieClient','photo','slug',
         'tvente_paiement.devise','tvente_paiement.taux','tvente_categorie_client.designation as CategorieClient',
         'modepaie','libellepaie','refBanque','numeroBordereau',"tconf_banque.nom_banque","tconf_banque.numerocompte",
         'tconf_banque.nom_mode',"tconf_banque.refSscompte",'refSousCompte','nom_ssouscompte','numero_ssouscompte',
         'nom_souscompte','numero_souscompte','tfin_souscompte.refCompte as refCompteBanque','nom_compte',
         'numero_compte','refClasse','refTypecompte','refPosition','nom_classe',
         'numero_classe','nom_typeposition',"nom_typecompte")
         ->selectRaw('((montant_paie)/tvente_paiement.taux) as montant_paieFC')
         ->selectRaw('ROUND((IFNULL(paie,0)),1) as totalPaie')
         ->selectRaw('CONCAT("R",YEAR(tvente_paiement.date_paie),"",MONTH(tvente_paiement.date_paie),"00",tvente_paiement.id) as codeRecu')
         ->selectRaw("DATE_FORMAT(tvente_paiement.date_paie,'%d/%M/%Y') as date_paie")
         ->where([
            ['tvente_paiement.date_paie','>=', $date1],
            ['tvente_paiement.date_paie','<=', $date2],
            ['refBanque','=', $refBanque]
        ])      
        ->get();      
        $output='';
        foreach ($data3 as $row) 
        {
            $nom_banque=$row->nom_banque;
            $numero_ssouscompte=$row->numero_ssouscompte;                   
        }



           

        $output='<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Transitional//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd">
        <!-- saved from url=(0016)http://localhost -->
        <html>
        <head>
            <title>rpt_RapportPaiement</title>
            <meta HTTP-EQUIV="Content-Type" CONTENT="text/html; charset=utf-8"/>
            <style type="text/css">
                .csB6F858D0 {color:#000000;background-color:#D6E5F4;border-left-style: none;border-top-style: none;border-right-style: none;border-bottom-style: none;font-family:Times New Roman; font-size:24px; font-weight:bold; font-style:normal; padding-left:2px;padding-right:2px;}
                .cs49AA1D99 {color:#000000;background-color:#E0E0E0;border-left:#000000 1px solid;border-top:#000000 1px solid;border-right:#000000 1px solid;border-bottom:#000000 1px solid;font-family:Times New Roman; font-size:13px; font-weight:bold; font-style:normal; }
                .cs3DB3E5A1 {color:#000000;background-color:#E0E0E0;border-left-style: none;border-top:#000000 1px solid;border-right:#000000 1px solid;border-bottom:#000000 1px solid;font-family:Times New Roman; font-size:11px; font-weight:bold; font-style:normal; }
                .cs691A15EF {color:#000000;background-color:#E0E0E0;border-left-style: none;border-top:#000000 1px solid;border-right-style: none;border-bottom:#000000 1px solid;font-family:Times New Roman; font-size:11px; font-weight:bold; font-style:normal; }
                .csEAC52FCD {color:#000000;background-color:#E0E0E0;border-left-style: none;border-top:#000000 1px solid;border-right-style: none;border-bottom:#000000 1px solid;font-family:Times New Roman; font-size:13px; font-weight:bold; font-style:normal; }
                .cs56F73198 {color:#000000;background-color:transparent;border-left:#000000 1px solid;border-top:#000000 1px solid;border-right:#000000 1px solid;border-bottom:#000000 1px solid;font-family:Times New Roman; font-size:16px; font-weight:normal; font-style:normal; padding-left:2px;}
                .cs3B0DD49A {color:#000000;background-color:transparent;border-left-style: none;border-top:#000000 1px solid;border-right:#000000 1px solid;border-bottom:#000000 1px solid;font-family:Times New Roman; font-size:11px; font-weight:normal; font-style:normal; }
                .cs803D2C52 {color:#000000;background-color:transparent;border-left-style: none;border-top:#000000 1px solid;border-right-style: none;border-bottom:#000000 1px solid;font-family:Times New Roman; font-size:11px; font-weight:normal; font-style:normal; }
                .cs612ED82F {color:#000000;background-color:transparent;border-left-style: none;border-top-style: none;border-right-style: none;border-bottom-style: none;font-family:Times New Roman; font-size:12px; font-weight:bold; font-style:normal; padding-left:2px;}
                .csFFC1C457 {color:#000000;background-color:transparent;border-left-style: none;border-top-style: none;border-right-style: none;border-bottom-style: none;font-family:Times New Roman; font-size:12px; font-weight:normal; font-style:normal; padding-left:2px;}
                .cs101A94F7 {color:#000000;background-color:transparent;border-left-style: none;border-top-style: none;border-right-style: none;border-bottom-style: none;font-family:Times New Roman; font-size:13px; font-weight:normal; font-style:normal; }
                .csCE72709D {color:#000000;background-color:transparent;border-left-style: none;border-top-style: none;border-right-style: none;border-bottom-style: none;font-family:Times New Roman; font-size:14px; font-weight:bold; font-style:normal; padding-left:2px;}
                .cs12FE94AA {color:#000000;background-color:transparent;border-left-style: none;border-top-style: none;border-right-style: none;border-bottom-style: none;font-family:Times New Roman; font-size:14px; font-weight:normal; font-style:normal; padding-left:2px;}
                .csFBB219FE {color:#000000;background-color:transparent;border-left-style: none;border-top-style: none;border-right-style: none;border-bottom-style: none;font-family:Times New Roman; font-size:18px; font-weight:bold; font-style:normal; padding-left:2px;}
                .cs739196BC {color:#5C5C5C;background-color:transparent;border-left-style: none;border-top-style: none;border-right-style: none;border-bottom-style: none;font-family:Segoe UI; font-size:11px; font-weight:normal; font-style:normal; }
                .csF7D3565D {height:0px;width:0px;overflow:hidden;font-size:0px;line-height:0px;}
            </style>
        </head>
        <body leftMargin=10 topMargin=10 rightMargin=10 bottomMargin=10 style="background-color:#FFFFFF">
        <table cellpadding="0" cellspacing="0" border="0" style="border-width:0px;empty-cells:show;width:946px;height:383px;position:relative;">
            <tr>
                <td style="width:0px;height:0px;"></td>
                <td style="height:0px;width:10px;"></td>
                <td style="height:0px;width:88px;"></td>
                <td style="height:0px;width:50px;"></td>
                <td style="height:0px;width:71px;"></td>
                <td style="height:0px;width:101px;"></td>
                <td style="height:0px;width:23px;"></td>
                <td style="height:0px;width:66px;"></td>
                <td style="height:0px;width:110px;"></td>
                <td style="height:0px;width:127px;"></td>
                <td style="height:0px;width:89px;"></td>
                <td style="height:0px;width:33px;"></td>
                <td style="height:0px;width:9px;"></td>
                <td style="height:0px;width:55px;"></td>
                <td style="height:0px;width:53px;"></td>
                <td style="height:0px;width:59px;"></td>
                <td style="height:0px;width:2px;"></td>
            </tr>
            <tr style="vertical-align:top;">
                <td style="width:0px;height:23px;"></td>
                <td></td>
                <td></td>
                <td></td>
                <td></td>
                <td></td>
                <td></td>
                <td></td>
                <td></td>
                <td></td>
                <td></td>
            </tr>
            <tr style="vertical-align:top;">
                <td style="width:0px;height:9px;"></td>
                <td></td>
                <td></td>
                <td></td>
                <td></td>
                <td></td>
                <td></td>
                <td></td>
                <td></td>
                <td></td>
                <td></td>
                <td></td>
                <td></td>
                <td></td>
                <td></td>
                <td></td>
                <td></td>
            </tr>
            <tr style="vertical-align:top;">
                <td style="width:0px;height:23px;"></td>
                <td></td>
                <td class="csFBB219FE" colspan="9" style="width:723px;height:23px;line-height:21px;text-align:left;vertical-align:middle;"><nobr>'.$nomEse.'</nobr></td>
                <td></td>
                <td class="cs101A94F7" colspan="4" rowspan="7" style="width:176px;height:144px;text-align:left;vertical-align:top;"><div style="overflow:hidden;width:176px;height:144px;">
                    <img alt="" src="'.$pic2.'" style="width:176px;height:144px;" /></div>
                </td>
                <td></td>
            </tr>
            <tr style="vertical-align:top;">
                <td style="width:0px;height:22px;"></td>
                <td></td>
                <td class="csCE72709D" colspan="9" style="width:723px;height:22px;line-height:15px;text-align:left;vertical-align:middle;">'.$busnessName.'</td>
                <td></td>
                <td></td>
            </tr>
            <tr style="vertical-align:top;">
                <td style="width:0px;height:22px;"></td>
                <td></td>
                <td class="csCE72709D" colspan="9" style="width:723px;height:22px;line-height:15px;text-align:left;vertical-align:middle;"><nobr>RCCM'.$rccEse.'.&nbsp;ID-NAT.'.$idNatEse.'</nobr></td>
                <td></td>
                <td></td>
            </tr>
            <tr style="vertical-align:top;">
                <td style="width:0px;height:22px;"></td>
                <td></td>
                <td class="csFFC1C457" colspan="9" style="width:723px;height:22px;line-height:13px;text-align:left;vertical-align:middle;">'.$adresseEse.'</td>
                <td></td>
                <td></td>
            </tr>
            <tr style="vertical-align:top;">
                <td style="width:0px;height:22px;"></td>
                <td></td>
                <td class="csFFC1C457" colspan="9" style="width:723px;height:22px;line-height:13px;text-align:left;vertical-align:middle;"><nobr>Email&nbsp;:&nbsp;'.$emailEse.'</nobr></td>
                <td></td>
                <td></td>
            </tr>
            <tr style="vertical-align:top;">
                <td style="width:0px;height:22px;"></td>
                <td></td>
                <td class="csFFC1C457" colspan="9" style="width:723px;height:22px;line-height:13px;text-align:left;vertical-align:middle;"><nobr>Site&nbsp;web&nbsp;:&nbsp;'.$siteEse.'</nobr></td>
                <td></td>
                <td></td>
            </tr>
            <tr style="vertical-align:top;">
                <td style="width:0px;height:11px;"></td>
                <td></td>
                <td class="cs612ED82F" colspan="9" rowspan="2" style="width:723px;height:23px;line-height:13px;text-align:left;vertical-align:middle;"><nobr>T&#233;l&#233;phone&nbsp;:&nbsp;'.$Tel1Ese.'&nbsp;&nbsp;24h/24</nobr></td>
                <td></td>
                <td></td>
            </tr>
            <tr style="vertical-align:top;">
                <td style="width:0px;height:12px;"></td>
                <td></td>
                <td></td>
                <td></td>
                <td></td>
                <td></td>
                <td></td>
                <td></td>
            </tr>
            <tr style="vertical-align:top;">
                <td style="width:0px;height:8px;"></td>
                <td></td>
                <td></td>
                <td></td>
                <td></td>
                <td></td>
                <td></td>
                <td></td>
                <td></td>
                <td></td>
                <td></td>
                <td></td>
                <td></td>
                <td></td>
                <td></td>
                <td></td>
                <td></td>
            </tr>
            <tr style="vertical-align:top;">
                <td style="width:0px;height:32px;"></td>
                <td></td>
                <td></td>
                <td></td>
                <td class="csB6F858D0" colspan="9" style="width:625px;height:32px;line-height:28px;text-align:center;vertical-align:middle;"><nobr>RAPPORT&nbsp;JOURNALIER&nbsp;DES&nbsp;PAIEMENTS</nobr></td>
                <td></td>
                <td></td>
                <td></td>
                <td></td>
            </tr>
            <tr style="vertical-align:top;">
                <td style="width:0px;height:19px;"></td>
                <td></td>
                <td></td>
                <td></td>
                <td></td>
                <td></td>
                <td></td>
                <td></td>
                <td></td>
                <td></td>
                <td></td>
                <td></td>
                <td></td>
                <td></td>
                <td></td>
                <td></td>
                <td></td>
            </tr>
            <tr style="vertical-align:top;">
                <td style="width:0px;height:23px;"></td>
                <td></td>
                <td class="cs56F73198" colspan="5" style="width:329px;height:21px;line-height:18px;text-align:left;vertical-align:top;"><nobr>&nbsp;PERIODE&nbsp;:&nbsp;&nbsp;Du&nbsp;&nbsp;'.$date1.'&nbsp;&nbsp;au&nbsp;'.$date2.'</nobr></td>
                <td class="cs56F73198" colspan="9" style="width:597px;height:21px;line-height:18px;text-align:left;vertical-align:top;"><nobr>'.$nom_banque.'  : '.$numero_ssouscompte.'</nobr></td>
                <td></td>
            </tr>
            <tr style="vertical-align:top;">
                <td style="width:0px;height:9px;"></td>
                <td></td>
                <td></td>
                <td></td>
                <td></td>
                <td></td>
                <td></td>
                <td></td>
                <td></td>
                <td></td>
                <td></td>
                <td></td>
                <td></td>
                <td></td>
                <td></td>
                <td></td>
                <td></td>
            </tr>
            <tr style="vertical-align:top;">
                <td style="width:0px;height:24px;"></td>
                <td></td>
                <td class="cs3DB3E5A1" style="width:87px;height:22px;line-height:12px;text-align:center;vertical-align:middle;"><nobr>DATE</nobr></td>
                <td class="cs3DB3E5A1" colspan="2" style="width:120px;height:22px;line-height:12px;text-align:center;vertical-align:middle;"><nobr>AGENT</nobr></td>
                <td class="cs3DB3E5A1" style="width:100px;height:22px;line-height:12px;text-align:center;vertical-align:middle;"><nobr>N&#176;&nbsp;PAIEMENT</nobr></td>
                <td class="cs3DB3E5A1" colspan="3" style="width:198px;height:22px;line-height:12px;text-align:center;vertical-align:middle;"><nobr>CLIENT</nobr></td>
                <td class="cs3DB3E5A1" style="width:126px;height:22px;line-height:12px;text-align:center;vertical-align:middle;"><nobr>LIBELLE</nobr></td>
                <td class="cs3DB3E5A1" style="width:88px;height:22px;line-height:12px;text-align:center;vertical-align:middle;"><nobr>N&#176;&nbsp;FACTURE</nobr></td>
                <td class="cs3DB3E5A1" colspan="3" style="width:96px;height:22px;line-height:12px;text-align:center;vertical-align:middle;"><nobr>MONTANT($)</nobr></td>
                <td class="cs3DB3E5A1" style="width:52px;height:22px;line-height:12px;text-align:center;vertical-align:middle;"><nobr>TAUX</nobr></td>
                <td class="cs691A15EF" colspan="2" style="width:61px;height:22px;line-height:12px;text-align:center;vertical-align:middle;"><nobr>COMPTE</nobr></td>
            </tr>
            ';
        
                    $output .= $this->showPaiementFacturation_Banque($date1, $date2,$refBanque); 
        
                    $output.='
            <tr style="vertical-align:top;">
                <td style="width:0px;height:24px;"></td>
                <td></td>
                <td></td>
                <td></td>
                <td></td>
                <td></td>
                <td></td>
                <td></td>
                <td></td>
                <td class="cs49AA1D99" colspan="2" style="width:214px;height:22px;line-height:15px;text-align:center;vertical-align:middle;"><nobr>TOTAL&nbsp;($)&nbsp;:</nobr></td>
                <td class="csEAC52FCD" colspan="5" style="width:209px;height:22px;line-height:15px;text-align:center;vertical-align:middle;"><nobr>'.$totalPaie.' $</nobr></td>
                <td></td>
            </tr>
            <tr style="vertical-align:top;">
                <td style="width:0px;height:10px;"></td>
                <td></td>
                <td></td>
                <td></td>
                <td></td>
                <td></td>
                <td></td>
                <td></td>
                <td></td>
                <td></td>
                <td></td>
                <td></td>
                <td></td>
                <td></td>
                <td></td>
                <td></td>
                <td></td>
            </tr>
            <tr style="vertical-align:top;">
                <td style="width:0px;height:22px;"></td>
                <td></td>
                <td class="cs12FE94AA" colspan="3" style="width:207px;height:22px;line-height:16px;text-align:left;vertical-align:top;"><nobr>Fait&nbsp;&#224;&nbsp;Goma&nbsp;le&nbsp;&nbsp;'.date('Y-m-d').'</nobr></td>
                <td></td>
                <td></td>
                <td></td>
                <td></td>
                <td></td>
                <td></td>
                <td></td>
                <td></td>
                <td></td>
                <td></td>
                <td></td>
                <td></td>
            </tr>
        </table>
        </body>
        </html>';  
       
        return $output; 

}
function showPaiementFacturation_Banque($date1, $date2,$refBanque)
{
        $data = DB::table('tvente_paiement')
        ->join('tvente_entete_vente','tvente_entete_vente.id','=','tvente_paiement.refEnteteVente')
        ->join('tvente_client','tvente_client.id','=','tvente_entete_vente.refClient')
        ->join('tvente_categorie_client','tvente_categorie_client.id','=','tvente_client.refCategieClient')

        ->join('tconf_banque' , 'tconf_banque.id','=','tvente_paiement.refBanque')
        ->join('tfin_ssouscompte','tfin_ssouscompte.id','=','tconf_banque.refSscompte')
        ->join('tfin_souscompte','tfin_souscompte.id','=','tfin_ssouscompte.refSousCompte')
        ->join('tfin_compte','tfin_compte.id','=','tfin_souscompte.refCompte')
        ->join('tfin_classe','tfin_classe.id','=','tfin_compte.refClasse')
        ->join('tfin_typecompte','tfin_typecompte.id','=','tfin_compte.refTypecompte')
        ->join('tfin_typeposition','tfin_typeposition.id','=','tfin_compte.refPosition') 

        ->select('tvente_paiement.id','refEnteteVente','montant_paie',
        'libelle','tvente_paiement.author','tvente_paiement.created_at','noms','sexe',
        'contact','mail','adresse','pieceidentite','numeroPiece','dateLivrePiece','lieulivraisonCarte',
        'nationnalite','datenaissance','lieunaissance','profession','occupation','nombreEnfant',
        'dateArriverGoma','arriverPar','refCategieClient','photo','slug',
        'tvente_paiement.devise','tvente_paiement.taux as montant_taux','tvente_categorie_client.designation as CategorieClient',
        'modepaie','libellepaie','refBanque','numeroBordereau',"tconf_banque.nom_banque","tconf_banque.numerocompte",
        'tconf_banque.nom_mode',"tconf_banque.refSscompte",'refSousCompte','nom_ssouscompte','numero_ssouscompte',
        'nom_souscompte','numero_souscompte','tfin_souscompte.refCompte as refCompteBanque','nom_compte',
        'numero_compte','refClasse','refTypecompte','refPosition','nom_classe',
        'numero_classe','nom_typeposition',"nom_typecompte")
        ->selectRaw('((montant_paie)/tvente_paiement.taux) as montant_paieFC')
        ->selectRaw('ROUND((IFNULL(paie,0)),1) as totalPaie')
        ->selectRaw('CONCAT("F",YEAR(dateVente),"",MONTH(dateVente),"00",tvente_entete_vente.id) as codeFacture')
        ->selectRaw('CONCAT("R",YEAR(tvente_paiement.date_paie),"",MONTH(tvente_paiement.date_paie),"00",tvente_paiement.id) as codeRecu')
        ->selectRaw("DATE_FORMAT(tvente_paiement.date_paie,'%d/%M/%Y') as date_paie")
        ->where([
           ['tvente_paiement.date_paie','>=', $date1],
           ['tvente_paiement.date_paie','<=', $date2],
           ['refBanque','=', $refBanque],
       ])
       ->orderBy("tvente_paiement.created_at", "asc")
       ->get();
       $output='';

    foreach ($data as $row) 
    {
        $output .='
                <tr style="vertical-align:top;">
                <td style="width:0px;height:24px;"></td>
                <td></td>
                <td class="cs3B0DD49A" style="width:87px;height:22px;line-height:12px;text-align:center;vertical-align:middle;">'.$row->date_paie.'</td>
                <td class="cs3B0DD49A" colspan="2" style="width:120px;height:22px;line-height:12px;text-align:left;vertical-align:middle;">'.$row->author.'</td>
                <td class="cs3B0DD49A" style="width:100px;height:22px;line-height:12px;text-align:center;vertical-align:middle;">'.$row->codeRecu.'</td>
                <td class="cs3B0DD49A" colspan="3" style="width:198px;height:22px;line-height:12px;text-align:left;vertical-align:middle;">'.$row->noms.'</td>
                <td class="cs3B0DD49A" style="width:126px;height:22px;line-height:12px;text-align:center;vertical-align:middle;">'.$row->codeFacture.'&nbsp;:&nbsp;'.$row->noms.'</td>
                <td class="cs3B0DD49A" style="width:88px;height:22px;line-height:12px;text-align:center;vertical-align:middle;">'.$row->codeFacture.'</td>
                <td class="cs3B0DD49A" colspan="3" style="width:96px;height:22px;line-height:12px;text-align:center;vertical-align:middle;">'.$row->montant_paie.'$</td>
                <td class="cs3B0DD49A" style="width:52px;height:22px;line-height:12px;text-align:center;vertical-align:middle;">'.$row->montant_taux.'</td>
                <td class="cs803D2C52" style="width:59px;height:22px;line-height:12px;text-align:center;vertical-align:middle;">'.$row->numero_ssouscompte.'</td>
                <td></td>
            </tr>
        '; 
           
   
    }

    return $output;

}


public function fetch_rapport_paiementfacture_date_etat_facture(Request $request)
{
    if ($request->get('date1') && $request->get('date2')&& $request->get('etat_facture')) {
        // code...
        $date1 = $request->get('date1');
        $date2 = $request->get('date2');
        $etat_facture = $request->get('etat_facture');
        
        $html ='<html><head><meta http-equiv="Content-Type" content="text/html; charset=utf-8"/>';
        $html .= $this->printRapportPaiementFacture_EtatFacture($date1, $date2,$etat_facture);       
        $html .='<script>window.print()</script>';
        echo($html);
    } else {
        // code...
    }  
    
}
function printRapportPaiementFacture_EtatFacture($date1, $date2,$etat_facture)
{

        $nomEse='';
        $adresseEse='';
        $Tel1Ese='';
        $Tel2Ese='';
        $siteEse='';
        $emailEse='';
        $idNatEse='';
        $numImpotEse='';
        $rccEse='';
        $siege='';
        $busnessName='';
        $pic='';
        $pic2 = $this->displayImg("fichier", 'logo.png');
        $logo='';

        $data1 = DB::table('entreprises')
        ->join('secteurs','secteurs.id','=','entreprises.idsecteur')
        ->join('forme_juridiques','forme_juridiques.id','=','entreprises.idforme')

        ->join('pays','pays.id','=','entreprises.idPays')
        ->join('provinces','provinces.id','=','entreprises.idProvince')
        ->join('users','users.id','=','entreprises.ceo')        
        ->select('entreprises.id as id','entreprises.id as idEntreprise',
        'entreprises.ceo','entreprises.nomEntreprise','entreprises.descriptionEntreprise',
        'entreprises.emailEntreprise','entreprises.adresseEntreprise',
        'entreprises.telephoneEntreprise','entreprises.solutionEntreprise','entreprises.idsecteur',
        'entreprises.idforme','entreprises.etat',
        'entreprises.idPays','entreprises.idProvince','entreprises.edition','entreprises.facebook',
        'entreprises.linkedin','entreprises.twitter','entreprises.siteweb','entreprises.rccm',
        'entreprises.invPersonnel','entreprises.invHub','entreprises.invRecherche',
        'entreprises.chiffreAffaire','entreprises.nbremploye','entreprises.slug','entreprises.logo',
            //forme
            'forme_juridiques.nomForme','secteurs.nomSecteur',
            //users
            'users.name','users.email','users.avatar','users.telephone','users.adresse',
            //
            'provinces.nomProvince','pays.nomPays', 'entreprises.created_at')
        ->get();
         $output='';
         foreach ($data1 as $row) 
         {                                
             $nomEse=$row->nomEntreprise;
             $adresseEse=$row->adresseEntreprise;
             $Tel1Ese=$row->telephoneEntreprise;
             $Tel2Ese=$row->telephone;
             $siteEse=$row->siteweb;
             $emailEse=$row->emailEntreprise;
             $idNatEse=$row->rccm;
             $numImpotEse=$row->rccm;
             $busnessName=$row->nomSecteur;
             $rccmEse=$row->rccm;
             $pic = $this->displayImg("fichier", 'logo.png');
             $siege=$row->nomForme;         
         }


         $totalPaie=0;
                 
         //
         $data2 = DB::table('tvente_paiement')
         ->join('tvente_entete_vente','tvente_entete_vente.id','=','tvente_paiement.refEnteteVente')
         ->select(DB::raw('ROUND(SUM(montant_paie),2) as TotalPaie'))
         ->where([
            ['tvente_paiement.date_paie','>=', $date1],
            ['tvente_paiement.date_paie','<=', $date2],
            ['tvente_entete_vente.etat_facture','=', $etat_facture]
        ])    
         ->get(); 
         $output='';
         foreach ($data2 as $row) 
         {                                
            $totalPaie=$row->TotalPaie;
                           
         }

         $nom_banque= $etat_facture;
         $numero_ssouscompte= '--';





           

        $output='<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Transitional//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd">
        <!-- saved from url=(0016)http://localhost -->
        <html>
        <head>
            <title>rpt_RapportPaiement</title>
            <meta HTTP-EQUIV="Content-Type" CONTENT="text/html; charset=utf-8"/>
            <style type="text/css">
                .csB6F858D0 {color:#000000;background-color:#D6E5F4;border-left-style: none;border-top-style: none;border-right-style: none;border-bottom-style: none;font-family:Times New Roman; font-size:24px; font-weight:bold; font-style:normal; padding-left:2px;padding-right:2px;}
                .cs49AA1D99 {color:#000000;background-color:#E0E0E0;border-left:#000000 1px solid;border-top:#000000 1px solid;border-right:#000000 1px solid;border-bottom:#000000 1px solid;font-family:Times New Roman; font-size:13px; font-weight:bold; font-style:normal; }
                .cs3DB3E5A1 {color:#000000;background-color:#E0E0E0;border-left-style: none;border-top:#000000 1px solid;border-right:#000000 1px solid;border-bottom:#000000 1px solid;font-family:Times New Roman; font-size:11px; font-weight:bold; font-style:normal; }
                .cs691A15EF {color:#000000;background-color:#E0E0E0;border-left-style: none;border-top:#000000 1px solid;border-right-style: none;border-bottom:#000000 1px solid;font-family:Times New Roman; font-size:11px; font-weight:bold; font-style:normal; }
                .csEAC52FCD {color:#000000;background-color:#E0E0E0;border-left-style: none;border-top:#000000 1px solid;border-right-style: none;border-bottom:#000000 1px solid;font-family:Times New Roman; font-size:13px; font-weight:bold; font-style:normal; }
                .cs56F73198 {color:#000000;background-color:transparent;border-left:#000000 1px solid;border-top:#000000 1px solid;border-right:#000000 1px solid;border-bottom:#000000 1px solid;font-family:Times New Roman; font-size:16px; font-weight:normal; font-style:normal; padding-left:2px;}
                .cs3B0DD49A {color:#000000;background-color:transparent;border-left-style: none;border-top:#000000 1px solid;border-right:#000000 1px solid;border-bottom:#000000 1px solid;font-family:Times New Roman; font-size:11px; font-weight:normal; font-style:normal; }
                .cs803D2C52 {color:#000000;background-color:transparent;border-left-style: none;border-top:#000000 1px solid;border-right-style: none;border-bottom:#000000 1px solid;font-family:Times New Roman; font-size:11px; font-weight:normal; font-style:normal; }
                .cs612ED82F {color:#000000;background-color:transparent;border-left-style: none;border-top-style: none;border-right-style: none;border-bottom-style: none;font-family:Times New Roman; font-size:12px; font-weight:bold; font-style:normal; padding-left:2px;}
                .csFFC1C457 {color:#000000;background-color:transparent;border-left-style: none;border-top-style: none;border-right-style: none;border-bottom-style: none;font-family:Times New Roman; font-size:12px; font-weight:normal; font-style:normal; padding-left:2px;}
                .cs101A94F7 {color:#000000;background-color:transparent;border-left-style: none;border-top-style: none;border-right-style: none;border-bottom-style: none;font-family:Times New Roman; font-size:13px; font-weight:normal; font-style:normal; }
                .csCE72709D {color:#000000;background-color:transparent;border-left-style: none;border-top-style: none;border-right-style: none;border-bottom-style: none;font-family:Times New Roman; font-size:14px; font-weight:bold; font-style:normal; padding-left:2px;}
                .cs12FE94AA {color:#000000;background-color:transparent;border-left-style: none;border-top-style: none;border-right-style: none;border-bottom-style: none;font-family:Times New Roman; font-size:14px; font-weight:normal; font-style:normal; padding-left:2px;}
                .csFBB219FE {color:#000000;background-color:transparent;border-left-style: none;border-top-style: none;border-right-style: none;border-bottom-style: none;font-family:Times New Roman; font-size:18px; font-weight:bold; font-style:normal; padding-left:2px;}
                .cs739196BC {color:#5C5C5C;background-color:transparent;border-left-style: none;border-top-style: none;border-right-style: none;border-bottom-style: none;font-family:Segoe UI; font-size:11px; font-weight:normal; font-style:normal; }
                .csF7D3565D {height:0px;width:0px;overflow:hidden;font-size:0px;line-height:0px;}
            </style>
        </head>
        <body leftMargin=10 topMargin=10 rightMargin=10 bottomMargin=10 style="background-color:#FFFFFF">
        <table cellpadding="0" cellspacing="0" border="0" style="border-width:0px;empty-cells:show;width:946px;height:383px;position:relative;">
            <tr>
                <td style="width:0px;height:0px;"></td>
                <td style="height:0px;width:10px;"></td>
                <td style="height:0px;width:88px;"></td>
                <td style="height:0px;width:50px;"></td>
                <td style="height:0px;width:71px;"></td>
                <td style="height:0px;width:101px;"></td>
                <td style="height:0px;width:23px;"></td>
                <td style="height:0px;width:66px;"></td>
                <td style="height:0px;width:110px;"></td>
                <td style="height:0px;width:127px;"></td>
                <td style="height:0px;width:89px;"></td>
                <td style="height:0px;width:33px;"></td>
                <td style="height:0px;width:9px;"></td>
                <td style="height:0px;width:55px;"></td>
                <td style="height:0px;width:53px;"></td>
                <td style="height:0px;width:59px;"></td>
                <td style="height:0px;width:2px;"></td>
            </tr>
            <tr style="vertical-align:top;">
                <td style="width:0px;height:23px;"></td>
                <td></td>
                <td></td>
                <td></td>
                <td></td>
                <td></td>
                <td></td>
                <td></td>
                <td></td>
                <td></td>
                <td></td>
            </tr>
            <tr style="vertical-align:top;">
                <td style="width:0px;height:9px;"></td>
                <td></td>
                <td></td>
                <td></td>
                <td></td>
                <td></td>
                <td></td>
                <td></td>
                <td></td>
                <td></td>
                <td></td>
                <td></td>
                <td></td>
                <td></td>
                <td></td>
                <td></td>
                <td></td>
            </tr>
            <tr style="vertical-align:top;">
                <td style="width:0px;height:23px;"></td>
                <td></td>
                <td class="csFBB219FE" colspan="9" style="width:723px;height:23px;line-height:21px;text-align:left;vertical-align:middle;"><nobr>'.$nomEse.'</nobr></td>
                <td></td>
                <td class="cs101A94F7" colspan="4" rowspan="7" style="width:176px;height:144px;text-align:left;vertical-align:top;"><div style="overflow:hidden;width:176px;height:144px;">
                    <img alt="" src="'.$pic2.'" style="width:176px;height:144px;" /></div>
                </td>
                <td></td>
            </tr>
            <tr style="vertical-align:top;">
                <td style="width:0px;height:22px;"></td>
                <td></td>
                <td class="csCE72709D" colspan="9" style="width:723px;height:22px;line-height:15px;text-align:left;vertical-align:middle;">'.$busnessName.'</td>
                <td></td>
                <td></td>
            </tr>
            <tr style="vertical-align:top;">
                <td style="width:0px;height:22px;"></td>
                <td></td>
                <td class="csCE72709D" colspan="9" style="width:723px;height:22px;line-height:15px;text-align:left;vertical-align:middle;"><nobr>RCCM'.$rccEse.'.&nbsp;ID-NAT.'.$idNatEse.'</nobr></td>
                <td></td>
                <td></td>
            </tr>
            <tr style="vertical-align:top;">
                <td style="width:0px;height:22px;"></td>
                <td></td>
                <td class="csFFC1C457" colspan="9" style="width:723px;height:22px;line-height:13px;text-align:left;vertical-align:middle;">'.$adresseEse.'</td>
                <td></td>
                <td></td>
            </tr>
            <tr style="vertical-align:top;">
                <td style="width:0px;height:22px;"></td>
                <td></td>
                <td class="csFFC1C457" colspan="9" style="width:723px;height:22px;line-height:13px;text-align:left;vertical-align:middle;"><nobr>Email&nbsp;:&nbsp;'.$emailEse.'</nobr></td>
                <td></td>
                <td></td>
            </tr>
            <tr style="vertical-align:top;">
                <td style="width:0px;height:22px;"></td>
                <td></td>
                <td class="csFFC1C457" colspan="9" style="width:723px;height:22px;line-height:13px;text-align:left;vertical-align:middle;"><nobr>Site&nbsp;web&nbsp;:&nbsp;'.$siteEse.'</nobr></td>
                <td></td>
                <td></td>
            </tr>
            <tr style="vertical-align:top;">
                <td style="width:0px;height:11px;"></td>
                <td></td>
                <td class="cs612ED82F" colspan="9" rowspan="2" style="width:723px;height:23px;line-height:13px;text-align:left;vertical-align:middle;"><nobr>T&#233;l&#233;phone&nbsp;:&nbsp;'.$Tel1Ese.'&nbsp;&nbsp;24h/24</nobr></td>
                <td></td>
                <td></td>
            </tr>
            <tr style="vertical-align:top;">
                <td style="width:0px;height:12px;"></td>
                <td></td>
                <td></td>
                <td></td>
                <td></td>
                <td></td>
                <td></td>
                <td></td>
            </tr>
            <tr style="vertical-align:top;">
                <td style="width:0px;height:8px;"></td>
                <td></td>
                <td></td>
                <td></td>
                <td></td>
                <td></td>
                <td></td>
                <td></td>
                <td></td>
                <td></td>
                <td></td>
                <td></td>
                <td></td>
                <td></td>
                <td></td>
                <td></td>
                <td></td>
            </tr>
            <tr style="vertical-align:top;">
                <td style="width:0px;height:32px;"></td>
                <td></td>
                <td></td>
                <td></td>
                <td class="csB6F858D0" colspan="9" style="width:625px;height:32px;line-height:28px;text-align:center;vertical-align:middle;"><nobr>RAPPORT&nbsp;JOURNALIER&nbsp;DES&nbsp;PAIEMENTS</nobr></td>
                <td></td>
                <td></td>
                <td></td>
                <td></td>
            </tr>
            <tr style="vertical-align:top;">
                <td style="width:0px;height:19px;"></td>
                <td></td>
                <td></td>
                <td></td>
                <td></td>
                <td></td>
                <td></td>
                <td></td>
                <td></td>
                <td></td>
                <td></td>
                <td></td>
                <td></td>
                <td></td>
                <td></td>
                <td></td>
                <td></td>
            </tr>
            <tr style="vertical-align:top;">
                <td style="width:0px;height:23px;"></td>
                <td></td>
                <td class="cs56F73198" colspan="5" style="width:329px;height:21px;line-height:18px;text-align:left;vertical-align:top;"><nobr>&nbsp;PERIODE&nbsp;:&nbsp;&nbsp;Du&nbsp;&nbsp;'.$date1.'&nbsp;&nbsp;au&nbsp;'.$date2.'</nobr></td>
                <td class="cs56F73198" colspan="9" style="width:597px;height:21px;line-height:18px;text-align:left;vertical-align:top;"><nobr>'.$nom_banque.'  : '.$numero_ssouscompte.'</nobr></td>
                <td></td>
            </tr>
            <tr style="vertical-align:top;">
                <td style="width:0px;height:9px;"></td>
                <td></td>
                <td></td>
                <td></td>
                <td></td>
                <td></td>
                <td></td>
                <td></td>
                <td></td>
                <td></td>
                <td></td>
                <td></td>
                <td></td>
                <td></td>
                <td></td>
                <td></td>
                <td></td>
            </tr>
            <tr style="vertical-align:top;">
                <td style="width:0px;height:24px;"></td>
                <td></td>
                <td class="cs3DB3E5A1" style="width:87px;height:22px;line-height:12px;text-align:center;vertical-align:middle;"><nobr>DATE</nobr></td>
                <td class="cs3DB3E5A1" colspan="2" style="width:120px;height:22px;line-height:12px;text-align:center;vertical-align:middle;"><nobr>AGENT</nobr></td>
                <td class="cs3DB3E5A1" style="width:100px;height:22px;line-height:12px;text-align:center;vertical-align:middle;"><nobr>N&#176;&nbsp;PAIEMENT</nobr></td>
                <td class="cs3DB3E5A1" colspan="3" style="width:198px;height:22px;line-height:12px;text-align:center;vertical-align:middle;"><nobr>CLIENT</nobr></td>
                <td class="cs3DB3E5A1" style="width:126px;height:22px;line-height:12px;text-align:center;vertical-align:middle;"><nobr>LIBELLE</nobr></td>
                <td class="cs3DB3E5A1" style="width:88px;height:22px;line-height:12px;text-align:center;vertical-align:middle;"><nobr>N&#176;&nbsp;FACTURE</nobr></td>
                <td class="cs3DB3E5A1" colspan="3" style="width:96px;height:22px;line-height:12px;text-align:center;vertical-align:middle;"><nobr>MONTANT($)</nobr></td>
                <td class="cs3DB3E5A1" style="width:52px;height:22px;line-height:12px;text-align:center;vertical-align:middle;"><nobr>TAUX</nobr></td>
                <td class="cs691A15EF" colspan="2" style="width:61px;height:22px;line-height:12px;text-align:center;vertical-align:middle;"><nobr>COMPTE</nobr></td>
            </tr>
            ';
        
                    $output .= $this->showPaiementFacturation_EtatFacture($date1, $date2,$etat_facture); 
        
                    $output.='
            <tr style="vertical-align:top;">
                <td style="width:0px;height:24px;"></td>
                <td></td>
                <td></td>
                <td></td>
                <td></td>
                <td></td>
                <td></td>
                <td></td>
                <td></td>
                <td class="cs49AA1D99" colspan="2" style="width:214px;height:22px;line-height:15px;text-align:center;vertical-align:middle;"><nobr>TOTAL&nbsp;($)&nbsp;:</nobr></td>
                <td class="csEAC52FCD" colspan="5" style="width:209px;height:22px;line-height:15px;text-align:center;vertical-align:middle;"><nobr>'.$totalPaie.' $</nobr></td>
                <td></td>
            </tr>
            <tr style="vertical-align:top;">
                <td style="width:0px;height:10px;"></td>
                <td></td>
                <td></td>
                <td></td>
                <td></td>
                <td></td>
                <td></td>
                <td></td>
                <td></td>
                <td></td>
                <td></td>
                <td></td>
                <td></td>
                <td></td>
                <td></td>
                <td></td>
                <td></td>
            </tr>
            <tr style="vertical-align:top;">
                <td style="width:0px;height:22px;"></td>
                <td></td>
                <td class="cs12FE94AA" colspan="3" style="width:207px;height:22px;line-height:16px;text-align:left;vertical-align:top;"><nobr>Fait&nbsp;&#224;&nbsp;Goma&nbsp;le&nbsp;&nbsp;'.date('Y-m-d').'</nobr></td>
                <td></td>
                <td></td>
                <td></td>
                <td></td>
                <td></td>
                <td></td>
                <td></td>
                <td></td>
                <td></td>
                <td></td>
                <td></td>
                <td></td>
            </tr>
        </table>
        </body>
        </html>';  
       
        return $output; 

}
function showPaiementFacturation_EtatFacture($date1, $date2,$etat_facture)
{
        $data = DB::table('tvente_paiement')
        ->join('tvente_entete_vente','tvente_entete_vente.id','=','tvente_paiement.refEnteteVente')
        ->join('tvente_client','tvente_client.id','=','tvente_entete_vente.refClient')
        ->join('tvente_categorie_client','tvente_categorie_client.id','=','tvente_client.refCategieClient')

        ->join('tconf_banque' , 'tconf_banque.id','=','tvente_paiement.refBanque')
        ->join('tfin_ssouscompte','tfin_ssouscompte.id','=','tconf_banque.refSscompte')
        ->join('tfin_souscompte','tfin_souscompte.id','=','tfin_ssouscompte.refSousCompte')
        ->join('tfin_compte','tfin_compte.id','=','tfin_souscompte.refCompte')
        ->join('tfin_classe','tfin_classe.id','=','tfin_compte.refClasse')
        ->join('tfin_typecompte','tfin_typecompte.id','=','tfin_compte.refTypecompte')
        ->join('tfin_typeposition','tfin_typeposition.id','=','tfin_compte.refPosition') 

        ->select('tvente_paiement.id','refEnteteVente','montant_paie',
        'libelle','tvente_paiement.author','tvente_paiement.created_at','noms','sexe',
        'contact','mail','adresse','pieceidentite','numeroPiece','dateLivrePiece','lieulivraisonCarte',
        'nationnalite','datenaissance','lieunaissance','profession','occupation','nombreEnfant',
        'dateArriverGoma','arriverPar','refCategieClient','photo','slug',
        'tvente_paiement.devise','tvente_paiement.taux as montant_taux','tvente_categorie_client.designation as CategorieClient',
        'modepaie','libellepaie','refBanque','numeroBordereau',"tconf_banque.nom_banque","tconf_banque.numerocompte",
        'tconf_banque.nom_mode',"tconf_banque.refSscompte",'refSousCompte','nom_ssouscompte','numero_ssouscompte',
        'nom_souscompte','numero_souscompte','tfin_souscompte.refCompte as refCompteBanque','nom_compte',
        'numero_compte','refClasse','refTypecompte','refPosition','nom_classe',
        'numero_classe','nom_typeposition',"nom_typecompte")
        ->selectRaw('((montant_paie)/tvente_paiement.taux) as montant_paieFC')
        ->selectRaw('ROUND((IFNULL(paie,0)),1) as totalPaie')
        ->selectRaw('CONCAT("F",YEAR(dateVente),"",MONTH(dateVente),"00",tvente_entete_vente.id) as codeFacture')
        ->selectRaw('CONCAT("R",YEAR(tvente_paiement.date_paie),"",MONTH(tvente_paiement.date_paie),"00",tvente_paiement.id) as codeRecu')
        ->selectRaw("DATE_FORMAT(tvente_paiement.date_paie,'%d/%M/%Y') as date_paie")
        ->where([
           ['tvente_paiement.date_paie','>=', $date1],
           ['tvente_paiement.date_paie','<=', $date2],
           ['tvente_entete_vente.etat_facture','=', $etat_facture],
       ])
       ->orderBy("tvente_paiement.created_at", "asc")
       ->get();
       $output='';

    foreach ($data as $row) 
    {
        $output .='
                <tr style="vertical-align:top;">
                <td style="width:0px;height:24px;"></td>
                <td></td>
                <td class="cs3B0DD49A" style="width:87px;height:22px;line-height:12px;text-align:center;vertical-align:middle;">'.$row->date_paie.'</td>
                <td class="cs3B0DD49A" colspan="2" style="width:120px;height:22px;line-height:12px;text-align:left;vertical-align:middle;">'.$row->author.'</td>
                <td class="cs3B0DD49A" style="width:100px;height:22px;line-height:12px;text-align:center;vertical-align:middle;">'.$row->codeRecu.'</td>
                <td class="cs3B0DD49A" colspan="3" style="width:198px;height:22px;line-height:12px;text-align:left;vertical-align:middle;">'.$row->noms.'</td>
                <td class="cs3B0DD49A" style="width:126px;height:22px;line-height:12px;text-align:center;vertical-align:middle;">'.$row->codeFacture.'&nbsp;:&nbsp;'.$row->noms.'</td>
                <td class="cs3B0DD49A" style="width:88px;height:22px;line-height:12px;text-align:center;vertical-align:middle;">'.$row->codeFacture.'</td>
                <td class="cs3B0DD49A" colspan="3" style="width:96px;height:22px;line-height:12px;text-align:center;vertical-align:middle;">'.$row->montant_paie.'$</td>
                <td class="cs3B0DD49A" style="width:52px;height:22px;line-height:12px;text-align:center;vertical-align:middle;">'.$row->montant_taux.'</td>
                <td class="cs803D2C52" style="width:59px;height:22px;line-height:12px;text-align:center;vertical-align:middle;">'.$row->numero_ssouscompte.'</td>
                <td></td>
            </tr>
        '; 
           
   
    }

    return $output;

}


//===================== RAPPORT DE PAIEMENT  DES COMMANDES DES FOURNISSEURS =====================================
//===============================================================================================================

public function fetch_rapport_paiementfacture_commande_date(Request $request)
{
    
    if ($request->get('date1') && $request->get('date2')) {
        // code...
        $date1 = $request->get('date1');
        $date2 = $request->get('date2');

        $html ='<html><head><meta http-equiv="Content-Type" content="text/html; charset=utf-8"/>';
        $html .= $this->printRapportPaieFactureCommande($date1, $date2);       
        $html .='<script>window.print()</script>';
        echo($html);
    } else {
        // code...
    }
    
    
}
function printRapportPaieFactureCommande($date1, $date2)
{

         //Info Entreprise
        $nomEse='';
        $adresseEse='';
        $Tel1Ese='';
        $Tel2Ese='';
        $siteEse='';
        $emailEse='';
        $idNatEse='';
        $numImpotEse='';
        $rccEse='';
        $siege='';
        $busnessName='';
        $pic='';
        $pic2 = $this->displayImg("fichier", 'logo.png');
        $logo='';

        $data1 = DB::table('entreprises')
        ->join('secteurs','secteurs.id','=','entreprises.idsecteur')
        ->join('forme_juridiques','forme_juridiques.id','=','entreprises.idforme')

        ->join('pays','pays.id','=','entreprises.idPays')
        ->join('provinces','provinces.id','=','entreprises.idProvince')
        ->join('users','users.id','=','entreprises.ceo')        
        ->select('entreprises.id as id','entreprises.id as idEntreprise',
        'entreprises.ceo','entreprises.nomEntreprise','entreprises.descriptionEntreprise',
        'entreprises.emailEntreprise','entreprises.adresseEntreprise',
        'entreprises.telephoneEntreprise','entreprises.solutionEntreprise','entreprises.idsecteur',
        'entreprises.idforme','entreprises.etat',
        'entreprises.idPays','entreprises.idProvince','entreprises.edition','entreprises.facebook',
        'entreprises.linkedin','entreprises.twitter','entreprises.siteweb','entreprises.rccm',
        'entreprises.invPersonnel','entreprises.invHub','entreprises.invRecherche',
        'entreprises.chiffreAffaire','entreprises.nbremploye','entreprises.slug','entreprises.logo',
            //forme
            'forme_juridiques.nomForme','secteurs.nomSecteur',
            //users
            'users.name','users.email','users.avatar','users.telephone','users.adresse',
            //
            'provinces.nomProvince','pays.nomPays', 'entreprises.created_at')
        ->get();
         $output='';
         foreach ($data1 as $row) 
         {                                
             $nomEse=$row->nomEntreprise;
             $adresseEse=$row->adresseEntreprise;
             $Tel1Ese=$row->telephoneEntreprise;
             $Tel2Ese=$row->telephone;
             $siteEse=$row->siteweb;
             $emailEse=$row->emailEntreprise;
             $idNatEse=$row->rccm;
             $numImpotEse=$row->rccm;
             $busnessName=$row->nomSecteur;
             $rccmEse=$row->rccm;
             $pic = $this->displayImg("fichier", 'logo.png');
             $siege=$row->nomForme;         
         }

         $totalPaie=0;
                 
         //
         $data2 = DB::table('tvente_paiement_commande')         
         ->select(DB::raw('ROUND(SUM(montant_paie),2) as TotalPaie'))
         ->where([
            ['tvente_paiement_commande.date_paie','>=', $date1],
            ['tvente_paiement_commande.date_paie','<=', $date2]
        ])    
         ->get(); 
         $output='';
         foreach ($data2 as $row) 
         {                                
            $totalPaie=$row->TotalPaie;
                           
         }

           

        $output='
        <!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Transitional//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd">
        <!-- saved from url=(0016)http://localhost -->
        <html>
        <head>
            <title>rpt_RapportPaiement</title>
            <meta HTTP-EQUIV="Content-Type" CONTENT="text/html; charset=utf-8"/>
            <style type="text/css">
                .csB6F858D0 {color:#000000;background-color:#D6E5F4;border-left-style: none;border-top-style: none;border-right-style: none;border-bottom-style: none;font-family:Times New Roman; font-size:24px; font-weight:bold; font-style:normal; padding-left:2px;padding-right:2px;}
                .cs49AA1D99 {color:#000000;background-color:#E0E0E0;border-left:#000000 1px solid;border-top:#000000 1px solid;border-right:#000000 1px solid;border-bottom:#000000 1px solid;font-family:Times New Roman; font-size:13px; font-weight:bold; font-style:normal; }
                .cs3DB3E5A1 {color:#000000;background-color:#E0E0E0;border-left-style: none;border-top:#000000 1px solid;border-right:#000000 1px solid;border-bottom:#000000 1px solid;font-family:Times New Roman; font-size:11px; font-weight:bold; font-style:normal; }
                .cs691A15EF {color:#000000;background-color:#E0E0E0;border-left-style: none;border-top:#000000 1px solid;border-right-style: none;border-bottom:#000000 1px solid;font-family:Times New Roman; font-size:11px; font-weight:bold; font-style:normal; }
                .csEAC52FCD {color:#000000;background-color:#E0E0E0;border-left-style: none;border-top:#000000 1px solid;border-right-style: none;border-bottom:#000000 1px solid;font-family:Times New Roman; font-size:13px; font-weight:bold; font-style:normal; }
                .cs56F73198 {color:#000000;background-color:transparent;border-left:#000000 1px solid;border-top:#000000 1px solid;border-right:#000000 1px solid;border-bottom:#000000 1px solid;font-family:Times New Roman; font-size:16px; font-weight:normal; font-style:normal; padding-left:2px;}
                .cs3B0DD49A {color:#000000;background-color:transparent;border-left-style: none;border-top:#000000 1px solid;border-right:#000000 1px solid;border-bottom:#000000 1px solid;font-family:Times New Roman; font-size:11px; font-weight:normal; font-style:normal; }
                .cs803D2C52 {color:#000000;background-color:transparent;border-left-style: none;border-top:#000000 1px solid;border-right-style: none;border-bottom:#000000 1px solid;font-family:Times New Roman; font-size:11px; font-weight:normal; font-style:normal; }
                .cs612ED82F {color:#000000;background-color:transparent;border-left-style: none;border-top-style: none;border-right-style: none;border-bottom-style: none;font-family:Times New Roman; font-size:12px; font-weight:bold; font-style:normal; padding-left:2px;}
                .csFFC1C457 {color:#000000;background-color:transparent;border-left-style: none;border-top-style: none;border-right-style: none;border-bottom-style: none;font-family:Times New Roman; font-size:12px; font-weight:normal; font-style:normal; padding-left:2px;}
                .cs101A94F7 {color:#000000;background-color:transparent;border-left-style: none;border-top-style: none;border-right-style: none;border-bottom-style: none;font-family:Times New Roman; font-size:13px; font-weight:normal; font-style:normal; }
                .csCE72709D {color:#000000;background-color:transparent;border-left-style: none;border-top-style: none;border-right-style: none;border-bottom-style: none;font-family:Times New Roman; font-size:14px; font-weight:bold; font-style:normal; padding-left:2px;}
                .cs12FE94AA {color:#000000;background-color:transparent;border-left-style: none;border-top-style: none;border-right-style: none;border-bottom-style: none;font-family:Times New Roman; font-size:14px; font-weight:normal; font-style:normal; padding-left:2px;}
                .csFBB219FE {color:#000000;background-color:transparent;border-left-style: none;border-top-style: none;border-right-style: none;border-bottom-style: none;font-family:Times New Roman; font-size:18px; font-weight:bold; font-style:normal; padding-left:2px;}
                .cs739196BC {color:#5C5C5C;background-color:transparent;border-left-style: none;border-top-style: none;border-right-style: none;border-bottom-style: none;font-family:Segoe UI; font-size:11px; font-weight:normal; font-style:normal; }
                .csF7D3565D {height:0px;width:0px;overflow:hidden;font-size:0px;line-height:0px;}
            </style>
        </head>
        <body leftMargin=10 topMargin=10 rightMargin=10 bottomMargin=10 style="background-color:#FFFFFF">
        <table cellpadding="0" cellspacing="0" border="0" style="border-width:0px;empty-cells:show;width:946px;height:383px;position:relative;">
            <tr>
                <td style="width:0px;height:0px;"></td>
                <td style="height:0px;width:10px;"></td>
                <td style="height:0px;width:88px;"></td>
                <td style="height:0px;width:50px;"></td>
                <td style="height:0px;width:71px;"></td>
                <td style="height:0px;width:101px;"></td>
                <td style="height:0px;width:23px;"></td>
                <td style="height:0px;width:66px;"></td>
                <td style="height:0px;width:110px;"></td>
                <td style="height:0px;width:127px;"></td>
                <td style="height:0px;width:89px;"></td>
                <td style="height:0px;width:33px;"></td>
                <td style="height:0px;width:9px;"></td>
                <td style="height:0px;width:55px;"></td>
                <td style="height:0px;width:53px;"></td>
                <td style="height:0px;width:59px;"></td>
                <td style="height:0px;width:2px;"></td>
            </tr>
            <tr style="vertical-align:top;">
                <td style="width:0px;height:23px;"></td>
                <td></td>
                <td></td>
                <td></td>
                <td></td>
                <td></td>
                <td></td>
                <td></td>
                <td></td>
                <td></td>
                <td></td>
            </tr>
            <tr style="vertical-align:top;">
                <td style="width:0px;height:9px;"></td>
                <td></td>
                <td></td>
                <td></td>
                <td></td>
                <td></td>
                <td></td>
                <td></td>
                <td></td>
                <td></td>
                <td></td>
                <td></td>
                <td></td>
                <td></td>
                <td></td>
                <td></td>
                <td></td>
            </tr>
            <tr style="vertical-align:top;">
                <td style="width:0px;height:23px;"></td>
                <td></td>
                <td class="csFBB219FE" colspan="9" style="width:723px;height:23px;line-height:21px;text-align:left;vertical-align:middle;"><nobr>'.$nomEse.'</nobr></td>
                <td></td>
                <td class="cs101A94F7" colspan="4" rowspan="7" style="width:176px;height:144px;text-align:left;vertical-align:top;"><div style="overflow:hidden;width:176px;height:144px;">
                    <img alt="" src="'.$pic2.'" style="width:176px;height:144px;" /></div>
                </td>
                <td></td>
            </tr>
            <tr style="vertical-align:top;">
                <td style="width:0px;height:22px;"></td>
                <td></td>
                <td class="csCE72709D" colspan="9" style="width:723px;height:22px;line-height:15px;text-align:left;vertical-align:middle;">'.$busnessName.'</td>
                <td></td>
                <td></td>
            </tr>
            <tr style="vertical-align:top;">
                <td style="width:0px;height:22px;"></td>
                <td></td>
                <td class="csCE72709D" colspan="9" style="width:723px;height:22px;line-height:15px;text-align:left;vertical-align:middle;"><nobr>RCCM'.$rccEse.'.&nbsp;ID-NAT.'.$idNatEse.'</nobr></td>
                <td></td>
                <td></td>
            </tr>
            <tr style="vertical-align:top;">
                <td style="width:0px;height:22px;"></td>
                <td></td>
                <td class="csFFC1C457" colspan="9" style="width:723px;height:22px;line-height:13px;text-align:left;vertical-align:middle;">'.$adresseEse.'</td>
                <td></td>
                <td></td>
            </tr>
            <tr style="vertical-align:top;">
                <td style="width:0px;height:22px;"></td>
                <td></td>
                <td class="csFFC1C457" colspan="9" style="width:723px;height:22px;line-height:13px;text-align:left;vertical-align:middle;"><nobr>Email&nbsp;:&nbsp;'.$emailEse.'</nobr></td>
                <td></td>
                <td></td>
            </tr>
            <tr style="vertical-align:top;">
                <td style="width:0px;height:22px;"></td>
                <td></td>
                <td class="csFFC1C457" colspan="9" style="width:723px;height:22px;line-height:13px;text-align:left;vertical-align:middle;"><nobr>Site&nbsp;web&nbsp;:&nbsp;'.$siteEse.'</nobr></td>
                <td></td>
                <td></td>
            </tr>
            <tr style="vertical-align:top;">
                <td style="width:0px;height:11px;"></td>
                <td></td>
                <td class="cs612ED82F" colspan="9" rowspan="2" style="width:723px;height:23px;line-height:13px;text-align:left;vertical-align:middle;"><nobr>T&#233;l&#233;phone&nbsp;:&nbsp;'.$Tel1Ese.'&nbsp;&nbsp;24h/24</nobr></td>
                <td></td>
                <td></td>
            </tr>
            <tr style="vertical-align:top;">
                <td style="width:0px;height:12px;"></td>
                <td></td>
                <td></td>
                <td></td>
                <td></td>
                <td></td>
                <td></td>
                <td></td>
            </tr>
            <tr style="vertical-align:top;">
                <td style="width:0px;height:8px;"></td>
                <td></td>
                <td></td>
                <td></td>
                <td></td>
                <td></td>
                <td></td>
                <td></td>
                <td></td>
                <td></td>
                <td></td>
                <td></td>
                <td></td>
                <td></td>
                <td></td>
                <td></td>
                <td></td>
            </tr>
            <tr style="vertical-align:top;">
                <td style="width:0px;height:32px;"></td>
                <td></td>
                <td></td>
                <td></td>
                <td class="csB6F858D0" colspan="9" style="width:625px;height:32px;line-height:28px;text-align:center;vertical-align:middle;"><nobr>RAPPORT&nbsp;JOURNALIER&nbsp;DES&nbsp;PAIEMENTS</nobr></td>
                <td></td>
                <td></td>
                <td></td>
                <td></td>
            </tr>
            <tr style="vertical-align:top;">
                <td style="width:0px;height:19px;"></td>
                <td></td>
                <td></td>
                <td></td>
                <td></td>
                <td></td>
                <td></td>
                <td></td>
                <td></td>
                <td></td>
                <td></td>
                <td></td>
                <td></td>
                <td></td>
                <td></td>
                <td></td>
                <td></td>
            </tr>
            <tr style="vertical-align:top;">
                <td style="width:0px;height:23px;"></td>
                <td></td>
                <td class="cs56F73198" colspan="5" style="width:329px;height:21px;line-height:18px;text-align:left;vertical-align:top;"><nobr>&nbsp;PERIODE&nbsp;:&nbsp;&nbsp;Du&nbsp;&nbsp;'.$date1.'&nbsp;&nbsp;au&nbsp;'.$date2.'</nobr></td>
                <td class="cs56F73198" colspan="9" style="width:597px;height:21px;line-height:18px;text-align:left;vertical-align:top;"><nobr>DEPARTEMENT</nobr></td>
                <td></td>
            </tr>
            <tr style="vertical-align:top;">
                <td style="width:0px;height:9px;"></td>
                <td></td>
                <td></td>
                <td></td>
                <td></td>
                <td></td>
                <td></td>
                <td></td>
                <td></td>
                <td></td>
                <td></td>
                <td></td>
                <td></td>
                <td></td>
                <td></td>
                <td></td>
                <td></td>
            </tr>
            <tr style="vertical-align:top;">
                <td style="width:0px;height:24px;"></td>
                <td></td>
                <td class="cs3DB3E5A1" style="width:87px;height:22px;line-height:12px;text-align:center;vertical-align:middle;"><nobr>DATE</nobr></td>
                <td class="cs3DB3E5A1" colspan="2" style="width:120px;height:22px;line-height:12px;text-align:center;vertical-align:middle;"><nobr>AGENT</nobr></td>
                <td class="cs3DB3E5A1" style="width:100px;height:22px;line-height:12px;text-align:center;vertical-align:middle;"><nobr>N&#176;&nbsp;PAIEMENT</nobr></td>
                <td class="cs3DB3E5A1" colspan="3" style="width:198px;height:22px;line-height:12px;text-align:center;vertical-align:middle;"><nobr>FOURNISSEUR</nobr></td>
                <td class="cs3DB3E5A1" style="width:126px;height:22px;line-height:12px;text-align:center;vertical-align:middle;"><nobr>LIBELLE</nobr></td>
                <td class="cs3DB3E5A1" style="width:88px;height:22px;line-height:12px;text-align:center;vertical-align:middle;"><nobr>N&#176;&nbsp;FACTURE</nobr></td>
                <td class="cs3DB3E5A1" colspan="3" style="width:96px;height:22px;line-height:12px;text-align:center;vertical-align:middle;"><nobr>MONTANT($)</nobr></td>
                <td class="cs3DB3E5A1" style="width:52px;height:22px;line-height:12px;text-align:center;vertical-align:middle;"><nobr>TAUX</nobr></td>
                <td class="cs691A15EF" colspan="2" style="width:61px;height:22px;line-height:12px;text-align:center;vertical-align:middle;"><nobr>COMPTE</nobr></td>
            </tr>
            ';
        
                    $output .= $this->showPaieFacturationCommande($date1,$date2); 
        
                    $output.='
            <tr style="vertical-align:top;">
                <td style="width:0px;height:24px;"></td>
                <td></td>
                <td></td>
                <td></td>
                <td></td>
                <td></td>
                <td></td>
                <td></td>
                <td></td>
                <td class="cs49AA1D99" colspan="2" style="width:214px;height:22px;line-height:15px;text-align:center;vertical-align:middle;"><nobr>TOTAL&nbsp;($)&nbsp;:</nobr></td>
                <td class="csEAC52FCD" colspan="5" style="width:209px;height:22px;line-height:15px;text-align:center;vertical-align:middle;"><nobr>'.$totalPaie.' $</nobr></td>
                <td></td>
            </tr>
            <tr style="vertical-align:top;">
                <td style="width:0px;height:10px;"></td>
                <td></td>
                <td></td>
                <td></td>
                <td></td>
                <td></td>
                <td></td>
                <td></td>
                <td></td>
                <td></td>
                <td></td>
                <td></td>
                <td></td>
                <td></td>
                <td></td>
                <td></td>
                <td></td>
            </tr>
            <tr style="vertical-align:top;">
                <td style="width:0px;height:22px;"></td>
                <td></td>
                <td class="cs12FE94AA" colspan="3" style="width:207px;height:22px;line-height:16px;text-align:left;vertical-align:top;"><nobr>Fait&nbsp;&#224;&nbsp;Goma&nbsp;le&nbsp;&nbsp;'.date('Y-m-d').'</nobr></td>
                <td></td>
                <td></td>
                <td></td>
                <td></td>
                <td></td>
                <td></td>
                <td></td>
                <td></td>
                <td></td>
                <td></td>
                <td></td>
                <td></td>
            </tr>
        </table>
        </body>
        </html>
        ';  
       
        return $output; 

}
function showPaieFacturationCommande($date1, $date2)
{
    $data = DB::table('tvente_paiement_commande')
    ->join('tvente_entete_requisition','tvente_entete_requisition.id','=','tvente_paiement_commande.refCommande')
    ->join('tvente_entete_paiecommande','tvente_entete_paiecommande.id','=','tvente_paiement_commande.refEntetepaie')
    ->join('tvente_module','tvente_module.id','=','tvente_entete_requisition.module_id')
    ->join('tvente_services','tvente_services.id','=','tvente_entete_requisition.refService')
    ->join('tvente_fournisseur','tvente_fournisseur.id','=','tvente_entete_requisition.refFournisseur')
    ->join('tvente_categorie_fournisseur','tvente_categorie_fournisseur.id','=','tvente_fournisseur.refCategorieFss')
    ->join('tfin_ssouscompte as comptefss','comptefss.id','=','tvente_categorie_fournisseur.compte_fss_bl')
    ->join('tconf_banque' , 'tconf_banque.id','=','tvente_paiement_commande.refBanque')
    ->join('tfin_ssouscompte as compteBanque','compteBanque.id','=','tconf_banque.refSscompte')

    ->select('tvente_paiement_commande.id','tvente_entete_paiecommande.code','refEntetepaie','refCommande','refBanque',
    'montant_paie','tvente_paiement_commande.devise','tvente_paiement_commande.taux',
    'modepaie','libellepaie','numeroBordereau','tvente_paiement_commande.author',
    'tvente_paiement_commande.refUser','tvente_paiement_commande.active','tvente_paiement_commande.created_at',
    "tvente_module.nom_module","tvente_services.nom_service",
    'refFournisseur','tvente_entete_paiecommande.module_id as module_idPaie',
    'tvente_entete_paiecommande.refService as refServicePaie','dateCmd','libelle','niveau1','niveaumax',
    'montant','paie',"tvente_fournisseur.noms","tvente_fournisseur.contact","tvente_fournisseur.mail",
    "tvente_fournisseur.adresse",'refCategorieFss',"tvente_categorie_fournisseur.nom_categoriefss",
    "compte_fss_bl",'comptefss.refSousCompte as refSousCompteFss',
    'comptefss.nom_ssouscompte as nom_ssouscompteFss','comptefss.numero_ssouscompte as numero_ssouscompteFss',
    'date_entete_paie',    
    "tconf_banque.nom_banque","tconf_banque.numerocompte",'tconf_banque.nom_mode',
    "tconf_banque.refSscompte as refSscompteBanque"
    ,'compteBanque.refSousCompte as refSousCompteBanque',
    'compteBanque.nom_ssouscompte as nom_ssouscompteBanque',
    'compteBanque.numero_ssouscompte as numero_ssouscompteBanque')
    ->selectRaw('((montant_paie)/tvente_paiement_commande.taux) as montant_paieFC')
    ->selectRaw('CONCAT("R",YEAR(date_paie),"",MONTH(date_paie),"00",tvente_paiement_commande.id) as codeRecu')
    ->selectRaw('ROUND((IFNULL(paie,0)),1) as totalPaie')
    ->selectRaw('CONCAT("F",YEAR(dateCmd),"",MONTH(dateCmd),"00",tvente_entete_requisition.id) as codeFacture')
    ->selectRaw("DATE_FORMAT(tvente_paiement_commande.date_paie,'%d/%M/%Y') as date_paie")
    ->where([
        ['tvente_paiement_commande.date_paie','>=', $date1],
        ['tvente_paiement_commande.date_paie','<=', $date2]
    ])
    ->orderBy("tvente_paiement_commande.created_at", "asc")
    ->get();

    $output='';

    foreach ($data as $row) 
    {
        $output .='
        <tr style="vertical-align:top;">
		<td style="width:0px;height:24px;"></td>
		<td></td>
		<td class="cs3B0DD49A" style="width:87px;height:22px;line-height:12px;text-align:center;vertical-align:middle;">'.$row->date_paie.'</td>
		<td class="cs3B0DD49A" colspan="2" style="width:120px;height:22px;line-height:12px;text-align:left;vertical-align:middle;">'.$row->author.'</td>
		<td class="cs3B0DD49A" style="width:100px;height:22px;line-height:12px;text-align:center;vertical-align:middle;">'.$row->codeRecu.'</td>
		<td class="cs3B0DD49A" colspan="3" style="width:198px;height:22px;line-height:12px;text-align:left;vertical-align:middle;">'.$row->noms.'</td>
		<td class="cs3B0DD49A" style="width:126px;height:22px;line-height:12px;text-align:center;vertical-align:middle;">'.$row->codeFacture.'&nbsp;:&nbsp;'.$row->noms.'</td>
		<td class="cs3B0DD49A" style="width:88px;height:22px;line-height:12px;text-align:center;vertical-align:middle;">'.$row->codeFacture.'</td>
		<td class="cs3B0DD49A" colspan="3" style="width:96px;height:22px;line-height:12px;text-align:center;vertical-align:middle;">'.$row->montant_paie.'$</td>
		<td class="cs3B0DD49A" style="width:52px;height:22px;line-height:12px;text-align:center;vertical-align:middle;">'.$row->taux.'</td>
		<td class="cs803D2C52" style="width:59px;height:22px;line-height:12px;text-align:center;vertical-align:middle;">'.$row->numero_ssouscompteBanque.'</td>
		<td></td>
	</tr>
        ';        
   
    }

    return $output;

}


public function fetch_rapport_paiementfacture_commande_date_banque(Request $request)
{
    if ($request->get('date1') && $request->get('date2')&& $request->get('refBanque')) {
        // code...
        $date1 = $request->get('date1');
        $date2 = $request->get('date2');
        $refBanque = $request->get('refBanque');
        
        $html ='<html><head><meta http-equiv="Content-Type" content="text/html; charset=utf-8"/>';
        $html .= $this->printRapportPaiementFactureCommande_Banque($date1, $date2,$refBanque);       
        $html .='<script>window.print()</script>';
        echo($html);
    } else {
        // code...
    }  
    
}
function printRapportPaiementFactureCommande_Banque($date1, $date2,$refBanque)
{

        $nomEse='';
        $adresseEse='';
        $Tel1Ese='';
        $Tel2Ese='';
        $siteEse='';
        $emailEse='';
        $idNatEse='';
        $numImpotEse='';
        $rccEse='';
        $siege='';
        $busnessName='';
        $pic='';
        $pic2 = $this->displayImg("fichier", 'logo.png');
        $logo='';

        $data1 = DB::table('entreprises')
        ->join('secteurs','secteurs.id','=','entreprises.idsecteur')
        ->join('forme_juridiques','forme_juridiques.id','=','entreprises.idforme')

        ->join('pays','pays.id','=','entreprises.idPays')
        ->join('provinces','provinces.id','=','entreprises.idProvince')
        ->join('users','users.id','=','entreprises.ceo')        
        ->select('entreprises.id as id','entreprises.id as idEntreprise',
        'entreprises.ceo','entreprises.nomEntreprise','entreprises.descriptionEntreprise',
        'entreprises.emailEntreprise','entreprises.adresseEntreprise',
        'entreprises.telephoneEntreprise','entreprises.solutionEntreprise','entreprises.idsecteur',
        'entreprises.idforme','entreprises.etat',
        'entreprises.idPays','entreprises.idProvince','entreprises.edition','entreprises.facebook',
        'entreprises.linkedin','entreprises.twitter','entreprises.siteweb','entreprises.rccm',
        'entreprises.invPersonnel','entreprises.invHub','entreprises.invRecherche',
        'entreprises.chiffreAffaire','entreprises.nbremploye','entreprises.slug','entreprises.logo',
            //forme
            'forme_juridiques.nomForme','secteurs.nomSecteur',
            //users
            'users.name','users.email','users.avatar','users.telephone','users.adresse',
            //
            'provinces.nomProvince','pays.nomPays', 'entreprises.created_at')
        ->get();
         $output='';
         foreach ($data1 as $row) 
         {                                
             $nomEse=$row->nomEntreprise;
             $adresseEse=$row->adresseEntreprise;
             $Tel1Ese=$row->telephoneEntreprise;
             $Tel2Ese=$row->telephone;
             $siteEse=$row->siteweb;
             $emailEse=$row->emailEntreprise;
             $idNatEse=$row->rccm;
             $numImpotEse=$row->rccm;
             $busnessName=$row->nomSecteur;
             $rccmEse=$row->rccm;
             $pic = $this->displayImg("fichier", 'logo.png');
             $siege=$row->nomForme;         
         }


         $totalPaie=0;
                 
         //
         $data2 = DB::table('tvente_paiement_commande')
         ->select(DB::raw('ROUND(SUM(montant_paie),2) as TotalPaie'))
         ->where([
            ['tvente_paiement_commande.date_paie','>=', $date1],
            ['tvente_paiement_commande.date_paie','<=', $date2],
            ['refBanque','=', $refBanque]
        ])    
         ->first(); 
         $output='';
         if ($data2) 
         {                                
            $totalPaie=$data2->TotalPaie;
                           
         }

         $nom_banque='';
         $numero_ssouscompte='';

         $data3 = DB::table('tconf_banque')
         ->select('id','nom_banque','numerocompte','nom_mode','refSscompte','author','refUser')
         ->where([
            ['tconf_banque.id','=', $refBanque]
        ])      
        ->first();      
        $output='';
        if ($data3) 
        {
            $nom_banque=$data3->nom_banque;
            $numero_ssouscompte=$data3->numero_ssouscompte;                   
        }



           

        $output='<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Transitional//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd">
        <!-- saved from url=(0016)http://localhost -->
        <html>
        <head>
            <title>rpt_RapportPaiement</title>
            <meta HTTP-EQUIV="Content-Type" CONTENT="text/html; charset=utf-8"/>
            <style type="text/css">
                .csB6F858D0 {color:#000000;background-color:#D6E5F4;border-left-style: none;border-top-style: none;border-right-style: none;border-bottom-style: none;font-family:Times New Roman; font-size:24px; font-weight:bold; font-style:normal; padding-left:2px;padding-right:2px;}
                .cs49AA1D99 {color:#000000;background-color:#E0E0E0;border-left:#000000 1px solid;border-top:#000000 1px solid;border-right:#000000 1px solid;border-bottom:#000000 1px solid;font-family:Times New Roman; font-size:13px; font-weight:bold; font-style:normal; }
                .cs3DB3E5A1 {color:#000000;background-color:#E0E0E0;border-left-style: none;border-top:#000000 1px solid;border-right:#000000 1px solid;border-bottom:#000000 1px solid;font-family:Times New Roman; font-size:11px; font-weight:bold; font-style:normal; }
                .cs691A15EF {color:#000000;background-color:#E0E0E0;border-left-style: none;border-top:#000000 1px solid;border-right-style: none;border-bottom:#000000 1px solid;font-family:Times New Roman; font-size:11px; font-weight:bold; font-style:normal; }
                .csEAC52FCD {color:#000000;background-color:#E0E0E0;border-left-style: none;border-top:#000000 1px solid;border-right-style: none;border-bottom:#000000 1px solid;font-family:Times New Roman; font-size:13px; font-weight:bold; font-style:normal; }
                .cs56F73198 {color:#000000;background-color:transparent;border-left:#000000 1px solid;border-top:#000000 1px solid;border-right:#000000 1px solid;border-bottom:#000000 1px solid;font-family:Times New Roman; font-size:16px; font-weight:normal; font-style:normal; padding-left:2px;}
                .cs3B0DD49A {color:#000000;background-color:transparent;border-left-style: none;border-top:#000000 1px solid;border-right:#000000 1px solid;border-bottom:#000000 1px solid;font-family:Times New Roman; font-size:11px; font-weight:normal; font-style:normal; }
                .cs803D2C52 {color:#000000;background-color:transparent;border-left-style: none;border-top:#000000 1px solid;border-right-style: none;border-bottom:#000000 1px solid;font-family:Times New Roman; font-size:11px; font-weight:normal; font-style:normal; }
                .cs612ED82F {color:#000000;background-color:transparent;border-left-style: none;border-top-style: none;border-right-style: none;border-bottom-style: none;font-family:Times New Roman; font-size:12px; font-weight:bold; font-style:normal; padding-left:2px;}
                .csFFC1C457 {color:#000000;background-color:transparent;border-left-style: none;border-top-style: none;border-right-style: none;border-bottom-style: none;font-family:Times New Roman; font-size:12px; font-weight:normal; font-style:normal; padding-left:2px;}
                .cs101A94F7 {color:#000000;background-color:transparent;border-left-style: none;border-top-style: none;border-right-style: none;border-bottom-style: none;font-family:Times New Roman; font-size:13px; font-weight:normal; font-style:normal; }
                .csCE72709D {color:#000000;background-color:transparent;border-left-style: none;border-top-style: none;border-right-style: none;border-bottom-style: none;font-family:Times New Roman; font-size:14px; font-weight:bold; font-style:normal; padding-left:2px;}
                .cs12FE94AA {color:#000000;background-color:transparent;border-left-style: none;border-top-style: none;border-right-style: none;border-bottom-style: none;font-family:Times New Roman; font-size:14px; font-weight:normal; font-style:normal; padding-left:2px;}
                .csFBB219FE {color:#000000;background-color:transparent;border-left-style: none;border-top-style: none;border-right-style: none;border-bottom-style: none;font-family:Times New Roman; font-size:18px; font-weight:bold; font-style:normal; padding-left:2px;}
                .cs739196BC {color:#5C5C5C;background-color:transparent;border-left-style: none;border-top-style: none;border-right-style: none;border-bottom-style: none;font-family:Segoe UI; font-size:11px; font-weight:normal; font-style:normal; }
                .csF7D3565D {height:0px;width:0px;overflow:hidden;font-size:0px;line-height:0px;}
            </style>
        </head>
        <body leftMargin=10 topMargin=10 rightMargin=10 bottomMargin=10 style="background-color:#FFFFFF">
        <table cellpadding="0" cellspacing="0" border="0" style="border-width:0px;empty-cells:show;width:946px;height:383px;position:relative;">
            <tr>
                <td style="width:0px;height:0px;"></td>
                <td style="height:0px;width:10px;"></td>
                <td style="height:0px;width:88px;"></td>
                <td style="height:0px;width:50px;"></td>
                <td style="height:0px;width:71px;"></td>
                <td style="height:0px;width:101px;"></td>
                <td style="height:0px;width:23px;"></td>
                <td style="height:0px;width:66px;"></td>
                <td style="height:0px;width:110px;"></td>
                <td style="height:0px;width:127px;"></td>
                <td style="height:0px;width:89px;"></td>
                <td style="height:0px;width:33px;"></td>
                <td style="height:0px;width:9px;"></td>
                <td style="height:0px;width:55px;"></td>
                <td style="height:0px;width:53px;"></td>
                <td style="height:0px;width:59px;"></td>
                <td style="height:0px;width:2px;"></td>
            </tr>
            <tr style="vertical-align:top;">
                <td style="width:0px;height:23px;"></td>
                <td></td>
                <td></td>
                <td></td>
                <td></td>
                <td></td>
                <td></td>
                <td></td>
                <td></td>
                <td></td>
                <td></td>
            </tr>
            <tr style="vertical-align:top;">
                <td style="width:0px;height:9px;"></td>
                <td></td>
                <td></td>
                <td></td>
                <td></td>
                <td></td>
                <td></td>
                <td></td>
                <td></td>
                <td></td>
                <td></td>
                <td></td>
                <td></td>
                <td></td>
                <td></td>
                <td></td>
                <td></td>
            </tr>
            <tr style="vertical-align:top;">
                <td style="width:0px;height:23px;"></td>
                <td></td>
                <td class="csFBB219FE" colspan="9" style="width:723px;height:23px;line-height:21px;text-align:left;vertical-align:middle;"><nobr>'.$nomEse.'</nobr></td>
                <td></td>
                <td class="cs101A94F7" colspan="4" rowspan="7" style="width:176px;height:144px;text-align:left;vertical-align:top;"><div style="overflow:hidden;width:176px;height:144px;">
                    <img alt="" src="'.$pic2.'" style="width:176px;height:144px;" /></div>
                </td>
                <td></td>
            </tr>
            <tr style="vertical-align:top;">
                <td style="width:0px;height:22px;"></td>
                <td></td>
                <td class="csCE72709D" colspan="9" style="width:723px;height:22px;line-height:15px;text-align:left;vertical-align:middle;">'.$busnessName.'</td>
                <td></td>
                <td></td>
            </tr>
            <tr style="vertical-align:top;">
                <td style="width:0px;height:22px;"></td>
                <td></td>
                <td class="csCE72709D" colspan="9" style="width:723px;height:22px;line-height:15px;text-align:left;vertical-align:middle;"><nobr>RCCM'.$rccEse.'.&nbsp;ID-NAT.'.$idNatEse.'</nobr></td>
                <td></td>
                <td></td>
            </tr>
            <tr style="vertical-align:top;">
                <td style="width:0px;height:22px;"></td>
                <td></td>
                <td class="csFFC1C457" colspan="9" style="width:723px;height:22px;line-height:13px;text-align:left;vertical-align:middle;">'.$adresseEse.'</td>
                <td></td>
                <td></td>
            </tr>
            <tr style="vertical-align:top;">
                <td style="width:0px;height:22px;"></td>
                <td></td>
                <td class="csFFC1C457" colspan="9" style="width:723px;height:22px;line-height:13px;text-align:left;vertical-align:middle;"><nobr>Email&nbsp;:&nbsp;'.$emailEse.'</nobr></td>
                <td></td>
                <td></td>
            </tr>
            <tr style="vertical-align:top;">
                <td style="width:0px;height:22px;"></td>
                <td></td>
                <td class="csFFC1C457" colspan="9" style="width:723px;height:22px;line-height:13px;text-align:left;vertical-align:middle;"><nobr>Site&nbsp;web&nbsp;:&nbsp;'.$siteEse.'</nobr></td>
                <td></td>
                <td></td>
            </tr>
            <tr style="vertical-align:top;">
                <td style="width:0px;height:11px;"></td>
                <td></td>
                <td class="cs612ED82F" colspan="9" rowspan="2" style="width:723px;height:23px;line-height:13px;text-align:left;vertical-align:middle;"><nobr>T&#233;l&#233;phone&nbsp;:&nbsp;'.$Tel1Ese.'&nbsp;&nbsp;24h/24</nobr></td>
                <td></td>
                <td></td>
            </tr>
            <tr style="vertical-align:top;">
                <td style="width:0px;height:12px;"></td>
                <td></td>
                <td></td>
                <td></td>
                <td></td>
                <td></td>
                <td></td>
                <td></td>
            </tr>
            <tr style="vertical-align:top;">
                <td style="width:0px;height:8px;"></td>
                <td></td>
                <td></td>
                <td></td>
                <td></td>
                <td></td>
                <td></td>
                <td></td>
                <td></td>
                <td></td>
                <td></td>
                <td></td>
                <td></td>
                <td></td>
                <td></td>
                <td></td>
                <td></td>
            </tr>
            <tr style="vertical-align:top;">
                <td style="width:0px;height:32px;"></td>
                <td></td>
                <td></td>
                <td></td>
                <td class="csB6F858D0" colspan="9" style="width:625px;height:32px;line-height:28px;text-align:center;vertical-align:middle;"><nobr>RAPPORT&nbsp;JOURNALIER&nbsp;DES&nbsp;PAIEMENTS</nobr></td>
                <td></td>
                <td></td>
                <td></td>
                <td></td>
            </tr>
            <tr style="vertical-align:top;">
                <td style="width:0px;height:19px;"></td>
                <td></td>
                <td></td>
                <td></td>
                <td></td>
                <td></td>
                <td></td>
                <td></td>
                <td></td>
                <td></td>
                <td></td>
                <td></td>
                <td></td>
                <td></td>
                <td></td>
                <td></td>
                <td></td>
            </tr>
            <tr style="vertical-align:top;">
                <td style="width:0px;height:23px;"></td>
                <td></td>
                <td class="cs56F73198" colspan="5" style="width:329px;height:21px;line-height:18px;text-align:left;vertical-align:top;"><nobr>&nbsp;PERIODE&nbsp;:&nbsp;&nbsp;Du&nbsp;&nbsp;'.$date1.'&nbsp;&nbsp;au&nbsp;'.$date2.'</nobr></td>
                <td class="cs56F73198" colspan="9" style="width:597px;height:21px;line-height:18px;text-align:left;vertical-align:top;"><nobr>'.$nom_banque.'  : '.$numero_ssouscompte.'</nobr></td>
                <td></td>
            </tr>
            <tr style="vertical-align:top;">
                <td style="width:0px;height:9px;"></td>
                <td></td>
                <td></td>
                <td></td>
                <td></td>
                <td></td>
                <td></td>
                <td></td>
                <td></td>
                <td></td>
                <td></td>
                <td></td>
                <td></td>
                <td></td>
                <td></td>
                <td></td>
                <td></td>
            </tr>
            <tr style="vertical-align:top;">
                <td style="width:0px;height:24px;"></td>
                <td></td>
                <td class="cs3DB3E5A1" style="width:87px;height:22px;line-height:12px;text-align:center;vertical-align:middle;"><nobr>DATE</nobr></td>
                <td class="cs3DB3E5A1" colspan="2" style="width:120px;height:22px;line-height:12px;text-align:center;vertical-align:middle;"><nobr>AGENT</nobr></td>
                <td class="cs3DB3E5A1" style="width:100px;height:22px;line-height:12px;text-align:center;vertical-align:middle;"><nobr>N&#176;&nbsp;PAIEMENT</nobr></td>
                <td class="cs3DB3E5A1" colspan="3" style="width:198px;height:22px;line-height:12px;text-align:center;vertical-align:middle;"><nobr>FOURNISSEUR</nobr></td>
                <td class="cs3DB3E5A1" style="width:126px;height:22px;line-height:12px;text-align:center;vertical-align:middle;"><nobr>LIBELLE</nobr></td>
                <td class="cs3DB3E5A1" style="width:88px;height:22px;line-height:12px;text-align:center;vertical-align:middle;"><nobr>N&#176;&nbsp;FACTURE</nobr></td>
                <td class="cs3DB3E5A1" colspan="3" style="width:96px;height:22px;line-height:12px;text-align:center;vertical-align:middle;"><nobr>MONTANT($)</nobr></td>
                <td class="cs3DB3E5A1" style="width:52px;height:22px;line-height:12px;text-align:center;vertical-align:middle;"><nobr>TAUX</nobr></td>
                <td class="cs691A15EF" colspan="2" style="width:61px;height:22px;line-height:12px;text-align:center;vertical-align:middle;"><nobr>COMPTE</nobr></td>
            </tr>
            ';
        
                    $output .= $this->showPaiementFacturationCommande_Banque($date1, $date2,$refBanque); 
        
                    $output.='
            <tr style="vertical-align:top;">
                <td style="width:0px;height:24px;"></td>
                <td></td>
                <td></td>
                <td></td>
                <td></td>
                <td></td>
                <td></td>
                <td></td>
                <td></td>
                <td class="cs49AA1D99" colspan="2" style="width:214px;height:22px;line-height:15px;text-align:center;vertical-align:middle;"><nobr>TOTAL&nbsp;($)&nbsp;:</nobr></td>
                <td class="csEAC52FCD" colspan="5" style="width:209px;height:22px;line-height:15px;text-align:center;vertical-align:middle;"><nobr>'.$totalPaie.' $</nobr></td>
                <td></td>
            </tr>
            <tr style="vertical-align:top;">
                <td style="width:0px;height:10px;"></td>
                <td></td>
                <td></td>
                <td></td>
                <td></td>
                <td></td>
                <td></td>
                <td></td>
                <td></td>
                <td></td>
                <td></td>
                <td></td>
                <td></td>
                <td></td>
                <td></td>
                <td></td>
                <td></td>
            </tr>
            <tr style="vertical-align:top;">
                <td style="width:0px;height:22px;"></td>
                <td></td>
                <td class="cs12FE94AA" colspan="3" style="width:207px;height:22px;line-height:16px;text-align:left;vertical-align:top;"><nobr>Fait&nbsp;&#224;&nbsp;Goma&nbsp;le&nbsp;&nbsp;'.date('Y-m-d').'</nobr></td>
                <td></td>
                <td></td>
                <td></td>
                <td></td>
                <td></td>
                <td></td>
                <td></td>
                <td></td>
                <td></td>
                <td></td>
                <td></td>
                <td></td>
            </tr>
        </table>
        </body>
        </html>';  
       
        return $output; 

}
function showPaiementFacturationCommande_Banque($date1, $date2,$refBanque)
{
        $data = DB::table('tvente_paiement_commande')
        ->join('tvente_entete_requisition','tvente_entete_requisition.id','=','tvente_paiement_commande.refCommande')
        ->join('tvente_entete_paiecommande','tvente_entete_paiecommande.id','=','tvente_paiement_commande.refEntetepaie')
        ->join('tvente_module','tvente_module.id','=','tvente_entete_requisition.module_id')
        ->join('tvente_services','tvente_services.id','=','tvente_entete_requisition.refService')
        ->join('tvente_fournisseur','tvente_fournisseur.id','=','tvente_entete_requisition.refFournisseur')
        ->join('tvente_categorie_fournisseur','tvente_categorie_fournisseur.id','=','tvente_fournisseur.refCategorieFss')
        ->join('tfin_ssouscompte as comptefss','comptefss.id','=','tvente_categorie_fournisseur.compte_fss_bl')
        ->join('tconf_banque' , 'tconf_banque.id','=','tvente_paiement_commande.refBanque')
        ->join('tfin_ssouscompte as compteBanque','compteBanque.id','=','tconf_banque.refSscompte')
    
        ->select('tvente_paiement_commande.id','tvente_entete_paiecommande.code','refEntetepaie','refCommande','refBanque',
        'montant_paie','tvente_paiement_commande.devise','tvente_paiement_commande.taux',
        'modepaie','libellepaie','numeroBordereau','tvente_paiement_commande.author',
        'tvente_paiement_commande.refUser','tvente_paiement_commande.active','tvente_paiement_commande.created_at',
        "tvente_module.nom_module","tvente_services.nom_service",
        'refFournisseur','tvente_entete_paiecommande.module_id as module_idPaie',
        'tvente_entete_paiecommande.refService as refServicePaie','dateCmd','libelle','niveau1','niveaumax',
        'montant','paie',"tvente_fournisseur.noms","tvente_fournisseur.contact","tvente_fournisseur.mail",
        "tvente_fournisseur.adresse",'refCategorieFss',"tvente_categorie_fournisseur.nom_categoriefss",
        "compte_fss_bl",'comptefss.refSousCompte as refSousCompteFss',
        'comptefss.nom_ssouscompte as nom_ssouscompteFss','comptefss.numero_ssouscompte as numero_ssouscompteFss',
        'date_entete_paie',    
        "tconf_banque.nom_banque","tconf_banque.numerocompte",'tconf_banque.nom_mode',
        "tconf_banque.refSscompte as refSscompteBanque"
        ,'compteBanque.refSousCompte as refSousCompteBanque',
        'compteBanque.nom_ssouscompte as nom_ssouscompteBanque',
        'compteBanque.numero_ssouscompte as numero_ssouscompteBanque')
        ->selectRaw('((montant_paie)/tvente_paiement_commande.taux) as montant_paieFC')
        ->selectRaw('CONCAT("R",YEAR(date_paie),"",MONTH(date_paie),"00",tvente_paiement_commande.id) as codeRecu')
        ->selectRaw('ROUND((IFNULL(paie,0)),1) as totalPaie')
        ->selectRaw('CONCAT("F",YEAR(dateCmd),"",MONTH(dateCmd),"00",tvente_entete_requisition.id) as codeFacture')
        ->selectRaw("DATE_FORMAT(tvente_paiement_commande.date_paie,'%d/%M/%Y') as date_paie")
        ->where([
           ['tvente_paiement_commande.date_paie','>=', $date1],
           ['tvente_paiement_commande.date_paie','<=', $date2],
           ['refBanque','=', $refBanque],
       ])
       ->orderBy("tvente_paiement_commande.created_at", "asc")
       ->get();
       $output='';

    foreach ($data as $row) 
    {
        $output .='
                <tr style="vertical-align:top;">
                <td style="width:0px;height:24px;"></td>
                <td></td>
                <td class="cs3B0DD49A" style="width:87px;height:22px;line-height:12px;text-align:center;vertical-align:middle;">'.$row->date_paie.'</td>
                <td class="cs3B0DD49A" colspan="2" style="width:120px;height:22px;line-height:12px;text-align:left;vertical-align:middle;">'.$row->author.'</td>
                <td class="cs3B0DD49A" style="width:100px;height:22px;line-height:12px;text-align:center;vertical-align:middle;">'.$row->codeRecu.'</td>
                <td class="cs3B0DD49A" colspan="3" style="width:198px;height:22px;line-height:12px;text-align:left;vertical-align:middle;">'.$row->noms.'</td>
                <td class="cs3B0DD49A" style="width:126px;height:22px;line-height:12px;text-align:center;vertical-align:middle;">'.$row->codeFacture.'&nbsp;:&nbsp;'.$row->noms.'</td>
                <td class="cs3B0DD49A" style="width:88px;height:22px;line-height:12px;text-align:center;vertical-align:middle;">'.$row->codeFacture.'</td>
                <td class="cs3B0DD49A" colspan="3" style="width:96px;height:22px;line-height:12px;text-align:center;vertical-align:middle;">'.$row->montant_paie.'$</td>
                <td class="cs3B0DD49A" style="width:52px;height:22px;line-height:12px;text-align:center;vertical-align:middle;">'.$row->montant_taux.'</td>
                <td class="cs803D2C52" style="width:59px;height:22px;line-height:12px;text-align:center;vertical-align:middle;">'.$row->numero_ssouscompte.'</td>
                <td></td>
            </tr>
        '; 
           
   
    }

    return $output;

}



public function fetch_rapport_paiementfacture_commande_date_fournisseur(Request $request)
{
    if ($request->get('date1') && $request->get('date2')&& $request->get('refFournisseur')) {
        // code...
        $date1 = $request->get('date1');
        $date2 = $request->get('date2');
        $refFournisseur = $request->get('refFournisseur');
        
        $html ='<html><head><meta http-equiv="Content-Type" content="text/html; charset=utf-8"/>';
        $html .= $this->printRapportPaiementFactureCommande_Fournisseur($date1, $date2,$refFournisseur);       
        $html .='<script>window.print()</script>';
        echo($html);
    } else {
        // code...
    }  
    
}
function printRapportPaiementFactureCommande_Fournisseur($date1, $date2,$refFournisseur)
{

        $nomEse='';
        $adresseEse='';
        $Tel1Ese='';
        $Tel2Ese='';
        $siteEse='';
        $emailEse='';
        $idNatEse='';
        $numImpotEse='';
        $rccEse='';
        $siege='';
        $busnessName='';
        $pic='';
        $pic2 = $this->displayImg("fichier", 'logo.png');
        $logo='';

        $data1 = DB::table('entreprises')
        ->join('secteurs','secteurs.id','=','entreprises.idsecteur')
        ->join('forme_juridiques','forme_juridiques.id','=','entreprises.idforme')

        ->join('pays','pays.id','=','entreprises.idPays')
        ->join('provinces','provinces.id','=','entreprises.idProvince')
        ->join('users','users.id','=','entreprises.ceo')        
        ->select('entreprises.id as id','entreprises.id as idEntreprise',
        'entreprises.ceo','entreprises.nomEntreprise','entreprises.descriptionEntreprise',
        'entreprises.emailEntreprise','entreprises.adresseEntreprise',
        'entreprises.telephoneEntreprise','entreprises.solutionEntreprise','entreprises.idsecteur',
        'entreprises.idforme','entreprises.etat',
        'entreprises.idPays','entreprises.idProvince','entreprises.edition','entreprises.facebook',
        'entreprises.linkedin','entreprises.twitter','entreprises.siteweb','entreprises.rccm',
        'entreprises.invPersonnel','entreprises.invHub','entreprises.invRecherche',
        'entreprises.chiffreAffaire','entreprises.nbremploye','entreprises.slug','entreprises.logo',
            //forme
            'forme_juridiques.nomForme','secteurs.nomSecteur',
            //users
            'users.name','users.email','users.avatar','users.telephone','users.adresse',
            //
            'provinces.nomProvince','pays.nomPays', 'entreprises.created_at')
        ->get();
         $output='';
         foreach ($data1 as $row) 
         {                                
             $nomEse=$row->nomEntreprise;
             $adresseEse=$row->adresseEntreprise;
             $Tel1Ese=$row->telephoneEntreprise;
             $Tel2Ese=$row->telephone;
             $siteEse=$row->siteweb;
             $emailEse=$row->emailEntreprise;
             $idNatEse=$row->rccm;
             $numImpotEse=$row->rccm;
             $busnessName=$row->nomSecteur;
             $rccmEse=$row->rccm;
             $pic = $this->displayImg("fichier", 'logo.png');
             $siege=$row->nomForme;         
         }


         $totalPaie=0;
                 
         //
         $data2 = DB::table('tvente_paiement_commande')
         ->join('tvente_entete_requisition','tvente_entete_requisition.id','=','tvente_paiement_commande.refCommande')
         ->select(DB::raw('ROUND(SUM(montant_paie),2) as TotalPaie'))
         ->where([
            ['tvente_paiement_commande.date_paie','>=', $date1],
            ['tvente_paiement_commande.date_paie','<=', $date2],
            ['refFournisseur','=', $refFournisseur]
        ])    
         ->first(); 
         $output='';
         if ($data2) 
         {                                
            $totalPaie=$data2->TotalPaie;
                           
         }

         $nom_banque='';
         $numero_ssouscompte='';

         $data3 = DB::table('tvente_fournisseur')
         ->select('id','refCategorieFss','noms','contact','mail','adresse','author')
         ->where([
            ['tvente_fournisseur.id','=', $refFournisseur]
        ])      
        ->first();      
        $output='';
        if ($data3) 
        {
            $nom_banque=$data3->noms;
            $numero_ssouscompte=$data3->contact;                   
        }



           

        $output='<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Transitional//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd">
        <!-- saved from url=(0016)http://localhost -->
        <html>
        <head>
            <title>rpt_RapportPaiement</title>
            <meta HTTP-EQUIV="Content-Type" CONTENT="text/html; charset=utf-8"/>
            <style type="text/css">
                .csB6F858D0 {color:#000000;background-color:#D6E5F4;border-left-style: none;border-top-style: none;border-right-style: none;border-bottom-style: none;font-family:Times New Roman; font-size:24px; font-weight:bold; font-style:normal; padding-left:2px;padding-right:2px;}
                .cs49AA1D99 {color:#000000;background-color:#E0E0E0;border-left:#000000 1px solid;border-top:#000000 1px solid;border-right:#000000 1px solid;border-bottom:#000000 1px solid;font-family:Times New Roman; font-size:13px; font-weight:bold; font-style:normal; }
                .cs3DB3E5A1 {color:#000000;background-color:#E0E0E0;border-left-style: none;border-top:#000000 1px solid;border-right:#000000 1px solid;border-bottom:#000000 1px solid;font-family:Times New Roman; font-size:11px; font-weight:bold; font-style:normal; }
                .cs691A15EF {color:#000000;background-color:#E0E0E0;border-left-style: none;border-top:#000000 1px solid;border-right-style: none;border-bottom:#000000 1px solid;font-family:Times New Roman; font-size:11px; font-weight:bold; font-style:normal; }
                .csEAC52FCD {color:#000000;background-color:#E0E0E0;border-left-style: none;border-top:#000000 1px solid;border-right-style: none;border-bottom:#000000 1px solid;font-family:Times New Roman; font-size:13px; font-weight:bold; font-style:normal; }
                .cs56F73198 {color:#000000;background-color:transparent;border-left:#000000 1px solid;border-top:#000000 1px solid;border-right:#000000 1px solid;border-bottom:#000000 1px solid;font-family:Times New Roman; font-size:16px; font-weight:normal; font-style:normal; padding-left:2px;}
                .cs3B0DD49A {color:#000000;background-color:transparent;border-left-style: none;border-top:#000000 1px solid;border-right:#000000 1px solid;border-bottom:#000000 1px solid;font-family:Times New Roman; font-size:11px; font-weight:normal; font-style:normal; }
                .cs803D2C52 {color:#000000;background-color:transparent;border-left-style: none;border-top:#000000 1px solid;border-right-style: none;border-bottom:#000000 1px solid;font-family:Times New Roman; font-size:11px; font-weight:normal; font-style:normal; }
                .cs612ED82F {color:#000000;background-color:transparent;border-left-style: none;border-top-style: none;border-right-style: none;border-bottom-style: none;font-family:Times New Roman; font-size:12px; font-weight:bold; font-style:normal; padding-left:2px;}
                .csFFC1C457 {color:#000000;background-color:transparent;border-left-style: none;border-top-style: none;border-right-style: none;border-bottom-style: none;font-family:Times New Roman; font-size:12px; font-weight:normal; font-style:normal; padding-left:2px;}
                .cs101A94F7 {color:#000000;background-color:transparent;border-left-style: none;border-top-style: none;border-right-style: none;border-bottom-style: none;font-family:Times New Roman; font-size:13px; font-weight:normal; font-style:normal; }
                .csCE72709D {color:#000000;background-color:transparent;border-left-style: none;border-top-style: none;border-right-style: none;border-bottom-style: none;font-family:Times New Roman; font-size:14px; font-weight:bold; font-style:normal; padding-left:2px;}
                .cs12FE94AA {color:#000000;background-color:transparent;border-left-style: none;border-top-style: none;border-right-style: none;border-bottom-style: none;font-family:Times New Roman; font-size:14px; font-weight:normal; font-style:normal; padding-left:2px;}
                .csFBB219FE {color:#000000;background-color:transparent;border-left-style: none;border-top-style: none;border-right-style: none;border-bottom-style: none;font-family:Times New Roman; font-size:18px; font-weight:bold; font-style:normal; padding-left:2px;}
                .cs739196BC {color:#5C5C5C;background-color:transparent;border-left-style: none;border-top-style: none;border-right-style: none;border-bottom-style: none;font-family:Segoe UI; font-size:11px; font-weight:normal; font-style:normal; }
                .csF7D3565D {height:0px;width:0px;overflow:hidden;font-size:0px;line-height:0px;}
            </style>
        </head>
        <body leftMargin=10 topMargin=10 rightMargin=10 bottomMargin=10 style="background-color:#FFFFFF">
        <table cellpadding="0" cellspacing="0" border="0" style="border-width:0px;empty-cells:show;width:946px;height:383px;position:relative;">
            <tr>
                <td style="width:0px;height:0px;"></td>
                <td style="height:0px;width:10px;"></td>
                <td style="height:0px;width:88px;"></td>
                <td style="height:0px;width:50px;"></td>
                <td style="height:0px;width:71px;"></td>
                <td style="height:0px;width:101px;"></td>
                <td style="height:0px;width:23px;"></td>
                <td style="height:0px;width:66px;"></td>
                <td style="height:0px;width:110px;"></td>
                <td style="height:0px;width:127px;"></td>
                <td style="height:0px;width:89px;"></td>
                <td style="height:0px;width:33px;"></td>
                <td style="height:0px;width:9px;"></td>
                <td style="height:0px;width:55px;"></td>
                <td style="height:0px;width:53px;"></td>
                <td style="height:0px;width:59px;"></td>
                <td style="height:0px;width:2px;"></td>
            </tr>
            <tr style="vertical-align:top;">
                <td style="width:0px;height:23px;"></td>
                <td></td>
                <td></td>
                <td></td>
                <td></td>
                <td></td>
                <td></td>
                <td></td>
                <td></td>
                <td></td>
                <td></td>
            </tr>
            <tr style="vertical-align:top;">
                <td style="width:0px;height:9px;"></td>
                <td></td>
                <td></td>
                <td></td>
                <td></td>
                <td></td>
                <td></td>
                <td></td>
                <td></td>
                <td></td>
                <td></td>
                <td></td>
                <td></td>
                <td></td>
                <td></td>
                <td></td>
                <td></td>
            </tr>
            <tr style="vertical-align:top;">
                <td style="width:0px;height:23px;"></td>
                <td></td>
                <td class="csFBB219FE" colspan="9" style="width:723px;height:23px;line-height:21px;text-align:left;vertical-align:middle;"><nobr>'.$nomEse.'</nobr></td>
                <td></td>
                <td class="cs101A94F7" colspan="4" rowspan="7" style="width:176px;height:144px;text-align:left;vertical-align:top;"><div style="overflow:hidden;width:176px;height:144px;">
                    <img alt="" src="'.$pic2.'" style="width:176px;height:144px;" /></div>
                </td>
                <td></td>
            </tr>
            <tr style="vertical-align:top;">
                <td style="width:0px;height:22px;"></td>
                <td></td>
                <td class="csCE72709D" colspan="9" style="width:723px;height:22px;line-height:15px;text-align:left;vertical-align:middle;">'.$busnessName.'</td>
                <td></td>
                <td></td>
            </tr>
            <tr style="vertical-align:top;">
                <td style="width:0px;height:22px;"></td>
                <td></td>
                <td class="csCE72709D" colspan="9" style="width:723px;height:22px;line-height:15px;text-align:left;vertical-align:middle;"><nobr>RCCM'.$rccEse.'.&nbsp;ID-NAT.'.$idNatEse.'</nobr></td>
                <td></td>
                <td></td>
            </tr>
            <tr style="vertical-align:top;">
                <td style="width:0px;height:22px;"></td>
                <td></td>
                <td class="csFFC1C457" colspan="9" style="width:723px;height:22px;line-height:13px;text-align:left;vertical-align:middle;">'.$adresseEse.'</td>
                <td></td>
                <td></td>
            </tr>
            <tr style="vertical-align:top;">
                <td style="width:0px;height:22px;"></td>
                <td></td>
                <td class="csFFC1C457" colspan="9" style="width:723px;height:22px;line-height:13px;text-align:left;vertical-align:middle;"><nobr>Email&nbsp;:&nbsp;'.$emailEse.'</nobr></td>
                <td></td>
                <td></td>
            </tr>
            <tr style="vertical-align:top;">
                <td style="width:0px;height:22px;"></td>
                <td></td>
                <td class="csFFC1C457" colspan="9" style="width:723px;height:22px;line-height:13px;text-align:left;vertical-align:middle;"><nobr>Site&nbsp;web&nbsp;:&nbsp;'.$siteEse.'</nobr></td>
                <td></td>
                <td></td>
            </tr>
            <tr style="vertical-align:top;">
                <td style="width:0px;height:11px;"></td>
                <td></td>
                <td class="cs612ED82F" colspan="9" rowspan="2" style="width:723px;height:23px;line-height:13px;text-align:left;vertical-align:middle;"><nobr>T&#233;l&#233;phone&nbsp;:&nbsp;'.$Tel1Ese.'&nbsp;&nbsp;24h/24</nobr></td>
                <td></td>
                <td></td>
            </tr>
            <tr style="vertical-align:top;">
                <td style="width:0px;height:12px;"></td>
                <td></td>
                <td></td>
                <td></td>
                <td></td>
                <td></td>
                <td></td>
                <td></td>
            </tr>
            <tr style="vertical-align:top;">
                <td style="width:0px;height:8px;"></td>
                <td></td>
                <td></td>
                <td></td>
                <td></td>
                <td></td>
                <td></td>
                <td></td>
                <td></td>
                <td></td>
                <td></td>
                <td></td>
                <td></td>
                <td></td>
                <td></td>
                <td></td>
                <td></td>
            </tr>
            <tr style="vertical-align:top;">
                <td style="width:0px;height:32px;"></td>
                <td></td>
                <td></td>
                <td></td>
                <td class="csB6F858D0" colspan="9" style="width:625px;height:32px;line-height:28px;text-align:center;vertical-align:middle;"><nobr>RAPPORT&nbsp;JOURNALIER&nbsp;DES&nbsp;PAIEMENTS</nobr></td>
                <td></td>
                <td></td>
                <td></td>
                <td></td>
            </tr>
            <tr style="vertical-align:top;">
                <td style="width:0px;height:19px;"></td>
                <td></td>
                <td></td>
                <td></td>
                <td></td>
                <td></td>
                <td></td>
                <td></td>
                <td></td>
                <td></td>
                <td></td>
                <td></td>
                <td></td>
                <td></td>
                <td></td>
                <td></td>
                <td></td>
            </tr>
            <tr style="vertical-align:top;">
                <td style="width:0px;height:23px;"></td>
                <td></td>
                <td class="cs56F73198" colspan="5" style="width:329px;height:21px;line-height:18px;text-align:left;vertical-align:top;"><nobr>&nbsp;PERIODE&nbsp;:&nbsp;&nbsp;Du&nbsp;&nbsp;'.$date1.'&nbsp;&nbsp;au&nbsp;'.$date2.'</nobr></td>
                <td class="cs56F73198" colspan="9" style="width:597px;height:21px;line-height:18px;text-align:left;vertical-align:top;"><nobr>'.$nom_banque.'  : '.$numero_ssouscompte.'</nobr></td>
                <td></td>
            </tr>
            <tr style="vertical-align:top;">
                <td style="width:0px;height:9px;"></td>
                <td></td>
                <td></td>
                <td></td>
                <td></td>
                <td></td>
                <td></td>
                <td></td>
                <td></td>
                <td></td>
                <td></td>
                <td></td>
                <td></td>
                <td></td>
                <td></td>
                <td></td>
                <td></td>
            </tr>
            <tr style="vertical-align:top;">
                <td style="width:0px;height:24px;"></td>
                <td></td>
                <td class="cs3DB3E5A1" style="width:87px;height:22px;line-height:12px;text-align:center;vertical-align:middle;"><nobr>DATE</nobr></td>
                <td class="cs3DB3E5A1" colspan="2" style="width:120px;height:22px;line-height:12px;text-align:center;vertical-align:middle;"><nobr>AGENT</nobr></td>
                <td class="cs3DB3E5A1" style="width:100px;height:22px;line-height:12px;text-align:center;vertical-align:middle;"><nobr>N&#176;&nbsp;PAIEMENT</nobr></td>
                <td class="cs3DB3E5A1" colspan="3" style="width:198px;height:22px;line-height:12px;text-align:center;vertical-align:middle;"><nobr>FOURNISSEUR</nobr></td>
                <td class="cs3DB3E5A1" style="width:126px;height:22px;line-height:12px;text-align:center;vertical-align:middle;"><nobr>LIBELLE</nobr></td>
                <td class="cs3DB3E5A1" style="width:88px;height:22px;line-height:12px;text-align:center;vertical-align:middle;"><nobr>N&#176;&nbsp;FACTURE</nobr></td>
                <td class="cs3DB3E5A1" colspan="3" style="width:96px;height:22px;line-height:12px;text-align:center;vertical-align:middle;"><nobr>MONTANT($)</nobr></td>
                <td class="cs3DB3E5A1" style="width:52px;height:22px;line-height:12px;text-align:center;vertical-align:middle;"><nobr>TAUX</nobr></td>
                <td class="cs691A15EF" colspan="2" style="width:61px;height:22px;line-height:12px;text-align:center;vertical-align:middle;"><nobr>COMPTE</nobr></td>
            </tr>
            ';
        
                    $output .= $this->showPaiementFacturationCommande_Fournisseur($date1, $date2,$refFournisseur); 
        
                    $output.='
            <tr style="vertical-align:top;">
                <td style="width:0px;height:24px;"></td>
                <td></td>
                <td></td>
                <td></td>
                <td></td>
                <td></td>
                <td></td>
                <td></td>
                <td></td>
                <td class="cs49AA1D99" colspan="2" style="width:214px;height:22px;line-height:15px;text-align:center;vertical-align:middle;"><nobr>TOTAL&nbsp;($)&nbsp;:</nobr></td>
                <td class="csEAC52FCD" colspan="5" style="width:209px;height:22px;line-height:15px;text-align:center;vertical-align:middle;"><nobr>'.$totalPaie.' $</nobr></td>
                <td></td>
            </tr>
            <tr style="vertical-align:top;">
                <td style="width:0px;height:10px;"></td>
                <td></td>
                <td></td>
                <td></td>
                <td></td>
                <td></td>
                <td></td>
                <td></td>
                <td></td>
                <td></td>
                <td></td>
                <td></td>
                <td></td>
                <td></td>
                <td></td>
                <td></td>
                <td></td>
            </tr>
            <tr style="vertical-align:top;">
                <td style="width:0px;height:22px;"></td>
                <td></td>
                <td class="cs12FE94AA" colspan="3" style="width:207px;height:22px;line-height:16px;text-align:left;vertical-align:top;"><nobr>Fait&nbsp;&#224;&nbsp;Goma&nbsp;le&nbsp;&nbsp;'.date('Y-m-d').'</nobr></td>
                <td></td>
                <td></td>
                <td></td>
                <td></td>
                <td></td>
                <td></td>
                <td></td>
                <td></td>
                <td></td>
                <td></td>
                <td></td>
                <td></td>
            </tr>
        </table>
        </body>
        </html>';  
       
        return $output; 

}
function showPaiementFacturationCommande_Fournisseur($date1, $date2,$refFournisseur)
{
        $data = DB::table('tvente_paiement_commande')
        ->join('tvente_entete_requisition','tvente_entete_requisition.id','=','tvente_paiement_commande.refCommande')
        ->join('tvente_entete_paiecommande','tvente_entete_paiecommande.id','=','tvente_paiement_commande.refEntetepaie')
        ->join('tvente_module','tvente_module.id','=','tvente_entete_requisition.module_id')
        ->join('tvente_services','tvente_services.id','=','tvente_entete_requisition.refService')
        ->join('tvente_fournisseur','tvente_fournisseur.id','=','tvente_entete_requisition.refFournisseur')
        ->join('tvente_categorie_fournisseur','tvente_categorie_fournisseur.id','=','tvente_fournisseur.refCategorieFss')
        ->join('tfin_ssouscompte as comptefss','comptefss.id','=','tvente_categorie_fournisseur.compte_fss_bl')
        ->join('tconf_banque' , 'tconf_banque.id','=','tvente_paiement_commande.refBanque')
        ->join('tfin_ssouscompte as compteBanque','compteBanque.id','=','tconf_banque.refSscompte')
    
        ->select('tvente_paiement_commande.id','tvente_entete_paiecommande.code','refEntetepaie','refCommande','refBanque',
        'montant_paie','tvente_paiement_commande.devise','tvente_paiement_commande.taux',
        'modepaie','libellepaie','numeroBordereau','tvente_paiement_commande.author',
        'tvente_paiement_commande.refUser','tvente_paiement_commande.active','tvente_paiement_commande.created_at',
        "tvente_module.nom_module","tvente_services.nom_service",
        'refFournisseur','tvente_entete_paiecommande.module_id as module_idPaie',
        'tvente_entete_paiecommande.refService as refServicePaie','dateCmd','libelle','niveau1','niveaumax',
        'montant','paie',"tvente_fournisseur.noms","tvente_fournisseur.contact","tvente_fournisseur.mail",
        "tvente_fournisseur.adresse",'refCategorieFss',"tvente_categorie_fournisseur.nom_categoriefss",
        "compte_fss_bl",'comptefss.refSousCompte as refSousCompteFss',
        'comptefss.nom_ssouscompte as nom_ssouscompteFss','comptefss.numero_ssouscompte as numero_ssouscompteFss',
        'date_entete_paie',    
        "tconf_banque.nom_banque","tconf_banque.numerocompte",'tconf_banque.nom_mode',
        "tconf_banque.refSscompte as refSscompteBanque"
        ,'compteBanque.refSousCompte as refSousCompteBanque',
        'compteBanque.nom_ssouscompte as nom_ssouscompteBanque',
        'compteBanque.numero_ssouscompte as numero_ssouscompteBanque')
        ->selectRaw('((montant_paie)/tvente_paiement_commande.taux) as montant_paieFC')
        ->selectRaw('CONCAT("R",YEAR(date_paie),"",MONTH(date_paie),"00",tvente_paiement_commande.id) as codeRecu')
        ->selectRaw('ROUND((IFNULL(paie,0)),1) as totalPaie')
        ->selectRaw('CONCAT("F",YEAR(dateCmd),"",MONTH(dateCmd),"00",tvente_entete_requisition.id) as codeFacture')
        ->selectRaw("DATE_FORMAT(tvente_paiement_commande.date_paie,'%d/%M/%Y') as date_paie")
        ->where([
           ['tvente_paiement_commande.date_paie','>=', $date1],
           ['tvente_paiement_commande.date_paie','<=', $date2],
           ['tvente_entete_requisition.refFournisseur','=', $refFournisseur],
       ])
       ->orderBy("tvente_paiement_commande.created_at", "asc")
       ->get();
       $output='';

    foreach ($data as $row) 
    {
        $output .='
                <tr style="vertical-align:top;">
                <td style="width:0px;height:24px;"></td>
                <td></td>
                <td class="cs3B0DD49A" style="width:87px;height:22px;line-height:12px;text-align:center;vertical-align:middle;">'.$row->date_paie.'</td>
                <td class="cs3B0DD49A" colspan="2" style="width:120px;height:22px;line-height:12px;text-align:left;vertical-align:middle;">'.$row->author.'</td>
                <td class="cs3B0DD49A" style="width:100px;height:22px;line-height:12px;text-align:center;vertical-align:middle;">'.$row->codeRecu.'</td>
                <td class="cs3B0DD49A" colspan="3" style="width:198px;height:22px;line-height:12px;text-align:left;vertical-align:middle;">'.$row->noms.'</td>
                <td class="cs3B0DD49A" style="width:126px;height:22px;line-height:12px;text-align:center;vertical-align:middle;">'.$row->codeFacture.'&nbsp;:&nbsp;'.$row->noms.'</td>
                <td class="cs3B0DD49A" style="width:88px;height:22px;line-height:12px;text-align:center;vertical-align:middle;">'.$row->codeFacture.'</td>
                <td class="cs3B0DD49A" colspan="3" style="width:96px;height:22px;line-height:12px;text-align:center;vertical-align:middle;">'.$row->montant_paie.'$</td>
                <td class="cs3B0DD49A" style="width:52px;height:22px;line-height:12px;text-align:center;vertical-align:middle;">'.$row->taux.'</td>
                <td class="cs803D2C52" style="width:59px;height:22px;line-height:12px;text-align:center;vertical-align:middle;">'.$row->numero_ssouscompteBanque.'</td>
                <td></td>
            </tr>
        '; 
           
   
    }

    return $output;

}


//====================================================================================================================
//======================  ENTREE ET COMMANDE PAR PRODUIT ==================================================================




//==================== RAPPORT JOURNALIER DES ENTREES / FOURNISSEUR ===========================================================================

public function fetch_rapport_detailentree_date_fss(Request $request)
{
    //refFournisseur

    if ($request->get('date1') && $request->get('date2') && $request->get('refFournisseur')) {
        // code...
        $date1 = $request->get('date1');
        $date2 = $request->get('date2');
        $refFournisseur = $request->get('refFournisseur');

        $html ='<html><head><meta http-equiv="Content-Type" content="text/html; charset=utf-8"/>';
        $html .= $this->printRapportDetailEntreeFss($date1, $date2, $refFournisseur);       
        $html .='<script>window.print()</script>';

        echo($html); 
        
        // $html = $this->printRapportDetailEntree($date1, $date2);
        // $pdf = \App::make('dompdf.wrapper');
        // $pdf->loadHTML($html)->setPaper('a4', 'landscape');
        // return $pdf->stream();            

    } else {
        // code...
    }
    
    
}
function printRapportDetailEntreeFss($date1, $date2, $refFournisseur)
{

         //Info Entreprise
         $nomEse='';
         $adresseEse='';
         $Tel1Ese='';
         $Tel2Ese='';
         $siteEse='';
         $emailEse='';
         $idNatEse='';
         $numImpotEse='';
         $rccEse='';
         $siege='';
         $busnessName='';
         $pic='';
         $pic2 = $this->displayImg("fichier", 'logo.png');
         $logo='';
 
         $data1 = DB::table('entreprises')
         ->join('secteurs','secteurs.id','=','entreprises.idsecteur')
         ->join('forme_juridiques','forme_juridiques.id','=','entreprises.idforme')
 
         ->join('pays','pays.id','=','entreprises.idPays')
         ->join('provinces','provinces.id','=','entreprises.idProvince')
         ->join('users','users.id','=','entreprises.ceo')        
         ->select('entreprises.id as id','entreprises.id as idEntreprise',
         'entreprises.ceo','entreprises.nomEntreprise','entreprises.descriptionEntreprise',
         'entreprises.emailEntreprise','entreprises.adresseEntreprise',
         'entreprises.telephoneEntreprise','entreprises.solutionEntreprise','entreprises.idsecteur',
         'entreprises.idforme','entreprises.etat',
         'entreprises.idPays','entreprises.idProvince','entreprises.edition','entreprises.facebook',
         'entreprises.linkedin','entreprises.twitter','entreprises.siteweb','entreprises.rccm',
         'entreprises.invPersonnel','entreprises.invHub','entreprises.invRecherche',
         'entreprises.chiffreAffaire','entreprises.nbremploye','entreprises.slug','entreprises.logo',
             //forme
             'forme_juridiques.nomForme','secteurs.nomSecteur',
             //users
             'users.name','users.email','users.avatar','users.telephone','users.adresse',
             //
             'provinces.nomProvince','pays.nomPays', 'entreprises.created_at')
         ->get();
         $output='';
         foreach ($data1 as $row) 
         {                                
             $nomEse=$row->nomEntreprise;
             $adresseEse=$row->adresseEntreprise;
             $Tel1Ese=$row->telephoneEntreprise;
             $Tel2Ese=$row->telephone;
             $siteEse=$row->siteweb;
             $emailEse=$row->emailEntreprise;
             $idNatEse=$row->rccm;
             $numImpotEse=$row->rccm;
             $busnessName=$row->nomSecteur;
             $rccmEse=$row->rccm;
             $pic = $this->displayImg("fichier", 'logo.png');
             $siege=$row->nomForme;         
         }
 

         $totalFact=0;
                 
         // 
         $data2 =   DB::table('tvente_detail_entree')
         ->join('tvente_produit','tvente_produit.id','=','tvente_detail_entree.refProduit')
         ->join('tvente_categorie_produit','tvente_categorie_produit.id','=','tvente_produit.refCategorie')
         ->join('tvente_entete_entree','tvente_entete_entree.id','=','tvente_detail_entree.refEnteteEntree')
         ->join('tvente_fournisseur','tvente_fournisseur.id','=','tvente_entete_entree.refFournisseur')
 
         ->select(DB::raw('ROUND(SUM(qteEntree*puEntree),0) as TotalFacture'))
         ->where([
            ['dateEntree','>=', $date1],
            ['dateEntree','<=', $date2],
            ['refFournisseur','=', $refFournisseur]
        ])    
         ->get(); 
         $output='';
         foreach ($data2 as $row) 
         {                                
            $totalFact=$row->TotalFacture;                           
         }

         $noms = '';
         $data3 =   DB::table('tvente_detail_entree')
         ->join('tvente_produit','tvente_produit.id','=','tvente_detail_entree.refProduit')
         ->join('tvente_categorie_produit','tvente_categorie_produit.id','=','tvente_produit.refCategorie')
         ->join('tvente_entete_entree','tvente_entete_entree.id','=','tvente_detail_entree.refEnteteEntree')
         ->join('tvente_fournisseur','tvente_fournisseur.id','=','tvente_entete_entree.refFournisseur')
 
         ->select('tvente_produit.designation as nom_produit','tvente_fournisseur.noms')
         ->where([
            ['dateEntree','>=', $date1],
            ['dateEntree','<=', $date2],
            ['refFournisseur','=', $refFournisseur]
        ])    
         ->get(); 
         $output='';
         foreach ($data3 as $row) 
         {
            $noms=$row->noms;               
         }

           

        $output='<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Transitional//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd">
        <!-- saved from url=(0016)http://localhost -->
        <html>
        <head>
            <title>rpt_Rapportdetailfacture</title>
            <meta HTTP-EQUIV="Content-Type" CONTENT="text/html; charset=utf-8"/>
            <style type="text/css">
                .csB6F858D0 {color:#000000;background-color:#D6E5F4;border-left-style: none;border-top-style: none;border-right-style: none;border-bottom-style: none;font-family:Times New Roman; font-size:24px; font-weight:bold; font-style:normal; padding-left:2px;padding-right:2px;}
                .cs49AA1D99 {color:#000000;background-color:#E0E0E0;border-left:#000000 1px solid;border-top:#000000 1px solid;border-right:#000000 1px solid;border-bottom:#000000 1px solid;font-family:Times New Roman; font-size:13px; font-weight:bold; font-style:normal; }
                .cs9FE9304F {color:#000000;background-color:#E0E0E0;border-left-style: none;border-top:#000000 1px solid;border-right:#000000 1px solid;border-bottom:#000000 1px solid;font-family:Times New Roman; font-size:13px; font-weight:bold; font-style:normal; }
                .csEAC52FCD {color:#000000;background-color:#E0E0E0;border-left-style: none;border-top:#000000 1px solid;border-right-style: none;border-bottom:#000000 1px solid;font-family:Times New Roman; font-size:13px; font-weight:bold; font-style:normal; }
                .cs56F73198 {color:#000000;background-color:transparent;border-left:#000000 1px solid;border-top:#000000 1px solid;border-right:#000000 1px solid;border-bottom:#000000 1px solid;font-family:Times New Roman; font-size:16px; font-weight:normal; font-style:normal; padding-left:2px;}
                .cs6E02D7D2 {color:#000000;background-color:transparent;border-left-style: none;border-top:#000000 1px solid;border-right:#000000 1px solid;border-bottom:#000000 1px solid;font-family:Times New Roman; font-size:14px; font-weight:normal; font-style:normal; }
                .cs6C28398D {color:#000000;background-color:transparent;border-left-style: none;border-top:#000000 1px solid;border-right-style: none;border-bottom:#000000 1px solid;font-family:Times New Roman; font-size:14px; font-weight:normal; font-style:normal; }
                .cs612ED82F {color:#000000;background-color:transparent;border-left-style: none;border-top-style: none;border-right-style: none;border-bottom-style: none;font-family:Times New Roman; font-size:12px; font-weight:bold; font-style:normal; padding-left:2px;}
                .csFFC1C457 {color:#000000;background-color:transparent;border-left-style: none;border-top-style: none;border-right-style: none;border-bottom-style: none;font-family:Times New Roman; font-size:12px; font-weight:normal; font-style:normal; padding-left:2px;}
                .cs101A94F7 {color:#000000;background-color:transparent;border-left-style: none;border-top-style: none;border-right-style: none;border-bottom-style: none;font-family:Times New Roman; font-size:13px; font-weight:normal; font-style:normal; }
                .csCE72709D {color:#000000;background-color:transparent;border-left-style: none;border-top-style: none;border-right-style: none;border-bottom-style: none;font-family:Times New Roman; font-size:14px; font-weight:bold; font-style:normal; padding-left:2px;}
                .cs12FE94AA {color:#000000;background-color:transparent;border-left-style: none;border-top-style: none;border-right-style: none;border-bottom-style: none;font-family:Times New Roman; font-size:14px; font-weight:normal; font-style:normal; padding-left:2px;}
                .csFBB219FE {color:#000000;background-color:transparent;border-left-style: none;border-top-style: none;border-right-style: none;border-bottom-style: none;font-family:Times New Roman; font-size:18px; font-weight:bold; font-style:normal; padding-left:2px;}
                .cs739196BC {color:#5C5C5C;background-color:transparent;border-left-style: none;border-top-style: none;border-right-style: none;border-bottom-style: none;font-family:Segoe UI; font-size:11px; font-weight:normal; font-style:normal; }
                .csF7D3565D {height:0px;width:0px;overflow:hidden;font-size:0px;line-height:0px;}
            </style>
        </head>
        <body leftMargin=10 topMargin=10 rightMargin=10 bottomMargin=10 style="background-color:#FFFFFF">
        <table cellpadding="0" cellspacing="0" border="0" style="border-width:0px;empty-cells:show;width:909px;height:383px;position:relative;">
            <tr>
                <td style="width:0px;height:0px;"></td>
                <td style="height:0px;width:10px;"></td>
                <td style="height:0px;width:102px;"></td>
                <td style="height:0px;width:36px;"></td>
                <td style="height:0px;width:71px;"></td>
                <td style="height:0px;width:124px;"></td>
                <td style="height:0px;width:66px;"></td>
                <td style="height:0px;width:42px;"></td>
                <td style="height:0px;width:179px;"></td>
                <td style="height:0px;width:64px;"></td>
                <td style="height:0px;width:28px;"></td>
                <td style="height:0px;width:2px;"></td>
                <td style="height:0px;width:53px;"></td>
                <td style="height:0px;width:10px;"></td>
                <td style="height:0px;width:112px;"></td>
                <td style="height:0px;width:10px;"></td>
            </tr>
            <tr style="vertical-align:top;">
                <td style="width:0px;height:23px;"></td>
                <td></td>
                <td></td>
                <td></td>
                <td></td>
                <td></td>
                <td></td>
                <td></td>
                <td></td>
                <td></td>
                <td></td>
            </tr>
            <tr style="vertical-align:top;">
                <td style="width:0px;height:9px;"></td>
                <td></td>
                <td></td>
                <td></td>
                <td></td>
                <td></td>
                <td></td>
                <td></td>
                <td></td>
                <td></td>
                <td></td>
                <td></td>
                <td></td>
                <td></td>
                <td></td>
                <td></td>
            </tr>
            <tr style="vertical-align:top;">
                <td style="width:0px;height:1px;"></td>
                <td></td>
                <td class="csFBB219FE" colspan="8" rowspan="2" style="width:682px;height:23px;line-height:21px;text-align:left;vertical-align:middle;"><nobr>'.$nomEse.'</nobr></td>
                <td></td>
                <td></td>
                <td></td>
                <td></td>
                <td></td>
                <td></td>
            </tr>
            <tr style="vertical-align:top;">
                <td style="width:0px;height:22px;"></td>
                <td></td>
                <td></td>
                <td></td>
                <td class="cs101A94F7" colspan="3" rowspan="7" style="width:175px;height:144px;text-align:left;vertical-align:top;"><div style="overflow:hidden;width:175px;height:144px;">
                    <!--[if lt IE 7]><img alt="" src="'.$pic2.'" style="width:175px;height:144px;filter:progid:DXImageTransform.Microsoft.AlphaImageLoader(src="",sizingMethod="");" /><div style="display:none"><![endif]--><img alt="" src="'.$pic2.'" style="width:175px;height:144px;" /><!--[if lt IE 7]></div><![endif]--></div>
                </td>
                <td></td>
            </tr>
            <tr style="vertical-align:top;">
                <td style="width:0px;height:22px;"></td>
                <td></td>
                <td class="csCE72709D" colspan="8" style="width:682px;height:22px;line-height:15px;text-align:left;vertical-align:middle;"><nobr>'.$busnessName.'</nobr></td>
                <td></td>
                <td></td>
                <td></td>
            </tr>
            <tr style="vertical-align:top;">
                <td style="width:0px;height:22px;"></td>
                <td></td>
                <td class="csCE72709D" colspan="8" style="width:682px;height:22px;line-height:15px;text-align:left;vertical-align:middle;"><nobr>RCCM'.$rccEse.'.&nbsp;ID-NAT.'.$idNatEse.'</nobr></td>
                <td></td>
                <td></td>
                <td></td>
            </tr>
            <tr style="vertical-align:top;">
                <td style="width:0px;height:22px;"></td>
                <td></td>
                <td class="csFFC1C457" colspan="8" style="width:682px;height:22px;line-height:13px;text-align:left;vertical-align:middle;">'.$adresseEse.'</td>
                <td></td>
                <td></td>
                <td></td>
            </tr>
            <tr style="vertical-align:top;">
                <td style="width:0px;height:22px;"></td>
                <td></td>
                <td class="csFFC1C457" colspan="8" style="width:682px;height:22px;line-height:13px;text-align:left;vertical-align:middle;"><nobr>Email&nbsp;:&nbsp;'.$emailEse.'</nobr></td>
                <td></td>
                <td></td>
                <td></td>
            </tr>
            <tr style="vertical-align:top;">
                <td style="width:0px;height:22px;"></td>
                <td></td>
                <td class="csFFC1C457" colspan="8" style="width:682px;height:22px;line-height:13px;text-align:left;vertical-align:middle;"><nobr>Site&nbsp;web&nbsp;:&nbsp;'.$siteEse.'</nobr></td>
                <td></td>
                <td></td>
                <td></td>
            </tr>
            <tr style="vertical-align:top;">
                <td style="width:0px;height:12px;"></td>
                <td></td>
                <td class="cs612ED82F" colspan="8" rowspan="2" style="width:682px;height:23px;line-height:13px;text-align:left;vertical-align:middle;"><nobr>T&#233;l&#233;phone&nbsp;:&nbsp;'.$Tel1Ese.'&nbsp;&nbsp;24h/24</nobr></td>
                <td></td>
                <td></td>
                <td></td>
            </tr>
            <tr style="vertical-align:top;">
                <td style="width:0px;height:11px;"></td>
                <td></td>
                <td></td>
                <td></td>
                <td></td>
                <td></td>
                <td></td>
                <td></td>
            </tr>
            <tr style="vertical-align:top;">
                <td style="width:0px;height:8px;"></td>
                <td></td>
                <td></td>
                <td></td>
                <td></td>
                <td></td>
                <td></td>
                <td></td>
                <td></td>
                <td></td>
                <td></td>
                <td></td>
                <td></td>
                <td></td>
                <td></td>
                <td></td>
            </tr>
            <tr style="vertical-align:top;">
                <td style="width:0px;height:32px;"></td>
                <td></td>
                <td></td>
                <td></td>
                <td class="csB6F858D0" colspan="9" style="width:625px;height:32px;line-height:28px;text-align:center;vertical-align:middle;"><nobr>RAPPORT&nbsp;JOURNALIER&nbsp;DES&nbsp;ENTREES</nobr></td>
                <td></td>
                <td></td>
                <td></td>
            </tr>
            <tr style="vertical-align:top;">
                <td style="width:0px;height:19px;"></td>
                <td></td>
                <td></td>
                <td></td>
                <td></td>
                <td></td>
                <td></td>
                <td></td>
                <td></td>
                <td></td>
                <td></td>
                <td></td>
                <td></td>
                <td></td>
                <td></td>
                <td></td>
            </tr>
            <tr style="vertical-align:top;">
                <td style="width:0px;height:23px;"></td>
                <td></td>
                <td class="cs56F73198" colspan="4" style="width:329px;height:21px;line-height:18px;text-align:left;vertical-align:top;"><nobr>&nbsp;PERIODE&nbsp;:&nbsp;&nbsp;Du&nbsp;&nbsp;'.$date1.'&nbsp;&nbsp;au&nbsp;'.$date2.' : '.$noms.'</nobr></td>
                <td></td>
                <td></td>
                <td></td>
                <td></td>
                <td></td>
                <td></td>
                <td></td>
                <td></td>
                <td></td>
                <td></td>
            </tr>
            <tr style="vertical-align:top;">
                <td style="width:0px;height:9px;"></td>
                <td></td>
                <td></td>
                <td></td>
                <td></td>
                <td></td>
                <td></td>
                <td></td>
                <td></td>
                <td></td>
                <td></td>
                <td></td>
                <td></td>
                <td></td>
                <td></td>
                <td></td>
            </tr>
            <tr style="vertical-align:top;">
                <td style="width:0px;height:24px;"></td>
                <td></td>
                <td class="cs9FE9304F" style="width:101px;height:22px;line-height:15px;text-align:center;vertical-align:middle;"><nobr>N&#176;&nbsp;FACTURE</nobr></td>
                <td class="cs9FE9304F" colspan="3" style="width:230px;height:22px;line-height:15px;text-align:center;vertical-align:middle;"><nobr>FOURNISSEUR</nobr></td>
                <td class="cs9FE9304F" colspan="2" style="width:107px;height:22px;line-height:15px;text-align:center;vertical-align:middle;"><nobr>DATE&nbsp;ENTREE</nobr></td>
                <td class="cs9FE9304F" style="width:178px;height:22px;line-height:15px;text-align:center;vertical-align:middle;"><nobr>ARTICLE</nobr></td>
                <td class="cs9FE9304F" colspan="2" style="width:91px;height:22px;line-height:15px;text-align:center;vertical-align:middle;"><nobr>Qte</nobr></td>
                <td class="cs9FE9304F" colspan="3" style="width:64px;height:22px;line-height:15px;text-align:center;vertical-align:middle;"><nobr>PU(USD)</nobr></td>
                <td class="csEAC52FCD" colspan="2" style="width:122px;height:22px;line-height:15px;text-align:center;vertical-align:middle;"><nobr>PT(USD)</nobr></td>
            </tr>
            ';

            $output .= $this->showDetailEntreeFss($date1,$date2,$refFournisseur); 

            $output.='
            <tr style="vertical-align:top;">
                <td style="width:0px;height:24px;"></td>
                <td></td>
                <td></td>
                <td></td>
                <td></td>
                <td></td>
                <td></td>
                <td></td>
                <td></td>
                <td class="cs49AA1D99" colspan="5" style="width:155px;height:22px;line-height:15px;text-align:center;vertical-align:middle;"><nobr>TOTAL&nbsp;($)&nbsp;:</nobr></td>
                <td class="csEAC52FCD" colspan="2" style="width:122px;height:22px;line-height:15px;text-align:center;vertical-align:middle;">'.$totalFact.' $</td>
            </tr>
            <tr style="vertical-align:top;">
                <td style="width:0px;height:10px;"></td>
                <td></td>
                <td></td>
                <td></td>
                <td></td>
                <td></td>
                <td></td>
                <td></td>
                <td></td>
                <td></td>
                <td></td>
                <td></td>
                <td></td>
                <td></td>
                <td></td>
                <td></td>
            </tr>
            <tr style="vertical-align:top;">
                <td style="width:0px;height:22px;"></td>
                <td></td>
                <td class="cs12FE94AA" colspan="3" style="width:207px;height:22px;line-height:16px;text-align:left;vertical-align:top;"><nobr>Fait&nbsp;&#224;&nbsp;Goma&nbsp;le&nbsp;&nbsp;'.date('Y-m-d').'</nobr></td>
                <td></td>
                <td></td>
                <td></td>
                <td></td>
                <td></td>
                <td></td>
                <td></td>
                <td></td>
                <td></td>
                <td></td>
                <td></td>
            </tr>
        </table>
        </body>
        </html>';  
       
        return $output; 

}
function showDetailEntreeFss($date1,$date2,$refFournisseur)
{
    $data = DB::table('tvente_detail_entree')

    ->join('tvente_entete_entree','tvente_entete_entree.id','=','tvente_detail_entree.refEnteteEntree')
    ->join('tvente_module','tvente_module.id','=','tvente_entete_entree.module_id')
    ->join('tvente_fournisseur','tvente_fournisseur.id','=','tvente_entete_entree.refFournisseur')

    ->join('tvente_services','tvente_services.id','=','tvente_entete_entree.refService')
    ->join('tvente_produit','tvente_produit.id','=','tvente_detail_entree.refProduit')
    ->join('tvente_categorie_produit','tvente_categorie_produit.id','=','tvente_produit.refCategorie')
    
    // ->join('tfin_ssouscompte as compteachat','compteachat.id','=','tvente_categorie_produit.compte_achat')       
    // ->join('tfin_ssouscompte as comptevariation','comptevariation.id','=','tvente_categorie_produit.compte_variationstock')       
    // ->join('tfin_ssouscompte as compteproduit','compteproduit.id','=','tvente_categorie_produit.compte_produit')        
    // ->join('tfin_ssouscompte as comptestockage','comptestockage.id','=','tvente_categorie_produit.compte_stockage')      

    ->select('tvente_detail_entree.id','refEnteteEntree','refProduit','tvente_entete_entree.refService',
    'tvente_detail_entree.compte_achat','tvente_detail_entree.compte_variationstock',
    'tvente_detail_entree.compte_produit','tvente_detail_entree.compte_stockage','puEntree','qteEntree',
    'uniteEntree',
    'puBase','qteBase','tvente_detail_entree.uniteBase','tvente_detail_entree.devise','tvente_detail_entree.taux',
    'montanttva','montantreduction','tvente_detail_entree.active','tvente_detail_entree.author',
    'tvente_detail_entree.refUser','tvente_detail_entree.created_at','tvente_detail_entree.devise',
    'tvente_detail_entree.taux'

    ,'noms','contact','mail','adresse','tvente_entete_entree.code','tvente_entete_entree.refFournisseur',
    'tvente_entete_entree.refRecquisition','tvente_entete_entree.module_id','dateEntree',
    'tvente_entete_entree.libelle','transporteur','niveau1','niveaumax',"tvente_module.nom_module"

    ,'nom_service'

    ,"tvente_produit.designation as designation",'refCategorie','refUniteBase','pu','qte',
    'cmup','Oldcode','Newcode','tvaapplique','estvendable',"tvente_categorie_produit.designation as Categorie"

    // ,'compteachat.refSousCompte as refSousCompteAchat','compteachat.nom_ssouscompte as nom_ssouscompteAchat',
    // 'compteachat.numero_ssouscompte as numero_ssouscompteAchat'
    // ,'comptevariation.refSousCompte as refSousCompteVariation','comptevariation.nom_ssouscompte as nom_ssouscompteVariation',
    // 'comptevariation.numero_ssouscompte as numero_ssouscompteVariation'
    // ,'compteproduit.refSousCompte as refSousCompteProduit','compteproduit.nom_ssouscompte as nom_ssouscompteProduit',
    // 'compteproduit.numero_ssouscompte as numero_ssouscompteProduit'
    // ,'comptestockage.refSousCompte as refSousCompteStockage','comptestockage.nom_ssouscompte as nom_ssouscompteStockage',
    // 'comptestockage.numero_ssouscompte as numero_ssouscompteStockage' 
    )
    ->selectRaw('(((qteEntree) * (puEntree))/tvente_detail_entree.taux) as PTEntreeFC')
    ->selectRaw('(qteBase*puBase) as PTBase')
    ->selectRaw('((qteBase*puBase)/tvente_detail_entree.taux) as PTBaseFC')
    ->selectRaw('(qteEntree*puEntree) as prixTotal')
    ->selectRaw('CONCAT("BE",YEAR(dateEntree),"",MONTH(dateEntree),"00",refEnteteEntree) as codeFacture')
    ->where([
        ['dateEntree','>=', $date1],
        ['dateEntree','<=', $date2],
        ['refFournisseur','=', $refFournisseur]
    ])
    ->orderBy("tvente_detail_entree.created_at", "asc")
    ->get();
    $output='';

    foreach ($data as $row) 
    { 
        $output .='<tr style="vertical-align:top;">
        <td style="width:0px;height:24px;"></td>
        <td></td>
        <td class="cs6E02D7D2" style="width:101px;height:22px;line-height:15px;text-align:center;vertical-align:middle;">'.$row->codeFacture.'</td>
        <td class="cs6E02D7D2" colspan="3" style="width:230px;height:22px;line-height:15px;text-align:left;vertical-align:middle;">'.$row->noms.'</td>
        <td class="cs6E02D7D2" colspan="2" style="width:107px;height:22px;line-height:15px;text-align:center;vertical-align:middle;">'.$row->dateEntree.'</td>
        <td class="cs6E02D7D2" style="width:178px;height:22px;line-height:15px;text-align:left;vertical-align:middle;">'.$row->designation.'</td>
        <td class="cs6E02D7D2" colspan="2" style="width:91px;height:22px;line-height:15px;text-align:center;vertical-align:middle;">'.$row->qteEntree.' ('.$row->uniteEntree.')</td>
        <td class="cs6E02D7D2" colspan="3" style="width:64px;height:22px;line-height:15px;text-align:center;vertical-align:middle;">'.$row->puEntree.'$</td>
        <td class="cs6C28398D" colspan="2" style="width:122px;height:22px;line-height:15px;text-align:center;vertical-align:middle;">'.$row->prixTotal.'$</td>
    </tr>';      
   
    }

    return $output;

}


//==================== RAPPORT JOURNALIER DES REQUISITIONS ===========================================================================

public function fetch_rapport_detailcmd_date_fss(Request $request)
{
    //refFournisseur

    if ($request->get('date1') && $request->get('date2')&& $request->get('refFournisseur')) {
        // code...
        $date1 = $request->get('date1');
        $date2 = $request->get('date2');
        $refFournisseur = $request->get('refFournisseur');

        $html ='<html><head><meta http-equiv="Content-Type" content="text/html; charset=utf-8"/>';
        $html .= $this->printRapportDetailRequisitionFss($date1, $date2, $refFournisseur);       
        $html .='<script>window.print()</script>';

        echo($html);         

    } else {
        // code...
    }
    
    
}
function printRapportDetailRequisitionFss($date1, $date2, $refFournisseur)
{

         //Info Entreprise
         $nomEse='';
         $adresseEse='';
         $Tel1Ese='';
         $Tel2Ese='';
         $siteEse='';
         $emailEse='';
         $idNatEse='';
         $numImpotEse='';
         $rccEse='';
         $siege='';
         $busnessName='';
         $pic='';
         $pic2 = $this->displayImg("fichier", 'logo.png');
         $logo='';
 
         $data1 = DB::table('entreprises')
         ->join('secteurs','secteurs.id','=','entreprises.idsecteur')
         ->join('forme_juridiques','forme_juridiques.id','=','entreprises.idforme')
 
         ->join('pays','pays.id','=','entreprises.idPays')
         ->join('provinces','provinces.id','=','entreprises.idProvince')
         ->join('users','users.id','=','entreprises.ceo')        
         ->select('entreprises.id as id','entreprises.id as idEntreprise',
         'entreprises.ceo','entreprises.nomEntreprise','entreprises.descriptionEntreprise',
         'entreprises.emailEntreprise','entreprises.adresseEntreprise',
         'entreprises.telephoneEntreprise','entreprises.solutionEntreprise','entreprises.idsecteur',
         'entreprises.idforme','entreprises.etat',
         'entreprises.idPays','entreprises.idProvince','entreprises.edition','entreprises.facebook',
         'entreprises.linkedin','entreprises.twitter','entreprises.siteweb','entreprises.rccm',
         'entreprises.invPersonnel','entreprises.invHub','entreprises.invRecherche',
         'entreprises.chiffreAffaire','entreprises.nbremploye','entreprises.slug','entreprises.logo',
             //forme
             'forme_juridiques.nomForme','secteurs.nomSecteur',
             //users
             'users.name','users.email','users.avatar','users.telephone','users.adresse',
             //
             'provinces.nomProvince','pays.nomPays', 'entreprises.created_at')
         ->get();
         $output='';
         foreach ($data1 as $row) 
         {                                
             $nomEse=$row->nomEntreprise;
             $adresseEse=$row->adresseEntreprise;
             $Tel1Ese=$row->telephoneEntreprise;
             $Tel2Ese=$row->telephone;
             $siteEse=$row->siteweb;
             $emailEse=$row->emailEntreprise;
             $idNatEse=$row->rccm;
             $numImpotEse=$row->rccm;
             $busnessName=$row->nomSecteur;
             $rccmEse=$row->rccm;
             $pic = $this->displayImg("fichier", 'logo.png');
             $siege=$row->nomForme;         
         }
 

         $totalFact=0;
                 
         // 
         $data2 =  DB::table('tvente_detail_requisition')         
         ->join('tvente_entete_requisition','tvente_entete_requisition.id','=','tvente_detail_requisition.refEnteteCmd')
         ->select(DB::raw('ROUND(SUM(qteCmd*puCmd),2) as TotalFacture'))
         ->where([
            ['dateCmd','>=', $date1],
            ['dateCmd','<=', $date2],
            ['refFournisseur','=', $refFournisseur]
        ])    
         ->get(); 
         $output='';
         foreach ($data2 as $row) 
         {                                
            $totalFact=$row->TotalFacture;
                           
         }

         $noms = '';
         $data3 =   DB::table('tvente_detail_requisition')
         ->join('tvente_produit','tvente_produit.id','=','tvente_detail_requisition.refProduit')
         ->join('tvente_categorie_produit','tvente_categorie_produit.id','=','tvente_produit.refCategorie')
         ->join('tvente_entete_requisition','tvente_entete_requisition.id','=','tvente_detail_requisition.refEnteteCmd')
         ->join('tvente_fournisseur','tvente_fournisseur.id','=','tvente_entete_requisition.refFournisseur')
 
         ->select('tvente_produit.designation as nom_produit','tvente_fournisseur.noms')
         ->where([
            ['dateCmd','>=', $date1],
            ['dateCmd','<=', $date2],
            ['refFournisseur','=', $refFournisseur]
        ])    
         ->get(); 
         $output='';
         foreach ($data3 as $row) 
         {
            $noms=$row->noms;               
         }

           

        $output='<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Transitional//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd">
        <!-- saved from url=(0016)http://localhost -->
        <html>
        <head>
            <title>rpt_Rapportdetailfacture</title>
            <meta HTTP-EQUIV="Content-Type" CONTENT="text/html; charset=utf-8"/>
            <style type="text/css">
                .csB6F858D0 {color:#000000;background-color:#D6E5F4;border-left-style: none;border-top-style: none;border-right-style: none;border-bottom-style: none;font-family:Times New Roman; font-size:24px; font-weight:bold; font-style:normal; padding-left:2px;padding-right:2px;}
                .cs49AA1D99 {color:#000000;background-color:#E0E0E0;border-left:#000000 1px solid;border-top:#000000 1px solid;border-right:#000000 1px solid;border-bottom:#000000 1px solid;font-family:Times New Roman; font-size:13px; font-weight:bold; font-style:normal; }
                .cs9FE9304F {color:#000000;background-color:#E0E0E0;border-left-style: none;border-top:#000000 1px solid;border-right:#000000 1px solid;border-bottom:#000000 1px solid;font-family:Times New Roman; font-size:13px; font-weight:bold; font-style:normal; }
                .csEAC52FCD {color:#000000;background-color:#E0E0E0;border-left-style: none;border-top:#000000 1px solid;border-right-style: none;border-bottom:#000000 1px solid;font-family:Times New Roman; font-size:13px; font-weight:bold; font-style:normal; }
                .cs56F73198 {color:#000000;background-color:transparent;border-left:#000000 1px solid;border-top:#000000 1px solid;border-right:#000000 1px solid;border-bottom:#000000 1px solid;font-family:Times New Roman; font-size:16px; font-weight:normal; font-style:normal; padding-left:2px;}
                .cs6E02D7D2 {color:#000000;background-color:transparent;border-left-style: none;border-top:#000000 1px solid;border-right:#000000 1px solid;border-bottom:#000000 1px solid;font-family:Times New Roman; font-size:14px; font-weight:normal; font-style:normal; }
                .cs6C28398D {color:#000000;background-color:transparent;border-left-style: none;border-top:#000000 1px solid;border-right-style: none;border-bottom:#000000 1px solid;font-family:Times New Roman; font-size:14px; font-weight:normal; font-style:normal; }
                .cs612ED82F {color:#000000;background-color:transparent;border-left-style: none;border-top-style: none;border-right-style: none;border-bottom-style: none;font-family:Times New Roman; font-size:12px; font-weight:bold; font-style:normal; padding-left:2px;}
                .csFFC1C457 {color:#000000;background-color:transparent;border-left-style: none;border-top-style: none;border-right-style: none;border-bottom-style: none;font-family:Times New Roman; font-size:12px; font-weight:normal; font-style:normal; padding-left:2px;}
                .cs101A94F7 {color:#000000;background-color:transparent;border-left-style: none;border-top-style: none;border-right-style: none;border-bottom-style: none;font-family:Times New Roman; font-size:13px; font-weight:normal; font-style:normal; }
                .csCE72709D {color:#000000;background-color:transparent;border-left-style: none;border-top-style: none;border-right-style: none;border-bottom-style: none;font-family:Times New Roman; font-size:14px; font-weight:bold; font-style:normal; padding-left:2px;}
                .cs12FE94AA {color:#000000;background-color:transparent;border-left-style: none;border-top-style: none;border-right-style: none;border-bottom-style: none;font-family:Times New Roman; font-size:14px; font-weight:normal; font-style:normal; padding-left:2px;}
                .csFBB219FE {color:#000000;background-color:transparent;border-left-style: none;border-top-style: none;border-right-style: none;border-bottom-style: none;font-family:Times New Roman; font-size:18px; font-weight:bold; font-style:normal; padding-left:2px;}
                .cs739196BC {color:#5C5C5C;background-color:transparent;border-left-style: none;border-top-style: none;border-right-style: none;border-bottom-style: none;font-family:Segoe UI; font-size:11px; font-weight:normal; font-style:normal; }
                .csF7D3565D {height:0px;width:0px;overflow:hidden;font-size:0px;line-height:0px;}
            </style>
        </head>
        <body leftMargin=10 topMargin=10 rightMargin=10 bottomMargin=10 style="background-color:#FFFFFF">
        <table cellpadding="0" cellspacing="0" border="0" style="border-width:0px;empty-cells:show;width:909px;height:383px;position:relative;">
            <tr>
                <td style="width:0px;height:0px;"></td>
                <td style="height:0px;width:10px;"></td>
                <td style="height:0px;width:102px;"></td>
                <td style="height:0px;width:36px;"></td>
                <td style="height:0px;width:71px;"></td>
                <td style="height:0px;width:124px;"></td>
                <td style="height:0px;width:66px;"></td>
                <td style="height:0px;width:42px;"></td>
                <td style="height:0px;width:179px;"></td>
                <td style="height:0px;width:64px;"></td>
                <td style="height:0px;width:28px;"></td>
                <td style="height:0px;width:2px;"></td>
                <td style="height:0px;width:53px;"></td>
                <td style="height:0px;width:10px;"></td>
                <td style="height:0px;width:112px;"></td>
                <td style="height:0px;width:10px;"></td>
            </tr>
            <tr style="vertical-align:top;">
                <td style="width:0px;height:23px;"></td>
                <td></td>
                <td></td>
                <td></td>
                <td></td>
                <td></td>
                <td></td>
                <td></td>
                <td></td>
                <td></td>
                <td></td>
            </tr>
            <tr style="vertical-align:top;">
                <td style="width:0px;height:9px;"></td>
                <td></td>
                <td></td>
                <td></td>
                <td></td>
                <td></td>
                <td></td>
                <td></td>
                <td></td>
                <td></td>
                <td></td>
                <td></td>
                <td></td>
                <td></td>
                <td></td>
                <td></td>
            </tr>
            <tr style="vertical-align:top;">
                <td style="width:0px;height:1px;"></td>
                <td></td>
                <td class="csFBB219FE" colspan="8" rowspan="2" style="width:682px;height:23px;line-height:21px;text-align:left;vertical-align:middle;"><nobr>'.$nomEse.'</nobr></td>
                <td></td>
                <td></td>
                <td></td>
                <td></td>
                <td></td>
                <td></td>
            </tr>
            <tr style="vertical-align:top;">
                <td style="width:0px;height:22px;"></td>
                <td></td>
                <td></td>
                <td></td>
                <td class="cs101A94F7" colspan="3" rowspan="7" style="width:175px;height:144px;text-align:left;vertical-align:top;"><div style="overflow:hidden;width:175px;height:144px;">
                    <!--[if lt IE 7]><img alt="" src="'.$pic2.'" style="width:175px;height:144px;filter:progid:DXImageTransform.Microsoft.AlphaImageLoader(src="",sizingMethod="");" /><div style="display:none"><![endif]--><img alt="" src="'.$pic2.'" style="width:175px;height:144px;" /><!--[if lt IE 7]></div><![endif]--></div>
                </td>
                <td></td>
            </tr>
            <tr style="vertical-align:top;">
                <td style="width:0px;height:22px;"></td>
                <td></td>
                <td class="csCE72709D" colspan="8" style="width:682px;height:22px;line-height:15px;text-align:left;vertical-align:middle;"><nobr>'.$busnessName.'</nobr></td>
                <td></td>
                <td></td>
                <td></td>
            </tr>
            <tr style="vertical-align:top;">
                <td style="width:0px;height:22px;"></td>
                <td></td>
                <td class="csCE72709D" colspan="8" style="width:682px;height:22px;line-height:15px;text-align:left;vertical-align:middle;"><nobr>RCCM'.$rccEse.'.&nbsp;ID-NAT.'.$idNatEse.'</nobr></td>
                <td></td>
                <td></td>
                <td></td>
            </tr>
            <tr style="vertical-align:top;">
                <td style="width:0px;height:22px;"></td>
                <td></td>
                <td class="csFFC1C457" colspan="8" style="width:682px;height:22px;line-height:13px;text-align:left;vertical-align:middle;">'.$adresseEse.'</td>
                <td></td>
                <td></td>
                <td></td>
            </tr>
            <tr style="vertical-align:top;">
                <td style="width:0px;height:22px;"></td>
                <td></td>
                <td class="csFFC1C457" colspan="8" style="width:682px;height:22px;line-height:13px;text-align:left;vertical-align:middle;"><nobr>Email&nbsp;:&nbsp;'.$emailEse.'</nobr></td>
                <td></td>
                <td></td>
                <td></td>
            </tr>
            <tr style="vertical-align:top;">
                <td style="width:0px;height:22px;"></td>
                <td></td>
                <td class="csFFC1C457" colspan="8" style="width:682px;height:22px;line-height:13px;text-align:left;vertical-align:middle;"><nobr>Site&nbsp;web&nbsp;:&nbsp;'.$siteEse.'</nobr></td>
                <td></td>
                <td></td>
                <td></td>
            </tr>
            <tr style="vertical-align:top;">
                <td style="width:0px;height:12px;"></td>
                <td></td>
                <td class="cs612ED82F" colspan="8" rowspan="2" style="width:682px;height:23px;line-height:13px;text-align:left;vertical-align:middle;"><nobr>T&#233;l&#233;phone&nbsp;:&nbsp;'.$Tel1Ese.'&nbsp;&nbsp;24h/24</nobr></td>
                <td></td>
                <td></td>
                <td></td>
            </tr>
            <tr style="vertical-align:top;">
                <td style="width:0px;height:11px;"></td>
                <td></td>
                <td></td>
                <td></td>
                <td></td>
                <td></td>
                <td></td>
                <td></td>
            </tr>
            <tr style="vertical-align:top;">
                <td style="width:0px;height:8px;"></td>
                <td></td>
                <td></td>
                <td></td>
                <td></td>
                <td></td>
                <td></td>
                <td></td>
                <td></td>
                <td></td>
                <td></td>
                <td></td>
                <td></td>
                <td></td>
                <td></td>
                <td></td>
            </tr>
            <tr style="vertical-align:top;">
                <td style="width:0px;height:32px;"></td>
                <td></td>
                <td></td>
                <td></td>
                <td class="csB6F858D0" colspan="9" style="width:625px;height:32px;line-height:28px;text-align:center;vertical-align:middle;"><nobr>RAPPORT&nbsp;JOURNALIER&nbsp;DES&nbsp;COMMANDES FSS.</nobr></td>
                <td></td>
                <td></td>
                <td></td>
            </tr>
            <tr style="vertical-align:top;">
                <td style="width:0px;height:19px;"></td>
                <td></td>
                <td></td>
                <td></td>
                <td></td>
                <td></td>
                <td></td>
                <td></td>
                <td></td>
                <td></td>
                <td></td>
                <td></td>
                <td></td>
                <td></td>
                <td></td>
                <td></td>
            </tr>
            <tr style="vertical-align:top;">
                <td style="width:0px;height:23px;"></td>
                <td></td>
                <td class="cs56F73198" colspan="4" style="width:329px;height:21px;line-height:18px;text-align:left;vertical-align:top;"><nobr>&nbsp;PERIODE&nbsp;:&nbsp;&nbsp;Du&nbsp;&nbsp;'.$date1.'&nbsp;&nbsp;au&nbsp;'.$date2.'  : '.$noms.'</nobr></td>
                <td></td>
                <td></td>
                <td></td>
                <td></td>
                <td></td>
                <td></td>
                <td></td>
                <td></td>
                <td></td>
                <td></td>
            </tr>
            <tr style="vertical-align:top;">
                <td style="width:0px;height:9px;"></td>
                <td></td>
                <td></td>
                <td></td>
                <td></td>
                <td></td>
                <td></td>
                <td></td>
                <td></td>
                <td></td>
                <td></td>
                <td></td>
                <td></td>
                <td></td>
                <td></td>
                <td></td>
            </tr>
            <tr style="vertical-align:top;">
                <td style="width:0px;height:24px;"></td>
                <td></td>
                <td class="cs9FE9304F" style="width:101px;height:22px;line-height:15px;text-align:center;vertical-align:middle;"><nobr>N&#176;&nbsp;FACTURE</nobr></td>
                <td class="cs9FE9304F" colspan="3" style="width:230px;height:22px;line-height:15px;text-align:center;vertical-align:middle;"><nobr>FOURNISSEUR</nobr></td>
                <td class="cs9FE9304F" colspan="2" style="width:107px;height:22px;line-height:15px;text-align:center;vertical-align:middle;"><nobr>DATE&nbsp;ENTREE</nobr></td>
                <td class="cs9FE9304F" style="width:178px;height:22px;line-height:15px;text-align:center;vertical-align:middle;"><nobr>ARTICLE</nobr></td>
                <td class="cs9FE9304F" colspan="2" style="width:91px;height:22px;line-height:15px;text-align:center;vertical-align:middle;"><nobr>Qte</nobr></td>
                <td class="cs9FE9304F" colspan="3" style="width:64px;height:22px;line-height:15px;text-align:center;vertical-align:middle;"><nobr>PU(USD)</nobr></td>
                <td class="csEAC52FCD" colspan="2" style="width:122px;height:22px;line-height:15px;text-align:center;vertical-align:middle;"><nobr>PT(USD)</nobr></td>
            </tr>
            ';

            $output .= $this->showDetailRequisitionFss($date1,$date2,$refFournisseur); 

            $output.='
            <tr style="vertical-align:top;">
                <td style="width:0px;height:24px;"></td>
                <td></td>
                <td></td>
                <td></td>
                <td></td>
                <td></td>
                <td></td>
                <td></td>
                <td></td>
                <td class="cs49AA1D99" colspan="5" style="width:155px;height:22px;line-height:15px;text-align:center;vertical-align:middle;"><nobr>TOTAL&nbsp;($)&nbsp;:</nobr></td>
                <td class="csEAC52FCD" colspan="2" style="width:122px;height:22px;line-height:15px;text-align:center;vertical-align:middle;">'.$totalFact.' $</td>
            </tr>
            <tr style="vertical-align:top;">
                <td style="width:0px;height:10px;"></td>
                <td></td>
                <td></td>
                <td></td>
                <td></td>
                <td></td>
                <td></td>
                <td></td>
                <td></td>
                <td></td>
                <td></td>
                <td></td>
                <td></td>
                <td></td>
                <td></td>
                <td></td>
            </tr>
            <tr style="vertical-align:top;">
                <td style="width:0px;height:22px;"></td>
                <td></td>
                <td class="cs12FE94AA" colspan="3" style="width:207px;height:22px;line-height:16px;text-align:left;vertical-align:top;"><nobr>Fait&nbsp;&#224;&nbsp;Goma&nbsp;le&nbsp;&nbsp;'.date('Y-m-d').'</nobr></td>
                <td></td>
                <td></td>
                <td></td>
                <td></td>
                <td></td>
                <td></td>
                <td></td>
                <td></td>
                <td></td>
                <td></td>
                <td></td>
            </tr>
        </table>
        </body>
        </html>';  
       
        return $output; 

}
function showDetailRequisitionFss($date1,$date2,$refFournisseur)
{
    $data = DB::table('tvente_detail_requisition')
    ->join('tfin_ssouscompte as compteachat','compteachat.id','=','tvente_detail_requisition.compte_achat')
    ->join('tfin_ssouscompte as compteproduit','compteproduit.id','=','tvente_detail_requisition.compte_produit')
    ->join('tvente_produit','tvente_produit.id','=','tvente_detail_requisition.refProduit')
    ->join('tvente_categorie_produit','tvente_categorie_produit.id','=','tvente_produit.refCategorie')
    ->join('tvente_entete_requisition','tvente_entete_requisition.id','=','tvente_detail_requisition.refEnteteCmd')
    ->join('tvente_fournisseur','tvente_fournisseur.id','=','tvente_entete_requisition.refFournisseur')
    ->select('tvente_detail_requisition.id','refEnteteCmd','refProduit','tvente_detail_requisition.compte_achat',
    'tvente_detail_requisition.compte_produit','puCmd','qteCmd','uniteCmd','tvente_detail_requisition.puBase',
    'tvente_detail_requisition.qteBase','tvente_detail_requisition.uniteBase','tvente_detail_requisition.devise',
    'tvente_detail_requisition.taux','montanttva','montantreduction','tvente_detail_requisition.active',
    'tvente_detail_requisition.author','tvente_detail_requisition.refUser','tvente_detail_requisition.created_at'
    ,"tvente_produit.designation as designation",'refCategorie','pu','qte',
    'cmup','Oldcode','Newcode','tvaapplique','estvendable',"tvente_categorie_produit.designation as Categorie"
    ,'compteachat.refSousCompte as refSousCompteAchat','compteachat.nom_ssouscompte as nom_ssouscompteAchat',
    'compteachat.numero_ssouscompte as numero_ssouscompteAchat'
    ,'compteproduit.refSousCompte as refSousCompteProduit','compteproduit.nom_ssouscompte as nom_ssouscompteProduit',
    'compteproduit.numero_ssouscompte as numero_ssouscompteProduit','noms','contact','mail','adresse','dateCmd')
    ->selectRaw('(qteCmd*puCmd) as PTCmd')
    ->selectRaw('(qteBase*puBase) as PTBase')
    ->selectRaw('((qteCmd*puCmd)/tvente_detail_requisition.taux) as PTCmdFC')
    ->selectRaw('((qteBase*puBase)/tvente_detail_requisition.taux) as PTBaseFC')
    ->selectRaw('CONCAT("BE",YEAR(dateCmd),"",MONTH(dateCmd),"00",refEnteteCmd) as codeFacture')
    ->where([
        ['dateCmd','>=', $date1],
        ['dateCmd','<=', $date2],
        ['refFournisseur','=', $refFournisseur]
    ])
    ->orderBy("tvente_detail_requisition.created_at", "asc")
    ->get();

    $output='';

    foreach ($data as $row) 
    { 
        $output .='<tr style="vertical-align:top;">
        <td style="width:0px;height:24px;"></td>
        <td></td>
        <td class="cs6E02D7D2" style="width:101px;height:22px;line-height:15px;text-align:center;vertical-align:middle;">'.$row->codeFacture.'</td>
        <td class="cs6E02D7D2" colspan="3" style="width:230px;height:22px;line-height:15px;text-align:left;vertical-align:middle;">'.$row->noms.'</td>
        <td class="cs6E02D7D2" colspan="2" style="width:107px;height:22px;line-height:15px;text-align:center;vertical-align:middle;">'.$row->dateCmd.'</td>
        <td class="cs6E02D7D2" style="width:178px;height:22px;line-height:15px;text-align:left;vertical-align:middle;">'.$row->designation.'</td>
        <td class="cs6E02D7D2" colspan="2" style="width:91px;height:22px;line-height:15px;text-align:center;vertical-align:middle;">'.$row->qteCmd.'</td>
        <td class="cs6E02D7D2" colspan="3" style="width:64px;height:22px;line-height:15px;text-align:center;vertical-align:middle;">'.$row->puCmd.'$</td>
        <td class="cs6C28398D" colspan="2" style="width:122px;height:22px;line-height:15px;text-align:center;vertical-align:middle;">'.$row->PTCmd.'$</td>
    </tr>';     
   
    }

    return $output;

}

//==================== RAPPORT JOURNALIER DES ENTREES / FOURNISSEUR / PRODUIT ===========================================================================

public function fetch_rapport_detailentree_date_fss_produit(Request $request)
{
    //refFournisseur

    if ($request->get('date1') && $request->get('date2') && $request->get('refFournisseur') && $request->get('idProduit')) {
        // code...
        $date1 = $request->get('date1');
        $date2 = $request->get('date2');
        $refFournisseur = $request->get('refFournisseur');
        $idProduit = $request->get('idProduit');

        $html ='<html><head><meta http-equiv="Content-Type" content="text/html; charset=utf-8"/>';
        $html .= $this->printRapportDetailEntreeFssProduit($date1, $date2, $refFournisseur,$idProduit);       
        $html .='<script>window.print()</script>';

        echo($html); 
        
        // $html = $this->printRapportDetailEntree($date1, $date2);
        // $pdf = \App::make('dompdf.wrapper');
        // $pdf->loadHTML($html)->setPaper('a4', 'landscape');
        // return $pdf->stream();            

    } else {
        // code...
    }
    
    
}
function printRapportDetailEntreeFssProduit($date1, $date2, $refFournisseur,$idProduit)
{

         //Info Entreprise
         $nomEse='';
         $adresseEse='';
         $Tel1Ese='';
         $Tel2Ese='';
         $siteEse='';
         $emailEse='';
         $idNatEse='';
         $numImpotEse='';
         $rccEse='';
         $siege='';
         $busnessName='';
         $pic='';
         $pic2 = $this->displayImg("fichier", 'logo.png');
         $logo='';
 
         $data1 = DB::table('entreprises')
         ->join('secteurs','secteurs.id','=','entreprises.idsecteur')
         ->join('forme_juridiques','forme_juridiques.id','=','entreprises.idforme')
 
         ->join('pays','pays.id','=','entreprises.idPays')
         ->join('provinces','provinces.id','=','entreprises.idProvince')
         ->join('users','users.id','=','entreprises.ceo')        
         ->select('entreprises.id as id','entreprises.id as idEntreprise',
         'entreprises.ceo','entreprises.nomEntreprise','entreprises.descriptionEntreprise',
         'entreprises.emailEntreprise','entreprises.adresseEntreprise',
         'entreprises.telephoneEntreprise','entreprises.solutionEntreprise','entreprises.idsecteur',
         'entreprises.idforme','entreprises.etat',
         'entreprises.idPays','entreprises.idProvince','entreprises.edition','entreprises.facebook',
         'entreprises.linkedin','entreprises.twitter','entreprises.siteweb','entreprises.rccm',
         'entreprises.invPersonnel','entreprises.invHub','entreprises.invRecherche',
         'entreprises.chiffreAffaire','entreprises.nbremploye','entreprises.slug','entreprises.logo',
             //forme
             'forme_juridiques.nomForme','secteurs.nomSecteur',
             //users
             'users.name','users.email','users.avatar','users.telephone','users.adresse',
             //
             'provinces.nomProvince','pays.nomPays', 'entreprises.created_at')
         ->get();
         $output='';
         foreach ($data1 as $row) 
         {                                
             $nomEse=$row->nomEntreprise;
             $adresseEse=$row->adresseEntreprise;
             $Tel1Ese=$row->telephoneEntreprise;
             $Tel2Ese=$row->telephone;
             $siteEse=$row->siteweb;
             $emailEse=$row->emailEntreprise;
             $idNatEse=$row->rccm;
             $numImpotEse=$row->rccm;
             $busnessName=$row->nomSecteur;
             $rccmEse=$row->rccm;
             $pic = $this->displayImg("fichier", 'logo.png');
             $siege=$row->nomForme;         
         }
 

         $totalFact=0;        
         // 
         $data2 =   DB::table('tvente_detail_entree')
         ->join('tvente_produit','tvente_produit.id','=','tvente_detail_entree.refProduit')
         ->join('tvente_categorie_produit','tvente_categorie_produit.id','=','tvente_produit.refCategorie')
         ->join('tvente_entete_entree','tvente_entete_entree.id','=','tvente_detail_entree.refEnteteEntree')
         ->join('tvente_fournisseur','tvente_fournisseur.id','=','tvente_entete_entree.refFournisseur')
 
         ->select(DB::raw('ROUND(SUM(qteEntree*puEntree),0) as TotalFacture'))
         ->where([
            ['dateEntree','>=', $date1],
            ['dateEntree','<=', $date2],
            ['refFournisseur','=', $refFournisseur],
            ['refProduit','=', $idProduit]
        ])    
         ->get(); 
         $output='';
         foreach ($data2 as $row) 
         {                                
            $totalFact=$row->TotalFacture;
                           
         }

         $nom_produit='';   
         $noms = '';
         $data3 =   DB::table('tvente_detail_entree')
         ->join('tvente_produit','tvente_produit.id','=','tvente_detail_entree.refProduit')
         ->join('tvente_categorie_produit','tvente_categorie_produit.id','=','tvente_produit.refCategorie')
         ->join('tvente_entete_entree','tvente_entete_entree.id','=','tvente_detail_entree.refEnteteEntree')
         ->join('tvente_fournisseur','tvente_fournisseur.id','=','tvente_entete_entree.refFournisseur')
 
         ->select('tvente_produit.designation as nom_produit','tvente_fournisseur.noms')
         ->where([
            ['dateEntree','>=', $date1],
            ['dateEntree','<=', $date2],
            ['refFournisseur','=', $refFournisseur],
            ['refProduit','=', $idProduit]
        ])    
         ->get(); 
         $output='';
         foreach ($data3 as $row) 
         {                                
            $nom_produit=$row->nom_produit;
            $noms=$row->noms;               
         }

           

        $output='<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Transitional//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd">
        <!-- saved from url=(0016)http://localhost -->
        <html>
        <head>
            <title>rpt_Rapportdetailfacture</title>
            <meta HTTP-EQUIV="Content-Type" CONTENT="text/html; charset=utf-8"/>
            <style type="text/css">
                .csB6F858D0 {color:#000000;background-color:#D6E5F4;border-left-style: none;border-top-style: none;border-right-style: none;border-bottom-style: none;font-family:Times New Roman; font-size:24px; font-weight:bold; font-style:normal; padding-left:2px;padding-right:2px;}
                .cs49AA1D99 {color:#000000;background-color:#E0E0E0;border-left:#000000 1px solid;border-top:#000000 1px solid;border-right:#000000 1px solid;border-bottom:#000000 1px solid;font-family:Times New Roman; font-size:13px; font-weight:bold; font-style:normal; }
                .cs9FE9304F {color:#000000;background-color:#E0E0E0;border-left-style: none;border-top:#000000 1px solid;border-right:#000000 1px solid;border-bottom:#000000 1px solid;font-family:Times New Roman; font-size:13px; font-weight:bold; font-style:normal; }
                .csEAC52FCD {color:#000000;background-color:#E0E0E0;border-left-style: none;border-top:#000000 1px solid;border-right-style: none;border-bottom:#000000 1px solid;font-family:Times New Roman; font-size:13px; font-weight:bold; font-style:normal; }
                .cs56F73198 {color:#000000;background-color:transparent;border-left:#000000 1px solid;border-top:#000000 1px solid;border-right:#000000 1px solid;border-bottom:#000000 1px solid;font-family:Times New Roman; font-size:16px; font-weight:normal; font-style:normal; padding-left:2px;}
                .cs6E02D7D2 {color:#000000;background-color:transparent;border-left-style: none;border-top:#000000 1px solid;border-right:#000000 1px solid;border-bottom:#000000 1px solid;font-family:Times New Roman; font-size:14px; font-weight:normal; font-style:normal; }
                .cs6C28398D {color:#000000;background-color:transparent;border-left-style: none;border-top:#000000 1px solid;border-right-style: none;border-bottom:#000000 1px solid;font-family:Times New Roman; font-size:14px; font-weight:normal; font-style:normal; }
                .cs612ED82F {color:#000000;background-color:transparent;border-left-style: none;border-top-style: none;border-right-style: none;border-bottom-style: none;font-family:Times New Roman; font-size:12px; font-weight:bold; font-style:normal; padding-left:2px;}
                .csFFC1C457 {color:#000000;background-color:transparent;border-left-style: none;border-top-style: none;border-right-style: none;border-bottom-style: none;font-family:Times New Roman; font-size:12px; font-weight:normal; font-style:normal; padding-left:2px;}
                .cs101A94F7 {color:#000000;background-color:transparent;border-left-style: none;border-top-style: none;border-right-style: none;border-bottom-style: none;font-family:Times New Roman; font-size:13px; font-weight:normal; font-style:normal; }
                .csCE72709D {color:#000000;background-color:transparent;border-left-style: none;border-top-style: none;border-right-style: none;border-bottom-style: none;font-family:Times New Roman; font-size:14px; font-weight:bold; font-style:normal; padding-left:2px;}
                .cs12FE94AA {color:#000000;background-color:transparent;border-left-style: none;border-top-style: none;border-right-style: none;border-bottom-style: none;font-family:Times New Roman; font-size:14px; font-weight:normal; font-style:normal; padding-left:2px;}
                .csFBB219FE {color:#000000;background-color:transparent;border-left-style: none;border-top-style: none;border-right-style: none;border-bottom-style: none;font-family:Times New Roman; font-size:18px; font-weight:bold; font-style:normal; padding-left:2px;}
                .cs739196BC {color:#5C5C5C;background-color:transparent;border-left-style: none;border-top-style: none;border-right-style: none;border-bottom-style: none;font-family:Segoe UI; font-size:11px; font-weight:normal; font-style:normal; }
                .csF7D3565D {height:0px;width:0px;overflow:hidden;font-size:0px;line-height:0px;}
            </style>
        </head>
        <body leftMargin=10 topMargin=10 rightMargin=10 bottomMargin=10 style="background-color:#FFFFFF">
        <table cellpadding="0" cellspacing="0" border="0" style="border-width:0px;empty-cells:show;width:909px;height:383px;position:relative;">
            <tr>
                <td style="width:0px;height:0px;"></td>
                <td style="height:0px;width:10px;"></td>
                <td style="height:0px;width:102px;"></td>
                <td style="height:0px;width:36px;"></td>
                <td style="height:0px;width:71px;"></td>
                <td style="height:0px;width:124px;"></td>
                <td style="height:0px;width:66px;"></td>
                <td style="height:0px;width:42px;"></td>
                <td style="height:0px;width:179px;"></td>
                <td style="height:0px;width:64px;"></td>
                <td style="height:0px;width:28px;"></td>
                <td style="height:0px;width:2px;"></td>
                <td style="height:0px;width:53px;"></td>
                <td style="height:0px;width:10px;"></td>
                <td style="height:0px;width:112px;"></td>
                <td style="height:0px;width:10px;"></td>
            </tr>
            <tr style="vertical-align:top;">
                <td style="width:0px;height:23px;"></td>
                <td></td>
                <td></td>
                <td></td>
                <td></td>
                <td></td>
                <td></td>
                <td></td>
                <td></td>
                <td></td>
                <td></td>
            </tr>
            <tr style="vertical-align:top;">
                <td style="width:0px;height:9px;"></td>
                <td></td>
                <td></td>
                <td></td>
                <td></td>
                <td></td>
                <td></td>
                <td></td>
                <td></td>
                <td></td>
                <td></td>
                <td></td>
                <td></td>
                <td></td>
                <td></td>
                <td></td>
            </tr>
            <tr style="vertical-align:top;">
                <td style="width:0px;height:1px;"></td>
                <td></td>
                <td class="csFBB219FE" colspan="8" rowspan="2" style="width:682px;height:23px;line-height:21px;text-align:left;vertical-align:middle;"><nobr>'.$nomEse.'</nobr></td>
                <td></td>
                <td></td>
                <td></td>
                <td></td>
                <td></td>
                <td></td>
            </tr>
            <tr style="vertical-align:top;">
                <td style="width:0px;height:22px;"></td>
                <td></td>
                <td></td>
                <td></td>
                <td class="cs101A94F7" colspan="3" rowspan="7" style="width:175px;height:144px;text-align:left;vertical-align:top;"><div style="overflow:hidden;width:175px;height:144px;">
                    <!--[if lt IE 7]><img alt="" src="'.$pic2.'" style="width:175px;height:144px;filter:progid:DXImageTransform.Microsoft.AlphaImageLoader(src="",sizingMethod="");" /><div style="display:none"><![endif]--><img alt="" src="'.$pic2.'" style="width:175px;height:144px;" /><!--[if lt IE 7]></div><![endif]--></div>
                </td>
                <td></td>
            </tr>
            <tr style="vertical-align:top;">
                <td style="width:0px;height:22px;"></td>
                <td></td>
                <td class="csCE72709D" colspan="8" style="width:682px;height:22px;line-height:15px;text-align:left;vertical-align:middle;"><nobr>'.$busnessName.'</nobr></td>
                <td></td>
                <td></td>
                <td></td>
            </tr>
            <tr style="vertical-align:top;">
                <td style="width:0px;height:22px;"></td>
                <td></td>
                <td class="csCE72709D" colspan="8" style="width:682px;height:22px;line-height:15px;text-align:left;vertical-align:middle;"><nobr>RCCM'.$rccEse.'.&nbsp;ID-NAT.'.$idNatEse.'</nobr></td>
                <td></td>
                <td></td>
                <td></td>
            </tr>
            <tr style="vertical-align:top;">
                <td style="width:0px;height:22px;"></td>
                <td></td>
                <td class="csFFC1C457" colspan="8" style="width:682px;height:22px;line-height:13px;text-align:left;vertical-align:middle;">'.$adresseEse.'</td>
                <td></td>
                <td></td>
                <td></td>
            </tr>
            <tr style="vertical-align:top;">
                <td style="width:0px;height:22px;"></td>
                <td></td>
                <td class="csFFC1C457" colspan="8" style="width:682px;height:22px;line-height:13px;text-align:left;vertical-align:middle;"><nobr>Email&nbsp;:&nbsp;'.$emailEse.'</nobr></td>
                <td></td>
                <td></td>
                <td></td>
            </tr>
            <tr style="vertical-align:top;">
                <td style="width:0px;height:22px;"></td>
                <td></td>
                <td class="csFFC1C457" colspan="8" style="width:682px;height:22px;line-height:13px;text-align:left;vertical-align:middle;"><nobr>Site&nbsp;web&nbsp;:&nbsp;'.$siteEse.'</nobr></td>
                <td></td>
                <td></td>
                <td></td>
            </tr>
            <tr style="vertical-align:top;">
                <td style="width:0px;height:12px;"></td>
                <td></td>
                <td class="cs612ED82F" colspan="8" rowspan="2" style="width:682px;height:23px;line-height:13px;text-align:left;vertical-align:middle;"><nobr>T&#233;l&#233;phone&nbsp;:&nbsp;'.$Tel1Ese.'&nbsp;&nbsp;24h/24</nobr></td>
                <td></td>
                <td></td>
                <td></td>
            </tr>
            <tr style="vertical-align:top;">
                <td style="width:0px;height:11px;"></td>
                <td></td>
                <td></td>
                <td></td>
                <td></td>
                <td></td>
                <td></td>
                <td></td>
            </tr>
            <tr style="vertical-align:top;">
                <td style="width:0px;height:8px;"></td>
                <td></td>
                <td></td>
                <td></td>
                <td></td>
                <td></td>
                <td></td>
                <td></td>
                <td></td>
                <td></td>
                <td></td>
                <td></td>
                <td></td>
                <td></td>
                <td></td>
                <td></td>
            </tr>
            <tr style="vertical-align:top;">
                <td style="width:0px;height:32px;"></td>
                <td></td>
                <td></td>
                <td></td>
                <td class="csB6F858D0" colspan="9" style="width:625px;height:32px;line-height:28px;text-align:center;vertical-align:middle;"><nobr>RAPPORT&nbsp;JOURNALIER&nbsp;DES&nbsp;ENTREES</nobr></td>
                <td></td>
                <td></td>
                <td></td>
            </tr>
            <tr style="vertical-align:top;">
                <td style="width:0px;height:19px;"></td>
                <td></td>
                <td></td>
                <td></td>
                <td></td>
                <td></td>
                <td></td>
                <td></td>
                <td></td>
                <td></td>
                <td></td>
                <td></td>
                <td></td>
                <td></td>
                <td></td>
                <td></td>
            </tr>
            <tr style="vertical-align:top;">
                <td style="width:0px;height:23px;"></td>
                <td></td>
                <td class="cs56F73198" colspan="4" style="width:329px;height:21px;line-height:18px;text-align:left;vertical-align:top;"><nobr>&nbsp;PERIODE&nbsp;:&nbsp;&nbsp;Du&nbsp;&nbsp;'.$date1.'&nbsp;&nbsp;au&nbsp;'.$date2.' : '.$noms.' - '.$nom_produit.'</nobr></td>
                <td></td>
                <td></td>
                <td></td>
                <td></td>
                <td></td>
                <td></td>
                <td></td>
                <td></td>
                <td></td>
                <td></td>
            </tr>
            <tr style="vertical-align:top;">
                <td style="width:0px;height:9px;"></td>
                <td></td>
                <td></td>
                <td></td>
                <td></td>
                <td></td>
                <td></td>
                <td></td>
                <td></td>
                <td></td>
                <td></td>
                <td></td>
                <td></td>
                <td></td>
                <td></td>
                <td></td>
            </tr>
            <tr style="vertical-align:top;">
                <td style="width:0px;height:24px;"></td>
                <td></td>
                <td class="cs9FE9304F" style="width:101px;height:22px;line-height:15px;text-align:center;vertical-align:middle;"><nobr>N&#176;&nbsp;FACTURE</nobr></td>
                <td class="cs9FE9304F" colspan="3" style="width:230px;height:22px;line-height:15px;text-align:center;vertical-align:middle;"><nobr>FOURNISSEUR</nobr></td>
                <td class="cs9FE9304F" colspan="2" style="width:107px;height:22px;line-height:15px;text-align:center;vertical-align:middle;"><nobr>DATE&nbsp;ENTREE</nobr></td>
                <td class="cs9FE9304F" style="width:178px;height:22px;line-height:15px;text-align:center;vertical-align:middle;"><nobr>ARTICLE</nobr></td>
                <td class="cs9FE9304F" colspan="2" style="width:91px;height:22px;line-height:15px;text-align:center;vertical-align:middle;"><nobr>Qte</nobr></td>
                <td class="cs9FE9304F" colspan="3" style="width:64px;height:22px;line-height:15px;text-align:center;vertical-align:middle;"><nobr>PU(USD)</nobr></td>
                <td class="csEAC52FCD" colspan="2" style="width:122px;height:22px;line-height:15px;text-align:center;vertical-align:middle;"><nobr>PT(USD)</nobr></td>
            </tr>
            ';

            $output .= $this->showDetailEntreeFssProduit($date1,$date2,$refFournisseur,$idProduit); 

            $output.='
            <tr style="vertical-align:top;">
                <td style="width:0px;height:24px;"></td>
                <td></td>
                <td></td>
                <td></td>
                <td></td>
                <td></td>
                <td></td>
                <td></td>
                <td></td>
                <td class="cs49AA1D99" colspan="5" style="width:155px;height:22px;line-height:15px;text-align:center;vertical-align:middle;"><nobr>TOTAL&nbsp;($)&nbsp;:</nobr></td>
                <td class="csEAC52FCD" colspan="2" style="width:122px;height:22px;line-height:15px;text-align:center;vertical-align:middle;">'.$totalFact.' $</td>
            </tr>
            <tr style="vertical-align:top;">
                <td style="width:0px;height:10px;"></td>
                <td></td>
                <td></td>
                <td></td>
                <td></td>
                <td></td>
                <td></td>
                <td></td>
                <td></td>
                <td></td>
                <td></td>
                <td></td>
                <td></td>
                <td></td>
                <td></td>
                <td></td>
            </tr>
            <tr style="vertical-align:top;">
                <td style="width:0px;height:22px;"></td>
                <td></td>
                <td class="cs12FE94AA" colspan="3" style="width:207px;height:22px;line-height:16px;text-align:left;vertical-align:top;"><nobr>Fait&nbsp;&#224;&nbsp;Goma&nbsp;le&nbsp;&nbsp;'.date('Y-m-d').'</nobr></td>
                <td></td>
                <td></td>
                <td></td>
                <td></td>
                <td></td>
                <td></td>
                <td></td>
                <td></td>
                <td></td>
                <td></td>
                <td></td>
            </tr>
        </table>
        </body>
        </html>';  
       
        return $output; 

}
function showDetailEntreeFssProduit($date1,$date2,$refFournisseur,$idProduit)
{
    $data = DB::table('tvente_detail_entree')

    ->join('tvente_entete_entree','tvente_entete_entree.id','=','tvente_detail_entree.refEnteteEntree')
    ->join('tvente_module','tvente_module.id','=','tvente_entete_entree.module_id')
    ->join('tvente_fournisseur','tvente_fournisseur.id','=','tvente_entete_entree.refFournisseur')

    ->join('tvente_services','tvente_services.id','=','tvente_entete_entree.refService')
    ->join('tvente_produit','tvente_produit.id','=','tvente_detail_entree.refProduit')
    ->join('tvente_categorie_produit','tvente_categorie_produit.id','=','tvente_produit.refCategorie')
    
    // ->join('tfin_ssouscompte as compteachat','compteachat.id','=','tvente_categorie_produit.compte_achat')       
    // ->join('tfin_ssouscompte as comptevariation','comptevariation.id','=','tvente_categorie_produit.compte_variationstock')       
    // ->join('tfin_ssouscompte as compteproduit','compteproduit.id','=','tvente_categorie_produit.compte_produit')        
    // ->join('tfin_ssouscompte as comptestockage','comptestockage.id','=','tvente_categorie_produit.compte_stockage')      

    ->select('tvente_detail_entree.id','refEnteteEntree','refProduit','tvente_entete_entree.refService',
    'tvente_detail_entree.compte_achat','tvente_detail_entree.compte_variationstock',
    'tvente_detail_entree.compte_produit','tvente_detail_entree.compte_stockage','puEntree','qteEntree',
    'uniteEntree',
    'puBase','qteBase','tvente_detail_entree.uniteBase','tvente_detail_entree.devise','tvente_detail_entree.taux',
    'montanttva','montantreduction','tvente_detail_entree.active','tvente_detail_entree.author',
    'tvente_detail_entree.refUser','tvente_detail_entree.created_at','tvente_detail_entree.devise',
    'tvente_detail_entree.taux'

    ,'noms','contact','mail','adresse','tvente_entete_entree.code','tvente_entete_entree.refFournisseur',
    'tvente_entete_entree.refRecquisition','tvente_entete_entree.module_id','dateEntree',
    'tvente_entete_entree.libelle','transporteur','niveau1','niveaumax',"tvente_module.nom_module"

    ,'nom_service'

    ,"tvente_produit.designation as designation",'refCategorie','refUniteBase','pu','qte',
    'cmup','Oldcode','Newcode','tvaapplique','estvendable',"tvente_categorie_produit.designation as Categorie"

    // ,'compteachat.refSousCompte as refSousCompteAchat','compteachat.nom_ssouscompte as nom_ssouscompteAchat',
    // 'compteachat.numero_ssouscompte as numero_ssouscompteAchat'
    // ,'comptevariation.refSousCompte as refSousCompteVariation','comptevariation.nom_ssouscompte as nom_ssouscompteVariation',
    // 'comptevariation.numero_ssouscompte as numero_ssouscompteVariation'
    // ,'compteproduit.refSousCompte as refSousCompteProduit','compteproduit.nom_ssouscompte as nom_ssouscompteProduit',
    // 'compteproduit.numero_ssouscompte as numero_ssouscompteProduit'
    // ,'comptestockage.refSousCompte as refSousCompteStockage','comptestockage.nom_ssouscompte as nom_ssouscompteStockage',
    // 'comptestockage.numero_ssouscompte as numero_ssouscompteStockage' 
    )
    ->selectRaw('(((qteEntree) * (puEntree))/tvente_detail_entree.taux) as PTEntreeFC')
    ->selectRaw('(qteBase*puBase) as PTBase')
    ->selectRaw('((qteBase*puBase)/tvente_detail_entree.taux) as PTBaseFC')
    ->selectRaw('(qteEntree*puEntree) as prixTotal')
    ->selectRaw('CONCAT("BE",YEAR(dateEntree),"",MONTH(dateEntree),"00",refEnteteEntree) as codeFacture')
    ->where([
        ['dateEntree','>=', $date1],
        ['dateEntree','<=', $date2],
        ['refFournisseur','=', $refFournisseur],
        ['refProduit','=', $idProduit]
    ])
    ->orderBy("tvente_detail_entree.created_at", "asc")
    ->get();
    $output='';

    foreach ($data as $row) 
    { 
        $output .='<tr style="vertical-align:top;">
        <td style="width:0px;height:24px;"></td>
        <td></td>
        <td class="cs6E02D7D2" style="width:101px;height:22px;line-height:15px;text-align:center;vertical-align:middle;">'.$row->codeFacture.'</td>
        <td class="cs6E02D7D2" colspan="3" style="width:230px;height:22px;line-height:15px;text-align:left;vertical-align:middle;">'.$row->noms.'</td>
        <td class="cs6E02D7D2" colspan="2" style="width:107px;height:22px;line-height:15px;text-align:center;vertical-align:middle;">'.$row->dateEntree.'</td>
        <td class="cs6E02D7D2" style="width:178px;height:22px;line-height:15px;text-align:left;vertical-align:middle;">'.$row->designation.'</td>
        <td class="cs6E02D7D2" colspan="2" style="width:91px;height:22px;line-height:15px;text-align:center;vertical-align:middle;">'.$row->qteEntree.' ('.$row->uniteEntree.')</td>
        <td class="cs6E02D7D2" colspan="3" style="width:64px;height:22px;line-height:15px;text-align:center;vertical-align:middle;">'.$row->puEntree.'$</td>
        <td class="cs6C28398D" colspan="2" style="width:122px;height:22px;line-height:15px;text-align:center;vertical-align:middle;">'.$row->prixTotal.'$</td>
    </tr>';      
   
    }

    return $output;

}


//==================== RAPPORT JOURNALIER DES REQUISITIONS ===========================================================================

public function fetch_rapport_detailcmd_date_fss_produit(Request $request)
{
    if ($request->get('date1') && $request->get('date2') && $request->get('refFournisseur')&& $request->get('idProduit')) {
        // code...
        $date1 = $request->get('date1');
        $date2 = $request->get('date2');
        $refFournisseur = $request->get('refFournisseur');
        $idProduit = $request->get('idProduit');

        $html ='<html><head><meta http-equiv="Content-Type" content="text/html; charset=utf-8"/>';
        $html .= $this->printRapportDetailRequisitionFssProduit($date1, $date2, $refFournisseur,$idProduit);       
        $html .='<script>window.print()</script>';

        echo($html);         

    } else {
        // code...
    }   
    
}
function printRapportDetailRequisitionFssProduit($date1, $date2, $refFournisseur,$idProduit)
{

         //Info Entreprise
         $nomEse='';
         $adresseEse='';
         $Tel1Ese='';
         $Tel2Ese='';
         $siteEse='';
         $emailEse='';
         $idNatEse='';
         $numImpotEse='';
         $rccEse='';
         $siege='';
         $busnessName='';
         $pic='';
         $pic2 = $this->displayImg("fichier", 'logo.png');
         $logo='';
 
         $data1 = DB::table('entreprises')
         ->join('secteurs','secteurs.id','=','entreprises.idsecteur')
         ->join('forme_juridiques','forme_juridiques.id','=','entreprises.idforme')
 
         ->join('pays','pays.id','=','entreprises.idPays')
         ->join('provinces','provinces.id','=','entreprises.idProvince')
         ->join('users','users.id','=','entreprises.ceo')        
         ->select('entreprises.id as id','entreprises.id as idEntreprise',
         'entreprises.ceo','entreprises.nomEntreprise','entreprises.descriptionEntreprise',
         'entreprises.emailEntreprise','entreprises.adresseEntreprise',
         'entreprises.telephoneEntreprise','entreprises.solutionEntreprise','entreprises.idsecteur',
         'entreprises.idforme','entreprises.etat',
         'entreprises.idPays','entreprises.idProvince','entreprises.edition','entreprises.facebook',
         'entreprises.linkedin','entreprises.twitter','entreprises.siteweb','entreprises.rccm',
         'entreprises.invPersonnel','entreprises.invHub','entreprises.invRecherche',
         'entreprises.chiffreAffaire','entreprises.nbremploye','entreprises.slug','entreprises.logo',
             //forme
             'forme_juridiques.nomForme','secteurs.nomSecteur',
             //users
             'users.name','users.email','users.avatar','users.telephone','users.adresse',
             //
             'provinces.nomProvince','pays.nomPays', 'entreprises.created_at')
         ->get();
         $output='';
         foreach ($data1 as $row) 
         {                                
             $nomEse=$row->nomEntreprise;
             $adresseEse=$row->adresseEntreprise;
             $Tel1Ese=$row->telephoneEntreprise;
             $Tel2Ese=$row->telephone;
             $siteEse=$row->siteweb;
             $emailEse=$row->emailEntreprise;
             $idNatEse=$row->rccm;
             $numImpotEse=$row->rccm;
             $busnessName=$row->nomSecteur;
             $rccmEse=$row->rccm;
             $pic = $this->displayImg("fichier", 'logo.png');
             $siege=$row->nomForme;         
         }
 

         $totalFact=0;                 
         $data2 =  DB::table('tvente_detail_requisition')         
         ->join('tvente_entete_requisition','tvente_entete_requisition.id','=','tvente_detail_requisition.refEnteteCmd')
         ->select(DB::raw('ROUND(SUM(qteBase*puBase),2) as TotalFacture'))
         ->where([
            ['dateCmd','>=', $date1],
            ['dateCmd','<=', $date2],
            ['refFournisseur','=', $refFournisseur],
            ['refProduit','=', $idProduit]
        ])    
         ->get(); 
         $output='';
         foreach ($data2 as $row) 
         {                                
            $totalFact=$row->TotalFacture;
                           
         }


         $nom_produit='';   
         $noms = '';
         $data3 =   DB::table('tvente_detail_requisition')
         ->join('tvente_produit','tvente_produit.id','=','tvente_detail_requisition.refProduit')
         ->join('tvente_categorie_produit','tvente_categorie_produit.id','=','tvente_produit.refCategorie')
         ->join('tvente_entete_requisition','tvente_entete_requisition.id','=','tvente_detail_requisition.refEnteteCmd')
         ->join('tvente_fournisseur','tvente_fournisseur.id','=','tvente_entete_requisition.refFournisseur')
 
         ->select('tvente_produit.designation as nom_produit','tvente_fournisseur.noms')
         ->where([
            ['dateCmd','>=', $date1],
            ['dateCmd','<=', $date2],
            ['refFournisseur','=', $refFournisseur],
            ['refProduit','=', $idProduit]
        ])    
         ->get(); 
         $output='';
         foreach ($data3 as $row) 
         {                                
            $nom_produit=$row->nom_produit;
            $noms=$row->noms;               
         }

           

        $output='<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Transitional//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd">
        <!-- saved from url=(0016)http://localhost -->
        <html>
        <head>
            <title>rpt_Rapportdetailfacture</title>
            <meta HTTP-EQUIV="Content-Type" CONTENT="text/html; charset=utf-8"/>
            <style type="text/css">
                .csB6F858D0 {color:#000000;background-color:#D6E5F4;border-left-style: none;border-top-style: none;border-right-style: none;border-bottom-style: none;font-family:Times New Roman; font-size:24px; font-weight:bold; font-style:normal; padding-left:2px;padding-right:2px;}
                .cs49AA1D99 {color:#000000;background-color:#E0E0E0;border-left:#000000 1px solid;border-top:#000000 1px solid;border-right:#000000 1px solid;border-bottom:#000000 1px solid;font-family:Times New Roman; font-size:13px; font-weight:bold; font-style:normal; }
                .cs9FE9304F {color:#000000;background-color:#E0E0E0;border-left-style: none;border-top:#000000 1px solid;border-right:#000000 1px solid;border-bottom:#000000 1px solid;font-family:Times New Roman; font-size:13px; font-weight:bold; font-style:normal; }
                .csEAC52FCD {color:#000000;background-color:#E0E0E0;border-left-style: none;border-top:#000000 1px solid;border-right-style: none;border-bottom:#000000 1px solid;font-family:Times New Roman; font-size:13px; font-weight:bold; font-style:normal; }
                .cs56F73198 {color:#000000;background-color:transparent;border-left:#000000 1px solid;border-top:#000000 1px solid;border-right:#000000 1px solid;border-bottom:#000000 1px solid;font-family:Times New Roman; font-size:16px; font-weight:normal; font-style:normal; padding-left:2px;}
                .cs6E02D7D2 {color:#000000;background-color:transparent;border-left-style: none;border-top:#000000 1px solid;border-right:#000000 1px solid;border-bottom:#000000 1px solid;font-family:Times New Roman; font-size:14px; font-weight:normal; font-style:normal; }
                .cs6C28398D {color:#000000;background-color:transparent;border-left-style: none;border-top:#000000 1px solid;border-right-style: none;border-bottom:#000000 1px solid;font-family:Times New Roman; font-size:14px; font-weight:normal; font-style:normal; }
                .cs612ED82F {color:#000000;background-color:transparent;border-left-style: none;border-top-style: none;border-right-style: none;border-bottom-style: none;font-family:Times New Roman; font-size:12px; font-weight:bold; font-style:normal; padding-left:2px;}
                .csFFC1C457 {color:#000000;background-color:transparent;border-left-style: none;border-top-style: none;border-right-style: none;border-bottom-style: none;font-family:Times New Roman; font-size:12px; font-weight:normal; font-style:normal; padding-left:2px;}
                .cs101A94F7 {color:#000000;background-color:transparent;border-left-style: none;border-top-style: none;border-right-style: none;border-bottom-style: none;font-family:Times New Roman; font-size:13px; font-weight:normal; font-style:normal; }
                .csCE72709D {color:#000000;background-color:transparent;border-left-style: none;border-top-style: none;border-right-style: none;border-bottom-style: none;font-family:Times New Roman; font-size:14px; font-weight:bold; font-style:normal; padding-left:2px;}
                .cs12FE94AA {color:#000000;background-color:transparent;border-left-style: none;border-top-style: none;border-right-style: none;border-bottom-style: none;font-family:Times New Roman; font-size:14px; font-weight:normal; font-style:normal; padding-left:2px;}
                .csFBB219FE {color:#000000;background-color:transparent;border-left-style: none;border-top-style: none;border-right-style: none;border-bottom-style: none;font-family:Times New Roman; font-size:18px; font-weight:bold; font-style:normal; padding-left:2px;}
                .cs739196BC {color:#5C5C5C;background-color:transparent;border-left-style: none;border-top-style: none;border-right-style: none;border-bottom-style: none;font-family:Segoe UI; font-size:11px; font-weight:normal; font-style:normal; }
                .csF7D3565D {height:0px;width:0px;overflow:hidden;font-size:0px;line-height:0px;}
            </style>
        </head>
        <body leftMargin=10 topMargin=10 rightMargin=10 bottomMargin=10 style="background-color:#FFFFFF">
        <table cellpadding="0" cellspacing="0" border="0" style="border-width:0px;empty-cells:show;width:909px;height:383px;position:relative;">
            <tr>
                <td style="width:0px;height:0px;"></td>
                <td style="height:0px;width:10px;"></td>
                <td style="height:0px;width:102px;"></td>
                <td style="height:0px;width:36px;"></td>
                <td style="height:0px;width:71px;"></td>
                <td style="height:0px;width:124px;"></td>
                <td style="height:0px;width:66px;"></td>
                <td style="height:0px;width:42px;"></td>
                <td style="height:0px;width:179px;"></td>
                <td style="height:0px;width:64px;"></td>
                <td style="height:0px;width:28px;"></td>
                <td style="height:0px;width:2px;"></td>
                <td style="height:0px;width:53px;"></td>
                <td style="height:0px;width:10px;"></td>
                <td style="height:0px;width:112px;"></td>
                <td style="height:0px;width:10px;"></td>
            </tr>
            <tr style="vertical-align:top;">
                <td style="width:0px;height:23px;"></td>
                <td></td>
                <td></td>
                <td></td>
                <td></td>
                <td></td>
                <td></td>
                <td></td>
                <td></td>
                <td></td>
                <td></td>
            </tr>
            <tr style="vertical-align:top;">
                <td style="width:0px;height:9px;"></td>
                <td></td>
                <td></td>
                <td></td>
                <td></td>
                <td></td>
                <td></td>
                <td></td>
                <td></td>
                <td></td>
                <td></td>
                <td></td>
                <td></td>
                <td></td>
                <td></td>
                <td></td>
            </tr>
            <tr style="vertical-align:top;">
                <td style="width:0px;height:1px;"></td>
                <td></td>
                <td class="csFBB219FE" colspan="8" rowspan="2" style="width:682px;height:23px;line-height:21px;text-align:left;vertical-align:middle;"><nobr>'.$nomEse.'</nobr></td>
                <td></td>
                <td></td>
                <td></td>
                <td></td>
                <td></td>
                <td></td>
            </tr>
            <tr style="vertical-align:top;">
                <td style="width:0px;height:22px;"></td>
                <td></td>
                <td></td>
                <td></td>
                <td class="cs101A94F7" colspan="3" rowspan="7" style="width:175px;height:144px;text-align:left;vertical-align:top;"><div style="overflow:hidden;width:175px;height:144px;">
                    <!--[if lt IE 7]><img alt="" src="'.$pic2.'" style="width:175px;height:144px;filter:progid:DXImageTransform.Microsoft.AlphaImageLoader(src="",sizingMethod="");" /><div style="display:none"><![endif]--><img alt="" src="'.$pic2.'" style="width:175px;height:144px;" /><!--[if lt IE 7]></div><![endif]--></div>
                </td>
                <td></td>
            </tr>
            <tr style="vertical-align:top;">
                <td style="width:0px;height:22px;"></td>
                <td></td>
                <td class="csCE72709D" colspan="8" style="width:682px;height:22px;line-height:15px;text-align:left;vertical-align:middle;"><nobr>'.$busnessName.'</nobr></td>
                <td></td>
                <td></td>
                <td></td>
            </tr>
            <tr style="vertical-align:top;">
                <td style="width:0px;height:22px;"></td>
                <td></td>
                <td class="csCE72709D" colspan="8" style="width:682px;height:22px;line-height:15px;text-align:left;vertical-align:middle;"><nobr>RCCM'.$rccEse.'.&nbsp;ID-NAT.'.$idNatEse.'</nobr></td>
                <td></td>
                <td></td>
                <td></td>
            </tr>
            <tr style="vertical-align:top;">
                <td style="width:0px;height:22px;"></td>
                <td></td>
                <td class="csFFC1C457" colspan="8" style="width:682px;height:22px;line-height:13px;text-align:left;vertical-align:middle;">'.$adresseEse.'</td>
                <td></td>
                <td></td>
                <td></td>
            </tr>
            <tr style="vertical-align:top;">
                <td style="width:0px;height:22px;"></td>
                <td></td>
                <td class="csFFC1C457" colspan="8" style="width:682px;height:22px;line-height:13px;text-align:left;vertical-align:middle;"><nobr>Email&nbsp;:&nbsp;'.$emailEse.'</nobr></td>
                <td></td>
                <td></td>
                <td></td>
            </tr>
            <tr style="vertical-align:top;">
                <td style="width:0px;height:22px;"></td>
                <td></td>
                <td class="csFFC1C457" colspan="8" style="width:682px;height:22px;line-height:13px;text-align:left;vertical-align:middle;"><nobr>Site&nbsp;web&nbsp;:&nbsp;'.$siteEse.'</nobr></td>
                <td></td>
                <td></td>
                <td></td>
            </tr>
            <tr style="vertical-align:top;">
                <td style="width:0px;height:12px;"></td>
                <td></td>
                <td class="cs612ED82F" colspan="8" rowspan="2" style="width:682px;height:23px;line-height:13px;text-align:left;vertical-align:middle;"><nobr>T&#233;l&#233;phone&nbsp;:&nbsp;'.$Tel1Ese.'&nbsp;&nbsp;24h/24</nobr></td>
                <td></td>
                <td></td>
                <td></td>
            </tr>
            <tr style="vertical-align:top;">
                <td style="width:0px;height:11px;"></td>
                <td></td>
                <td></td>
                <td></td>
                <td></td>
                <td></td>
                <td></td>
                <td></td>
            </tr>
            <tr style="vertical-align:top;">
                <td style="width:0px;height:8px;"></td>
                <td></td>
                <td></td>
                <td></td>
                <td></td>
                <td></td>
                <td></td>
                <td></td>
                <td></td>
                <td></td>
                <td></td>
                <td></td>
                <td></td>
                <td></td>
                <td></td>
                <td></td>
            </tr>
            <tr style="vertical-align:top;">
                <td style="width:0px;height:32px;"></td>
                <td></td>
                <td></td>
                <td></td>
                <td class="csB6F858D0" colspan="9" style="width:625px;height:32px;line-height:28px;text-align:center;vertical-align:middle;"><nobr>RAPPORT&nbsp;JOURNALIER&nbsp;DES&nbsp;ENTREES</nobr></td>
                <td></td>
                <td></td>
                <td></td>
            </tr>
            <tr style="vertical-align:top;">
                <td style="width:0px;height:19px;"></td>
                <td></td>
                <td></td>
                <td></td>
                <td></td>
                <td></td>
                <td></td>
                <td></td>
                <td></td>
                <td></td>
                <td></td>
                <td></td>
                <td></td>
                <td></td>
                <td></td>
                <td></td>
            </tr>
            <tr style="vertical-align:top;">
                <td style="width:0px;height:23px;"></td>
                <td></td>
                <td class="cs56F73198" colspan="4" style="width:329px;height:21px;line-height:18px;text-align:left;vertical-align:top;"><nobr>&nbsp;PERIODE&nbsp;:&nbsp;&nbsp;Du&nbsp;&nbsp;'.$date1.'&nbsp;&nbsp;au&nbsp;'.$date2.' : '.$noms.' - '.$nom_produit.'</nobr></td>
                <td></td>
                <td></td>
                <td></td>
                <td></td>
                <td></td>
                <td></td>
                <td></td>
                <td></td>
                <td></td>
                <td></td>
            </tr>
            <tr style="vertical-align:top;">
                <td style="width:0px;height:9px;"></td>
                <td></td>
                <td></td>
                <td></td>
                <td></td>
                <td></td>
                <td></td>
                <td></td>
                <td></td>
                <td></td>
                <td></td>
                <td></td>
                <td></td>
                <td></td>
                <td></td>
                <td></td>
            </tr>
            <tr style="vertical-align:top;">
                <td style="width:0px;height:24px;"></td>
                <td></td>
                <td class="cs9FE9304F" style="width:101px;height:22px;line-height:15px;text-align:center;vertical-align:middle;"><nobr>N&#176;&nbsp;FACTURE</nobr></td>
                <td class="cs9FE9304F" colspan="3" style="width:230px;height:22px;line-height:15px;text-align:center;vertical-align:middle;"><nobr>FOURNISSEUR</nobr></td>
                <td class="cs9FE9304F" colspan="2" style="width:107px;height:22px;line-height:15px;text-align:center;vertical-align:middle;"><nobr>DATE&nbsp;ENTREE</nobr></td>
                <td class="cs9FE9304F" style="width:178px;height:22px;line-height:15px;text-align:center;vertical-align:middle;"><nobr>ARTICLE</nobr></td>
                <td class="cs9FE9304F" colspan="2" style="width:91px;height:22px;line-height:15px;text-align:center;vertical-align:middle;"><nobr>Qte</nobr></td>
                <td class="cs9FE9304F" colspan="3" style="width:64px;height:22px;line-height:15px;text-align:center;vertical-align:middle;"><nobr>PU(USD)</nobr></td>
                <td class="csEAC52FCD" colspan="2" style="width:122px;height:22px;line-height:15px;text-align:center;vertical-align:middle;"><nobr>PT(USD)</nobr></td>
            </tr>
            ';

            $output .= $this->showDetailRequisitionFssProduit($date1,$date2,$refFournisseur,$idProduit); 

            $output.='
            <tr style="vertical-align:top;">
                <td style="width:0px;height:24px;"></td>
                <td></td>
                <td></td>
                <td></td>
                <td></td>
                <td></td>
                <td></td>
                <td></td>
                <td></td>
                <td class="cs49AA1D99" colspan="5" style="width:155px;height:22px;line-height:15px;text-align:center;vertical-align:middle;"><nobr>TOTAL&nbsp;($)&nbsp;:</nobr></td>
                <td class="csEAC52FCD" colspan="2" style="width:122px;height:22px;line-height:15px;text-align:center;vertical-align:middle;">'.$totalFact.' $</td>
            </tr>
            <tr style="vertical-align:top;">
                <td style="width:0px;height:10px;"></td>
                <td></td>
                <td></td>
                <td></td>
                <td></td>
                <td></td>
                <td></td>
                <td></td>
                <td></td>
                <td></td>
                <td></td>
                <td></td>
                <td></td>
                <td></td>
                <td></td>
                <td></td>
            </tr>
            <tr style="vertical-align:top;">
                <td style="width:0px;height:22px;"></td>
                <td></td>
                <td class="cs12FE94AA" colspan="3" style="width:207px;height:22px;line-height:16px;text-align:left;vertical-align:top;"><nobr>Fait&nbsp;&#224;&nbsp;Goma&nbsp;le&nbsp;&nbsp;'.date('Y-m-d').'</nobr></td>
                <td></td>
                <td></td>
                <td></td>
                <td></td>
                <td></td>
                <td></td>
                <td></td>
                <td></td>
                <td></td>
                <td></td>
                <td></td>
            </tr>
        </table>
        </body>
        </html>';  
       
        return $output; 

}
function showDetailRequisitionFssProduit($date1,$date2,$refFournisseur,$idProduit)
{
    $data = DB::table('tvente_detail_requisition')
    ->join('tfin_ssouscompte as compteachat','compteachat.id','=','tvente_detail_requisition.compte_achat')
    ->join('tfin_ssouscompte as compteproduit','compteproduit.id','=','tvente_detail_requisition.compte_produit')
    ->join('tvente_produit','tvente_produit.id','=','tvente_detail_requisition.refProduit')
    ->join('tvente_categorie_produit','tvente_categorie_produit.id','=','tvente_produit.refCategorie')
    ->join('tvente_entete_requisition','tvente_entete_requisition.id','=','tvente_detail_requisition.refEnteteCmd')
    ->join('tvente_fournisseur','tvente_fournisseur.id','=','tvente_entete_requisition.refFournisseur')
    ->select('tvente_detail_requisition.id','refEnteteCmd','refProduit','tvente_detail_requisition.compte_achat',
    'tvente_detail_requisition.compte_produit','puCmd','qteCmd','uniteCmd','tvente_detail_requisition.puBase',
    'tvente_detail_requisition.qteBase','tvente_detail_requisition.uniteBase','tvente_detail_requisition.devise',
    'tvente_detail_requisition.taux','montanttva','montantreduction','tvente_detail_requisition.active',
    'tvente_detail_requisition.author','tvente_detail_requisition.refUser','tvente_detail_requisition.created_at'
    ,"tvente_produit.designation as designation",'refCategorie','pu','qte',
    'cmup','Oldcode','Newcode','tvaapplique','estvendable',"tvente_categorie_produit.designation as Categorie"
    ,'compteachat.refSousCompte as refSousCompteAchat','compteachat.nom_ssouscompte as nom_ssouscompteAchat',
    'compteachat.numero_ssouscompte as numero_ssouscompteAchat'
    ,'compteproduit.refSousCompte as refSousCompteProduit','compteproduit.nom_ssouscompte as nom_ssouscompteProduit',
    'compteproduit.numero_ssouscompte as numero_ssouscompteProduit','noms','contact','mail','adresse','dateCmd')
    ->selectRaw('(qteCmd*puCmd) as PTCmd')
    ->selectRaw('(qteBase*puBase) as PTBase')
    ->selectRaw('((qteCmd*puCmd)/tvente_detail_requisition.taux) as PTCmdFC')
    ->selectRaw('((qteBase*puBase)/tvente_detail_requisition.taux) as PTBaseFC')
    ->selectRaw('CONCAT("BE",YEAR(dateCmd),"",MONTH(dateCmd),"00",refEnteteCmd) as codeFacture')
    ->where([
        ['dateCmd','>=', $date1],
        ['dateCmd','<=', $date2],
        ['refFournisseur','=', $refFournisseur],
        ['refProduit','=', $idProduit]
    ])
    ->orderBy("tvente_detail_requisition.created_at", "asc")
    ->get();

    $output='';

    foreach ($data as $row) 
    { 
        $output .='<tr style="vertical-align:top;">
        <td style="width:0px;height:24px;"></td>
        <td></td>
        <td class="cs6E02D7D2" style="width:101px;height:22px;line-height:15px;text-align:center;vertical-align:middle;">'.$row->codeFacture.'</td>
        <td class="cs6E02D7D2" colspan="3" style="width:230px;height:22px;line-height:15px;text-align:left;vertical-align:middle;">'.$row->noms.'</td>
        <td class="cs6E02D7D2" colspan="2" style="width:107px;height:22px;line-height:15px;text-align:center;vertical-align:middle;">'.$row->dateCmd.'</td>
        <td class="cs6E02D7D2" style="width:178px;height:22px;line-height:15px;text-align:left;vertical-align:middle;">'.$row->designation.'</td>
        <td class="cs6E02D7D2" colspan="2" style="width:91px;height:22px;line-height:15px;text-align:center;vertical-align:middle;">'.$row->qteBase.'</td>
        <td class="cs6E02D7D2" colspan="3" style="width:64px;height:22px;line-height:15px;text-align:center;vertical-align:middle;">'.$row->puBase.'$</td>
        <td class="cs6C28398D" colspan="2" style="width:122px;height:22px;line-height:15px;text-align:center;vertical-align:middle;">'.$row->PTBase.'$</td>
    </tr>';      
   
    }

    return $output;

}


//======================= FICHE MOUVEMENT SUR LE PRODUIT ==================================================================
//=========================================================================================================================

function pdf_fiche_mouvement_produit(Request $request)
{

    if ($request->get('date1') && $request->get('date2') && $request->get('idProduit') && $request->get('idService')) 
    {
        $date1 = $request->get('date1');
        $date2 = $request->get('date2');
        $refProduit = $request->get('idProduit');
        $refService = $request->get('idService');

        $html = $this->getInfoMouvementProduit($date1,$date2,$refProduit,$refService);
        $pdf = \App::make('dompdf.wrapper');

        $pdf->loadHTML($html);
        $pdf->loadHTML($html)->setPaper('a4');
        return $pdf->stream();
        
    }
    else{

    }   
    
}

function getInfoMouvementProduit($date1,$date2,$refProduit,$refService)
{
           //Info Entreprise
           $nomEse='';
           $adresseEse='';
           $Tel1Ese='';
           $Tel2Ese='';
           $siteEse='';
           $emailEse='';
           $idNatEse='';
           $numImpotEse='';
           $rccEse='';
           $siege='';
           $busnessName='';
           $pic='';
           $pic2 = $this->displayImg("fichier", 'logo.png');
           $logo='';
   
           $data1 = DB::table('entreprises')
           ->join('secteurs','secteurs.id','=','entreprises.idsecteur')
           ->join('forme_juridiques','forme_juridiques.id','=','entreprises.idforme')
   
           ->join('pays','pays.id','=','entreprises.idPays')
           ->join('provinces','provinces.id','=','entreprises.idProvince')
           ->join('users','users.id','=','entreprises.ceo')        
           ->select('entreprises.id as id','entreprises.id as idEntreprise',
           'entreprises.ceo','entreprises.nomEntreprise','entreprises.descriptionEntreprise',
           'entreprises.emailEntreprise','entreprises.adresseEntreprise',
           'entreprises.telephoneEntreprise','entreprises.solutionEntreprise','entreprises.idsecteur',
           'entreprises.idforme','entreprises.etat',
           'entreprises.idPays','entreprises.idProvince','entreprises.edition','entreprises.facebook',
           'entreprises.linkedin','entreprises.twitter','entreprises.siteweb','entreprises.rccm',
           'entreprises.invPersonnel','entreprises.invHub','entreprises.invRecherche',
           'entreprises.chiffreAffaire','entreprises.nbremploye','entreprises.slug','entreprises.logo',
               //forme
               'forme_juridiques.nomForme','secteurs.nomSecteur',
               //users
               'users.name','users.email','users.avatar','users.telephone','users.adresse',
               //
               'provinces.nomProvince','pays.nomPays', 'entreprises.created_at')
           ->get();
           $output='';
           foreach ($data1 as $row) 
           {                                
               $nomEse=$row->nomEntreprise;
               $adresseEse=$row->adresseEntreprise;
               $Tel1Ese=$row->telephoneEntreprise;
               $Tel2Ese=$row->telephone;
               $siteEse=$row->siteweb;
               $emailEse=$row->emailEntreprise;
               $idNatEse=$row->rccm;
               $numImpotEse=$row->rccm;
               $busnessName=$row->nomSecteur;
               $rccmEse=$row->rccm;
               $pic = $this->displayImg("fichier", 'logo.png');
               $siege=$row->nomForme;         
           }
               //
            $totalEntree=0;
            $totalSortie=0;
            $tempEntree=0;
            $tempSortie=0;
            $report=0;
            $solde=0;

            $nom_produit=''; 
            $nom_unitebase='';  
            $nom_service='';

            $data_service = DB::table("tvente_services")
            ->select("tvente_services.id","tvente_services.nom_service","tvente_services.created_at","status",
            'tvente_services.active')
            ->where([
               ['tvente_services.id','=', $refService]
           ])      
           ->get(); 
           foreach ($data_service as $row) 
           {
              $nom_service=$row->nom_service;                 
           }


           $data_produit = DB::table("tvente_produit")
           ->select('id','designation','refCategorie','refUniteBase','uniteBase','pu','qte',
            'cmup','stock_alerte','devise','taux','Oldcode','Newcode','tvaapplique','estvendable','author','refUser')
           ->where([
              ['tvente_produit.id','=', $refProduit]
          ])      
          ->get(); 
          foreach ($data_produit as $row) 
          {
             $nom_produit=$row->designation;  
             $nom_unitebase=$row->uniteBase;                
          }
   

          $date_temp_entree = DB::table('tvente_mouvement_stock')   
          ->join('tvente_stock_service','tvente_stock_service.id','=','tvente_mouvement_stock.idStockService')
          ->select(DB::raw('IFNULL(ROUND(SUM(qteMvt * qteBase),3),0) as tempEntree'))
          ->where([               
              ['dateMvt','<', $date1],
              ['tvente_stock_service.refProduit','=', $refProduit],
              ['tvente_stock_service.refService','=', $refService],
              ['tvente_mouvement_stock.type_mouvement','=', 'Entree']                
          ])               
          ->get();
          foreach ($date_temp_entree as $row) 
          {                                
             $tempEntree=$row->tempEntree;                           
          }

          $data_temp_sortie = DB::table('tvente_mouvement_stock')   
          ->join('tvente_stock_service','tvente_stock_service.id','=','tvente_mouvement_stock.idStockService')
          ->select(DB::raw('IFNULL(ROUND(SUM(qteMvt * qteBase),3),0) as tempSortie'))
          ->where([               
              ['dateMvt','<', $date1],
              ['tvente_stock_service.refProduit','=', $refProduit],
              ['tvente_stock_service.refService','=', $refService],
              ['tvente_mouvement_stock.type_mouvement','=', 'Sortie']                
          ])               
          ->get();
          foreach ($data_temp_sortie as $row) 
          {                                
             $tempSortie=$row->tempSortie;                           
          }

          $report = floatval($tempEntree) - floatval($tempSortie);

            $data_entree = DB::table('tvente_mouvement_stock')   
            ->join('tvente_stock_service','tvente_stock_service.id','=','tvente_mouvement_stock.idStockService')
            ->select(DB::raw('IFNULL(ROUND(SUM(qteMvt * qteBase),3),0) as totalEntree'))
            ->where([               
                ['dateMvt','>=', $date1],
                ['dateMvt','<=', $date2],
                ['tvente_stock_service.refProduit','=', $refProduit],
                ['tvente_stock_service.refService','=', $refService],
                ['tvente_mouvement_stock.type_mouvement','=', 'Entree']                
            ])               
            ->get();
            foreach ($data_entree as $row) 
            {                                
               $totalEntree=$row->totalEntree;                           
            }

            $data_sortie = DB::table('tvente_mouvement_stock')   
            ->join('tvente_stock_service','tvente_stock_service.id','=','tvente_mouvement_stock.idStockService')
            ->select(DB::raw('IFNULL(ROUND(SUM(qteMvt * qteBase),3),0) as totalSortie'))
            ->where([               
                ['dateMvt','>=', $date1],
                ['dateMvt','<=', $date2],
                ['tvente_stock_service.refProduit','=', $refProduit],
                ['tvente_stock_service.refService','=', $refService],
                ['tvente_mouvement_stock.type_mouvement','=', 'Sortie']                
            ])               
            ->get();
            foreach ($data_sortie as $row) 
            {                                
               $totalSortie=$row->totalSortie;                           
            }

            $solde = floatval($report) + floatval($totalEntree) - floatval($totalSortie);            

            $output='';  
            $output=' 

                <!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Transitional//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd">
                <!-- saved from url=(0016)http://localhost -->
                <html>
                <head>
                    <title>rptFicheProduit</title>
                    <meta HTTP-EQUIV="Content-Type" CONTENT="text/html; charset=utf-8"/>
                    <style type="text/css">
                        .cs275E312D {color:#000000;background-color:transparent;border-left:#000000 1px solid;border-top:#000000 1px solid;border-right:#000000 1px solid;border-bottom:#000000 1px solid;font-family:Times New Roman; font-size:13px; font-weight:bold; font-style:normal; }
                        .csE71035DC {color:#000000;background-color:transparent;border-left:#000000 1px solid;border-top:#000000 1px solid;border-right:#000000 1px solid;border-bottom:#000000 1px solid;font-family:Times New Roman; font-size:13px; font-weight:normal; font-style:normal; }
                        .csAB3AA82A {color:#000000;background-color:transparent;border-left-style: none;border-top:#000000 1px solid;border-right:#000000 1px solid;border-bottom:#000000 1px solid;font-family:Times New Roman; font-size:13px; font-weight:bold; font-style:normal; }
                        .cs82D98BB6 {color:#000000;background-color:transparent;border-left-style: none;border-top:#000000 1px solid;border-right:#000000 1px solid;border-bottom:#000000 1px solid;font-family:Times New Roman; font-size:13px; font-weight:normal; font-style:normal; }
                        .cs8A513397 {color:#000000;background-color:transparent;border-left-style: none;border-top-style: none;border-right-style: none;border-bottom-style: none;font-family:Times New Roman; font-size:13px; font-weight:bold; font-style:normal; padding-left:2px;}
                        .cs8BD51C12 {color:#000000;background-color:transparent;border-left-style: none;border-top-style: none;border-right-style: none;border-bottom-style: none;font-family:Times New Roman; font-size:13px; font-weight:bold; font-style:normal; padding-left:2px;padding-right:2px;}
                        .cs101A94F7 {color:#000000;background-color:transparent;border-left-style: none;border-top-style: none;border-right-style: none;border-bottom-style: none;font-family:Times New Roman; font-size:13px; font-weight:normal; font-style:normal; }
                        .cs6105B8F3 {color:#000000;background-color:transparent;border-left-style: none;border-top-style: none;border-right-style: none;border-bottom-style: none;font-family:Times New Roman; font-size:13px; font-weight:normal; font-style:normal; padding-left:2px;}
                        .cs5EA817F2 {color:#000000;background-color:transparent;border-left-style: none;border-top-style: none;border-right-style: none;border-bottom-style: none;font-family:Times New Roman; font-size:13px; font-weight:normal; font-style:normal; padding-left:2px;padding-right:2px;}
                        .cs739196BC {color:#5C5C5C;background-color:transparent;border-left-style: none;border-top-style: none;border-right-style: none;border-bottom-style: none;font-family:Segoe UI; font-size:11px; font-weight:normal; font-style:normal; }
                        .csF7D3565D {height:0px;width:0px;overflow:hidden;font-size:0px;line-height:0px;}
                    </style>
                </head>
                <body leftMargin=10 topMargin=10 rightMargin=10 bottomMargin=10 style="background-color:#FFFFFF">
                <table cellpadding="0" cellspacing="0" border="0" style="border-width:0px;empty-cells:show;width:614px;height:373px;position:relative;">
                    <tr>
                        <td style="width:0px;height:0px;"></td>
                        <td style="height:0px;width:10px;"></td>
                        <td style="height:0px;width:96px;"></td>
                        <td style="height:0px;width:2px;"></td>
                        <td style="height:0px;width:79px;"></td>
                        <td style="height:0px;width:213px;"></td>
                        <td style="height:0px;width:9px;"></td>
                        <td style="height:0px;width:27px;"></td>
                        <td style="height:0px;width:10px;"></td>
                        <td style="height:0px;width:27px;"></td>
                        <td style="height:0px;width:10px;"></td>
                        <td style="height:0px;width:58px;"></td>
                        <td style="height:0px;width:2px;"></td>
                        <td style="height:0px;width:71px;"></td>
                    </tr>
                    <tr style="vertical-align:top;">
                        <td style="width:0px;height:23px;"></td>
                        <td class="cs739196BC" colspan="6" style="width:409px;height:23px;line-height:14px;text-align:center;vertical-align:middle;"></td>
                        <td></td>
                        <td></td>
                        <td></td>
                        <td></td>
                        <td></td>
                        <td></td>
                        <td></td>
                    </tr>
                    <tr style="vertical-align:top;">
                        <td style="width:0px;height:12px;"></td>
                        <td></td>
                        <td></td>
                        <td></td>
                        <td></td>
                        <td></td>
                        <td></td>
                        <td></td>
                        <td></td>
                        <td></td>
                        <td></td>
                        <td></td>
                        <td></td>
                        <td></td>
                    </tr>
                    <tr style="vertical-align:top;">
                        <td style="width:0px;height:22px;"></td>
                        <td></td>
                        <td class="cs8A513397" colspan="7" style="width:434px;height:22px;line-height:15px;text-align:left;vertical-align:middle;"><nobr>'.$nomEse.'</nobr></td>
                        <td></td>
                        <td></td>
                        <td class="cs101A94F7" colspan="3" rowspan="5" style="width:131px;height:110px;text-align:left;vertical-align:top;"><div style="overflow:hidden;width:131px;height:110px;">
                            <img alt="" src="'.$pic2.'" style="width:131px;height:110px;" /></div>
                        </td>
                    </tr>
                    <tr style="vertical-align:top;">
                        <td style="width:0px;height:22px;"></td>
                        <td></td>
                        <td class="cs6105B8F3" colspan="7" style="width:434px;height:22px;line-height:15px;text-align:left;vertical-align:middle;"><nobr>'.$busnessName.'</nobr></td>
                        <td></td>
                        <td></td>
                    </tr>
                    <tr style="vertical-align:top;">
                        <td style="width:0px;height:22px;"></td>
                        <td></td>
                        <td class="cs8A513397" colspan="7" style="width:434px;height:22px;line-height:15px;text-align:left;vertical-align:middle;"><nobr>RCCM&nbsp;'.$rccEse.'.&nbsp;ID&nbsp;NAT&nbsp;'.$idNatEse.'</nobr></td>
                        <td></td>
                        <td></td>
                    </tr>
                    <tr style="vertical-align:top;">
                        <td style="width:0px;height:22px;"></td>
                        <td></td>
                        <td class="cs8A513397" colspan="7" style="width:434px;height:22px;line-height:15px;text-align:left;vertical-align:middle;"><nobr>N&#176;&nbsp;Impot : '.$numImpotEse.'</nobr></td>
                        <td></td>
                        <td></td>
                    </tr>
                    <tr style="vertical-align:top;">
                        <td style="width:0px;height:22px;"></td>
                        <td></td>
                        <td class="cs6105B8F3" colspan="7" style="width:434px;height:22px;line-height:15px;text-align:left;vertical-align:middle;"><nobr>'.$adresseEse.'</nobr></td>
                        <td></td>
                        <td></td>
                    </tr>
                    <tr style="vertical-align:top;">
                        <td style="width:0px;height:23px;"></td>
                        <td></td>
                        <td class="cs6105B8F3" colspan="7" style="width:434px;height:23px;line-height:15px;text-align:left;vertical-align:middle;"><nobr>E-mail&nbsp;:&nbsp;'.$emailEse.'</nobr></td>
                        <td></td>
                        <td></td>
                        <td></td>
                        <td></td>
                        <td></td>
                    </tr>
                    <tr style="vertical-align:top;">
                        <td style="width:0px;height:22px;"></td>
                        <td></td>
                        <td class="cs6105B8F3" colspan="7" style="width:434px;height:22px;line-height:15px;text-align:left;vertical-align:middle;"><nobr>Site-web&nbsp;:&nbsp;'.$siteEse.'</nobr></td>
                        <td></td>
                        <td></td>
                        <td></td>
                        <td></td>
                        <td></td>
                    </tr>
                    <tr style="vertical-align:top;">
                        <td style="width:0px;height:22px;"></td>
                        <td></td>
                        <td class="cs8A513397" colspan="7" style="width:434px;height:22px;line-height:15px;text-align:left;vertical-align:middle;"><nobr>Tel&#233;phone&nbsp;:&nbsp;'.$Tel1Ese.' - '.$Tel2Ese.'</nobr></td>
                        <td></td>
                        <td></td>
                        <td></td>
                        <td></td>
                        <td></td>
                    </tr>
                    <tr style="vertical-align:top;">
                        <td style="width:0px;height:10px;"></td>
                        <td></td>
                        <td></td>
                        <td></td>
                        <td></td>
                        <td></td>
                        <td></td>
                        <td></td>
                        <td></td>
                        <td></td>
                        <td></td>
                        <td></td>
                        <td></td>
                        <td></td>
                    </tr>
                    <tr style="vertical-align:top;">
                        <td style="width:0px;height:22px;"></td>
                        <td></td>
                        <td></td>
                        <td></td>
                        <td></td>
                        <td class="cs5EA817F2" colspan="3" style="width:245px;height:22px;line-height:15px;text-align:center;vertical-align:middle;"><nobr>Du&nbsp;'.$date1.'&nbsp;&nbsp;au&nbsp;&nbsp;'.$date2.'</nobr></td>
                        <td></td>
                        <td></td>
                        <td></td>
                        <td></td>
                        <td></td>
                        <td></td>
                    </tr>
                    <tr style="vertical-align:top;">
                        <td style="width:0px;height:22px;"></td>
                        <td></td>
                        <td></td>
                        <td></td>
                        <td class="cs8BD51C12" colspan="9" style="width:431px;height:22px;line-height:15px;text-align:center;vertical-align:middle;"><nobr>'.$nom_service.':&nbsp;'.$nom_produit.'&nbsp;('.$nom_unitebase.')</nobr></td>
                        <td></td>
                    </tr>
                    <tr style="vertical-align:top;">
                        <td style="width:0px;height:11px;"></td>
                        <td></td>
                        <td></td>
                        <td></td>
                        <td></td>
                        <td></td>
                        <td></td>
                        <td></td>
                        <td></td>
                        <td></td>
                        <td></td>
                        <td></td>
                        <td></td>
                        <td></td>
                    </tr>
                    <tr style="vertical-align:top;">
                        <td style="width:0px;height:24px;"></td>
                        <td></td>
                        <td class="cs275E312D" style="width:94px;height:22px;line-height:15px;text-align:center;vertical-align:middle;"><nobr>Date</nobr></td>
                        <td class="csAB3AA82A" colspan="3" style="width:293px;height:22px;line-height:15px;text-align:center;vertical-align:middle;"><nobr>Libell&#233;</nobr></td>
                        <td class="csAB3AA82A" colspan="4" style="width:72px;height:22px;line-height:15px;text-align:center;vertical-align:middle;"><nobr>Entr&#233;e</nobr></td>
                        <td class="csAB3AA82A" colspan="2" style="width:67px;height:22px;line-height:15px;text-align:center;vertical-align:middle;"><nobr>Sortie</nobr></td>
                        <td class="csAB3AA82A" colspan="2" style="width:72px;height:22px;line-height:15px;text-align:center;vertical-align:middle;"><nobr>SF</nobr></td>
                    </tr>
                    <tr style="vertical-align:top;">
                        <td style="width:0px;height:24px;"></td>
                        <td></td>
                        <td class="cs275E312D" style="width:94px;height:22px;line-height:15px;text-align:center;vertical-align:middle;"><nobr>'.$date1.'</nobr></td>
                        <td class="csAB3AA82A" colspan="3" style="width:293px;height:22px;line-height:15px;text-align:center;vertical-align:middle;"><nobr>Solde&nbsp;Innitial</nobr></td>
                        <td class="csAB3AA82A" colspan="4" style="width:72px;height:22px;line-height:15px;text-align:center;vertical-align:middle;"><nobr>0</nobr></td>
                        <td class="csAB3AA82A" colspan="2" style="width:67px;height:22px;line-height:15px;text-align:center;vertical-align:middle;"><nobr>0</nobr></td>
                        <td class="csAB3AA82A" colspan="2" style="width:72px;height:22px;line-height:15px;text-align:center;vertical-align:middle;"><nobr>'.$report.'</nobr></td>
                    </tr>
                    ';
                                                                    
                                        $output .= $this->showMouvementProduit($date1,$date2,$refProduit,$refService); 
                                                                    
                                        $output.='
                    <tr style="vertical-align:top;">
                        <td style="width:0px;height:24px;"></td>
                        <td></td>
                        <td class="cs275E312D" style="width:94px;height:22px;line-height:15px;text-align:center;vertical-align:middle;"><nobr>'.$date2.'</nobr></td>
                        <td class="csAB3AA82A" colspan="3" style="width:293px;height:22px;line-height:15px;text-align:center;vertical-align:middle;"><nobr>Solde&nbsp;Final</nobr></td>
                        <td class="csAB3AA82A" colspan="4" style="width:72px;height:22px;line-height:15px;text-align:center;vertical-align:middle;"><nobr>0</nobr></td>
                        <td class="csAB3AA82A" colspan="2" style="width:67px;height:22px;line-height:15px;text-align:center;vertical-align:middle;"><nobr>0</nobr></td>
                        <td class="csAB3AA82A" colspan="2" style="width:72px;height:22px;line-height:15px;text-align:center;vertical-align:middle;"><nobr>'.$solde.'</nobr></td>
                    </tr>
                </table>
                </body>
                </html>

            '; 

    return $output;

}   

function showMouvementProduit($date1,$date2,$refProduit,$refService)
{
    $data = DB::table('tvente_mouvement_stock')
    ->join('tvente_stock_service','tvente_stock_service.id','=','tvente_mouvement_stock.idStockService')
    ->join('tvente_produit','tvente_produit.id','=','tvente_stock_service.refProduit')
    ->join('tvente_services','tvente_services.id','=','tvente_stock_service.refService')
    ->join('tvente_categorie_produit','tvente_categorie_produit.id','=','tvente_produit.refCategorie') 

    ->select('tvente_mouvement_stock.id','idStockService','tvente_categorie_produit.compte_vente',
    'tvente_categorie_produit.compte_variationstock','tvente_categorie_produit.compte_perte',
    'tvente_categorie_produit.compte_produit','tvente_categorie_produit.compte_destockage',
    'tvente_categorie_produit.compte_achat','tvente_categorie_produit.compte_stockage','dateMvt',
    'type_mouvement','libelle_mouvement','nom_table','id_data','puMvt','qteMvt','uniteMvt',
    'puBase','qteBase','tvente_mouvement_stock.uniteBase',
    'cmupMvt','tvente_mouvement_stock.devise','tvente_mouvement_stock.taux','tvente_mouvement_stock.author',
    'tvente_mouvement_stock.refUser','tvente_mouvement_stock.created_at',

    'tvente_produit.designation','tvente_produit.refCategorie','tvente_produit.refUniteBase',
    'tvente_produit.Oldcode','tvente_produit.Newcode','tvente_produit.tvaapplique',
    'tvente_produit.estvendable',  

    'nom_service','tvente_stock_service.refService','tvente_stock_service.refProduit',
    'tvente_stock_service.pu','tvente_stock_service.qte','tvente_stock_service.cmup','tvente_stock_service.active')
    ->selectRaw("(CASE WHEN (type_mouvement = 'Entree') THEN (qteMvt * qteBase) END) as qteEntree")
    ->selectRaw("(CASE WHEN (type_mouvement = 'Sortie') THEN (qteMvt * qteBase) END) as qteSortie")
    ->selectRaw("((CASE WHEN (type_mouvement = 'Entree') THEN (qteMvt * qteBase) END) - (CASE WHEN (type_mouvement = 'Sortie') THEN (qteMvt * qteBase) END)) as solde")
    ->where([               
        ['dateMvt','>=', $date1],
        ['dateMvt','<=', $date2],
        ['tvente_stock_service.refProduit','=', $refProduit],
        ['tvente_stock_service.refService','=', $refService]                
    ])
    ->orderBy("dateMvt", "asc")
    ->get();

    $output='';

    foreach ($data as $row) 
    {
         $output .='
            <tr style="vertical-align:top;">
                <td style="width:0px;height:24px;"></td>
                <td></td>
                <td class="csE71035DC" style="width:94px;height:22px;line-height:15px;text-align:center;vertical-align:middle;"><nobr>'.$row->dateMvt.'</nobr></td>
                <td class="cs82D98BB6" colspan="3" style="width:293px;height:22px;line-height:15px;text-align:left;vertical-align:middle;">'.$row->libelle_mouvement.'</td>
                <td class="cs82D98BB6" colspan="4" style="width:72px;height:22px;line-height:15px;text-align:center;vertical-align:middle;"><nobr>'.$row->qteEntree.'</nobr></td>
                <td class="cs82D98BB6" colspan="2" style="width:67px;height:22px;line-height:15px;text-align:center;vertical-align:middle;"><nobr>'.$row->qteSortie.'</nobr></td>
                <td class="cs82D98BB6" colspan="2" style="width:72px;height:22px;line-height:15px;text-align:center;vertical-align:middle;"><nobr>'.$row->solde.'</nobr></td>
            </tr>
         ';
       
    }

    return $output;

}


//======================= FICHE MOUVEMENT DES COMPTES ==================================================================
//=========================================================================================================================

function pdf_fiche_mouvement_comptes(Request $request)
{

    if ($request->get('date1') && $request->get('date2') && $request->get('refService')) 
    {
        $date1 = $request->get('date1');
        $date2 = $request->get('date2');
        $refService = $request->get('refService');

        $html = $this->getInfoMouvementCompteProduit($date1,$date2,$refService);
        $pdf = \App::make('dompdf.wrapper');

        $pdf->loadHTML($html);
        $pdf->loadHTML($html)->setPaper('a4', 'landscape');
        return $pdf->stream();
        
    }
    else{

    }   
    
}
function getInfoMouvementCompteProduit($date1,$date2,$refService)
{
           //Info Entreprise
           $nomEse='';
           $adresseEse='';
           $Tel1Ese='';
           $Tel2Ese='';
           $siteEse='';
           $emailEse='';
           $idNatEse='';
           $numImpotEse='';
           $rccEse='';
           $siege='';
           $busnessName='';
           $pic='';
           $pic2 = $this->displayImg("fichier", 'logo.png');
           $logo='';
   
           $data1 = DB::table('entreprises')
           ->join('secteurs','secteurs.id','=','entreprises.idsecteur')
           ->join('forme_juridiques','forme_juridiques.id','=','entreprises.idforme')
   
           ->join('pays','pays.id','=','entreprises.idPays')
           ->join('provinces','provinces.id','=','entreprises.idProvince')
           ->join('users','users.id','=','entreprises.ceo')        
           ->select('entreprises.id as id','entreprises.id as idEntreprise',
           'entreprises.ceo','entreprises.nomEntreprise','entreprises.descriptionEntreprise',
           'entreprises.emailEntreprise','entreprises.adresseEntreprise',
           'entreprises.telephoneEntreprise','entreprises.solutionEntreprise','entreprises.idsecteur',
           'entreprises.idforme','entreprises.etat',
           'entreprises.idPays','entreprises.idProvince','entreprises.edition','entreprises.facebook',
           'entreprises.linkedin','entreprises.twitter','entreprises.siteweb','entreprises.rccm',
           'entreprises.invPersonnel','entreprises.invHub','entreprises.invRecherche',
           'entreprises.chiffreAffaire','entreprises.nbremploye','entreprises.slug','entreprises.logo',
               //forme
               'forme_juridiques.nomForme','secteurs.nomSecteur',
               //users
               'users.name','users.email','users.avatar','users.telephone','users.adresse',
               //
               'provinces.nomProvince','pays.nomPays', 'entreprises.created_at')
           ->first();
           $output='';
           if ($data1) 
           {                                
               $nomEse=$data1->nomEntreprise;
               $adresseEse=$data1->adresseEntreprise;
               $Tel1Ese=$data1->telephoneEntreprise;
               $Tel2Ese=$data1->telephone;
               $siteEse=$data1->siteweb;
               $emailEse=$data1->emailEntreprise;
               $idNatEse=$data1->rccm;
               $numImpotEse=$data1->rccm;
               $busnessName=$data1->nomSecteur;
               $rccmEse=$data1->rccm;
               $pic = $this->displayImg("fichier", 'logo.png');
               $siege=$data1->nomForme;         
           }
               //
            $Montant=0;
            $nom_service='';

            $data_service = DB::table("tvente_services")
            ->select("tvente_services.id","tvente_services.nom_service","tvente_services.created_at","status",
            'tvente_services.active')
            ->where([
               ['tvente_services.id','=', $refService]
           ])      
           ->first(); 
           if ($data_service) 
           {
              $nom_service=$data_service->nom_service;                 
           }   

            $totalVente = 0;
            $data_entree = DB::table('tvente_detail_vente') 
            ->join('tvente_produit','tvente_produit.id','=','tvente_detail_vente.refProduit')
            ->join('tvente_categorie_produit','tvente_categorie_produit.id','=','tvente_produit.refCategorie')
    
            ->join('tvente_entete_vente','tvente_entete_vente.id','=','tvente_detail_vente.refEnteteVente')        
            ->join('tvente_module','tvente_module.id','=','tvente_entete_vente.module_id')
            ->join('tvente_services','tvente_services.id','=','tvente_entete_vente.refService')
            ->join('tvente_client','tvente_client.id','=','tvente_entete_vente.refClient')
            ->join('tfin_ssouscompte as comptevariation','comptevariation.id','=','tvente_detail_vente.compte_variationstock')
            ->select(DB::raw('IFNULL(ROUND(SUM(qteVente * puVente),0),0) as totalVente'))
            ->where([               
                ['dateVente','>=', $date1],
                ['dateVente','<=', $date2],
                ['tvente_entete_vente.refService','=', $refService]                
            ])               
            ->first();
            if ($data_entree) 
            {                                
               $totalVente=$data_entree->totalVente;                           
            }       

            $output='';  
            $output=' 

            <!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Transitional//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd">
            <!-- saved from url=(0016)http://localhost -->
            <html>
            <head>
                <title>rptReleveCompte</title>
                <meta HTTP-EQUIV="Content-Type" CONTENT="text/html; charset=utf-8"/>
                <style type="text/css">
                    .csE5AC9E0D {color:#000000;background-color:transparent;border-left:#000000 1px solid;border-top:#000000 1px solid;border-right:#000000 1px solid;border-bottom:#000000 1px solid;font-family:Times New Roman; font-size:11px; font-weight:normal; font-style:normal; }
                    .cs275E312D {color:#000000;background-color:transparent;border-left:#000000 1px solid;border-top:#000000 1px solid;border-right:#000000 1px solid;border-bottom:#000000 1px solid;font-family:Times New Roman; font-size:13px; font-weight:bold; font-style:normal; }
                    .cs3B0DD49A {color:#000000;background-color:transparent;border-left-style: none;border-top:#000000 1px solid;border-right:#000000 1px solid;border-bottom:#000000 1px solid;font-family:Times New Roman; font-size:11px; font-weight:normal; font-style:normal; }
                    .csAB3AA82A {color:#000000;background-color:transparent;border-left-style: none;border-top:#000000 1px solid;border-right:#000000 1px solid;border-bottom:#000000 1px solid;font-family:Times New Roman; font-size:13px; font-weight:bold; font-style:normal; }
                    .cs8A513397 {color:#000000;background-color:transparent;border-left-style: none;border-top-style: none;border-right-style: none;border-bottom-style: none;font-family:Times New Roman; font-size:13px; font-weight:bold; font-style:normal; padding-left:2px;}
                    .cs101A94F7 {color:#000000;background-color:transparent;border-left-style: none;border-top-style: none;border-right-style: none;border-bottom-style: none;font-family:Times New Roman; font-size:13px; font-weight:normal; font-style:normal; }
                    .cs6105B8F3 {color:#000000;background-color:transparent;border-left-style: none;border-top-style: none;border-right-style: none;border-bottom-style: none;font-family:Times New Roman; font-size:13px; font-weight:normal; font-style:normal; padding-left:2px;}
                    .cs5EA817F2 {color:#000000;background-color:transparent;border-left-style: none;border-top-style: none;border-right-style: none;border-bottom-style: none;font-family:Times New Roman; font-size:13px; font-weight:normal; font-style:normal; padding-left:2px;padding-right:2px;}
                    .cs739196BC {color:#5C5C5C;background-color:transparent;border-left-style: none;border-top-style: none;border-right-style: none;border-bottom-style: none;font-family:Segoe UI; font-size:11px; font-weight:normal; font-style:normal; }
                    .csF7D3565D {height:0px;width:0px;overflow:hidden;font-size:0px;line-height:0px;}
                </style>
            </head>
            <body leftMargin=10 topMargin=10 rightMargin=10 bottomMargin=10 style="background-color:#FFFFFF">
            <table cellpadding="0" cellspacing="0" border="0" style="border-width:0px;empty-cells:show;width:614px;height:322px;position:relative;">
                <tr>
                    <td style="width:0px;height:0px;"></td>
                    <td style="height:0px;width:10px;"></td>
                    <td style="height:0px;width:54px;"></td>
                    <td style="height:0px;width:69px;"></td>
                    <td style="height:0px;width:79px;"></td>
                    <td style="height:0px;width:197px;"></td>
                    <td style="height:0px;width:9px;"></td>
                    <td style="height:0px;width:28px;"></td>
                    <td style="height:0px;width:37px;"></td>
                    <td style="height:0px;width:97px;"></td>
                    <td style="height:0px;width:34px;"></td>
                </tr>
                <tr style="vertical-align:top;">
                    <td style="width:0px;height:23px;"></td>
                    <td class="cs739196BC" colspan="5" style="width:409px;height:23px;line-height:14px;text-align:center;vertical-align:middle;"></td>
                    <td></td>
                    <td></td>
                    <td></td>
                    <td></td>
                    <td></td>
                </tr>
                <tr style="vertical-align:top;">
                    <td style="width:0px;height:3px;"></td>
                    <td></td>
                    <td></td>
                    <td></td>
                    <td></td>
                    <td></td>
                    <td></td>
                    <td></td>
                    <td></td>
                    <td></td>
                    <td></td>
                </tr>
                <tr style="vertical-align:top;">
                    <td style="width:0px;height:22px;"></td>
                    <td></td>
                    <td class="cs8A513397" colspan="6" style="width:434px;height:22px;line-height:15px;text-align:left;vertical-align:middle;"><nobr>'.$nomEse.'</nobr></td>
                    <td></td>
                    <td class="cs101A94F7" colspan="2" rowspan="5" style="width:131px;height:111px;text-align:left;vertical-align:top;"><div style="overflow:hidden;width:131px;height:111px;">
                        <img alt="" src="'.$pic2.'" style="width:131px;height:111px;" /></div>
                    </td>
                </tr>
                <tr style="vertical-align:top;">
                    <td style="width:0px;height:22px;"></td>
                    <td></td>
                    <td class="cs6105B8F3" colspan="6" style="width:434px;height:22px;line-height:15px;text-align:left;vertical-align:middle;"><nobr>'.$busnessName.'</nobr></td>
                    <td></td>
                </tr>
                <tr style="vertical-align:top;">
                    <td style="width:0px;height:23px;"></td>
                    <td></td>
                    <td class="cs8A513397" colspan="6" style="width:434px;height:23px;line-height:15px;text-align:left;vertical-align:middle;"><nobr>RCCM&nbsp;'.$rccEse.'.&nbsp;ID&nbsp;NAT&nbsp;'.$idNatEse.'</nobr></td>
                    <td></td>
                </tr>
                <tr style="vertical-align:top;">
                    <td style="width:0px;height:22px;"></td>
                    <td></td>
                    <td class="cs8A513397" colspan="6" style="width:434px;height:22px;line-height:15px;text-align:left;vertical-align:middle;"><nobr>N&#176;&nbsp;'.$numImpotEse.'</nobr></td>
                    <td></td>
                </tr>
                <tr style="vertical-align:top;">
                    <td style="width:0px;height:22px;"></td>
                    <td></td>
                    <td class="cs6105B8F3" colspan="6" style="width:434px;height:22px;line-height:15px;text-align:left;vertical-align:middle;"><nobr>'.$adresseEse.'</nobr></td>
                    <td></td>
                </tr>
                <tr style="vertical-align:top;">
                    <td style="width:0px;height:22px;"></td>
                    <td></td>
                    <td class="cs6105B8F3" colspan="6" style="width:434px;height:22px;line-height:15px;text-align:left;vertical-align:middle;"><nobr>E-mail&nbsp;:&nbsp;'.$emailEse.'</nobr></td>
                    <td></td>
                    <td></td>
                    <td></td>
                </tr>
                <tr style="vertical-align:top;">
                    <td style="width:0px;height:22px;"></td>
                    <td></td>
                    <td class="cs6105B8F3" colspan="6" style="width:434px;height:22px;line-height:15px;text-align:left;vertical-align:middle;"><nobr>Site-web&nbsp;:&nbsp;'.$siteEse.'</nobr></td>
                    <td></td>
                    <td></td>
                    <td></td>
                </tr>
                <tr style="vertical-align:top;">
                    <td style="width:0px;height:22px;"></td>
                    <td></td>
                    <td class="cs8A513397" colspan="6" style="width:434px;height:22px;line-height:15px;text-align:left;vertical-align:middle;"><nobr>Tel&#233;phone&nbsp;:&nbsp;'.$Tel1Ese.' - '.$Tel2Ese.'</nobr></td>
                    <td></td>
                    <td></td>
                    <td></td>
                </tr>
                <tr style="vertical-align:top;">
                    <td style="width:0px;height:11px;"></td>
                    <td></td>
                    <td></td>
                    <td></td>
                    <td></td>
                    <td></td>
                    <td></td>
                    <td></td>
                    <td></td>
                    <td></td>
                    <td></td>
                </tr>
                <tr style="vertical-align:top;">
                    <td style="width:0px;height:22px;"></td>
                    <td></td>
                    <td></td>
                    <td></td>
                    <td></td>
                    <td class="cs5EA817F2" colspan="2" style="width:202px;height:22px;line-height:15px;text-align:center;vertical-align:middle;"><nobr>Du&nbsp;'.$date1.'&nbsp;&nbsp;au&nbsp;&nbsp;'.$date2.'</nobr></td>
                    <td></td>
                    <td></td>
                    <td></td>
                    <td></td>
                </tr>
                <tr style="vertical-align:top;">
                    <td style="width:0px;height:14px;"></td>
                    <td></td>
                    <td></td>
                    <td></td>
                    <td></td>
                    <td></td>
                    <td></td>
                    <td></td>
                    <td></td>
                    <td></td>
                    <td></td>
                </tr>
                <tr style="vertical-align:top;">
                    <td style="width:0px;height:24px;"></td>
                    <td></td>
                    <td class="cs275E312D" style="width:52px;height:22px;line-height:15px;text-align:center;vertical-align:middle;"><nobr>DATE</nobr></td>
                    <td class="csAB3AA82A" style="width:68px;height:22px;line-height:15px;text-align:center;vertical-align:middle;"><nobr>COMPTE</nobr></td>
                    <td class="csAB3AA82A" colspan="5" style="width:349px;height:22px;line-height:15px;text-align:center;vertical-align:middle;"><nobr>CATEGORIE</nobr></td>
                    <td class="csAB3AA82A" style="width:96px;height:22px;line-height:15px;text-align:center;vertical-align:middle;"><nobr>MONTANT</nobr></td>
                    <td></td>
                </tr>
                ';
                                                                
                    $output .= $this->showMouvementCompteProduit($date1,$date2,$refService); 
                                                                
                $output.='
                <tr style="vertical-align:top;">
                    <td style="width:0px;height:24px;"></td>
                    <td></td>
                    <td class="cs275E312D" colspan="2" style="width:121px;height:22px;line-height:15px;text-align:center;vertical-align:middle;"><nobr>Total</nobr></td>
                    <td class="csAB3AA82A" colspan="6" style="width:446px;height:22px;line-height:15px;text-align:center;vertical-align:middle;"><nobr>'.$totalVente.'$</nobr></td>
                    <td></td>
                </tr>
            </table>
            </body>
            </html>

            '; 

                return $output;

        }   

function showMouvementCompteProduit($date1,$date2,$refService)
{
    $data = DB::table('tvente_detail_vente') 
    ->join('tvente_produit','tvente_produit.id','=','tvente_detail_vente.refProduit')
    ->join('tvente_categorie_produit','tvente_categorie_produit.id','=','tvente_produit.refCategorie')

    ->join('tvente_entete_vente','tvente_entete_vente.id','=','tvente_detail_vente.refEnteteVente')        
    ->join('tvente_module','tvente_module.id','=','tvente_entete_vente.module_id')
    ->join('tvente_services','tvente_services.id','=','tvente_entete_vente.refService')
    ->join('tvente_client','tvente_client.id','=','tvente_entete_vente.refClient')
    ->join('tfin_ssouscompte as comptevariation','comptevariation.id','=','tvente_detail_vente.compte_variationstock')

    ->select(DB::raw('IFNULL(ROUND(SUM(qteVente * puVente),0),0) as totalVente,nom_ssouscompte,numero_ssouscompte'))
    ->where([               
        ['dateVente','>=', $date1],
        ['dateVente','<=', $date2],
        ['tvente_entete_vente.refService','=', $refService]                
    ])
    ->groupBy('comptevariation.nom_ssouscompte','comptevariation.numero_ssouscompte')
    ->get();

    $output='';

    foreach ($data as $row) 
    {


        $output .='
            <tr style="vertical-align:top;">
                <td style="width:0px;height:24px;"></td>
                <td></td>
                <td class="csE5AC9E0D" style="width:52px;height:22px;line-height:12px;text-align:center;vertical-align:middle;"><nobr></nobr></td>
                <td class="cs3B0DD49A" style="width:68px;height:22px;line-height:12px;text-align:center;vertical-align:middle;">'.$row->numero_ssouscompte.'</td>
                <td class="cs3B0DD49A" colspan="5" style="width:349px;height:22px;line-height:12px;text-align:center;vertical-align:middle;">'.$row->nom_ssouscompte.'</td>
                <td class="cs3B0DD49A" style="width:96px;height:22px;line-height:12px;text-align:center;vertical-align:middle;"><nobr>'.$row->totalVente.'$</nobr></td>
                <td></td>
            </tr>
        ';
       
    }

    return $output;

}


//========================= POUR LES ENTREES

function pdf_fiche_mouvement_comptes_entree(Request $request)
{

    if ($request->get('date1') && $request->get('date2') && $request->get('refService')) 
    {
        $date1 = $request->get('date1');
        $date2 = $request->get('date2');
        $refService = $request->get('refService');

        $html = $this->getInfoMouvementCompteProduitEntree($date1,$date2,$refService);
        $pdf = \App::make('dompdf.wrapper');

        $pdf->loadHTML($html);
        $pdf->loadHTML($html)->setPaper('a4', 'landscape');
        return $pdf->stream();
        
    }
    else{

    }   
    
}
function getInfoMouvementCompteProduitEntree($date1,$date2,$refService)
{
           //Info Entreprise
           $nomEse='';
           $adresseEse='';
           $Tel1Ese='';
           $Tel2Ese='';
           $siteEse='';
           $emailEse='';
           $idNatEse='';
           $numImpotEse='';
           $rccEse='';
           $siege='';
           $busnessName='';
           $pic='';
           $pic2 = $this->displayImg("fichier", 'logo.png');
           $logo='';
   
           $data1 = DB::table('entreprises')
           ->join('secteurs','secteurs.id','=','entreprises.idsecteur')
           ->join('forme_juridiques','forme_juridiques.id','=','entreprises.idforme')
   
           ->join('pays','pays.id','=','entreprises.idPays')
           ->join('provinces','provinces.id','=','entreprises.idProvince')
           ->join('users','users.id','=','entreprises.ceo')        
           ->select('entreprises.id as id','entreprises.id as idEntreprise',
           'entreprises.ceo','entreprises.nomEntreprise','entreprises.descriptionEntreprise',
           'entreprises.emailEntreprise','entreprises.adresseEntreprise',
           'entreprises.telephoneEntreprise','entreprises.solutionEntreprise','entreprises.idsecteur',
           'entreprises.idforme','entreprises.etat',
           'entreprises.idPays','entreprises.idProvince','entreprises.edition','entreprises.facebook',
           'entreprises.linkedin','entreprises.twitter','entreprises.siteweb','entreprises.rccm',
           'entreprises.invPersonnel','entreprises.invHub','entreprises.invRecherche',
           'entreprises.chiffreAffaire','entreprises.nbremploye','entreprises.slug','entreprises.logo',
               //forme
               'forme_juridiques.nomForme','secteurs.nomSecteur',
               //users
               'users.name','users.email','users.avatar','users.telephone','users.adresse',
               //
               'provinces.nomProvince','pays.nomPays', 'entreprises.created_at')
           ->first();
           if ($data1) 
           {                                
               $nomEse=$data1->nomEntreprise;
               $adresseEse=$data1->adresseEntreprise;
               $Tel1Ese=$data1->telephoneEntreprise;
               $Tel2Ese=$data1->telephone;
               $siteEse=$data1->siteweb;
               $emailEse=$data1->emailEntreprise;
               $idNatEse=$data1->rccm;
               $numImpotEse=$data1->rccm;
               $busnessName=$data1->nomSecteur;
               $rccmEse=$data1->rccm;
               $pic = $this->displayImg("fichier", 'logo.png');
               $siege=$data1->nomForme;         
           }
            $Montant=0;
            $nom_service='';

            $data_service = DB::table("tvente_services")
            ->select("tvente_services.id","tvente_services.nom_service","tvente_services.created_at","status",
            'tvente_services.active')
            ->where([
               ['tvente_services.id','=', $refService]
           ])      
           ->first(); 
           if ($data_service) 
           {
              $nom_service=$data_service->nom_service;                 
           }   

            $totalEntree = 0;
            $data_entree = DB::table('tvente_detail_entree') 
            ->join('tvente_produit','tvente_produit.id','=','tvente_detail_entree.refProduit')
            ->join('tvente_categorie_produit','tvente_categorie_produit.id','=','tvente_produit.refCategorie')
    
            ->join('tvente_entete_entree','tvente_entete_entree.id','=','tvente_detail_entree.refEnteteEntree')        
            ->join('tvente_services','tvente_services.id','=','tvente_entete_entree.refService')
            ->join('tfin_ssouscompte as comptevariation','comptevariation.id','=','tvente_detail_entree.compte_variationstock')
            ->select(DB::raw('IFNULL(ROUND(SUM(qteEntree * puEntree),0),0) as totalEntree'))
            ->where([               
                ['dateEntree','>=', $date1],
                ['dateEntree','<=', $date2],
                ['tvente_entete_entree.refService','=', $refService]                
            ])               
            ->first();
            if ($data_entree) 
            {                                
               $totalEntree=$data_entree->totalEntree;                           
            }       

            $output=' 

            <!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Transitional//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd">
            <!-- saved from url=(0016)http://localhost -->
            <html>
            <head>
                <title>rptReleveCompte</title>
                <meta HTTP-EQUIV="Content-Type" CONTENT="text/html; charset=utf-8"/>
                <style type="text/css">
                    .csE5AC9E0D {color:#000000;background-color:transparent;border-left:#000000 1px solid;border-top:#000000 1px solid;border-right:#000000 1px solid;border-bottom:#000000 1px solid;font-family:Times New Roman; font-size:11px; font-weight:normal; font-style:normal; }
                    .cs275E312D {color:#000000;background-color:transparent;border-left:#000000 1px solid;border-top:#000000 1px solid;border-right:#000000 1px solid;border-bottom:#000000 1px solid;font-family:Times New Roman; font-size:13px; font-weight:bold; font-style:normal; }
                    .cs3B0DD49A {color:#000000;background-color:transparent;border-left-style: none;border-top:#000000 1px solid;border-right:#000000 1px solid;border-bottom:#000000 1px solid;font-family:Times New Roman; font-size:11px; font-weight:normal; font-style:normal; }
                    .csAB3AA82A {color:#000000;background-color:transparent;border-left-style: none;border-top:#000000 1px solid;border-right:#000000 1px solid;border-bottom:#000000 1px solid;font-family:Times New Roman; font-size:13px; font-weight:bold; font-style:normal; }
                    .cs8A513397 {color:#000000;background-color:transparent;border-left-style: none;border-top-style: none;border-right-style: none;border-bottom-style: none;font-family:Times New Roman; font-size:13px; font-weight:bold; font-style:normal; padding-left:2px;}
                    .cs101A94F7 {color:#000000;background-color:transparent;border-left-style: none;border-top-style: none;border-right-style: none;border-bottom-style: none;font-family:Times New Roman; font-size:13px; font-weight:normal; font-style:normal; }
                    .cs6105B8F3 {color:#000000;background-color:transparent;border-left-style: none;border-top-style: none;border-right-style: none;border-bottom-style: none;font-family:Times New Roman; font-size:13px; font-weight:normal; font-style:normal; padding-left:2px;}
                    .cs5EA817F2 {color:#000000;background-color:transparent;border-left-style: none;border-top-style: none;border-right-style: none;border-bottom-style: none;font-family:Times New Roman; font-size:13px; font-weight:normal; font-style:normal; padding-left:2px;padding-right:2px;}
                    .cs739196BC {color:#5C5C5C;background-color:transparent;border-left-style: none;border-top-style: none;border-right-style: none;border-bottom-style: none;font-family:Segoe UI; font-size:11px; font-weight:normal; font-style:normal; }
                    .csF7D3565D {height:0px;width:0px;overflow:hidden;font-size:0px;line-height:0px;}
                </style>
            </head>
            <body leftMargin=10 topMargin=10 rightMargin=10 bottomMargin=10 style="background-color:#FFFFFF">
            <table cellpadding="0" cellspacing="0" border="0" style="border-width:0px;empty-cells:show;width:614px;height:322px;position:relative;">
                <tr>
                    <td style="width:0px;height:0px;"></td>
                    <td style="height:0px;width:10px;"></td>
                    <td style="height:0px;width:54px;"></td>
                    <td style="height:0px;width:69px;"></td>
                    <td style="height:0px;width:79px;"></td>
                    <td style="height:0px;width:197px;"></td>
                    <td style="height:0px;width:9px;"></td>
                    <td style="height:0px;width:28px;"></td>
                    <td style="height:0px;width:37px;"></td>
                    <td style="height:0px;width:97px;"></td>
                    <td style="height:0px;width:34px;"></td>
                </tr>
                <tr style="vertical-align:top;">
                    <td style="width:0px;height:23px;"></td>
                    <td class="cs739196BC" colspan="5" style="width:409px;height:23px;line-height:14px;text-align:center;vertical-align:middle;"></td>
                    <td></td>
                    <td></td>
                    <td></td>
                    <td></td>
                    <td></td>
                </tr>
                <tr style="vertical-align:top;">
                    <td style="width:0px;height:3px;"></td>
                    <td></td>
                    <td></td>
                    <td></td>
                    <td></td>
                    <td></td>
                    <td></td>
                    <td></td>
                    <td></td>
                    <td></td>
                    <td></td>
                </tr>
                <tr style="vertical-align:top;">
                    <td style="width:0px;height:22px;"></td>
                    <td></td>
                    <td class="cs8A513397" colspan="6" style="width:434px;height:22px;line-height:15px;text-align:left;vertical-align:middle;"><nobr>'.$nomEse.'</nobr></td>
                    <td></td>
                    <td class="cs101A94F7" colspan="2" rowspan="5" style="width:131px;height:111px;text-align:left;vertical-align:top;"><div style="overflow:hidden;width:131px;height:111px;">
                        <img alt="" src="'.$pic2.'" style="width:131px;height:111px;" /></div>
                    </td>
                </tr>
                <tr style="vertical-align:top;">
                    <td style="width:0px;height:22px;"></td>
                    <td></td>
                    <td class="cs6105B8F3" colspan="6" style="width:434px;height:22px;line-height:15px;text-align:left;vertical-align:middle;"><nobr>'.$busnessName.'</nobr></td>
                    <td></td>
                </tr>
                <tr style="vertical-align:top;">
                    <td style="width:0px;height:23px;"></td>
                    <td></td>
                    <td class="cs8A513397" colspan="6" style="width:434px;height:23px;line-height:15px;text-align:left;vertical-align:middle;"><nobr>RCCM&nbsp;'.$rccEse.'.&nbsp;ID&nbsp;NAT&nbsp;'.$idNatEse.'</nobr></td>
                    <td></td>
                </tr>
                <tr style="vertical-align:top;">
                    <td style="width:0px;height:22px;"></td>
                    <td></td>
                    <td class="cs8A513397" colspan="6" style="width:434px;height:22px;line-height:15px;text-align:left;vertical-align:middle;"><nobr>N&#176;&nbsp;'.$numImpotEse.'</nobr></td>
                    <td></td>
                </tr>
                <tr style="vertical-align:top;">
                    <td style="width:0px;height:22px;"></td>
                    <td></td>
                    <td class="cs6105B8F3" colspan="6" style="width:434px;height:22px;line-height:15px;text-align:left;vertical-align:middle;"><nobr>'.$adresseEse.'</nobr></td>
                    <td></td>
                </tr>
                <tr style="vertical-align:top;">
                    <td style="width:0px;height:22px;"></td>
                    <td></td>
                    <td class="cs6105B8F3" colspan="6" style="width:434px;height:22px;line-height:15px;text-align:left;vertical-align:middle;"><nobr>E-mail&nbsp;:&nbsp;'.$emailEse.'</nobr></td>
                    <td></td>
                    <td></td>
                    <td></td>
                </tr>
                <tr style="vertical-align:top;">
                    <td style="width:0px;height:22px;"></td>
                    <td></td>
                    <td class="cs6105B8F3" colspan="6" style="width:434px;height:22px;line-height:15px;text-align:left;vertical-align:middle;"><nobr>Site-web&nbsp;:&nbsp;'.$siteEse.'</nobr></td>
                    <td></td>
                    <td></td>
                    <td></td>
                </tr>
                <tr style="vertical-align:top;">
                    <td style="width:0px;height:22px;"></td>
                    <td></td>
                    <td class="cs8A513397" colspan="6" style="width:434px;height:22px;line-height:15px;text-align:left;vertical-align:middle;"><nobr>Tel&#233;phone&nbsp;:&nbsp;'.$Tel1Ese.' - '.$Tel2Ese.'</nobr></td>
                    <td></td>
                    <td></td>
                    <td></td>
                </tr>
                <tr style="vertical-align:top;">
                    <td style="width:0px;height:11px;"></td>
                    <td></td>
                    <td></td>
                    <td></td>
                    <td></td>
                    <td></td>
                    <td></td>
                    <td></td>
                    <td></td>
                    <td></td>
                    <td></td>
                </tr>
                <tr style="vertical-align:top;">
                    <td style="width:0px;height:22px;"></td>
                    <td></td>
                    <td></td>
                    <td></td>
                    <td></td>
                    <td class="cs5EA817F2" colspan="2" style="width:202px;height:22px;line-height:15px;text-align:center;vertical-align:middle;"><nobr>Du&nbsp;'.$date1.'&nbsp;&nbsp;au&nbsp;&nbsp;'.$date2.'</nobr></td>
                    <td></td>
                    <td></td>
                    <td></td>
                    <td></td>
                </tr>
                <tr style="vertical-align:top;">
                    <td style="width:0px;height:14px;"></td>
                    <td></td>
                    <td></td>
                    <td></td>
                    <td></td>
                    <td></td>
                    <td></td>
                    <td></td>
                    <td></td>
                    <td></td>
                    <td></td>
                </tr>
                <tr style="vertical-align:top;">
                    <td style="width:0px;height:24px;"></td>
                    <td></td>
                    <td class="cs275E312D" style="width:52px;height:22px;line-height:15px;text-align:center;vertical-align:middle;"><nobr>DATE</nobr></td>
                    <td class="csAB3AA82A" style="width:68px;height:22px;line-height:15px;text-align:center;vertical-align:middle;"><nobr>COMPTE</nobr></td>
                    <td class="csAB3AA82A" colspan="5" style="width:349px;height:22px;line-height:15px;text-align:center;vertical-align:middle;"><nobr>CATEGORIE</nobr></td>
                    <td class="csAB3AA82A" style="width:96px;height:22px;line-height:15px;text-align:center;vertical-align:middle;"><nobr>MONTANT</nobr></td>
                    <td></td>
                </tr>
                ';
                                                                
                    $output .= $this->showMouvementCompteProduitEntree($date1,$date2,$refService); 
                                                                
                $output.='
                <tr style="vertical-align:top;">
                    <td style="width:0px;height:24px;"></td>
                    <td></td>
                    <td class="cs275E312D" colspan="2" style="width:121px;height:22px;line-height:15px;text-align:center;vertical-align:middle;"><nobr>Total</nobr></td>
                    <td class="csAB3AA82A" colspan="6" style="width:446px;height:22px;line-height:15px;text-align:center;vertical-align:middle;"><nobr>'.$totalEntree.'$</nobr></td>
                    <td></td>
                </tr>
            </table>
            </body>
            </html>

            '; 

                return $output;

        }   

function showMouvementCompteProduitEntree($date1,$date2,$refService)
{
    $data = DB::table('tvente_detail_entree') 
    ->join('tvente_produit','tvente_produit.id','=','tvente_detail_entree.refProduit')
    ->join('tvente_categorie_produit','tvente_categorie_produit.id','=','tvente_produit.refCategorie')

    ->join('tvente_entete_entree','tvente_entete_entree.id','=','tvente_detail_entree.refEnteteEntree')        
    ->join('tvente_module','tvente_module.id','=','tvente_entete_entree.module_id')
    ->join('tvente_services','tvente_services.id','=','tvente_entete_entree.refService')
    ->join('tfin_ssouscompte as comptevariation','comptevariation.id','=','tvente_detail_entree.compte_variationstock')

    ->select(DB::raw('IFNULL(ROUND(SUM(qteEntree * puEntree),0),0) as totalEntree,nom_ssouscompte,numero_ssouscompte'))
    ->where([               
        ['dateEntree','>=', $date1],
        ['dateEntree','<=', $date2],
        ['tvente_entete_entree.refService','=', $refService]                
    ])
    ->groupBy('comptevariation.nom_ssouscompte','comptevariation.numero_ssouscompte')
    ->get();

    $output='';

    foreach ($data as $row) 
    {


        $output .='
            <tr style="vertical-align:top;">
                <td style="width:0px;height:24px;"></td>
                <td></td>
                <td class="csE5AC9E0D" style="width:52px;height:22px;line-height:12px;text-align:center;vertical-align:middle;"><nobr></nobr></td>
                <td class="cs3B0DD49A" style="width:68px;height:22px;line-height:12px;text-align:center;vertical-align:middle;">'.$row->numero_ssouscompte.'</td>
                <td class="cs3B0DD49A" colspan="5" style="width:349px;height:22px;line-height:12px;text-align:center;vertical-align:middle;">'.$row->nom_ssouscompte.'</td>
                <td class="cs3B0DD49A" style="width:96px;height:22px;line-height:12px;text-align:center;vertical-align:middle;"><nobr>'.$row->totalEntree.'$</nobr></td>
                <td></td>
            </tr>
        ';
       
    }

    return $output;

}

//=============Paiement des Fournisseurs===========================================================================================



public function fetch_rapport_entete_facture_cmd_date(Request $request)
{
    //

    if ($request->get('date1') && $request->get('date2')) {
        // code...
        $date1 = $request->get('date1');
        $date2 = $request->get('date2');

        $html ='<html><head><meta http-equiv="Content-Type" content="text/html; charset=utf-8"/>';
        $html .= $this->printRapportEnteteFactureCommande($date1, $date2);       
        $html .='<script>window.print()</script>';
        echo($html);             

    } else {
        // code...
    }
    
    
}
function printRapportEnteteFactureCommande($date1, $date2)
{

         //Info Entreprise
        $nomEse='';
        $adresseEse='';
        $Tel1Ese='';
        $Tel2Ese='';
        $siteEse='';
        $emailEse='';
        $idNatEse='';
        $numImpotEse='';
        $rccEse='';
        $siege='';
        $busnessName='';
        $pic='';
        $pic2 = $this->displayImg("fichier", 'logo.png');
        $logo='';

        $data1 = DB::table('entreprises')
        ->join('secteurs','secteurs.id','=','entreprises.idsecteur')
        ->join('forme_juridiques','forme_juridiques.id','=','entreprises.idforme')

        ->join('pays','pays.id','=','entreprises.idPays')
        ->join('provinces','provinces.id','=','entreprises.idProvince')
        ->join('users','users.id','=','entreprises.ceo')        
        ->select('entreprises.id as id','entreprises.id as idEntreprise',
        'entreprises.ceo','entreprises.nomEntreprise','entreprises.descriptionEntreprise',
        'entreprises.emailEntreprise','entreprises.adresseEntreprise',
        'entreprises.telephoneEntreprise','entreprises.solutionEntreprise','entreprises.idsecteur',
        'entreprises.idforme','entreprises.etat',
        'entreprises.idPays','entreprises.idProvince','entreprises.edition','entreprises.facebook',
        'entreprises.linkedin','entreprises.twitter','entreprises.siteweb','entreprises.rccm',
        'entreprises.invPersonnel','entreprises.invHub','entreprises.invRecherche',
        'entreprises.chiffreAffaire','entreprises.nbremploye','entreprises.slug','entreprises.logo',
            //forme
            'forme_juridiques.nomForme','secteurs.nomSecteur',
            //users
            'users.name','users.email','users.avatar','users.telephone','users.adresse',
            //
            'provinces.nomProvince','pays.nomPays', 'entreprises.created_at')
        ->first();
        if ($data1) 
        {                                
            $nomEse=$data1->nomEntreprise;
            $adresseEse=$data1->adresseEntreprise;
            $Tel1Ese=$data1->telephoneEntreprise;
            $Tel2Ese=$data1->telephone;
            $siteEse=$data1->siteweb;
            $emailEse=$data1->emailEntreprise;
            $idNatEse=$data1->rccm;
            $numImpotEse=$data1->rccm;
            $busnessName=$data1->nomSecteur;
            $rccmEse=$data1->rccm;
            $pic = $this->displayImg("fichier", 'logo.png');
            $siege=$data1->nomForme;         
        }

         $totalFact=0;
         $totalPaie=0;
         $totalReste=0;
                 
         //
         $data2 = DB::table('tvente_entete_requisition') 
         ->selectRaw('ROUND(SUM( IFNULL(montant,0)),2) as TotalFacture')
         ->selectRaw('ROUND(SUM( IFNULL(paie,0)),2) as TotalPaie')
         ->selectRaw('ROUND(SUM(IFNULL((IFNULL(montant,0) - IFNULL(paie,0)),0)),2) as TotalReste')
         ->where([
            ['dateCmd','>=', $date1],
            ['dateCmd','<=', $date2]
        ])    
         ->first(); 
         $output='';
         if ($data2) 
         {                                
            $totalFact=$data2->TotalFacture;
            $totalPaie=$data2->TotalPaie;
            $totalReste=$data2->TotalReste;
                           
         }

           

        $output='<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Transitional//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd">
        <!-- saved from url=(0016)http://localhost -->
        <html>
        <head>
            <title>rpt_RapportSynthese</title>
            <meta HTTP-EQUIV="Content-Type" CONTENT="text/html; charset=utf-8"/>
            <style type="text/css">
                .csB6F858D0 {color:#000000;background-color:#D6E5F4;border-left-style: none;border-top-style: none;border-right-style: none;border-bottom-style: none;font-family:Times New Roman; font-size:24px; font-weight:bold; font-style:normal; padding-left:2px;padding-right:2px;}
                .cs9FE9304F {color:#000000;background-color:#E0E0E0;border-left-style: none;border-top:#000000 1px solid;border-right:#000000 1px solid;border-bottom:#000000 1px solid;font-family:Times New Roman; font-size:13px; font-weight:bold; font-style:normal; }
                .csEAC52FCD {color:#000000;background-color:#E0E0E0;border-left-style: none;border-top:#000000 1px solid;border-right-style: none;border-bottom:#000000 1px solid;font-family:Times New Roman; font-size:13px; font-weight:bold; font-style:normal; }
                .cs56F73198 {color:#000000;background-color:transparent;border-left:#000000 1px solid;border-top:#000000 1px solid;border-right:#000000 1px solid;border-bottom:#000000 1px solid;font-family:Times New Roman; font-size:16px; font-weight:normal; font-style:normal; padding-left:2px;}
                .cs6E02D7D2 {color:#000000;background-color:transparent;border-left-style: none;border-top:#000000 1px solid;border-right:#000000 1px solid;border-bottom:#000000 1px solid;font-family:Times New Roman; font-size:14px; font-weight:normal; font-style:normal; }
                .cs6C28398D {color:#000000;background-color:transparent;border-left-style: none;border-top:#000000 1px solid;border-right-style: none;border-bottom:#000000 1px solid;font-family:Times New Roman; font-size:14px; font-weight:normal; font-style:normal; }
                .cs612ED82F {color:#000000;background-color:transparent;border-left-style: none;border-top-style: none;border-right-style: none;border-bottom-style: none;font-family:Times New Roman; font-size:12px; font-weight:bold; font-style:normal; padding-left:2px;}
                .csFFC1C457 {color:#000000;background-color:transparent;border-left-style: none;border-top-style: none;border-right-style: none;border-bottom-style: none;font-family:Times New Roman; font-size:12px; font-weight:normal; font-style:normal; padding-left:2px;}
                .cs101A94F7 {color:#000000;background-color:transparent;border-left-style: none;border-top-style: none;border-right-style: none;border-bottom-style: none;font-family:Times New Roman; font-size:13px; font-weight:normal; font-style:normal; }
                .csCE72709D {color:#000000;background-color:transparent;border-left-style: none;border-top-style: none;border-right-style: none;border-bottom-style: none;font-family:Times New Roman; font-size:14px; font-weight:bold; font-style:normal; padding-left:2px;}
                .cs12FE94AA {color:#000000;background-color:transparent;border-left-style: none;border-top-style: none;border-right-style: none;border-bottom-style: none;font-family:Times New Roman; font-size:14px; font-weight:normal; font-style:normal; padding-left:2px;}
                .csFBB219FE {color:#000000;background-color:transparent;border-left-style: none;border-top-style: none;border-right-style: none;border-bottom-style: none;font-family:Times New Roman; font-size:18px; font-weight:bold; font-style:normal; padding-left:2px;}
                .cs739196BC {color:#5C5C5C;background-color:transparent;border-left-style: none;border-top-style: none;border-right-style: none;border-bottom-style: none;font-family:Segoe UI; font-size:11px; font-weight:normal; font-style:normal; }
                .csF7D3565D {height:0px;width:0px;overflow:hidden;font-size:0px;line-height:0px;}
            </style>
        </head>
        <body leftMargin=10 topMargin=10 rightMargin=10 bottomMargin=10 style="background-color:#FFFFFF">
        <table cellpadding="0" cellspacing="0" border="0" style="border-width:0px;empty-cells:show;width:909px;height:383px;position:relative;">
            <tr>
                <td style="width:0px;height:0px;"></td>
                <td style="height:0px;width:10px;"></td>
                <td style="height:0px;width:102px;"></td>
                <td style="height:0px;width:36px;"></td>
                <td style="height:0px;width:71px;"></td>
                <td style="height:0px;width:124px;"></td>
                <td style="height:0px;width:66px;"></td>
                <td style="height:0px;width:42px;"></td>
                <td style="height:0px;width:129px;"></td>
                <td style="height:0px;width:114px;"></td>
                <td style="height:0px;width:40px;"></td>
                <td style="height:0px;width:43px;"></td>
                <td style="height:0px;width:30px;"></td>
                <td style="height:0px;width:102px;"></td>
            </tr>
            <tr style="vertical-align:top;">
                <td style="width:0px;height:23px;"></td>
                <td></td>
                <td></td>
                <td></td>
                <td></td>
                <td></td>
                <td></td>
                <td></td>
                <td></td>
            </tr>
            <tr style="vertical-align:top;">
                <td style="width:0px;height:9px;"></td>
                <td></td>
                <td></td>
                <td></td>
                <td></td>
                <td></td>
                <td></td>
                <td></td>
                <td></td>
                <td></td>
                <td></td>
                <td></td>
                <td></td>
                <td></td>
            </tr>
            <tr style="vertical-align:top;">
                <td style="width:0px;height:23px;"></td>
                <td></td>
                <td class="csFBB219FE" colspan="8" style="width:682px;height:23px;line-height:21px;text-align:left;vertical-align:middle;"><nobr>'.$nomEse.'</nobr></td>
                <td></td>
                <td class="cs101A94F7" colspan="3" rowspan="7" style="width:175px;height:144px;text-align:left;vertical-align:top;"><div style="overflow:hidden;width:175px;height:144px;">
                   <img alt="" src="'.$pic2.'" style="width:175px;height:144px;" /></div>
                </td>
            </tr>
            <tr style="vertical-align:top;">
                <td style="width:0px;height:22px;"></td>
                <td></td>
                <td class="csCE72709D" colspan="8" style="width:682px;height:22px;line-height:15px;text-align:left;vertical-align:middle;"><nobr>'.$busnessName.'</nobr></td>
                <td></td>
            </tr>
            <tr style="vertical-align:top;">
                <td style="width:0px;height:22px;"></td>
                <td></td>
                <td class="csCE72709D" colspan="8" style="width:682px;height:22px;line-height:15px;text-align:left;vertical-align:middle;"><nobr>RCCM'.$rccEse.'.&nbsp;ID-NAT.'.$idNatEse.'</nobr></td>
                <td></td>
            </tr>
            <tr style="vertical-align:top;">
                <td style="width:0px;height:22px;"></td>
                <td></td>
                <td class="csFFC1C457" colspan="8" style="width:682px;height:22px;line-height:13px;text-align:left;vertical-align:middle;">'.$adresseEse.'</td>
                <td></td>
            </tr>
            <tr style="vertical-align:top;">
                <td style="width:0px;height:22px;"></td>
                <td></td>
                <td class="csFFC1C457" colspan="8" style="width:682px;height:22px;line-height:13px;text-align:left;vertical-align:middle;"><nobr>Email&nbsp;:&nbsp;'.$emailEse.'</nobr></td>
                <td></td>
            </tr>
            <tr style="vertical-align:top;">
                <td style="width:0px;height:22px;"></td>
                <td></td>
                <td class="csFFC1C457" colspan="8" style="width:682px;height:22px;line-height:13px;text-align:left;vertical-align:middle;"><nobr>Site&nbsp;web&nbsp;:&nbsp;'.$siteEse.'</nobr></td>
                <td></td>
            </tr>
            <tr style="vertical-align:top;">
                <td style="width:0px;height:11px;"></td>
                <td></td>
                <td class="cs612ED82F" colspan="8" rowspan="2" style="width:682px;height:23px;line-height:13px;text-align:left;vertical-align:middle;"><nobr>T&#233;l&#233;phone&nbsp;:&nbsp;'.$Tel1Ese.'&nbsp;&nbsp;24h/24</nobr></td>
                <td></td>
            </tr>
            <tr style="vertical-align:top;">
                <td style="width:0px;height:12px;"></td>
                <td></td>
                <td></td>
                <td></td>
                <td></td>
                <td></td>
            </tr>
            <tr style="vertical-align:top;">
                <td style="width:0px;height:8px;"></td>
                <td></td>
                <td></td>
                <td></td>
                <td></td>
                <td></td>
                <td></td>
                <td></td>
                <td></td>
                <td></td>
                <td></td>
                <td></td>
                <td></td>
                <td></td>
            </tr>
            <tr style="vertical-align:top;">
                <td style="width:0px;height:32px;"></td>
                <td></td>
                <td></td>
                <td></td>
                <td class="csB6F858D0" colspan="8" style="width:625px;height:32px;line-height:28px;text-align:center;vertical-align:middle;"><nobr>RAPPORT DES FACTURES DES FOURNISSEURS</nobr></td>
                <td></td>
                <td></td>
            </tr>
            <tr style="vertical-align:top;">
                <td style="width:0px;height:19px;"></td>
                <td></td>
                <td></td>
                <td></td>
                <td></td>
                <td></td>
                <td></td>
                <td></td>
                <td></td>
                <td></td>
                <td></td>
                <td></td>
                <td></td>
                <td></td>
            </tr>
            <tr style="vertical-align:top;">
                <td style="width:0px;height:23px;"></td>
                <td></td>
                <td class="cs56F73198" colspan="4" style="width:329px;height:21px;line-height:18px;text-align:left;vertical-align:top;"><nobr>&nbsp;PERIODE&nbsp;:&nbsp;&nbsp;Du&nbsp;&nbsp;'.$date1.'&nbsp;&nbsp;au&nbsp;'.$date2.'</nobr></td>
                <td class="cs56F73198" colspan="8" style="width:562px;height:21px;line-height:18px;text-align:left;vertical-align:top;"><nobr>DEPARTEMENT</nobr></td>
            </tr>
            <tr style="vertical-align:top;">
                <td style="width:0px;height:9px;"></td>
                <td></td>
                <td></td>
                <td></td>
                <td></td>
                <td></td>
                <td></td>
                <td></td>
                <td></td>
                <td></td>
                <td></td>
                <td></td>
                <td></td>
                <td></td>
            </tr>
            <tr style="vertical-align:top;">
                <td style="width:0px;height:24px;"></td>
                <td></td>
                <td class="cs9FE9304F" style="width:101px;height:22px;line-height:15px;text-align:center;vertical-align:middle;"><nobr>N&#176;&nbsp;FACTURE</nobr></td>
                <td class="cs9FE9304F" colspan="3" style="width:230px;height:22px;line-height:15px;text-align:center;vertical-align:middle;"><nobr>FOURNISSEUR</nobr></td>
                <td class="cs9FE9304F" colspan="2" style="width:107px;height:22px;line-height:15px;text-align:center;vertical-align:middle;"><nobr>DATE&nbsp;FACTURE</nobr></td>
                <td class="cs9FE9304F" style="width:128px;height:22px;line-height:15px;text-align:center;vertical-align:middle;"><nobr>TOTAL&nbsp;FACTURE($)</nobr></td>
                <td class="cs9FE9304F" style="width:113px;height:22px;line-height:15px;text-align:center;vertical-align:middle;"><nobr>TOTAL&nbsp;PAIE($)</nobr></td>
                <td class="cs9FE9304F" colspan="3" style="width:112px;height:22px;line-height:15px;text-align:center;vertical-align:middle;"><nobr>RESTE($)</nobr></td>
                <td class="csEAC52FCD" style="width:102px;height:22px;line-height:15px;text-align:center;vertical-align:middle;"><nobr>OBS</nobr></td>
            </tr>
            ';

            $output .= $this->showDetailFacturationCommande($date1,$date2); 

            $output.='
            <tr style="vertical-align:top;">
                <td style="width:0px;height:24px;"></td>
                <td></td>
                <td class="cs9FE9304F" colspan="6" style="width:440px;height:22px;line-height:15px;text-align:center;vertical-align:middle;"><nobr>TOTAL&nbsp;($)&nbsp;:</nobr></td>
                <td class="cs9FE9304F" style="width:128px;height:22px;line-height:15px;text-align:center;vertical-align:middle;">'.$totalFact.'$</td>
                <td class="cs9FE9304F" style="width:113px;height:22px;line-height:15px;text-align:center;vertical-align:middle;">'.$totalPaie.'$</td>
                <td class="cs9FE9304F" colspan="3" style="width:112px;height:22px;line-height:15px;text-align:center;vertical-align:middle;">'.$totalReste.'$</td>
                <td class="csEAC52FCD" style="width:102px;height:22px;"><!--[if lte IE 7]><div class="csF7D3565D"></div><![endif]--></td>
            </tr>
            <tr style="vertical-align:top;">
                <td style="width:0px;height:10px;"></td>
                <td></td>
                <td></td>
                <td></td>
                <td></td>
                <td></td>
                <td></td>
                <td></td>
                <td></td>
                <td></td>
                <td></td>
                <td></td>
                <td></td>
                <td></td>
            </tr>
            <tr style="vertical-align:top;">
                <td style="width:0px;height:22px;"></td>
                <td></td>
                <td class="cs12FE94AA" colspan="3" style="width:207px;height:22px;line-height:16px;text-align:left;vertical-align:top;"><nobr>Fait&nbsp;&#224;&nbsp;Goma&nbsp;le&nbsp;&nbsp;'.date('Y-m-d').'</nobr></td>
                <td></td>
                <td></td>
                <td></td>
                <td></td>
                <td></td>
                <td></td>
                <td></td>
                <td></td>
                <td></td>
            </tr>
        </table>
        </body>
        </html>';  
       
        return $output; 

}
function showDetailFacturationCommande($date1, $date2)
{
    $data = DB::table('tvente_entete_requisition')
    ->join('tvente_module','tvente_module.id','=','tvente_entete_requisition.module_id')
    ->join('tvente_services','tvente_services.id','=','tvente_entete_requisition.refService')
    ->join('tvente_fournisseur','tvente_fournisseur.id','=','tvente_entete_requisition.refFournisseur')
    ->join('tvente_categorie_fournisseur','tvente_categorie_fournisseur.id','=','tvente_fournisseur.refCategorieFss')
    ->join('tfin_ssouscompte','tfin_ssouscompte.id','=','tvente_categorie_fournisseur.compte_fss_bl')
    ->join('tfin_souscompte','tfin_souscompte.id','=','tfin_ssouscompte.refSousCompte')
    ->join('tfin_compte','tfin_compte.id','=','tfin_souscompte.refCompte')
    ->join('tfin_classe','tfin_classe.id','=','tfin_compte.refClasse')
    ->join('tfin_typecompte','tfin_typecompte.id','=','tfin_compte.refTypecompte')
    ->join('tfin_typeposition','tfin_typeposition.id','=','tfin_compte.refPosition')
    ->select('tvente_entete_requisition.id','tvente_entete_requisition.code','refFournisseur','module_id',
    'refService','dateCmd','libelle','cloture',
    'niveau1','niveaumax','tvente_entete_requisition.active','montant','paie','tvente_entete_requisition.author','tvente_entete_requisition.refUser',
    'tvente_entete_requisition.created_at',"tvente_fournisseur.noms","tvente_fournisseur.contact",
    "tvente_fournisseur.mail","tvente_fournisseur.adresse",'refCategorieFss', "tvente_categorie_fournisseur.nom_categoriefss",
    "compte_fss_bl",'refSousCompte','nom_ssouscompte','numero_ssouscompte','nom_souscompte','numero_souscompte','refCompte','nom_compte',
    'numero_compte','refClasse','refTypecompte','refPosition','nom_classe','numero_classe','nom_typeposition',"nom_typecompte"
    ,"tvente_module.nom_module","tvente_services.nom_service")
    ->selectRaw('CONCAT("F",YEAR(dateCmd),"",MONTH(dateCmd),"00",tvente_entete_requisition.id) as codeFacture')
    ->selectRaw(' IFNULL(montant,0) as totalFacture')
    ->selectRaw(' IFNULL(paie,0) as totalPaie')
    ->selectRaw('(IFNULL((IFNULL(montant,0) - IFNULL(paie,0)),0)) as RestePaie')
    ->selectRaw('TIMESTAMPDIFF(DAY, dateCmd, CURDATE()) as nombreJr')
    ->where([
        ['dateCmd','>=', $date1],
        ['dateCmd','<=', $date2]
    ])
    ->orderBy("tvente_entete_requisition.created_at", "asc")
    ->get();

    $output='';

    foreach ($data as $row) 
    {
        $output .='
        <tr style="vertical-align:top;">
		<td style="width:0px;height:24px;"></td>
		<td></td>
		<td class="cs6E02D7D2" style="width:101px;height:22px;line-height:15px;text-align:center;vertical-align:middle;"><nobr>'.$row->codeFacture.'</nobr></td>
		<td class="cs6E02D7D2" colspan="3" style="width:230px;height:22px;line-height:15px;text-align:left;vertical-align:middle;">'.$row->noms.'</td>
		<td class="cs6E02D7D2" colspan="2" style="width:107px;height:22px;line-height:15px;text-align:center;vertical-align:middle;">'.$row->dateCmd.'</td>
		<td class="cs6E02D7D2" style="width:128px;height:22px;line-height:15px;text-align:center;vertical-align:middle;">'.$row->totalFacture.'$</td>
		<td class="cs6E02D7D2" style="width:113px;height:22px;line-height:15px;text-align:center;vertical-align:middle;">'.$row->totalPaie.'$</td>
		<td class="cs6E02D7D2" colspan="3" style="width:112px;height:22px;line-height:15px;text-align:center;vertical-align:middle;">'.$row->RestePaie.'$</td>
		<td class="cs6C28398D" style="width:102px;height:22px;line-height:15px;text-align:center;vertical-align:middle;"><nobr>'.$row->nombreJr.'J</nobr></td>
	</tr>
        ';     
        
   
    }

    return $output;

}


public function fetch_rapport_entete_facture_date_fournisseur(Request $request)
{
    //refDepartement

    if ($request->get('date1') && $request->get('date2')&& $request->get('refFournisseur')) {
        // code...
        $date1 = $request->get('date1');
        $date2 = $request->get('date2');
        $refFournisseur = $request->get('refFournisseur');
        
        $html = $this->printRapportEnteteFacture_Fournisseur($date1, $date2,$refFournisseur);
        $pdf = \App::make('dompdf.wrapper');
        // echo($html);
        // $pdf->loadHTML($html);
        $pdf->loadHTML($html)->setPaper('a4', 'landscape');
        return $pdf->stream();            

    } else {
        // code...
    }  
    
}
function printRapportEnteteFacture_Fournisseur($date1, $date2,$refFournisseur)
{

         //Info Entreprise
        $nomEse='';
        $adresseEse='';
        $Tel1Ese='';
        $Tel2Ese='';
        $siteEse='';
        $emailEse='';
        $idNatEse='';
        $numImpotEse='';
        $rccEse='';
        $siege='';
        $busnessName='';
        $pic='';
        $pic2 = $this->displayImg("fichier", 'logo.png');
        $logo='';

        $data1 = DB::table('entreprises')
        ->join('secteurs','secteurs.id','=','entreprises.idsecteur')
        ->join('forme_juridiques','forme_juridiques.id','=','entreprises.idforme')

        ->join('pays','pays.id','=','entreprises.idPays')
        ->join('provinces','provinces.id','=','entreprises.idProvince')
        ->join('users','users.id','=','entreprises.ceo')        
        ->select('entreprises.id as id','entreprises.id as idEntreprise',
        'entreprises.ceo','entreprises.nomEntreprise','entreprises.descriptionEntreprise',
        'entreprises.emailEntreprise','entreprises.adresseEntreprise',
        'entreprises.telephoneEntreprise','entreprises.solutionEntreprise','entreprises.idsecteur',
        'entreprises.idforme','entreprises.etat',
        'entreprises.idPays','entreprises.idProvince','entreprises.edition','entreprises.facebook',
        'entreprises.linkedin','entreprises.twitter','entreprises.siteweb','entreprises.rccm',
        'entreprises.invPersonnel','entreprises.invHub','entreprises.invRecherche',
        'entreprises.chiffreAffaire','entreprises.nbremploye','entreprises.slug','entreprises.logo',
            //forme
            'forme_juridiques.nomForme','secteurs.nomSecteur',
            //users
            'users.name','users.email','users.avatar','users.telephone','users.adresse',
            //
            'provinces.nomProvince','pays.nomPays', 'entreprises.created_at')
        ->first();
        if ($data1) 
        {                                
            $nomEse=$data1->nomEntreprise;
            $adresseEse=$data1->adresseEntreprise;
            $Tel1Ese=$data1->telephoneEntreprise;
            $Tel2Ese=$data1->telephone;
            $siteEse=$data1->siteweb;
            $emailEse=$data1->emailEntreprise;
            $idNatEse=$data1->rccm;
            $numImpotEse=$data1->rccm;
            $busnessName=$data1->nomSecteur;
            $rccmEse=$data1->rccm;
            $pic = $this->displayImg("fichier", 'logo.png');
            $siege=$data1->nomForme;         
        }


         $totalFact=0;
         $totalPaie=0;
         $totalReste=0;
                 
         //
         $data2 = DB::table('tvente_entete_requisition') 
         ->selectRaw('ROUND(SUM( IFNULL(montant,0)),2) as TotalFacture')
         ->selectRaw('ROUND(SUM( IFNULL(paie,0)),2) as TotalPaie')
         ->selectRaw('ROUND(SUM(IFNULL((IFNULL(montant,0) - IFNULL(paie,0)),0)),2) as TotalReste')
         ->where([
            ['dateCmd','>=', $date1],
            ['dateCmd','<=', $date2],
            ['refFournisseur','=', $refFournisseur]
        ])    
         ->first(); 
         $output='';
         if ($data2) 
         {                                
            $totalFact=$data2->TotalFacture;
            $totalPaie=$data2->TotalPaie;
            $totalReste=$data2->TotalReste;                           
         }

         $nom_departement='';
         $code_departement='';

         $data3= DB::table('tvente_fournisseur') 
         ->select('id','refCategorieFss','noms','contact','mail','adresse','author')
         ->where([
            ['tvente_fournisseur.id','=', $refFournisseur]
        ])      
        ->first();      
        $output='';
        if ($data3) 
        {
            $nom_departement=$data3->noms; 
            $code_departement='';              
        }



           

        $output='<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Transitional//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd">
        <!-- saved from url=(0016)http://localhost -->
        <html>
        <head>
            <title>rpt_RapportSynthese</title>
            <meta HTTP-EQUIV="Content-Type" CONTENT="text/html; charset=utf-8"/>
            <style type="text/css">
                .csB6F858D0 {color:#000000;background-color:#D6E5F4;border-left-style: none;border-top-style: none;border-right-style: none;border-bottom-style: none;font-family:Times New Roman; font-size:24px; font-weight:bold; font-style:normal; padding-left:2px;padding-right:2px;}
                .cs9FE9304F {color:#000000;background-color:#E0E0E0;border-left-style: none;border-top:#000000 1px solid;border-right:#000000 1px solid;border-bottom:#000000 1px solid;font-family:Times New Roman; font-size:13px; font-weight:bold; font-style:normal; }
                .csEAC52FCD {color:#000000;background-color:#E0E0E0;border-left-style: none;border-top:#000000 1px solid;border-right-style: none;border-bottom:#000000 1px solid;font-family:Times New Roman; font-size:13px; font-weight:bold; font-style:normal; }
                .cs56F73198 {color:#000000;background-color:transparent;border-left:#000000 1px solid;border-top:#000000 1px solid;border-right:#000000 1px solid;border-bottom:#000000 1px solid;font-family:Times New Roman; font-size:16px; font-weight:normal; font-style:normal; padding-left:2px;}
                .cs6E02D7D2 {color:#000000;background-color:transparent;border-left-style: none;border-top:#000000 1px solid;border-right:#000000 1px solid;border-bottom:#000000 1px solid;font-family:Times New Roman; font-size:14px; font-weight:normal; font-style:normal; }
                .cs6C28398D {color:#000000;background-color:transparent;border-left-style: none;border-top:#000000 1px solid;border-right-style: none;border-bottom:#000000 1px solid;font-family:Times New Roman; font-size:14px; font-weight:normal; font-style:normal; }
                .cs612ED82F {color:#000000;background-color:transparent;border-left-style: none;border-top-style: none;border-right-style: none;border-bottom-style: none;font-family:Times New Roman; font-size:12px; font-weight:bold; font-style:normal; padding-left:2px;}
                .csFFC1C457 {color:#000000;background-color:transparent;border-left-style: none;border-top-style: none;border-right-style: none;border-bottom-style: none;font-family:Times New Roman; font-size:12px; font-weight:normal; font-style:normal; padding-left:2px;}
                .cs101A94F7 {color:#000000;background-color:transparent;border-left-style: none;border-top-style: none;border-right-style: none;border-bottom-style: none;font-family:Times New Roman; font-size:13px; font-weight:normal; font-style:normal; }
                .csCE72709D {color:#000000;background-color:transparent;border-left-style: none;border-top-style: none;border-right-style: none;border-bottom-style: none;font-family:Times New Roman; font-size:14px; font-weight:bold; font-style:normal; padding-left:2px;}
                .cs12FE94AA {color:#000000;background-color:transparent;border-left-style: none;border-top-style: none;border-right-style: none;border-bottom-style: none;font-family:Times New Roman; font-size:14px; font-weight:normal; font-style:normal; padding-left:2px;}
                .csFBB219FE {color:#000000;background-color:transparent;border-left-style: none;border-top-style: none;border-right-style: none;border-bottom-style: none;font-family:Times New Roman; font-size:18px; font-weight:bold; font-style:normal; padding-left:2px;}
                .cs739196BC {color:#5C5C5C;background-color:transparent;border-left-style: none;border-top-style: none;border-right-style: none;border-bottom-style: none;font-family:Segoe UI; font-size:11px; font-weight:normal; font-style:normal; }
                .csF7D3565D {height:0px;width:0px;overflow:hidden;font-size:0px;line-height:0px;}
            </style>
        </head>
        <body leftMargin=10 topMargin=10 rightMargin=10 bottomMargin=10 style="background-color:#FFFFFF">
        <table cellpadding="0" cellspacing="0" border="0" style="border-width:0px;empty-cells:show;width:909px;height:383px;position:relative;">
            <tr>
                <td style="width:0px;height:0px;"></td>
                <td style="height:0px;width:10px;"></td>
                <td style="height:0px;width:102px;"></td>
                <td style="height:0px;width:36px;"></td>
                <td style="height:0px;width:71px;"></td>
                <td style="height:0px;width:124px;"></td>
                <td style="height:0px;width:66px;"></td>
                <td style="height:0px;width:42px;"></td>
                <td style="height:0px;width:129px;"></td>
                <td style="height:0px;width:114px;"></td>
                <td style="height:0px;width:40px;"></td>
                <td style="height:0px;width:43px;"></td>
                <td style="height:0px;width:30px;"></td>
                <td style="height:0px;width:102px;"></td>
            </tr>
            <tr style="vertical-align:top;">
                <td style="width:0px;height:23px;"></td>
                <td></td>
                <td></td>
                <td></td>
                <td></td>
                <td></td>
                <td></td>
                <td></td>
                <td></td>
            </tr>
            <tr style="vertical-align:top;">
                <td style="width:0px;height:9px;"></td>
                <td></td>
                <td></td>
                <td></td>
                <td></td>
                <td></td>
                <td></td>
                <td></td>
                <td></td>
                <td></td>
                <td></td>
                <td></td>
                <td></td>
                <td></td>
            </tr>
            <tr style="vertical-align:top;">
                <td style="width:0px;height:23px;"></td>
                <td></td>
                <td class="csFBB219FE" colspan="8" style="width:682px;height:23px;line-height:21px;text-align:left;vertical-align:middle;"><nobr>'.$nomEse.'</nobr></td>
                <td></td>
                <td class="cs101A94F7" colspan="3" rowspan="7" style="width:175px;height:144px;text-align:left;vertical-align:top;"><div style="overflow:hidden;width:175px;height:144px;">
                   <img alt="" src="'.$pic2.'" style="width:175px;height:144px;" /></div>
                </td>
            </tr>
            <tr style="vertical-align:top;">
                <td style="width:0px;height:22px;"></td>
                <td></td>
                <td class="csCE72709D" colspan="8" style="width:682px;height:22px;line-height:15px;text-align:left;vertical-align:middle;"><nobr>'.$busnessName.'</nobr></td>
                <td></td>
            </tr>
            <tr style="vertical-align:top;">
                <td style="width:0px;height:22px;"></td>
                <td></td>
                <td class="csCE72709D" colspan="8" style="width:682px;height:22px;line-height:15px;text-align:left;vertical-align:middle;"><nobr>RCCM'.$rccEse.'.&nbsp;ID-NAT.'.$idNatEse.'</nobr></td>
                <td></td>
            </tr>
            <tr style="vertical-align:top;">
                <td style="width:0px;height:22px;"></td>
                <td></td>
                <td class="csFFC1C457" colspan="8" style="width:682px;height:22px;line-height:13px;text-align:left;vertical-align:middle;">'.$adresseEse.'</td>
                <td></td>
            </tr>
            <tr style="vertical-align:top;">
                <td style="width:0px;height:22px;"></td>
                <td></td>
                <td class="csFFC1C457" colspan="8" style="width:682px;height:22px;line-height:13px;text-align:left;vertical-align:middle;"><nobr>Email&nbsp;:&nbsp;'.$emailEse.'</nobr></td>
                <td></td>
            </tr>
            <tr style="vertical-align:top;">
                <td style="width:0px;height:22px;"></td>
                <td></td>
                <td class="csFFC1C457" colspan="8" style="width:682px;height:22px;line-height:13px;text-align:left;vertical-align:middle;"><nobr>Site&nbsp;web&nbsp;:&nbsp;'.$siteEse.'</nobr></td>
                <td></td>
            </tr>
            <tr style="vertical-align:top;">
                <td style="width:0px;height:11px;"></td>
                <td></td>
                <td class="cs612ED82F" colspan="8" rowspan="2" style="width:682px;height:23px;line-height:13px;text-align:left;vertical-align:middle;"><nobr>T&#233;l&#233;phone&nbsp;:&nbsp;'.$Tel1Ese.'&nbsp;&nbsp;24h/24</nobr></td>
                <td></td>
            </tr>
            <tr style="vertical-align:top;">
                <td style="width:0px;height:12px;"></td>
                <td></td>
                <td></td>
                <td></td>
                <td></td>
                <td></td>
            </tr>
            <tr style="vertical-align:top;">
                <td style="width:0px;height:8px;"></td>
                <td></td>
                <td></td>
                <td></td>
                <td></td>
                <td></td>
                <td></td>
                <td></td>
                <td></td>
                <td></td>
                <td></td>
                <td></td>
                <td></td>
                <td></td>
            </tr>
            <tr style="vertical-align:top;">
                <td style="width:0px;height:32px;"></td>
                <td></td>
                <td></td>
                <td></td>
                <td class="csB6F858D0" colspan="8" style="width:625px;height:32px;line-height:28px;text-align:center;vertical-align:middle;"><nobr>RAPPORT DES FACTURES DES FOURNISSEURS PAR FSS. </nobr></td>
                <td></td>
                <td></td>
            </tr>
            <tr style="vertical-align:top;">
                <td style="width:0px;height:19px;"></td>
                <td></td>
                <td></td>
                <td></td>
                <td></td>
                <td></td>
                <td></td>
                <td></td>
                <td></td>
                <td></td>
                <td></td>
                <td></td>
                <td></td>
                <td></td>
            </tr>
            <tr style="vertical-align:top;">
                <td style="width:0px;height:23px;"></td>
                <td></td>
                <td class="cs56F73198" colspan="4" style="width:329px;height:21px;line-height:18px;text-align:left;vertical-align:top;"><nobr>&nbsp;PERIODE&nbsp;:&nbsp;&nbsp;Du&nbsp;&nbsp;'.$date1.'&nbsp;&nbsp;au&nbsp;'.$date2.'</nobr></td>
                <td class="cs56F73198" colspan="8" style="width:562px;height:21px;line-height:18px;text-align:left;vertical-align:top;"><nobr>'.$nom_departement.'</nobr></td>
            </tr>
            <tr style="vertical-align:top;">
                <td style="width:0px;height:9px;"></td>
                <td></td>
                <td></td>
                <td></td>
                <td></td>
                <td></td>
                <td></td>
                <td></td>
                <td></td>
                <td></td>
                <td></td>
                <td></td>
                <td></td>
                <td></td>
            </tr>
            <tr style="vertical-align:top;">
                <td style="width:0px;height:24px;"></td>
                <td></td>
                <td class="cs9FE9304F" style="width:101px;height:22px;line-height:15px;text-align:center;vertical-align:middle;"><nobr>N&#176;&nbsp;FACTURE</nobr></td>
                <td class="cs9FE9304F" colspan="3" style="width:230px;height:22px;line-height:15px;text-align:center;vertical-align:middle;"><nobr>FOURNISSEUR</nobr></td>
                <td class="cs9FE9304F" colspan="2" style="width:107px;height:22px;line-height:15px;text-align:center;vertical-align:middle;"><nobr>DATE&nbsp;FACTURE</nobr></td>
                <td class="cs9FE9304F" style="width:128px;height:22px;line-height:15px;text-align:center;vertical-align:middle;"><nobr>TOTAL&nbsp;FACTURE($)</nobr></td>
                <td class="cs9FE9304F" style="width:113px;height:22px;line-height:15px;text-align:center;vertical-align:middle;"><nobr>TOTAL&nbsp;PAIE($)</nobr></td>
                <td class="cs9FE9304F" colspan="3" style="width:112px;height:22px;line-height:15px;text-align:center;vertical-align:middle;"><nobr>RESTE($)</nobr></td>
                <td class="csEAC52FCD" style="width:102px;height:22px;line-height:15px;text-align:center;vertical-align:middle;"><nobr>OBS</nobr></td>
            </tr>
            ';

            $output .= $this->showDetailFacturationCommande_Fournisseur($date1,$date2,$refFournisseur); 

            $output.='
            <tr style="vertical-align:top;">
                <td style="width:0px;height:24px;"></td>
                <td></td>
                <td class="cs9FE9304F" colspan="6" style="width:440px;height:22px;line-height:15px;text-align:center;vertical-align:middle;"><nobr>TOTAL&nbsp;($)&nbsp;:</nobr></td>
                <td class="cs9FE9304F" style="width:128px;height:22px;line-height:15px;text-align:center;vertical-align:middle;">'.$totalFact.'$</td>
                <td class="cs9FE9304F" style="width:113px;height:22px;line-height:15px;text-align:center;vertical-align:middle;">'.$totalPaie.'$</td>
                <td class="cs9FE9304F" colspan="3" style="width:112px;height:22px;line-height:15px;text-align:center;vertical-align:middle;">'.$totalReste.'$</td>
                <td class="csEAC52FCD" style="width:102px;height:22px;"><!--[if lte IE 7]><div class="csF7D3565D"></div><![endif]--></td>
            </tr>
            <tr style="vertical-align:top;">
                <td style="width:0px;height:10px;"></td>
                <td></td>
                <td></td>
                <td></td>
                <td></td>
                <td></td>
                <td></td>
                <td></td>
                <td></td>
                <td></td>
                <td></td>
                <td></td>
                <td></td>
                <td></td>
            </tr>
            <tr style="vertical-align:top;">
                <td style="width:0px;height:22px;"></td>
                <td></td>
                <td class="cs12FE94AA" colspan="3" style="width:207px;height:22px;line-height:16px;text-align:left;vertical-align:top;"><nobr>Fait&nbsp;&#224;&nbsp;Goma&nbsp;le&nbsp;&nbsp;'.date('Y-m-d').'</nobr></td>
                <td></td>
                <td></td>
                <td></td>
                <td></td>
                <td></td>
                <td></td>
                <td></td>
                <td></td>
                <td></td>
            </tr>
        </table>
        </body>
        </html>';  
       
        return $output; 

}
function showDetailFacturationCommande_Fournisseur($date1,$date2,$refFournisseur)
{
        $data = DB::table('tvente_entete_requisition')
        ->join('tvente_module','tvente_module.id','=','tvente_entete_requisition.module_id')
        ->join('tvente_services','tvente_services.id','=','tvente_entete_requisition.refService')
        ->join('tvente_fournisseur','tvente_fournisseur.id','=','tvente_entete_requisition.refFournisseur')
        ->join('tvente_categorie_fournisseur','tvente_categorie_fournisseur.id','=','tvente_fournisseur.refCategorieFss')
        ->join('tfin_ssouscompte','tfin_ssouscompte.id','=','tvente_categorie_fournisseur.compte_fss_bl')
        ->join('tfin_souscompte','tfin_souscompte.id','=','tfin_ssouscompte.refSousCompte')
        ->join('tfin_compte','tfin_compte.id','=','tfin_souscompte.refCompte')
        ->join('tfin_classe','tfin_classe.id','=','tfin_compte.refClasse')
        ->join('tfin_typecompte','tfin_typecompte.id','=','tfin_compte.refTypecompte')
        ->join('tfin_typeposition','tfin_typeposition.id','=','tfin_compte.refPosition')
        ->select('tvente_entete_requisition.id','tvente_entete_requisition.code','refFournisseur','module_id',
        'refService','dateCmd','libelle','cloture',
        'niveau1','niveaumax','tvente_entete_requisition.active','montant','paie','tvente_entete_requisition.author','tvente_entete_requisition.refUser',
        'tvente_entete_requisition.created_at',"tvente_fournisseur.noms","tvente_fournisseur.contact",
        "tvente_fournisseur.mail","tvente_fournisseur.adresse",'refCategorieFss', "tvente_categorie_fournisseur.nom_categoriefss",
        "compte_fss_bl",'refSousCompte','nom_ssouscompte','numero_ssouscompte','nom_souscompte','numero_souscompte','refCompte','nom_compte',
        'numero_compte','refClasse','refTypecompte','refPosition','nom_classe','numero_classe','nom_typeposition',"nom_typecompte"
        ,"tvente_module.nom_module","tvente_services.nom_service")
        ->selectRaw('CONCAT("F",YEAR(dateCmd),"",MONTH(dateCmd),"00",tvente_entete_requisition.id) as codeFacture')
        ->selectRaw(' IFNULL(montant,0) as totalFacture')
        ->selectRaw(' IFNULL(paie,0) as totalPaie')
        ->selectRaw('(IFNULL((IFNULL(montant,0) - IFNULL(paie,0)),0)) as RestePaie') 
        ->selectRaw('TIMESTAMPDIFF(DAY, dateCmd, CURDATE()) as nombreJr')
        ->where([
            ['dateCmd','>=', $date1],
            ['dateCmd','<=', $date2],
            ['refFournisseur','=', $refFournisseur]
        ])
        ->orderBy("tvente_entete_requisition.created_at", "asc")
        ->get();
        $output='';

        foreach ($data as $row) 
        {
            $output .='
            <tr style="vertical-align:top;">
            <td style="width:0px;height:24px;"></td>
            <td></td>
            <td class="cs6E02D7D2" style="width:101px;height:22px;line-height:15px;text-align:center;vertical-align:middle;"><nobr>'.$row->codeFacture.'</nobr></td>
            <td class="cs6E02D7D2" colspan="3" style="width:230px;height:22px;line-height:15px;text-align:left;vertical-align:middle;">'.$row->noms.'</td>
            <td class="cs6E02D7D2" colspan="2" style="width:107px;height:22px;line-height:15px;text-align:center;vertical-align:middle;">'.$row->dateCmd.'</td>
            <td class="cs6E02D7D2" style="width:128px;height:22px;line-height:15px;text-align:center;vertical-align:middle;">'.$row->totalFacture.'$</td>
            <td class="cs6E02D7D2" style="width:113px;height:22px;line-height:15px;text-align:center;vertical-align:middle;">'.$row->totalPaie.'$</td>
            <td class="cs6E02D7D2" colspan="3" style="width:112px;height:22px;line-height:15px;text-align:center;vertical-align:middle;">'.$row->RestePaie.'$</td>
            <td class="cs6C28398D" style="width:102px;height:22px;line-height:15px;text-align:center;vertical-align:middle;"><nobr>'.$row->nombreJr.'J</nobr></td>
        </tr>
            '; 
           
   
    }

    return $output;

}




//===================== SOLDE DES FOURNISSEURS =================================================================================


public function fetch_rapport_solde_facture_date_fournisseur(Request $request)
{
    //refDepartement

    if ($request->get('date1') && $request->get('date2')) {
        // code...
        $date1 = $request->get('date1');
        $date2 = $request->get('date2');
        
        // $html = $this->printRapportSoldeFacture_Fournisseur($date1, $date2);
        // $pdf = \App::make('dompdf.wrapper');
        // // echo($html);
        // // $pdf->loadHTML($html);
        // $pdf->loadHTML($html)->setPaper('a4', 'landscape');
        // return $pdf->stream();     
        
        

        $html ='<html><head><meta http-equiv="Content-Type" content="text/html; charset=utf-8"/>';
        $html .= $this->printRapportSoldeFacture_Fournisseur($date1, $date2);       
        $html .='<script>window.print()</script>';

        echo($html);  

    } else {
        // code...
    }  
    
}

function printRapportSoldeFacture_Fournisseur($date1, $date2)
{

         //Info Entreprise
        $nomEse='';
        $adresseEse='';
        $Tel1Ese='';
        $Tel2Ese='';
        $siteEse='';
        $emailEse='';
        $idNatEse='';
        $numImpotEse='';
        $rccEse='';
        $siege='';
        $busnessName='';
        $pic='';
        $pic2 = $this->displayImg("fichier", 'logo.png');
        $logo='';

        $data1 = DB::table('entreprises')
        ->join('secteurs','secteurs.id','=','entreprises.idsecteur')
        ->join('forme_juridiques','forme_juridiques.id','=','entreprises.idforme')

        ->join('pays','pays.id','=','entreprises.idPays')
        ->join('provinces','provinces.id','=','entreprises.idProvince')
        ->join('users','users.id','=','entreprises.ceo')        
        ->select('entreprises.id as id','entreprises.id as idEntreprise',
        'entreprises.ceo','entreprises.nomEntreprise','entreprises.descriptionEntreprise',
        'entreprises.emailEntreprise','entreprises.adresseEntreprise',
        'entreprises.telephoneEntreprise','entreprises.solutionEntreprise','entreprises.idsecteur',
        'entreprises.idforme','entreprises.etat',
        'entreprises.idPays','entreprises.idProvince','entreprises.edition','entreprises.facebook',
        'entreprises.linkedin','entreprises.twitter','entreprises.siteweb','entreprises.rccm',
        'entreprises.invPersonnel','entreprises.invHub','entreprises.invRecherche',
        'entreprises.chiffreAffaire','entreprises.nbremploye','entreprises.slug','entreprises.logo',
            //forme
            'forme_juridiques.nomForme','secteurs.nomSecteur',
            //users
            'users.name','users.email','users.avatar','users.telephone','users.adresse',
            //
            'provinces.nomProvince','pays.nomPays', 'entreprises.created_at')
        ->first();
        if ($data1) 
        {                                
            $nomEse=$data1->nomEntreprise;
            $adresseEse=$data1->adresseEntreprise;
            $Tel1Ese=$data1->telephoneEntreprise;
            $Tel2Ese=$data1->telephone;
            $siteEse=$data1->siteweb;
            $emailEse=$data1->emailEntreprise;
            $idNatEse=$data1->rccm;
            $numImpotEse=$data1->rccm;
            $busnessName=$data1->nomSecteur;
            $rccmEse=$data1->rccm;
            $pic = $this->displayImg("fichier", 'logo.png');
            $siege=$data1->nomForme;         
        }        

        $output='
       <!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Transitional//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd">
        <!-- saved from url=(0016)http://localhost -->
        <html>
        <head>
            <title>rpt_SoldeFournisseurs</title>
            <meta HTTP-EQUIV="Content-Type" CONTENT="text/html; charset=utf-8"/>
            <style type="text/css">
                .cs275E312D {color:#000000;background-color:transparent;border-left:#000000 1px solid;border-top:#000000 1px solid;border-right:#000000 1px solid;border-bottom:#000000 1px solid;font-family:Times New Roman; font-size:13px; font-weight:bold; font-style:normal; }
                .csE71035DC {color:#000000;background-color:transparent;border-left:#000000 1px solid;border-top:#000000 1px solid;border-right:#000000 1px solid;border-bottom:#000000 1px solid;font-family:Times New Roman; font-size:13px; font-weight:normal; font-style:normal; }
                .csAB3AA82A {color:#000000;background-color:transparent;border-left-style: none;border-top:#000000 1px solid;border-right:#000000 1px solid;border-bottom:#000000 1px solid;font-family:Times New Roman; font-size:13px; font-weight:bold; font-style:normal; }
                .cs82D98BB6 {color:#000000;background-color:transparent;border-left-style: none;border-top:#000000 1px solid;border-right:#000000 1px solid;border-bottom:#000000 1px solid;font-family:Times New Roman; font-size:13px; font-weight:normal; font-style:normal; }
                .cs8A513397 {color:#000000;background-color:transparent;border-left-style: none;border-top-style: none;border-right-style: none;border-bottom-style: none;font-family:Times New Roman; font-size:13px; font-weight:bold; font-style:normal; padding-left:2px;}
                .cs101A94F7 {color:#000000;background-color:transparent;border-left-style: none;border-top-style: none;border-right-style: none;border-bottom-style: none;font-family:Times New Roman; font-size:13px; font-weight:normal; font-style:normal; }
                .cs6105B8F3 {color:#000000;background-color:transparent;border-left-style: none;border-top-style: none;border-right-style: none;border-bottom-style: none;font-family:Times New Roman; font-size:13px; font-weight:normal; font-style:normal; padding-left:2px;}
                .cs5EA817F2 {color:#000000;background-color:transparent;border-left-style: none;border-top-style: none;border-right-style: none;border-bottom-style: none;font-family:Times New Roman; font-size:13px; font-weight:normal; font-style:normal; padding-left:2px;padding-right:2px;}
                .cs2C853136 {color:#000000;background-color:transparent;border-left-style: none;border-top-style: none;border-right-style: none;border-bottom-style: none;font-family:Times New Roman; font-size:19px; font-weight:bold; font-style:normal; padding-left:2px;padding-right:2px;}
                .cs739196BC {color:#5C5C5C;background-color:transparent;border-left-style: none;border-top-style: none;border-right-style: none;border-bottom-style: none;font-family:Segoe UI; font-size:11px; font-weight:normal; font-style:normal; }
                .csF7D3565D {height:0px;width:0px;overflow:hidden;font-size:0px;line-height:0px;}
            </style>
        </head>
        <body leftMargin=10 topMargin=10 rightMargin=10 bottomMargin=10 style="background-color:#FFFFFF">
        <table cellpadding="0" cellspacing="0" border="0" style="border-width:0px;empty-cells:show;width:886px;height:392px;position:relative;">
            <tr>
                <td style="width:0px;height:0px;"></td>
                <td style="height:0px;width:10px;"></td>
                <td style="height:0px;width:70px;"></td>
                <td style="height:0px;width:30px;"></td>
                <td style="height:0px;width:178px;"></td>
                <td style="height:0px;width:100px;"></td>
                <td style="height:0px;width:21px;"></td>
                <td style="height:0px;width:85px;"></td>
                <td style="height:0px;width:14px;"></td>
                <td style="height:0px;width:101px;"></td>
                <td style="height:0px;width:45px;"></td>
                <td style="height:0px;width:6px;"></td>
                <td style="height:0px;width:51px;"></td>
                <td style="height:0px;width:44px;"></td>
                <td style="height:0px;width:58px;"></td>
                <td style="height:0px;width:73px;"></td>
            </tr>
            <tr style="vertical-align:top;">
                <td style="width:0px;height:23px;"></td>
                <td class="cs739196BC" colspan="6" style="width:409px;height:23px;line-height:14px;text-align:center;vertical-align:middle;"></td>
                <td></td>
                <td></td>
                <td></td>
                <td></td>
                <td></td>
                <td></td>
                <td></td>
                <td></td>
                <td></td>
            </tr>
            <tr style="vertical-align:top;">
                <td style="width:0px;height:10px;"></td>
                <td></td>
                <td></td>
                <td></td>
                <td></td>
                <td></td>
                <td></td>
                <td></td>
                <td></td>
                <td></td>
                <td></td>
                <td></td>
                <td></td>
                <td></td>
                <td></td>
                <td></td>
            </tr>
            <tr style="vertical-align:top;">
                <td style="width:0px;height:22px;"></td>
                <td></td>
                <td class="cs8A513397" colspan="10" style="width:648px;height:22px;line-height:15px;text-align:left;vertical-align:middle;"><nobr>'.$nomEse.'</nobr></td>
                <td></td>
                <td></td>
                <td class="cs101A94F7" colspan="2" rowspan="5" style="width:131px;height:110px;text-align:left;vertical-align:top;"><div style="overflow:hidden;width:131px;height:110px;"><img alt="" src="'.$pic2.'" style="width:131px;height:110px;" /></div>
                </td>
            </tr>
            <tr style="vertical-align:top;">
                <td style="width:0px;height:22px;"></td>
                <td></td>
                <td class="cs6105B8F3" colspan="10" style="width:648px;height:22px;line-height:15px;text-align:left;vertical-align:middle;"><nobr>'.$busnessName.'</nobr></td>
                <td></td>
                <td></td>
            </tr>
            <tr style="vertical-align:top;">
                <td style="width:0px;height:22px;"></td>
                <td></td>
                <td class="cs8A513397" colspan="10" style="width:648px;height:22px;line-height:15px;text-align:left;vertical-align:middle;"><nobr>RCCM'.$rccEse.'.&nbsp;ID-NAT.'.$idNatEse.'</nobr></td>
                <td></td>
                <td></td>
            </tr>
            <tr style="vertical-align:top;">
                <td style="width:0px;height:22px;"></td>
                <td></td>
                <td class="cs8A513397" colspan="10" style="width:648px;height:22px;line-height:15px;text-align:left;vertical-align:middle;"><nobr>N&#176;&nbsp;'.$numImpotEse.'</nobr></td>
                <td></td>
                <td></td>
            </tr>
            <tr style="vertical-align:top;">
                <td style="width:0px;height:22px;"></td>
                <td></td>
                <td class="cs6105B8F3" colspan="10" style="width:648px;height:22px;line-height:15px;text-align:left;vertical-align:middle;"><nobr>'.$adresseEse.'</nobr></td>
                <td></td>
                <td></td>
            </tr>
            <tr style="vertical-align:top;">
                <td style="width:0px;height:22px;"></td>
                <td></td>
                <td class="cs6105B8F3" colspan="10" style="width:648px;height:22px;line-height:15px;text-align:left;vertical-align:middle;"><nobr>E-mail&nbsp;:&nbsp;'.$emailEse.'</nobr></td>
                <td></td>
                <td></td>
                <td></td>
                <td></td>
            </tr>
            <tr style="vertical-align:top;">
                <td style="width:0px;height:22px;"></td>
                <td></td>
                <td class="cs6105B8F3" colspan="10" style="width:648px;height:22px;line-height:15px;text-align:left;vertical-align:middle;"><nobr>Site-web&nbsp;:&nbsp;$siteEse</nobr></td>
                <td></td>
                <td></td>
                <td></td>
                <td></td>
            </tr>
            <tr style="vertical-align:top;">
                <td style="width:0px;height:23px;"></td>
                <td></td>
                <td class="cs8A513397" colspan="10" style="width:648px;height:23px;line-height:15px;text-align:left;vertical-align:middle;"><nobr>Tel&#233;phone&nbsp;:&nbsp;'.$Tel1Ese.'</nobr></td>
                <td></td>
                <td></td>
                <td></td>
                <td></td>
            </tr>
            <tr style="vertical-align:top;">
                <td style="width:0px;height:16px;"></td>
                <td></td>
                <td></td>
                <td></td>
                <td></td>
                <td></td>
                <td></td>
                <td></td>
                <td></td>
                <td></td>
                <td></td>
                <td></td>
                <td></td>
                <td></td>
                <td></td>
                <td></td>
            </tr>
            <tr style="vertical-align:top;">
                <td style="width:0px;height:23px;"></td>
                <td></td>
                <td></td>
                <td></td>
                <td class="cs2C853136" colspan="9" style="width:597px;height:23px;line-height:22px;text-align:center;vertical-align:middle;"><nobr>RAPPORTS DES SOLDES DES FOURNISSEURS</nobr></td>
                <td></td>
                <td></td>
                <td></td>
            </tr>
            <tr style="vertical-align:top;">
                <td style="width:0px;height:22px;"></td>
                <td></td>
                <td></td>
                <td></td>
                <td></td>
                <td class="cs5EA817F2" colspan="3" style="width:202px;height:22px;line-height:15px;text-align:center;vertical-align:middle;"><nobr>'.$date1.'&nbsp;&nbsp;au&nbsp;&nbsp;'.$date2.'</nobr></td>
                <td></td>
                <td></td>
                <td></td>
                <td></td>
                <td></td>
                <td></td>
                <td></td>
                <td></td>
            </tr>
            <tr style="vertical-align:top;">
                <td style="width:0px;height:11px;"></td>
                <td></td>
                <td></td>
                <td></td>
                <td></td>
                <td></td>
                <td></td>
                <td></td>
                <td></td>
                <td></td>
                <td></td>
                <td></td>
                <td></td>
                <td></td>
                <td></td>
                <td></td>
            </tr>
            <tr style="vertical-align:top;">
                <td style="width:0px;height:24px;"></td>
                <td></td>
                <td class="cs275E312D" style="width:68px;height:22px;line-height:15px;text-align:center;vertical-align:middle;"><nobr>N&#176;</nobr></td>
                <td class="csAB3AA82A" colspan="3" style="width:307px;height:22px;line-height:15px;text-align:center;vertical-align:middle;"><nobr>Fournisseur</nobr></td>
                <td class="csAB3AA82A" colspan="3" style="width:119px;height:22px;line-height:15px;text-align:center;vertical-align:middle;"><nobr>Solde&nbsp;Innitial</nobr></td>
                <td class="csAB3AA82A" style="width:100px;height:22px;line-height:15px;text-align:center;vertical-align:middle;"><nobr>Montant&nbsp;d&#249;</nobr></td>
                <td class="csAB3AA82A" colspan="3" style="width:101px;height:22px;line-height:15px;text-align:center;vertical-align:middle;"><nobr>Montant&nbsp;Pay&#233;</nobr></td>
                <td class="csAB3AA82A" colspan="2" style="width:101px;height:22px;line-height:15px;text-align:center;vertical-align:middle;"><nobr>Solde&nbsp;Final</nobr></td>
                <td></td>
            </tr>
            ';

                    $output .= $this->showDetailSoldeFournisseur($date1, $date2); 

                    $output.='
            ';

                    $output .= $this->showSommeSoldeFournisseur($date1, $date2); 

                    $output.='
            <tr style="vertical-align:top;">
                <td style="width:0px;height:16px;"></td>
                <td></td>
                <td></td>
                <td></td>
                <td></td>
                <td></td>
                <td></td>
                <td></td>
                <td></td>
                <td></td>
                <td></td>
                <td></td>
                <td></td>
                <td></td>
                <td></td>
                <td></td>
            </tr>
            <tr style="vertical-align:top;">
                <td style="width:0px;height:22px;"></td>
                <td></td>
                <td></td>
                <td></td>
                <td></td>
                <td></td>
                <td></td>
                <td></td>
                <td></td>
                <td></td>
                <td></td>
                <td class="cs5EA817F2" colspan="4" style="width:155px;height:22px;line-height:15px;text-align:right;vertical-align:middle;"><nobr>Fait&nbsp;&#224;&nbsp;Goma&nbsp;le&nbsp;'.date('Y-m-d').'</nobr></td>
                <td></td>
            </tr>
        </table>
        </body>
        </html>
        ';  
       
        return $output; 

}

function showDetailSoldeFournisseur($date1, $date2)
{
        // Récupérer les données de stock, mouvements et ventes en une seule requête 

        // $data1 = DB::table('tvente_fournisseur')
        //     ->leftJoin('tvente_entete_requisition as dataCmd', function ($join) use ($date1) {
        //         $join->on('dataCmd.refFournisseur', '=', 'tvente_fournisseur.id')
        //              ->where('dataCmd.dateCmd', '<', $date1);
        //     })
        //     ->select(
        //         "tvente_fournisseur.id","tvente_fournisseur.noms","tvente_fournisseur.contact",
        //         "tvente_fournisseur.mail","tvente_fournisseur.adresse","tvente_fournisseur.author",
        //         'refCategorieFss',
        //         DB::raw('IFNULL(ROUND(SUM(dataCmd.montant), 2), 0) as dataFacture')                
        //     )
        //     ->groupBy("tvente_fournisseur.id","tvente_fournisseur.noms","tvente_fournisseur.contact",
        //         "tvente_fournisseur.mail","tvente_fournisseur.adresse","tvente_fournisseur.author",
        //         'refCategorieFss')
        //     ->orderBy("tvente_fournisseur.noms", "asc")
        //     ->get();

        $data1 = DB::table('tvente_fournisseur') 
        ->leftjoin('tvente_entete_requisition', 'tvente_entete_requisition.refFournisseur', '=', 'tvente_fournisseur.id')  
        ->leftJoin('tvente_detail_requisition as dataCmd', function ($join) use ($date1) {
            $join->on('dataCmd.refEnteteCmd', '=', 'tvente_entete_requisition.id')
            ->where('tvente_entete_requisition.dateCmd', '<', $date1);
        })
        ->select(
            "tvente_fournisseur.id","tvente_fournisseur.noms","tvente_fournisseur.contact",
            "tvente_fournisseur.mail","tvente_fournisseur.adresse","tvente_fournisseur.author",
            'refCategorieFss',
            DB::raw('IFNULL(ROUND(SUM(dataCmd.puCmd * dataCmd.qteCmd), 2), 0) as dataFacture')
        )
        ->groupBy("tvente_fournisseur.id","tvente_fournisseur.noms","tvente_fournisseur.contact",
                 "tvente_fournisseur.mail","tvente_fournisseur.adresse","tvente_fournisseur.author",
                'refCategorieFss')
        ->orderBy("tvente_fournisseur.noms", "asc")
        ->get();


            $data2 = DB::table('tvente_fournisseur') 
            ->leftjoin('tvente_entete_requisition', 'tvente_entete_requisition.refFournisseur', '=', 'tvente_fournisseur.id')  
            ->leftJoin('tvente_paiement_commande as dataPaie', function ($join) use ($date1) {
                $join->on('dataPaie.refCommande', '=', 'tvente_entete_requisition.id')
                ->where('dataPaie.date_paie', '<', $date1);
            })
            ->select(
                "tvente_fournisseur.id",
                'tvente_fournisseur.noms',
                DB::raw('IFNULL(ROUND(SUM(dataPaie.montant_paie), 2), 0) as dataPaie')
            )
            ->groupBy("tvente_fournisseur.id", "tvente_fournisseur.noms")
            ->orderBy("tvente_fournisseur.noms", "asc")
            ->get();
    

        //=============================================================================================

        $data11 = DB::table('tvente_fournisseur') 
        ->leftjoin('tvente_entete_requisition', 'tvente_entete_requisition.refFournisseur', '=', 'tvente_fournisseur.id')  
        ->leftJoin('tvente_detail_requisition as mvtCmd', function ($join) use ($date1, $date2) {
            $join->on('mvtCmd.refEnteteCmd', '=', 'tvente_entete_requisition.id')
            ->whereBetween('tvente_entete_requisition.dateCmd', [$date1, $date2]);
        })
        ->select(
            "tvente_fournisseur.id","tvente_fournisseur.noms",
            DB::raw('IFNULL(ROUND(SUM(mvtCmd.puCmd * mvtCmd.qteCmd), 2), 0) as mvtFacture')
        )
        ->groupBy("tvente_fournisseur.id","tvente_fournisseur.noms")
        ->orderBy("tvente_fournisseur.noms", "asc")
        ->get();
    
    
        $data22 = DB::table('tvente_fournisseur')   
        ->leftjoin('tvente_entete_requisition', 'tvente_entete_requisition.refFournisseur', '=', 'tvente_fournisseur.id')
        ->leftJoin('tvente_paiement_commande as mvtPaie', function ($join) use ($date1, $date2) {
            $join->on('mvtPaie.refCommande', '=', 'tvente_entete_requisition.id')
            ->whereBetween('mvtPaie.date_paie', [$date1, $date2]);
        })
        ->select(
            "tvente_fournisseur.id",
            'tvente_fournisseur.noms',
            DB::raw('IFNULL(ROUND(SUM(mvtPaie.montant_paie), 2), 0) as mvtPaie')
        )
        ->groupBy("tvente_fournisseur.id", "tvente_fournisseur.noms")
        ->orderBy("tvente_fournisseur.noms", "asc")
        ->get();



        // Construction de l'output
        
        $output = '';
    
        // Vérifiez que les deux tableaux ont la même longueur
        if ((count($data1) === count($data2)) && (count($data1) === count($data11)) 
        && (count($data1) === count($data22)))
        {
            $counts = 0;
            for ($i = 0; $i < count($data1); $i++) {

                $counts ++;
                $row1 = $data1[$i];
                $row2 = $data2[$i];
                $row11 = $data11[$i];
                $row22 = $data22[$i];                            
    
                $dataFacture = floatval($row1->dataFacture);
                $dataPaie = floatval($row2->dataPaie);
    
                $mvtFacture = floatval($row11->mvtFacture);            
                $mvtPaie = floatval($row22->mvtPaie);

                $soldeInnitial = ((floatval($dataFacture)) - (floatval($dataPaie)));
                $montantDu = ((floatval($soldeInnitial)) + (floatval($mvtFacture)));
                $soldeFinal = ((floatval($montantDu)) - (floatval($mvtPaie)));
  
    
                $output .= '

                    <tr style="vertical-align:top;">
                        <td style="width:0px;height:24px;"></td>
                        <td></td>
                        <td class="csE71035DC" style="width:68px;height:22px;line-height:15px;text-align:center;vertical-align:middle;"><nobr>'.$counts.'</nobr></td>
                        <td class="cs82D98BB6" colspan="3" style="width:307px;height:22px;line-height:15px;text-align:left;vertical-align:middle;">'.$row1->noms.'</td>
                        <td class="cs82D98BB6" colspan="3" style="width:119px;height:22px;line-height:15px;text-align:center;vertical-align:middle;">'.$soldeInnitial.'$</td>
                        <td class="cs82D98BB6" style="width:100px;height:22px;line-height:15px;text-align:center;vertical-align:middle;">'.$mvtFacture.'$</td>
                        <td class="cs82D98BB6" colspan="3" style="width:101px;height:22px;line-height:15px;text-align:center;vertical-align:middle;">'.$mvtPaie.'$</td>
                        <td class="cs82D98BB6" colspan="2" style="width:101px;height:22px;line-height:15px;text-align:center;vertical-align:middle;">'.$soldeFinal.'$</td>
                        <td></td>
                    </tr>';   
    
        }
        } else {
            // Gérer le cas où les tableaux n'ont pas la même longueur
            echo 'Les tableaux ont pas la même longueur.';
        }
    
        return $output;
    

}

function showSommeSoldeFournisseur($date1, $date2)
{

        $data1 = DB::table('tvente_fournisseur') 
        ->leftjoin('tvente_entete_requisition', 'tvente_entete_requisition.refFournisseur', '=', 'tvente_fournisseur.id')  
        ->leftJoin('tvente_detail_requisition as dataCmd', function ($join) use ($date1) {
            $join->on('dataCmd.refEnteteCmd', '=', 'tvente_entete_requisition.id')
            ->where('tvente_entete_requisition.dateCmd', '<', $date1);
        })
        ->select(
            "tvente_fournisseur.id","tvente_fournisseur.noms","tvente_fournisseur.contact",
            "tvente_fournisseur.mail","tvente_fournisseur.adresse","tvente_fournisseur.author",
            'refCategorieFss',
            DB::raw('IFNULL(ROUND(SUM(dataCmd.puCmd * dataCmd.qteCmd), 2), 0) as dataFacture')
        )
        ->groupBy("tvente_fournisseur.id","tvente_fournisseur.noms","tvente_fournisseur.contact",
                 "tvente_fournisseur.mail","tvente_fournisseur.adresse","tvente_fournisseur.author",
                'refCategorieFss')
        ->orderBy("tvente_fournisseur.noms", "asc")
        ->get();


            $data2 = DB::table('tvente_fournisseur') 
            ->leftjoin('tvente_entete_requisition', 'tvente_entete_requisition.refFournisseur', '=', 'tvente_fournisseur.id')  
            ->leftJoin('tvente_paiement_commande as dataPaie', function ($join) use ($date1) {
                $join->on('dataPaie.refCommande', '=', 'tvente_entete_requisition.id')
                ->where('dataPaie.date_paie', '<', $date1);
            })
            ->select(
                "tvente_fournisseur.id",
                'tvente_fournisseur.noms',
                DB::raw('IFNULL(ROUND(SUM(dataPaie.montant_paie), 2), 0) as dataPaie')
            )
            ->groupBy("tvente_fournisseur.id", "tvente_fournisseur.noms")
            ->orderBy("tvente_fournisseur.noms", "asc")
            ->get();
    

        //=============================================================================================

        $data11 = DB::table('tvente_fournisseur') 
        ->leftjoin('tvente_entete_requisition', 'tvente_entete_requisition.refFournisseur', '=', 'tvente_fournisseur.id')  
        ->leftJoin('tvente_detail_requisition as mvtCmd', function ($join) use ($date1, $date2) {
            $join->on('mvtCmd.refEnteteCmd', '=', 'tvente_entete_requisition.id')
            ->whereBetween('tvente_entete_requisition.dateCmd', [$date1, $date2]);
        })
        ->select(
            "tvente_fournisseur.id","tvente_fournisseur.noms",
            DB::raw('IFNULL(ROUND(SUM(mvtCmd.puCmd * mvtCmd.qteCmd), 2), 0) as mvtFacture')
        )
        ->groupBy("tvente_fournisseur.id","tvente_fournisseur.noms")
        ->orderBy("tvente_fournisseur.noms", "asc")
        ->get();
    
    
        $data22 = DB::table('tvente_fournisseur')   
        ->leftjoin('tvente_entete_requisition', 'tvente_entete_requisition.refFournisseur', '=', 'tvente_fournisseur.id')
        ->leftJoin('tvente_paiement_commande as mvtPaie', function ($join) use ($date1, $date2) {
            $join->on('mvtPaie.refCommande', '=', 'tvente_entete_requisition.id')
            ->whereBetween('mvtPaie.date_paie', [$date1, $date2]);
        })
        ->select(
            "tvente_fournisseur.id",
            'tvente_fournisseur.noms',
            DB::raw('IFNULL(ROUND(SUM(mvtPaie.montant_paie), 2), 0) as mvtPaie')
        )
        ->groupBy("tvente_fournisseur.id", "tvente_fournisseur.noms")
        ->orderBy("tvente_fournisseur.noms", "asc")
        ->get();



        // Construction de l'output
        
        $output = '';
    
        // Vérifiez que les deux tableaux ont la même longueur
        if ((count($data1) === count($data2)) && (count($data1) === count($data11)) 
        && (count($data1) === count($data22)))
        {

            $somme_total_du=0;
            $somme_total_innitial=0;
            $somme_total_paie=0;
            $somme_total_solde=0;

            $counts = 0;
            for ($i = 0; $i < count($data1); $i++) {

                $counts ++;
                $row1 = $data1[$i];
                $row2 = $data2[$i];
                $row11 = $data11[$i];
                $row22 = $data22[$i];                            
    
                $dataFacture = floatval($row1->dataFacture);
                $dataPaie = floatval($row2->dataPaie);
    
                $mvtFacture = floatval($row11->mvtFacture);            
                $mvtPaie = floatval($row22->mvtPaie);

                $soldeInnitial = ((floatval($dataFacture)) - (floatval($dataPaie)));
                $montantDu = ((floatval($soldeInnitial)) + (floatval($mvtFacture)));
                $soldeFinal = ((floatval($montantDu)) - (floatval($mvtPaie)));

                $somme_total_innitial = floatval($somme_total_innitial) + floatval($soldeInnitial);
                $somme_total_du = floatval($somme_total_du) + floatval($mvtFacture);                
                $somme_total_paie = floatval($somme_total_paie) + floatval($mvtPaie);
                $somme_total_solde = floatval($somme_total_solde) + floatval($soldeFinal);                   
    
        }

        $output .= '

           <tr style="vertical-align:top;">
                <td style="width:0px;height:24px;"></td>
                <td></td>
                <td class="cs275E312D" colspan="4" style="width:376px;height:22px;line-height:15px;text-align:center;vertical-align:middle;"><nobr></nobr></td>
                <td class="csAB3AA82A" colspan="3" style="width:119px;height:22px;line-height:15px;text-align:center;vertical-align:middle;"><nobr>'.$somme_total_innitial.'$</nobr></td>
                <td class="csAB3AA82A" style="width:100px;height:22px;line-height:15px;text-align:center;vertical-align:middle;"><nobr>'.$somme_total_du.'$</nobr></td>
                <td class="csAB3AA82A" colspan="3" style="width:101px;height:22px;line-height:15px;text-align:center;vertical-align:middle;"><nobr>'.$somme_total_paie.'$</nobr></td>
                <td class="csAB3AA82A" colspan="2" style="width:101px;height:22px;line-height:15px;text-align:center;vertical-align:middle;"><nobr>'.$somme_total_solde.'$</nobr></td>
                <td></td>
            </tr>';

        } else {
            // Gérer le cas où les tableaux n'ont pas la même longueur
            echo 'Les tableaux ont pas la même longueur.';
        }

        
    
        return $output;
    

}

//==================== RAPPORT TRANSFERT PAR SERVICE SOURCE =======================================

public function fetch_rapport_detailtransfert_date_service_source(Request $request)
{
    //refDepartement

    if ($request->get('date1') && $request->get('date2')&& $request->get('idService')) {
        // code...
        $date1 = $request->get('date1');
        $date2 = $request->get('date2');
        $idService = $request->get('idService');

        $html ='<html><head><meta http-equiv="Content-Type" content="text/html; charset=utf-8"/>';
        $html .= $this->printRapportDetailTransfert_Service_Source($date1, $date2,$idService);       
        $html .='<script>window.print()</script>';

        echo($html);          

    } else {
        // code...
    }  
    
}
function printRapportDetailTransfert_Service_Source($date1, $date2,$idService)
{

         //Info Entreprise
         $nomEse='';
         $adresseEse='';
         $Tel1Ese='';
         $Tel2Ese='';
         $siteEse='';
         $emailEse='';
         $idNatEse='';
         $numImpotEse='';
         $rccEse='';
         $siege='';
         $busnessName='';
         $pic='';
         $pic2 = $this->displayImg("fichier", 'logo.png');
         $logo='';
 
         $data1 = DB::table('entreprises')
         ->join('secteurs','secteurs.id','=','entreprises.idsecteur')
         ->join('forme_juridiques','forme_juridiques.id','=','entreprises.idforme')
 
         ->join('pays','pays.id','=','entreprises.idPays')
         ->join('provinces','provinces.id','=','entreprises.idProvince')
         ->join('users','users.id','=','entreprises.ceo')        
         ->select('entreprises.id as id','entreprises.id as idEntreprise',
         'entreprises.ceo','entreprises.nomEntreprise','entreprises.descriptionEntreprise',
         'entreprises.emailEntreprise','entreprises.adresseEntreprise',
         'entreprises.telephoneEntreprise','entreprises.solutionEntreprise','entreprises.idsecteur',
         'entreprises.idforme','entreprises.etat',
         'entreprises.idPays','entreprises.idProvince','entreprises.edition','entreprises.facebook',
         'entreprises.linkedin','entreprises.twitter','entreprises.siteweb','entreprises.rccm',
         'entreprises.invPersonnel','entreprises.invHub','entreprises.invRecherche',
         'entreprises.chiffreAffaire','entreprises.nbremploye','entreprises.slug','entreprises.logo',
             //forme
             'forme_juridiques.nomForme','secteurs.nomSecteur',
             //users
             'users.name','users.email','users.avatar','users.telephone','users.adresse',
             //
             'provinces.nomProvince','pays.nomPays', 'entreprises.created_at')
         ->get();
         $output='';
         foreach ($data1 as $row) 
         {                                
             $nomEse=$row->nomEntreprise;
             $adresseEse=$row->adresseEntreprise;
             $Tel1Ese=$row->telephoneEntreprise;
             $Tel2Ese=$row->telephone;
             $siteEse=$row->siteweb;
             $emailEse=$row->emailEntreprise;
             $idNatEse=$row->rccm;
             $numImpotEse=$row->rccm;
             $busnessName=$row->nomSecteur;
             $rccmEse=$row->rccm;
             $pic = $this->displayImg("fichier", 'logo.png');
             $siege=$row->nomForme;         
         }
 
         $TotalTransfert=0;
         // 
         $data2 =  DB::table('tvente_detail_transfert')
         ->join('tvente_entete_transfert','tvente_entete_transfert.id','=','tvente_detail_transfert.refEnteteTransfert')     
         ->join('tvente_services as servicesOrigine','servicesOrigine.id','=','tvente_entete_transfert.refService')
         ->join('tvente_services as servicesDestination','servicesDestination.id','=','tvente_detail_transfert.refDestination')
         ->join('tvente_produit','tvente_produit.id','=','tvente_detail_transfert.refProduit')
         ->join('tvente_categorie_produit','tvente_categorie_produit.id','=','tvente_produit.refCategorie')

         ->select(DB::raw('ROUND(SUM(qteTransfert * puTransfert),3) as TotalTransfert'))
         ->where([
            ['date_transfert','>=', $date1],
            ['date_transfert','<=', $date2],
            ['servicesOrigine.id','=', $idService],
        ])    
         ->get(); 
         $output='';
         foreach ($data2 as $row) 
         {                                
            $TotalTransfert=$row->TotalTransfert;                    
         }




         $services='';         

         $data3=DB::table('tvente_services')       
         ->select('id','nom_service','status','active')
         ->where([
            ['tvente_services.id','=', $idService]
        ])      
        ->first(); 
        if ($data3) 
        {
            $services=$data3->nom_service;              
        }


        $output='';  

        $output='
            <!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Transitional//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd">
            <!-- saved from url=(0016)http://localhost -->
            <html>
            <head>
                <title>rptRapportTransfert</title>
                <meta HTTP-EQUIV="Content-Type" CONTENT="text/html; charset=utf-8"/>
                <style type="text/css">
                    .cs1E4BB091 {color:#000000;background-color:transparent;border-left:#000000 1px solid;border-top:#000000 1px solid;border-right:#000000 1px solid;border-bottom:#000000 1px solid;font-family:Times New Roman; font-size:11px; font-weight:bold; font-style:normal; }
                    .csDB0B2364 {color:#000000;background-color:transparent;border-left:#000000 1px solid;border-top:#000000 1px solid;border-right:#000000 1px solid;border-bottom:#000000 1px solid;font-family:Times New Roman; font-size:9px; font-weight:bold; font-style:normal; }
                    .cs463A9CD7 {color:#000000;background-color:transparent;border-left:#000000 1px solid;border-top:#000000 1px solid;border-right:#000000 1px solid;border-bottom:#000000 1px solid;font-family:Times New Roman; font-size:9px; font-weight:normal; font-style:normal; }
                    .csEE1F9023 {color:#000000;background-color:transparent;border-left-style: none;border-top:#000000 1px solid;border-right:#000000 1px solid;border-bottom:#000000 1px solid;font-family:Times New Roman; font-size:11px; font-weight:bold; font-style:normal; }
                    .cs5A34C077 {color:#000000;background-color:transparent;border-left-style: none;border-top:#000000 1px solid;border-right:#000000 1px solid;border-bottom:#000000 1px solid;font-family:Times New Roman; font-size:9px; font-weight:bold; font-style:normal; }
                    .cs6AEC9C2 {color:#000000;background-color:transparent;border-left-style: none;border-top:#000000 1px solid;border-right:#000000 1px solid;border-bottom:#000000 1px solid;font-family:Times New Roman; font-size:9px; font-weight:normal; font-style:normal; }
                    .cs8A513397 {color:#000000;background-color:transparent;border-left-style: none;border-top-style: none;border-right-style: none;border-bottom-style: none;font-family:Times New Roman; font-size:13px; font-weight:bold; font-style:normal; padding-left:2px;}
                    .cs8BD51C12 {color:#000000;background-color:transparent;border-left-style: none;border-top-style: none;border-right-style: none;border-bottom-style: none;font-family:Times New Roman; font-size:13px; font-weight:bold; font-style:normal; padding-left:2px;padding-right:2px;}
                    .cs101A94F7 {color:#000000;background-color:transparent;border-left-style: none;border-top-style: none;border-right-style: none;border-bottom-style: none;font-family:Times New Roman; font-size:13px; font-weight:normal; font-style:normal; }
                    .cs6105B8F3 {color:#000000;background-color:transparent;border-left-style: none;border-top-style: none;border-right-style: none;border-bottom-style: none;font-family:Times New Roman; font-size:13px; font-weight:normal; font-style:normal; padding-left:2px;}
                    .cs5EA817F2 {color:#000000;background-color:transparent;border-left-style: none;border-top-style: none;border-right-style: none;border-bottom-style: none;font-family:Times New Roman; font-size:13px; font-weight:normal; font-style:normal; padding-left:2px;padding-right:2px;}
                    .cs2C853136 {color:#000000;background-color:transparent;border-left-style: none;border-top-style: none;border-right-style: none;border-bottom-style: none;font-family:Times New Roman; font-size:19px; font-weight:bold; font-style:normal; padding-left:2px;padding-right:2px;}
                    .cs739196BC {color:#5C5C5C;background-color:transparent;border-left-style: none;border-top-style: none;border-right-style: none;border-bottom-style: none;font-family:Segoe UI; font-size:11px; font-weight:normal; font-style:normal; }
                    .csF7D3565D {height:0px;width:0px;overflow:hidden;font-size:0px;line-height:0px;}
                </style>
            </head>
            <body leftMargin=10 topMargin=10 rightMargin=10 bottomMargin=10 style="background-color:#FFFFFF">
            <table cellpadding="0" cellspacing="0" border="0" style="border-width:0px;empty-cells:show;width:844px;height:375px;position:relative;">
                <tr>
                    <td style="width:0px;height:0px;"></td>
                    <td style="height:0px;width:10px;"></td>
                    <td style="height:0px;width:38px;"></td>
                    <td style="height:0px;width:62px;"></td>
                    <td style="height:0px;width:77px;"></td>
                    <td style="height:0px;width:4px;"></td>
                    <td style="height:0px;width:128px;"></td>
                    <td style="height:0px;width:1px;"></td>
                    <td style="height:0px;width:89px;"></td>
                    <td style="height:0px;width:41px;"></td>
                    <td style="height:0px;width:76px;"></td>
                    <td style="height:0px;width:72px;"></td>
                    <td style="height:0px;width:24px;"></td>
                    <td style="height:0px;width:8px;"></td>
                    <td style="height:0px;width:36px;"></td>
                    <td style="height:0px;width:45px;"></td>
                    <td style="height:0px;width:7px;"></td>
                    <td style="height:0px;width:12px;"></td>
                    <td style="height:0px;width:114px;"></td>
                </tr>
                <tr style="vertical-align:top;">
                    <td style="width:0px;height:23px;"></td>
                    <td class="cs739196BC" colspan="8" style="width:409px;height:23px;line-height:14px;text-align:center;vertical-align:middle;"></td>
                    <td></td>
                    <td></td>
                    <td></td>
                    <td></td>
                    <td></td>
                    <td></td>
                    <td></td>
                    <td></td>
                    <td></td>
                    <td></td>
                </tr>
                <tr style="vertical-align:top;">
                    <td style="width:0px;height:10px;"></td>
                    <td></td>
                    <td></td>
                    <td></td>
                    <td></td>
                    <td></td>
                    <td></td>
                    <td></td>
                    <td></td>
                    <td></td>
                    <td></td>
                    <td></td>
                    <td></td>
                    <td></td>
                    <td></td>
                    <td></td>
                    <td></td>
                    <td></td>
                    <td></td>
                </tr>
                <tr style="vertical-align:top;">
                    <td style="width:0px;height:22px;"></td>
                    <td></td>
                    <td class="cs8A513397" colspan="10" style="width:586px;height:22px;line-height:15px;text-align:left;vertical-align:middle;"><nobr>'.$nomEse.'</nobr></td>
                    <td></td>
                    <td></td>
                    <td></td>
                    <td></td>
                    <td></td>
                    <td class="cs101A94F7" colspan="2" rowspan="5" style="width:126px;height:110px;text-align:left;vertical-align:top;"><div style="overflow:hidden;width:126px;height:110px;">
                        <img alt="" src="'.$pic2.'" style="width:126px;height:110px;" /></div>
                    </td>
                </tr>
                <tr style="vertical-align:top;">
                    <td style="width:0px;height:22px;"></td>
                    <td></td>
                    <td class="cs6105B8F3" colspan="10" style="width:586px;height:22px;line-height:15px;text-align:left;vertical-align:middle;"><nobr>'.$busnessName.'</nobr></td>
                    <td></td>
                    <td></td>
                    <td></td>
                    <td></td>
                    <td></td>
                </tr>
                <tr style="vertical-align:top;">
                    <td style="width:0px;height:22px;"></td>
                    <td></td>
                    <td class="cs8A513397" colspan="10" style="width:586px;height:22px;line-height:15px;text-align:left;vertical-align:middle;"><nobr>RCCM'.$rccEse.'.&nbsp;ID-NAT.'.$idNatEse.'</nobr></td>
                    <td></td>
                    <td></td>
                    <td></td>
                    <td></td>
                    <td></td>
                </tr>
                <tr style="vertical-align:top;">
                    <td style="width:0px;height:22px;"></td>
                    <td></td>
                    <td class="cs8A513397" colspan="10" style="width:586px;height:22px;line-height:15px;text-align:left;vertical-align:middle;"><nobr>N&#176;&nbsp;00056789/M</nobr></td>
                    <td></td>
                    <td></td>
                    <td></td>
                    <td></td>
                    <td></td>
                </tr>
                <tr style="vertical-align:top;">
                    <td style="width:0px;height:22px;"></td>
                    <td></td>
                    <td class="cs6105B8F3" colspan="10" style="width:586px;height:22px;line-height:15px;text-align:left;vertical-align:middle;"><nobr>'.$adresseEse.'</nobr></td>
                    <td></td>
                    <td></td>
                    <td></td>
                    <td></td>
                    <td></td>
                </tr>
                <tr style="vertical-align:top;">
                    <td style="width:0px;height:22px;"></td>
                    <td></td>
                    <td class="cs6105B8F3" colspan="10" style="width:586px;height:22px;line-height:15px;text-align:left;vertical-align:middle;"><nobr>E-mail&nbsp;:&nbsp;'.$emailEse.'</nobr></td>
                    <td></td>
                    <td></td>
                    <td></td>
                    <td></td>
                    <td></td>
                    <td></td>
                    <td></td>
                </tr>
                <tr style="vertical-align:top;">
                    <td style="width:0px;height:22px;"></td>
                    <td></td>
                    <td class="cs6105B8F3" colspan="10" style="width:586px;height:22px;line-height:15px;text-align:left;vertical-align:middle;"><nobr>Site-web&nbsp;:&nbsp;'.$siteEse.'</nobr></td>
                    <td></td>
                    <td></td>
                    <td></td>
                    <td></td>
                    <td></td>
                    <td></td>
                    <td></td>
                </tr>
                <tr style="vertical-align:top;">
                    <td style="width:0px;height:23px;"></td>
                    <td></td>
                    <td class="cs8A513397" colspan="10" style="width:586px;height:23px;line-height:15px;text-align:left;vertical-align:middle;"><nobr>Tel&#233;phone&nbsp;:&nbsp;'.$Tel1Ese.'</nobr></td>
                    <td></td>
                    <td></td>
                    <td></td>
                    <td></td>
                    <td></td>
                    <td></td>
                    <td></td>
                </tr>
                <tr style="vertical-align:top;">
                    <td style="width:0px;height:16px;"></td>
                    <td></td>
                    <td></td>
                    <td></td>
                    <td></td>
                    <td></td>
                    <td></td>
                    <td></td>
                    <td></td>
                    <td></td>
                    <td></td>
                    <td></td>
                    <td></td>
                    <td></td>
                    <td></td>
                    <td></td>
                    <td></td>
                    <td></td>
                    <td></td>
                </tr>
                <tr style="vertical-align:top;">
                    <td style="width:0px;height:23px;"></td>
                    <td></td>
                    <td></td>
                    <td></td>
                    <td class="cs2C853136" colspan="12" style="width:597px;height:23px;line-height:22px;text-align:center;vertical-align:middle;"><nobr>RAPPORT&nbsp;DES&nbsp;TRANSFERT&nbsp;PAR&nbsp;SERVICE&nbsp;SOURCE</nobr></td>
                    <td></td>
                    <td></td>
                    <td></td>
                </tr>
                <tr style="vertical-align:top;">
                    <td style="width:0px;height:22px;"></td>
                    <td></td>
                    <td></td>
                    <td></td>
                    <td></td>
                    <td></td>
                    <td></td>
                    <td class="cs5EA817F2" colspan="4" style="width:203px;height:22px;line-height:15px;text-align:center;vertical-align:middle;"><nobr>'.$date1.'&nbsp;&nbsp;au&nbsp;&nbsp;'.$date2.'</nobr></td>
                    <td></td>
                    <td></td>
                    <td></td>
                    <td></td>
                    <td></td>
                    <td></td>
                    <td></td>
                    <td></td>
                </tr>
                <tr style="vertical-align:top;">
                    <td style="width:0px;height:22px;"></td>
                    <td></td>
                    <td></td>
                    <td></td>
                    <td></td>
                    <td class="cs8BD51C12" colspan="8" style="width:431px;height:22px;line-height:15px;text-align:center;vertical-align:middle;"><nobr>Service&nbsp;Source&nbsp;:&nbsp;'.$services.'</nobr></td>
                    <td></td>
                    <td></td>
                    <td></td>
                    <td></td>
                    <td></td>
                    <td></td>
                </tr>
                <tr style="vertical-align:top;">
                    <td style="width:0px;height:10px;"></td>
                    <td></td>
                    <td></td>
                    <td></td>
                    <td></td>
                    <td></td>
                    <td></td>
                    <td></td>
                    <td></td>
                    <td></td>
                    <td></td>
                    <td></td>
                    <td></td>
                    <td></td>
                    <td></td>
                    <td></td>
                    <td></td>
                    <td></td>
                    <td></td>
                </tr>
                <tr style="vertical-align:top;">
                    <td style="width:0px;height:24px;"></td>
                    <td></td>
                    <td class="cs1E4BB091" style="width:36px;height:22px;line-height:12px;text-align:center;vertical-align:middle;"><nobr>N&#176;</nobr></td>
                    <td class="csEE1F9023" style="width:61px;height:22px;line-height:12px;text-align:center;vertical-align:middle;"><nobr>Date</nobr></td>
                    <td class="csEE1F9023" colspan="2" style="width:80px;height:22px;line-height:12px;text-align:center;vertical-align:middle;"><nobr>N&#176;&nbsp;Transfert</nobr></td>
                    <td class="csEE1F9023" colspan="2" style="width:128px;height:22px;line-height:12px;text-align:center;vertical-align:middle;"><nobr>Service&nbsp;Source</nobr></td>
                    <td class="csEE1F9023" colspan="2" style="width:129px;height:22px;line-height:12px;text-align:center;vertical-align:middle;"><nobr>Sercive&nbsp;Destination</nobr></td>
                    <td class="csEE1F9023" colspan="4" style="width:179px;height:22px;line-height:12px;text-align:center;vertical-align:middle;"><nobr>Produit</nobr></td>
                    <td class="csEE1F9023" style="width:35px;height:22px;line-height:12px;text-align:center;vertical-align:middle;"><nobr>Qt&#233;</nobr></td>
                    <td class="csEE1F9023" colspan="3" style="width:63px;height:22px;line-height:12px;text-align:center;vertical-align:middle;"><nobr>PU</nobr></td>
                    <td class="csEE1F9023" style="width:113px;height:22px;line-height:12px;text-align:center;vertical-align:middle;"><nobr>PT</nobr></td>
                </tr>
                ';

                                        $output .= $this->showDetailTransfert_Service_Source($date1,$date2,$idService); 

                                        $output.='
                <tr style="vertical-align:top;">
                    <td style="width:0px;height:24px;"></td>
                    <td></td>
                    <td></td>
                    <td></td>
                    <td></td>
                    <td></td>
                    <td></td>
                    <td></td>
                    <td></td>
                    <td></td>
                    <td></td>
                    <td></td>
                    <td></td>
                    <td></td>
                    <td class="csDB0B2364" colspan="4" style="width:98px;height:22px;line-height:10px;text-align:center;vertical-align:middle;"><nobr>TOTAL</nobr></td>
                    <td class="cs5A34C077" style="width:113px;height:22px;line-height:10px;text-align:center;vertical-align:middle;"><nobr>'.$TotalTransfert.'$</nobr></td>
                </tr>
            </table>
            </body>
            </html>      
        ';  
       
        return $output; 

}
function showDetailTransfert_Service_Source($date1,$date2,$idService)
{
        $data = DB::table('tvente_detail_transfert')  
        ->join('tvente_entete_transfert','tvente_entete_transfert.id','=','tvente_detail_transfert.refEnteteTransfert')     
        ->join('tvente_services as servicesOrigine','servicesOrigine.id','=','tvente_entete_transfert.refService')
        ->join('tvente_services as servicesDestination','servicesDestination.id','=','tvente_detail_transfert.refDestination')
        ->join('tvente_produit','tvente_produit.id','=','tvente_detail_transfert.refProduit')
        ->join('tvente_categorie_produit','tvente_categorie_produit.id','=','tvente_produit.refCategorie')

        ->select('tvente_detail_transfert.id','refEnteteTransfert','refProduit','refDestination','puTransfert',
        'qteTransfert','uniteTransfert','tvente_detail_transfert.puBase','tvente_detail_transfert.qteBase',
        'tvente_detail_transfert.uniteBase','tvente_detail_transfert.author','tvente_detail_transfert.refUser',
        'tvente_detail_transfert.created_at','refService','date_transfert',"servicesOrigine.nom_service as ServiceOrigine",
        "servicesDestination.nom_service as ServiceDestination"

        ,"tvente_produit.designation as designation",'refCategorie','refUniteBase','pu','qte',
        'cmup','devise','taux','Oldcode','Newcode','tvaapplique','estvendable',"tvente_categorie_produit.designation as Categorie"        
        )
        ->selectRaw('(qteTransfert*puTransfert) as PTTransfert')
        ->selectRaw('(qteBase*puBase) as PTBase')
        ->selectRaw('CONCAT("S",YEAR(date_transfert),"",MONTH(date_transfert),"00",refEnteteTransfert) as codeFacture')
        ->where([
            ['date_transfert','>=', $date1],
            ['date_transfert','<=', $date2],
            ['servicesOrigine.id','=', $idService]
        ])
        ->orderBy("tvente_detail_transfert.created_at", "asc")
        ->get();
        $output='';

        foreach ($data as $row) 
        {

            $output .='
                	<tr style="vertical-align:top;">
                    <td style="width:0px;height:24px;"></td>
                    <td></td>
                    <td class="cs463A9CD7" style="width:36px;height:22px;line-height:10px;text-align:center;vertical-align:middle;"><nobr>1</nobr></td>
                    <td class="cs6AEC9C2" style="width:61px;height:22px;line-height:10px;text-align:center;vertical-align:middle;"><nobr>'.$row->date_transfert.'</nobr></td>
                    <td class="cs6AEC9C2" colspan="2" style="width:80px;height:22px;line-height:10px;text-align:center;vertical-align:middle;"><nobr>'.$row->codeFacture.'</nobr></td>
                    <td class="cs6AEC9C2" colspan="2" style="width:128px;height:22px;line-height:10px;text-align:left;vertical-align:middle;">'.$row->ServiceOrigine.'</td>
                    <td class="cs6AEC9C2" colspan="2" style="width:129px;height:22px;line-height:10px;text-align:left;vertical-align:middle;">'.$row->ServiceDestination.'</td>
                    <td class="cs6AEC9C2" colspan="4" style="width:179px;height:22px;line-height:10px;text-align:left;vertical-align:middle;">'.$row->designation.'</td>
                    <td class="cs6AEC9C2" style="width:35px;height:22px;line-height:10px;text-align:center;vertical-align:middle;"><nobr>'.$row->qteTransfert.'('.$row->uniteTransfert.')</nobr></td>
                    <td class="cs6AEC9C2" colspan="3" style="width:63px;height:22px;line-height:10px;text-align:center;vertical-align:middle;"><nobr>'.$row->puTransfert.'$</nobr></td>
                    <td class="cs6AEC9C2" style="width:113px;height:22px;line-height:10px;text-align:center;vertical-align:middle;"><nobr>'.$row->PTTransfert.'$</nobr></td>
                </tr>
            ';         
   
    }

    return $output;

}


//==================== RAPPORT DETAIL TRANSFERT SELON LES SERVICES =======================================

public function fetch_rapport_detailtransfert_date_service_destination(Request $request)
{
    //refDepartement

    if ($request->get('date1') && $request->get('date2')&& $request->get('idService')) {
        // code...
        $date1 = $request->get('date1');
        $date2 = $request->get('date2');
        $idService = $request->get('idService');

        $html ='<html><head><meta http-equiv="Content-Type" content="text/html; charset=utf-8"/>';
        $html .= $this->printRapportDetailTransfert_Service_Destination($date1, $date2,$idService);       
        $html .='<script>window.print()</script>';

        echo($html);          

    } else {
        // code...
    }  
    
}
function printRapportDetailTransfert_Service_Destination($date1, $date2,$idService)
{

         //Info Entreprise
         $nomEse='';
         $adresseEse='';
         $Tel1Ese='';
         $Tel2Ese='';
         $siteEse='';
         $emailEse='';
         $idNatEse='';
         $numImpotEse='';
         $rccEse='';
         $siege='';
         $busnessName='';
         $pic='';
         $pic2 = $this->displayImg("fichier", 'logo.png');
         $logo='';
 
         $data1 = DB::table('entreprises')
         ->join('secteurs','secteurs.id','=','entreprises.idsecteur')
         ->join('forme_juridiques','forme_juridiques.id','=','entreprises.idforme')
 
         ->join('pays','pays.id','=','entreprises.idPays')
         ->join('provinces','provinces.id','=','entreprises.idProvince')
         ->join('users','users.id','=','entreprises.ceo')        
         ->select('entreprises.id as id','entreprises.id as idEntreprise',
         'entreprises.ceo','entreprises.nomEntreprise','entreprises.descriptionEntreprise',
         'entreprises.emailEntreprise','entreprises.adresseEntreprise',
         'entreprises.telephoneEntreprise','entreprises.solutionEntreprise','entreprises.idsecteur',
         'entreprises.idforme','entreprises.etat',
         'entreprises.idPays','entreprises.idProvince','entreprises.edition','entreprises.facebook',
         'entreprises.linkedin','entreprises.twitter','entreprises.siteweb','entreprises.rccm',
         'entreprises.invPersonnel','entreprises.invHub','entreprises.invRecherche',
         'entreprises.chiffreAffaire','entreprises.nbremploye','entreprises.slug','entreprises.logo',
             //forme
             'forme_juridiques.nomForme','secteurs.nomSecteur',
             //users
             'users.name','users.email','users.avatar','users.telephone','users.adresse',
             //
             'provinces.nomProvince','pays.nomPays', 'entreprises.created_at')
         ->get();
         $output='';
         foreach ($data1 as $row) 
         {                                
             $nomEse=$row->nomEntreprise;
             $adresseEse=$row->adresseEntreprise;
             $Tel1Ese=$row->telephoneEntreprise;
             $Tel2Ese=$row->telephone;
             $siteEse=$row->siteweb;
             $emailEse=$row->emailEntreprise;
             $idNatEse=$row->rccm;
             $numImpotEse=$row->rccm;
             $busnessName=$row->nomSecteur;
             $rccmEse=$row->rccm;
             $pic = $this->displayImg("fichier", 'logo.png');
             $siege=$row->nomForme;         
         }
 
         $TotalTransfert=0;
         // 
         $data2 =  DB::table('tvente_detail_transfert')
         ->join('tvente_entete_transfert','tvente_entete_transfert.id','=','tvente_detail_transfert.refEnteteTransfert')     
         ->join('tvente_services as servicesOrigine','servicesOrigine.id','=','tvente_entete_transfert.refService')
         ->join('tvente_services as servicesDestination','servicesDestination.id','=','tvente_detail_transfert.refDestination')
         ->join('tvente_produit','tvente_produit.id','=','tvente_detail_transfert.refProduit')
         ->join('tvente_categorie_produit','tvente_categorie_produit.id','=','tvente_produit.refCategorie')

         ->select(DB::raw('ROUND(SUM(qteTransfert * puTransfert),3) as TotalTransfert'))
         ->where([
            ['date_transfert','>=', $date1],
            ['date_transfert','<=', $date2],
            ['servicesDestination.id','=', $idService],
        ])    
         ->get(); 
         $output='';
         foreach ($data2 as $row) 
         {                                
            $TotalTransfert=$row->TotalTransfert;                    
         }




         $services='';         

         $data3=DB::table('tvente_services')       
         ->select('id','nom_service','status','active')
         ->where([
            ['tvente_services.id','=', $idService]
        ])      
        ->first(); 
        if ($data3) 
        {
            $services=$data3->nom_service;              
        }


        $output='';  

        $output='
            <!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Transitional//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd">
            <!-- saved from url=(0016)http://localhost -->
            <html>
            <head>
                <title>rptRapportTransfert</title>
                <meta HTTP-EQUIV="Content-Type" CONTENT="text/html; charset=utf-8"/>
                <style type="text/css">
                    .cs1E4BB091 {color:#000000;background-color:transparent;border-left:#000000 1px solid;border-top:#000000 1px solid;border-right:#000000 1px solid;border-bottom:#000000 1px solid;font-family:Times New Roman; font-size:11px; font-weight:bold; font-style:normal; }
                    .csDB0B2364 {color:#000000;background-color:transparent;border-left:#000000 1px solid;border-top:#000000 1px solid;border-right:#000000 1px solid;border-bottom:#000000 1px solid;font-family:Times New Roman; font-size:9px; font-weight:bold; font-style:normal; }
                    .cs463A9CD7 {color:#000000;background-color:transparent;border-left:#000000 1px solid;border-top:#000000 1px solid;border-right:#000000 1px solid;border-bottom:#000000 1px solid;font-family:Times New Roman; font-size:9px; font-weight:normal; font-style:normal; }
                    .csEE1F9023 {color:#000000;background-color:transparent;border-left-style: none;border-top:#000000 1px solid;border-right:#000000 1px solid;border-bottom:#000000 1px solid;font-family:Times New Roman; font-size:11px; font-weight:bold; font-style:normal; }
                    .cs5A34C077 {color:#000000;background-color:transparent;border-left-style: none;border-top:#000000 1px solid;border-right:#000000 1px solid;border-bottom:#000000 1px solid;font-family:Times New Roman; font-size:9px; font-weight:bold; font-style:normal; }
                    .cs6AEC9C2 {color:#000000;background-color:transparent;border-left-style: none;border-top:#000000 1px solid;border-right:#000000 1px solid;border-bottom:#000000 1px solid;font-family:Times New Roman; font-size:9px; font-weight:normal; font-style:normal; }
                    .cs8A513397 {color:#000000;background-color:transparent;border-left-style: none;border-top-style: none;border-right-style: none;border-bottom-style: none;font-family:Times New Roman; font-size:13px; font-weight:bold; font-style:normal; padding-left:2px;}
                    .cs8BD51C12 {color:#000000;background-color:transparent;border-left-style: none;border-top-style: none;border-right-style: none;border-bottom-style: none;font-family:Times New Roman; font-size:13px; font-weight:bold; font-style:normal; padding-left:2px;padding-right:2px;}
                    .cs101A94F7 {color:#000000;background-color:transparent;border-left-style: none;border-top-style: none;border-right-style: none;border-bottom-style: none;font-family:Times New Roman; font-size:13px; font-weight:normal; font-style:normal; }
                    .cs6105B8F3 {color:#000000;background-color:transparent;border-left-style: none;border-top-style: none;border-right-style: none;border-bottom-style: none;font-family:Times New Roman; font-size:13px; font-weight:normal; font-style:normal; padding-left:2px;}
                    .cs5EA817F2 {color:#000000;background-color:transparent;border-left-style: none;border-top-style: none;border-right-style: none;border-bottom-style: none;font-family:Times New Roman; font-size:13px; font-weight:normal; font-style:normal; padding-left:2px;padding-right:2px;}
                    .cs2C853136 {color:#000000;background-color:transparent;border-left-style: none;border-top-style: none;border-right-style: none;border-bottom-style: none;font-family:Times New Roman; font-size:19px; font-weight:bold; font-style:normal; padding-left:2px;padding-right:2px;}
                    .cs739196BC {color:#5C5C5C;background-color:transparent;border-left-style: none;border-top-style: none;border-right-style: none;border-bottom-style: none;font-family:Segoe UI; font-size:11px; font-weight:normal; font-style:normal; }
                    .csF7D3565D {height:0px;width:0px;overflow:hidden;font-size:0px;line-height:0px;}
                </style>
            </head>
            <body leftMargin=10 topMargin=10 rightMargin=10 bottomMargin=10 style="background-color:#FFFFFF">
            <table cellpadding="0" cellspacing="0" border="0" style="border-width:0px;empty-cells:show;width:844px;height:375px;position:relative;">
                <tr>
                    <td style="width:0px;height:0px;"></td>
                    <td style="height:0px;width:10px;"></td>
                    <td style="height:0px;width:38px;"></td>
                    <td style="height:0px;width:62px;"></td>
                    <td style="height:0px;width:77px;"></td>
                    <td style="height:0px;width:4px;"></td>
                    <td style="height:0px;width:128px;"></td>
                    <td style="height:0px;width:1px;"></td>
                    <td style="height:0px;width:89px;"></td>
                    <td style="height:0px;width:41px;"></td>
                    <td style="height:0px;width:76px;"></td>
                    <td style="height:0px;width:72px;"></td>
                    <td style="height:0px;width:24px;"></td>
                    <td style="height:0px;width:8px;"></td>
                    <td style="height:0px;width:36px;"></td>
                    <td style="height:0px;width:45px;"></td>
                    <td style="height:0px;width:7px;"></td>
                    <td style="height:0px;width:12px;"></td>
                    <td style="height:0px;width:114px;"></td>
                </tr>
                <tr style="vertical-align:top;">
                    <td style="width:0px;height:23px;"></td>
                    <td class="cs739196BC" colspan="8" style="width:409px;height:23px;line-height:14px;text-align:center;vertical-align:middle;"></td>
                    <td></td>
                    <td></td>
                    <td></td>
                    <td></td>
                    <td></td>
                    <td></td>
                    <td></td>
                    <td></td>
                    <td></td>
                    <td></td>
                </tr>
                <tr style="vertical-align:top;">
                    <td style="width:0px;height:10px;"></td>
                    <td></td>
                    <td></td>
                    <td></td>
                    <td></td>
                    <td></td>
                    <td></td>
                    <td></td>
                    <td></td>
                    <td></td>
                    <td></td>
                    <td></td>
                    <td></td>
                    <td></td>
                    <td></td>
                    <td></td>
                    <td></td>
                    <td></td>
                    <td></td>
                </tr>
                <tr style="vertical-align:top;">
                    <td style="width:0px;height:22px;"></td>
                    <td></td>
                    <td class="cs8A513397" colspan="10" style="width:586px;height:22px;line-height:15px;text-align:left;vertical-align:middle;"><nobr>'.$nomEse.'</nobr></td>
                    <td></td>
                    <td></td>
                    <td></td>
                    <td></td>
                    <td></td>
                    <td class="cs101A94F7" colspan="2" rowspan="5" style="width:126px;height:110px;text-align:left;vertical-align:top;"><div style="overflow:hidden;width:126px;height:110px;">
                        <img alt="" src="'.$pic2.'" style="width:126px;height:110px;" /></div>
                    </td>
                </tr>
                <tr style="vertical-align:top;">
                    <td style="width:0px;height:22px;"></td>
                    <td></td>
                    <td class="cs6105B8F3" colspan="10" style="width:586px;height:22px;line-height:15px;text-align:left;vertical-align:middle;"><nobr>'.$busnessName.'</nobr></td>
                    <td></td>
                    <td></td>
                    <td></td>
                    <td></td>
                    <td></td>
                </tr>
                <tr style="vertical-align:top;">
                    <td style="width:0px;height:22px;"></td>
                    <td></td>
                    <td class="cs8A513397" colspan="10" style="width:586px;height:22px;line-height:15px;text-align:left;vertical-align:middle;"><nobr>RCCM'.$rccEse.'.&nbsp;ID-NAT.'.$idNatEse.'</nobr></td>
                    <td></td>
                    <td></td>
                    <td></td>
                    <td></td>
                    <td></td>
                </tr>
                <tr style="vertical-align:top;">
                    <td style="width:0px;height:22px;"></td>
                    <td></td>
                    <td class="cs8A513397" colspan="10" style="width:586px;height:22px;line-height:15px;text-align:left;vertical-align:middle;"><nobr>N&#176;&nbsp;00056789/M</nobr></td>
                    <td></td>
                    <td></td>
                    <td></td>
                    <td></td>
                    <td></td>
                </tr>
                <tr style="vertical-align:top;">
                    <td style="width:0px;height:22px;"></td>
                    <td></td>
                    <td class="cs6105B8F3" colspan="10" style="width:586px;height:22px;line-height:15px;text-align:left;vertical-align:middle;"><nobr>'.$adresseEse.'</nobr></td>
                    <td></td>
                    <td></td>
                    <td></td>
                    <td></td>
                    <td></td>
                </tr>
                <tr style="vertical-align:top;">
                    <td style="width:0px;height:22px;"></td>
                    <td></td>
                    <td class="cs6105B8F3" colspan="10" style="width:586px;height:22px;line-height:15px;text-align:left;vertical-align:middle;"><nobr>E-mail&nbsp;:&nbsp;'.$emailEse.'</nobr></td>
                    <td></td>
                    <td></td>
                    <td></td>
                    <td></td>
                    <td></td>
                    <td></td>
                    <td></td>
                </tr>
                <tr style="vertical-align:top;">
                    <td style="width:0px;height:22px;"></td>
                    <td></td>
                    <td class="cs6105B8F3" colspan="10" style="width:586px;height:22px;line-height:15px;text-align:left;vertical-align:middle;"><nobr>Site-web&nbsp;:&nbsp;'.$siteEse.'</nobr></td>
                    <td></td>
                    <td></td>
                    <td></td>
                    <td></td>
                    <td></td>
                    <td></td>
                    <td></td>
                </tr>
                <tr style="vertical-align:top;">
                    <td style="width:0px;height:23px;"></td>
                    <td></td>
                    <td class="cs8A513397" colspan="10" style="width:586px;height:23px;line-height:15px;text-align:left;vertical-align:middle;"><nobr>Tel&#233;phone&nbsp;:&nbsp;'.$Tel1Ese.'</nobr></td>
                    <td></td>
                    <td></td>
                    <td></td>
                    <td></td>
                    <td></td>
                    <td></td>
                    <td></td>
                </tr>
                <tr style="vertical-align:top;">
                    <td style="width:0px;height:16px;"></td>
                    <td></td>
                    <td></td>
                    <td></td>
                    <td></td>
                    <td></td>
                    <td></td>
                    <td></td>
                    <td></td>
                    <td></td>
                    <td></td>
                    <td></td>
                    <td></td>
                    <td></td>
                    <td></td>
                    <td></td>
                    <td></td>
                    <td></td>
                    <td></td>
                </tr>
                <tr style="vertical-align:top;">
                    <td style="width:0px;height:23px;"></td>
                    <td></td>
                    <td></td>
                    <td></td>
                    <td class="cs2C853136" colspan="12" style="width:597px;height:23px;line-height:22px;text-align:center;vertical-align:middle;"><nobr>RAPPORT&nbsp;DES&nbsp;TRANSFERT&nbsp;PAR&nbsp;SERVICE&nbsp;RECEPTEUR</nobr></td>
                    <td></td>
                    <td></td>
                    <td></td>
                </tr>
                <tr style="vertical-align:top;">
                    <td style="width:0px;height:22px;"></td>
                    <td></td>
                    <td></td>
                    <td></td>
                    <td></td>
                    <td></td>
                    <td></td>
                    <td class="cs5EA817F2" colspan="4" style="width:203px;height:22px;line-height:15px;text-align:center;vertical-align:middle;"><nobr>'.$date1.'&nbsp;&nbsp;au&nbsp;&nbsp;'.$date2.'</nobr></td>
                    <td></td>
                    <td></td>
                    <td></td>
                    <td></td>
                    <td></td>
                    <td></td>
                    <td></td>
                    <td></td>
                </tr>
                <tr style="vertical-align:top;">
                    <td style="width:0px;height:22px;"></td>
                    <td></td>
                    <td></td>
                    <td></td>
                    <td></td>
                    <td class="cs8BD51C12" colspan="8" style="width:431px;height:22px;line-height:15px;text-align:center;vertical-align:middle;"><nobr>Service&nbsp;Source&nbsp;:&nbsp;'.$services.'</nobr></td>
                    <td></td>
                    <td></td>
                    <td></td>
                    <td></td>
                    <td></td>
                    <td></td>
                </tr>
                <tr style="vertical-align:top;">
                    <td style="width:0px;height:10px;"></td>
                    <td></td>
                    <td></td>
                    <td></td>
                    <td></td>
                    <td></td>
                    <td></td>
                    <td></td>
                    <td></td>
                    <td></td>
                    <td></td>
                    <td></td>
                    <td></td>
                    <td></td>
                    <td></td>
                    <td></td>
                    <td></td>
                    <td></td>
                    <td></td>
                </tr>
                <tr style="vertical-align:top;">
                    <td style="width:0px;height:24px;"></td>
                    <td></td>
                    <td class="cs1E4BB091" style="width:36px;height:22px;line-height:12px;text-align:center;vertical-align:middle;"><nobr>N&#176;</nobr></td>
                    <td class="csEE1F9023" style="width:61px;height:22px;line-height:12px;text-align:center;vertical-align:middle;"><nobr>Date</nobr></td>
                    <td class="csEE1F9023" colspan="2" style="width:80px;height:22px;line-height:12px;text-align:center;vertical-align:middle;"><nobr>N&#176;&nbsp;Transfert</nobr></td>
                    <td class="csEE1F9023" colspan="2" style="width:128px;height:22px;line-height:12px;text-align:center;vertical-align:middle;"><nobr>Service&nbsp;Source</nobr></td>
                    <td class="csEE1F9023" colspan="2" style="width:129px;height:22px;line-height:12px;text-align:center;vertical-align:middle;"><nobr>Sercive&nbsp;Destination</nobr></td>
                    <td class="csEE1F9023" colspan="4" style="width:179px;height:22px;line-height:12px;text-align:center;vertical-align:middle;"><nobr>Produit</nobr></td>
                    <td class="csEE1F9023" style="width:35px;height:22px;line-height:12px;text-align:center;vertical-align:middle;"><nobr>Qt&#233;</nobr></td>
                    <td class="csEE1F9023" colspan="3" style="width:63px;height:22px;line-height:12px;text-align:center;vertical-align:middle;"><nobr>PU</nobr></td>
                    <td class="csEE1F9023" style="width:113px;height:22px;line-height:12px;text-align:center;vertical-align:middle;"><nobr>PT</nobr></td>
                </tr>
                ';

                                        $output .= $this->showDetailTransfert_Service_Destination($date1,$date2,$idService); 

                                        $output.='
                <tr style="vertical-align:top;">
                    <td style="width:0px;height:24px;"></td>
                    <td></td>
                    <td></td>
                    <td></td>
                    <td></td>
                    <td></td>
                    <td></td>
                    <td></td>
                    <td></td>
                    <td></td>
                    <td></td>
                    <td></td>
                    <td></td>
                    <td></td>
                    <td class="csDB0B2364" colspan="4" style="width:98px;height:22px;line-height:10px;text-align:center;vertical-align:middle;"><nobr>TOTAL</nobr></td>
                    <td class="cs5A34C077" style="width:113px;height:22px;line-height:10px;text-align:center;vertical-align:middle;"><nobr>'.$TotalTransfert.'$</nobr></td>
                </tr>
            </table>
            </body>
            </html>      
        ';  
       
        return $output; 

}
function showDetailTransfert_Service_Destination($date1,$date2,$idService)
{
        $data = DB::table('tvente_detail_transfert')  
        ->join('tvente_entete_transfert','tvente_entete_transfert.id','=','tvente_detail_transfert.refEnteteTransfert')     
        ->join('tvente_services as servicesOrigine','servicesOrigine.id','=','tvente_entete_transfert.refService')
        ->join('tvente_services as servicesDestination','servicesDestination.id','=','tvente_detail_transfert.refDestination')
        ->join('tvente_produit','tvente_produit.id','=','tvente_detail_transfert.refProduit')
        ->join('tvente_categorie_produit','tvente_categorie_produit.id','=','tvente_produit.refCategorie')

        ->select('tvente_detail_transfert.id','refEnteteTransfert','refProduit','refDestination','puTransfert',
        'qteTransfert','uniteTransfert','tvente_detail_transfert.puBase','tvente_detail_transfert.qteBase',
        'tvente_detail_transfert.uniteBase','tvente_detail_transfert.author','tvente_detail_transfert.refUser',
        'tvente_detail_transfert.created_at','refService','date_transfert',"servicesOrigine.nom_service as ServiceOrigine",
        "servicesDestination.nom_service as ServiceDestination"

        ,"tvente_produit.designation as designation",'refCategorie','refUniteBase','pu','qte',
        'cmup','devise','taux','Oldcode','Newcode','tvaapplique','estvendable',"tvente_categorie_produit.designation as Categorie"        
        )
        ->selectRaw('(qteTransfert*puTransfert) as PTTransfert')
        ->selectRaw('(qteBase*puBase) as PTBase')
        ->selectRaw('CONCAT("S",YEAR(date_transfert),"",MONTH(date_transfert),"00",refEnteteTransfert) as codeFacture')
        ->where([
            ['date_transfert','>=', $date1],
            ['date_transfert','<=', $date2],
            ['servicesDestination.id','=', $idService]
        ])
        ->orderBy("tvente_detail_transfert.created_at", "asc")
        ->get();
        $output='';

        foreach ($data as $row) 
        {

            $output .='
                	<tr style="vertical-align:top;">
                    <td style="width:0px;height:24px;"></td>
                    <td></td>
                    <td class="cs463A9CD7" style="width:36px;height:22px;line-height:10px;text-align:center;vertical-align:middle;"><nobr>1</nobr></td>
                    <td class="cs6AEC9C2" style="width:61px;height:22px;line-height:10px;text-align:center;vertical-align:middle;"><nobr>'.$row->date_transfert.'</nobr></td>
                    <td class="cs6AEC9C2" colspan="2" style="width:80px;height:22px;line-height:10px;text-align:center;vertical-align:middle;"><nobr>'.$row->codeFacture.'</nobr></td>
                    <td class="cs6AEC9C2" colspan="2" style="width:128px;height:22px;line-height:10px;text-align:left;vertical-align:middle;">'.$row->ServiceOrigine.'</td>
                    <td class="cs6AEC9C2" colspan="2" style="width:129px;height:22px;line-height:10px;text-align:left;vertical-align:middle;">'.$row->ServiceDestination.'</td>
                    <td class="cs6AEC9C2" colspan="4" style="width:179px;height:22px;line-height:10px;text-align:left;vertical-align:middle;">'.$row->designation.'</td>
                    <td class="cs6AEC9C2" style="width:35px;height:22px;line-height:10px;text-align:center;vertical-align:middle;"><nobr>'.$row->qteTransfert.'('.$row->uniteTransfert.')</nobr></td>
                    <td class="cs6AEC9C2" colspan="3" style="width:63px;height:22px;line-height:10px;text-align:center;vertical-align:middle;"><nobr>'.$row->puTransfert.'$</nobr></td>
                    <td class="cs6AEC9C2" style="width:113px;height:22px;line-height:10px;text-align:center;vertical-align:middle;"><nobr>'.$row->PTTransfert.'$</nobr></td>
                </tr>
            ';         
   
    }

    return $output;

}










//== FICHE DE STOCK DES SERVICES SANS PRIX ET POUR LES FILTRES DES NON VENDABLES ET VENDABLES=======================================================================================

//pdf_fiche_stock_vente_service_by_vendable
//pdf_fiche_stock_vente_service_by_sans_prix

function pdf_fiche_stock_vente_service_by_sans_prix(Request $request)
{

    if ($request->get('date1') && $request->get('date2') && $request->get('idService')) {
        // code...
        $date1 = $request->get('date1');
        $date2 = $request->get('date2');
        $idService = $request->get('idService');
        
        $html ='<html><head><meta http-equiv="Content-Type" content="text/html; charset=utf-8"/>';
        $html .= $this->getInfoFicheStockServicesBySansPrix($date1,$date2,$idService);       
        $html .='<script>window.print()</script>';

        echo($html); 
        
    }
    else{
    }    
}

function getInfoFicheStockServicesBySansPrix($date1,$date2,$idService)
{
           //Info Entreprise
           $nomEse='';
           $adresseEse='';
           $Tel1Ese='';
           $Tel2Ese='';
           $siteEse='';
           $emailEse='';
           $idNatEse='';
           $numImpotEse='';
           $rccEse='';
           $siege='';
           $busnessName='';
           $pic='';
           $pic2 = $this->displayImg("fichier", 'logo.png');
           $logo='';
   
           $data1 = DB::table('entreprises')
           ->join('secteurs','secteurs.id','=','entreprises.idsecteur')
           ->join('forme_juridiques','forme_juridiques.id','=','entreprises.idforme')
   
           ->join('pays','pays.id','=','entreprises.idPays')
           ->join('provinces','provinces.id','=','entreprises.idProvince')
           ->join('users','users.id','=','entreprises.ceo')        
           ->select('entreprises.id as id','entreprises.id as idEntreprise',
           'entreprises.ceo','entreprises.nomEntreprise','entreprises.descriptionEntreprise',
           'entreprises.emailEntreprise','entreprises.adresseEntreprise',
           'entreprises.telephoneEntreprise','entreprises.solutionEntreprise','entreprises.idsecteur',
           'entreprises.idforme','entreprises.etat',
           'entreprises.idPays','entreprises.idProvince','entreprises.edition','entreprises.facebook',
           'entreprises.linkedin','entreprises.twitter','entreprises.siteweb','entreprises.rccm',
           'entreprises.invPersonnel','entreprises.invHub','entreprises.invRecherche',
           'entreprises.chiffreAffaire','entreprises.nbremploye','entreprises.slug','entreprises.logo',
            //forme
            'forme_juridiques.nomForme','secteurs.nomSecteur',
            //users
            'users.name','users.email','users.avatar','users.telephone','users.adresse',
            //
            'provinces.nomProvince','pays.nomPays', 'entreprises.created_at')
           ->get();
           $output='';
           foreach ($data1 as $row1) 
           {                                
               $nomEse=$row1->nomEntreprise;
               $adresseEse=$row1->adresseEntreprise;
               $Tel1Ese=$row1->telephoneEntreprise;
               $Tel2Ese=$row1->telephone;
               $siteEse=$row1->siteweb;
               $emailEse=$row1->emailEntreprise;
               $idNatEse=$row1->rccm;
               $numImpotEse=$row1->rccm;
               $busnessName=$row1->nomSecteur;
               $rccmEse=$row1->rccm;
               $pic = $this->displayImg("fichier", 'logo.png');
               $siege=$row1->nomForme;         
           }


           $totalVente = 0;
           $totalTransfert=0;
           $totalCMUP = 0;
           $globalTP=0;

           $data5 = DB::table('tvente_detail_vente')
           ->join('tvente_stock_service','tvente_stock_service.id','=','tvente_detail_vente.idStockService')
           ->join('tvente_produit','tvente_produit.id','=','tvente_stock_service.refProduit')
           ->join('tvente_categorie_produit','tvente_categorie_produit.id','=','tvente_produit.refCategorie')
           ->join('tvente_entete_vente','tvente_entete_vente.id','=','tvente_detail_vente.refEnteteVente')
           ->select(DB::raw('IFNULL(ROUND(SUM(qteVente*puVente),0),0) as totalSortie'))
           ->where([               
               ['tvente_entete_vente.dateVente','>=', $date1],
               ['tvente_entete_vente.dateVente','<=', $date2],
               ['tvente_stock_service.refService','=', $idService]
           ])->get(); 
           
           foreach ($data5 as $row5) 
           {                                
            //   $totalVente=$row5->totalSortie;  
              $totalVente=0;                          
           }


           $CategorieClient=''; 

           $data3=DB::table('tvente_services')
           ->select('id','nom_service','status','active')
           ->where([
              ['tvente_services.id','=', $idService]
          ])      
          ->get();      
          $output='';
          foreach ($data3 as $row) 
          {
              $CategorieClient=$row->nom_service;              
          }
  
   
            $output=' 

            <!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Transitional//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd">
            <!-- saved from url=(0016)http://localhost -->
            <html>
            <head>
                <title>FicheStock</title>
                <meta HTTP-EQUIV="Content-Type" CONTENT="text/html; charset=utf-8"/>
                <style type="text/css">
                    .cs1B222893 {color:#000000;background-color:#D6E5F4;border-left:#004000 1px solid;border-top:#004000 1px solid;border-right:#004000 1px solid;border-bottom:#004000 1px solid;font-family:Times New Roman; font-size:27px; font-weight:bold; font-style:normal; padding-left:2px;padding-right:2px;}
                    .cs6F7E55AC {color:#000000;background-color:#D6E5F4;border-left-style: none;border-top:#004000 1px solid;border-right:#004000 1px solid;border-bottom:#004000 1px solid;font-family:Times New Roman; font-size:13px; font-weight:bold; font-style:normal; }
                    .csE0D816CD {color:#000000;background-color:#D6E5F4;border-left-style: none;border-top-style: none;border-right-style: none;border-bottom-style: none;font-family:Times New Roman; font-size:15px; font-weight:bold; font-style:normal; padding-left:2px;padding-right:2px;}
                    .cs8F59FFB2 {color:#000000;background-color:#F5F5F5;border-left:#004000 1px solid;border-top:#004000 1px solid;border-right:#004000 1px solid;border-bottom:#004000 1px solid;font-family:Times New Roman; font-size:13px; font-weight:bold; font-style:normal; }
                    .csF3AA49E4 {color:#000000;background-color:#F5F5F5;border-left-style: none;border-top:#004000 1px solid;border-right:#004000 1px solid;border-bottom:#004000 1px solid;font-family:Times New Roman; font-size:13px; font-weight:bold; font-style:normal; }
                    .csE78F4A6 {color:#000000;background-color:#F5F5F5;border-left-style: none;border-top:#004000 1px solid;border-right:#004000 1px solid;border-bottom:#004000 1px solid;font-family:Times New Roman; font-size:13px; font-weight:normal; font-style:normal; }
                    .cs4B928201 {color:#000000;background-color:#FFFFFF;border-left-style: none;border-top:#004000 1px solid;border-right:#004000 1px solid;border-bottom:#004000 1px solid;font-family:Times New Roman; font-size:13px; font-weight:bold; font-style:normal; }
                    .cs2C96DE68 {color:#000000;background-color:transparent;border-left:#000000 1px solid;border-top:#000000 1px solid;border-right:#000000 1px solid;border-bottom:#000000 1px solid;font-family:Times New Roman; font-size:13px; font-weight:normal; font-style:italic; padding-left:2px;}
                    .csE71035DC {color:#000000;background-color:transparent;border-left:#000000 1px solid;border-top:#000000 1px solid;border-right:#000000 1px solid;border-bottom:#000000 1px solid;font-family:Times New Roman; font-size:13px; font-weight:normal; font-style:normal; }
                    .csAB3AA82A {color:#000000;background-color:transparent;border-left-style: none;border-top:#000000 1px solid;border-right:#000000 1px solid;border-bottom:#000000 1px solid;font-family:Times New Roman; font-size:13px; font-weight:bold; font-style:normal; }
                    .csC73F4F41 {color:#000000;background-color:transparent;border-left-style: none;border-top:#004000 1px solid;border-right:#004000 1px solid;border-bottom:#004000 1px solid;font-family:Times New Roman; font-size:13px; font-weight:bold; font-style:normal; }
                    .csD149F8AB {color:#000000;background-color:transparent;border-left-style: none;border-top:#004000 1px solid;border-right:#004000 1px solid;border-bottom:#004000 1px solid;font-family:Times New Roman; font-size:13px; font-weight:normal; font-style:normal; }
                    .cs612ED82F {color:#000000;background-color:transparent;border-left-style: none;border-top-style: none;border-right-style: none;border-bottom-style: none;font-family:Times New Roman; font-size:12px; font-weight:bold; font-style:normal; padding-left:2px;}
                    .csFFC1C457 {color:#000000;background-color:transparent;border-left-style: none;border-top-style: none;border-right-style: none;border-bottom-style: none;font-family:Times New Roman; font-size:12px; font-weight:normal; font-style:normal; padding-left:2px;}
                    .cs101A94F7 {color:#000000;background-color:transparent;border-left-style: none;border-top-style: none;border-right-style: none;border-bottom-style: none;font-family:Times New Roman; font-size:13px; font-weight:normal; font-style:normal; }
                    .csCE72709D {color:#000000;background-color:transparent;border-left-style: none;border-top-style: none;border-right-style: none;border-bottom-style: none;font-family:Times New Roman; font-size:14px; font-weight:bold; font-style:normal; padding-left:2px;}
                    .csFBB219FE {color:#000000;background-color:transparent;border-left-style: none;border-top-style: none;border-right-style: none;border-bottom-style: none;font-family:Times New Roman; font-size:18px; font-weight:bold; font-style:normal; padding-left:2px;}
                    .cs739196BC {color:#5C5C5C;background-color:transparent;border-left-style: none;border-top-style: none;border-right-style: none;border-bottom-style: none;font-family:Segoe UI; font-size:11px; font-weight:normal; font-style:normal; }
                    .csF7D3565D {height:0px;width:0px;overflow:hidden;font-size:0px;line-height:0px;}
                </style>
            </head>
            <body leftMargin=10 topMargin=10 rightMargin=10 bottomMargin=10 style="background-color:#FFFFFF">
            <table cellpadding="0" cellspacing="0" border="0" style="border-width:0px;empty-cells:show;width:958px;height:352px;position:relative;">
                <tr>
                    <td style="width:0px;height:0px;"></td>
                    <td style="height:0px;width:6px;"></td>
                    <td style="height:0px;width:4px;"></td>
                    <td style="height:0px;width:163px;"></td>
                    <td style="height:0px;width:47px;"></td>
                    <td style="height:0px;width:59px;"></td>
                    <td style="height:0px;width:108px;"></td>
                    <td style="height:0px;width:22px;"></td>
                    <td style="height:0px;width:88px;"></td>
                    <td style="height:0px;width:77px;"></td>
                    <td style="height:0px;width:89px;"></td>
                    <td style="height:0px;width:21px;"></td>
                    <td style="height:0px;width:18px;"></td>
                    <td style="height:0px;width:86px;"></td>
                    <td style="height:0px;width:36px;"></td>
                    <td style="height:0px;width:132px;"></td>
                    <td style="height:0px;width:2px;"></td>
                </tr>
                <tr style="vertical-align:top;">
                    <td style="width:0px;height:23px;"></td>
                    <td></td>
                    <td></td>
                    <td></td>
                    <td></td>
                    <td></td>
                    <td></td>
                    <td></td>
                    <td></td>
                    <td></td>
                    <td></td>
                </tr>
                <tr style="vertical-align:top;">
                    <td style="width:0px;height:3px;"></td>
                    <td></td>
                    <td></td>
                    <td></td>
                    <td></td>
                    <td></td>
                    <td></td>
                    <td></td>
                    <td></td>
                    <td></td>
                    <td></td>
                    <td></td>
                    <td></td>
                    <td></td>
                    <td></td>
                    <td></td>
                    <td></td>
                </tr>
                <tr style="vertical-align:top;">
                    <td style="width:0px;height:10px;"></td>
                    <td></td>
                    <td></td>
                    <td class="csFBB219FE" colspan="10" rowspan="2" style="width:690px;height:23px;line-height:21px;text-align:left;vertical-align:middle;">'.$nomEse.'</td>
                    <td></td>
                    <td></td>
                    <td></td>
                    <td></td>
                </tr>
                <tr style="vertical-align:top;">
                    <td style="width:0px;height:13px;"></td>
                    <td></td>
                    <td></td>
                    <td></td>
                    <td class="cs101A94F7" colspan="2" rowspan="7" style="width:168px;height:144px;text-align:left;vertical-align:top;"><div style="overflow:hidden;width:168px;height:144px;">
                        <img alt="" src="'.$pic2.'" style="width:168px;height:144px;" /></div>
                    </td>
                    <td></td>
                </tr>
                <tr style="vertical-align:top;">
                    <td style="width:0px;height:22px;"></td>
                    <td></td>
                    <td></td>
                    <td class="csCE72709D" colspan="10" style="width:690px;height:22px;line-height:15px;text-align:left;vertical-align:middle;">'.$busnessName.'</td>
                    <td></td>
                    <td></td>
                </tr>
                <tr style="vertical-align:top;">
                    <td style="width:0px;height:22px;"></td>
                    <td></td>
                    <td></td>
                    <td class="csCE72709D" colspan="10" style="width:690px;height:22px;line-height:15px;text-align:left;vertical-align:middle;"><nobr>RCCM'.$rccEse.'.&nbsp;ID-NAT.'.$numImpotEse.'</nobr></td>
                    <td></td>
                    <td></td>
                </tr>
                <tr style="vertical-align:top;">
                    <td style="width:0px;height:22px;"></td>
                    <td></td>
                    <td></td>
                    <td class="csFFC1C457" colspan="10" style="width:690px;height:22px;line-height:13px;text-align:left;vertical-align:middle;">'.$adresseEse.'</td>
                    <td></td>
                    <td></td>
                </tr>
                <tr style="vertical-align:top;">
                    <td style="width:0px;height:22px;"></td>
                    <td></td>
                    <td></td>
                    <td class="csFFC1C457" colspan="10" style="width:690px;height:22px;line-height:13px;text-align:left;vertical-align:middle;"><nobr>Email&nbsp;:&nbsp;'.$emailEse.'</nobr></td>
                    <td></td>
                    <td></td>
                </tr>
                <tr style="vertical-align:top;">
                    <td style="width:0px;height:22px;"></td>
                    <td></td>
                    <td></td>
                    <td class="csFFC1C457" colspan="10" style="width:690px;height:22px;line-height:13px;text-align:left;vertical-align:middle;"><nobr>Site&nbsp;web&nbsp;:&nbsp;'.$siteEse.'</nobr></td>
                    <td></td>
                    <td></td>
                </tr>
                <tr style="vertical-align:top;">
                    <td style="width:0px;height:21px;"></td>
                    <td></td>
                    <td></td>
                    <td class="cs612ED82F" colspan="10" rowspan="2" style="width:690px;height:22px;line-height:13px;text-align:left;vertical-align:middle;"><nobr>T&#233;l&#233;phone&nbsp;:&nbsp;'.$Tel1Ese.'&nbsp;&nbsp;24h/24</nobr></td>
                    <td></td>
                    <td></td>
                </tr>
                <tr style="vertical-align:top;">
                    <td style="width:0px;height:1px;"></td>
                    <td></td>
                    <td></td>
                    <td></td>
                    <td></td>
                    <td></td>
                    <td></td>
                </tr>
                <tr style="vertical-align:top;">
                    <td style="width:0px;height:14px;"></td>
                    <td></td>
                    <td></td>
                    <td></td>
                    <td></td>
                    <td></td>
                    <td></td>
                    <td></td>
                    <td></td>
                    <td></td>
                    <td></td>
                    <td></td>
                    <td></td>
                    <td></td>
                    <td></td>
                    <td></td>
                    <td></td>
                </tr>
                <tr style="vertical-align:top;">
                    <td style="width:0px;height:34px;"></td>
                    <td></td>
                    <td></td>
                    <td></td>
                    <td></td>
                    <td class="cs1B222893" colspan="6" style="width:437px;height:32px;line-height:31px;text-align:center;vertical-align:middle;"><nobr>FICHE&nbsp;DE&nbsp;STOCK : '.$CategorieClient.'</nobr></td>
                    <td></td>
                    <td></td>
                    <td></td>
                    <td></td>
                    <td></td>
                    <td></td>
                </tr>
                <tr style="vertical-align:top;">
                    <td style="width:0px;height:7px;"></td>
                    <td></td>
                    <td></td>
                    <td></td>
                    <td></td>
                    <td></td>
                    <td></td>
                    <td></td>
                    <td></td>
                    <td></td>
                    <td></td>
                    <td></td>
                    <td></td>
                    <td></td>
                    <td></td>
                    <td></td>
                    <td></td>
                </tr>
                <tr style="vertical-align:top;">
                    <td style="width:0px;height:24px;"></td>
                    <td></td>
                    <td class="csE71035DC" colspan="10" style="width:676px;height:22px;line-height:15px;text-align:center;vertical-align:middle;"><nobr>TOTAL&nbsp;VENTE(USD)</nobr></td>
                    <td class="csAB3AA82A" colspan="5" style="width:273px;height:22px;line-height:15px;text-align:center;vertical-align:middle;"><nobr>'.$totalVente.'$</nobr></td>
                </tr>
                <tr style="vertical-align:top;">
                    <td style="width:0px;height:24px;"></td>
                    <td></td>
                    <td class="cs8F59FFB2" colspan="2" style="width:165px;height:22px;line-height:15px;text-align:center;vertical-align:middle;"><nobr>PRODUIT</nobr></td>
                    <td class="cs6F7E55AC" colspan="2" style="width:105px;height:22px;line-height:15px;text-align:center;vertical-align:middle;"><nobr>SI</nobr></td>
                    <td class="csF3AA49E4" style="width:107px;height:22px;line-height:15px;text-align:center;vertical-align:middle;"><nobr>ENTREE</nobr></td>
                    <td class="csC73F4F41" colspan="2" style="width:109px;height:22px;line-height:15px;text-align:center;vertical-align:middle;"><nobr>TOTAL</nobr></td>
                    <td class="cs4B928201" colspan="2" style="width:109px;height:22px;line-height:15px;text-align:center;vertical-align:middle;"><nobr>SORTIE</nobr></td>
                    <td class="csF3AA49E4" style="width:76px;height:22px;line-height:15px;text-align:center;vertical-align:middle;"><nobr>SF</nobr></td>                    
                    <td class="cs4B928201" colspan="3" style="width:139px;height:22px;line-height:15px;text-align:center;vertical-align:middle;"><nobr>Unité</nobr></td>
                    <td class="cs6F7E55AC" colspan="2" style="width:133px;height:22px;line-height:15px;text-align:center;vertical-align:middle;"><nobr>Obs.</nobr></td>
                </tr>
                <tr style="vertical-align:top;">
                    <td style="width:0px;height:22px;"></td>
                    <td></td>
                    <td class="cs2C96DE68" colspan="15" style="width:948px;height:20px;line-height:15px;text-align:left;vertical-align:top;"><nobr>'.$date1.'</nobr></td>
                </tr>
                ';
                                                                
                   $output .= $this->showCategorieFicheStockServiceSansPrix($date1,$date2,$idService); 
                                                                
                 $output.='
            </table>
            </body>
            </html>

            '; 

    return $output;

} 

function showCategorieFicheStockServiceSansPrix($date1,$date2,$idService)
{
    $data = DB::table("tvente_categorie_produit")
    ->select("tvente_categorie_produit.id", "tvente_categorie_produit.designation", 
    "tvente_categorie_produit.created_at", "tvente_categorie_produit.author")    
    ->orderBy("tvente_categorie_produit.designation", "asc")
    ->get();
    
    $output='';

    foreach ($data as $row) 
    {
        $output .='
                <tr style="vertical-align:top;">
                <td style="width:0px;height:22px;"></td>
                <td></td>
                <td class="csE0D816CD" colspan="15" style="width:948px;height:22px;line-height:17px;text-align:center;vertical-align:middle;">'.$row->designation.'</td>
            </tr>
            ';
                                                    
                $output .= $this->showDetailFicheStockServiceSansPrix($date1,$date2,$row->id,$idService);                                                     
                $output.='
        ';      
    }

    return $output;

}
function showDetailFicheStockServiceSansPrix($date1, $date2, $refCategorie, $idService)
{
    // Récupérer les données de stock, mouvements et ventes en une seule requête 
    $data11 = DB::table('tvente_stock_service')
    ->join('tvente_services', 'tvente_services.id', '=', 'tvente_stock_service.refService')
    ->Join('tvente_produit', 'tvente_produit.id', '=', 'tvente_stock_service.refProduit')
    ->Join('tvente_categorie_produit', 'tvente_categorie_produit.id', '=', 'tvente_produit.refCategorie')

    ->leftJoin('tvente_mouvement_stock as dtEntree', function ($join) use ($date1, $idService) {
        $join->on('dtEntree.idStockService', '=', 'tvente_stock_service.id')        
             ->where('dtEntree.type_mouvement', '=', 'Entree')
             ->where('dtEntree.dateMvt', '<', $date1);
    })

        // Utilisez distinct() avant select()
        ->distinct()
        ->select(
            "tvente_stock_service.id",
            'tvente_stock_service.refService',
            'tvente_stock_service.refProduit',
            "tvente_produit.designation as designation",
            "refCategorie",
            "tvente_stock_service.pu",
            "tvente_categorie_produit.designation as Categorie",
            "tvente_stock_service.qte",
            "tvente_stock_service.uniteBase",
            "tvente_stock_service.cmup","tvente_stock_service.devise","tvente_stock_service.taux",            
            DB::raw('IFNULL(ROUND(SUM(dtEntree.qteBase * dtEntree.qteMvt), 3), 0) as totalEntree'),

        )
        ->where([
            ['tvente_produit.refCategorie', '=', $refCategorie],
            ['tvente_stock_service.refService', '=', $idService]
        ])
        ->groupBy("tvente_stock_service.id", "tvente_stock_service.refService", "tvente_stock_service.refProduit", 
        "designation", "refCategorie", "pu", "Categorie", "qte", "uniteBase","cmup",
        "tvente_stock_service.devise","tvente_stock_service.taux")
        ->orderBy("tvente_produit.designation", "asc")
        ->get();


    $data22 = DB::table('tvente_stock_service')
    ->join('tvente_services', 'tvente_services.id', '=', 'tvente_stock_service.refService')
    ->Join('tvente_produit', 'tvente_produit.id', '=', 'tvente_stock_service.refProduit')
    ->Join('tvente_categorie_produit', 'tvente_categorie_produit.id', '=', 'tvente_produit.refCategorie')

    ->leftJoin('tvente_mouvement_stock as dtSortie', function ($join) use ($date1, $idService) {
        $join->on('dtSortie.idStockService', '=', 'tvente_stock_service.id')        
             ->where('dtSortie.type_mouvement', '=', 'Sortie')
             ->where('dtSortie.dateMvt', '<', $date1);
    })
    // Utilisez distinct() avant select()
    ->distinct()
    ->select(
        "tvente_stock_service.id",
        'tvente_stock_service.refService',
        'tvente_stock_service.refProduit',
        "tvente_produit.designation as designation",
        "refCategorie",
        "tvente_stock_service.pu",
        "tvente_categorie_produit.designation as Categorie",
        "tvente_stock_service.qte",
        "tvente_stock_service.uniteBase",
        "tvente_stock_service.cmup",
        DB::raw('IFNULL(ROUND(SUM(dtSortie.qteBase * dtSortie.qteMvt), 3), 0) as totalSortie')
    )
    ->where([
        ['tvente_produit.refCategorie', '=', $refCategorie],
        ['tvente_stock_service.refService', '=', $idService]
    ])
    ->groupBy("tvente_stock_service.id", "tvente_stock_service.refService", "tvente_stock_service.refProduit", "designation", "refCategorie", "pu", "Categorie", "qte", "uniteBase","cmup")
    ->orderBy("tvente_produit.designation", "asc")
    ->get();

    // ============ LEs Mouvements =========================================================================

        // Récupérer les données de stock, mouvements et ventes en une seule requête 
        $data1 = DB::table('tvente_stock_service')
        ->join('tvente_services', 'tvente_services.id', '=', 'tvente_stock_service.refService')
        ->Join('tvente_produit', 'tvente_produit.id', '=', 'tvente_stock_service.refProduit')
        ->Join('tvente_categorie_produit', 'tvente_categorie_produit.id', '=', 'tvente_produit.refCategorie')
    
        ->leftJoin('tvente_mouvement_stock as mvtEntree', function ($join) use ($date1, $date2, $idService) {
            $join->on('mvtEntree.idStockService', '=', 'tvente_stock_service.id')        
                 ->where('mvtEntree.type_mouvement', '=', 'Entree')
                 ->whereBetween('mvtEntree.dateMvt', [$date1, $date2]);;
        })
    
            // Utilisez distinct() avant select()
            ->distinct()
            ->select(
                "tvente_stock_service.id",
                'tvente_stock_service.refService',
                'tvente_stock_service.refProduit',
                "tvente_produit.designation as designation",
                "refCategorie",
                "tvente_stock_service.pu",
                "tvente_categorie_produit.designation as Categorie",
                "tvente_stock_service.qte",
                "tvente_stock_service.uniteBase",
                "tvente_stock_service.cmup","tvente_stock_service.devise","tvente_stock_service.taux",            
                DB::raw('IFNULL(ROUND(SUM(mvtEntree.qteBase * mvtEntree.qteMvt), 3), 0) as stockEntree'),
    
            )
            ->where([
                ['tvente_produit.refCategorie', '=', $refCategorie],
                ['tvente_stock_service.refService', '=', $idService]
            ])
            ->groupBy("tvente_stock_service.id", "tvente_stock_service.refService", "tvente_stock_service.refProduit", 
            "designation", "refCategorie", "pu", "Categorie", "qte", "uniteBase","cmup",
            "tvente_stock_service.devise","tvente_stock_service.taux")
            ->orderBy("tvente_produit.designation", "asc")
            ->get();
    
    //======================================================================
    
        // Récupérer les données de stock, mouvements et ventes en une seule requête 
        $data2 = DB::table('tvente_stock_service')
        ->join('tvente_services', 'tvente_services.id', '=', 'tvente_stock_service.refService')
        ->Join('tvente_produit', 'tvente_produit.id', '=', 'tvente_stock_service.refProduit')
        ->Join('tvente_categorie_produit', 'tvente_categorie_produit.id', '=', 'tvente_produit.refCategorie')
    
        ->leftJoin('tvente_mouvement_stock as mvtSortie', function ($join) use ($date1, $date2, $idService) {
            $join->on('mvtSortie.idStockService', '=', 'tvente_stock_service.id')        
                 ->where('mvtSortie.type_mouvement', '=', 'Sortie')
                 ->whereBetween('mvtSortie.dateMvt', [$date1, $date2]);;
        })
    
            // Utilisez distinct() avant select()
            ->distinct()
            ->select(
                "tvente_stock_service.id",
                'tvente_stock_service.refService',
                'tvente_stock_service.refProduit',
                "tvente_produit.designation as designation",
                "refCategorie",
                "tvente_stock_service.pu",
                "tvente_categorie_produit.designation as Categorie",
                "tvente_stock_service.qte",
                "tvente_stock_service.uniteBase",
                "tvente_stock_service.cmup","tvente_stock_service.devise","tvente_stock_service.taux",            
                DB::raw('IFNULL(ROUND(SUM(mvtSortie.qteBase * mvtSortie.qteMvt), 3), 0) as stockSortie'),
    
            )
            ->where([
                ['tvente_produit.refCategorie', '=', $refCategorie],
                ['tvente_stock_service.refService', '=', $idService]
            ])
            ->groupBy("tvente_stock_service.id", "tvente_stock_service.refService", "tvente_stock_service.refProduit", 
            "designation", "refCategorie", "pu", "Categorie", "qte", "uniteBase","cmup",
            "tvente_stock_service.devise","tvente_stock_service.taux")
            ->orderBy("tvente_produit.designation", "asc")
            ->get();
    

    // Construction de l'output
    
    $output = '';

    // Vérifiez que les deux tableaux ont la même longueur
    if ((count($data1) === count($data2)) && (count($data1) === count($data11)) 
    && (count($data1) === count($data22)))
    {
        for ($i = 0; $i < count($data1); $i++) {
            $row11 = $data11[$i];
            $row22 = $data22[$i];
            $row1 = $data1[$i];
            $row2 = $data2[$i];            

            $totalSortie = floatval($row22->totalSortie);
            $totalEntree = floatval($row11->totalEntree);

            $stockSortie = floatval($row2->stockSortie);            
            $stockEntree = floatval($row1->stockEntree);

            $totalSI = ((floatval($totalEntree)) - (floatval($totalSortie)));
            $totalGEntree = floatval($stockEntree);
            $totalG = floatval($totalSI) + floatval($stockEntree);
            $TGSortie = floatval($stockSortie);
            $totalSF = floatval($totalG) - floatval($stockSortie);
            $totalPT = floatval($totalSF) * floatval($row2->cmup);

             $output .= '
                <tr style="vertical-align:top;">
                    <td style="width:0px;height:24px;"></td>
                    <td></td>
                    <td class="cs8F59FFB2" colspan="2" style="width:165px;height:22px;line-height:15px;text-align:center;vertical-align:middle;">'.$row1->designation.'</td>
                    <td class="cs6F7E55AC" colspan="2" style="width:105px;height:22px;line-height:15px;text-align:center;vertical-align:middle;">'.$totalSI.' '.$row1->uniteBase.'</td>
                    <td class="csE78F4A6" style="width:107px;height:22px;line-height:15px;text-align:center;vertical-align:middle;">'.$totalGEntree.' '.$row1->uniteBase.' </td>
                    <td class="csD149F8AB" colspan="2" style="width:109px;height:22px;line-height:15px;text-align:center;vertical-align:middle;">'.$totalG.' '.$row1->uniteBase.'</td>
                    <td class="cs4B928201" colspan="2" style="width:109px;height:22px;line-height:15px;text-align:center;vertical-align:middle;">'.$TGSortie.' '.$row1->uniteBase.'</td>
                    <td class="csE78F4A6" style="width:76px;height:22px;line-height:15px;text-align:center;vertical-align:middle;">'.$totalSF.' '.$row1->uniteBase.'</td>                
                    <td class="cs4B928201" colspan="3" style="width:139px;height:22px;line-height:15px;text-align:center;vertical-align:middle;">'.$row2->uniteBase.'</td>
                    <td class="cs6F7E55AC" colspan="2" style="width:133px;height:22px;line-height:15px;text-align:center;vertical-align:middle;">--</td>
                </tr>
            ';   

    }
    } else {
        // Gérer le cas où les tableaux n'ont pas la même longueur
        echo 'Les tableaux ont pas la même longueur.';
    }

    return $output;
}


//==============  VENDABLE===========================================================================

function pdf_fiche_stock_vente_service_by_vendable(Request $request)
{

    if ($request->get('date1') && $request->get('date2') && $request->get('idService')&& $request->get('statut')) {
        // code...
        $date1 = $request->get('date1');
        $date2 = $request->get('date2');
        $idService = $request->get('idService');
        $statut = $request->get('statut');
        
        $html ='<html><head><meta http-equiv="Content-Type" content="text/html; charset=utf-8"/>';
        $html .= $this->getInfoFicheStockServicesByVendable($date1,$date2,$idService,$statut);       
        $html .='<script>window.print()</script>';

        echo($html); 
        
    }
    else{
    }    
}
function getInfoFicheStockServicesByVendable($date1,$date2,$idService,$statut)
{
           //Info Entreprise
           $nomEse='';
           $adresseEse='';
           $Tel1Ese='';
           $Tel2Ese='';
           $siteEse='';
           $emailEse='';
           $idNatEse='';
           $numImpotEse='';
           $rccEse='';
           $siege='';
           $busnessName='';
           $pic='';
           $pic2 = $this->displayImg("fichier", 'logo.png');
           $logo='';
   
           $data1 = DB::table('entreprises')
           ->join('secteurs','secteurs.id','=','entreprises.idsecteur')
           ->join('forme_juridiques','forme_juridiques.id','=','entreprises.idforme')
   
           ->join('pays','pays.id','=','entreprises.idPays')
           ->join('provinces','provinces.id','=','entreprises.idProvince')
           ->join('users','users.id','=','entreprises.ceo')        
           ->select('entreprises.id as id','entreprises.id as idEntreprise',
           'entreprises.ceo','entreprises.nomEntreprise','entreprises.descriptionEntreprise',
           'entreprises.emailEntreprise','entreprises.adresseEntreprise',
           'entreprises.telephoneEntreprise','entreprises.solutionEntreprise','entreprises.idsecteur',
           'entreprises.idforme','entreprises.etat',
           'entreprises.idPays','entreprises.idProvince','entreprises.edition','entreprises.facebook',
           'entreprises.linkedin','entreprises.twitter','entreprises.siteweb','entreprises.rccm',
           'entreprises.invPersonnel','entreprises.invHub','entreprises.invRecherche',
           'entreprises.chiffreAffaire','entreprises.nbremploye','entreprises.slug','entreprises.logo',
            //forme
            'forme_juridiques.nomForme','secteurs.nomSecteur',
            //users
            'users.name','users.email','users.avatar','users.telephone','users.adresse',
            //
            'provinces.nomProvince','pays.nomPays', 'entreprises.created_at')
           ->get();
           $output='';
           foreach ($data1 as $row1) 
           {                                
               $nomEse=$row1->nomEntreprise;
               $adresseEse=$row1->adresseEntreprise;
               $Tel1Ese=$row1->telephoneEntreprise;
               $Tel2Ese=$row1->telephone;
               $siteEse=$row1->siteweb;
               $emailEse=$row1->emailEntreprise;
               $idNatEse=$row1->rccm;
               $numImpotEse=$row1->rccm;
               $busnessName=$row1->nomSecteur;
               $rccmEse=$row1->rccm;
               $pic = $this->displayImg("fichier", 'logo.png');
               $siege=$row1->nomForme;         
           }


           $totalVente = 0;
           $totalTransfert=0;
           $totalCMUP = 0;
           $globalTP=0;

           $data5 = DB::table('tvente_detail_vente')
           ->join('tvente_stock_service','tvente_stock_service.id','=','tvente_detail_vente.idStockService')
           ->join('tvente_produit','tvente_produit.id','=','tvente_stock_service.refProduit')
           ->join('tvente_categorie_produit','tvente_categorie_produit.id','=','tvente_produit.refCategorie')
           ->join('tvente_entete_vente','tvente_entete_vente.id','=','tvente_detail_vente.refEnteteVente')
           ->select(DB::raw('IFNULL(ROUND(SUM(qteVente*puVente),0),0) as totalSortie'))
           ->where([               
               ['tvente_entete_vente.dateVente','>=', $date1],
               ['tvente_entete_vente.dateVente','<=', $date2],
               ['tvente_produit.estvendable','=', $statut],
               ['tvente_stock_service.refService','=', $idService]
           ])->get(); 
           
           foreach ($data5 as $row5) 
           {                                
              $totalVente=$row5->totalSortie;                           
           }


           $CategorieClient=''; 

           $data3=DB::table('tvente_services')
           ->select('id','nom_service','status','active')
           ->where([
              ['tvente_services.id','=', $idService]
          ])      
          ->get();      
          $output='';
          foreach ($data3 as $row) 
          {
              $CategorieClient=$row->nom_service;              
          }
  
   
            $output=' 

            <!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Transitional//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd">
            <!-- saved from url=(0016)http://localhost -->
            <html>
            <head>
                <title>FicheStock</title>
                <meta HTTP-EQUIV="Content-Type" CONTENT="text/html; charset=utf-8"/>
                <style type="text/css">
                    .cs1B222893 {color:#000000;background-color:#D6E5F4;border-left:#004000 1px solid;border-top:#004000 1px solid;border-right:#004000 1px solid;border-bottom:#004000 1px solid;font-family:Times New Roman; font-size:27px; font-weight:bold; font-style:normal; padding-left:2px;padding-right:2px;}
                    .cs6F7E55AC {color:#000000;background-color:#D6E5F4;border-left-style: none;border-top:#004000 1px solid;border-right:#004000 1px solid;border-bottom:#004000 1px solid;font-family:Times New Roman; font-size:13px; font-weight:bold; font-style:normal; }
                    .csE0D816CD {color:#000000;background-color:#D6E5F4;border-left-style: none;border-top-style: none;border-right-style: none;border-bottom-style: none;font-family:Times New Roman; font-size:15px; font-weight:bold; font-style:normal; padding-left:2px;padding-right:2px;}
                    .cs8F59FFB2 {color:#000000;background-color:#F5F5F5;border-left:#004000 1px solid;border-top:#004000 1px solid;border-right:#004000 1px solid;border-bottom:#004000 1px solid;font-family:Times New Roman; font-size:13px; font-weight:bold; font-style:normal; }
                    .csF3AA49E4 {color:#000000;background-color:#F5F5F5;border-left-style: none;border-top:#004000 1px solid;border-right:#004000 1px solid;border-bottom:#004000 1px solid;font-family:Times New Roman; font-size:13px; font-weight:bold; font-style:normal; }
                    .csE78F4A6 {color:#000000;background-color:#F5F5F5;border-left-style: none;border-top:#004000 1px solid;border-right:#004000 1px solid;border-bottom:#004000 1px solid;font-family:Times New Roman; font-size:13px; font-weight:normal; font-style:normal; }
                    .cs4B928201 {color:#000000;background-color:#FFFFFF;border-left-style: none;border-top:#004000 1px solid;border-right:#004000 1px solid;border-bottom:#004000 1px solid;font-family:Times New Roman; font-size:13px; font-weight:bold; font-style:normal; }
                    .cs2C96DE68 {color:#000000;background-color:transparent;border-left:#000000 1px solid;border-top:#000000 1px solid;border-right:#000000 1px solid;border-bottom:#000000 1px solid;font-family:Times New Roman; font-size:13px; font-weight:normal; font-style:italic; padding-left:2px;}
                    .csE71035DC {color:#000000;background-color:transparent;border-left:#000000 1px solid;border-top:#000000 1px solid;border-right:#000000 1px solid;border-bottom:#000000 1px solid;font-family:Times New Roman; font-size:13px; font-weight:normal; font-style:normal; }
                    .csAB3AA82A {color:#000000;background-color:transparent;border-left-style: none;border-top:#000000 1px solid;border-right:#000000 1px solid;border-bottom:#000000 1px solid;font-family:Times New Roman; font-size:13px; font-weight:bold; font-style:normal; }
                    .csC73F4F41 {color:#000000;background-color:transparent;border-left-style: none;border-top:#004000 1px solid;border-right:#004000 1px solid;border-bottom:#004000 1px solid;font-family:Times New Roman; font-size:13px; font-weight:bold; font-style:normal; }
                    .csD149F8AB {color:#000000;background-color:transparent;border-left-style: none;border-top:#004000 1px solid;border-right:#004000 1px solid;border-bottom:#004000 1px solid;font-family:Times New Roman; font-size:13px; font-weight:normal; font-style:normal; }
                    .cs612ED82F {color:#000000;background-color:transparent;border-left-style: none;border-top-style: none;border-right-style: none;border-bottom-style: none;font-family:Times New Roman; font-size:12px; font-weight:bold; font-style:normal; padding-left:2px;}
                    .csFFC1C457 {color:#000000;background-color:transparent;border-left-style: none;border-top-style: none;border-right-style: none;border-bottom-style: none;font-family:Times New Roman; font-size:12px; font-weight:normal; font-style:normal; padding-left:2px;}
                    .cs101A94F7 {color:#000000;background-color:transparent;border-left-style: none;border-top-style: none;border-right-style: none;border-bottom-style: none;font-family:Times New Roman; font-size:13px; font-weight:normal; font-style:normal; }
                    .csCE72709D {color:#000000;background-color:transparent;border-left-style: none;border-top-style: none;border-right-style: none;border-bottom-style: none;font-family:Times New Roman; font-size:14px; font-weight:bold; font-style:normal; padding-left:2px;}
                    .csFBB219FE {color:#000000;background-color:transparent;border-left-style: none;border-top-style: none;border-right-style: none;border-bottom-style: none;font-family:Times New Roman; font-size:18px; font-weight:bold; font-style:normal; padding-left:2px;}
                    .cs739196BC {color:#5C5C5C;background-color:transparent;border-left-style: none;border-top-style: none;border-right-style: none;border-bottom-style: none;font-family:Segoe UI; font-size:11px; font-weight:normal; font-style:normal; }
                    .csF7D3565D {height:0px;width:0px;overflow:hidden;font-size:0px;line-height:0px;}
                </style>
            </head>
            <body leftMargin=10 topMargin=10 rightMargin=10 bottomMargin=10 style="background-color:#FFFFFF">
            <table cellpadding="0" cellspacing="0" border="0" style="border-width:0px;empty-cells:show;width:958px;height:352px;position:relative;">
                <tr>
                    <td style="width:0px;height:0px;"></td>
                    <td style="height:0px;width:6px;"></td>
                    <td style="height:0px;width:4px;"></td>
                    <td style="height:0px;width:163px;"></td>
                    <td style="height:0px;width:47px;"></td>
                    <td style="height:0px;width:59px;"></td>
                    <td style="height:0px;width:108px;"></td>
                    <td style="height:0px;width:22px;"></td>
                    <td style="height:0px;width:88px;"></td>
                    <td style="height:0px;width:77px;"></td>
                    <td style="height:0px;width:89px;"></td>
                    <td style="height:0px;width:21px;"></td>
                    <td style="height:0px;width:18px;"></td>
                    <td style="height:0px;width:86px;"></td>
                    <td style="height:0px;width:36px;"></td>
                    <td style="height:0px;width:132px;"></td>
                    <td style="height:0px;width:2px;"></td>
                </tr>
                <tr style="vertical-align:top;">
                    <td style="width:0px;height:23px;"></td>
                    <td></td>
                    <td></td>
                    <td></td>
                    <td></td>
                    <td></td>
                    <td></td>
                    <td></td>
                    <td></td>
                    <td></td>
                    <td></td>
                </tr>
                <tr style="vertical-align:top;">
                    <td style="width:0px;height:3px;"></td>
                    <td></td>
                    <td></td>
                    <td></td>
                    <td></td>
                    <td></td>
                    <td></td>
                    <td></td>
                    <td></td>
                    <td></td>
                    <td></td>
                    <td></td>
                    <td></td>
                    <td></td>
                    <td></td>
                    <td></td>
                    <td></td>
                </tr>
                <tr style="vertical-align:top;">
                    <td style="width:0px;height:10px;"></td>
                    <td></td>
                    <td></td>
                    <td class="csFBB219FE" colspan="10" rowspan="2" style="width:690px;height:23px;line-height:21px;text-align:left;vertical-align:middle;">'.$nomEse.'</td>
                    <td></td>
                    <td></td>
                    <td></td>
                    <td></td>
                </tr>
                <tr style="vertical-align:top;">
                    <td style="width:0px;height:13px;"></td>
                    <td></td>
                    <td></td>
                    <td></td>
                    <td class="cs101A94F7" colspan="2" rowspan="7" style="width:168px;height:144px;text-align:left;vertical-align:top;"><div style="overflow:hidden;width:168px;height:144px;">
                        <img alt="" src="'.$pic2.'" style="width:168px;height:144px;" /></div>
                    </td>
                    <td></td>
                </tr>
                <tr style="vertical-align:top;">
                    <td style="width:0px;height:22px;"></td>
                    <td></td>
                    <td></td>
                    <td class="csCE72709D" colspan="10" style="width:690px;height:22px;line-height:15px;text-align:left;vertical-align:middle;">'.$busnessName.'</td>
                    <td></td>
                    <td></td>
                </tr>
                <tr style="vertical-align:top;">
                    <td style="width:0px;height:22px;"></td>
                    <td></td>
                    <td></td>
                    <td class="csCE72709D" colspan="10" style="width:690px;height:22px;line-height:15px;text-align:left;vertical-align:middle;"><nobr>RCCM'.$rccEse.'.&nbsp;ID-NAT.'.$numImpotEse.'</nobr></td>
                    <td></td>
                    <td></td>
                </tr>
                <tr style="vertical-align:top;">
                    <td style="width:0px;height:22px;"></td>
                    <td></td>
                    <td></td>
                    <td class="csFFC1C457" colspan="10" style="width:690px;height:22px;line-height:13px;text-align:left;vertical-align:middle;">'.$adresseEse.'</td>
                    <td></td>
                    <td></td>
                </tr>
                <tr style="vertical-align:top;">
                    <td style="width:0px;height:22px;"></td>
                    <td></td>
                    <td></td>
                    <td class="csFFC1C457" colspan="10" style="width:690px;height:22px;line-height:13px;text-align:left;vertical-align:middle;"><nobr>Email&nbsp;:&nbsp;'.$emailEse.'</nobr></td>
                    <td></td>
                    <td></td>
                </tr>
                <tr style="vertical-align:top;">
                    <td style="width:0px;height:22px;"></td>
                    <td></td>
                    <td></td>
                    <td class="csFFC1C457" colspan="10" style="width:690px;height:22px;line-height:13px;text-align:left;vertical-align:middle;"><nobr>Site&nbsp;web&nbsp;:&nbsp;'.$siteEse.'</nobr></td>
                    <td></td>
                    <td></td>
                </tr>
                <tr style="vertical-align:top;">
                    <td style="width:0px;height:21px;"></td>
                    <td></td>
                    <td></td>
                    <td class="cs612ED82F" colspan="10" rowspan="2" style="width:690px;height:22px;line-height:13px;text-align:left;vertical-align:middle;"><nobr>T&#233;l&#233;phone&nbsp;:&nbsp;'.$Tel1Ese.'&nbsp;&nbsp;24h/24</nobr></td>
                    <td></td>
                    <td></td>
                </tr>
                <tr style="vertical-align:top;">
                    <td style="width:0px;height:1px;"></td>
                    <td></td>
                    <td></td>
                    <td></td>
                    <td></td>
                    <td></td>
                    <td></td>
                </tr>
                <tr style="vertical-align:top;">
                    <td style="width:0px;height:14px;"></td>
                    <td></td>
                    <td></td>
                    <td></td>
                    <td></td>
                    <td></td>
                    <td></td>
                    <td></td>
                    <td></td>
                    <td></td>
                    <td></td>
                    <td></td>
                    <td></td>
                    <td></td>
                    <td></td>
                    <td></td>
                    <td></td>
                </tr>
                <tr style="vertical-align:top;">
                    <td style="width:0px;height:34px;"></td>
                    <td></td>
                    <td></td>
                    <td></td>
                    <td></td>
                    <td class="cs1B222893" colspan="6" style="width:437px;height:32px;line-height:31px;text-align:center;vertical-align:middle;"><nobr>FICHE&nbsp;DE&nbsp;STOCK : '.$CategorieClient.'</nobr></td>
                    <td></td>
                    <td></td>
                    <td></td>
                    <td></td>
                    <td></td>
                    <td></td>
                </tr>
                <tr style="vertical-align:top;">
                    <td style="width:0px;height:7px;"></td>
                    <td></td>
                    <td></td>
                    <td></td>
                    <td></td>
                    <td></td>
                    <td></td>
                    <td></td>
                    <td></td>
                    <td></td>
                    <td></td>
                    <td></td>
                    <td></td>
                    <td></td>
                    <td></td>
                    <td></td>
                    <td></td>
                </tr>
                <tr style="vertical-align:top;">
                    <td style="width:0px;height:24px;"></td>
                    <td></td>
                    <td class="csE71035DC" colspan="10" style="width:676px;height:22px;line-height:15px;text-align:center;vertical-align:middle;"><nobr>TOTAL&nbsp;VENTE(USD)</nobr></td>
                    <td class="csAB3AA82A" colspan="5" style="width:273px;height:22px;line-height:15px;text-align:center;vertical-align:middle;"><nobr>'.$totalVente.'$</nobr></td>
                </tr>
                <tr style="vertical-align:top;">
                    <td style="width:0px;height:24px;"></td>
                    <td></td>
                    <td class="cs8F59FFB2" colspan="2" style="width:165px;height:22px;line-height:15px;text-align:center;vertical-align:middle;"><nobr>PRODUIT</nobr></td>
                    <td class="cs6F7E55AC" colspan="2" style="width:105px;height:22px;line-height:15px;text-align:center;vertical-align:middle;"><nobr>SI</nobr></td>
                    <td class="csF3AA49E4" style="width:107px;height:22px;line-height:15px;text-align:center;vertical-align:middle;"><nobr>ENTREE</nobr></td>
                    <td class="csC73F4F41" colspan="2" style="width:109px;height:22px;line-height:15px;text-align:center;vertical-align:middle;"><nobr>TOTAL</nobr></td>
                    <td class="cs4B928201" colspan="2" style="width:109px;height:22px;line-height:15px;text-align:center;vertical-align:middle;"><nobr>SORTIE</nobr></td>
                    <td class="csF3AA49E4" style="width:76px;height:22px;line-height:15px;text-align:center;vertical-align:middle;"><nobr>SF</nobr></td>                    
                    <td class="cs4B928201" colspan="3" style="width:139px;height:22px;line-height:15px;text-align:center;vertical-align:middle;"><nobr>PU(USD)</nobr></td>
                    <td class="cs6F7E55AC" colspan="2" style="width:133px;height:22px;line-height:15px;text-align:center;vertical-align:middle;"><nobr>PT(USD)</nobr></td>
                </tr>
                <tr style="vertical-align:top;">
                    <td style="width:0px;height:22px;"></td>
                    <td></td>
                    <td class="cs2C96DE68" colspan="15" style="width:948px;height:20px;line-height:15px;text-align:left;vertical-align:top;"><nobr>'.$date1.'</nobr></td>
                </tr>
                ';
                                                                
                   $output .= $this->showCategorieFicheStockServiceVendable($date1,$date2,$idService,$statut); 
                                                                
                 $output.='
            </table>
            </body>
            </html>

            '; 

    return $output;

} 
function showCategorieFicheStockServiceVendable($date1,$date2,$idService,$statut)
{
    $data = DB::table("tvente_categorie_produit")
    ->select("tvente_categorie_produit.id", "tvente_categorie_produit.designation", 
    "tvente_categorie_produit.created_at", "tvente_categorie_produit.author")    
    ->orderBy("tvente_categorie_produit.designation", "asc")
    ->get();
    
    $output='';

    foreach ($data as $row) 
    {
        $output .='
                <tr style="vertical-align:top;">
                <td style="width:0px;height:22px;"></td>
                <td></td>
                <td class="csE0D816CD" colspan="15" style="width:948px;height:22px;line-height:17px;text-align:center;vertical-align:middle;">'.$row->designation.'</td>
            </tr>
            ';
                                                    
                $output .= $this->showDetailFicheStockServiceByVendable($date1, $date2, $row->id, $idService,$statut);                                                     
                $output.='
        ';      
    }

    return $output;

}
function showDetailFicheStockServiceByVendable($date1, $date2, $refCategorie, $idService,$statut)
{
    // Récupérer les données de stock, mouvements et ventes en une seule requête 
    $data11 = DB::table('tvente_stock_service')
    ->join('tvente_services', 'tvente_services.id', '=', 'tvente_stock_service.refService')
    ->Join('tvente_produit', 'tvente_produit.id', '=', 'tvente_stock_service.refProduit')
    ->Join('tvente_categorie_produit', 'tvente_categorie_produit.id', '=', 'tvente_produit.refCategorie')

    ->leftJoin('tvente_mouvement_stock as dtEntree', function ($join) use ($date1, $idService) {
        $join->on('dtEntree.idStockService', '=', 'tvente_stock_service.id')        
             ->where('dtEntree.type_mouvement', '=', 'Entree')
             ->where('dtEntree.dateMvt', '<', $date1);
    })

        // Utilisez distinct() avant select()
        ->distinct()
        ->select(
            "tvente_stock_service.id",
            'tvente_stock_service.refService',
            'tvente_stock_service.refProduit',
            "tvente_produit.designation as designation",
            "refCategorie",
            "tvente_stock_service.pu",
            "tvente_categorie_produit.designation as Categorie",
            "tvente_stock_service.qte",
            "tvente_stock_service.uniteBase",
            "tvente_stock_service.cmup","tvente_stock_service.devise","tvente_stock_service.taux",            
            DB::raw('IFNULL(ROUND(SUM(dtEntree.qteBase * dtEntree.qteMvt), 3), 0) as totalEntree'),

        )
        ->where([
            ['tvente_produit.refCategorie', '=', $refCategorie],
            ['tvente_stock_service.refService', '=', $idService],
            ['tvente_produit.estvendable','=', $statut],
        ])
        ->groupBy("tvente_stock_service.id", "tvente_stock_service.refService", "tvente_stock_service.refProduit", 
        "designation", "refCategorie", "pu", "Categorie", "qte", "uniteBase","cmup",
        "tvente_stock_service.devise","tvente_stock_service.taux")
        ->orderBy("tvente_produit.designation", "asc")
        ->get();


    $data22 = DB::table('tvente_stock_service')
    ->join('tvente_services', 'tvente_services.id', '=', 'tvente_stock_service.refService')
    ->Join('tvente_produit', 'tvente_produit.id', '=', 'tvente_stock_service.refProduit')
    ->Join('tvente_categorie_produit', 'tvente_categorie_produit.id', '=', 'tvente_produit.refCategorie')

    ->leftJoin('tvente_mouvement_stock as dtSortie', function ($join) use ($date1, $idService) {
        $join->on('dtSortie.idStockService', '=', 'tvente_stock_service.id')        
             ->where('dtSortie.type_mouvement', '=', 'Sortie')
             ->where('dtSortie.dateMvt', '<', $date1);
    })
    // Utilisez distinct() avant select()
    ->distinct()
    ->select(
        "tvente_stock_service.id",
        'tvente_stock_service.refService',
        'tvente_stock_service.refProduit',
        "tvente_produit.designation as designation",
        "refCategorie",
        "tvente_stock_service.pu",
        "tvente_categorie_produit.designation as Categorie",
        "tvente_stock_service.qte",
        "tvente_stock_service.uniteBase",
        "tvente_stock_service.cmup",
        DB::raw('IFNULL(ROUND(SUM(dtSortie.qteBase * dtSortie.qteMvt), 3), 0) as totalSortie')
    )
    ->where([
        ['tvente_produit.refCategorie', '=', $refCategorie],
        ['tvente_stock_service.refService', '=', $idService],
        ['tvente_produit.estvendable','=', $statut],
    ])
    ->groupBy("tvente_stock_service.id", "tvente_stock_service.refService", "tvente_stock_service.refProduit", "designation", "refCategorie", "pu", "Categorie", "qte", "uniteBase","cmup")
    ->orderBy("tvente_produit.designation", "asc")
    ->get();

    // ============ LEs Mouvements =========================================================================

        // Récupérer les données de stock, mouvements et ventes en une seule requête 
        $data1 = DB::table('tvente_stock_service')
        ->join('tvente_services', 'tvente_services.id', '=', 'tvente_stock_service.refService')
        ->Join('tvente_produit', 'tvente_produit.id', '=', 'tvente_stock_service.refProduit')
        ->Join('tvente_categorie_produit', 'tvente_categorie_produit.id', '=', 'tvente_produit.refCategorie')
    
        ->leftJoin('tvente_mouvement_stock as mvtEntree', function ($join) use ($date1, $date2, $idService) {
            $join->on('mvtEntree.idStockService', '=', 'tvente_stock_service.id')        
                 ->where('mvtEntree.type_mouvement', '=', 'Entree')
                 ->whereBetween('mvtEntree.dateMvt', [$date1, $date2]);;
        })
    
            // Utilisez distinct() avant select()
            ->distinct()
            ->select(
                "tvente_stock_service.id",
                'tvente_stock_service.refService',
                'tvente_stock_service.refProduit',
                "tvente_produit.designation as designation",
                "refCategorie",
                "tvente_stock_service.pu",
                "tvente_categorie_produit.designation as Categorie",
                "tvente_stock_service.qte",
                "tvente_stock_service.uniteBase",
                "tvente_stock_service.cmup","tvente_stock_service.devise","tvente_stock_service.taux",            
                DB::raw('IFNULL(ROUND(SUM(mvtEntree.qteBase * mvtEntree.qteMvt), 3), 0) as stockEntree'),
    
            )
            ->where([
                ['tvente_produit.refCategorie', '=', $refCategorie],
                ['tvente_stock_service.refService', '=', $idService],
                ['tvente_produit.estvendable','=', $statut],
            ])
            ->groupBy("tvente_stock_service.id", "tvente_stock_service.refService", "tvente_stock_service.refProduit", 
            "designation", "refCategorie", "pu", "Categorie", "qte", "uniteBase","cmup",
            "tvente_stock_service.devise","tvente_stock_service.taux")
            ->orderBy("tvente_produit.designation", "asc")
            ->get();
    
    //======================================================================
    
        // Récupérer les données de stock, mouvements et ventes en une seule requête 
        $data2 = DB::table('tvente_stock_service')
        ->join('tvente_services', 'tvente_services.id', '=', 'tvente_stock_service.refService')
        ->Join('tvente_produit', 'tvente_produit.id', '=', 'tvente_stock_service.refProduit')
        ->Join('tvente_categorie_produit', 'tvente_categorie_produit.id', '=', 'tvente_produit.refCategorie')
    
        ->leftJoin('tvente_mouvement_stock as mvtSortie', function ($join) use ($date1, $date2, $idService) {
            $join->on('mvtSortie.idStockService', '=', 'tvente_stock_service.id')        
                 ->where('mvtSortie.type_mouvement', '=', 'Sortie')
                 ->whereBetween('mvtSortie.dateMvt', [$date1, $date2]);;
        })
    
            // Utilisez distinct() avant select()
            ->distinct()
            ->select(
                "tvente_stock_service.id",
                'tvente_stock_service.refService',
                'tvente_stock_service.refProduit',
                "tvente_produit.designation as designation",
                "refCategorie",
                "tvente_stock_service.pu",
                "tvente_categorie_produit.designation as Categorie",
                "tvente_stock_service.qte",
                "tvente_stock_service.uniteBase",
                "tvente_stock_service.cmup","tvente_stock_service.devise","tvente_stock_service.taux",            
                DB::raw('IFNULL(ROUND(SUM(mvtSortie.qteBase * mvtSortie.qteMvt), 3), 0) as stockSortie'),
    
            )
            ->where([
                ['tvente_produit.refCategorie', '=', $refCategorie],
                ['tvente_stock_service.refService', '=', $idService],
                ['tvente_produit.estvendable','=', $statut],
            ])
            ->groupBy("tvente_stock_service.id", "tvente_stock_service.refService", "tvente_stock_service.refProduit", 
            "designation", "refCategorie", "pu", "Categorie", "qte", "uniteBase","cmup",
            "tvente_stock_service.devise","tvente_stock_service.taux")
            ->orderBy("tvente_produit.designation", "asc")
            ->get();
    

    // Construction de l'output
    
    $output = '';

    // Vérifiez que les deux tableaux ont la même longueur
    if ((count($data1) === count($data2)) && (count($data1) === count($data11)) 
    && (count($data1) === count($data22)))
    {
        for ($i = 0; $i < count($data1); $i++) {
            $row11 = $data11[$i];
            $row22 = $data22[$i];
            $row1 = $data1[$i];
            $row2 = $data2[$i];            

            $totalSortie = floatval($row22->totalSortie);
            $totalEntree = floatval($row11->totalEntree);

            $stockSortie = floatval($row2->stockSortie);            
            $stockEntree = floatval($row1->stockEntree);

            $totalSI = ((floatval($totalEntree)) - (floatval($totalSortie)));
            $totalGEntree = floatval($stockEntree);
            $totalG = floatval($totalSI) + floatval($stockEntree);
            $TGSortie = floatval($stockSortie);
            $totalSF = floatval($totalG) - floatval($stockSortie);
            $totalPT = floatval($totalSF) * floatval($row2->cmup);

            $output .= '
            <tr style="vertical-align:top;">
                <td style="width:0px;height:24px;"></td>
                <td></td>
                <td class="cs8F59FFB2" colspan="2" style="width:165px;height:22px;line-height:15px;text-align:center;vertical-align:middle;">'.$row1->designation.'</td>
                <td class="cs6F7E55AC" colspan="2" style="width:105px;height:22px;line-height:15px;text-align:center;vertical-align:middle;">'.$totalSI.' '.$row1->uniteBase.'</td>
                <td class="csE78F4A6" style="width:107px;height:22px;line-height:15px;text-align:center;vertical-align:middle;">'.$totalGEntree.' '.$row1->uniteBase.' </td>
                <td class="csD149F8AB" colspan="2" style="width:109px;height:22px;line-height:15px;text-align:center;vertical-align:middle;">'.$totalG.' '.$row1->uniteBase.'</td>
                <td class="cs4B928201" colspan="2" style="width:109px;height:22px;line-height:15px;text-align:center;vertical-align:middle;">'.$TGSortie.' '.$row1->uniteBase.'</td>
                <td class="csE78F4A6" style="width:76px;height:22px;line-height:15px;text-align:center;vertical-align:middle;">'.$totalSF.' '.$row1->uniteBase.'</td>                
                <td class="cs4B928201" colspan="3" style="width:139px;height:22px;line-height:15px;text-align:center;vertical-align:middle;">'.round($row2->cmup, 2).'$</td>
                <td class="cs6F7E55AC" colspan="2" style="width:133px;height:22px;line-height:15px;text-align:center;vertical-align:middle;">'.round($totalPT, 2).'$</td>
            </tr>
        '; 

    }
    } else {
        // Gérer le cas où les tableaux n'ont pas la même longueur
        echo 'Les tableaux ont pas la même longueur.';
    }

    return $output;
}




//==============  VENDABLE===========================================================================

function pdf_fiche_stock_vente_service_by_vendable_cmup(Request $request)
{

    if ($request->get('date1') && $request->get('date2') && $request->get('idService')&& $request->get('statut')) {
        // code...
        $date1 = $request->get('date1');
        $date2 = $request->get('date2');
        $idService = $request->get('idService');
        $statut = $request->get('statut');
        
        $html ='<html><head><meta http-equiv="Content-Type" content="text/html; charset=utf-8"/>';
        $html .= $this->getInfoFicheStockServicesByVendableCMUP($date1,$date2,$idService,$statut);       
        $html .='<script>window.print()</script>';

        echo($html); 
        
    }
    else{
    }    
}
function getInfoFicheStockServicesByVendableCMUP($date1,$date2,$idService,$statut)
{
           //Info Entreprise
           $nomEse='';
           $adresseEse='';
           $Tel1Ese='';
           $Tel2Ese='';
           $siteEse='';
           $emailEse='';
           $idNatEse='';
           $numImpotEse='';
           $rccEse='';
           $siege='';
           $busnessName='';
           $pic='';
           $pic2 = $this->displayImg("fichier", 'logo.png');
           $logo='';
   
           $data1 = DB::table('entreprises')
           ->join('secteurs','secteurs.id','=','entreprises.idsecteur')
           ->join('forme_juridiques','forme_juridiques.id','=','entreprises.idforme')
   
           ->join('pays','pays.id','=','entreprises.idPays')
           ->join('provinces','provinces.id','=','entreprises.idProvince')
           ->join('users','users.id','=','entreprises.ceo')        
           ->select('entreprises.id as id','entreprises.id as idEntreprise',
           'entreprises.ceo','entreprises.nomEntreprise','entreprises.descriptionEntreprise',
           'entreprises.emailEntreprise','entreprises.adresseEntreprise',
           'entreprises.telephoneEntreprise','entreprises.solutionEntreprise','entreprises.idsecteur',
           'entreprises.idforme','entreprises.etat',
           'entreprises.idPays','entreprises.idProvince','entreprises.edition','entreprises.facebook',
           'entreprises.linkedin','entreprises.twitter','entreprises.siteweb','entreprises.rccm',
           'entreprises.invPersonnel','entreprises.invHub','entreprises.invRecherche',
           'entreprises.chiffreAffaire','entreprises.nbremploye','entreprises.slug','entreprises.logo',
            //forme
            'forme_juridiques.nomForme','secteurs.nomSecteur',
            //users
            'users.name','users.email','users.avatar','users.telephone','users.adresse',
            //
            'provinces.nomProvince','pays.nomPays', 'entreprises.created_at')
           ->get();
           $output='';
           foreach ($data1 as $row1) 
           {                                
               $nomEse=$row1->nomEntreprise;
               $adresseEse=$row1->adresseEntreprise;
               $Tel1Ese=$row1->telephoneEntreprise;
               $Tel2Ese=$row1->telephone;
               $siteEse=$row1->siteweb;
               $emailEse=$row1->emailEntreprise;
               $idNatEse=$row1->rccm;
               $numImpotEse=$row1->rccm;
               $busnessName=$row1->nomSecteur;
               $rccmEse=$row1->rccm;
               $pic = $this->displayImg("fichier", 'logo.png');
               $siege=$row1->nomForme;         
           }


           $totalVente = 0;
           $totalTransfert=0;
           $totalCMUP = 0;
           $globalTP=0;

           $data5 = DB::table('tvente_detail_vente')
           ->join('tvente_stock_service','tvente_stock_service.id','=','tvente_detail_vente.idStockService')
           ->join('tvente_produit','tvente_produit.id','=','tvente_stock_service.refProduit')
           ->join('tvente_categorie_produit','tvente_categorie_produit.id','=','tvente_produit.refCategorie')
           ->join('tvente_entete_vente','tvente_entete_vente.id','=','tvente_detail_vente.refEnteteVente')
           ->select(DB::raw('IFNULL(ROUND(SUM(qteVente*puVente),0),0) as totalSortie'))
           ->where([               
               ['tvente_entete_vente.dateVente','>=', $date1],
               ['tvente_entete_vente.dateVente','<=', $date2],
               ['tvente_produit.estvendable','=', $statut],
               ['tvente_stock_service.refService','=', $idService]
           ])->get(); 
           
           foreach ($data5 as $row5) 
           {                                
              $totalVente=$row5->totalSortie;                           
           }


           $CategorieClient=''; 

           $data3=DB::table('tvente_services')
           ->select('id','nom_service','status','active')
           ->where([
              ['tvente_services.id','=', $idService]
          ])      
          ->get();      
          $output='';
          foreach ($data3 as $row) 
          {
              $CategorieClient=$row->nom_service;              
          }
  
   
            $output=' 

            <!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Transitional//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd">
            <!-- saved from url=(0016)http://localhost -->
            <html>
            <head>
                <title>FicheStock</title>
                <meta HTTP-EQUIV="Content-Type" CONTENT="text/html; charset=utf-8"/>
                <style type="text/css">
                    .cs1B222893 {color:#000000;background-color:#D6E5F4;border-left:#004000 1px solid;border-top:#004000 1px solid;border-right:#004000 1px solid;border-bottom:#004000 1px solid;font-family:Times New Roman; font-size:27px; font-weight:bold; font-style:normal; padding-left:2px;padding-right:2px;}
                    .cs6F7E55AC {color:#000000;background-color:#D6E5F4;border-left-style: none;border-top:#004000 1px solid;border-right:#004000 1px solid;border-bottom:#004000 1px solid;font-family:Times New Roman; font-size:13px; font-weight:bold; font-style:normal; }
                    .csE0D816CD {color:#000000;background-color:#D6E5F4;border-left-style: none;border-top-style: none;border-right-style: none;border-bottom-style: none;font-family:Times New Roman; font-size:15px; font-weight:bold; font-style:normal; padding-left:2px;padding-right:2px;}
                    .cs8F59FFB2 {color:#000000;background-color:#F5F5F5;border-left:#004000 1px solid;border-top:#004000 1px solid;border-right:#004000 1px solid;border-bottom:#004000 1px solid;font-family:Times New Roman; font-size:13px; font-weight:bold; font-style:normal; }
                    .csF3AA49E4 {color:#000000;background-color:#F5F5F5;border-left-style: none;border-top:#004000 1px solid;border-right:#004000 1px solid;border-bottom:#004000 1px solid;font-family:Times New Roman; font-size:13px; font-weight:bold; font-style:normal; }
                    .csE78F4A6 {color:#000000;background-color:#F5F5F5;border-left-style: none;border-top:#004000 1px solid;border-right:#004000 1px solid;border-bottom:#004000 1px solid;font-family:Times New Roman; font-size:13px; font-weight:normal; font-style:normal; }
                    .cs4B928201 {color:#000000;background-color:#FFFFFF;border-left-style: none;border-top:#004000 1px solid;border-right:#004000 1px solid;border-bottom:#004000 1px solid;font-family:Times New Roman; font-size:13px; font-weight:bold; font-style:normal; }
                    .cs2C96DE68 {color:#000000;background-color:transparent;border-left:#000000 1px solid;border-top:#000000 1px solid;border-right:#000000 1px solid;border-bottom:#000000 1px solid;font-family:Times New Roman; font-size:13px; font-weight:normal; font-style:italic; padding-left:2px;}
                    .csE71035DC {color:#000000;background-color:transparent;border-left:#000000 1px solid;border-top:#000000 1px solid;border-right:#000000 1px solid;border-bottom:#000000 1px solid;font-family:Times New Roman; font-size:13px; font-weight:normal; font-style:normal; }
                    .csAB3AA82A {color:#000000;background-color:transparent;border-left-style: none;border-top:#000000 1px solid;border-right:#000000 1px solid;border-bottom:#000000 1px solid;font-family:Times New Roman; font-size:13px; font-weight:bold; font-style:normal; }
                    .csC73F4F41 {color:#000000;background-color:transparent;border-left-style: none;border-top:#004000 1px solid;border-right:#004000 1px solid;border-bottom:#004000 1px solid;font-family:Times New Roman; font-size:13px; font-weight:bold; font-style:normal; }
                    .csD149F8AB {color:#000000;background-color:transparent;border-left-style: none;border-top:#004000 1px solid;border-right:#004000 1px solid;border-bottom:#004000 1px solid;font-family:Times New Roman; font-size:13px; font-weight:normal; font-style:normal; }
                    .cs612ED82F {color:#000000;background-color:transparent;border-left-style: none;border-top-style: none;border-right-style: none;border-bottom-style: none;font-family:Times New Roman; font-size:12px; font-weight:bold; font-style:normal; padding-left:2px;}
                    .csFFC1C457 {color:#000000;background-color:transparent;border-left-style: none;border-top-style: none;border-right-style: none;border-bottom-style: none;font-family:Times New Roman; font-size:12px; font-weight:normal; font-style:normal; padding-left:2px;}
                    .cs101A94F7 {color:#000000;background-color:transparent;border-left-style: none;border-top-style: none;border-right-style: none;border-bottom-style: none;font-family:Times New Roman; font-size:13px; font-weight:normal; font-style:normal; }
                    .csCE72709D {color:#000000;background-color:transparent;border-left-style: none;border-top-style: none;border-right-style: none;border-bottom-style: none;font-family:Times New Roman; font-size:14px; font-weight:bold; font-style:normal; padding-left:2px;}
                    .csFBB219FE {color:#000000;background-color:transparent;border-left-style: none;border-top-style: none;border-right-style: none;border-bottom-style: none;font-family:Times New Roman; font-size:18px; font-weight:bold; font-style:normal; padding-left:2px;}
                    .cs739196BC {color:#5C5C5C;background-color:transparent;border-left-style: none;border-top-style: none;border-right-style: none;border-bottom-style: none;font-family:Segoe UI; font-size:11px; font-weight:normal; font-style:normal; }
                    .csF7D3565D {height:0px;width:0px;overflow:hidden;font-size:0px;line-height:0px;}
                </style>
            </head>
            <body leftMargin=10 topMargin=10 rightMargin=10 bottomMargin=10 style="background-color:#FFFFFF">
            <table cellpadding="0" cellspacing="0" border="0" style="border-width:0px;empty-cells:show;width:958px;height:352px;position:relative;">
                <tr>
                    <td style="width:0px;height:0px;"></td>
                    <td style="height:0px;width:6px;"></td>
                    <td style="height:0px;width:4px;"></td>
                    <td style="height:0px;width:163px;"></td>
                    <td style="height:0px;width:47px;"></td>
                    <td style="height:0px;width:59px;"></td>
                    <td style="height:0px;width:108px;"></td>
                    <td style="height:0px;width:22px;"></td>
                    <td style="height:0px;width:88px;"></td>
                    <td style="height:0px;width:77px;"></td>
                    <td style="height:0px;width:89px;"></td>
                    <td style="height:0px;width:21px;"></td>
                    <td style="height:0px;width:18px;"></td>
                    <td style="height:0px;width:86px;"></td>
                    <td style="height:0px;width:36px;"></td>
                    <td style="height:0px;width:132px;"></td>
                    <td style="height:0px;width:2px;"></td>
                </tr>
                <tr style="vertical-align:top;">
                    <td style="width:0px;height:23px;"></td>
                    <td></td>
                    <td></td>
                    <td></td>
                    <td></td>
                    <td></td>
                    <td></td>
                    <td></td>
                    <td></td>
                    <td></td>
                    <td></td>
                </tr>
                <tr style="vertical-align:top;">
                    <td style="width:0px;height:3px;"></td>
                    <td></td>
                    <td></td>
                    <td></td>
                    <td></td>
                    <td></td>
                    <td></td>
                    <td></td>
                    <td></td>
                    <td></td>
                    <td></td>
                    <td></td>
                    <td></td>
                    <td></td>
                    <td></td>
                    <td></td>
                    <td></td>
                </tr>
                <tr style="vertical-align:top;">
                    <td style="width:0px;height:10px;"></td>
                    <td></td>
                    <td></td>
                    <td class="csFBB219FE" colspan="10" rowspan="2" style="width:690px;height:23px;line-height:21px;text-align:left;vertical-align:middle;">'.$nomEse.'</td>
                    <td></td>
                    <td></td>
                    <td></td>
                    <td></td>
                </tr>
                <tr style="vertical-align:top;">
                    <td style="width:0px;height:13px;"></td>
                    <td></td>
                    <td></td>
                    <td></td>
                    <td class="cs101A94F7" colspan="2" rowspan="7" style="width:168px;height:144px;text-align:left;vertical-align:top;"><div style="overflow:hidden;width:168px;height:144px;">
                        <img alt="" src="'.$pic2.'" style="width:168px;height:144px;" /></div>
                    </td>
                    <td></td>
                </tr>
                <tr style="vertical-align:top;">
                    <td style="width:0px;height:22px;"></td>
                    <td></td>
                    <td></td>
                    <td class="csCE72709D" colspan="10" style="width:690px;height:22px;line-height:15px;text-align:left;vertical-align:middle;">'.$busnessName.'</td>
                    <td></td>
                    <td></td>
                </tr>
                <tr style="vertical-align:top;">
                    <td style="width:0px;height:22px;"></td>
                    <td></td>
                    <td></td>
                    <td class="csCE72709D" colspan="10" style="width:690px;height:22px;line-height:15px;text-align:left;vertical-align:middle;"><nobr>RCCM'.$rccEse.'.&nbsp;ID-NAT.'.$numImpotEse.'</nobr></td>
                    <td></td>
                    <td></td>
                </tr>
                <tr style="vertical-align:top;">
                    <td style="width:0px;height:22px;"></td>
                    <td></td>
                    <td></td>
                    <td class="csFFC1C457" colspan="10" style="width:690px;height:22px;line-height:13px;text-align:left;vertical-align:middle;">'.$adresseEse.'</td>
                    <td></td>
                    <td></td>
                </tr>
                <tr style="vertical-align:top;">
                    <td style="width:0px;height:22px;"></td>
                    <td></td>
                    <td></td>
                    <td class="csFFC1C457" colspan="10" style="width:690px;height:22px;line-height:13px;text-align:left;vertical-align:middle;"><nobr>Email&nbsp;:&nbsp;'.$emailEse.'</nobr></td>
                    <td></td>
                    <td></td>
                </tr>
                <tr style="vertical-align:top;">
                    <td style="width:0px;height:22px;"></td>
                    <td></td>
                    <td></td>
                    <td class="csFFC1C457" colspan="10" style="width:690px;height:22px;line-height:13px;text-align:left;vertical-align:middle;"><nobr>Site&nbsp;web&nbsp;:&nbsp;'.$siteEse.'</nobr></td>
                    <td></td>
                    <td></td>
                </tr>
                <tr style="vertical-align:top;">
                    <td style="width:0px;height:21px;"></td>
                    <td></td>
                    <td></td>
                    <td class="cs612ED82F" colspan="10" rowspan="2" style="width:690px;height:22px;line-height:13px;text-align:left;vertical-align:middle;"><nobr>T&#233;l&#233;phone&nbsp;:&nbsp;'.$Tel1Ese.'&nbsp;&nbsp;24h/24</nobr></td>
                    <td></td>
                    <td></td>
                </tr>
                <tr style="vertical-align:top;">
                    <td style="width:0px;height:1px;"></td>
                    <td></td>
                    <td></td>
                    <td></td>
                    <td></td>
                    <td></td>
                    <td></td>
                </tr>
                <tr style="vertical-align:top;">
                    <td style="width:0px;height:14px;"></td>
                    <td></td>
                    <td></td>
                    <td></td>
                    <td></td>
                    <td></td>
                    <td></td>
                    <td></td>
                    <td></td>
                    <td></td>
                    <td></td>
                    <td></td>
                    <td></td>
                    <td></td>
                    <td></td>
                    <td></td>
                    <td></td>
                </tr>
                <tr style="vertical-align:top;">
                    <td style="width:0px;height:34px;"></td>
                    <td></td>
                    <td></td>
                    <td></td>
                    <td></td>
                    <td class="cs1B222893" colspan="6" style="width:437px;height:32px;line-height:31px;text-align:center;vertical-align:middle;"><nobr>FICHE&nbsp;DE&nbsp;STOCK : '.$CategorieClient.'</nobr></td>
                    <td></td>
                    <td></td>
                    <td></td>
                    <td></td>
                    <td></td>
                    <td></td>
                </tr>
                <tr style="vertical-align:top;">
                    <td style="width:0px;height:7px;"></td>
                    <td></td>
                    <td></td>
                    <td></td>
                    <td></td>
                    <td></td>
                    <td></td>
                    <td></td>
                    <td></td>
                    <td></td>
                    <td></td>
                    <td></td>
                    <td></td>
                    <td></td>
                    <td></td>
                    <td></td>
                    <td></td>
                </tr>
                <tr style="vertical-align:top;">
                    <td style="width:0px;height:24px;"></td>
                    <td></td>
                    <td class="csE71035DC" colspan="10" style="width:676px;height:22px;line-height:15px;text-align:center;vertical-align:middle;"><nobr>TOTAL&nbsp;VENTE(USD)</nobr></td>
                    <td class="csAB3AA82A" colspan="5" style="width:273px;height:22px;line-height:15px;text-align:center;vertical-align:middle;"><nobr>'.$totalVente.'$</nobr></td>
                </tr>
                <tr style="vertical-align:top;">
                    <td style="width:0px;height:24px;"></td>
                    <td></td>
                    <td class="cs8F59FFB2" colspan="2" style="width:165px;height:22px;line-height:15px;text-align:center;vertical-align:middle;"><nobr>PRODUIT</nobr></td>
                    <td class="cs6F7E55AC" colspan="2" style="width:105px;height:22px;line-height:15px;text-align:center;vertical-align:middle;"><nobr>SI</nobr></td>
                    <td class="csF3AA49E4" style="width:107px;height:22px;line-height:15px;text-align:center;vertical-align:middle;"><nobr>ENTREE</nobr></td>
                    <td class="csC73F4F41" colspan="2" style="width:109px;height:22px;line-height:15px;text-align:center;vertical-align:middle;"><nobr>TOTAL</nobr></td>
                    <td class="cs4B928201" colspan="2" style="width:109px;height:22px;line-height:15px;text-align:center;vertical-align:middle;"><nobr>SORTIE</nobr></td>
                    <td class="csF3AA49E4" style="width:76px;height:22px;line-height:15px;text-align:center;vertical-align:middle;"><nobr>SF</nobr></td>                    
                    <td class="cs4B928201" colspan="3" style="width:139px;height:22px;line-height:15px;text-align:center;vertical-align:middle;"><nobr>PU(USD)</nobr></td>
                    <td class="cs6F7E55AC" colspan="2" style="width:133px;height:22px;line-height:15px;text-align:center;vertical-align:middle;"><nobr>PT(USD)</nobr></td>
                </tr>
                <tr style="vertical-align:top;">
                    <td style="width:0px;height:22px;"></td>
                    <td></td>
                    <td class="cs2C96DE68" colspan="15" style="width:948px;height:20px;line-height:15px;text-align:left;vertical-align:top;"><nobr>'.$date1.'</nobr></td>
                </tr>
                ';
                                                                
                   $output .= $this->showCategorieFicheStockServiceVendableCMUP($date1,$date2,$idService,$statut); 
                                                                
                 $output.='
            </table>
            </body>
            </html>

            '; 

    return $output;

} 
function showCategorieFicheStockServiceVendableCMUP($date1,$date2,$idService,$statut)
{
    $data = DB::table("tvente_categorie_produit")
    ->select("tvente_categorie_produit.id", "tvente_categorie_produit.designation", 
    "tvente_categorie_produit.created_at", "tvente_categorie_produit.author")    
    ->orderBy("tvente_categorie_produit.designation", "asc")
    ->get();
    
    $output='';

    foreach ($data as $row) 
    {
        $output .='
                <tr style="vertical-align:top;">
                <td style="width:0px;height:22px;"></td>
                <td></td>
                <td class="csE0D816CD" colspan="15" style="width:948px;height:22px;line-height:17px;text-align:center;vertical-align:middle;">'.$row->designation.'</td>
            </tr>
            ';
                                                    
                $output .= $this->showDetailFicheStockServiceByVendableCMUP($date1, $date2, $row->id, $idService,$statut);                                                     
                $output.='
        ';      
    }

    return $output;

}

// function calculerCoutMoyen($articleIdStk, $date1, $date2) {
//     // Exécuter la requête pour obtenir le stock final et la valeur totale
//     $result = DB::table('tvente_mouvement_stock')
//         ->select(
//             DB::raw('SUM(CASE WHEN type_mouvement = "Entree" THEN qteMvt * qteBase ELSE 0 END) as stock_final'),
//             DB::raw('SUM(CASE WHEN type_mouvement = "Entree" THEN qteMvt * qteBase * (puMvt / qteBase) ELSE 0 END) as valeur_totale')
//         )
//         ->where([
//             // ['tvente_mouvement_stock.dateMvt','>=', $date1],
//             ['tvente_mouvement_stock.dateMvt','<=', $date2],
//             ['tvente_mouvement_stock.idStockService','=', $articleIdStk],
//             ['tvente_mouvement_stock.type_mouvement','=', 'Entree'],
//         ])       
//         ->first();

//     // Initialiser les variables
//     $coutMoyen = 0;
//     $stockFinal = $result->stock_final ?? 0;
//     $valeurTotale = $result->valeur_totale ?? 0;

//     // Calculer le coût moyen si le stock final est supérieur à 0
//     if ($stockFinal > 0) {
//         $coutMoyen = round(floatval($valeurTotale) / floatval($stockFinal), 3);
//         // $coutMoyen = $valeurTotale;
//     }

//     return $coutMoyen;
// }



function showDetailFicheStockServiceByVendableCMUP($date1, $date2, $refCategorie, $idService,$statut)
{
    // Récupérer les données de stock, mouvements et ventes en une seule requête 
    $data11 = DB::table('tvente_stock_service')
    ->join('tvente_services', 'tvente_services.id', '=', 'tvente_stock_service.refService')
    ->Join('tvente_produit', 'tvente_produit.id', '=', 'tvente_stock_service.refProduit')
    ->Join('tvente_categorie_produit', 'tvente_categorie_produit.id', '=', 'tvente_produit.refCategorie')

    ->leftJoin('tvente_mouvement_stock as dtEntree', function ($join) use ($date1, $idService) {
        $join->on('dtEntree.idStockService', '=', 'tvente_stock_service.id')        
             ->where('dtEntree.type_mouvement', '=', 'Entree')
             ->where('dtEntree.dateMvt', '<', $date1);
    })

        // Utilisez distinct() avant select()
        ->distinct()
        ->select(
            "tvente_stock_service.id",
            'tvente_stock_service.refService',
            'tvente_stock_service.refProduit',
            "tvente_produit.designation as designation",
            "refCategorie",
            "tvente_stock_service.pu",
            "tvente_categorie_produit.designation as Categorie",
            "tvente_stock_service.qte",
            "tvente_stock_service.uniteBase",
            "tvente_stock_service.devise","tvente_stock_service.taux",            
            DB::raw('IFNULL(ROUND(SUM(dtEntree.qteBase * dtEntree.qteMvt), 3), 0) as totalEntree')
        )
        ->where([
            ['tvente_produit.refCategorie', '=', $refCategorie],
            ['tvente_stock_service.refService', '=', $idService],
            ['tvente_produit.estvendable','=', $statut],
        ])
        ->groupBy("tvente_stock_service.id", "tvente_stock_service.refService", 
        "tvente_stock_service.refProduit", "designation", "refCategorie", "pu", 
        "Categorie", "qte", "uniteBase","tvente_stock_service.devise","tvente_stock_service.taux")
        ->orderBy("tvente_produit.designation", "asc")
        ->get();


    $data22 = DB::table('tvente_stock_service')
    ->join('tvente_services', 'tvente_services.id', '=', 'tvente_stock_service.refService')
    ->Join('tvente_produit', 'tvente_produit.id', '=', 'tvente_stock_service.refProduit')
    ->Join('tvente_categorie_produit', 'tvente_categorie_produit.id', '=', 'tvente_produit.refCategorie')

    ->leftJoin('tvente_mouvement_stock as dtSortie', function ($join) use ($date1, $idService) {
        $join->on('dtSortie.idStockService', '=', 'tvente_stock_service.id')        
             ->where('dtSortie.type_mouvement', '=', 'Sortie')
             ->where('dtSortie.dateMvt', '<', $date1);
    })
    // Utilisez distinct() avant select()
    ->distinct()
    ->select(
        // "tvente_stock_service.id",
        'tvente_stock_service.refService',
        'tvente_stock_service.refProduit',
        "tvente_produit.designation as designation",
        "refCategorie",
        "tvente_stock_service.pu",
        "tvente_categorie_produit.designation as Categorie",
        "tvente_stock_service.qte",
        "tvente_stock_service.uniteBase",
        DB::raw('IFNULL(ROUND(SUM(dtSortie.qteBase * dtSortie.qteMvt), 3), 0) as totalSortie')
    )
    ->where([
        ['tvente_produit.refCategorie', '=', $refCategorie],
        ['tvente_stock_service.refService', '=', $idService],
        ['tvente_produit.estvendable','=', $statut],
    ])
    // ->groupBy("tvente_stock_service.id", "tvente_stock_service.refService", 
    ->groupBy("tvente_stock_service.refService", 
    "tvente_stock_service.refProduit", "designation", "refCategorie", "pu", "Categorie",
     "qte", "uniteBase")
    ->orderBy("tvente_produit.designation", "asc")
    ->get();

    // ============ LEs Mouvements =========================================================================

        // Récupérer les données de stock, mouvements et ventes en une seule requête 
        $data1 = DB::table('tvente_stock_service')
        ->join('tvente_services', 'tvente_services.id', '=', 'tvente_stock_service.refService')
        ->Join('tvente_produit', 'tvente_produit.id', '=', 'tvente_stock_service.refProduit')
        ->Join('tvente_categorie_produit', 'tvente_categorie_produit.id', '=', 'tvente_produit.refCategorie')
    
        ->leftJoin('tvente_mouvement_stock as mvtEntree', function ($join) use ($date1, $date2, $idService) {
            $join->on('mvtEntree.idStockService', '=', 'tvente_stock_service.id')        
                 ->where('mvtEntree.type_mouvement', '=', 'Entree')
                 ->whereBetween('mvtEntree.dateMvt', [$date1, $date2]);
        })
    
            // Utilisez distinct() avant select()
            ->distinct()
            ->select(
                // "tvente_stock_service.id",
                'tvente_stock_service.refService',
                'tvente_stock_service.refProduit',
                "tvente_produit.designation as designation",
                "refCategorie",
                "tvente_stock_service.pu",
                "tvente_categorie_produit.designation as Categorie",
                "tvente_stock_service.qte",
                "tvente_stock_service.uniteBase",
                "tvente_stock_service.devise","tvente_stock_service.taux",            
                DB::raw('IFNULL(ROUND(SUM(mvtEntree.qteBase * mvtEntree.qteMvt), 3), 0) as stockEntree')                
            )
            ->where([
                ['tvente_produit.refCategorie', '=', $refCategorie],
                ['tvente_stock_service.refService', '=', $idService],
                ['tvente_produit.estvendable','=', $statut],
            ])
            // ->groupBy("tvente_stock_service.id", "tvente_stock_service.refService", 
            ->groupBy("tvente_stock_service.refService", 
            "tvente_stock_service.refProduit", 
            "designation", "refCategorie", "pu", "Categorie", "qte", "uniteBase",
            "tvente_stock_service.devise","tvente_stock_service.taux")
            ->orderBy("tvente_produit.designation", "asc")
            ->get();
    
    //======================================================================
    
        // Récupérer les données de stock, mouvements et ventes en une seule requête 
        $data2 = DB::table('tvente_stock_service')
        ->join('tvente_services', 'tvente_services.id', '=', 'tvente_stock_service.refService')
        ->Join('tvente_produit', 'tvente_produit.id', '=', 'tvente_stock_service.refProduit')
        ->Join('tvente_categorie_produit', 'tvente_categorie_produit.id', '=', 'tvente_produit.refCategorie')
    
        ->leftJoin('tvente_mouvement_stock as mvtSortie', function ($join) use ($date1, $date2, $idService) {
            $join->on('mvtSortie.idStockService', '=', 'tvente_stock_service.id')        
                 ->where('mvtSortie.type_mouvement', '=', 'Sortie')
                 ->whereBetween('mvtSortie.dateMvt', [$date1, $date2]);
        })
    
            // Utilisez distinct() avant select()
            ->distinct()
            ->select(
                // "tvente_stock_service.id",
                'tvente_stock_service.refService',
                'tvente_stock_service.refProduit',
                "tvente_produit.designation as designation",
                "refCategorie",
                "tvente_stock_service.pu",
                "tvente_categorie_produit.designation as Categorie",
                "tvente_stock_service.qte",
                "tvente_stock_service.uniteBase",
                "tvente_stock_service.devise","tvente_stock_service.taux",            
                DB::raw('IFNULL(ROUND(SUM(mvtSortie.qteBase * mvtSortie.qteMvt), 3), 0) as stockSortie')                
            )
            ->where([
                ['tvente_produit.refCategorie', '=', $refCategorie],
                ['tvente_stock_service.refService', '=', $idService],
                // ['tvente_produit.estvendable','=', $statut],
            ])
            // ->groupBy("tvente_stock_service.id", "tvente_stock_service.refService", 
            ->groupBy("tvente_stock_service.id", "tvente_stock_service.refService",
            "tvente_stock_service.refProduit", 
            "designation", "refCategorie", "pu", "Categorie", "qte", "uniteBase",
            "tvente_stock_service.devise","tvente_stock_service.taux")
            ->orderBy("tvente_produit.designation", "asc")
            ->get();




    // // Requête pour récupérer les informations nécessaires
    // $data_cmup = DB::table('tvente_stock_service')
    //     ->join('tvente_services', 'tvente_services.id', '=', 'tvente_stock_service.refService')
    //     ->join('tvente_produit', 'tvente_produit.id', '=', 'tvente_stock_service.refProduit')
    //     ->join('tvente_categorie_produit', 'tvente_categorie_produit.id', '=', 'tvente_produit.refCategorie')
    //     ->leftJoin('tvente_mouvement_stock as dtEntree', function ($join) use ($date1, $date2, $idService) {
    //         $join->on('dtEntree.idStockService', '=', 'tvente_stock_service.id')        
    //              ->where('dtEntree.type_mouvement', '=', 'Entree')
    //              ->whereBetween('dtEntree.dateMvt', [$date1, $date2]);
    //     })
    //     ->distinct()
    //     ->select(
    //         "tvente_stock_service.id",
    //         'tvente_stock_service.refService',
    //         'tvente_stock_service.refProduit',
    //         "tvente_produit.designation as designation",
    //         "refCategorie",
    //         "tvente_stock_service.pu",
    //         "tvente_categorie_produit.designation as Categorie",
    //         "tvente_stock_service.qte",
    //         "tvente_stock_service.uniteBase",
    //         "tvente_stock_service.devise",
    //         "tvente_stock_service.taux",            
    //         DB::raw('IFNULL(ROUND(SUM(dtEntree.qteBase * dtEntree.qteMvt), 3), 0) as totalEntree')
    //     )
    //     ->where([
    //         ['tvente_produit.refCategorie', '=', $refCategorie],
    //         ['tvente_stock_service.refService', '=', $idService],
    //         ['tvente_produit.estvendable', '=', $statut],
    //     ])
    //     ->groupBy(
    //         "tvente_stock_service.id", 
    //         "tvente_stock_service.refService", 
    //         "tvente_stock_service.refProduit", 
    //         "designation", 
    //         "refCategorie", 
    //         "pu", 
    //         "Categorie", 
    //         "qte", 
    //         "uniteBase",
    //         "devise",
    //         "taux"
    //     )
    //     ->orderBy("tvente_produit.designation", "asc")
    //     ->get();

    // // Calculer le CMUP en PHP
    // $cmupData = [];
    
    // foreach ($data11 as $item) {
    //     // Calculer le CMUP : (Total des Coûts / Total des Quantités)
    //     $totalCout = ($item->totalEntree * $item->pu); // Coût total basé sur les entrées et le prix unitaire
    //     $totalQte = $item->qte;

    //     // Éviter la division par zéro
    //     $cmup = ($totalQte > 0) ? round($totalCout / $totalQte, 3) : 0;

    //     // Ajouter les résultats au tableau
    //     $cmupData[] = [
    //         'id' => $item->id,
    //         'designation' => $item->designation,
    //         'cmup' => $cmup,
    //         'totalEntree' => $item->totalEntree,
    //         'categorie' => $item->Categorie,
    //         'uniteBase' => $item->uniteBase,
    //         'devise' => $item->devise,
    //         'taux' => $item->taux,
    //     ];
    // };
    // Construction de l'output
    
    $output = '';

    // Vérifiez que les deux tableaux ont la même longueur
    if ((count($data1) === count($data2)) && (count($data1) === count($data11)) 
    && (count($data1) === count($data22))) {

        $cmup_data =0;

    for ($i = 0; $i < count($data1); $i++) {
        $row11 = $data11[$i];
        $row22 = $data22[$i];
        $row1 = $data1[$i];
        $row2 = $data2[$i];

        $cmup_data = floatval($this->calculerCoutMoyen($row11->id, $date1, $date2));
        // $cmup_data = $row11->id;
        
        // Assurez-vous que toutes les variables nécessaires sont définies
        $totalEntree = isset($row11->totalEntree) ? floatval($row11->totalEntree) : 0;
        $totalSortie = isset($row22->totalSortie) ? floatval($row22->totalSortie) : 0;
        $stockEntree = isset($row1->stockEntree) ? floatval($row1->stockEntree) : 0;
        $stockSortie = isset($row2->stockSortie) ? floatval($row2->stockSortie) : 0;

        // Calculs
        $totalSI = $totalEntree - $totalSortie;
        $totalGEntree = $stockEntree;
        $totalG = $totalSI + $stockEntree;
        $TGSortie = $stockSortie;
        $totalSF = $totalG - $stockSortie;
        $totalPT = $totalSF * $cmup_data;

        // Construction de la sortie HTML
        $output .= '
        <tr style="vertical-align:top;">
            <td style="width:0px;height:24px;"></td>
            <td></td>
            <td class="cs8F59FFB2" colspan="2" style="width:165px;height:22px;line-height:15px;text-align:center;vertical-align:middle;">'.$row1->designation.'</td>
            <td class="cs6F7E55AC" colspan="2" style="width:105px;height:22px;line-height:15px;text-align:center;vertical-align:middle;">'.$totalSI.' '.$row1->uniteBase.'</td>
            <td class="csE78F4A6" style="width:107px;height:22px;line-height:15px;text-align:center;vertical-align:middle;">'.$totalGEntree.' '.$row1->uniteBase.'</td>
            <td class="csD149F8AB" colspan="2" style="width:109px;height:22px;line-height:15px;text-align:center;vertical-align:middle;">'.$totalG.' '.$row1->uniteBase.'</td>
            <td class="cs4B928201" colspan="2" style="width:109px;height:22px;line-height:15px;text-align:center;vertical-align:middle;">'.$TGSortie.' '.$row1->uniteBase.'</td>
            <td class="csE78F4A6" style="width:76px;height:22px;line-height:15px;text-align:center;vertical-align:middle;">'.$totalSF.' '.$row1->uniteBase.'</td>                
            <td class="cs4B928201" colspan="3" style="width:139px;height:22px;line-height:15px;text-align:center;vertical-align:middle;">'.round($cmup_data, 2).'$</td>
            <td class="cs6F7E55AC" colspan="2" style="width:133px;height:22px;line-height:15px;text-align:center;vertical-align:middle;">'.round($totalPT, 2).'$</td>
        </tr>';
    }
    } else {
        // Gérer le cas où les tableaux n'ont pas la même longueur
        echo 'Les tableaux pas la même longueur.';
    }

    return $output;
}



















//===================================================================================================================
//======================== FICHE STOCK AVEC EXCEL ====================================================================

//=============== FICHE DE STOCK DES SERVICES EXCEL=======================================================================================
function pdf_fiche_stock_vente_service_excel(Request $request)
{
    if ($request->get('date1') && $request->get('date2') && $request->get('idService')) {
        $date1 = $request->get('date1');
        $date2 = $request->get('date2');
        $idService = $request->get('idService');

        $data_return = []; // Initialisation du tableau pour stocker les résultats

            // Récupérer les données de stock, mouvements et ventes en une seule requête 
        $data11 = DB::table('tvente_stock_service')
        ->join('tvente_services', 'tvente_services.id', '=', 'tvente_stock_service.refService')
        ->Join('tvente_produit', 'tvente_produit.id', '=', 'tvente_stock_service.refProduit')
        ->Join('tvente_categorie_produit', 'tvente_categorie_produit.id', '=', 'tvente_produit.refCategorie')

        ->leftJoin('tvente_mouvement_stock as dtEntree', function ($join) use ($date1, $idService) {
        $join->on('dtEntree.idStockService', '=', 'tvente_stock_service.id')        
             ->where('dtEntree.type_mouvement', '=', 'Entree')
             ->where('dtEntree.dateMvt', '<', $date1);
    })

        // Utilisez distinct() avant select()
        ->distinct()
        ->select(
            "tvente_stock_service.id",
            'tvente_stock_service.refService',
            'tvente_stock_service.refProduit',
            "tvente_produit.designation as designation",
            "refCategorie",
            "tvente_stock_service.pu",
            "tvente_categorie_produit.designation as Categorie",
            "tvente_stock_service.qte",
            "tvente_stock_service.uniteBase",
            "tvente_stock_service.cmup",
            "tvente_stock_service.devise",
            "tvente_stock_service.taux",            
            DB::raw('IFNULL(ROUND(SUM(dtEntree.qteBase * dtEntree.qteMvt), 3), 0) as totalEntree'),

        )
        ->where([
            ['tvente_stock_service.refService', '=', $idService]
        ])
        ->groupBy("tvente_stock_service.id",
            'tvente_stock_service.refService',
            'tvente_stock_service.refProduit',
            "tvente_produit.designation",
            "refCategorie",
            "tvente_stock_service.pu",
            "tvente_categorie_produit.designation",
            "tvente_stock_service.qte",
            "tvente_stock_service.uniteBase",
            "tvente_stock_service.cmup",
            "tvente_stock_service.devise",
            "tvente_stock_service.taux")
        ->orderBy("tvente_produit.designation", "asc")
        ->get();

    $data22 = DB::table('tvente_stock_service')
    ->join('tvente_services', 'tvente_services.id', '=', 'tvente_stock_service.refService')
    ->Join('tvente_produit', 'tvente_produit.id', '=', 'tvente_stock_service.refProduit')
    ->Join('tvente_categorie_produit', 'tvente_categorie_produit.id', '=', 'tvente_produit.refCategorie')

    ->leftJoin('tvente_mouvement_stock as dtSortie', function ($join) use ($date1, $idService) {
        $join->on('dtSortie.idStockService', '=', 'tvente_stock_service.id')        
             ->where('dtSortie.type_mouvement', '=', 'Sortie')
             ->where('dtSortie.dateMvt', '<', $date1);
    })
    // Utilisez distinct() avant select()
    ->distinct()
    ->select(
        "tvente_stock_service.id",
        'tvente_stock_service.refService',
        'tvente_stock_service.refProduit',
        "tvente_produit.designation as designation",
        "refCategorie",
        "tvente_stock_service.pu",
        "tvente_categorie_produit.designation as Categorie",
        "tvente_stock_service.qte",
        "tvente_stock_service.uniteBase",
        "tvente_stock_service.cmup",
        DB::raw('IFNULL(ROUND(SUM(dtSortie.qteBase * dtSortie.qteMvt), 3), 0) as totalSortie')
    )
    ->where([
        ['tvente_stock_service.refService', '=', $idService]
    ])
    ->groupBy("tvente_stock_service.id",
        'tvente_stock_service.refService',
        'tvente_stock_service.refProduit',
        "tvente_produit.designation",
        "refCategorie",
        "tvente_stock_service.pu",
        "tvente_categorie_produit.designation",
        "tvente_stock_service.qte",
        "tvente_stock_service.uniteBase",
        "tvente_stock_service.cmup"
        )
    ->orderBy("tvente_produit.designation", "asc")
    ->get();

    // ============ LEs Mouvements =========================================================================

        // Récupérer les données de stock, mouvements et ventes en une seule requête 
        $data1 = DB::table('tvente_stock_service')
        ->join('tvente_services', 'tvente_services.id', '=', 'tvente_stock_service.refService')
        ->Join('tvente_produit', 'tvente_produit.id', '=', 'tvente_stock_service.refProduit')
        ->Join('tvente_categorie_produit', 'tvente_categorie_produit.id', '=', 'tvente_produit.refCategorie')
    
        ->leftJoin('tvente_mouvement_stock as mvtEntree', function ($join) use ($date1, $date2, $idService) {
            $join->on('mvtEntree.idStockService', '=', 'tvente_stock_service.id')        
                 ->where('mvtEntree.type_mouvement', '=', 'Entree')
                 ->whereBetween('mvtEntree.dateMvt', [$date1, $date2]);;
        })
    
            // Utilisez distinct() avant select()
            ->distinct()
            ->select(
                "tvente_stock_service.id",
                'tvente_stock_service.refService',
                'tvente_stock_service.refProduit',
                "tvente_produit.designation as designation",
                "refCategorie",
                "tvente_stock_service.pu",
                "tvente_categorie_produit.designation as Categorie",
                "tvente_stock_service.qte",
                "tvente_stock_service.uniteBase","nom_service",
                "tvente_stock_service.cmup",
                "tvente_stock_service.devise",
                "tvente_stock_service.taux",            
                DB::raw('IFNULL(ROUND(SUM(mvtEntree.qteBase * mvtEntree.qteMvt), 3), 0) as stockEntree')
    
            )
            ->where([
                ['tvente_stock_service.refService', '=', $idService]
            ])
            ->groupBy(
                "tvente_stock_service.id",
                'tvente_stock_service.refService',
                'tvente_stock_service.refProduit',
                "tvente_produit.designation",
                "refCategorie",
                "tvente_stock_service.pu",
                "tvente_categorie_produit.designation",
                "tvente_stock_service.qte",
                "tvente_stock_service.uniteBase",
                "nom_service",
                "tvente_stock_service.cmup",
                "tvente_stock_service.devise",
                "tvente_stock_service.taux"
                )
            ->orderBy("tvente_produit.designation", "asc")
            ->get();
    
    //======================================================================
    
        // Récupérer les données de stock, mouvements et ventes en une seule requête 
        $data2 = DB::table('tvente_stock_service')
        ->join('tvente_services', 'tvente_services.id', '=', 'tvente_stock_service.refService')
        ->Join('tvente_produit', 'tvente_produit.id', '=', 'tvente_stock_service.refProduit')
        ->Join('tvente_categorie_produit', 'tvente_categorie_produit.id', '=', 'tvente_produit.refCategorie')
    
        ->leftJoin('tvente_mouvement_stock as mvtSortie', function ($join) use ($date1, $date2, $idService) {
            $join->on('mvtSortie.idStockService', '=', 'tvente_stock_service.id')        
                 ->where('mvtSortie.type_mouvement', '=', 'Sortie')
                 ->whereBetween('mvtSortie.dateMvt', [$date1, $date2]);;
        })
    
            // Utilisez distinct() avant select()
            ->distinct()
            ->select(
                "tvente_stock_service.id",
                'tvente_stock_service.refService',
                'tvente_stock_service.refProduit',
                "tvente_produit.designation as designation",
                "refCategorie",
                "tvente_stock_service.pu",
                "tvente_categorie_produit.designation as Categorie",
                "tvente_stock_service.qte",
                "tvente_stock_service.uniteBase","nom_service",
                "tvente_stock_service.cmup",
                "tvente_stock_service.devise",
                "tvente_stock_service.taux",            
                DB::raw('IFNULL(ROUND(SUM(mvtSortie.qteBase * mvtSortie.qteMvt), 3), 0) as stockSortie'),
    
            )
            ->where([
                ['tvente_stock_service.refService', '=', $idService]
            ])
            ->groupBy(
                "tvente_stock_service.id",
                'tvente_stock_service.refService',
                'tvente_stock_service.refProduit',
                "tvente_produit.designation",
                "refCategorie",
                "tvente_stock_service.pu",
                "tvente_categorie_produit.designation",
                "tvente_stock_service.qte",
                "tvente_stock_service.uniteBase",
                "nom_service",
                "tvente_stock_service.cmup",
                "tvente_stock_service.devise",
                "tvente_stock_service.taux"
                )
            ->orderBy("tvente_produit.designation", "asc")
            ->get();
    

    // Vérifiez que les deux tableaux ont la même longueur
    if ((count($data1) === count($data2)) && (count($data1) === count($data11)) 
    && (count($data1) === count($data22)))
    {
        for ($i = 0; $i < count($data1); $i++) {
            $row11 = $data11[$i];
            $row22 = $data22[$i];
            $row1 = $data1[$i];
            $row2 = $data2[$i];            

            $cmup_data = floatval($this->calculerCoutMoyen($row1->id, $date1, $date2));
            
            $totalSortie = floatval($row22->totalSortie);
            $totalEntree = floatval($row11->totalEntree);

            $stockSortie = floatval($row2->stockSortie);            
            $stockEntree = floatval($row1->stockEntree);

            $totalSI = ((floatval($totalEntree)) - (floatval($totalSortie)));
            $totalGEntree = floatval($stockEntree);
            $totalG = floatval($totalSI) + floatval($stockEntree);
            $TGSortie = floatval($stockSortie);
            $totalSF = floatval($totalG) - floatval($stockSortie);
            $totalPT = floatval($totalSF) * floatval($cmup_data);



            $data_return[] = [
                'id' => $row1->id,
                'Service' => $row1->nom_service,
                'designation' => $row1->designation,
                'Categorie' => $row1->Categorie,
                'SI' => $totalSI,
                'Entree' =>$totalGEntree,
                'Total' => $totalG,
                'Sortie' => $TGSortie,
                'SF' => $totalSF,
                'PU' => round($cmup_data,2),
                'PT' => round($totalPT,2),
                'Unité' => $row1->uniteBase
            ];

        }
    } 
    else {
        // Gérer le cas où les tableaux n'ont pas la même longueur
        echo 'Les tableaux ont pas la même longueur.';
    }

    return response()->json($data_return);

    }



    return response()->json(['error' => 'Invalid parameters'], 400);
}
//=============== FICHE DE STOCK DES SERVICES EXCEL=======================================================================================
function pdf_fiche_stock_vente_service_sans_prix_excel(Request $request)
{
    if ($request->get('date1') && $request->get('date2') && $request->get('idService')) {
        $date1 = $request->get('date1');
        $date2 = $request->get('date2');
        $idService = $request->get('idService');

        $data_return = []; // Initialisation du tableau pour stocker les résultats

            // Récupérer les données de stock, mouvements et ventes en une seule requête 
        $data11 = DB::table('tvente_stock_service')
        ->join('tvente_services', 'tvente_services.id', '=', 'tvente_stock_service.refService')
        ->Join('tvente_produit', 'tvente_produit.id', '=', 'tvente_stock_service.refProduit')
        ->Join('tvente_categorie_produit', 'tvente_categorie_produit.id', '=', 'tvente_produit.refCategorie')

        ->leftJoin('tvente_mouvement_stock as dtEntree', function ($join) use ($date1, $idService) {
        $join->on('dtEntree.idStockService', '=', 'tvente_stock_service.id')        
             ->where('dtEntree.type_mouvement', '=', 'Entree')
             ->where('dtEntree.dateMvt', '<', $date1);
        })

        // Utilisez distinct() avant select()
        ->distinct()
        ->select(
            "tvente_stock_service.id",
            'tvente_stock_service.refService',
            'tvente_stock_service.refProduit',
            "tvente_produit.designation as designation",
            "refCategorie",
            "tvente_stock_service.pu",
            "tvente_categorie_produit.designation as Categorie",
            "tvente_stock_service.qte",
            "tvente_stock_service.uniteBase",
            "tvente_stock_service.cmup",
            "tvente_stock_service.devise",
            "tvente_stock_service.taux",            
            DB::raw('IFNULL(ROUND(SUM(dtEntree.qteBase * dtEntree.qteMvt), 3), 0) as totalEntree'),

        )
        ->where([
            ['tvente_stock_service.refService', '=', $idService]
        ])
        ->groupBy("tvente_stock_service.id",
            'tvente_stock_service.refService',
            'tvente_stock_service.refProduit',
            "tvente_produit.designation",
            "refCategorie",
            "tvente_stock_service.pu",
            "tvente_categorie_produit.designation",
            "tvente_stock_service.qte",
            "tvente_stock_service.uniteBase",
            "tvente_stock_service.cmup",
            "tvente_stock_service.devise",
            "tvente_stock_service.taux")
        ->orderBy("tvente_produit.designation", "asc")
        ->get();

    $data22 = DB::table('tvente_stock_service')
    ->join('tvente_services', 'tvente_services.id', '=', 'tvente_stock_service.refService')
    ->Join('tvente_produit', 'tvente_produit.id', '=', 'tvente_stock_service.refProduit')
    ->Join('tvente_categorie_produit', 'tvente_categorie_produit.id', '=', 'tvente_produit.refCategorie')

    ->leftJoin('tvente_mouvement_stock as dtSortie', function ($join) use ($date1, $idService) {
        $join->on('dtSortie.idStockService', '=', 'tvente_stock_service.id')        
             ->where('dtSortie.type_mouvement', '=', 'Sortie')
             ->where('dtSortie.dateMvt', '<', $date1);
    })
    // Utilisez distinct() avant select()
    ->distinct()
    ->select(
        "tvente_stock_service.id",
        'tvente_stock_service.refService',
        'tvente_stock_service.refProduit',
        "tvente_produit.designation as designation",
        "refCategorie",
        "tvente_stock_service.pu",
        "tvente_categorie_produit.designation as Categorie",
        "tvente_stock_service.qte",
        "tvente_stock_service.uniteBase",
        "tvente_stock_service.cmup",
        DB::raw('IFNULL(ROUND(SUM(dtSortie.qteBase * dtSortie.qteMvt), 3), 0) as totalSortie')
    )
    ->where([
        ['tvente_stock_service.refService', '=', $idService]
    ])
    ->groupBy("tvente_stock_service.id",
        'tvente_stock_service.refService',
        'tvente_stock_service.refProduit',
        "tvente_produit.designation",
        "refCategorie",
        "tvente_stock_service.pu",
        "tvente_categorie_produit.designation",
        "tvente_stock_service.qte",
        "tvente_stock_service.uniteBase",
        "tvente_stock_service.cmup"
        )
    ->orderBy("tvente_produit.designation", "asc")
    ->get();

    // ============ LEs Mouvements =========================================================================

        // Récupérer les données de stock, mouvements et ventes en une seule requête 
        $data1 = DB::table('tvente_stock_service')
        ->join('tvente_services', 'tvente_services.id', '=', 'tvente_stock_service.refService')
        ->Join('tvente_produit', 'tvente_produit.id', '=', 'tvente_stock_service.refProduit')
        ->Join('tvente_categorie_produit', 'tvente_categorie_produit.id', '=', 'tvente_produit.refCategorie')
    
        ->leftJoin('tvente_mouvement_stock as mvtEntree', function ($join) use ($date1, $date2, $idService) {
            $join->on('mvtEntree.idStockService', '=', 'tvente_stock_service.id')        
                 ->where('mvtEntree.type_mouvement', '=', 'Entree')
                 ->whereBetween('mvtEntree.dateMvt', [$date1, $date2]);;
        })
    
            // Utilisez distinct() avant select()
            ->distinct()
            ->select(
                "tvente_stock_service.id",
                'tvente_stock_service.refService',
                'tvente_stock_service.refProduit',
                "tvente_produit.designation as designation",
                "refCategorie",
                "tvente_stock_service.pu",
                "tvente_categorie_produit.designation as Categorie",
                "tvente_stock_service.qte",
                "tvente_stock_service.uniteBase","nom_service",
                "tvente_stock_service.cmup",
                "tvente_stock_service.devise",
                "tvente_stock_service.taux",            
                DB::raw('IFNULL(ROUND(SUM(mvtEntree.qteBase * mvtEntree.qteMvt), 3), 0) as stockEntree')
    
            )
            ->where([
                ['tvente_stock_service.refService', '=', $idService]
            ])
            ->groupBy(
                "tvente_stock_service.id",
                'tvente_stock_service.refService',
                'tvente_stock_service.refProduit',
                "tvente_produit.designation",
                "refCategorie",
                "tvente_stock_service.pu",
                "tvente_categorie_produit.designation",
                "tvente_stock_service.qte",
                "tvente_stock_service.uniteBase",
                "nom_service",
                "tvente_stock_service.cmup",
                "tvente_stock_service.devise",
                "tvente_stock_service.taux"
                )
            ->orderBy("tvente_produit.designation", "asc")
            ->get();
    
    //======================================================================
    
        // Récupérer les données de stock, mouvements et ventes en une seule requête 
        $data2 = DB::table('tvente_stock_service')
        ->join('tvente_services', 'tvente_services.id', '=', 'tvente_stock_service.refService')
        ->Join('tvente_produit', 'tvente_produit.id', '=', 'tvente_stock_service.refProduit')
        ->Join('tvente_categorie_produit', 'tvente_categorie_produit.id', '=', 'tvente_produit.refCategorie')
    
        ->leftJoin('tvente_mouvement_stock as mvtSortie', function ($join) use ($date1, $date2, $idService) {
            $join->on('mvtSortie.idStockService', '=', 'tvente_stock_service.id')        
                 ->where('mvtSortie.type_mouvement', '=', 'Sortie')
                 ->whereBetween('mvtSortie.dateMvt', [$date1, $date2]);;
        })
    
            // Utilisez distinct() avant select()
            ->distinct()
            ->select(
                "tvente_stock_service.id",
                'tvente_stock_service.refService',
                'tvente_stock_service.refProduit',
                "tvente_produit.designation as designation",
                "refCategorie",
                "tvente_stock_service.pu",
                "tvente_categorie_produit.designation as Categorie",
                "tvente_stock_service.qte",
                "tvente_stock_service.uniteBase","nom_service",
                "tvente_stock_service.cmup",
                "tvente_stock_service.devise",
                "tvente_stock_service.taux",            
                DB::raw('IFNULL(ROUND(SUM(mvtSortie.qteBase * mvtSortie.qteMvt), 3), 0) as stockSortie'),
    
            )
            ->where([
                ['tvente_stock_service.refService', '=', $idService]
            ])
            ->groupBy(
                "tvente_stock_service.id",
                'tvente_stock_service.refService',
                'tvente_stock_service.refProduit',
                "tvente_produit.designation",
                "refCategorie",
                "tvente_stock_service.pu",
                "tvente_categorie_produit.designation",
                "tvente_stock_service.qte",
                "tvente_stock_service.uniteBase",
                "nom_service",
                "tvente_stock_service.cmup",
                "tvente_stock_service.devise",
                "tvente_stock_service.taux"
                )
            ->orderBy("tvente_produit.designation", "asc")
            ->get();
    

    // Vérifiez que les deux tableaux ont la même longueur
    if ((count($data1) === count($data2)) && (count($data1) === count($data11)) 
    && (count($data1) === count($data22)))
    {
        for ($i = 0; $i < count($data1); $i++) {
            $row11 = $data11[$i];
            $row22 = $data22[$i];
            $row1 = $data1[$i];
            $row2 = $data2[$i];   
            
            $cmup_data = floatval($this->calculerCoutMoyen($row1->id, $date1, $date2));

            $totalSortie = floatval($row22->totalSortie);
            $totalEntree = floatval($row11->totalEntree);

            $stockSortie = floatval($row2->stockSortie);            
            $stockEntree = floatval($row1->stockEntree);

            $totalSI = ((floatval($totalEntree)) - (floatval($totalSortie)));
            $totalGEntree = floatval($stockEntree);
            $totalG = floatval($totalSI) + floatval($stockEntree);
            $TGSortie = floatval($stockSortie);
            $totalSF = floatval($totalG) - floatval($stockSortie);
            $totalPT = floatval($totalSF) * floatval($row2->cmup);

            $data_return[] = [
                'id' => $row1->id,
                'Service' => $row1->nom_service,
                'designation' => $row1->designation,
                'Categorie' => $row1->Categorie,
                'SI' => $totalSI,
                'Entree' =>$totalGEntree,
                'Total' => $totalG,
                'Sortie' => $TGSortie,
                'SF' => $totalSF,
                // 'PU' => round($row1->cmup,2),
                // 'PT' => round($totalPT,2),
                'Unité' => $row1->uniteBase
            ];

        }
    } 
    else {
        // Gérer le cas où les tableaux n'ont pas la même longueur
        echo 'Les tableaux ont pas la même longueur.';
    }

    return response()->json($data_return);

    }



    return response()->json(['error' => 'Invalid parameters'], 400);
}
//=============== FICHE DE STOCK DES SERVICES BY CATEGORIE EXCEL=======================================================================================
function pdf_fiche_stock_vente_service_bycategorie_excel(Request $request)
{
    if ($request->get('date1') && $request->get('date2') && $request->get('idCategorie') && $request->get('idService')) {
        $date1 = $request->get('date1');
        $date2 = $request->get('date2');
        $refCategorie = $request->get('idCategorie');
        $idService = $request->get('idService');

        $data_return = []; // Initialisation du tableau pour stocker les résultat

        $data11 = DB::table('tvente_stock_service')
        ->join('tvente_services', 'tvente_services.id', '=', 'tvente_stock_service.refService')
        ->Join('tvente_produit', 'tvente_produit.id', '=', 'tvente_stock_service.refProduit')
        ->Join('tvente_categorie_produit', 'tvente_categorie_produit.id', '=', 'tvente_produit.refCategorie')
    
        ->leftJoin('tvente_mouvement_stock as dtEntree', function ($join) use ($date1, $idService) {
            $join->on('dtEntree.idStockService', '=', 'tvente_stock_service.id')        
                 ->where('dtEntree.type_mouvement', '=', 'Entree')
                 ->where('dtEntree.dateMvt', '<', $date1);
        })
    
            // Utilisez distinct() avant select()
            ->distinct()
            ->select(
                "tvente_stock_service.id",
                'tvente_stock_service.refService',
                'tvente_stock_service.refProduit',
                "tvente_produit.designation as designation",
                "refCategorie",
                "tvente_stock_service.pu",
                "tvente_categorie_produit.designation as Categorie",
                "tvente_stock_service.qte",
                "tvente_stock_service.uniteBase",
                "tvente_stock_service.cmup",
                "tvente_stock_service.devise",
                "tvente_stock_service.taux",            
                DB::raw('IFNULL(ROUND(SUM(dtEntree.qteBase * dtEntree.qteMvt), 3), 0) as totalEntree'),
    
            )
            ->where([
                ['tvente_produit.refCategorie', '=', $refCategorie],
                ['tvente_stock_service.refService', '=', $idService]
            ])
            ->groupBy("tvente_stock_service.id",
                'tvente_stock_service.refService',
                'tvente_stock_service.refProduit',
                "tvente_produit.designation",
                "refCategorie",
                "tvente_stock_service.pu",
                "tvente_categorie_produit.designation",
                "tvente_stock_service.qte",
                "tvente_stock_service.uniteBase",
                "tvente_stock_service.cmup",
                "tvente_stock_service.devise",
                "tvente_stock_service.taux")
            ->orderBy("tvente_produit.designation", "asc")
            ->get();
    
        $data22 = DB::table('tvente_stock_service')
        ->join('tvente_services', 'tvente_services.id', '=', 'tvente_stock_service.refService')
        ->Join('tvente_produit', 'tvente_produit.id', '=', 'tvente_stock_service.refProduit')
        ->Join('tvente_categorie_produit', 'tvente_categorie_produit.id', '=', 'tvente_produit.refCategorie')
    
        ->leftJoin('tvente_mouvement_stock as dtSortie', function ($join) use ($date1, $idService) {
            $join->on('dtSortie.idStockService', '=', 'tvente_stock_service.id')        
                 ->where('dtSortie.type_mouvement', '=', 'Sortie')
                 ->where('dtSortie.dateMvt', '<', $date1);
        })
        // Utilisez distinct() avant select()
        ->distinct()
        ->select(
            "tvente_stock_service.id",
            'tvente_stock_service.refService',
            'tvente_stock_service.refProduit',
            "tvente_produit.designation as designation",
            "refCategorie",
            "tvente_stock_service.pu",
            "tvente_categorie_produit.designation as Categorie",
            "tvente_stock_service.qte",
            "tvente_stock_service.uniteBase",
            "tvente_stock_service.cmup",
            DB::raw('IFNULL(ROUND(SUM(dtSortie.qteBase * dtSortie.qteMvt), 3), 0) as totalSortie')
        )
        ->where([
            ['tvente_produit.refCategorie', '=', $refCategorie],
            ['tvente_stock_service.refService', '=', $idService]
        ])
        ->groupBy(
            "tvente_stock_service.id",
            'tvente_stock_service.refService',
            'tvente_stock_service.refProduit',
            "tvente_produit.designation",
            "refCategorie",
            "tvente_stock_service.pu",
            "tvente_categorie_produit.designation",
            "tvente_stock_service.qte",
            "tvente_stock_service.uniteBase",
            "tvente_stock_service.cmup"
            )
        ->orderBy("tvente_produit.designation", "asc")
        ->get();
    
        // ============ LEs Mouvements =========================================================================
    
            // Récupérer les données de stock, mouvements et ventes en une seule requête 
            $data1 = DB::table('tvente_stock_service')
            ->join('tvente_services', 'tvente_services.id', '=', 'tvente_stock_service.refService')
            ->Join('tvente_produit', 'tvente_produit.id', '=', 'tvente_stock_service.refProduit')
            ->Join('tvente_categorie_produit', 'tvente_categorie_produit.id', '=', 'tvente_produit.refCategorie')
        
            ->leftJoin('tvente_mouvement_stock as mvtEntree', function ($join) use ($date1, $date2, $idService) {
                $join->on('mvtEntree.idStockService', '=', 'tvente_stock_service.id')        
                     ->where('mvtEntree.type_mouvement', '=', 'Entree')
                     ->whereBetween('mvtEntree.dateMvt', [$date1, $date2]);;
            })
        
                // Utilisez distinct() avant select()
                ->distinct()
                ->select(
                    "tvente_stock_service.id",
                    'tvente_stock_service.refService',
                    'tvente_stock_service.refProduit',
                    "tvente_produit.designation as designation",
                    "refCategorie",
                    "tvente_stock_service.pu",
                    "tvente_categorie_produit.designation as Categorie",
                    "tvente_stock_service.qte",
                    "tvente_stock_service.uniteBase","nom_service",
                    "tvente_stock_service.cmup",
                    "tvente_stock_service.devise",
                    "tvente_stock_service.taux",            
                    DB::raw('IFNULL(ROUND(SUM(mvtEntree.qteBase * mvtEntree.qteMvt), 3), 0) as stockEntree')
        
                )
                ->where([
                    ['tvente_produit.refCategorie', '=', $refCategorie],
                    ['tvente_stock_service.refService', '=', $idService]
                ])
                ->groupBy("tvente_stock_service.id",
                    'tvente_stock_service.refService',
                    'tvente_stock_service.refProduit',
                    "tvente_produit.designation",
                    "refCategorie",
                    "tvente_stock_service.pu",
                    "tvente_categorie_produit.designation",
                    "tvente_stock_service.qte",
                    "tvente_stock_service.uniteBase",
                    "nom_service",
                    "tvente_stock_service.cmup",
                    "tvente_stock_service.devise",
                    "tvente_stock_service.taux")
                ->orderBy("tvente_produit.designation", "asc")
                ->get();
        
        //======================================================================
        
            // Récupérer les données de stock, mouvements et ventes en une seule requête 
            $data2 = DB::table('tvente_stock_service')
            ->join('tvente_services', 'tvente_services.id', '=', 'tvente_stock_service.refService')
            ->Join('tvente_produit', 'tvente_produit.id', '=', 'tvente_stock_service.refProduit')
            ->Join('tvente_categorie_produit', 'tvente_categorie_produit.id', '=', 'tvente_produit.refCategorie')
        
            ->leftJoin('tvente_mouvement_stock as mvtSortie', function ($join) use ($date1, $date2, $idService) {
                $join->on('mvtSortie.idStockService', '=', 'tvente_stock_service.id')        
                     ->where('mvtSortie.type_mouvement', '=', 'Sortie')
                     ->whereBetween('mvtSortie.dateMvt', [$date1, $date2]);;
            })
        
                // Utilisez distinct() avant select()
                ->distinct()
                ->select(
                    "tvente_stock_service.id",
                    'tvente_stock_service.refService',
                    'tvente_stock_service.refProduit',
                    "tvente_produit.designation as designation",
                    "refCategorie",
                    "tvente_stock_service.pu",
                    "tvente_categorie_produit.designation as Categorie",
                    "tvente_stock_service.qte",
                    "tvente_stock_service.uniteBase","nom_service",
                    "tvente_stock_service.cmup",
                    "tvente_stock_service.devise",
                    "tvente_stock_service.taux",            
                    DB::raw('IFNULL(ROUND(SUM(mvtSortie.qteBase * mvtSortie.qteMvt), 3), 0) as stockSortie'),
        
                )
                ->where([
                    ['tvente_produit.refCategorie', '=', $refCategorie],
                    ['tvente_stock_service.refService', '=', $idService]
                ])
                ->groupBy("tvente_stock_service.id",
                    'tvente_stock_service.refService',
                    'tvente_stock_service.refProduit',
                    "tvente_produit.designation",
                    "refCategorie",
                    "tvente_stock_service.pu",
                    "tvente_categorie_produit.designation",
                    "tvente_stock_service.qte",
                    "tvente_stock_service.uniteBase","nom_service",
                    "tvente_stock_service.cmup",
                    "tvente_stock_service.devise",
                    "tvente_stock_service.taux")
                ->orderBy("tvente_produit.designation", "asc")
                ->get();
        
    
        // Vérifiez que les deux tableaux ont la même longueur
        if ((count($data1) === count($data2)) && (count($data1) === count($data11)) 
        && (count($data1) === count($data22)))
        {
            for ($i = 0; $i < count($data1); $i++) {
                $row11 = $data11[$i];
                $row22 = $data22[$i];
                $row1 = $data1[$i];
                $row2 = $data2[$i];      
                
                $cmup_data = floatval($this->calculerCoutMoyen($row1->id, $date1, $date2));
    
                $totalSortie = floatval($row22->totalSortie);
                $totalEntree = floatval($row11->totalEntree);
    
                $stockSortie = floatval($row2->stockSortie);            
                $stockEntree = floatval($row1->stockEntree);
    
                $totalSI = ((floatval($totalEntree)) - (floatval($totalSortie)));
                $totalGEntree = floatval($stockEntree);
                $totalG = floatval($totalSI) + floatval($stockEntree);
                $TGSortie = floatval($stockSortie);
                $totalSF = floatval($totalG) - floatval($stockSortie);
                $totalPT = floatval($totalSF) * floatval($cmup_data);
    
                $data_return[] = [
                    'id' => $row1->id,
                    'Service' => $row1->nom_service,
                    'designation' => $row1->designation,
                    'Categorie' => $row1->Categorie,
                    'SI' => $totalSI,
                    'Entree' =>$totalGEntree,
                    'Total' => $totalG,
                    'Sortie' => $TGSortie,
                    'SF' => $totalSF,
                    'PU' => round($cmup_data,2),
                    'PT' => round($totalPT,2),
                    'Unité' => $row1->uniteBase
                ];
    
            }
        } 
        else {
            // Gérer le cas où les tableaux n'ont pas la même longueur
            echo 'Les tableaux ont pas la même longueur.';
        }
    
        return response()->json($data_return);
    
        }
 
    return response()->json(['error' => 'Invalid parameters'], 400);
}

//=============== FICHE DE STOCK DES SERVICES BY CATEGORIE AVEC GRAANDE UNITE=======================================================================================

function pdf_fiche_stock_vente_service_bycategorie_unite_excel(Request $request)
{

    if ($request->get('date1') && $request->get('date2') && $request->get('idCategorie') && $request->get('idService')) {
        // code...
        $date1 = $request->get('date1');
        $date2 = $request->get('date2');
        $refCategorie = $request->get('idCategorie');
        $idService = $request->get('idService');

        $data_return = []; // Initialisation du tableau pour stocker les résultats

            // Récupérer les données de stock, mouvements et ventes en une seule requête 
        $data11 = DB::table('tvente_stock_service')
        ->join('tvente_services', 'tvente_services.id', '=', 'tvente_stock_service.refService')
        ->Join('tvente_produit', 'tvente_produit.id', '=', 'tvente_stock_service.refProduit')
        ->Join('tvente_categorie_produit', 'tvente_categorie_produit.id', '=', 'tvente_produit.refCategorie')

        ->leftJoin('tvente_mouvement_stock as dtEntree', function ($join) use ($date1, $idService) {
        $join->on('dtEntree.idStockService', '=', 'tvente_stock_service.id')        
             ->where('dtEntree.type_mouvement', '=', 'Entree')
             ->where('dtEntree.dateMvt', '<', $date1);
        })

        // Utilisez distinct() avant select()
        ->distinct()
        ->select(
            "tvente_stock_service.id",
            'tvente_stock_service.refService',
            'tvente_stock_service.refProduit',
            "tvente_produit.designation as designation",
            "refCategorie",
            "tvente_stock_service.pu",
            "tvente_categorie_produit.designation as Categorie",
            "tvente_stock_service.qte",
            "tvente_stock_service.uniteBase",
            "nom_service","qtePivot","unitePivot",
            "tvente_stock_service.cmup",
            "tvente_stock_service.devise",
            "tvente_stock_service.taux",            
            DB::raw('IFNULL(ROUND(SUM(dtEntree.qteBase * dtEntree.qteMvt), 3), 0) as totalEntree'),

        )
        ->where([
            ['tvente_produit.refCategorie', '=', $refCategorie],
            ['tvente_stock_service.refService', '=', $idService]
        ])
        ->groupBy("tvente_stock_service.id",
            'tvente_stock_service.refService',
            'tvente_stock_service.refProduit',
            "tvente_produit.designation",
            "refCategorie",
            "tvente_stock_service.pu",
            "tvente_categorie_produit.designation",
            "tvente_stock_service.qte",
            "tvente_stock_service.uniteBase",
            "nom_service","qtePivot","unitePivot",
            "tvente_stock_service.cmup",
            "tvente_stock_service.devise",
            "tvente_stock_service.taux")
        ->orderBy("tvente_produit.designation", "asc")
        ->get();

    $data22 = DB::table('tvente_stock_service')
    ->join('tvente_services', 'tvente_services.id', '=', 'tvente_stock_service.refService')
    ->Join('tvente_produit', 'tvente_produit.id', '=', 'tvente_stock_service.refProduit')
    ->Join('tvente_categorie_produit', 'tvente_categorie_produit.id', '=', 'tvente_produit.refCategorie')

    ->leftJoin('tvente_mouvement_stock as dtSortie', function ($join) use ($date1, $idService) {
        $join->on('dtSortie.idStockService', '=', 'tvente_stock_service.id')        
             ->where('dtSortie.type_mouvement', '=', 'Sortie')
             ->where('dtSortie.dateMvt', '<', $date1);
    })
    // Utilisez distinct() avant select()
    ->distinct()
    ->select(
        "tvente_stock_service.id",
        'tvente_stock_service.refService',
        'tvente_stock_service.refProduit',
        "tvente_produit.designation as designation",
        "refCategorie",
        "tvente_stock_service.pu",
        "tvente_categorie_produit.designation as Categorie",
        "tvente_stock_service.qte",
        "tvente_stock_service.uniteBase",
        "tvente_stock_service.cmup",
        DB::raw('IFNULL(ROUND(SUM(dtSortie.qteBase * dtSortie.qteMvt), 3), 0) as totalSortie')
    )
    ->where([
        ['tvente_produit.refCategorie', '=', $refCategorie],
        ['tvente_stock_service.refService', '=', $idService]
    ])
    ->groupBy(
        "tvente_stock_service.id",
        'tvente_stock_service.refService',
        'tvente_stock_service.refProduit',
        "tvente_produit.designation",
        "refCategorie",
        "tvente_stock_service.pu",
        "tvente_categorie_produit.designation",
        "tvente_stock_service.qte",
        "tvente_stock_service.uniteBase",
        "tvente_stock_service.cmup"
        )
    ->orderBy("tvente_produit.designation", "asc")
    ->get();

    // ============ LEs Mouvements =========================================================================

        // Récupérer les données de stock, mouvements et ventes en une seule requête 
        $data1 = DB::table('tvente_stock_service')
        ->join('tvente_services', 'tvente_services.id', '=', 'tvente_stock_service.refService')
        ->Join('tvente_produit', 'tvente_produit.id', '=', 'tvente_stock_service.refProduit')
        ->Join('tvente_categorie_produit', 'tvente_categorie_produit.id', '=', 'tvente_produit.refCategorie')
    
        ->leftJoin('tvente_mouvement_stock as mvtEntree', function ($join) use ($date1, $date2, $idService) {
            $join->on('mvtEntree.idStockService', '=', 'tvente_stock_service.id')        
                 ->where('mvtEntree.type_mouvement', '=', 'Entree')
                 ->whereBetween('mvtEntree.dateMvt', [$date1, $date2]);;
        })
    
            // Utilisez distinct() avant select()
            ->distinct()
            ->select(
                "tvente_stock_service.id",
                'tvente_stock_service.refService',
                'tvente_stock_service.refProduit',
                "tvente_produit.designation as designation",
                "refCategorie",
                "tvente_stock_service.pu",
                "tvente_categorie_produit.designation as Categorie",
                "tvente_stock_service.qte",
                "tvente_stock_service.uniteBase",
                "nom_service",
                "qtePivot",
                "unitePivot",
                "tvente_stock_service.cmup",
                "tvente_stock_service.devise",
                "tvente_stock_service.taux",            
                DB::raw('IFNULL(ROUND(SUM(mvtEntree.qteBase * mvtEntree.qteMvt), 3), 0) as stockEntree')
    
            )
            ->where([
                ['tvente_produit.refCategorie', '=', $refCategorie],
                ['tvente_stock_service.refService', '=', $idService]
            ])
            ->groupBy("tvente_stock_service.id",
                'tvente_stock_service.refService',
                'tvente_stock_service.refProduit',
                "tvente_produit.designation",
                "refCategorie",
                "tvente_stock_service.pu",
                "tvente_categorie_produit.designation",
                "tvente_stock_service.qte",
                "tvente_stock_service.uniteBase",
                "nom_service",
                "qtePivot",
                "unitePivot",
                "tvente_stock_service.cmup",
                "tvente_stock_service.devise",
                "tvente_stock_service.taux")
            ->orderBy("tvente_produit.designation", "asc")
            ->get();
    
    //======================================================================
    
        // Récupérer les données de stock, mouvements et ventes en une seule requête 
        $data2 = DB::table('tvente_stock_service')
        ->join('tvente_services', 'tvente_services.id', '=', 'tvente_stock_service.refService')
        ->Join('tvente_produit', 'tvente_produit.id', '=', 'tvente_stock_service.refProduit')
        ->Join('tvente_categorie_produit', 'tvente_categorie_produit.id', '=', 'tvente_produit.refCategorie')
    
        ->leftJoin('tvente_mouvement_stock as mvtSortie', function ($join) use ($date1, $date2, $idService) {
            $join->on('mvtSortie.idStockService', '=', 'tvente_stock_service.id')        
                 ->where('mvtSortie.type_mouvement', '=', 'Sortie')
                 ->whereBetween('mvtSortie.dateMvt', [$date1, $date2]);;
        })
    
            // Utilisez distinct() avant select()
            ->distinct()
            ->select(
                "tvente_stock_service.id",
                'tvente_stock_service.refService',
                'tvente_stock_service.refProduit',
                "tvente_produit.designation as designation",
                "refCategorie",
                "tvente_stock_service.pu",
                "tvente_categorie_produit.designation as Categorie",
                "tvente_stock_service.qte",
                "tvente_stock_service.uniteBase",
                "nom_service",
                "qtePivot",
                "unitePivot",
                "tvente_stock_service.cmup",
                "tvente_stock_service.devise",
                "tvente_stock_service.taux",            
                DB::raw('IFNULL(ROUND(SUM(mvtSortie.qteBase * mvtSortie.qteMvt), 3), 0) as stockSortie'),
    
            )
            ->where([
                ['tvente_produit.refCategorie', '=', $refCategorie],
                ['tvente_stock_service.refService', '=', $idService]
            ])
            ->groupBy("tvente_stock_service.id",
                'tvente_stock_service.refService',
                'tvente_stock_service.refProduit',
                "tvente_produit.designation",
                "refCategorie",
                "tvente_stock_service.pu",
                "tvente_categorie_produit.designation",
                "tvente_stock_service.qte",
                "tvente_stock_service.uniteBase",
                "nom_service",
                "qtePivot",
                "unitePivot",
                "tvente_stock_service.cmup",
                "tvente_stock_service.devise",
                "tvente_stock_service.taux")
            ->orderBy("tvente_produit.designation", "asc")
            ->get();
    

    // Vérifiez que les deux tableaux ont la même longueur
    if ((count($data1) === count($data2)) && (count($data1) === count($data11)) 
    && (count($data1) === count($data22)))
    {
        for ($i = 0; $i < count($data1); $i++) {
            $row11 = $data11[$i];
            $row22 = $data22[$i];
            $row1 = $data1[$i];
            $row2 = $data2[$i];    
            
            $cmup_data = floatval($this->calculerCoutMoyen($row1->id, $date1, $date2));

            $totalSortie = floatval($row22->totalSortie);
            $totalEntree = floatval($row11->totalEntree);

            $stockSortie = floatval($row2->stockSortie);            
            $stockEntree = floatval($row1->stockEntree);

            $totalSI = ((floatval($totalEntree)) - (floatval($totalSortie)));
            $totalGEntree = floatval($stockEntree);
            $totalG = floatval($totalSI) + floatval($stockEntree);
            $TGSortie = floatval($stockSortie);
            $totalSF = floatval($totalG) - floatval($stockSortie);

            $cmup_pivot = floatval($cmup_data) * floatval($row1->qtePivot);
            $totalPT = (floatval($totalSF)/floatval($row1->qtePivot)) * floatval($cmup_pivot);

            // $totalPT = (floatval($totalSF)/floatval($row1->qtePivot)) * floatval($cmup_pivot);
            // $totalPT = floatval($totalSF) * floatval($cmup_data);

            $data_return[] = [
                'id' => $row1->id,
                'Service' => $row1->nom_service,
                'designation' => $row1->designation,
                'Categorie' => $row1->Categorie,
                'SI' => round((floatval($totalSI)/floatval($row1->qtePivot)),2),
                'Entree' => round((floatval($totalGEntree)/floatval($row1->qtePivot)),2),
                'Total' => round((floatval($totalG)/floatval($row1->qtePivot)),2),
                'Sortie' => round((floatval($TGSortie)/floatval($row1->qtePivot)),2),
                'SF' => round((floatval($totalSF)/floatval($row1->qtePivot)),2),
                'PU' => round((floatval(round($cmup_data,2)) * floatval($row1->qtePivot)),2),
                'PT' => round(floatval($totalPT),2),
                'Unité' => $row1->unitePivot
            ];

            }
        } 
        else {
            // Gérer le cas où les tableaux n'ont pas la même longueur
            echo 'Les tableaux ont pas la même longueur.';
        }

        return response()->json($data_return);
        
    }
    else{
    }    
}
function pdf_fiche_stock_vente_service_unite_excel(Request $request)
{

    if ($request->get('date1') && $request->get('date2') && $request->get('idService')) {
        $date1 = $request->get('date1');
        $date2 = $request->get('date2');
        $idService = $request->get('idService');

        $data_return = []; // Initialisation du tableau pour stocker les résultats

        // Récupérer les données de stock, mouvements et ventes en une seule requête 
        $data11 = DB::table('tvente_stock_service')
        ->join('tvente_services', 'tvente_services.id', '=', 'tvente_stock_service.refService')
        ->Join('tvente_produit', 'tvente_produit.id', '=', 'tvente_stock_service.refProduit')
        ->Join('tvente_categorie_produit', 'tvente_categorie_produit.id', '=', 'tvente_produit.refCategorie')

        ->leftJoin('tvente_mouvement_stock as dtEntree', function ($join) use ($date1, $idService) {
        $join->on('dtEntree.idStockService', '=', 'tvente_stock_service.id')        
             ->where('dtEntree.type_mouvement', '=', 'Entree')
             ->where('dtEntree.dateMvt', '<', $date1);
        })

        // Utilisez distinct() avant select()
        ->distinct()
        ->select(
            "tvente_stock_service.id",
            'tvente_stock_service.refService',
            'tvente_stock_service.refProduit',
            "tvente_produit.designation as designation",
            "refCategorie",
            "tvente_stock_service.pu",
            "tvente_categorie_produit.designation as Categorie",
            "tvente_stock_service.qte",
            "tvente_stock_service.uniteBase","nom_service","qtePivot","unitePivot",
            "tvente_stock_service.cmup",
            "tvente_stock_service.devise",
            "tvente_stock_service.taux",            
            DB::raw('IFNULL(ROUND(SUM(dtEntree.qteBase * dtEntree.qteMvt), 3), 0) as totalEntree'),

        )
        ->where([
            ['tvente_stock_service.refService', '=', $idService]
        ])
        ->groupBy("tvente_stock_service.id",
            'tvente_stock_service.refService',
            'tvente_stock_service.refProduit',
            "tvente_produit.designation",
            "refCategorie",
            "tvente_stock_service.pu",
            "tvente_categorie_produit.designation",
            "tvente_stock_service.qte",
            "tvente_stock_service.uniteBase",
            "nom_service","qtePivot","unitePivot",
            "tvente_stock_service.cmup",
            "tvente_stock_service.devise",
            "tvente_stock_service.taux")
        ->orderBy("tvente_produit.designation", "asc")
        ->get();

    $data22 = DB::table('tvente_stock_service')
    ->join('tvente_services', 'tvente_services.id', '=', 'tvente_stock_service.refService')
    ->Join('tvente_produit', 'tvente_produit.id', '=', 'tvente_stock_service.refProduit')
    ->Join('tvente_categorie_produit', 'tvente_categorie_produit.id', '=', 'tvente_produit.refCategorie')

    ->leftJoin('tvente_mouvement_stock as dtSortie', function ($join) use ($date1, $idService) {
        $join->on('dtSortie.idStockService', '=', 'tvente_stock_service.id')        
             ->where('dtSortie.type_mouvement', '=', 'Sortie')
             ->where('dtSortie.dateMvt', '<', $date1);
    })
    // Utilisez distinct() avant select()
    ->distinct()
    ->select(
        "tvente_stock_service.id",
        'tvente_stock_service.refService',
        'tvente_stock_service.refProduit',
        "tvente_produit.designation as designation",
        "refCategorie",
        "tvente_stock_service.pu",
        "tvente_categorie_produit.designation as Categorie",
        "tvente_stock_service.qte",
        "tvente_stock_service.uniteBase",
        "tvente_stock_service.cmup",
        DB::raw('IFNULL(ROUND(SUM(dtSortie.qteBase * dtSortie.qteMvt), 3), 0) as totalSortie')
    )
    ->where([
        ['tvente_stock_service.refService', '=', $idService]
    ])
    ->groupBy("tvente_stock_service.id",
        'tvente_stock_service.refService',
        'tvente_stock_service.refProduit',
        "tvente_produit.designation",
        "refCategorie",
        "tvente_stock_service.pu",
        "tvente_categorie_produit.designation",
        "tvente_stock_service.qte",
        "tvente_stock_service.uniteBase",
        "tvente_stock_service.cmup")
    ->orderBy("tvente_produit.designation", "asc")
    ->get();

    // ============ LEs Mouvements =========================================================================

        // Récupérer les données de stock, mouvements et ventes en une seule requête 
        $data1 = DB::table('tvente_stock_service')
        ->join('tvente_services', 'tvente_services.id', '=', 'tvente_stock_service.refService')
        ->Join('tvente_produit', 'tvente_produit.id', '=', 'tvente_stock_service.refProduit')
        ->Join('tvente_categorie_produit', 'tvente_categorie_produit.id', '=', 'tvente_produit.refCategorie')
    
        ->leftJoin('tvente_mouvement_stock as mvtEntree', function ($join) use ($date1, $date2, $idService) {
            $join->on('mvtEntree.idStockService', '=', 'tvente_stock_service.id')        
                 ->where('mvtEntree.type_mouvement', '=', 'Entree')
                 ->whereBetween('mvtEntree.dateMvt', [$date1, $date2]);;
        })
    
            // Utilisez distinct() avant select()
            ->distinct()
            ->select(
                "tvente_stock_service.id",
                'tvente_stock_service.refService',
                'tvente_stock_service.refProduit',
                "tvente_produit.designation as designation",
                "refCategorie",
                "tvente_stock_service.pu",
                "tvente_categorie_produit.designation as Categorie",
                "tvente_stock_service.qte",
                "tvente_stock_service.uniteBase",
                "nom_service","qtePivot","unitePivot",
                "tvente_stock_service.cmup",
                "tvente_stock_service.devise",
                "tvente_stock_service.taux",            
                DB::raw('IFNULL(ROUND(SUM(mvtEntree.qteBase * mvtEntree.qteMvt), 3), 0) as stockEntree')
    
            )
            ->where([
                ['tvente_stock_service.refService', '=', $idService]
            ])
            ->groupBy("tvente_stock_service.id",
                'tvente_stock_service.refService',
                'tvente_stock_service.refProduit',
                "tvente_produit.designation",
                "refCategorie",
                "tvente_stock_service.pu",
                "tvente_categorie_produit.designation",
                "tvente_stock_service.qte",
                "tvente_stock_service.uniteBase",
                "nom_service","qtePivot","unitePivot",
                "tvente_stock_service.cmup",
                "tvente_stock_service.devise",
                "tvente_stock_service.taux")
            ->orderBy("tvente_produit.designation", "asc")
            ->get();
    
    //======================================================================
    
        // Récupérer les données de stock, mouvements et ventes en une seule requête 
        $data2 = DB::table('tvente_stock_service')
        ->join('tvente_services', 'tvente_services.id', '=', 'tvente_stock_service.refService')
        ->Join('tvente_produit', 'tvente_produit.id', '=', 'tvente_stock_service.refProduit')
        ->Join('tvente_categorie_produit', 'tvente_categorie_produit.id', '=', 'tvente_produit.refCategorie')
    
        ->leftJoin('tvente_mouvement_stock as mvtSortie', function ($join) use ($date1, $date2, $idService) {
            $join->on('mvtSortie.idStockService', '=', 'tvente_stock_service.id')        
                 ->where('mvtSortie.type_mouvement', '=', 'Sortie')
                 ->whereBetween('mvtSortie.dateMvt', [$date1, $date2]);;
        })
    
            // Utilisez distinct() avant select()
            ->distinct()
            ->select(
                "tvente_stock_service.id",
                'tvente_stock_service.refService',
                'tvente_stock_service.refProduit',
                "tvente_produit.designation as designation",
                "refCategorie",
                "tvente_stock_service.pu",
                "tvente_categorie_produit.designation as Categorie",
                "tvente_stock_service.qte",
                "tvente_stock_service.uniteBase",
                "nom_service","qtePivot","unitePivot",
                "tvente_stock_service.cmup",
                "tvente_stock_service.devise",
                "tvente_stock_service.taux",            
                DB::raw('IFNULL(ROUND(SUM(mvtSortie.qteBase * mvtSortie.qteMvt), 3), 0) as stockSortie'),
    
            )
            ->where([
                ['tvente_stock_service.refService', '=', $idService]
            ])
            ->groupBy("tvente_stock_service.id",
                'tvente_stock_service.refService',
                'tvente_stock_service.refProduit',
                "tvente_produit.designation",
                "refCategorie",
                "tvente_stock_service.pu",
                "tvente_categorie_produit.designation",
                "tvente_stock_service.qte",
                "tvente_stock_service.uniteBase",
                "nom_service","qtePivot","unitePivot",
                "tvente_stock_service.cmup",
                "tvente_stock_service.devise",
                "tvente_stock_service.taux")
            ->orderBy("tvente_produit.designation", "asc")
            ->get();
    

    // Vérifiez que les deux tableaux ont la même longueur
    if ((count($data1) === count($data2)) && (count($data1) === count($data11)) 
    && (count($data1) === count($data22)))
    {
        for ($i = 0; $i < count($data1); $i++) {
            $row11 = $data11[$i];
            $row22 = $data22[$i];
            $row1 = $data1[$i];
            $row2 = $data2[$i];            

            $cmup_data = floatval($this->calculerCoutMoyen($row1->id, $date1, $date2));

            $totalSortie = floatval($row22->totalSortie);
            $totalEntree = floatval($row11->totalEntree);

            $stockSortie = floatval($row2->stockSortie);            
            $stockEntree = floatval($row1->stockEntree);

            $totalSI = ((floatval($totalEntree)) - (floatval($totalSortie)));
            $totalGEntree = floatval($stockEntree);
            $totalG = floatval($totalSI) + floatval($stockEntree);
            $TGSortie = floatval($stockSortie);
            $totalSF = floatval($totalG) - floatval($stockSortie);
            $cmup_pivot = floatval($cmup_data) * floatval($row1->qtePivot);
            $totalPT = (floatval($totalSF)/floatval($row1->qtePivot)) * floatval($cmup_pivot);
            // $totalPT = floatval($totalSF) * floatval($cmup_data);

            $data_return[] = [
                'id' => $row1->id,
                'Service' => $row1->nom_service,
                'designation' => $row1->designation,
                'Categorie' => $row1->Categorie,
                'SI' => round((floatval($totalSI)/floatval($row1->qtePivot)),2),
                'Entree' => round((floatval($totalGEntree)/floatval($row1->qtePivot)),2),
                'Total' => round((floatval($totalG)/floatval($row1->qtePivot)),2),
                'Sortie' => round((floatval($TGSortie)/floatval($row1->qtePivot)),2),
                'SF' => round((floatval($totalSF)/floatval($row1->qtePivot)),2),
                'PU' => round((floatval(round($cmup_data,2)) * floatval($row1->qtePivot)),2),
                'PT' => round(floatval($totalPT),2),
                'Unité' => $row1->unitePivot
            ];

            }
        } 
        else {
            // Gérer le cas où les tableaux n'ont pas la même longueur
            echo 'Les tableaux ont pas la même longueur.';
        }

        return response()->json($data_return);

    }
    else
    {
        return response()->json(['error' => 'Invalid parameters'], 400);
    }
    

}

//==========================================================================================================
//==================== GESTION DES FOURNISSEURS ===========================================================

function pdf_detail_commande_fournisseur_excel(Request $request)
{
   if ($request->get('date1') && $request->get('date2')) {
        $date1 = $request->get('date1');
        $date2 = $request->get('date2');

        $data_return = []; // Initialisation du tableau pour stocker les résultats

        // Récupérer les données de stock, mouvements et ventes en une seule requête 
        $data = DB::table('tvente_detail_requisition')
        ->join('tfin_ssouscompte as compteachat','compteachat.id','=','tvente_detail_requisition.compte_achat')
        ->join('tfin_ssouscompte as compteproduit','compteproduit.id','=','tvente_detail_requisition.compte_produit')
        ->join('tvente_produit','tvente_produit.id','=','tvente_detail_requisition.refProduit')
        ->join('tvente_categorie_produit','tvente_categorie_produit.id','=','tvente_produit.refCategorie')
        ->join('tvente_grande_categorie_produit','tvente_grande_categorie_produit.id','=','tvente_categorie_produit.id_groupe_categorie')
        ->join('tvente_entete_requisition','tvente_entete_requisition.id','=','tvente_detail_requisition.refEnteteCmd')
        ->join('tvente_fournisseur','tvente_fournisseur.id','=','tvente_entete_requisition.refFournisseur')
        ->select('tvente_detail_requisition.id','refEnteteCmd','refProduit','tvente_detail_requisition.compte_achat',
        'tvente_detail_requisition.compte_produit','puCmd','qteCmd','uniteCmd','tvente_detail_requisition.puBase',
        'tvente_detail_requisition.qteBase','tvente_detail_requisition.uniteBase','tvente_detail_requisition.devise',
        'tvente_detail_requisition.taux','montanttva','montantreduction','tvente_detail_requisition.active',
        'tvente_detail_requisition.author','tvente_detail_requisition.refUser','tvente_detail_requisition.created_at'
        ,"tvente_produit.designation as designation",'refCategorie','pu','qte',
        'cmup','Oldcode','Newcode','tvaapplique','estvendable',"tvente_categorie_produit.designation as Categorie"
        ,'compteachat.refSousCompte as refSousCompteAchat','compteachat.nom_ssouscompte as nom_ssouscompteAchat',
        'compteachat.numero_ssouscompte as numero_ssouscompteAchat','designation_groupe'
        ,'compteproduit.refSousCompte as refSousCompteProduit','compteproduit.nom_ssouscompte as nom_ssouscompteProduit',
        'compteproduit.numero_ssouscompte as numero_ssouscompteProduit','noms','contact','mail','adresse','dateCmd')
        ->selectRaw('(qteCmd*puCmd) as PTCmd')
        ->selectRaw('(qteBase*puBase) as PTBase')
        ->selectRaw('((qteCmd*puCmd)/tvente_detail_requisition.taux) as PTCmdFC')
        ->selectRaw('((qteBase*puBase)/tvente_detail_requisition.taux) as PTBaseFC')
        ->selectRaw('CONCAT("BE",YEAR(dateCmd),"",MONTH(dateCmd),"00",refEnteteCmd) as codeFacture')
        ->where([
            ['dateCmd','>=', $date1],
            ['dateCmd','<=', $date2]
        ])
        ->orderBy("tvente_detail_requisition.created_at", "asc")
        ->get();   

    // Vérifiez que les deux tableaux ont la même longueur
    if ($data)
    {
        for ($i = 0; $i < count($data); $i++) {
            $row1 = $data[$i];

            $data_return[] = [
                'N°COM.' => $row1->refEnteteCmd,
                'FOUNISSEUR' => $row1->noms,
                'DATE COM.' => $row1->dateCmd,
                'PRODUIT' => $row1->designation,                
                'QTE' => $row1->qteCmd,
                'PU($)' =>$row1->puCmd,
                'PT($)' => $row1->PTCmd,
                'CATEGORIE' => $row1->Categorie,
                'G.CATEGORIE' => $row1->designation_groupe                
            ];

        }
    } 
    else {
        // Gérer le cas où les tableaux n'ont pas la même longueur
        echo 'Les tableaux ont pas la même longueur.';
    }

     return response()->json($data_return);

    }

    return response()->json(['error' => 'Invalid parameters'], 400);
}


function pdf_entete_commande_fournisseur_excel(Request $request)
{
   if ($request->get('date1') && $request->get('date2')) {
        $date1 = $request->get('date1');
        $date2 = $request->get('date2');

        $data_return = []; // Initialisation du tableau pour stocker les résultats

        // Récupérer les données de stock, mouvements et ventes en une seule requête 
        $data = DB::table('tvente_entete_requisition')
        ->join('tvente_module','tvente_module.id','=','tvente_entete_requisition.module_id')
        ->join('tvente_services','tvente_services.id','=','tvente_entete_requisition.refService')
        ->join('tvente_fournisseur','tvente_fournisseur.id','=','tvente_entete_requisition.refFournisseur')
        ->join('tvente_categorie_fournisseur','tvente_categorie_fournisseur.id','=','tvente_fournisseur.refCategorieFss')
        ->join('tfin_ssouscompte','tfin_ssouscompte.id','=','tvente_categorie_fournisseur.compte_fss_bl')
        ->join('tfin_souscompte','tfin_souscompte.id','=','tfin_ssouscompte.refSousCompte')
        ->join('tfin_compte','tfin_compte.id','=','tfin_souscompte.refCompte')
        ->join('tfin_classe','tfin_classe.id','=','tfin_compte.refClasse')
        ->join('tfin_typecompte','tfin_typecompte.id','=','tfin_compte.refTypecompte')
        ->join('tfin_typeposition','tfin_typeposition.id','=','tfin_compte.refPosition')
        ->select('tvente_entete_requisition.id','tvente_entete_requisition.code','refFournisseur','module_id',
        'refService','dateCmd','libelle','cloture',
        'niveau1','niveaumax','tvente_entete_requisition.active','montant','paie','tvente_entete_requisition.author','tvente_entete_requisition.refUser',
        'tvente_entete_requisition.created_at',"tvente_fournisseur.noms","tvente_fournisseur.contact",
        "tvente_fournisseur.mail","tvente_fournisseur.adresse",'refCategorieFss', "tvente_categorie_fournisseur.nom_categoriefss",
        "compte_fss_bl",'refSousCompte','nom_ssouscompte','numero_ssouscompte','nom_souscompte','numero_souscompte','refCompte','nom_compte',
        'numero_compte','refClasse','refTypecompte','refPosition','nom_classe','numero_classe','nom_typeposition',"nom_typecompte"
        ,"tvente_module.nom_module","tvente_services.nom_service")
        ->selectRaw('CONCAT("F",YEAR(dateCmd),"",MONTH(dateCmd),"00",tvente_entete_requisition.id) as codeFacture')
        ->selectRaw(' IFNULL(montant,0) as totalFacture')
        ->selectRaw(' IFNULL(paie,0) as totalPaie')
        ->selectRaw('(IFNULL((IFNULL(montant,0) - IFNULL(paie,0)),0)) as RestePaie')
        ->selectRaw('TIMESTAMPDIFF(DAY, dateCmd, CURDATE()) as nombreJr')
        ->where([
            ['dateCmd','>=', $date1],
            ['dateCmd','<=', $date2]
        ])
        ->orderBy("tvente_entete_requisition.created_at", "asc")
        ->get();   

    // Vérifiez que les deux tableaux ont la même longueur
    if ($data)
    {
        for ($i = 0; $i < count($data); $i++) {
            $row1 = $data[$i];

            $data_return[] = [
                'N°FACT.' => $row1->id,
                'FOUNISSEUR' => $row1->noms,
                'DATE FACTURE.' => $row1->dateCmd,
                'MONTANT DU($)' => $row1->totalFacture,                
                'MONTANT PAIE($)' => $row1->totalPaie,
                'RESTE($)' => $row1->RestePaie,
                'OBSERV.(J)' => $row1->nombreJr             
            ];

        }
    } 
    else {
        // Gérer le cas où les tableaux n'ont pas la même longueur
        echo 'Les tableaux ont pas la même longueur.';
    }

     return response()->json($data_return);

    }

    return response()->json(['error' => 'Invalid parameters'], 400);
}




function pdf_detail_vente_service_excel(Request $request)
{

   if ($request->get('date1') && $request->get('date2') && $request->get('idService')) {
        $date1 = $request->get('date1');
        $date2 = $request->get('date2');
        $idService = $request->get('idService');

        $data_return = []; // Initialisation du tableau pour stocker les résultats

        // Récupérer les données de stock, mouvements et ventes en une seule requête 
        $data = DB::table('tvente_detail_vente')
        ->join('tvente_produit','tvente_produit.id','=','tvente_detail_vente.refProduit')
        ->join('tvente_categorie_produit','tvente_categorie_produit.id','=','tvente_produit.refCategorie')
    
        ->join('tvente_entete_vente','tvente_entete_vente.id','=','tvente_detail_vente.refEnteteVente')        
        ->join('tvente_module','tvente_module.id','=','tvente_entete_vente.module_id')
        ->join('tvente_services','tvente_services.id','=','tvente_entete_vente.refService')
        ->join('tvente_client','tvente_client.id','=','tvente_entete_vente.refClient')
        ->join('tvente_categorie_client','tvente_categorie_client.id','=','tvente_client.refCategieClient')  
        // ->join('tfin_ssouscompte as compteclient','compteclient.id','=','tvente_categorie_client.compte_client')
    
        // ->join('tfin_ssouscompte as comptevente','comptevente.id','=','tvente_categorie_produit.compte_vente')
        // ->join('tfin_ssouscompte as comptevariation','comptevariation.id','=','tvente_categorie_produit.compte_variationstock')
        // ->join('tfin_ssouscompte as compteperte','compteperte.id','=','tvente_categorie_produit.compte_perte')
        // ->join('tfin_ssouscompte as compteproduit','compteproduit.id','=','tvente_categorie_produit.compte_produit')
        // ->join('tfin_ssouscompte as comptedestockage','comptedestockage.id','=','tvente_categorie_produit.compte_destockage')
      
    
        ->select('tvente_detail_vente.id','refEnteteVente','refProduit','tvente_detail_vente.compte_vente',
        'tvente_detail_vente.compte_variationstock','tvente_detail_vente.compte_perte','tvente_detail_vente.compte_produit',
        'tvente_detail_vente.compte_destockage','puVente','qteVente','uniteVente','puBase','qteBase',
        'tvente_detail_vente.uniteBase','cmupVente','tvente_detail_vente.devise','tvente_detail_vente.taux',
        'montanttva','montantreduction',
        'tvente_detail_vente.active','tvente_detail_vente.author','tvente_detail_vente.refUser',
        'tvente_detail_vente.created_at','idStockService',
        //Produit
        'tvente_produit.designation','tvente_produit.refCategorie','tvente_produit.refUniteBase',
        'tvente_produit.pu','tvente_produit.qte','tvente_produit.cmup','tvente_produit.taux',
        'tvente_produit.Oldcode','tvente_produit.Newcode','tvente_produit.tvaapplique',
        'tvente_produit.estvendable','tvente_categorie_produit.designation as Categorie',
        //client 
        'noms','sexe','contact','mail','adresse','pieceidentite','numeroPiece','dateLivrePiece',
        'lieulivraisonCarte','nationnalite','datenaissance','lieunaissance','profession','occupation',
        'nombreEnfant','dateArriverGoma','arriverPar','refCategieClient','photo','slug',
        "tvente_categorie_client.designation as CategorieClient","compte_client",
        // 'compteclient.refSousCompte','compteclient.nom_ssouscompte','compteclient.numero_ssouscompte',
        //ente vente
        'nom_service', "tvente_module.nom_module",'tvente_entete_vente.code','refClient','refService','refReservation','module_id',
        'dateVente','libelle','tvente_entete_vente.montant','tvente_entete_vente.paie','reduction','totaltva',
        //compte produit
        // 'comptevente.refSousCompte as refSousCompteVente','comptevente.nom_ssouscompte as nom_ssouscompteVente',
        // 'comptevente.numero_ssouscompte as numero_ssouscompteVente'
        // ,'comptevariation.refSousCompte as refSousCompteVariation','comptevariation.nom_ssouscompte as nom_ssouscompteVariation',
        // 'comptevariation.numero_ssouscompte as numero_ssouscompteVariation'
        // ,'compteperte.refSousCompte as refSousComptePerte','compteperte.nom_ssouscompte as nom_ssouscomptePerte',
        // 'compteperte.numero_ssouscompte as numero_ssouscomptePerte'
        // ,'compteproduit.refSousCompte as refSousCompteProduit','compteproduit.nom_ssouscompte as nom_ssouscompteProduit',
        // 'compteproduit.numero_ssouscompte as numero_ssouscompteProduit'
        // ,'comptedestockage.refSousCompte as refSousCompteDestockage','comptedestockage.nom_ssouscompte as nom_ssouscompteDestockage',
        // 'comptedestockage.numero_ssouscompte as numero_ssouscompteDestockage',
        'priseencharge')
       ->selectRaw('ROUND(((qteVente*puVente) - montantreduction),2) as PTVente')
       ->selectRaw('ROUND(((qteVente*puVente) - montantreduction + montanttva),2) as PTVenteTVA')
       ->selectRaw('ROUND((IFNULL(montant,0)),2) as totalFacture')
       ->selectRaw('ROUND((montanttva),2) as TotalTVA')
       ->selectRaw('ROUND((((IFNULL(montant,0)) - montantreduction)+(montanttva)),2) as PTTTC')
       ->selectRaw('((qteVente*puVente)/tvente_detail_vente.taux) as PTVenteFC')
       ->selectRaw('(qteBase*puBase) as PTBase')
       ->selectRaw('IFNULL(paie,0) as totalPaie')
       ->selectRaw('(IFNULL(montant,0)-IFNULL(paie,0)) as RestePaie')
        ->selectRaw('CONCAT("S",YEAR(dateVente),"",MONTH(dateVente),"00",refEnteteVente) as codeFacture')
        ->where([
            ['dateVente','>=', $date1],
            ['dateVente','<=', $date2],
            ['tvente_services.id','=', $idService]
        ])
        ->orderBy("tvente_detail_vente.created_at", "asc")    
        ->get();   

    // Vérifiez que les deux tableaux ont la même longueur
    if ($data)
    {
        for ($i = 0; $i < count($data); $i++) {
            $row1 = $data[$i];

            $data_return[] = [
                'N°FACT.' => $row1->codeFacture,
                'CLIENT' => $row1->noms,
                'DATE FACTURE.' => $row1->dateVente,
                'CATEGORIE' => $row1->Categorie,
                'PRODUIT' => $row1->designation,
                'UNITE' => $row1->uniteVente,
                'QTE_VENTE' => $row1->qteVente,
                'PU_VENTE' => $row1->puVente,
                'PT_VENTE' => $row1->PTVente,
                'TVA' => $row1->montanttva,                
                'PT_TVA' => $row1->PTVenteTVA, 
                'CMUP' => $row1->cmupVente ,               
                'DEVISE' => $row1->devise 
            ];

            //cmupVente

        }
    } 
    else {
        // Gérer le cas où les tableaux n'ont pas la même longueur
        echo 'Les tableaux ont pas la même longueur.';
    }

     return response()->json($data_return);

    }

    return response()->json(['error' => 'Invalid parameters'], 400);
}




//======== RAPPORTS DES ENTETES DES FACTURES ET DES CREDITS ==============================================
//========================================================================================================



public function fetch_rapport_entete_facture_client_date_etat_facture(Request $request)
{
    //refDepartement

    if ($request->get('date1') && $request->get('date2') && $request->get('etat_facture')) {
        // code...
        $date1 = $request->get('date1');
        $date2 = $request->get('date2');
        $etat_facture = $request->get('etat_facture');
        
        $html = $this->printRapportEnteteFactureClient_EtatFacture($date1, $date2,$etat_facture);
        $pdf = \App::make('dompdf.wrapper');
        // echo($html);
        // $pdf->loadHTML($html);
        $pdf->loadHTML($html)->setPaper('a4', 'landscape');
        return $pdf->stream();            

    } else {
        // code...
    }  
    
}
function printRapportEnteteFactureClient_EtatFacture($date1, $date2,$etat_facture)
{

         //Info Entreprise
        $nomEse='';
        $adresseEse='';
        $Tel1Ese='';
        $Tel2Ese='';
        $siteEse='';
        $emailEse='';
        $idNatEse='';
        $numImpotEse='';
        $rccEse='';
        $siege='';
        $busnessName='';
        $pic='';
        $pic2 = $this->displayImg("fichier", 'logo.png');
        $logo='';

        $data1 = DB::table('entreprises')
        ->join('secteurs','secteurs.id','=','entreprises.idsecteur')
        ->join('forme_juridiques','forme_juridiques.id','=','entreprises.idforme')

        ->join('pays','pays.id','=','entreprises.idPays')
        ->join('provinces','provinces.id','=','entreprises.idProvince')
        ->join('users','users.id','=','entreprises.ceo')        
        ->select('entreprises.id as id','entreprises.id as idEntreprise',
        'entreprises.ceo','entreprises.nomEntreprise','entreprises.descriptionEntreprise',
        'entreprises.emailEntreprise','entreprises.adresseEntreprise',
        'entreprises.telephoneEntreprise','entreprises.solutionEntreprise','entreprises.idsecteur',
        'entreprises.idforme','entreprises.etat',
        'entreprises.idPays','entreprises.idProvince','entreprises.edition','entreprises.facebook',
        'entreprises.linkedin','entreprises.twitter','entreprises.siteweb','entreprises.rccm',
        'entreprises.invPersonnel','entreprises.invHub','entreprises.invRecherche',
        'entreprises.chiffreAffaire','entreprises.nbremploye','entreprises.slug','entreprises.logo',
            //forme
            'forme_juridiques.nomForme','secteurs.nomSecteur',
            //users
            'users.name','users.email','users.avatar','users.telephone','users.adresse',
            //
            'provinces.nomProvince','pays.nomPays', 'entreprises.created_at')
        ->first();
        if ($data1) 
        {                                
            $nomEse=$data1->nomEntreprise;
            $adresseEse=$data1->adresseEntreprise;
            $Tel1Ese=$data1->telephoneEntreprise;
            $Tel2Ese=$data1->telephone;
            $siteEse=$data1->siteweb;
            $emailEse=$data1->emailEntreprise;
            $idNatEse=$data1->rccm;
            $numImpotEse=$data1->rccm;
            $busnessName=$data1->nomSecteur;
            $rccmEse=$data1->rccm;
            $pic = $this->displayImg("fichier", 'logo.png');
            $siege=$data1->nomForme;         
        }


         $totalFact=0;
         $totalPaie=0;
         $totalReste=0;
                 
         //
         $data2 = DB::table('tvente_entete_vente') 
         ->selectRaw('ROUND(SUM( IFNULL(montant,0)),2) as TotalFacture')
         ->selectRaw('ROUND(SUM( IFNULL(paie,0)),2) as TotalPaie')
         ->selectRaw('ROUND(SUM(IFNULL((IFNULL(montant,0) - IFNULL(reduction,0) - IFNULL(paie,0)),0)),2) as TotalReste')
         ->where([
            ['dateVente','>=', $date1],
            ['dateVente','<=', $date2],
            ['tvente_entete_vente.etat_facture','=', $etat_facture]
        ])    
         ->first(); 
         $output='';
         if ($data2) 
         {                                
            $totalFact=$data2->TotalFacture;
            $totalPaie=$data2->TotalPaie;
            $totalReste=$data2->TotalReste;                           
         }

         $nom_departement= $etat_facture;
         $code_departement= '-';

        //  $data3= DB::table('tagent') 
        //  ->select("tagent.id","matricule_agent","noms_agent","sexe_agent")
        //  ->where([
        //     ['tagent.id','=', $serveur_id]
        // ])      
        // ->first();      
        // $output='';
        // if ($data3) 
        // {
        //     $code_departement = $data3->noms_agent;              
        // }
           

        $output='<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Transitional//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd">
        <!-- saved from url=(0016)http://localhost -->
        <html>
        <head>
            <title>rpt_RapportSynthese</title>
            <meta HTTP-EQUIV="Content-Type" CONTENT="text/html; charset=utf-8"/>
            <style type="text/css">
                .csB6F858D0 {color:#000000;background-color:#D6E5F4;border-left-style: none;border-top-style: none;border-right-style: none;border-bottom-style: none;font-family:Times New Roman; font-size:24px; font-weight:bold; font-style:normal; padding-left:2px;padding-right:2px;}
                .cs9FE9304F {color:#000000;background-color:#E0E0E0;border-left-style: none;border-top:#000000 1px solid;border-right:#000000 1px solid;border-bottom:#000000 1px solid;font-family:Times New Roman; font-size:13px; font-weight:bold; font-style:normal; }
                .csEAC52FCD {color:#000000;background-color:#E0E0E0;border-left-style: none;border-top:#000000 1px solid;border-right-style: none;border-bottom:#000000 1px solid;font-family:Times New Roman; font-size:13px; font-weight:bold; font-style:normal; }
                .cs56F73198 {color:#000000;background-color:transparent;border-left:#000000 1px solid;border-top:#000000 1px solid;border-right:#000000 1px solid;border-bottom:#000000 1px solid;font-family:Times New Roman; font-size:16px; font-weight:normal; font-style:normal; padding-left:2px;}
                .cs6E02D7D2 {color:#000000;background-color:transparent;border-left-style: none;border-top:#000000 1px solid;border-right:#000000 1px solid;border-bottom:#000000 1px solid;font-family:Times New Roman; font-size:14px; font-weight:normal; font-style:normal; }
                .cs6C28398D {color:#000000;background-color:transparent;border-left-style: none;border-top:#000000 1px solid;border-right-style: none;border-bottom:#000000 1px solid;font-family:Times New Roman; font-size:14px; font-weight:normal; font-style:normal; }
                .cs612ED82F {color:#000000;background-color:transparent;border-left-style: none;border-top-style: none;border-right-style: none;border-bottom-style: none;font-family:Times New Roman; font-size:12px; font-weight:bold; font-style:normal; padding-left:2px;}
                .csFFC1C457 {color:#000000;background-color:transparent;border-left-style: none;border-top-style: none;border-right-style: none;border-bottom-style: none;font-family:Times New Roman; font-size:12px; font-weight:normal; font-style:normal; padding-left:2px;}
                .cs101A94F7 {color:#000000;background-color:transparent;border-left-style: none;border-top-style: none;border-right-style: none;border-bottom-style: none;font-family:Times New Roman; font-size:13px; font-weight:normal; font-style:normal; }
                .csCE72709D {color:#000000;background-color:transparent;border-left-style: none;border-top-style: none;border-right-style: none;border-bottom-style: none;font-family:Times New Roman; font-size:14px; font-weight:bold; font-style:normal; padding-left:2px;}
                .cs12FE94AA {color:#000000;background-color:transparent;border-left-style: none;border-top-style: none;border-right-style: none;border-bottom-style: none;font-family:Times New Roman; font-size:14px; font-weight:normal; font-style:normal; padding-left:2px;}
                .csFBB219FE {color:#000000;background-color:transparent;border-left-style: none;border-top-style: none;border-right-style: none;border-bottom-style: none;font-family:Times New Roman; font-size:18px; font-weight:bold; font-style:normal; padding-left:2px;}
                .cs739196BC {color:#5C5C5C;background-color:transparent;border-left-style: none;border-top-style: none;border-right-style: none;border-bottom-style: none;font-family:Segoe UI; font-size:11px; font-weight:normal; font-style:normal; }
                .csF7D3565D {height:0px;width:0px;overflow:hidden;font-size:0px;line-height:0px;}
            </style>
        </head>
        <body leftMargin=10 topMargin=10 rightMargin=10 bottomMargin=10 style="background-color:#FFFFFF">
        <table cellpadding="0" cellspacing="0" border="0" style="border-width:0px;empty-cells:show;width:909px;height:383px;position:relative;">
            <tr>
                <td style="width:0px;height:0px;"></td>
                <td style="height:0px;width:10px;"></td>
                <td style="height:0px;width:102px;"></td>
                <td style="height:0px;width:36px;"></td>
                <td style="height:0px;width:71px;"></td>
                <td style="height:0px;width:124px;"></td>
                <td style="height:0px;width:66px;"></td>
                <td style="height:0px;width:42px;"></td>
                <td style="height:0px;width:129px;"></td>
                <td style="height:0px;width:114px;"></td>
                <td style="height:0px;width:40px;"></td>
                <td style="height:0px;width:43px;"></td>
                <td style="height:0px;width:30px;"></td>
                <td style="height:0px;width:102px;"></td>
            </tr>
            <tr style="vertical-align:top;">
                <td style="width:0px;height:23px;"></td>
                <td></td>
                <td></td>
                <td></td>
                <td></td>
                <td></td>
                <td></td>
                <td></td>
                <td></td>
            </tr>
            <tr style="vertical-align:top;">
                <td style="width:0px;height:9px;"></td>
                <td></td>
                <td></td>
                <td></td>
                <td></td>
                <td></td>
                <td></td>
                <td></td>
                <td></td>
                <td></td>
                <td></td>
                <td></td>
                <td></td>
                <td></td>
            </tr>
            <tr style="vertical-align:top;">
                <td style="width:0px;height:23px;"></td>
                <td></td>
                <td class="csFBB219FE" colspan="8" style="width:682px;height:23px;line-height:21px;text-align:left;vertical-align:middle;"><nobr>'.$nomEse.'</nobr></td>
                <td></td>
                <td class="cs101A94F7" colspan="3" rowspan="7" style="width:175px;height:144px;text-align:left;vertical-align:top;"><div style="overflow:hidden;width:175px;height:144px;">
                   <img alt="" src="'.$pic2.'" style="width:175px;height:144px;" /></div>
                </td>
            </tr>
            <tr style="vertical-align:top;">
                <td style="width:0px;height:22px;"></td>
                <td></td>
                <td class="csCE72709D" colspan="8" style="width:682px;height:22px;line-height:15px;text-align:left;vertical-align:middle;"><nobr>'.$busnessName.'</nobr></td>
                <td></td>
            </tr>
            <tr style="vertical-align:top;">
                <td style="width:0px;height:22px;"></td>
                <td></td>
                <td class="csCE72709D" colspan="8" style="width:682px;height:22px;line-height:15px;text-align:left;vertical-align:middle;"><nobr>RCCM'.$rccEse.'.&nbsp;ID-NAT.'.$idNatEse.'</nobr></td>
                <td></td>
            </tr>
            <tr style="vertical-align:top;">
                <td style="width:0px;height:22px;"></td>
                <td></td>
                <td class="csFFC1C457" colspan="8" style="width:682px;height:22px;line-height:13px;text-align:left;vertical-align:middle;">'.$adresseEse.'</td>
                <td></td>
            </tr>
            <tr style="vertical-align:top;">
                <td style="width:0px;height:22px;"></td>
                <td></td>
                <td class="csFFC1C457" colspan="8" style="width:682px;height:22px;line-height:13px;text-align:left;vertical-align:middle;"><nobr>Email&nbsp;:&nbsp;'.$emailEse.'</nobr></td>
                <td></td>
            </tr>
            <tr style="vertical-align:top;">
                <td style="width:0px;height:22px;"></td>
                <td></td>
                <td class="csFFC1C457" colspan="8" style="width:682px;height:22px;line-height:13px;text-align:left;vertical-align:middle;"><nobr>Site&nbsp;web&nbsp;:&nbsp;'.$siteEse.'</nobr></td>
                <td></td>
            </tr>
            <tr style="vertical-align:top;">
                <td style="width:0px;height:11px;"></td>
                <td></td>
                <td class="cs612ED82F" colspan="8" rowspan="2" style="width:682px;height:23px;line-height:13px;text-align:left;vertical-align:middle;"><nobr>T&#233;l&#233;phone&nbsp;:&nbsp;'.$Tel1Ese.'&nbsp;&nbsp;24h/24</nobr></td>
                <td></td>
            </tr>
            <tr style="vertical-align:top;">
                <td style="width:0px;height:12px;"></td>
                <td></td>
                <td></td>
                <td></td>
                <td></td>
                <td></td>
            </tr>
            <tr style="vertical-align:top;">
                <td style="width:0px;height:8px;"></td>
                <td></td>
                <td></td>
                <td></td>
                <td></td>
                <td></td>
                <td></td>
                <td></td>
                <td></td>
                <td></td>
                <td></td>
                <td></td>
                <td></td>
                <td></td>
            </tr>
            <tr style="vertical-align:top;">
                <td style="width:0px;height:32px;"></td>
                <td></td>
                <td></td>
                <td></td>
                <td class="csB6F858D0" colspan="8" style="width:625px;height:32px;line-height:28px;text-align:center;vertical-align:middle;"><nobr>RAPPORT DES FACTURES/ETAT FACTURE</nobr></td>
                <td></td>
                <td></td>
            </tr>
            <tr style="vertical-align:top;">
                <td style="width:0px;height:19px;"></td>
                <td></td>
                <td></td>
                <td></td>
                <td></td>
                <td></td>
                <td></td>
                <td></td>
                <td></td>
                <td></td>
                <td></td>
                <td></td>
                <td></td>
                <td></td>
            </tr>
            <tr style="vertical-align:top;">
                <td style="width:0px;height:23px;"></td>
                <td></td>
                <td class="cs56F73198" colspan="4" style="width:329px;height:21px;line-height:18px;text-align:left;vertical-align:top;"><nobr>&nbsp;PERIODE&nbsp;:&nbsp;&nbsp;Du&nbsp;&nbsp;'.$date1.'&nbsp;&nbsp;au&nbsp;'.$date2.'</nobr></td>
                <td class="cs56F73198" colspan="8" style="width:562px;height:21px;line-height:18px;text-align:left;vertical-align:top;"><nobr>'.$nom_departement.'</nobr></td>
            </tr>
            <tr style="vertical-align:top;">
                <td style="width:0px;height:9px;"></td>
                <td></td>
                <td></td>
                <td></td>
                <td></td>
                <td></td>
                <td></td>
                <td></td>
                <td></td>
                <td></td>
                <td></td>
                <td></td>
                <td></td>
                <td></td>
            </tr>
            <tr style="vertical-align:top;">
                <td style="width:0px;height:24px;"></td>
                <td></td>
                <td class="cs9FE9304F" style="width:101px;height:22px;line-height:15px;text-align:center;vertical-align:middle;"><nobr>N&#176;&nbsp;FACTURE</nobr></td>
                <td class="cs9FE9304F" colspan="3" style="width:230px;height:22px;line-height:15px;text-align:center;vertical-align:middle;"><nobr>CLIENT</nobr></td>
                <td class="cs9FE9304F" colspan="2" style="width:107px;height:22px;line-height:15px;text-align:center;vertical-align:middle;"><nobr>DATE&nbsp;FACTURE</nobr></td>
                <td class="cs9FE9304F" style="width:128px;height:22px;line-height:15px;text-align:center;vertical-align:middle;"><nobr>TOTAL&nbsp;FACTURE($)</nobr></td>
                <td class="cs9FE9304F" style="width:113px;height:22px;line-height:15px;text-align:center;vertical-align:middle;"><nobr>TOTAL&nbsp;PAIE($)</nobr></td>
                <td class="cs9FE9304F" colspan="3" style="width:112px;height:22px;line-height:15px;text-align:center;vertical-align:middle;"><nobr>RESTE($)</nobr></td>
                <td class="csEAC52FCD" style="width:102px;height:22px;line-height:15px;text-align:center;vertical-align:middle;"><nobr>OBS</nobr></td>
            </tr>
            ';

            $output .= $this->showDetailFacturationClient_EtatFacture($date1,$date2,$etat_facture); 

            $output.='
            <tr style="vertical-align:top;">
                <td style="width:0px;height:24px;"></td>
                <td></td>
                <td class="cs9FE9304F" colspan="6" style="width:440px;height:22px;line-height:15px;text-align:center;vertical-align:middle;"><nobr>TOTAL&nbsp;($)&nbsp;:</nobr></td>
                <td class="cs9FE9304F" style="width:128px;height:22px;line-height:15px;text-align:center;vertical-align:middle;">'.$totalFact.'$</td>
                <td class="cs9FE9304F" style="width:113px;height:22px;line-height:15px;text-align:center;vertical-align:middle;">'.$totalPaie.'$</td>
                <td class="cs9FE9304F" colspan="3" style="width:112px;height:22px;line-height:15px;text-align:center;vertical-align:middle;">'.$totalReste.'$</td>
                <td class="csEAC52FCD" style="width:102px;height:22px;"><!--[if lte IE 7]><div class="csF7D3565D"></div><![endif]--></td>
            </tr>
            <tr style="vertical-align:top;">
                <td style="width:0px;height:10px;"></td>
                <td></td>
                <td></td>
                <td></td>
                <td></td>
                <td></td>
                <td></td>
                <td></td>
                <td></td>
                <td></td>
                <td></td>
                <td></td>
                <td></td>
                <td></td>
            </tr>
            <tr style="vertical-align:top;">
                <td style="width:0px;height:22px;"></td>
                <td></td>
                <td class="cs12FE94AA" colspan="3" style="width:207px;height:22px;line-height:16px;text-align:left;vertical-align:top;"><nobr>Fait&nbsp;&#224;&nbsp;Goma&nbsp;le&nbsp;&nbsp;'.date('Y-m-d').'</nobr></td>
                <td></td>
                <td></td>
                <td></td>
                <td></td>
                <td></td>
                <td></td>
                <td></td>
                <td></td>
                <td></td>
            </tr>
        </table>
        </body>
        </html>';  
       
        return $output; 

}
function showDetailFacturationClient_EtatFacture($date1,$date2,$etat_facture)
{
        $data = DB::table('tvente_entete_vente')
        ->join('tvente_module','tvente_module.id','=','tvente_entete_vente.module_id')
        ->join('tvente_services','tvente_services.id','=','tvente_entete_vente.refService')
        ->join('tvente_client','tvente_client.id','=','tvente_entete_vente.refClient')
        ->join('tvente_categorie_client','tvente_categorie_client.id','=','tvente_client.refCategieClient')  
        ->join('tfin_ssouscompte','tfin_ssouscompte.id','=','tvente_categorie_client.compte_client')
        ->join('tfin_souscompte','tfin_souscompte.id','=','tfin_ssouscompte.refSousCompte')
        ->join('tfin_compte','tfin_compte.id','=','tfin_souscompte.refCompte')
        ->join('tfin_classe','tfin_classe.id','=','tfin_compte.refClasse')
        ->join('tfin_typecompte','tfin_typecompte.id','=','tfin_compte.refTypecompte')
        ->join('tfin_typeposition','tfin_typeposition.id','=','tfin_compte.refPosition')
        ->select('tvente_entete_vente.id','tvente_entete_vente.code','refClient','refService','refReservation','module_id',
        'dateVente','libelle','tvente_entete_vente.montant','tvente_entete_vente.paie','tvente_entete_vente.author',
        'tvente_entete_vente.refUser','serveur_id','table_id','etat_facture',
        'tvente_entete_vente.created_at','reduction','totaltva'
        
        ,'nom_service', "tvente_module.nom_module",'date_paie_current','nombre_print'

        ,'noms','sexe','contact','mail','adresse','pieceidentite','numeroPiece','dateLivrePiece',
        'lieulivraisonCarte','nationnalite','datenaissance','lieunaissance','profession','occupation',
        'nombreEnfant','dateArriverGoma','arriverPar','refCategieClient','photo','slug','tvente_client.author',
        'tvente_entete_vente.updated_at', "tvente_categorie_client.designation",
        "compte_client",'refSousCompte','nom_ssouscompte','numero_ssouscompte','nom_souscompte',
        'numero_souscompte','refCompte','nom_compte','numero_compte','refClasse','refTypecompte','refPosition',
        'nom_classe','numero_classe','nom_typeposition',"nom_typecompte")
        ->selectRaw('CONCAT("F",YEAR(dateVente),"",MONTH(dateVente),"00",tvente_entete_vente.id) as codeFacture')
        ->selectRaw(' ROUND(IFNULL(montant,0),2) as totalFacture')
        ->selectRaw(' ROUND(IFNULL(paie,0),2) as totalPaie')
        ->selectRaw('ROUND((IFNULL((IFNULL(montant,0) - IFNULL(paie,0)),0)),2) as RestePaie') 
        ->selectRaw('TIMESTAMPDIFF(DAY, dateVente, CURDATE()) as nombreJr')
        ->where([
            ['dateVente','>=', $date1],
            ['dateVente','<=', $date2],
            ['tvente_entete_vente.etat_facture','=', $etat_facture]
        ])
        ->orderBy("tvente_entete_vente.created_at", "asc")
        ->get();
        $output='';

        foreach ($data as $row) 
        {
            $output .='
            <tr style="vertical-align:top;">
                <td style="width:0px;height:24px;"></td>
                <td></td>
                <td class="cs6E02D7D2" style="width:101px;height:22px;line-height:15px;text-align:center;vertical-align:middle;"><nobr>'.$row->codeFacture.'</nobr></td>
                <td class="cs6E02D7D2" colspan="3" style="width:230px;height:22px;line-height:15px;text-align:left;vertical-align:middle;">'.$row->noms.'</td>
                <td class="cs6E02D7D2" colspan="2" style="width:107px;height:22px;line-height:15px;text-align:center;vertical-align:middle;">'.$row->dateVente.'</td>
                <td class="cs6E02D7D2" style="width:128px;height:22px;line-height:15px;text-align:center;vertical-align:middle;">'.$row->totalFacture.'$</td>
                <td class="cs6E02D7D2" style="width:113px;height:22px;line-height:15px;text-align:center;vertical-align:middle;">'.$row->totalPaie.'$</td>
                <td class="cs6E02D7D2" colspan="3" style="width:112px;height:22px;line-height:15px;text-align:center;vertical-align:middle;">'.$row->RestePaie.'$</td>
                <td class="cs6C28398D" style="width:102px;height:22px;line-height:15px;text-align:center;vertical-align:middle;"><nobr>'.$row->nombreJr.'J</nobr></td>
            </tr>
            '; 
           
   
    }

    return $output;

}
//================================================

public function fetch_rapport_entete_facture_client_date_etat_facture_agent(Request $request)
{
    //refDepartement

    if ($request->get('date1') && $request->get('date2') && $request->get('etat_facture') && $request->get('serveur_id')) {
        // code...
        $date1 = $request->get('date1');
        $date2 = $request->get('date2');
        $etat_facture = $request->get('etat_facture');
        $serveur_id = $request->get('serveur_id');
        
        $html = $this->printRapportEnteteFactureClient_EtatFactureAgent($date1, $date2,$etat_facture,$serveur_id);
        $pdf = \App::make('dompdf.wrapper');
        // echo($html);
        // $pdf->loadHTML($html);
        $pdf->loadHTML($html)->setPaper('a4', 'landscape');
        return $pdf->stream();            

    } else {
        // code...
    }  
    
}
function printRapportEnteteFactureClient_EtatFactureAgent($date1, $date2,$etat_facture,$serveur_id)
{

         //Info Entreprise
        $nomEse='';
        $adresseEse='';
        $Tel1Ese='';
        $Tel2Ese='';
        $siteEse='';
        $emailEse='';
        $idNatEse='';
        $numImpotEse='';
        $rccEse='';
        $siege='';
        $busnessName='';
        $pic='';
        $pic2 = $this->displayImg("fichier", 'logo.png');
        $logo='';

        $data1 = DB::table('entreprises')
        ->join('secteurs','secteurs.id','=','entreprises.idsecteur')
        ->join('forme_juridiques','forme_juridiques.id','=','entreprises.idforme')

        ->join('pays','pays.id','=','entreprises.idPays')
        ->join('provinces','provinces.id','=','entreprises.idProvince')
        ->join('users','users.id','=','entreprises.ceo')        
        ->select('entreprises.id as id','entreprises.id as idEntreprise',
        'entreprises.ceo','entreprises.nomEntreprise','entreprises.descriptionEntreprise',
        'entreprises.emailEntreprise','entreprises.adresseEntreprise',
        'entreprises.telephoneEntreprise','entreprises.solutionEntreprise','entreprises.idsecteur',
        'entreprises.idforme','entreprises.etat',
        'entreprises.idPays','entreprises.idProvince','entreprises.edition','entreprises.facebook',
        'entreprises.linkedin','entreprises.twitter','entreprises.siteweb','entreprises.rccm',
        'entreprises.invPersonnel','entreprises.invHub','entreprises.invRecherche',
        'entreprises.chiffreAffaire','entreprises.nbremploye','entreprises.slug','entreprises.logo',
            //forme
            'forme_juridiques.nomForme','secteurs.nomSecteur',
            //users
            'users.name','users.email','users.avatar','users.telephone','users.adresse',
            //
            'provinces.nomProvince','pays.nomPays', 'entreprises.created_at')
        ->first();
        if ($data1) 
        {                                
            $nomEse=$data1->nomEntreprise;
            $adresseEse=$data1->adresseEntreprise;
            $Tel1Ese=$data1->telephoneEntreprise;
            $Tel2Ese=$data1->telephone;
            $siteEse=$data1->siteweb;
            $emailEse=$data1->emailEntreprise;
            $idNatEse=$data1->rccm;
            $numImpotEse=$data1->rccm;
            $busnessName=$data1->nomSecteur;
            $rccmEse=$data1->rccm;
            $pic = $this->displayImg("fichier", 'logo.png');
            $siege=$data1->nomForme;         
        }


         $totalFact=0;
         $totalPaie=0;
         $totalReste=0;
                 
         //
         $data2 = DB::table('tvente_entete_vente') 
         ->selectRaw('ROUND(SUM( IFNULL(montant,0)),2) as TotalFacture')
         ->selectRaw('ROUND(SUM( IFNULL(paie,0)),2) as TotalPaie')
         ->selectRaw('ROUND(SUM(IFNULL((IFNULL(montant,0) - IFNULL(reduction,0) - IFNULL(paie,0)),0)),2) as TotalReste')
         ->where([
            ['dateVente','>=', $date1],
            ['dateVente','<=', $date2],
            ['tvente_entete_vente.etat_facture','=', $etat_facture],
            ['tvente_entete_vente.serveur_id','=', $serveur_id]
        ])    
         ->first(); 
         $output='';
         if ($data2) 
         {                                
            $totalFact=$data2->TotalFacture;
            $totalPaie=$data2->TotalPaie;
            $totalReste=$data2->TotalReste;                           
         }

         $nom_departement= $etat_facture;
         $code_departement= '';

         $data3= DB::table('tagent') 
         ->select("tagent.id","matricule_agent","noms_agent","sexe_agent")
         ->where([
            ['tagent.id','=', $serveur_id]
        ])      
        ->first();      
        $output='';
        if ($data3) 
        {
            $code_departement = $data3->noms_agent;              
        }
           

        $output='<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Transitional//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd">
        <!-- saved from url=(0016)http://localhost -->
        <html>
        <head>
            <title>rpt_RapportSynthese</title>
            <meta HTTP-EQUIV="Content-Type" CONTENT="text/html; charset=utf-8"/>
            <style type="text/css">
                .csB6F858D0 {color:#000000;background-color:#D6E5F4;border-left-style: none;border-top-style: none;border-right-style: none;border-bottom-style: none;font-family:Times New Roman; font-size:24px; font-weight:bold; font-style:normal; padding-left:2px;padding-right:2px;}
                .cs9FE9304F {color:#000000;background-color:#E0E0E0;border-left-style: none;border-top:#000000 1px solid;border-right:#000000 1px solid;border-bottom:#000000 1px solid;font-family:Times New Roman; font-size:13px; font-weight:bold; font-style:normal; }
                .csEAC52FCD {color:#000000;background-color:#E0E0E0;border-left-style: none;border-top:#000000 1px solid;border-right-style: none;border-bottom:#000000 1px solid;font-family:Times New Roman; font-size:13px; font-weight:bold; font-style:normal; }
                .cs56F73198 {color:#000000;background-color:transparent;border-left:#000000 1px solid;border-top:#000000 1px solid;border-right:#000000 1px solid;border-bottom:#000000 1px solid;font-family:Times New Roman; font-size:16px; font-weight:normal; font-style:normal; padding-left:2px;}
                .cs6E02D7D2 {color:#000000;background-color:transparent;border-left-style: none;border-top:#000000 1px solid;border-right:#000000 1px solid;border-bottom:#000000 1px solid;font-family:Times New Roman; font-size:14px; font-weight:normal; font-style:normal; }
                .cs6C28398D {color:#000000;background-color:transparent;border-left-style: none;border-top:#000000 1px solid;border-right-style: none;border-bottom:#000000 1px solid;font-family:Times New Roman; font-size:14px; font-weight:normal; font-style:normal; }
                .cs612ED82F {color:#000000;background-color:transparent;border-left-style: none;border-top-style: none;border-right-style: none;border-bottom-style: none;font-family:Times New Roman; font-size:12px; font-weight:bold; font-style:normal; padding-left:2px;}
                .csFFC1C457 {color:#000000;background-color:transparent;border-left-style: none;border-top-style: none;border-right-style: none;border-bottom-style: none;font-family:Times New Roman; font-size:12px; font-weight:normal; font-style:normal; padding-left:2px;}
                .cs101A94F7 {color:#000000;background-color:transparent;border-left-style: none;border-top-style: none;border-right-style: none;border-bottom-style: none;font-family:Times New Roman; font-size:13px; font-weight:normal; font-style:normal; }
                .csCE72709D {color:#000000;background-color:transparent;border-left-style: none;border-top-style: none;border-right-style: none;border-bottom-style: none;font-family:Times New Roman; font-size:14px; font-weight:bold; font-style:normal; padding-left:2px;}
                .cs12FE94AA {color:#000000;background-color:transparent;border-left-style: none;border-top-style: none;border-right-style: none;border-bottom-style: none;font-family:Times New Roman; font-size:14px; font-weight:normal; font-style:normal; padding-left:2px;}
                .csFBB219FE {color:#000000;background-color:transparent;border-left-style: none;border-top-style: none;border-right-style: none;border-bottom-style: none;font-family:Times New Roman; font-size:18px; font-weight:bold; font-style:normal; padding-left:2px;}
                .cs739196BC {color:#5C5C5C;background-color:transparent;border-left-style: none;border-top-style: none;border-right-style: none;border-bottom-style: none;font-family:Segoe UI; font-size:11px; font-weight:normal; font-style:normal; }
                .csF7D3565D {height:0px;width:0px;overflow:hidden;font-size:0px;line-height:0px;}
            </style>
        </head>
        <body leftMargin=10 topMargin=10 rightMargin=10 bottomMargin=10 style="background-color:#FFFFFF">
        <table cellpadding="0" cellspacing="0" border="0" style="border-width:0px;empty-cells:show;width:909px;height:383px;position:relative;">
            <tr>
                <td style="width:0px;height:0px;"></td>
                <td style="height:0px;width:10px;"></td>
                <td style="height:0px;width:102px;"></td>
                <td style="height:0px;width:36px;"></td>
                <td style="height:0px;width:71px;"></td>
                <td style="height:0px;width:124px;"></td>
                <td style="height:0px;width:66px;"></td>
                <td style="height:0px;width:42px;"></td>
                <td style="height:0px;width:129px;"></td>
                <td style="height:0px;width:114px;"></td>
                <td style="height:0px;width:40px;"></td>
                <td style="height:0px;width:43px;"></td>
                <td style="height:0px;width:30px;"></td>
                <td style="height:0px;width:102px;"></td>
            </tr>
            <tr style="vertical-align:top;">
                <td style="width:0px;height:23px;"></td>
                <td></td>
                <td></td>
                <td></td>
                <td></td>
                <td></td>
                <td></td>
                <td></td>
                <td></td>
            </tr>
            <tr style="vertical-align:top;">
                <td style="width:0px;height:9px;"></td>
                <td></td>
                <td></td>
                <td></td>
                <td></td>
                <td></td>
                <td></td>
                <td></td>
                <td></td>
                <td></td>
                <td></td>
                <td></td>
                <td></td>
                <td></td>
            </tr>
            <tr style="vertical-align:top;">
                <td style="width:0px;height:23px;"></td>
                <td></td>
                <td class="csFBB219FE" colspan="8" style="width:682px;height:23px;line-height:21px;text-align:left;vertical-align:middle;"><nobr>'.$nomEse.'</nobr></td>
                <td></td>
                <td class="cs101A94F7" colspan="3" rowspan="7" style="width:175px;height:144px;text-align:left;vertical-align:top;"><div style="overflow:hidden;width:175px;height:144px;">
                   <img alt="" src="'.$pic2.'" style="width:175px;height:144px;" /></div>
                </td>
            </tr>
            <tr style="vertical-align:top;">
                <td style="width:0px;height:22px;"></td>
                <td></td>
                <td class="csCE72709D" colspan="8" style="width:682px;height:22px;line-height:15px;text-align:left;vertical-align:middle;"><nobr>'.$busnessName.'</nobr></td>
                <td></td>
            </tr>
            <tr style="vertical-align:top;">
                <td style="width:0px;height:22px;"></td>
                <td></td>
                <td class="csCE72709D" colspan="8" style="width:682px;height:22px;line-height:15px;text-align:left;vertical-align:middle;"><nobr>RCCM'.$rccEse.'.&nbsp;ID-NAT.'.$idNatEse.'</nobr></td>
                <td></td>
            </tr>
            <tr style="vertical-align:top;">
                <td style="width:0px;height:22px;"></td>
                <td></td>
                <td class="csFFC1C457" colspan="8" style="width:682px;height:22px;line-height:13px;text-align:left;vertical-align:middle;">'.$adresseEse.'</td>
                <td></td>
            </tr>
            <tr style="vertical-align:top;">
                <td style="width:0px;height:22px;"></td>
                <td></td>
                <td class="csFFC1C457" colspan="8" style="width:682px;height:22px;line-height:13px;text-align:left;vertical-align:middle;"><nobr>Email&nbsp;:&nbsp;'.$emailEse.'</nobr></td>
                <td></td>
            </tr>
            <tr style="vertical-align:top;">
                <td style="width:0px;height:22px;"></td>
                <td></td>
                <td class="csFFC1C457" colspan="8" style="width:682px;height:22px;line-height:13px;text-align:left;vertical-align:middle;"><nobr>Site&nbsp;web&nbsp;:&nbsp;'.$siteEse.'</nobr></td>
                <td></td>
            </tr>
            <tr style="vertical-align:top;">
                <td style="width:0px;height:11px;"></td>
                <td></td>
                <td class="cs612ED82F" colspan="8" rowspan="2" style="width:682px;height:23px;line-height:13px;text-align:left;vertical-align:middle;"><nobr>T&#233;l&#233;phone&nbsp;:&nbsp;'.$Tel1Ese.'&nbsp;&nbsp;24h/24</nobr></td>
                <td></td>
            </tr>
            <tr style="vertical-align:top;">
                <td style="width:0px;height:12px;"></td>
                <td></td>
                <td></td>
                <td></td>
                <td></td>
                <td></td>
            </tr>
            <tr style="vertical-align:top;">
                <td style="width:0px;height:8px;"></td>
                <td></td>
                <td></td>
                <td></td>
                <td></td>
                <td></td>
                <td></td>
                <td></td>
                <td></td>
                <td></td>
                <td></td>
                <td></td>
                <td></td>
                <td></td>
            </tr>
            <tr style="vertical-align:top;">
                <td style="width:0px;height:32px;"></td>
                <td></td>
                <td></td>
                <td></td>
                <td class="csB6F858D0" colspan="8" style="width:625px;height:32px;line-height:28px;text-align:center;vertical-align:middle;"><nobr>RAPPORT DES FACTURES /ETAT FACTURE/AGENT. </nobr></td>
                <td></td>
                <td></td>
            </tr>
            <tr style="vertical-align:top;">
                <td style="width:0px;height:19px;"></td>
                <td></td>
                <td></td>
                <td></td>
                <td></td>
                <td></td>
                <td></td>
                <td></td>
                <td></td>
                <td></td>
                <td></td>
                <td></td>
                <td></td>
                <td></td>
            </tr>
            <tr style="vertical-align:top;">
                <td style="width:0px;height:23px;"></td>
                <td></td>
                <td class="cs56F73198" colspan="4" style="width:329px;height:21px;line-height:18px;text-align:left;vertical-align:top;"><nobr>&nbsp;PERIODE&nbsp;:&nbsp;&nbsp;Du&nbsp;&nbsp;'.$date1.'&nbsp;&nbsp;au&nbsp;'.$date2.'</nobr></td>
                <td class="cs56F73198" colspan="8" style="width:562px;height:21px;line-height:18px;text-align:left;vertical-align:top;"><nobr>'.$nom_departement.' - '.$code_departement.'</nobr></td>
            </tr>
            <tr style="vertical-align:top;">
                <td style="width:0px;height:9px;"></td>
                <td></td>
                <td></td>
                <td></td>
                <td></td>
                <td></td>
                <td></td>
                <td></td>
                <td></td>
                <td></td>
                <td></td>
                <td></td>
                <td></td>
                <td></td>
            </tr>
            <tr style="vertical-align:top;">
                <td style="width:0px;height:24px;"></td>
                <td></td>
                <td class="cs9FE9304F" style="width:101px;height:22px;line-height:15px;text-align:center;vertical-align:middle;"><nobr>N&#176;&nbsp;FACTURE</nobr></td>
                <td class="cs9FE9304F" colspan="3" style="width:230px;height:22px;line-height:15px;text-align:center;vertical-align:middle;"><nobr>CLIENT</nobr></td>
                <td class="cs9FE9304F" colspan="2" style="width:107px;height:22px;line-height:15px;text-align:center;vertical-align:middle;"><nobr>DATE&nbsp;FACTURE</nobr></td>
                <td class="cs9FE9304F" style="width:128px;height:22px;line-height:15px;text-align:center;vertical-align:middle;"><nobr>TOTAL&nbsp;FACTURE($)</nobr></td>
                <td class="cs9FE9304F" style="width:113px;height:22px;line-height:15px;text-align:center;vertical-align:middle;"><nobr>TOTAL&nbsp;PAIE($)</nobr></td>
                <td class="cs9FE9304F" colspan="3" style="width:112px;height:22px;line-height:15px;text-align:center;vertical-align:middle;"><nobr>RESTE($)</nobr></td>
                <td class="csEAC52FCD" style="width:102px;height:22px;line-height:15px;text-align:center;vertical-align:middle;"><nobr>OBS</nobr></td>
            </tr>
            ';

            $output .= $this->showDetailFacturationClient_EtatFactureAgent($date1,$date2,$etat_facture,$serveur_id); 

            $output.='
            <tr style="vertical-align:top;">
                <td style="width:0px;height:24px;"></td>
                <td></td>
                <td class="cs9FE9304F" colspan="6" style="width:440px;height:22px;line-height:15px;text-align:center;vertical-align:middle;"><nobr>TOTAL&nbsp;($)&nbsp;:</nobr></td>
                <td class="cs9FE9304F" style="width:128px;height:22px;line-height:15px;text-align:center;vertical-align:middle;">'.$totalFact.'$</td>
                <td class="cs9FE9304F" style="width:113px;height:22px;line-height:15px;text-align:center;vertical-align:middle;">'.$totalPaie.'$</td>
                <td class="cs9FE9304F" colspan="3" style="width:112px;height:22px;line-height:15px;text-align:center;vertical-align:middle;">'.$totalReste.'$</td>
                <td class="csEAC52FCD" style="width:102px;height:22px;"><!--[if lte IE 7]><div class="csF7D3565D"></div><![endif]--></td>
            </tr>
            <tr style="vertical-align:top;">
                <td style="width:0px;height:10px;"></td>
                <td></td>
                <td></td>
                <td></td>
                <td></td>
                <td></td>
                <td></td>
                <td></td>
                <td></td>
                <td></td>
                <td></td>
                <td></td>
                <td></td>
                <td></td>
            </tr>
            <tr style="vertical-align:top;">
                <td style="width:0px;height:22px;"></td>
                <td></td>
                <td class="cs12FE94AA" colspan="3" style="width:207px;height:22px;line-height:16px;text-align:left;vertical-align:top;"><nobr>Fait&nbsp;&#224;&nbsp;Goma&nbsp;le&nbsp;&nbsp;'.date('Y-m-d').'</nobr></td>
                <td></td>
                <td></td>
                <td></td>
                <td></td>
                <td></td>
                <td></td>
                <td></td>
                <td></td>
                <td></td>
            </tr>
        </table>
        </body>
        </html>';  
       
        return $output; 

}
function showDetailFacturationClient_EtatFactureAgent($date1,$date2,$etat_facture,$serveur_id)
{
        $data = DB::table('tvente_entete_vente')
        ->join('tvente_module','tvente_module.id','=','tvente_entete_vente.module_id')
        ->join('tvente_services','tvente_services.id','=','tvente_entete_vente.refService')
        ->join('tvente_client','tvente_client.id','=','tvente_entete_vente.refClient')
        ->join('tvente_categorie_client','tvente_categorie_client.id','=','tvente_client.refCategieClient')  
        ->join('tfin_ssouscompte','tfin_ssouscompte.id','=','tvente_categorie_client.compte_client')
        ->join('tfin_souscompte','tfin_souscompte.id','=','tfin_ssouscompte.refSousCompte')
        ->join('tfin_compte','tfin_compte.id','=','tfin_souscompte.refCompte')
        ->join('tfin_classe','tfin_classe.id','=','tfin_compte.refClasse')
        ->join('tfin_typecompte','tfin_typecompte.id','=','tfin_compte.refTypecompte')
        ->join('tfin_typeposition','tfin_typeposition.id','=','tfin_compte.refPosition')
        ->select('tvente_entete_vente.id','tvente_entete_vente.code','refClient','refService','refReservation','module_id',
        'dateVente','libelle','tvente_entete_vente.montant','tvente_entete_vente.paie','tvente_entete_vente.author',
        'tvente_entete_vente.refUser','serveur_id','table_id','etat_facture',
        'tvente_entete_vente.created_at','reduction','totaltva'
        
        ,'nom_service', "tvente_module.nom_module",'date_paie_current','nombre_print'

        ,'noms','sexe','contact','mail','adresse','pieceidentite','numeroPiece','dateLivrePiece',
        'lieulivraisonCarte','nationnalite','datenaissance','lieunaissance','profession','occupation',
        'nombreEnfant','dateArriverGoma','arriverPar','refCategieClient','photo','slug','tvente_client.author',
        'tvente_entete_vente.updated_at', "tvente_categorie_client.designation",
        "compte_client",'refSousCompte','nom_ssouscompte','numero_ssouscompte','nom_souscompte',
        'numero_souscompte','refCompte','nom_compte','numero_compte','refClasse','refTypecompte','refPosition',
        'nom_classe','numero_classe','nom_typeposition',"nom_typecompte")
        ->selectRaw('CONCAT("F",YEAR(dateVente),"",MONTH(dateVente),"00",tvente_entete_vente.id) as codeFacture')
        ->selectRaw(' ROUND(IFNULL(montant,0),2) as totalFacture')
        ->selectRaw(' ROUND(IFNULL(paie,0),2) as totalPaie')
        ->selectRaw('ROUND((IFNULL((IFNULL(montant,0) - IFNULL(paie,0)),0)),2) as RestePaie') 
        ->selectRaw('TIMESTAMPDIFF(DAY, dateVente, CURDATE()) as nombreJr')
        ->where([
            ['dateVente','>=', $date1],
            ['dateVente','<=', $date2],
            ['tvente_entete_vente.etat_facture','=', $etat_facture],
            ['tvente_entete_vente.serveur_id','=', $serveur_id]
        ])
        ->orderBy("tvente_entete_vente.created_at", "asc")
        ->get();
        $output='';

        foreach ($data as $row) 
        {
            $output .='
            <tr style="vertical-align:top;">
                <td style="width:0px;height:24px;"></td>
                <td></td>
                <td class="cs6E02D7D2" style="width:101px;height:22px;line-height:15px;text-align:center;vertical-align:middle;"><nobr>'.$row->codeFacture.'</nobr></td>
                <td class="cs6E02D7D2" colspan="3" style="width:230px;height:22px;line-height:15px;text-align:left;vertical-align:middle;">'.$row->noms.'</td>
                <td class="cs6E02D7D2" colspan="2" style="width:107px;height:22px;line-height:15px;text-align:center;vertical-align:middle;">'.$row->dateVente.'</td>
                <td class="cs6E02D7D2" style="width:128px;height:22px;line-height:15px;text-align:center;vertical-align:middle;">'.$row->totalFacture.'$</td>
                <td class="cs6E02D7D2" style="width:113px;height:22px;line-height:15px;text-align:center;vertical-align:middle;">'.$row->totalPaie.'$</td>
                <td class="cs6E02D7D2" colspan="3" style="width:112px;height:22px;line-height:15px;text-align:center;vertical-align:middle;">'.$row->RestePaie.'$</td>
                <td class="cs6C28398D" style="width:102px;height:22px;line-height:15px;text-align:center;vertical-align:middle;"><nobr>'.$row->nombreJr.'J</nobr></td>
            </tr>
            '; 
           
   
    }

    return $output;

}
//================================================


public function fetch_rapport_entete_facture_dette_client_date(Request $request)
{
    //refDepartement

    if ($request->get('date1') && $request->get('date2')) {
        // code...
        $date1 = $request->get('date1');
        $date2 = $request->get('date2');
        
        $html = $this->printRapportEnteteFactureDetteClient($date1, $date2);
        $pdf = \App::make('dompdf.wrapper');
        // echo($html);
        // $pdf->loadHTML($html);
        $pdf->loadHTML($html)->setPaper('a4', 'landscape');
        return $pdf->stream();            

    } else {
        // code...
    }  
    
}
function printRapportEnteteFactureDetteClient($date1, $date2)
{

         //Info Entreprise
        $nomEse='';
        $adresseEse='';
        $Tel1Ese='';
        $Tel2Ese='';
        $siteEse='';
        $emailEse='';
        $idNatEse='';
        $numImpotEse='';
        $rccEse='';
        $siege='';
        $busnessName='';
        $pic='';
        $pic2 = $this->displayImg("fichier", 'logo.png');
        $logo='';

        $data1 = DB::table('entreprises')
        ->join('secteurs','secteurs.id','=','entreprises.idsecteur')
        ->join('forme_juridiques','forme_juridiques.id','=','entreprises.idforme')

        ->join('pays','pays.id','=','entreprises.idPays')
        ->join('provinces','provinces.id','=','entreprises.idProvince')
        ->join('users','users.id','=','entreprises.ceo')        
        ->select('entreprises.id as id','entreprises.id as idEntreprise',
        'entreprises.ceo','entreprises.nomEntreprise','entreprises.descriptionEntreprise',
        'entreprises.emailEntreprise','entreprises.adresseEntreprise',
        'entreprises.telephoneEntreprise','entreprises.solutionEntreprise','entreprises.idsecteur',
        'entreprises.idforme','entreprises.etat',
        'entreprises.idPays','entreprises.idProvince','entreprises.edition','entreprises.facebook',
        'entreprises.linkedin','entreprises.twitter','entreprises.siteweb','entreprises.rccm',
        'entreprises.invPersonnel','entreprises.invHub','entreprises.invRecherche',
        'entreprises.chiffreAffaire','entreprises.nbremploye','entreprises.slug','entreprises.logo',
            //forme
            'forme_juridiques.nomForme','secteurs.nomSecteur',
            //users
            'users.name','users.email','users.avatar','users.telephone','users.adresse',
            //
            'provinces.nomProvince','pays.nomPays', 'entreprises.created_at')
        ->first();
        if ($data1) 
        {                                
            $nomEse=$data1->nomEntreprise;
            $adresseEse=$data1->adresseEntreprise;
            $Tel1Ese=$data1->telephoneEntreprise;
            $Tel2Ese=$data1->telephone;
            $siteEse=$data1->siteweb;
            $emailEse=$data1->emailEntreprise;
            $idNatEse=$data1->rccm;
            $numImpotEse=$data1->rccm;
            $busnessName=$data1->nomSecteur;
            $rccmEse=$data1->rccm;
            $pic = $this->displayImg("fichier", 'logo.png');
            $siege=$data1->nomForme;         
        }


         $totalFact=0;
         $totalPaie=0;
         $totalReste=0;
                 
         //
         $data2 = DB::table('tvente_entete_vente')
        ->selectRaw('
            ROUND(SUM(IFNULL(montant, 0)), 2) as TotalFacture,
            ROUND(SUM(IFNULL(paie, 0)), 2) as TotalPaie,
            ROUND(SUM(IFNULL(montant, 0) - IFNULL(reduction, 0) - IFNULL(paie, 0)), 2) as TotalReste
        ')
        ->whereRaw('ROUND((IFNULL(montant, 0) + IFNULL(totaltva, 0) - IFNULL(reduction, 0)) - IFNULL(paie, 0), 2) > 0')
        ->where([
            ['dateVente', '>=', $date1],
            ['dateVente', '<=', $date2]
        ])
        ->first();

        $output = '';

        if ($data2) {                                
            $totalFact = $data2->TotalFacture;
            $totalPaie = $data2->TotalPaie;
            $totalReste = $data2->TotalReste;                           
        }


         $nom_departement= '-';
         $code_departement= '-';

        //  $data3= DB::table('tagent') 
        //  ->select("tagent.id","matricule_agent","noms_agent","sexe_agent")
        //  ->where([
        //     ['tagent.id','=', $serveur_id]
        // ])      
        // ->first();      
        // $output='';
        // if ($data3) 
        // {
        //     $code_departement = $data3->noms_agent;              
        // }
           

        $output='<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Transitional//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd">
        <!-- saved from url=(0016)http://localhost -->
        <html>
        <head>
            <title>rpt_RapportSynthese</title>
            <meta HTTP-EQUIV="Content-Type" CONTENT="text/html; charset=utf-8"/>
            <style type="text/css">
                .csB6F858D0 {color:#000000;background-color:#D6E5F4;border-left-style: none;border-top-style: none;border-right-style: none;border-bottom-style: none;font-family:Times New Roman; font-size:24px; font-weight:bold; font-style:normal; padding-left:2px;padding-right:2px;}
                .cs9FE9304F {color:#000000;background-color:#E0E0E0;border-left-style: none;border-top:#000000 1px solid;border-right:#000000 1px solid;border-bottom:#000000 1px solid;font-family:Times New Roman; font-size:13px; font-weight:bold; font-style:normal; }
                .csEAC52FCD {color:#000000;background-color:#E0E0E0;border-left-style: none;border-top:#000000 1px solid;border-right-style: none;border-bottom:#000000 1px solid;font-family:Times New Roman; font-size:13px; font-weight:bold; font-style:normal; }
                .cs56F73198 {color:#000000;background-color:transparent;border-left:#000000 1px solid;border-top:#000000 1px solid;border-right:#000000 1px solid;border-bottom:#000000 1px solid;font-family:Times New Roman; font-size:16px; font-weight:normal; font-style:normal; padding-left:2px;}
                .cs6E02D7D2 {color:#000000;background-color:transparent;border-left-style: none;border-top:#000000 1px solid;border-right:#000000 1px solid;border-bottom:#000000 1px solid;font-family:Times New Roman; font-size:14px; font-weight:normal; font-style:normal; }
                .cs6C28398D {color:#000000;background-color:transparent;border-left-style: none;border-top:#000000 1px solid;border-right-style: none;border-bottom:#000000 1px solid;font-family:Times New Roman; font-size:14px; font-weight:normal; font-style:normal; }
                .cs612ED82F {color:#000000;background-color:transparent;border-left-style: none;border-top-style: none;border-right-style: none;border-bottom-style: none;font-family:Times New Roman; font-size:12px; font-weight:bold; font-style:normal; padding-left:2px;}
                .csFFC1C457 {color:#000000;background-color:transparent;border-left-style: none;border-top-style: none;border-right-style: none;border-bottom-style: none;font-family:Times New Roman; font-size:12px; font-weight:normal; font-style:normal; padding-left:2px;}
                .cs101A94F7 {color:#000000;background-color:transparent;border-left-style: none;border-top-style: none;border-right-style: none;border-bottom-style: none;font-family:Times New Roman; font-size:13px; font-weight:normal; font-style:normal; }
                .csCE72709D {color:#000000;background-color:transparent;border-left-style: none;border-top-style: none;border-right-style: none;border-bottom-style: none;font-family:Times New Roman; font-size:14px; font-weight:bold; font-style:normal; padding-left:2px;}
                .cs12FE94AA {color:#000000;background-color:transparent;border-left-style: none;border-top-style: none;border-right-style: none;border-bottom-style: none;font-family:Times New Roman; font-size:14px; font-weight:normal; font-style:normal; padding-left:2px;}
                .csFBB219FE {color:#000000;background-color:transparent;border-left-style: none;border-top-style: none;border-right-style: none;border-bottom-style: none;font-family:Times New Roman; font-size:18px; font-weight:bold; font-style:normal; padding-left:2px;}
                .cs739196BC {color:#5C5C5C;background-color:transparent;border-left-style: none;border-top-style: none;border-right-style: none;border-bottom-style: none;font-family:Segoe UI; font-size:11px; font-weight:normal; font-style:normal; }
                .csF7D3565D {height:0px;width:0px;overflow:hidden;font-size:0px;line-height:0px;}
            </style>
        </head>
        <body leftMargin=10 topMargin=10 rightMargin=10 bottomMargin=10 style="background-color:#FFFFFF">
        <table cellpadding="0" cellspacing="0" border="0" style="border-width:0px;empty-cells:show;width:909px;height:383px;position:relative;">
            <tr>
                <td style="width:0px;height:0px;"></td>
                <td style="height:0px;width:10px;"></td>
                <td style="height:0px;width:102px;"></td>
                <td style="height:0px;width:36px;"></td>
                <td style="height:0px;width:71px;"></td>
                <td style="height:0px;width:124px;"></td>
                <td style="height:0px;width:66px;"></td>
                <td style="height:0px;width:42px;"></td>
                <td style="height:0px;width:129px;"></td>
                <td style="height:0px;width:114px;"></td>
                <td style="height:0px;width:40px;"></td>
                <td style="height:0px;width:43px;"></td>
                <td style="height:0px;width:30px;"></td>
                <td style="height:0px;width:102px;"></td>
            </tr>
            <tr style="vertical-align:top;">
                <td style="width:0px;height:23px;"></td>
                <td></td>
                <td></td>
                <td></td>
                <td></td>
                <td></td>
                <td></td>
                <td></td>
                <td></td>
            </tr>
            <tr style="vertical-align:top;">
                <td style="width:0px;height:9px;"></td>
                <td></td>
                <td></td>
                <td></td>
                <td></td>
                <td></td>
                <td></td>
                <td></td>
                <td></td>
                <td></td>
                <td></td>
                <td></td>
                <td></td>
                <td></td>
            </tr>
            <tr style="vertical-align:top;">
                <td style="width:0px;height:23px;"></td>
                <td></td>
                <td class="csFBB219FE" colspan="8" style="width:682px;height:23px;line-height:21px;text-align:left;vertical-align:middle;"><nobr>'.$nomEse.'</nobr></td>
                <td></td>
                <td class="cs101A94F7" colspan="3" rowspan="7" style="width:175px;height:144px;text-align:left;vertical-align:top;"><div style="overflow:hidden;width:175px;height:144px;">
                   <img alt="" src="'.$pic2.'" style="width:175px;height:144px;" /></div>
                </td>
            </tr>
            <tr style="vertical-align:top;">
                <td style="width:0px;height:22px;"></td>
                <td></td>
                <td class="csCE72709D" colspan="8" style="width:682px;height:22px;line-height:15px;text-align:left;vertical-align:middle;"><nobr>'.$busnessName.'</nobr></td>
                <td></td>
            </tr>
            <tr style="vertical-align:top;">
                <td style="width:0px;height:22px;"></td>
                <td></td>
                <td class="csCE72709D" colspan="8" style="width:682px;height:22px;line-height:15px;text-align:left;vertical-align:middle;"><nobr>RCCM'.$rccEse.'.&nbsp;ID-NAT.'.$idNatEse.'</nobr></td>
                <td></td>
            </tr>
            <tr style="vertical-align:top;">
                <td style="width:0px;height:22px;"></td>
                <td></td>
                <td class="csFFC1C457" colspan="8" style="width:682px;height:22px;line-height:13px;text-align:left;vertical-align:middle;">'.$adresseEse.'</td>
                <td></td>
            </tr>
            <tr style="vertical-align:top;">
                <td style="width:0px;height:22px;"></td>
                <td></td>
                <td class="csFFC1C457" colspan="8" style="width:682px;height:22px;line-height:13px;text-align:left;vertical-align:middle;"><nobr>Email&nbsp;:&nbsp;'.$emailEse.'</nobr></td>
                <td></td>
            </tr>
            <tr style="vertical-align:top;">
                <td style="width:0px;height:22px;"></td>
                <td></td>
                <td class="csFFC1C457" colspan="8" style="width:682px;height:22px;line-height:13px;text-align:left;vertical-align:middle;"><nobr>Site&nbsp;web&nbsp;:&nbsp;'.$siteEse.'</nobr></td>
                <td></td>
            </tr>
            <tr style="vertical-align:top;">
                <td style="width:0px;height:11px;"></td>
                <td></td>
                <td class="cs612ED82F" colspan="8" rowspan="2" style="width:682px;height:23px;line-height:13px;text-align:left;vertical-align:middle;"><nobr>T&#233;l&#233;phone&nbsp;:&nbsp;'.$Tel1Ese.'&nbsp;&nbsp;24h/24</nobr></td>
                <td></td>
            </tr>
            <tr style="vertical-align:top;">
                <td style="width:0px;height:12px;"></td>
                <td></td>
                <td></td>
                <td></td>
                <td></td>
                <td></td>
            </tr>
            <tr style="vertical-align:top;">
                <td style="width:0px;height:8px;"></td>
                <td></td>
                <td></td>
                <td></td>
                <td></td>
                <td></td>
                <td></td>
                <td></td>
                <td></td>
                <td></td>
                <td></td>
                <td></td>
                <td></td>
                <td></td>
            </tr>
            <tr style="vertical-align:top;">
                <td style="width:0px;height:32px;"></td>
                <td></td>
                <td></td>
                <td></td>
                <td class="csB6F858D0" colspan="8" style="width:625px;height:32px;line-height:28px;text-align:center;vertical-align:middle;"><nobr>RAPPORT DES FACTURES DES CLIENTS EN DETTE. </nobr></td>
                <td></td>
                <td></td>
            </tr>
            <tr style="vertical-align:top;">
                <td style="width:0px;height:19px;"></td>
                <td></td>
                <td></td>
                <td></td>
                <td></td>
                <td></td>
                <td></td>
                <td></td>
                <td></td>
                <td></td>
                <td></td>
                <td></td>
                <td></td>
                <td></td>
            </tr>
            <tr style="vertical-align:top;">
                <td style="width:0px;height:23px;"></td>
                <td></td>
                <td class="cs56F73198" colspan="4" style="width:329px;height:21px;line-height:18px;text-align:left;vertical-align:top;"><nobr>&nbsp;PERIODE&nbsp;:&nbsp;&nbsp;Du&nbsp;&nbsp;'.$date1.'&nbsp;&nbsp;au&nbsp;'.$date2.'</nobr></td>
                <td class="cs56F73198" colspan="8" style="width:562px;height:21px;line-height:18px;text-align:left;vertical-align:top;"><nobr>'.$nom_departement.'</nobr></td>
            </tr>
            <tr style="vertical-align:top;">
                <td style="width:0px;height:9px;"></td>
                <td></td>
                <td></td>
                <td></td>
                <td></td>
                <td></td>
                <td></td>
                <td></td>
                <td></td>
                <td></td>
                <td></td>
                <td></td>
                <td></td>
                <td></td>
            </tr>
            <tr style="vertical-align:top;">
                <td style="width:0px;height:24px;"></td>
                <td></td>
                <td class="cs9FE9304F" style="width:101px;height:22px;line-height:15px;text-align:center;vertical-align:middle;"><nobr>N&#176;&nbsp;FACTURE</nobr></td>
                <td class="cs9FE9304F" colspan="3" style="width:230px;height:22px;line-height:15px;text-align:center;vertical-align:middle;"><nobr>CLIENT</nobr></td>
                <td class="cs9FE9304F" colspan="2" style="width:107px;height:22px;line-height:15px;text-align:center;vertical-align:middle;"><nobr>DATE&nbsp;FACTURE</nobr></td>
                <td class="cs9FE9304F" style="width:128px;height:22px;line-height:15px;text-align:center;vertical-align:middle;"><nobr>TOTAL&nbsp;FACTURE($)</nobr></td>
                <td class="cs9FE9304F" style="width:113px;height:22px;line-height:15px;text-align:center;vertical-align:middle;"><nobr>TOTAL&nbsp;PAIE($)</nobr></td>
                <td class="cs9FE9304F" colspan="3" style="width:112px;height:22px;line-height:15px;text-align:center;vertical-align:middle;"><nobr>RESTE($)</nobr></td>
                <td class="csEAC52FCD" style="width:102px;height:22px;line-height:15px;text-align:center;vertical-align:middle;"><nobr>OBS</nobr></td>
            </tr>
            ';

            $output .= $this->showDetailFacturationDetteClient($date1,$date2); 

            $output.='
            <tr style="vertical-align:top;">
                <td style="width:0px;height:24px;"></td>
                <td></td>
                <td class="cs9FE9304F" colspan="6" style="width:440px;height:22px;line-height:15px;text-align:center;vertical-align:middle;"><nobr>TOTAL&nbsp;($)&nbsp;:</nobr></td>
                <td class="cs9FE9304F" style="width:128px;height:22px;line-height:15px;text-align:center;vertical-align:middle;">'.$totalFact.'$</td>
                <td class="cs9FE9304F" style="width:113px;height:22px;line-height:15px;text-align:center;vertical-align:middle;">'.$totalPaie.'$</td>
                <td class="cs9FE9304F" colspan="3" style="width:112px;height:22px;line-height:15px;text-align:center;vertical-align:middle;">'.$totalReste.'$</td>
                <td class="csEAC52FCD" style="width:102px;height:22px;"><!--[if lte IE 7]><div class="csF7D3565D"></div><![endif]--></td>
            </tr>
            <tr style="vertical-align:top;">
                <td style="width:0px;height:10px;"></td>
                <td></td>
                <td></td>
                <td></td>
                <td></td>
                <td></td>
                <td></td>
                <td></td>
                <td></td>
                <td></td>
                <td></td>
                <td></td>
                <td></td>
                <td></td>
            </tr>
            <tr style="vertical-align:top;">
                <td style="width:0px;height:22px;"></td>
                <td></td>
                <td class="cs12FE94AA" colspan="3" style="width:207px;height:22px;line-height:16px;text-align:left;vertical-align:top;"><nobr>Fait&nbsp;&#224;&nbsp;Goma&nbsp;le&nbsp;&nbsp;'.date('Y-m-d').'</nobr></td>
                <td></td>
                <td></td>
                <td></td>
                <td></td>
                <td></td>
                <td></td>
                <td></td>
                <td></td>
                <td></td>
            </tr>
        </table>
        </body>
        </html>';  
       
        return $output; 

}
function showDetailFacturationDetteClient($date1,$date2)
{
    $data = DB::table('tvente_entete_vente')
    ->join('tvente_module','tvente_module.id','=','tvente_entete_vente.module_id')
    ->join('tvente_services','tvente_services.id','=','tvente_entete_vente.refService')
    ->join('tvente_client','tvente_client.id','=','tvente_entete_vente.refClient')
    ->join('tvente_categorie_client','tvente_categorie_client.id','=','tvente_client.refCategieClient')  

    ->select(
        'tvente_entete_vente.id','tvente_entete_vente.code','refClient','refService','refReservation','module_id',
        'dateVente','tvente_entete_vente.libelle','tvente_entete_vente.montant','tvente_entete_vente.paie','tvente_entete_vente.author',
        'tvente_entete_vente.refUser','serveur_id','table_id','etat_facture',
        'tvente_entete_vente.created_at','reduction','totaltva',
        'tvente_services.nom_service', 'tvente_module.nom_module','date_paie_current','nombre_print',
        'tvente_client.noms','tvente_client.sexe','tvente_client.contact','tvente_client.mail','tvente_client.adresse',
        'tvente_client.pieceidentite','tvente_client.numeroPiece','tvente_client.dateLivrePiece',
        'tvente_client.lieulivraisonCarte','tvente_client.nationnalite','tvente_client.datenaissance',
        'tvente_client.lieunaissance','tvente_client.profession','tvente_client.occupation','tvente_client.nombreEnfant',
        'tvente_client.dateArriverGoma','tvente_client.arriverPar','tvente_client.refCategieClient','tvente_client.photo',
        'tvente_client.slug','tvente_client.author as client_author','tvente_entete_vente.updated_at',
        'tvente_categorie_client.designation')
    ->addSelect(DB::raw('
        CONCAT("F",YEAR(dateVente),"",MONTH(dateVente),"00",tvente_entete_vente.id) as codeFacture,
        ROUND(IFNULL(tvente_entete_vente.montant,0),2) as totalFacture,
        ROUND(IFNULL(tvente_entete_vente.paie,0),2) as totalPaie,
        ROUND((IFNULL(tvente_entete_vente.montant,0) - IFNULL(tvente_entete_vente.paie,0)),2) as RestePaie,
        TIMESTAMPDIFF(DAY, tvente_entete_vente.dateVente, CURDATE()) as nombreJr
    '))
    ->whereRaw('ROUND((IFNULL(tvente_entete_vente.montant, 0) + IFNULL(tvente_entete_vente.totaltva, 0) - IFNULL(tvente_entete_vente.reduction, 0)) - IFNULL(tvente_entete_vente.paie, 0), 2) > 0')
    ->where([
        ['dateVente','>=', $date1],
        ['dateVente','<=', $date2]
    ])
    ->orderBy("tvente_entete_vente.created_at", "asc")
    ->get();
        $output='';

        foreach ($data as $row) 
        {
            $output .='
            <tr style="vertical-align:top;">
                <td style="width:0px;height:24px;"></td>
                <td></td>
                <td class="cs6E02D7D2" style="width:101px;height:22px;line-height:15px;text-align:center;vertical-align:middle;"><nobr>'.$row->codeFacture.'</nobr></td>
                <td class="cs6E02D7D2" colspan="3" style="width:230px;height:22px;line-height:15px;text-align:left;vertical-align:middle;">'.$row->noms.'</td>
                <td class="cs6E02D7D2" colspan="2" style="width:107px;height:22px;line-height:15px;text-align:center;vertical-align:middle;">'.$row->dateVente.'</td>
                <td class="cs6E02D7D2" style="width:128px;height:22px;line-height:15px;text-align:center;vertical-align:middle;">'.$row->totalFacture.'$</td>
                <td class="cs6E02D7D2" style="width:113px;height:22px;line-height:15px;text-align:center;vertical-align:middle;">'.$row->totalPaie.'$</td>
                <td class="cs6E02D7D2" colspan="3" style="width:112px;height:22px;line-height:15px;text-align:center;vertical-align:middle;">'.$row->RestePaie.'$</td>
                <td class="cs6C28398D" style="width:102px;height:22px;line-height:15px;text-align:center;vertical-align:middle;"><nobr>'.$row->nombreJr.'J</nobr></td>
            </tr>
            '; 
           
   
    }

    return $output;

}

//================================================


public function fetch_rapport_entete_facture_dette_client_date_agent(Request $request)
{
    //refDepartement

    if ($request->get('date1') && $request->get('date2') && $request->get('serveur_id')) {
        // code...
        $date1 = $request->get('date1');
        $date2 = $request->get('date2');
        $serveur_id = $request->get('serveur_id');
        
        $html = $this->printRapportEnteteFactureDetteClientAgent($date1, $date2, $serveur_id);
        $pdf = \App::make('dompdf.wrapper');
        // echo($html);
        // $pdf->loadHTML($html);
        $pdf->loadHTML($html)->setPaper('a4', 'landscape');
        return $pdf->stream();            

    } else {
        // code...
    }  
    
}
function printRapportEnteteFactureDetteClientAgent($date1, $date2, $serveur_id)
{

         //Info Entreprise
        $nomEse='';
        $adresseEse='';
        $Tel1Ese='';
        $Tel2Ese='';
        $siteEse='';
        $emailEse='';
        $idNatEse='';
        $numImpotEse='';
        $rccEse='';
        $siege='';
        $busnessName='';
        $pic='';
        $pic2 = $this->displayImg("fichier", 'logo.png');
        $logo='';

        $data1 = DB::table('entreprises')
        ->join('secteurs','secteurs.id','=','entreprises.idsecteur')
        ->join('forme_juridiques','forme_juridiques.id','=','entreprises.idforme')

        ->join('pays','pays.id','=','entreprises.idPays')
        ->join('provinces','provinces.id','=','entreprises.idProvince')
        ->join('users','users.id','=','entreprises.ceo')        
        ->select('entreprises.id as id','entreprises.id as idEntreprise',
        'entreprises.ceo','entreprises.nomEntreprise','entreprises.descriptionEntreprise',
        'entreprises.emailEntreprise','entreprises.adresseEntreprise',
        'entreprises.telephoneEntreprise','entreprises.solutionEntreprise','entreprises.idsecteur',
        'entreprises.idforme','entreprises.etat',
        'entreprises.idPays','entreprises.idProvince','entreprises.edition','entreprises.facebook',
        'entreprises.linkedin','entreprises.twitter','entreprises.siteweb','entreprises.rccm',
        'entreprises.invPersonnel','entreprises.invHub','entreprises.invRecherche',
        'entreprises.chiffreAffaire','entreprises.nbremploye','entreprises.slug','entreprises.logo',
            //forme
            'forme_juridiques.nomForme','secteurs.nomSecteur',
            //users
            'users.name','users.email','users.avatar','users.telephone','users.adresse',
            //
            'provinces.nomProvince','pays.nomPays', 'entreprises.created_at')
        ->first();
        if ($data1) 
        {                                
            $nomEse=$data1->nomEntreprise;
            $adresseEse=$data1->adresseEntreprise;
            $Tel1Ese=$data1->telephoneEntreprise;
            $Tel2Ese=$data1->telephone;
            $siteEse=$data1->siteweb;
            $emailEse=$data1->emailEntreprise;
            $idNatEse=$data1->rccm;
            $numImpotEse=$data1->rccm;
            $busnessName=$data1->nomSecteur;
            $rccmEse=$data1->rccm;
            $pic = $this->displayImg("fichier", 'logo.png');
            $siege=$data1->nomForme;         
        }


         $totalFact=0;
         $totalPaie=0;
         $totalReste=0;
                 
         //
         $data2 = DB::table('tvente_entete_vente')
        ->selectRaw('
            ROUND(SUM(IFNULL(montant, 0)), 2) as TotalFacture,
            ROUND(SUM(IFNULL(paie, 0)), 2) as TotalPaie,
            ROUND(SUM(IFNULL(montant, 0) - IFNULL(reduction, 0) - IFNULL(paie, 0)), 2) as TotalReste
        ')
        ->whereRaw('ROUND((IFNULL(montant, 0) + IFNULL(totaltva, 0) - IFNULL(reduction, 0)) - IFNULL(paie, 0), 2) > 0')
        ->where([
            ['dateVente', '>=', $date1],
            ['dateVente', '<=', $date2],
            ['tvente_entete_vente.serveur_id','=', $serveur_id]
        ])
        ->first();

        $output = '';

        if ($data2) {                                
            $totalFact = $data2->TotalFacture;
            $totalPaie = $data2->TotalPaie;
            $totalReste = $data2->TotalReste;                           
        }


         $nom_departement= '-';
         $code_departement= '-';

         $data3= DB::table('tagent') 
         ->select("tagent.id","matricule_agent","noms_agent","sexe_agent")
         ->where([
            ['tagent.id','=', $serveur_id]
        ])      
        ->first();      
        $output='';
        if ($data3) 
        {
            $nom_departement = $data3->noms_agent;              
        }
           

        $output='<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Transitional//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd">
        <!-- saved from url=(0016)http://localhost -->
        <html>
        <head>
            <title>rpt_RapportSynthese</title>
            <meta HTTP-EQUIV="Content-Type" CONTENT="text/html; charset=utf-8"/>
            <style type="text/css">
                .csB6F858D0 {color:#000000;background-color:#D6E5F4;border-left-style: none;border-top-style: none;border-right-style: none;border-bottom-style: none;font-family:Times New Roman; font-size:24px; font-weight:bold; font-style:normal; padding-left:2px;padding-right:2px;}
                .cs9FE9304F {color:#000000;background-color:#E0E0E0;border-left-style: none;border-top:#000000 1px solid;border-right:#000000 1px solid;border-bottom:#000000 1px solid;font-family:Times New Roman; font-size:13px; font-weight:bold; font-style:normal; }
                .csEAC52FCD {color:#000000;background-color:#E0E0E0;border-left-style: none;border-top:#000000 1px solid;border-right-style: none;border-bottom:#000000 1px solid;font-family:Times New Roman; font-size:13px; font-weight:bold; font-style:normal; }
                .cs56F73198 {color:#000000;background-color:transparent;border-left:#000000 1px solid;border-top:#000000 1px solid;border-right:#000000 1px solid;border-bottom:#000000 1px solid;font-family:Times New Roman; font-size:16px; font-weight:normal; font-style:normal; padding-left:2px;}
                .cs6E02D7D2 {color:#000000;background-color:transparent;border-left-style: none;border-top:#000000 1px solid;border-right:#000000 1px solid;border-bottom:#000000 1px solid;font-family:Times New Roman; font-size:14px; font-weight:normal; font-style:normal; }
                .cs6C28398D {color:#000000;background-color:transparent;border-left-style: none;border-top:#000000 1px solid;border-right-style: none;border-bottom:#000000 1px solid;font-family:Times New Roman; font-size:14px; font-weight:normal; font-style:normal; }
                .cs612ED82F {color:#000000;background-color:transparent;border-left-style: none;border-top-style: none;border-right-style: none;border-bottom-style: none;font-family:Times New Roman; font-size:12px; font-weight:bold; font-style:normal; padding-left:2px;}
                .csFFC1C457 {color:#000000;background-color:transparent;border-left-style: none;border-top-style: none;border-right-style: none;border-bottom-style: none;font-family:Times New Roman; font-size:12px; font-weight:normal; font-style:normal; padding-left:2px;}
                .cs101A94F7 {color:#000000;background-color:transparent;border-left-style: none;border-top-style: none;border-right-style: none;border-bottom-style: none;font-family:Times New Roman; font-size:13px; font-weight:normal; font-style:normal; }
                .csCE72709D {color:#000000;background-color:transparent;border-left-style: none;border-top-style: none;border-right-style: none;border-bottom-style: none;font-family:Times New Roman; font-size:14px; font-weight:bold; font-style:normal; padding-left:2px;}
                .cs12FE94AA {color:#000000;background-color:transparent;border-left-style: none;border-top-style: none;border-right-style: none;border-bottom-style: none;font-family:Times New Roman; font-size:14px; font-weight:normal; font-style:normal; padding-left:2px;}
                .csFBB219FE {color:#000000;background-color:transparent;border-left-style: none;border-top-style: none;border-right-style: none;border-bottom-style: none;font-family:Times New Roman; font-size:18px; font-weight:bold; font-style:normal; padding-left:2px;}
                .cs739196BC {color:#5C5C5C;background-color:transparent;border-left-style: none;border-top-style: none;border-right-style: none;border-bottom-style: none;font-family:Segoe UI; font-size:11px; font-weight:normal; font-style:normal; }
                .csF7D3565D {height:0px;width:0px;overflow:hidden;font-size:0px;line-height:0px;}
            </style>
        </head>
        <body leftMargin=10 topMargin=10 rightMargin=10 bottomMargin=10 style="background-color:#FFFFFF">
        <table cellpadding="0" cellspacing="0" border="0" style="border-width:0px;empty-cells:show;width:909px;height:383px;position:relative;">
            <tr>
                <td style="width:0px;height:0px;"></td>
                <td style="height:0px;width:10px;"></td>
                <td style="height:0px;width:102px;"></td>
                <td style="height:0px;width:36px;"></td>
                <td style="height:0px;width:71px;"></td>
                <td style="height:0px;width:124px;"></td>
                <td style="height:0px;width:66px;"></td>
                <td style="height:0px;width:42px;"></td>
                <td style="height:0px;width:129px;"></td>
                <td style="height:0px;width:114px;"></td>
                <td style="height:0px;width:40px;"></td>
                <td style="height:0px;width:43px;"></td>
                <td style="height:0px;width:30px;"></td>
                <td style="height:0px;width:102px;"></td>
            </tr>
            <tr style="vertical-align:top;">
                <td style="width:0px;height:23px;"></td>
                <td></td>
                <td></td>
                <td></td>
                <td></td>
                <td></td>
                <td></td>
                <td></td>
                <td></td>
            </tr>
            <tr style="vertical-align:top;">
                <td style="width:0px;height:9px;"></td>
                <td></td>
                <td></td>
                <td></td>
                <td></td>
                <td></td>
                <td></td>
                <td></td>
                <td></td>
                <td></td>
                <td></td>
                <td></td>
                <td></td>
                <td></td>
            </tr>
            <tr style="vertical-align:top;">
                <td style="width:0px;height:23px;"></td>
                <td></td>
                <td class="csFBB219FE" colspan="8" style="width:682px;height:23px;line-height:21px;text-align:left;vertical-align:middle;"><nobr>'.$nomEse.'</nobr></td>
                <td></td>
                <td class="cs101A94F7" colspan="3" rowspan="7" style="width:175px;height:144px;text-align:left;vertical-align:top;"><div style="overflow:hidden;width:175px;height:144px;">
                   <img alt="" src="'.$pic2.'" style="width:175px;height:144px;" /></div>
                </td>
            </tr>
            <tr style="vertical-align:top;">
                <td style="width:0px;height:22px;"></td>
                <td></td>
                <td class="csCE72709D" colspan="8" style="width:682px;height:22px;line-height:15px;text-align:left;vertical-align:middle;"><nobr>'.$busnessName.'</nobr></td>
                <td></td>
            </tr>
            <tr style="vertical-align:top;">
                <td style="width:0px;height:22px;"></td>
                <td></td>
                <td class="csCE72709D" colspan="8" style="width:682px;height:22px;line-height:15px;text-align:left;vertical-align:middle;"><nobr>RCCM'.$rccEse.'.&nbsp;ID-NAT.'.$idNatEse.'</nobr></td>
                <td></td>
            </tr>
            <tr style="vertical-align:top;">
                <td style="width:0px;height:22px;"></td>
                <td></td>
                <td class="csFFC1C457" colspan="8" style="width:682px;height:22px;line-height:13px;text-align:left;vertical-align:middle;">'.$adresseEse.'</td>
                <td></td>
            </tr>
            <tr style="vertical-align:top;">
                <td style="width:0px;height:22px;"></td>
                <td></td>
                <td class="csFFC1C457" colspan="8" style="width:682px;height:22px;line-height:13px;text-align:left;vertical-align:middle;"><nobr>Email&nbsp;:&nbsp;'.$emailEse.'</nobr></td>
                <td></td>
            </tr>
            <tr style="vertical-align:top;">
                <td style="width:0px;height:22px;"></td>
                <td></td>
                <td class="csFFC1C457" colspan="8" style="width:682px;height:22px;line-height:13px;text-align:left;vertical-align:middle;"><nobr>Site&nbsp;web&nbsp;:&nbsp;'.$siteEse.'</nobr></td>
                <td></td>
            </tr>
            <tr style="vertical-align:top;">
                <td style="width:0px;height:11px;"></td>
                <td></td>
                <td class="cs612ED82F" colspan="8" rowspan="2" style="width:682px;height:23px;line-height:13px;text-align:left;vertical-align:middle;"><nobr>T&#233;l&#233;phone&nbsp;:&nbsp;'.$Tel1Ese.'&nbsp;&nbsp;24h/24</nobr></td>
                <td></td>
            </tr>
            <tr style="vertical-align:top;">
                <td style="width:0px;height:12px;"></td>
                <td></td>
                <td></td>
                <td></td>
                <td></td>
                <td></td>
            </tr>
            <tr style="vertical-align:top;">
                <td style="width:0px;height:8px;"></td>
                <td></td>
                <td></td>
                <td></td>
                <td></td>
                <td></td>
                <td></td>
                <td></td>
                <td></td>
                <td></td>
                <td></td>
                <td></td>
                <td></td>
                <td></td>
            </tr>
            <tr style="vertical-align:top;">
                <td style="width:0px;height:32px;"></td>
                <td></td>
                <td></td>
                <td></td>
                <td class="csB6F858D0" colspan="8" style="width:625px;height:32px;line-height:28px;text-align:center;vertical-align:middle;"><nobr>RAPPORT DES FACTURES DES CLIENTS EN DETTE/AGENT. </nobr></td>
                <td></td>
                <td></td>
            </tr>
            <tr style="vertical-align:top;">
                <td style="width:0px;height:19px;"></td>
                <td></td>
                <td></td>
                <td></td>
                <td></td>
                <td></td>
                <td></td>
                <td></td>
                <td></td>
                <td></td>
                <td></td>
                <td></td>
                <td></td>
                <td></td>
            </tr>
            <tr style="vertical-align:top;">
                <td style="width:0px;height:23px;"></td>
                <td></td>
                <td class="cs56F73198" colspan="4" style="width:329px;height:21px;line-height:18px;text-align:left;vertical-align:top;"><nobr>&nbsp;PERIODE&nbsp;:&nbsp;&nbsp;Du&nbsp;&nbsp;'.$date1.'&nbsp;&nbsp;au&nbsp;'.$date2.'</nobr></td>
                <td class="cs56F73198" colspan="8" style="width:562px;height:21px;line-height:18px;text-align:left;vertical-align:top;"><nobr>'.$nom_departement.'</nobr></td>
            </tr>
            <tr style="vertical-align:top;">
                <td style="width:0px;height:9px;"></td>
                <td></td>
                <td></td>
                <td></td>
                <td></td>
                <td></td>
                <td></td>
                <td></td>
                <td></td>
                <td></td>
                <td></td>
                <td></td>
                <td></td>
                <td></td>
            </tr>
            <tr style="vertical-align:top;">
                <td style="width:0px;height:24px;"></td>
                <td></td>
                <td class="cs9FE9304F" style="width:101px;height:22px;line-height:15px;text-align:center;vertical-align:middle;"><nobr>N&#176;&nbsp;FACTURE</nobr></td>
                <td class="cs9FE9304F" colspan="3" style="width:230px;height:22px;line-height:15px;text-align:center;vertical-align:middle;"><nobr>CLIENT</nobr></td>
                <td class="cs9FE9304F" colspan="2" style="width:107px;height:22px;line-height:15px;text-align:center;vertical-align:middle;"><nobr>DATE&nbsp;FACTURE</nobr></td>
                <td class="cs9FE9304F" style="width:128px;height:22px;line-height:15px;text-align:center;vertical-align:middle;"><nobr>TOTAL&nbsp;FACTURE($)</nobr></td>
                <td class="cs9FE9304F" style="width:113px;height:22px;line-height:15px;text-align:center;vertical-align:middle;"><nobr>TOTAL&nbsp;PAIE($)</nobr></td>
                <td class="cs9FE9304F" colspan="3" style="width:112px;height:22px;line-height:15px;text-align:center;vertical-align:middle;"><nobr>RESTE($)</nobr></td>
                <td class="csEAC52FCD" style="width:102px;height:22px;line-height:15px;text-align:center;vertical-align:middle;"><nobr>OBS</nobr></td>
            </tr>
            ';

            $output .= $this->showDetailFacturationDetteClientAgent($date1,$date2,$serveur_id); 

            $output.='
            <tr style="vertical-align:top;">
                <td style="width:0px;height:24px;"></td>
                <td></td>
                <td class="cs9FE9304F" colspan="6" style="width:440px;height:22px;line-height:15px;text-align:center;vertical-align:middle;"><nobr>TOTAL&nbsp;($)&nbsp;:</nobr></td>
                <td class="cs9FE9304F" style="width:128px;height:22px;line-height:15px;text-align:center;vertical-align:middle;">'.$totalFact.'$</td>
                <td class="cs9FE9304F" style="width:113px;height:22px;line-height:15px;text-align:center;vertical-align:middle;">'.$totalPaie.'$</td>
                <td class="cs9FE9304F" colspan="3" style="width:112px;height:22px;line-height:15px;text-align:center;vertical-align:middle;">'.$totalReste.'$</td>
                <td class="csEAC52FCD" style="width:102px;height:22px;"><!--[if lte IE 7]><div class="csF7D3565D"></div><![endif]--></td>
            </tr>
            <tr style="vertical-align:top;">
                <td style="width:0px;height:10px;"></td>
                <td></td>
                <td></td>
                <td></td>
                <td></td>
                <td></td>
                <td></td>
                <td></td>
                <td></td>
                <td></td>
                <td></td>
                <td></td>
                <td></td>
                <td></td>
            </tr>
            <tr style="vertical-align:top;">
                <td style="width:0px;height:22px;"></td>
                <td></td>
                <td class="cs12FE94AA" colspan="3" style="width:207px;height:22px;line-height:16px;text-align:left;vertical-align:top;"><nobr>Fait&nbsp;&#224;&nbsp;Goma&nbsp;le&nbsp;&nbsp;'.date('Y-m-d').'</nobr></td>
                <td></td>
                <td></td>
                <td></td>
                <td></td>
                <td></td>
                <td></td>
                <td></td>
                <td></td>
                <td></td>
            </tr>
        </table>
        </body>
        </html>';  
       
        return $output; 

}
function showDetailFacturationDetteClientAgent($date1,$date2,$serveur_id)
{
    $data = DB::table('tvente_entete_vente')
    ->join('tvente_module','tvente_module.id','=','tvente_entete_vente.module_id')
    ->join('tvente_services','tvente_services.id','=','tvente_entete_vente.refService')
    ->join('tvente_client','tvente_client.id','=','tvente_entete_vente.refClient')
    ->join('tvente_categorie_client','tvente_categorie_client.id','=','tvente_client.refCategieClient')  
    ->select(
        'tvente_entete_vente.id','tvente_entete_vente.code','refClient','refService','refReservation','module_id',
        'dateVente','tvente_entete_vente.libelle','tvente_entete_vente.montant','tvente_entete_vente.paie','tvente_entete_vente.author',
        'tvente_entete_vente.refUser','serveur_id','table_id','etat_facture',
        'tvente_entete_vente.created_at','reduction','totaltva',
        'tvente_services.nom_service', 'tvente_module.nom_module','date_paie_current','nombre_print',
        'tvente_client.noms','tvente_client.sexe','tvente_client.contact','tvente_client.mail','tvente_client.adresse',
        'tvente_client.pieceidentite','tvente_client.numeroPiece','tvente_client.dateLivrePiece',
        'tvente_client.lieulivraisonCarte','tvente_client.nationnalite','tvente_client.datenaissance',
        'tvente_client.lieunaissance','tvente_client.profession','tvente_client.occupation','tvente_client.nombreEnfant',
        'tvente_client.dateArriverGoma','tvente_client.arriverPar','tvente_client.refCategieClient','tvente_client.photo',
        'tvente_client.slug','tvente_client.author as client_author','tvente_entete_vente.updated_at',
        'tvente_categorie_client.designation'
    )
    ->addSelect(DB::raw('
        CONCAT("F",YEAR(dateVente),"",MONTH(dateVente),"00",tvente_entete_vente.id) as codeFacture,
        ROUND(IFNULL(tvente_entete_vente.montant,0),2) as totalFacture,
        ROUND(IFNULL(tvente_entete_vente.paie,0),2) as totalPaie,
        ROUND((IFNULL(tvente_entete_vente.montant,0) - IFNULL(tvente_entete_vente.paie,0)),2) as RestePaie,
        TIMESTAMPDIFF(DAY, tvente_entete_vente.dateVente, CURDATE()) as nombreJr
    '))
    ->whereRaw('ROUND((IFNULL(tvente_entete_vente.montant, 0) + IFNULL(tvente_entete_vente.totaltva, 0) - IFNULL(tvente_entete_vente.reduction, 0)) - IFNULL(tvente_entete_vente.paie, 0), 2) > 0')
    ->where([
        ['dateVente','>=', $date1],
        ['dateVente','<=', $date2],
        ['tvente_entete_vente.serveur_id','=', $serveur_id]
    ])
    ->orderBy("tvente_entete_vente.created_at", "asc")
    ->get();
        $output='';

        foreach ($data as $row) 
        {
            $output .='
            <tr style="vertical-align:top;">
                <td style="width:0px;height:24px;"></td>
                <td></td>
                <td class="cs6E02D7D2" style="width:101px;height:22px;line-height:15px;text-align:center;vertical-align:middle;"><nobr>'.$row->codeFacture.'</nobr></td>
                <td class="cs6E02D7D2" colspan="3" style="width:230px;height:22px;line-height:15px;text-align:left;vertical-align:middle;">'.$row->noms.'</td>
                <td class="cs6E02D7D2" colspan="2" style="width:107px;height:22px;line-height:15px;text-align:center;vertical-align:middle;">'.$row->dateVente.'</td>
                <td class="cs6E02D7D2" style="width:128px;height:22px;line-height:15px;text-align:center;vertical-align:middle;">'.$row->totalFacture.'$</td>
                <td class="cs6E02D7D2" style="width:113px;height:22px;line-height:15px;text-align:center;vertical-align:middle;">'.$row->totalPaie.'$</td>
                <td class="cs6E02D7D2" colspan="3" style="width:112px;height:22px;line-height:15px;text-align:center;vertical-align:middle;">'.$row->RestePaie.'$</td>
                <td class="cs6C28398D" style="width:102px;height:22px;line-height:15px;text-align:center;vertical-align:middle;"><nobr>'.$row->nombreJr.'J</nobr></td>
            </tr>
            ';           
   
    }

    return $output;

}


//================================================

public function fetch_rapport_liste_client(Request $request)
{
    //refDepartement

    // if ($request->get('date1') && $request->get('date2')) {
        // code...
       
        
        $html = $this->printRapportClient();
        $pdf = \App::make('dompdf.wrapper');
        // echo($html);
        // $pdf->loadHTML($html);
        $pdf->loadHTML($html)->setPaper('a4');
        return $pdf->stream();            

    // } else {
    //     // code...
    // }  
    
}
function printRapportClient()
{

         //Info Entreprise
        $nomEse='';
        $adresseEse='';
        $Tel1Ese='';
        $Tel2Ese='';
        $siteEse='';
        $emailEse='';
        $idNatEse='';
        $numImpotEse='';
        $rccEse='';
        $siege='';
        $busnessName='';
        $pic='';
        $pic2 = $this->displayImg("fichier", 'logo.png');
        $logo='';

        $data1 = DB::table('entreprises')
        ->join('secteurs','secteurs.id','=','entreprises.idsecteur')
        ->join('forme_juridiques','forme_juridiques.id','=','entreprises.idforme')

        ->join('pays','pays.id','=','entreprises.idPays')
        ->join('provinces','provinces.id','=','entreprises.idProvince')
        ->join('users','users.id','=','entreprises.ceo')        
        ->select('entreprises.id as id','entreprises.id as idEntreprise',
        'entreprises.ceo','entreprises.nomEntreprise','entreprises.descriptionEntreprise',
        'entreprises.emailEntreprise','entreprises.adresseEntreprise',
        'entreprises.telephoneEntreprise','entreprises.solutionEntreprise','entreprises.idsecteur',
        'entreprises.idforme','entreprises.etat',
        'entreprises.idPays','entreprises.idProvince','entreprises.edition','entreprises.facebook',
        'entreprises.linkedin','entreprises.twitter','entreprises.siteweb','entreprises.rccm',
        'entreprises.invPersonnel','entreprises.invHub','entreprises.invRecherche',
        'entreprises.chiffreAffaire','entreprises.nbremploye','entreprises.slug','entreprises.logo',
            //forme
            'forme_juridiques.nomForme','secteurs.nomSecteur',
            //users
            'users.name','users.email','users.avatar','users.telephone','users.adresse',
            //
            'provinces.nomProvince','pays.nomPays', 'entreprises.created_at')
        ->first();
        if ($data1) 
        {                                
            $nomEse=$data1->nomEntreprise;
            $adresseEse=$data1->adresseEntreprise;
            $Tel1Ese=$data1->telephoneEntreprise;
            $Tel2Ese=$data1->telephone;
            $siteEse=$data1->siteweb;
            $emailEse=$data1->emailEntreprise;
            $idNatEse=$data1->rccm;
            $numImpotEse=$data1->rccm;
            $busnessName=$data1->nomSecteur;
            $rccmEse=$data1->rccm;
            $pic = $this->displayImg("fichier", 'logo.png');
            $siege=$data1->nomForme;         
        }


         $nom_departement= '-';
         $code_departement= '-';           

        $output='
            <!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Transitional//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd">
            <!-- saved from url=(0016)http://localhost -->
            <html>
            <head>
                <title>rptListeClient</title>
                <meta HTTP-EQUIV="Content-Type" CONTENT="text/html; charset=utf-8"/>
                <style type="text/css">
                    .csFBCBEF30 {color:#000000;background-color:transparent;border-left:#000000 1px solid;border-top:#000000 1px solid;border-right:#000000 1px solid;border-bottom:#000000 1px solid;font-family:Times New Roman; font-size:12px; font-weight:normal; font-style:normal; }
                    .cs275E312D {color:#000000;background-color:transparent;border-left:#000000 1px solid;border-top:#000000 1px solid;border-right:#000000 1px solid;border-bottom:#000000 1px solid;font-family:Times New Roman; font-size:13px; font-weight:bold; font-style:normal; }
                    .csDC7EEB9 {color:#000000;background-color:transparent;border-left-style: none;border-top:#000000 1px solid;border-right:#000000 1px solid;border-bottom:#000000 1px solid;font-family:Times New Roman; font-size:12px; font-weight:normal; font-style:normal; }
                    .csAB3AA82A {color:#000000;background-color:transparent;border-left-style: none;border-top:#000000 1px solid;border-right:#000000 1px solid;border-bottom:#000000 1px solid;font-family:Times New Roman; font-size:13px; font-weight:bold; font-style:normal; }
                    .cs8A513397 {color:#000000;background-color:transparent;border-left-style: none;border-top-style: none;border-right-style: none;border-bottom-style: none;font-family:Times New Roman; font-size:13px; font-weight:bold; font-style:normal; padding-left:2px;}
                    .cs101A94F7 {color:#000000;background-color:transparent;border-left-style: none;border-top-style: none;border-right-style: none;border-bottom-style: none;font-family:Times New Roman; font-size:13px; font-weight:normal; font-style:normal; }
                    .cs6105B8F3 {color:#000000;background-color:transparent;border-left-style: none;border-top-style: none;border-right-style: none;border-bottom-style: none;font-family:Times New Roman; font-size:13px; font-weight:normal; font-style:normal; padding-left:2px;}
                    .cs5EA817F2 {color:#000000;background-color:transparent;border-left-style: none;border-top-style: none;border-right-style: none;border-bottom-style: none;font-family:Times New Roman; font-size:13px; font-weight:normal; font-style:normal; padding-left:2px;padding-right:2px;}
                    .cs739196BC {color:#5C5C5C;background-color:transparent;border-left-style: none;border-top-style: none;border-right-style: none;border-bottom-style: none;font-family:Segoe UI; font-size:11px; font-weight:normal; font-style:normal; }
                    .csF7D3565D {height:0px;width:0px;overflow:hidden;font-size:0px;line-height:0px;}
                </style>
            </head>
            <body leftMargin=10 topMargin=10 rightMargin=10 bottomMargin=10 style="background-color:#FFFFFF">
            <table cellpadding="0" cellspacing="0" border="0" style="border-width:0px;empty-cells:show;width:694px;height:305px;position:relative;">
                <tr>
                    <td style="width:0px;height:0px;"></td>
                    <td style="height:0px;width:10px;"></td>
                    <td style="height:0px;width:42px;"></td>
                    <td style="height:0px;width:114px;"></td>
                    <td style="height:0px;width:98px;"></td>
                    <td style="height:0px;width:85px;"></td>
                    <td style="height:0px;width:60px;"></td>
                    <td style="height:0px;width:101px;"></td>
                    <td style="height:0px;width:14px;"></td>
                    <td style="height:0px;width:39px;"></td>
                    <td style="height:0px;width:131px;"></td>
                </tr>
                <tr style="vertical-align:top;">
                    <td style="width:0px;height:23px;"></td>
                    <td class="cs739196BC" colspan="6" style="width:409px;height:23px;line-height:14px;text-align:center;vertical-align:middle;"></td>
                    <td></td>
                    <td></td>
                    <td></td>
                    <td></td>
                </tr>
                <tr style="vertical-align:top;">
                    <td style="width:0px;height:10px;"></td>
                    <td></td>
                    <td></td>
                    <td></td>
                    <td></td>
                    <td></td>
                    <td></td>
                    <td></td>
                    <td></td>
                    <td></td>
                    <td></td>
                </tr>
                <tr style="vertical-align:top;">
                    <td style="width:0px;height:2px;"></td>
                    <td></td>
                    <td></td>
                    <td></td>
                    <td></td>
                    <td></td>
                    <td></td>
                    <td></td>
                    <td></td>
                    <td></td>
                    <td class="cs101A94F7" rowspan="6" style="width:131px;height:110px;text-align:left;vertical-align:top;"><div style="overflow:hidden;width:131px;height:110px;">
                        <img alt="" src="'.$pic2.'" style="width:131px;height:110px;" /></div>
                    </td>
                </tr>
                <tr style="vertical-align:top;">
                    <td style="width:0px;height:22px;"></td>
                    <td></td>
                    <td class="cs8A513397" colspan="6" style="width:498px;height:22px;line-height:15px;text-align:left;vertical-align:middle;"><nobr>'.$nomEse.'</nobr></td>
                    <td></td>
                    <td></td>
                </tr>
                <tr style="vertical-align:top;">
                    <td style="width:0px;height:22px;"></td>
                    <td></td>
                    <td class="cs6105B8F3" colspan="6" style="width:498px;height:22px;line-height:15px;text-align:left;vertical-align:middle;"><nobr>'.$busnessName.'</nobr></td>
                    <td></td>
                    <td></td>
                </tr>
                <tr style="vertical-align:top;">
                    <td style="width:0px;height:22px;"></td>
                    <td></td>
                    <td class="cs8A513397" colspan="6" style="width:498px;height:22px;line-height:15px;text-align:left;vertical-align:middle;"><nobr>RCCM'.$rccEse.'.&nbsp;ID-NAT.'.$numImpotEse.'</nobr></td>
                    <td></td>
                    <td></td>
                </tr>
                <tr style="vertical-align:top;">
                    <td style="width:0px;height:22px;"></td>
                    <td></td>
                    <td class="cs8A513397" colspan="6" style="width:498px;height:22px;line-height:15px;text-align:left;vertical-align:middle;"><nobr>N&#176;&nbsp;'.$numImpotEse.'</nobr></td>
                    <td></td>
                    <td></td>
                </tr>
                <tr style="vertical-align:top;">
                    <td style="width:0px;height:20px;"></td>
                    <td></td>
                    <td class="cs6105B8F3" colspan="6" rowspan="2" style="width:498px;height:22px;line-height:15px;text-align:left;vertical-align:middle;"><nobr>'.$adresseEse.'</nobr></td>
                    <td></td>
                    <td></td>
                </tr>
                <tr style="vertical-align:top;">
                    <td style="width:0px;height:2px;"></td>
                    <td></td>
                    <td></td>
                    <td></td>
                    <td></td>
                </tr>
                <tr style="vertical-align:top;">
                    <td style="width:0px;height:23px;"></td>
                    <td></td>
                    <td class="cs6105B8F3" colspan="6" style="width:498px;height:23px;line-height:15px;text-align:left;vertical-align:middle;"><nobr>E-mail&nbsp;:&nbsp;'.$emailEse.'</nobr></td>
                    <td></td>
                    <td></td>
                    <td></td>
                </tr>
                <tr style="vertical-align:top;">
                    <td style="width:0px;height:22px;"></td>
                    <td></td>
                    <td class="cs6105B8F3" colspan="6" style="width:498px;height:22px;line-height:15px;text-align:left;vertical-align:middle;"><nobr>Site-web&nbsp;:&nbsp;'.$siteEse.'</nobr></td>
                    <td></td>
                    <td></td>
                    <td></td>
                </tr>
                <tr style="vertical-align:top;">
                    <td style="width:0px;height:22px;"></td>
                    <td></td>
                    <td class="cs8A513397" colspan="6" style="width:498px;height:22px;line-height:15px;text-align:left;vertical-align:middle;"><nobr>Tel&#233;phone&nbsp;:&nbsp;'.$Tel1Ese.'</nobr></td>
                    <td></td>
                    <td></td>
                    <td></td>
                </tr>
                <tr style="vertical-align:top;">
                    <td style="width:0px;height:13px;"></td>
                    <td></td>
                    <td></td>
                    <td></td>
                    <td></td>
                    <td></td>
                    <td></td>
                    <td></td>
                    <td></td>
                    <td></td>
                    <td></td>
                </tr>
                <tr style="vertical-align:top;">
                    <td style="width:0px;height:24px;"></td>
                    <td></td>
                    <td class="cs275E312D" style="width:40px;height:22px;line-height:15px;text-align:center;vertical-align:middle;"><nobr>N&#176;</nobr></td>
                    <td class="csAB3AA82A" colspan="2" style="width:211px;height:22px;line-height:15px;text-align:center;vertical-align:middle;"><nobr>Nom</nobr></td>
                    <td class="csAB3AA82A" style="width:84px;height:22px;line-height:15px;text-align:center;vertical-align:middle;"><nobr>Contact</nobr></td>
                    <td class="csAB3AA82A" colspan="3" style="width:174px;height:22px;line-height:15px;text-align:center;vertical-align:middle;"><nobr>Adresse</nobr></td>
                    <td class="csAB3AA82A" colspan="2" style="width:169px;height:22px;line-height:15px;text-align:center;vertical-align:middle;"><nobr>Mail</nobr></td>
                </tr>
                ';

                        $output .= $this->showDetailListeClient(); 

                        $output.='
                <tr style="vertical-align:top;">
                    <td style="width:0px;height:10px;"></td>
                    <td></td>
                    <td></td>
                    <td></td>
                    <td></td>
                    <td></td>
                    <td></td>
                    <td></td>
                    <td></td>
                    <td></td>
                    <td></td>
                </tr>
                <tr style="vertical-align:top;">
                    <td style="width:0px;height:22px;"></td>
                    <td></td>
                    <td class="cs5EA817F2" colspan="2" style="width:152px;height:22px;line-height:15px;text-align:center;vertical-align:top;"><nobr>Fait&nbsp;&#224;&nbsp;Goma&nbsp;le&nbsp;01/01/2025</nobr></td>
                    <td></td>
                    <td></td>
                    <td></td>
                    <td></td>
                    <td></td>
                    <td></td>
                    <td></td>
                </tr>
            </table>
            </body>
            </html>
        ';  
       
        return $output; 

}
function showDetailListeClient()
{
    $data = DB::table("tvente_client")  
    ->join('tvente_categorie_client','tvente_categorie_client.id','=','tvente_client.refCategieClient')  
    ->select('tvente_client.id','noms','sexe','contact','mail','adresse','pieceidentite',
    'numeroPiece','dateLivrePiece','lieulivraisonCarte','nationnalite','datenaissance',
    'lieunaissance','profession','occupation','nombreEnfant','dateArriverGoma','arriverPar',
    'refCategieClient','photo','slug','tvente_client.author','tvente_client.created_at',
    'tvente_client.updated_at', "tvente_categorie_client.designation")
    ->orderBy("tvente_client.noms", "asc")
    ->get();
    $output='';

    $count = 0;

        foreach ($data as $row) 
        {
            $count ++;

            $output .='
                <tr style="vertical-align:top;">
                    <td style="width:0px;height:24px;"></td>
                    <td></td>
                    <td class="csFBCBEF30" style="width:40px;height:22px;line-height:13px;text-align:center;vertical-align:middle;"><nobr>'.$count.'</nobr></td>
                    <td class="csDC7EEB9" colspan="2" style="width:211px;height:22px;line-height:13px;text-align:left;vertical-align:middle;"><nobr>'.$row->noms.'</nobr></td>
                    <td class="csDC7EEB9" style="width:84px;height:22px;line-height:13px;text-align:center;vertical-align:middle;"><nobr>'.$row->contact.'</nobr></td>
                    <td class="csDC7EEB9" colspan="3" style="width:174px;height:22px;line-height:13px;text-align:left;vertical-align:middle;"><nobr>'.$row->adresse.'</nobr></td>
                    <td class="csDC7EEB9" colspan="2" style="width:169px;height:22px;line-height:13px;text-align:left;vertical-align:middle;"><nobr>'.$row->mail.'</nobr></td>
                </tr>
            ';           
   
        }

    return $output;

}




}
